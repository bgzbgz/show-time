<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FT Admin Panel</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @font-face { font-family: 'Plaak'; src: url('../shared/fonts/Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; font-display: swap; }
    @font-face { font-family: 'Riforma'; src: url('../shared/fonts/RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; font-display: swap; }
    @font-face { font-family: 'Monument'; src: url('../shared/fonts/MonumentGrotesk-Mono.woff2') format('woff2'); font-display: swap; }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Riforma', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
      color: #fff;
      -webkit-font-smoothing: antialiased;
      overflow: hidden;
      height: 100vh;
    }

    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 0; }
    ::-webkit-scrollbar-thumb:hover { background: #FFF469; }

    input, button { font-family: 'Riforma', -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

    const SUPABASE_URL = 'https://lutzzfaedkbsmbobmrzx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ALL_TOOLS = ['woop','know-thyself','dream','values','team','fit','cash','energy','goals','focus','performance','meeting-rhythm','market-size','segmentation-target-market','target-segment-deep-dive','value-proposition','value-proposition-testing','product-development','pricing','brand-marketing','customer-service','route-to-market','core-activities','processes-decisions','fit-abc-analysis','org-redesign','employer-branding','agile-teams','digitalization','digital-heart'];

    // ─── Helpers ───────────────────────────────────────────────────────────────

    function timeAgo(dateStr) {
      if (!dateStr) return '—';
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      const hrs = Math.floor(mins / 60);
      const days = Math.floor(hrs / 24);
      if (mins < 1) return 'just now';
      if (mins < 60) return `${mins}m ago`;
      if (hrs < 24) return `${hrs}h ago`;
      if (days < 7) return `${days}d ago`;
      return new Date(dateStr).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function fmtDate(dateStr) {
      if (!dateStr) return '—';
      return new Date(dateStr).toLocaleString('en-GB', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function fmtDuration(ms) {
      if (!ms || ms < 0) return null;
      const mins = Math.floor(ms / 60000);
      const hrs = Math.floor(mins / 60);
      if (hrs > 0) return `${hrs}h ${mins % 60}m`;
      if (mins > 0) return `${mins}m`;
      return '<1m';
    }

    function exportCSV(rows, filename) {
      if (!rows.length) return;
      const keys = Object.keys(rows[0]);
      const csv = [
        keys.join(','),
        ...rows.map(r => keys.map(k => {
          const v = r[k] == null ? '' : String(r[k]);
          return v.includes(',') || v.includes('"') || v.includes('\n') ? `"${v.replace(/"/g, '""')}"` : v;
        }).join(','))
      ].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = filename;
      a.click();
    }

    function actionColor(action) {
      if (action === 'revised') return '#44ff88';
      if (action === 'submitted_anyway') return '#ff8844';
      if (action === 'no_challenges') return '#888';
      return '#555';
    }

    // ─── Shared styles ─────────────────────────────────────────────────────────

    const S = {
      viewTitle: {
        fontFamily: 'Plaak, sans-serif', fontSize: 22,
        marginBottom: 24, color: '#fff', letterSpacing: '0.02em', textTransform: 'uppercase'
      },
      sectionLabel: {
        fontSize: 10, letterSpacing: '0.12em', color: '#B2B2B2',
        textTransform: 'uppercase', marginBottom: 10,
        fontFamily: 'Monument, monospace'
      },
      th: {
        padding: '10px 14px', textAlign: 'left', fontSize: 10,
        color: '#B2B2B2', fontWeight: 'normal', letterSpacing: '0.08em',
        textTransform: 'uppercase', whiteSpace: 'nowrap',
        fontFamily: 'Monument, monospace'
      },
      td: { padding: '10px 14px', fontSize: 13, color: '#fff' },
      card: { background: '#1a1a1a', border: '1px solid #1f1f1f' },
      input: {
        background: '#1a1a1a', border: '1px solid #333', color: '#fff',
        fontSize: 14, padding: '12px 14px', outline: 'none', width: '100%'
      }
    };

    // ─── Loading ───────────────────────────────────────────────────────────────

    function LoadingState() {
      return (
        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: 240, color: '#B2B2B2' }}>
          <span style={{ fontFamily: 'Monument, monospace', fontSize: 12, letterSpacing: '0.1em' }}>LOADING...</span>
        </div>
      );
    }

    // ─── Login Screen ──────────────────────────────────────────────────────────

    function LoginScreen({ onLogin, error }) {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [localError, setLocalError] = useState('');

      async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);
        setLocalError('');
        try {
          await onLogin(email, password);
        } catch (err) {
          setLocalError(err.message || 'Login failed');
          setLoading(false);
        }
      }

      return (
        <div style={{
          display: 'flex', alignItems: 'center', justifyContent: 'center',
          height: '100vh', background: '#000'
        }}>
          <div style={{ width: 360 }}>
            <div style={{ marginBottom: 44 }}>
              <div style={{
                fontFamily: 'Plaak, sans-serif', fontSize: 30,
                color: '#FFF469', letterSpacing: '0.08em'
              }}>
                FT ADMIN
              </div>
              <div style={{ color: '#B2B2B2', fontSize: 13, marginTop: 6, letterSpacing: '0.04em' }}>
                Internal access only
              </div>
            </div>

            <form onSubmit={handleSubmit}>
              <div style={{ marginBottom: 12 }}>
                <input
                  type="email"
                  placeholder="Email"
                  value={email}
                  onChange={e => setEmail(e.target.value)}
                  required
                  style={S.input}
                />
              </div>
              <div style={{ marginBottom: 20 }}>
                <input
                  type="password"
                  placeholder="Password"
                  value={password}
                  onChange={e => setPassword(e.target.value)}
                  required
                  style={S.input}
                />
              </div>

              {(localError || error) && (
                <div style={{ color: '#ff5555', fontSize: 13, marginBottom: 16 }}>
                  {localError || error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                style={{
                  width: '100%', padding: '14px', background: loading ? '#aaa900' : '#FFF469',
                  color: '#000', border: 'none', cursor: loading ? 'not-allowed' : 'pointer',
                  fontSize: 13, fontWeight: 700, letterSpacing: '0.1em',
                  transition: 'background 0.15s'
                }}
              >
                {loading ? 'SIGNING IN...' : 'SIGN IN'}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // ─── Stat Card ─────────────────────────────────────────────────────────────

    function StatCard({ label, value, sub, accent }) {
      return (
        <div style={{
          ...S.card, padding: '20px 22px', flex: '1 1 140px', minWidth: 130
        }}>
          <div style={{
            fontFamily: 'Plaak, sans-serif', fontSize: 38,
            color: accent ? '#FFF469' : '#fff', lineHeight: 1, marginBottom: 8
          }}>
            {value ?? '—'}
          </div>
          <div style={{ fontSize: 10, color: '#666', letterSpacing: '0.1em', textTransform: 'uppercase' }}>
            {label}
          </div>
          {sub && <div style={{ fontSize: 11, color: '#B2B2B2', marginTop: 4 }}>{sub}</div>}
        </div>
      );
    }

    // ─── Overview View ─────────────────────────────────────────────────────────

    function OverviewView() {
      const [stats, setStats] = useState(null);
      const [feed, setFeed] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => { loadData(); }, []);

      async function loadData() {
        setLoading(true);
        try {
          const since24h = new Date(Date.now() - 86400000).toISOString();

          const [
            { count: totalUsers },
            { data: activeRows },
            { count: totalCompletions },
            { count: totalOrgs },
            { count: aiToday },
            { count: errorCount },
            { data: feedRows }
          ] = await Promise.all([
            db.from('users').select('*', { count: 'exact', head: true }),
            db.from('user_responses').select('user_id').gt('updated_at', since24h),
            db.from('tool_completions').select('*', { count: 'exact', head: true }),
            db.from('organizations').select('*', { count: 'exact', head: true }),
            db.from('ai_challenge_log').select('*', { count: 'exact', head: true }).gt('created_at', since24h),
            db.from('webhook_events').select('*', { count: 'exact', head: true }).not('error_message', 'is', null),
            db.from('user_responses')
              .select('updated_at, user_id, users(full_name, organization_name), tool_questions(tool_slug)')
              .order('updated_at', { ascending: false })
              .limit(20)
          ]);

          const activeUsers = activeRows ? new Set(activeRows.map(r => r.user_id)).size : 0;
          setStats({ totalUsers, activeUsers, totalCompletions, totalOrgs, aiToday, errorCount });
          setFeed(feedRows || []);
        } catch (err) {
          console.error('Overview load error:', err);
        }
        setLoading(false);
      }

      if (loading) return <LoadingState />;

      return (
        <div>
          <h2 style={S.viewTitle}>Overview</h2>

          <div style={{ display: 'flex', gap: 10, marginBottom: 36, flexWrap: 'wrap' }}>
            <StatCard label="Total Users" value={stats?.totalUsers} />
            <StatCard label="Active (24h)" value={stats?.activeUsers} accent />
            <StatCard label="Completions" value={stats?.totalCompletions} />
            <StatCard label="Companies" value={stats?.totalOrgs} />
            <StatCard label="AI Challenges Today" value={stats?.aiToday} />
            <StatCard
              label="Webhook Errors"
              value={stats?.errorCount}
              sub={stats?.errorCount > 0 ? 'check Logs tab' : undefined}
            />
          </div>

          <div style={{ ...S.sectionLabel }}>Recent Activity</div>
          <div style={S.card}>
            {feed.length === 0 && (
              <div style={{ padding: 32, color: '#444', textAlign: 'center', fontSize: 13 }}>
                No recent activity
              </div>
            )}
            {feed.map((row, i) => {
              const name = row.users?.full_name || 'Unknown';
              const org = row.users?.organization_name;
              const tool = row.tool_questions?.tool_slug || 'unknown tool';
              return (
                <div key={i} style={{
                  display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                  padding: '12px 16px',
                  borderBottom: i < feed.length - 1 ? '1px solid #1a1a1a' : 'none'
                }}>
                  <div style={{ fontSize: 13 }}>
                    <span style={{ color: '#FFF469' }}>{name}</span>
                    {org && <span style={{ color: '#B2B2B2' }}> ({org})</span>}
                    <span style={{ color: '#B2B2B2' }}> answered a question in </span>
                    <span style={{ fontFamily: 'Monument, monospace', fontSize: 11, color: '#999' }}>{tool}</span>
                  </div>
                  <div style={{ fontSize: 11, color: '#B2B2B2', whiteSpace: 'nowrap', marginLeft: 20 }}>
                    {timeAgo(row.updated_at)}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // ─── Companies View ────────────────────────────────────────────────────────

    function CompaniesView({ onSelectUser }) {
      const [orgs, setOrgs] = useState([]);
      const [users, setUsers] = useState([]);
      const [completions, setCompletions] = useState([]);
      const [lastActivity, setLastActivity] = useState({});
      const [expanded, setExpanded] = useState(null);
      const [loading, setLoading] = useState(true);
      const [orgModal, setOrgModal] = useState(null); // null | { mode: 'new'|'edit', id?, name, tag }
      const [orgSaving, setOrgSaving] = useState(false);
      const [cohortView, setCohortView] = useState({}); // orgId -> 'members' | 'progress'

      useEffect(() => { loadData(); }, []);

      async function loadData() {
        setLoading(true);
        try {
          const [
            { data: orgsData },
            { data: usersData },
            { data: compData },
            { data: actData }
          ] = await Promise.all([
            db.from('organizations').select('*').order('name'),
            db.from('users').select('id, full_name, email, organization_id, last_login, created_at').order('full_name'),
            db.from('tool_completions').select('user_id, tool_slug, completed_at'),
            db.from('user_responses').select('user_id, updated_at').order('updated_at', { ascending: false })
          ]);

          setOrgs(orgsData || []);
          setUsers(usersData || []);
          setCompletions(compData || []);

          const la = {};
          (actData || []).forEach(r => {
            if (!la[r.user_id]) la[r.user_id] = r.updated_at;
          });
          setLastActivity(la);
        } catch (err) {
          console.error('Companies load error:', err);
        }
        setLoading(false);
      }

      async function saveOrg() {
        setOrgSaving(true);
        if (orgModal.mode === 'new') {
          const { data } = await db.from('organizations').insert({ name: orgModal.name, learnworlds_tag: orgModal.tag || null }).select().single();
          if (data) setOrgs(prev => [...prev, data].sort((a, b) => a.name.localeCompare(b.name)));
        } else {
          await db.from('organizations').update({ name: orgModal.name, learnworlds_tag: orgModal.tag || null }).eq('id', orgModal.id);
          setOrgs(prev => prev.map(o => o.id === orgModal.id ? { ...o, name: orgModal.name, learnworlds_tag: orgModal.tag || null } : o));
        }
        setOrgSaving(false);
        setOrgModal(null);
      }

      async function deleteOrg(orgId, orgName) {
        if (!window.confirm(`Delete "${orgName}"? Members will lose their org assignment.`)) return;
        await db.from('organizations').delete().eq('id', orgId);
        setOrgs(prev => prev.filter(o => o.id !== orgId));
        setExpanded(null);
      }

      if (loading) return <LoadingState />;

      return (
        <div>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 24 }}>
            <h2 style={{ ...S.viewTitle, marginBottom: 0 }}>Companies</h2>
            <button
              onClick={() => setOrgModal({ mode: 'new', name: '', tag: '' })}
              style={{ background: '#FFF469', color: '#000', border: 'none', cursor: 'pointer', padding: '8px 16px', fontSize: 11, fontWeight: 700, letterSpacing: '0.08em' }}
            >
              + NEW COMPANY
            </button>
          </div>
          <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
            {orgs.map(org => {
              const members = users.filter(u => u.organization_id === org.id);
              const memberIds = new Set(members.map(m => m.id));
              const orgCompletions = completions.filter(c => memberIds.has(c.user_id));
              const orgLastActivity = members
                .map(m => lastActivity[m.id])
                .filter(Boolean)
                .sort()
                .reverse()[0];
              const isOpen = expanded === org.id;

              return (
                <div key={org.id} style={S.card}>
                  <div
                    style={{
                      display: 'flex', alignItems: 'center', justifyContent: 'space-between',
                      padding: '20px 24px',
                    }}
                  >
                    <div onClick={() => setExpanded(isOpen ? null : org.id)} style={{ flex: 1, cursor: 'pointer' }}>
                      <div style={{
                        fontFamily: 'Plaak, sans-serif', fontSize: 17,
                        color: '#FFF469', letterSpacing: '0.03em'
                      }}>
                        {org.name}
                      </div>
                      <div style={{ fontSize: 12, color: '#B2B2B2', marginTop: 5 }}>
                        {members.length} member{members.length !== 1 ? 's' : ''}
                        {' · '}
                        {orgCompletions.length} completion{orgCompletions.length !== 1 ? 's' : ''}
                        {orgLastActivity && ` · Last active ${timeAgo(orgLastActivity)}`}
                      </div>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                      <button onClick={() => setOrgModal({ mode: 'edit', id: org.id, name: org.name, tag: org.learnworlds_tag || '' })}
                        style={{ background: 'none', border: '1px solid #2a2a2a', color: '#555', cursor: 'pointer', padding: '4px 10px', fontSize: 11 }}>
                        EDIT
                      </button>
                      <button onClick={() => deleteOrg(org.id, org.name)}
                        style={{ background: 'none', border: '1px solid #2a2a2a', color: '#555', cursor: 'pointer', padding: '4px 10px', fontSize: 11 }}>
                        DEL
                      </button>
                      <div onClick={() => setExpanded(isOpen ? null : org.id)} style={{ color: '#444', fontSize: 12, cursor: 'pointer', padding: '4px 8px' }}>{isOpen ? '▲' : '▼'}</div>
                    </div>
                  </div>

                  {isOpen && (
                    <div style={{ borderTop: '1px solid #1a1a1a' }}>
                      {/* View toggle */}
                      <div style={{ display: 'flex', borderBottom: '1px solid #1a1a1a' }}>
                        {['members', 'progress'].map(v => (
                          <button key={v} onClick={() => setCohortView(prev => ({ ...prev, [org.id]: v }))}
                            style={{
                              padding: '8px 16px', background: 'none', border: 'none',
                              color: (cohortView[org.id] || 'members') === v ? '#FFF469' : '#444',
                              fontSize: 10, letterSpacing: '0.08em', cursor: 'pointer', textTransform: 'uppercase',
                              borderBottom: (cohortView[org.id] || 'members') === v ? '2px solid #FFF469' : '2px solid transparent',
                              marginBottom: -1,
                            }}>
                            {v}
                          </button>
                        ))}
                      </div>

                      {(cohortView[org.id] || 'members') === 'members' ? (
                        <div style={{ overflowX: 'auto' }}>
                          <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                              <tr style={{ background: '#0d0d0d' }}>
                                {['Name', 'Email', 'Tools Done', 'Last Active'].map(h => (
                                  <th key={h} style={S.th}>{h}</th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              {members.length === 0 && (
                                <tr>
                                  <td colSpan={4} style={{ ...S.td, color: '#444', textAlign: 'center', padding: 24 }}>
                                    No members
                                  </td>
                                </tr>
                              )}
                              {members.map(member => {
                                const done = completions.filter(c => c.user_id === member.id).length;
                                return (
                                  <tr
                                    key={member.id}
                                    onClick={() => onSelectUser(member)}
                                    style={{ borderTop: '1px solid #1a1a1a', cursor: 'pointer' }}
                                    onMouseEnter={e => e.currentTarget.style.background = '#161600'}
                                    onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                                  >
                                    <td style={S.td}><span style={{ color: '#FFF469' }}>{member.full_name || '—'}</span></td>
                                    <td style={{ ...S.td, color: '#B2B2B2', fontSize: 12 }}>{member.email}</td>
                                    <td style={S.td}>{done}</td>
                                    <td style={{ ...S.td, color: '#B2B2B2', fontSize: 12 }}>{timeAgo(lastActivity[member.id])}</td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      ) : (
                        <div style={{ overflowX: 'auto', padding: '12px 16px' }}>
                          {members.length === 0 ? (
                            <div style={{ color: '#444', fontSize: 13, textAlign: 'center', padding: 16 }}>No members</div>
                          ) : (
                            <table style={{ borderCollapse: 'collapse', fontSize: 10, fontFamily: 'Monument, monospace' }}>
                              <thead>
                                <tr>
                                  <th style={{ ...S.th, position: 'sticky', left: 0, background: '#111', zIndex: 1, minWidth: 120 }}>NAME</th>
                                  {['woop','know-thyself','dream','values','team','fit','cash','energy','goals','focus','perf','mtg','mkt','seg','tgt','vp','vp-test','prod','price','brand','cs','rtm','core','proc','fit-abc','org','eb','agile','digital','dh'].map(s => (
                                    <th key={s} style={{ ...S.th, textAlign: 'center', minWidth: 36, padding: '8px 4px' }}>{s.slice(0,4)}</th>
                                  ))}
                                </tr>
                              </thead>
                              <tbody>
                                {members.map(member => {
                                  const memberCompletions = new Set(completions.filter(c => c.user_id === member.id).map(c => c.tool_slug));
                                  const tools = ['woop','know-thyself','dream','values','team','fit','cash','energy','goals','focus','performance','meeting-rhythm','market-size','segmentation-target-market','target-segment-deep-dive','value-proposition','value-proposition-testing','product-development','pricing','brand-marketing','customer-service','route-to-market','core-activities','processes-decisions','fit-abc-analysis','org-redesign','employer-branding','agile-teams','digitalization','digital-heart'];
                                  return (
                                    <tr key={member.id} style={{ borderTop: '1px solid #1a1a1a' }}>
                                      <td style={{ ...S.td, position: 'sticky', left: 0, background: '#111', fontSize: 12, color: '#FFF469' }}>{member.full_name || member.email}</td>
                                      {tools.map(slug => (
                                        <td key={slug} style={{ textAlign: 'center', padding: '8px 4px', fontSize: 13 }}>
                                          {memberCompletions.has(slug) ? '✅' : '–'}
                                        </td>
                                      ))}
                                    </tr>
                                  );
                                })}
                              </tbody>
                            </table>
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              );
            })}
            {orgs.length === 0 && (
              <div style={{ color: '#444', textAlign: 'center', padding: 48, fontSize: 13 }}>
                No companies found
              </div>
            )}
          </div>

          {/* Org Modal */}
          {orgModal && (
            <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 100 }}>
              <div style={{ background: '#111', border: '1px solid #2a2a2a', padding: 28, width: 360 }}>
                <div style={{ fontFamily: 'Plaak, sans-serif', fontSize: 16, color: '#FFF469', marginBottom: 20, letterSpacing: '0.04em' }}>
                  {orgModal.mode === 'new' ? 'NEW COMPANY' : 'EDIT COMPANY'}
                </div>
                <div style={{ marginBottom: 12 }}>
                  <div style={{ ...S.sectionLabel, marginBottom: 6 }}>NAME</div>
                  <input value={orgModal.name} onChange={e => setOrgModal(m => ({ ...m, name: e.target.value }))}
                    placeholder="Company name" style={S.input} />
                </div>
                <div style={{ marginBottom: 20 }}>
                  <div style={{ ...S.sectionLabel, marginBottom: 6 }}>LEARNWORLDS TAG</div>
                  <input value={orgModal.tag} onChange={e => setOrgModal(m => ({ ...m, tag: e.target.value }))}
                    placeholder="e.g. ACME" style={S.input} />
                </div>
                <div style={{ display: 'flex', gap: 10 }}>
                  <button onClick={saveOrg} disabled={orgSaving || !orgModal.name.trim()}
                    style={{ background: '#FFF469', color: '#000', border: 'none', cursor: 'pointer', padding: '10px 20px', fontSize: 12, fontWeight: 700, letterSpacing: '0.08em' }}>
                    {orgSaving ? 'SAVING...' : 'SAVE'}
                  </button>
                  <button onClick={() => setOrgModal(null)}
                    style={{ background: 'none', border: '1px solid #2a2a2a', color: '#666', cursor: 'pointer', padding: '10px 20px', fontSize: 12 }}>
                    CANCEL
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ─── User Drawer ───────────────────────────────────────────────────────────

    function UserDrawer({ user, completions, onClose, onUserUpdate }) {
      const [responses, setResponses] = useState([]);
      const [challenges, setChallenges] = useState([]);
      const [orgs, setOrgs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [editMode, setEditMode] = useState(false);
      const [editName, setEditName] = useState(user.full_name || '');
      const [editEmail, setEditEmail] = useState(user.email || '');
      const [editOrgId, setEditOrgId] = useState(user.organization_id || '');
      const [saving, setSaving] = useState(false);
      const [notes, setNotes] = useState('');
      const [savingNotes, setSavingNotes] = useState(false);
      const [unlocking, setUnlocking] = useState(null);
      const [adminUnlocks, setAdminUnlocks] = useState([]);

      useEffect(() => { loadUserData(); }, [user.id]);

      async function loadUserData() {
        setLoading(true);
        try {
          const [{ data: respData }, { data: chalData }, { data: orgsData }, { data: notesData }, { data: unlockData }] = await Promise.all([
            db.from('user_responses')
              .select('id, response_value, response_data, created_at, updated_at, tool_questions(tool_slug, question_text, question_key)')
              .eq('user_id', user.id)
              .order('created_at', { ascending: true }),
            db.from('ai_challenge_log')
              .select('tool_slug, user_action, tokens_used, response_time_ms, created_at')
              .eq('user_id', user.id)
              .order('created_at', { ascending: false })
              .limit(5),
            db.from('organizations').select('id, name').order('name'),
            db.from('admin_notes').select('note').eq('target_type', 'user').eq('target_id', user.id).maybeSingle(),
            db.from('tool_completions').select('tool_slug').eq('user_id', user.id).eq('source', 'admin_unlock')
          ]);
          setResponses(respData || []);
          setChallenges(chalData || []);
          setOrgs(orgsData || []);
          setNotes(notesData?.note || '');
          setAdminUnlocks((unlockData || []).map(r => r.tool_slug));
        } catch (err) {
          console.error('User drawer error:', err);
        }
        setLoading(false);
      }

      async function saveUser() {
        setSaving(true);
        const { error } = await db.from('users').update({
          full_name: editName, email: editEmail, organization_id: editOrgId || null
        }).eq('id', user.id);
        if (!error) {
          setEditMode(false);
          if (onUserUpdate) onUserUpdate({ ...user, full_name: editName, email: editEmail, organization_id: editOrgId || null, organization_name: orgs.find(o => o.id === editOrgId)?.name || user.organization_name });
        }
        setSaving(false);
      }

      async function saveNotes() {
        setSavingNotes(true);
        const { data: existing } = await db.from('admin_notes').select('id').eq('target_type', 'user').eq('target_id', user.id).maybeSingle();
        if (existing) {
          await db.from('admin_notes').update({ note: notes, updated_at: new Date().toISOString() }).eq('id', existing.id);
        } else {
          await db.from('admin_notes').insert({ target_type: 'user', target_id: user.id, note: notes });
        }
        setSavingNotes(false);
      }

      async function unlockTool(toolSlug) {
        if (unlocking) return;
        if (!window.confirm(`Unlock "${toolSlug}" for ${user.full_name || user.email}?`)) return;
        setUnlocking(toolSlug);
        await db.from('tool_completions').insert({
          user_id: user.id, tool_slug: toolSlug,
          completed_at: new Date().toISOString(), source: 'admin_unlock'
        });
        setAdminUnlocks(prev => [...prev, toolSlug]);
        setUnlocking(null);
      }

      const userCompletions = useMemo(() =>
        completions
          .filter(c => c.user_id === user.id)
          .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at)),
        [completions, user.id]
      );

      const toolTimeline = useMemo(() =>
        userCompletions.map(c => {
          const toolResps = responses.filter(r => r.tool_questions?.tool_slug === c.tool_slug);
          const minStart = toolResps.reduce((min, r) => {
            const t = new Date(r.created_at).getTime();
            return t < min ? t : min;
          }, Infinity);
          const duration = minStart !== Infinity
            ? new Date(c.completed_at).getTime() - minStart
            : null;
          return { ...c, duration };
        }),
        [userCompletions, responses]
      );

      const completedSlugs = useMemo(() =>
        new Set(userCompletions.map(c => c.tool_slug)),
        [userCompletions]
      );

      const inProgressSlugs = useMemo(() => {
        const allSlugs = [...new Set(responses.map(r => r.tool_questions?.tool_slug).filter(Boolean))];
        return allSlugs.filter(s => !completedSlugs.has(s));
      }, [responses, completedSlugs]);

      const latestToolAnswers = useMemo(() => {
        if (!responses.length) return [];
        const sorted = [...responses].sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
        const latestSlug = sorted[0]?.tool_questions?.tool_slug;
        if (!latestSlug) return [];
        return responses.filter(r => r.tool_questions?.tool_slug === latestSlug);
      }, [responses]);

      const drawerSection = { ...S.sectionLabel, marginTop: 20, marginBottom: 8, paddingTop: 16, borderTop: '1px solid #222' };

      const btnStyle = { background: 'none', border: 'none', cursor: 'pointer' };

      return (
        <div style={{
          width: 340, borderLeft: '1px solid #222', background: '#0a0a0a',
          overflow: 'auto', maxHeight: 'calc(100vh - 52px)', flexShrink: 0,
          display: 'flex', flexDirection: 'column'
        }}>
          {/* Header */}
          <div style={{
            padding: '18px 18px 14px', borderBottom: '1px solid #1a1a1a',
            position: 'sticky', top: 0, background: '#0a0a0a', zIndex: 1
          }}>
            {editMode ? (
              <div>
                <input value={editName} onChange={e => setEditName(e.target.value)} placeholder="Full name"
                  style={{ ...S.input, marginBottom: 8, fontSize: 13, padding: '8px 10px' }} />
                <input value={editEmail} onChange={e => setEditEmail(e.target.value)} placeholder="Email"
                  style={{ ...S.input, marginBottom: 8, fontSize: 13, padding: '8px 10px' }} />
                <select value={editOrgId} onChange={e => setEditOrgId(e.target.value)}
                  style={{ ...S.input, marginBottom: 10, fontSize: 13, padding: '8px 10px' }}>
                  <option value="">No org</option>
                  {orgs.map(o => <option key={o.id} value={o.id}>{o.name}</option>)}
                </select>
                <div style={{ display: 'flex', gap: 8 }}>
                  <button onClick={saveUser} disabled={saving}
                    style={{ background: '#FFF469', color: '#000', border: 'none', cursor: 'pointer', fontWeight: 700, fontSize: 11, letterSpacing: '0.06em', padding: '6px 14px' }}>
                    {saving ? 'SAVING...' : 'SAVE'}
                  </button>
                  <button onClick={() => setEditMode(false)}
                    style={{ ...btnStyle, color: '#555', fontSize: 11, padding: '6px 10px' }}>CANCEL</button>
                </div>
              </div>
            ) : (
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <div style={{ flex: 1, minWidth: 0 }}>
                  <div style={{ fontFamily: 'Plaak, sans-serif', fontSize: 16, color: '#FFF469', letterSpacing: '0.02em' }}>
                    {user.full_name || 'Unknown'}
                  </div>
                  <div style={{ fontSize: 11, color: '#B2B2B2', marginTop: 3, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                    {user.email}
                  </div>
                  <div style={{ fontSize: 11, color: '#B2B2B2', marginTop: 2 }}>
                    {user.organization_name || 'No org'} · Joined {timeAgo(user.created_at)}
                  </div>
                </div>
                <div style={{ display: 'flex', gap: 2, marginLeft: 8, alignItems: 'center' }}>
                  <button onClick={() => setEditMode(true)} title="Edit user"
                    style={{ ...btnStyle, color: '#555', fontSize: 15, padding: '2px 6px' }}>✎</button>
                  <a href={`https://fasttracktools.up.railway.app/dashboard.html?preview_uid=${user.id}`}
                    target="_blank" rel="noopener noreferrer" title="View as user"
                    style={{ color: '#555', fontSize: 13, padding: '2px 6px', textDecoration: 'none', lineHeight: 1.5 }}>↗</a>
                  <button onClick={onClose}
                    style={{ ...btnStyle, color: '#444', fontSize: 20, padding: '0 0 0 4px', lineHeight: 1, marginTop: -2 }}>×</button>
                </div>
              </div>
            )}
          </div>

          {/* Body */}
          <div style={{ padding: '8px 18px 24px', flex: 1 }}>
            {loading ? (
              <div style={{ color: '#444', textAlign: 'center', padding: 40, fontSize: 12 }}>Loading...</div>
            ) : (
              <>
                {/* Completed Tools */}
                <div style={{ ...drawerSection, borderTop: 'none', paddingTop: 12 }}>
                  COMPLETED TOOLS ({toolTimeline.length})
                </div>
                {toolTimeline.length === 0 ? (
                  <div style={{ fontSize: 12, color: '#444' }}>None yet</div>
                ) : (
                  toolTimeline.map((t, i) => (
                    <div key={i} style={{
                      display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                      padding: '7px 0', borderBottom: '1px solid #161616'
                    }}>
                      <div style={{ fontFamily: 'Monument, monospace', fontSize: 11, color: '#aaa' }}>
                        {t.tool_slug}
                      </div>
                      <div style={{ textAlign: 'right', fontSize: 11, color: '#B2B2B2' }}>
                        <div>{fmtDate(t.completed_at)}</div>
                        {fmtDuration(t.duration) && (
                          <div style={{ color: '#3a3a3a' }}>{fmtDuration(t.duration)}</div>
                        )}
                      </div>
                    </div>
                  ))
                )}

                {/* In Progress */}
                {inProgressSlugs.length > 0 && (
                  <>
                    <div style={drawerSection}>IN PROGRESS</div>
                    {inProgressSlugs.map(slug => {
                      const answered = responses.filter(r => r.tool_questions?.tool_slug === slug).length;
                      return (
                        <div key={slug} style={{
                          display: 'flex', justifyContent: 'space-between',
                          padding: '7px 0', borderBottom: '1px solid #161616'
                        }}>
                          <div style={{ fontFamily: 'Monument, monospace', fontSize: 11, color: '#FFF469' }}>{slug}</div>
                          <div style={{ fontSize: 12, color: '#B2B2B2' }}>{answered} answered</div>
                        </div>
                      );
                    })}
                  </>
                )}

                {/* AI Challenges */}
                {challenges.length > 0 && (
                  <>
                    <div style={drawerSection}>RECENT AI CHALLENGES</div>
                    {challenges.map((c, i) => (
                      <div key={i} style={{ padding: '7px 0', borderBottom: '1px solid #161616' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 3 }}>
                          <span style={{ fontFamily: 'Monument, monospace', fontSize: 11, color: '#777' }}>
                            {c.tool_slug}
                          </span>
                          <span style={{ fontSize: 11, color: '#444' }}>{timeAgo(c.created_at)}</span>
                        </div>
                        <div style={{ fontSize: 12, color: actionColor(c.user_action) }}>
                          {c.user_action || '—'}
                        </div>
                      </div>
                    ))}
                  </>
                )}

                {/* Latest Tool Answers */}
                {latestToolAnswers.length > 0 && (
                  <>
                    <div style={drawerSection}>
                      LATEST ANSWERS —{' '}
                      <span style={{ fontFamily: 'Monument, monospace', fontSize: 10 }}>
                        {latestToolAnswers[0]?.tool_questions?.tool_slug}
                      </span>
                    </div>
                    {latestToolAnswers.map((r, i) => (
                      <div key={i} style={{ padding: '8px 0', borderBottom: '1px solid #161616' }}>
                        <div style={{ fontSize: 11, color: '#B2B2B2', marginBottom: 4 }}>
                          {r.tool_questions?.question_text || r.tool_questions?.question_key || '—'}
                        </div>
                        <div style={{ fontSize: 12, color: '#bbb', wordBreak: 'break-word', whiteSpace: 'pre-wrap' }}>
                          {r.response_value
                            || (r.response_data
                              ? JSON.stringify(r.response_data, null, 2)
                              : <span style={{ color: '#444' }}>—</span>
                            )
                          }
                        </div>
                      </div>
                    ))}
                  </>
                )}

                {/* Admin Notes */}
                <div style={drawerSection}>ADMIN NOTES</div>
                <textarea
                  value={notes}
                  onChange={e => setNotes(e.target.value)}
                  placeholder="Internal notes about this user..."
                  rows={3}
                  style={{ ...S.input, resize: 'none', fontSize: 12, fontFamily: 'Riforma, sans-serif', marginBottom: 8 }}
                />
                <button
                  onClick={saveNotes}
                  disabled={savingNotes}
                  style={{ background: savingNotes ? '#333' : '#1a1a1a', border: '1px solid #2a2a2a', color: savingNotes ? '#555' : '#888', padding: '5px 14px', fontSize: 11, cursor: 'pointer', letterSpacing: '0.06em' }}
                >
                  {savingNotes ? 'SAVING...' : 'SAVE NOTES'}
                </button>

                {/* Tool Access */}
                <div style={drawerSection}>TOOL ACCESS — CLICK TO UNLOCK</div>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: 4 }}>
                  {ALL_TOOLS.map(slug => {
                    const isDone = completedSlugs.has(slug);
                    const isAdminUnlocked = adminUnlocks.includes(slug);
                    const isUnlockingThis = unlocking === slug;
                    return (
                      <button
                        key={slug}
                        onClick={() => !isDone && !isAdminUnlocked && unlockTool(slug)}
                        title={isDone ? 'Completed' : isAdminUnlocked ? 'Admin unlocked' : `Click to unlock ${slug}`}
                        style={{
                          fontFamily: 'Monument, monospace', fontSize: 9, padding: '3px 6px',
                          border: isDone ? '1px solid #44ff88' : isAdminUnlocked ? '1px solid #FFF469' : '1px solid #222',
                          background: isDone ? '#0a1f0a' : isAdminUnlocked ? '#1a1900' : '#111',
                          color: isDone ? '#44ff88' : isAdminUnlocked ? '#FFF469' : '#444',
                          cursor: isDone || isAdminUnlocked ? 'default' : 'pointer',
                          opacity: isUnlockingThis ? 0.5 : 1,
                        }}
                      >
                        {slug}
                      </button>
                    );
                  })}
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    // ─── Users View ────────────────────────────────────────────────────────────

    function UsersView({ selectedUser, onSelectUser }) {
      const [users, setUsers] = useState([]);
      const [completions, setCompletions] = useState([]);
      const [currentTool, setCurrentTool] = useState({});
      const [lastActivity, setLastActivity] = useState({});
      const [search, setSearch] = useState('');
      const [loading, setLoading] = useState(true);

      useEffect(() => { loadData(); }, []);

      async function toggleGuru(user, e) {
        e.stopPropagation();
        const newRole = user.role === 'guru' ? 'participant' : 'guru';
        await db.from('users').update({ role: newRole }).eq('id', user.id);
        setUsers(prev => prev.map(u => u.id === user.id ? { ...u, role: newRole } : u));
      }

      async function loadData() {
        setLoading(true);
        try {
          const [
            { data: usersData },
            { data: compData },
            { data: actData }
          ] = await Promise.all([
            db.from('users').select('*').order('full_name'),
            db.from('tool_completions').select('user_id, tool_slug, completed_at'),
            db.from('user_responses')
              .select('user_id, updated_at, tool_questions(tool_slug)')
              .order('updated_at', { ascending: false })
          ]);

          setUsers(usersData || []);
          setCompletions(compData || []);

          const la = {}, ct = {};
          (actData || []).forEach(r => {
            if (!la[r.user_id]) la[r.user_id] = r.updated_at;
            if (!ct[r.user_id]) ct[r.user_id] = r.tool_questions?.tool_slug || null;
          });
          setLastActivity(la);
          setCurrentTool(ct);
        } catch (err) {
          console.error('Users load error:', err);
        }
        setLoading(false);
      }

      const filtered = useMemo(() => {
        const q = search.toLowerCase().trim();
        if (!q) return users;
        return users.filter(u =>
          (u.full_name || '').toLowerCase().includes(q) ||
          (u.email || '').toLowerCase().includes(q) ||
          (u.organization_name || '').toLowerCase().includes(q)
        );
      }, [users, search]);

      if (loading) return <LoadingState />;

      return (
        <div style={{ display: 'flex', gap: 0, height: '100%', overflow: 'hidden' }}>
          <div style={{ flex: 1, overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20, flexShrink: 0 }}>
              <h2 style={{ ...S.viewTitle, marginBottom: 0 }}>
                Users <span style={{ fontSize: 14, color: '#444', fontFamily: 'Riforma, sans-serif', fontWeight: 'normal' }}>({filtered.length})</span>
              </h2>
              <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>
                <input
                  type="text"
                  placeholder="Search name, email, company..."
                  value={search}
                  onChange={e => setSearch(e.target.value)}
                  style={{ ...S.input, width: 240, fontSize: 13, padding: '8px 12px' }}
                />
                <button
                  onClick={() => exportCSV(filtered.map(u => ({
                    Name: u.full_name || '',
                    Email: u.email || '',
                    Company: u.organization_name || '',
                    Role: u.role || 'participant',
                    'Tools Done': completions.filter(c => c.user_id === u.id).length,
                    'Last Active': lastActivity[u.id] ? new Date(lastActivity[u.id]).toLocaleDateString('en-GB') : '',
                    Joined: u.created_at ? new Date(u.created_at).toLocaleDateString('en-GB') : '',
                  })), `ft-users-${new Date().toISOString().slice(0,10)}.csv`)}
                  style={{ background: '#1a1a1a', border: '1px solid #2a2a2a', color: '#888', cursor: 'pointer', padding: '8px 14px', fontSize: 11, letterSpacing: '0.06em', whiteSpace: 'nowrap' }}
                >
                  EXPORT CSV
                </button>
              </div>
            </div>

            <div style={{ ...S.card, overflow: 'auto', flex: 1 }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead style={{ position: 'sticky', top: 0, background: '#111', zIndex: 1 }}>
                  <tr style={{ background: '#0d0d0d', borderBottom: '1px solid #1f1f1f' }}>
                    {['Name', 'Email', 'Company', 'Role', 'Tools Done', 'Current Tool', 'Last Active'].map(h => (
                      <th key={h} style={S.th}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {filtered.length === 0 && (
                    <tr>
                      <td colSpan={7} style={{ ...S.td, color: '#444', textAlign: 'center', padding: 40 }}>
                        No users found
                      </td>
                    </tr>
                  )}
                  {filtered.map(user => {
                    const done = completions.filter(c => c.user_id === user.id).length;
                    const ct = currentTool[user.id];
                    const la = lastActivity[user.id];
                    const isSelected = selectedUser?.id === user.id;
                    return (
                      <tr
                        key={user.id}
                        onClick={() => onSelectUser(isSelected ? null : user)}
                        style={{
                          borderTop: '1px solid #1a1a1a', cursor: 'pointer',
                          background: isSelected ? '#151500' : 'transparent',
                          transition: 'background 0.1s'
                        }}
                        onMouseEnter={e => { if (!isSelected) e.currentTarget.style.background = '#0f0f00'; }}
                        onMouseLeave={e => { if (!isSelected) e.currentTarget.style.background = 'transparent'; }}
                      >
                        <td style={S.td}>
                          <span style={{ color: '#FFF469' }}>{user.full_name || '—'}</span>
                        </td>
                        <td style={{ ...S.td, color: '#B2B2B2', fontSize: 12 }}>{user.email}</td>
                        <td style={{ ...S.td, color: '#B2B2B2', fontSize: 12 }}>{user.organization_name || '—'}</td>
                        <td style={S.td}>
                          <button
                            onClick={e => toggleGuru(user, e)}
                            title={user.role === 'guru' ? 'Click to remove guru' : 'Click to make guru'}
                            style={{
                              background: user.role === 'guru' ? '#FFF469' : '#1a1a1a',
                              color: user.role === 'guru' ? '#000' : '#444',
                              border: user.role === 'guru' ? 'none' : '1px solid #2a2a2a',
                              padding: '3px 10px',
                              fontFamily: 'Monument, monospace',
                              fontSize: 10,
                              letterSpacing: '0.06em',
                              cursor: 'pointer',
                              textTransform: 'uppercase',
                            }}
                          >
                            {user.role === 'guru' ? 'GURU' : user.role || 'participant'}
                          </button>
                        </td>
                        <td style={{ ...S.td, color: done > 0 ? '#ccc' : '#444' }}>{done}</td>
                        <td style={{ ...S.td, fontFamily: ct ? 'Monument, monospace' : 'inherit', fontSize: ct ? 11 : 13, color: ct ? '#B2B2B2' : '#555' }}>
                          {ct || '—'}
                        </td>
                        <td style={{ ...S.td, color: '#B2B2B2', fontSize: 12 }}>{timeAgo(la)}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>

          {selectedUser && (
            <UserDrawer
              user={selectedUser}
              completions={completions}
              onClose={() => onSelectUser(null)}
              onUserUpdate={updatedUser => {
                setUsers(prev => prev.map(u => u.id === updatedUser.id ? updatedUser : u));
                setSelectedUser(updatedUser);
              }}
            />
          )}
        </div>
      );
    }

    // ─── Logs View ─────────────────────────────────────────────────────────────

    function LogsView() {
      const [tab, setTab] = useState('errors');
      const [errors, setErrors] = useState([]);
      const [challenges, setChallenges] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => { loadData(); }, []);

      async function loadData() {
        setLoading(true);
        try {
          const [{ data: webhookData }, { data: chalData }] = await Promise.all([
            db.from('webhook_events')
              .select('id, source, event_type, error_message, payload, created_at')
              .order('created_at', { ascending: false })
              .limit(200),
            db.from('ai_challenge_log')
              .select('user_id, tool_slug, user_action, tokens_used, response_time_ms, created_at')
              .order('created_at', { ascending: false })
              .limit(500)
          ]);
          setErrors(webhookData || []);
          setChallenges(chalData || []);
        } catch (err) {
          console.error('Logs load error:', err);
        }
        setLoading(false);
      }

      async function replayWebhook(event) {
        if (!window.confirm(`Replay this ${event.event_type} event?`)) return;
        try {
          await fetch('https://backend-production-639c.up.railway.app/api/webhook', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(event.payload)
          });
          alert('Replay sent!');
        } catch (err) {
          alert('Replay failed: ' + err.message);
        }
      }

      const aiStats = useMemo(() => {
        const byTool = {};
        challenges.forEach(c => {
          if (!byTool[c.tool_slug]) byTool[c.tool_slug] = { total: 0, revised: 0, submitted_anyway: 0, tokens: [], ms: [] };
          const t = byTool[c.tool_slug];
          t.total++;
          if (c.user_action === 'revised') t.revised++;
          if (c.user_action === 'submitted_anyway') t.submitted_anyway++;
          if (c.tokens_used) t.tokens.push(c.tokens_used);
          if (c.response_time_ms) t.ms.push(c.response_time_ms);
        });
        return Object.entries(byTool).map(([slug, d]) => ({
          slug,
          total: d.total,
          revised: d.revised,
          submitted_anyway: d.submitted_anyway,
          passRate: d.total > 0 ? Math.round((d.revised / d.total) * 100) : 0,
          avgTokens: d.tokens.length ? Math.round(d.tokens.reduce((a, b) => a + b, 0) / d.tokens.length) : null,
          avgMs: d.ms.length ? Math.round(d.ms.reduce((a, b) => a + b, 0) / d.ms.length) : null,
        })).sort((a, b) => b.total - a.total);
      }, [challenges]);

      if (loading) return <LoadingState />;

      const errorCount = errors.filter(e => e.error_message).length;
      const tabs = [
        ['webhooks', `Webhooks (${errors.length})`],
        ['challenges', `AI Challenges (${challenges.length})`],
        ['aistats', `AI Stats (${aiStats.length} tools)`],
      ];

      return (
        <div>
          <h2 style={S.viewTitle}>Logs</h2>

          {/* Tab bar */}
          <div style={{ display: 'flex', borderBottom: '1px solid #1f1f1f', marginBottom: 20 }}>
            {tabs.map(([key, label]) => (
              <button
                key={key}
                onClick={() => setTab(key)}
                style={{
                  padding: '10px 20px', background: 'none', border: 'none',
                  color: tab === key ? '#FFF469' : '#555',
                  fontSize: 11, letterSpacing: '0.1em', cursor: 'pointer',
                  borderBottom: tab === key ? '2px solid #FFF469' : '2px solid transparent',
                  marginBottom: -1, textTransform: 'uppercase'
                }}
              >
                {label}
              </button>
            ))}
          </div>

          {tab === 'webhooks' && (
            <div style={{ ...S.card, overflow: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ background: '#0d0d0d' }}>
                    {['Status', 'Source', 'Event Type', 'Error', 'Time', ''].map(h => (
                      <th key={h} style={S.th}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {errors.length === 0 && (
                    <tr>
                      <td colSpan={6} style={{ ...S.td, color: '#444', textAlign: 'center', padding: 40 }}>
                        No webhook events
                      </td>
                    </tr>
                  )}
                  {errors.map((e, i) => (
                    <tr key={i} style={{ borderTop: '1px solid #1a1a1a' }}>
                      <td style={{ ...S.td, fontSize: 11 }}>
                        <span style={{ color: e.error_message ? '#ff5555' : '#44ff88', fontFamily: 'Monument, monospace', fontSize: 10 }}>
                          {e.error_message ? 'ERR' : 'OK'}
                        </span>
                      </td>
                      <td style={{ ...S.td, fontFamily: 'Monument, monospace', fontSize: 11, color: '#888' }}>{e.source}</td>
                      <td style={{ ...S.td, fontSize: 12 }}>{e.event_type}</td>
                      <td style={{ ...S.td, color: '#ff5555', fontSize: 12, maxWidth: 280, wordBreak: 'break-word' }}>
                        {e.error_message || <span style={{ color: '#333' }}>—</span>}
                      </td>
                      <td style={{ ...S.td, color: '#B2B2B2', fontSize: 12, whiteSpace: 'nowrap' }}>{fmtDate(e.created_at)}</td>
                      <td style={{ ...S.td, fontSize: 12 }}>
                        <button onClick={() => replayWebhook(e)}
                          style={{ background: 'none', border: '1px solid #2a2a2a', color: '#555', cursor: 'pointer', padding: '3px 8px', fontSize: 10, letterSpacing: '0.05em' }}>
                          REPLAY
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {tab === 'challenges' && (
            <div style={{ ...S.card, overflow: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ background: '#0d0d0d' }}>
                    {['User', 'Tool', 'Action', 'Tokens', 'Resp. ms', 'Time'].map(h => (
                      <th key={h} style={S.th}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {challenges.length === 0 && (
                    <tr>
                      <td colSpan={6} style={{ ...S.td, color: '#444', textAlign: 'center', padding: 40 }}>
                        No challenges logged
                      </td>
                    </tr>
                  )}
                  {challenges.map((c, i) => (
                    <tr key={i} style={{ borderTop: '1px solid #1a1a1a' }}>
                      <td style={{ ...S.td, fontSize: 11, color: '#B2B2B2', maxWidth: 160, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                        {c.user_id}
                      </td>
                      <td style={{ ...S.td, fontFamily: 'Monument, monospace', fontSize: 11, color: '#aaa' }}>
                        {c.tool_slug}
                      </td>
                      <td style={{ ...S.td, fontSize: 12, color: actionColor(c.user_action) }}>
                        {c.user_action || '—'}
                      </td>
                      <td style={{ ...S.td, fontSize: 12, color: '#B2B2B2' }}>{c.tokens_used ?? '—'}</td>
                      <td style={{ ...S.td, fontSize: 12, color: '#B2B2B2' }}>{c.response_time_ms ?? '—'}</td>
                      <td style={{ ...S.td, color: '#B2B2B2', fontSize: 12, whiteSpace: 'nowrap' }}>
                        {fmtDate(c.created_at)}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {tab === 'aistats' && (
            <div style={{ ...S.card, overflow: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ background: '#0d0d0d' }}>
                    {['Tool', 'Total', 'Revised ✓', 'Forced ✗', 'Pass %', 'Avg Tokens', 'Avg ms'].map(h => (
                      <th key={h} style={S.th}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {aiStats.length === 0 && (
                    <tr>
                      <td colSpan={7} style={{ ...S.td, color: '#444', textAlign: 'center', padding: 40 }}>No AI challenge data</td>
                    </tr>
                  )}
                  {aiStats.map((s, i) => (
                    <tr key={i} style={{ borderTop: '1px solid #1a1a1a' }}>
                      <td style={{ ...S.td, fontFamily: 'Monument, monospace', fontSize: 11, color: '#aaa' }}>{s.slug}</td>
                      <td style={S.td}>{s.total}</td>
                      <td style={{ ...S.td, color: '#44ff88' }}>{s.revised}</td>
                      <td style={{ ...S.td, color: '#ff8844' }}>{s.submitted_anyway}</td>
                      <td style={{ ...S.td, color: s.passRate >= 70 ? '#44ff88' : s.passRate >= 40 ? '#FFF469' : '#ff5555' }}>
                        {s.passRate}%
                      </td>
                      <td style={{ ...S.td, color: '#B2B2B2' }}>{s.avgTokens ?? '—'}</td>
                      <td style={{ ...S.td, color: '#B2B2B2' }}>{s.avgMs ?? '—'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      );
    }

    // ─── Admin Panel Layout ────────────────────────────────────────────────────

    function AdminPanel({ user, adminUser, onLogout }) {
      const [view, setView] = useState('overview');
      const [selectedUser, setSelectedUser] = useState(null);

      const navItems = [
        { id: 'overview', label: 'Overview' },
        { id: 'companies', label: 'Companies' },
        { id: 'users', label: 'Users' },
        { id: 'logs', label: 'Logs' }
      ];

      function handleSelectUser(u) {
        setSelectedUser(u);
        if (u && view !== 'users') setView('users');
      }

      return (
        <div style={{ display: 'flex', flexDirection: 'column', height: '100vh', background: '#000', overflow: 'hidden' }}>
          {/* Top bar */}
          <div style={{
            display: 'flex', alignItems: 'center', justifyContent: 'space-between',
            padding: '0 24px', height: 52, background: '#000',
            borderBottom: '1px solid #1a1a1a', flexShrink: 0
          }}>
            <div style={{
              fontFamily: 'Plaak, sans-serif', fontSize: 15,
              color: '#FFF469', letterSpacing: '0.12em'
            }}>
              FT ADMIN
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: 14 }}>
              <span style={{ fontSize: 12, color: '#B2B2B2' }}>
                {adminUser?.name || user.email}
              </span>
              <button
                onClick={onLogout}
                style={{
                  background: 'none', border: '1px solid #2a2a2a', color: '#666',
                  padding: '5px 14px', cursor: 'pointer', fontSize: 11,
                  letterSpacing: '0.05em', transition: 'border-color 0.15s, color 0.15s'
                }}
                onMouseEnter={e => { e.target.style.borderColor = '#555'; e.target.style.color = '#999'; }}
                onMouseLeave={e => { e.target.style.borderColor = '#2a2a2a'; e.target.style.color = '#666'; }}
              >
                LOGOUT
              </button>
            </div>
          </div>

          {/* Body */}
          <div style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
            {/* Sidebar */}
            <div style={{
              width: 170, background: '#000', borderRight: '1px solid #1a1a1a',
              padding: '20px 0', flexShrink: 0
            }}>
              {navItems.map(item => (
                <button
                  key={item.id}
                  onClick={() => setView(item.id)}
                  style={{
                    display: 'block', width: '100%', textAlign: 'left',
                    padding: '11px 24px', background: 'none', border: 'none',
                    color: view === item.id ? '#FFF469' : '#B2B2B2',
                    fontSize: 13, cursor: 'pointer', letterSpacing: '0.03em',
                    borderLeft: view === item.id ? '2px solid #FFF469' : '2px solid transparent',
                    transition: 'color 0.1s'
                  }}
                  onMouseEnter={e => { if (view !== item.id) e.currentTarget.style.color = '#fff'; }}
                  onMouseLeave={e => { if (view !== item.id) e.currentTarget.style.color = '#B2B2B2'; }}
                >
                  {item.label}
                </button>
              ))}
            </div>

            {/* Main content */}
            <div style={{ flex: 1, overflow: 'auto', padding: '28px 28px 28px 28px', display: 'flex', flexDirection: 'column' }}>
              {view === 'overview' && <OverviewView />}
              {view === 'companies' && <CompaniesView onSelectUser={handleSelectUser} />}
              {view === 'users' && (
                <UsersView selectedUser={selectedUser} onSelectUser={setSelectedUser} />
              )}
              {view === 'logs' && <LogsView />}
            </div>
          </div>
        </div>
      );
    }

    // ─── App Root ──────────────────────────────────────────────────────────────

    function App() {
      const [authState, setAuthState] = useState('loading');
      const [user, setUser] = useState(null);
      const [adminUser, setAdminUser] = useState(null);
      const [error, setError] = useState('');

      useEffect(() => {
        db.auth.getSession().then(({ data: { session } }) => {
          if (session?.user) {
            checkAdmin(session.user);
          } else {
            setAuthState('logged_out');
          }
        });

        const { data: listener } = db.auth.onAuthStateChange((event, session) => {
          if (event === 'SIGNED_OUT') {
            setAuthState('logged_out');
            setUser(null);
            setAdminUser(null);
            setError('');
          }
        });

        return () => listener.subscription.unsubscribe();
      }, []);

      async function checkAdmin(authUser) {
        try {
          const { data, error: dbErr } = await db
            .from('admin_users')
            .select('id, name')
            .eq('id', authUser.id)
            .single();

          if (data) {
            setUser(authUser);
            setAdminUser(data);
            setAuthState('logged_in');
          } else {
            await db.auth.signOut();
            setError('Access denied. This account is not authorised for admin access.');
            setAuthState('logged_out');
          }
        } catch (err) {
          await db.auth.signOut();
          setError('Access denied. This account is not authorised for admin access.');
          setAuthState('logged_out');
        }
      }

      async function handleLogin(email, password) {
        setError('');
        const { data, error: authErr } = await db.auth.signInWithPassword({ email, password });
        if (authErr) throw authErr;
        await checkAdmin(data.user);
      }

      async function handleLogout() {
        await db.auth.signOut();
      }

      if (authState === 'loading') {
        return (
          <div style={{
            display: 'flex', alignItems: 'center', justifyContent: 'center',
            height: '100vh', background: '#000'
          }}>
            <div style={{ fontFamily: 'Monument, monospace', fontSize: 12, color: '#B2B2B2', letterSpacing: '0.1em' }}>
              LOADING...
            </div>
          </div>
        );
      }

      if (authState === 'logged_in' && user) {
        return <AdminPanel user={user} adminUser={adminUser} onLogout={handleLogout} />;
      }

      return <LoginScreen onLogin={handleLogin} error={error} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
