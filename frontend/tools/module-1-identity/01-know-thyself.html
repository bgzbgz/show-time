<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Know Thyself | Fast Track Tool</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- ToolDB shared library -->
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <!-- Dependency Injection -->
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

    <!-- Font preloading to prevent FOUT -->
    <link rel="preload" href="Plaak3Trial-43-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="RiformaLL-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="MonumentGrotesk-Mono.woff2" as="font" type="font/woff2" crossorigin>

    <style>
        /* === FONT FACES === */
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); font-display: swap; }

        /* === BASE RESET === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Riforma', -apple-system, sans-serif;
            font-size: 16px;
            color: #000;
            background: #000;
            -webkit-font-smoothing: antialiased;
        }

        /* === CUSTOM SCROLLBAR === */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        * { scrollbar-width: thin; scrollbar-color: #000 transparent; }

        /* === TYPOGRAPHY HELPERS === */
        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        /* === LAYOUT FRAME === */
        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        /* === WIZARD LAYOUT === */
        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fff;
        }
        .wizard-content { flex: 1; padding: 48px 32px; max-width: 720px; width: 100%; margin: 0 auto; }

        /* === SIDEBAR === */
        .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }
        .wizard-sidebar-inner {
            padding: 32px 24px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .sidebar-step-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }

        /* === STEP HEADER === */
        .step-indicator {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-time { font-family: 'Monument', monospace; font-size: 11px; color: #6B7280; }
        .step-heading {
            font-family: 'Plaak', sans-serif;
            font-weight: bold;
            font-size: 32px;
            text-transform: uppercase;
            letter-spacing: -0.01em;
            line-height: 1.2;
            color: #000;
            margin-bottom: 6px;
        }
        .step-hint {
            font-size: 16px;
            color: #6B7280;
            line-height: 1.5;
            margin: 0 0 32px 0;
        }

        /* === FORM ELEMENTS === */
        .ft-label {
            display: flex; align-items: center; gap: 6px;
            font-family: 'Monument', monospace; font-size: 14px; font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.05em; color: #000; margin-bottom: 8px;
        }
        .ft-required { color: #DC2626; font-weight: 700; }

        .ft-input {
            width: 100%;
            height: 44px;
            padding: 8px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-input:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px #FFF469; }
        .ft-input.has-error, .ft-input.error { border: 2px solid #DC2626; }

        .ft-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            resize: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-textarea:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px #FFF469; }

        .ft-help { font-size: 14px; color: #6B7280; margin-top: 4px; line-height: 1.5; }
        .ft-error-msg { font-size: 14px; font-weight: 600; color: #DC2626; margin-top: 4px; }
        .ft-field-group { margin-bottom: 24px; }
        .ft-field-group:last-child { margin-bottom: 0; }
        .ft-section { margin-bottom: 32px; }

        /* === YELLOW INSIGHT BOX === */
        .ft-insight { background: #FFF469; border: 3px solid #000; padding: 16px; margin-bottom: 32px; }

        /* === EXAMPLE BOX === */
        .ft-example { background: #F3F4F6; padding: 16px; margin-bottom: 8px; font-size: 14px; line-height: 1.6; color: #1F2937; }

        /* === ERROR SUMMARY === */
        .ft-error-summary { border: 2px solid #DC2626; background: #fff; padding: 16px; margin-bottom: 24px; }
        .ft-error-summary a { color: #DC2626; text-decoration: underline; cursor: pointer; }

        /* === BUTTON FOOTER === */
        .btn-footer {
            position: sticky; bottom: 0; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 32px; border-top: 1px solid #E5E7EB; background: #fff; width: 100%;
        }
        .btn-back {
            background: #fff; color: #000; border: 2px solid #000;
            padding: 12px 24px; font-family: 'Riforma', sans-serif; font-size: 16px;
            cursor: pointer; transition: all 0.2s ease; min-height: 44px;
        }
        .btn-back:hover { background: #F3F4F6; }
        .btn-next {
            background: #000; color: #fff; border: 2px solid #000;
            padding: 12px 24px; font-family: 'Riforma', sans-serif; font-size: 16px;
            cursor: pointer; transition: all 0.2s ease; min-height: 44px;
        }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E5E7EB; color: #9CA3AF; border-color: #E5E7EB; cursor: not-allowed; }

        /* === MOBILE STEP BAR === */
        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; background: #F3F4F6; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E5E7EB; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }

        /* === CANVAS STYLES === */
        .numbered-section { background: #000; color: #fff; padding: 8px 14px; font-size: 14px; font-weight: bold; letter-spacing: 0.5px; display: inline-block; font-family: 'Monument', monospace; }

        /* === ANIMATIONS === */
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.5s ease-out; }

        /* === PRINT === */
        @media print { .no-print { display: none !important; } body { background: white; } }

        /* === RESPONSIVE === */
        @media (min-width: 769px) and (max-width: 1024px) {
            .wizard-sidebar { width: 220px; }
            .wizard-sidebar-inner { padding: 24px 16px; }
        }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .mobile-step-bar { display: block; }
            .wizard-content { padding: 24px 16px; }
            .step-heading { font-size: 24px; }
            .btn-footer { padding: 12px 16px; }
        }
        @media (max-width: 480px) {
            .step-heading { font-size: 20px; }
            .wizard-content { padding: 20px 12px; }
        }

        /* === TOOL-SPECIFIC: Legacy button styles === */
        .btn-primary {
            background: #000; color: #fff; padding: 12px 24px; border: 2px solid #000;
            font-family: 'Riforma', sans-serif; font-size: 16px; cursor: pointer; transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary:disabled { background: #E0E0E0; color: #9CA3AF; cursor: not-allowed; opacity: 0.5; border-color: #E0E0E0; }
        .btn-secondary {
            background: #fff; color: #000; padding: 12px 24px; border: 2px solid #000;
            font-family: 'Riforma', sans-serif; font-size: 16px; cursor: pointer; transition: all 0.2s ease;
        }
        .btn-secondary:hover { background: #F8F8F8; }

        textarea { resize: none !important; min-height: 100px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
            TOOL_SLUG: 'know-thyself',
            AUTOSAVE_DELAY: 2000,
            STORAGE_KEY: 'fasttrack_know_thyself_data',
            TOOL_NAME: 'know_thyself'
        };

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // Make Supabase client globally available for dependency injection
        window.supabaseClient = supabaseClient;

        // Initialize ToolDB and dependency injection
        ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);

        // Initialize cognitive load components
        CognitiveLoad.init('know-thyself', {"insights":["Self-awareness is the foundation of leadership. You cannot lead others until you understand yourself.","The 80/20 rule: 80% of your leadership effectiveness comes from understanding your personal values and strengths."],"caseStudy":{"before":"A mid-sized tech company CEO spent years chasing every market opportunity without a clear sense of personal values or purpose. Team turnover was 40%, strategic direction changed quarterly, and key talent left because they could not see a coherent vision.","after":"After completing the Know Thyself sprint, the CEO articulated a clear identity statement rooted in personal strengths and values. The leadership team aligned around a shared vision, decision-making speed doubled, and employee engagement scores rose by 35% within six months.","quote":"Once I understood my own strengths and values, every business decision became clearer. I stopped second-guessing and started leading with conviction."}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

        /* ============================================================
           TRANSITION CONTENT — VP-style screens between steps
           ============================================================ */
        const TRANSITION_CONTENT = {
            1: {
                title: 'DREAM DEFINED.',
                text: "You've found your reason to get up in the morning. Now let's discover what fuels you.",
                brutalTruth: "Leaders who define a vivid, values-aligned dream make faster decisions and maintain motivation through setbacks. Your 80th birthday vision creates the emotional anchor that drives everything else in Fast Track.",
                peerProof: "Harvard Business Review research shows leaders who write down a vivid personal vision are 42% more likely to achieve their goals. The act of writing activates deeper cognitive processing and creates a psychological contract with yourself."
            },
            2: {
                title: 'STRENGTHS MAPPED.',
                text: "You know what energizes you. Now align your values with your actions.",
                brutalTruth: "Focus on strengths, not weaknesses. Buckingham and Clifton's research proves the key to excellence lies in identifying and cultivating your natural talents. People who focus on strengths are 3x more likely to report an excellent quality of life.",
                peerProof: "Gallup StrengthsFinder research across 1.7M employees found strength-based development is 3x more effective than fixing weaknesses. People who use their strengths daily are 6x more likely to be engaged at work."
            },
            3: {
                title: 'VALUES ALIGNED.',
                text: "Your core values are clear. Now set goals to close the gap between where you are and where you want to be.",
                brutalTruth: "Values-driven decisions eliminate internal conflict. When personal values and professional endeavors are aligned, work becomes deeply fulfilling — not just productive. The pattern in your dream and strengths answers reveals what truly matters.",
                peerProof: "Barrett Values Centre research across 6,000+ organizations shows companies with strong values alignment outperform peers by 4x in revenue growth. When actions align with core values, decisions become faster and more confident."
            },
            4: {
                title: 'PLAN SET.',
                text: "Self-knowledge complete. Your dream, strengths, values, and growth plan are locked in.",
                brutalTruth: "Goals without action plans are wishes. Turn vision into execution with specific actions and deadlines. No vague aspirations — only concrete next steps that connect to your dream.",
                peerProof: "Research on structured goal-setting shows that specific, written action plans increase goal achievement by 42-78% compared to verbal intentions. Your growth blueprint creates the accountability that transforms insight into action."
            }
        };

        /* ============================================================
           SHARED COMPONENTS
           ============================================================ */

        function CheckIcon({ color = "#fff", size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
        }

        function ButtonFooter({ onBack, onNext, nextLabel = 'Next', showBack = true, disabled = false }) {
            return (
                <div className="btn-footer no-print">
                    {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                    <button className="btn-next" disabled={disabled} onClick={onNext}>{nextLabel} &rarr;</button>
                </div>
            );
        }

        function MobileStepBar({ currentStep, totalSteps }) {
            const total = totalSteps || 4;
            const progress = currentStep >= 999 ? 100 : Math.round((currentStep / total) * 100);
            return (
                <div className="mobile-step-bar no-print">
                    <div className="bar-text">Step {Math.min(currentStep, total)} of {total}</div>
                    <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${progress}%` }} /></div>
                </div>
            );
        }

        function CoachFeedbackPanel() {
            const [expanded, setExpanded] = useState(false);
            const [feedback, setFeedback] = useState(null);
            useEffect(() => {
                const check = () => { if (window.AIChallenge && window.AIChallenge.getLastFeedback) setFeedback(window.AIChallenge.getLastFeedback()); };
                check();
                const interval = setInterval(check, 2000);
                return () => clearInterval(interval);
            }, []);
            if (!feedback) return null;
            return (
                <div style={{ marginTop: 24, borderTop: '1px solid #333', paddingTop: 16 }}>
                    <button onClick={() => setExpanded(!expanded)}
                        style={{ background: 'none', border: 'none', color: '#FFF469', cursor: 'pointer', fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', display: 'flex', alignItems: 'center', gap: 6, padding: 0, width: '100%' }}>
                        <span style={{ transform: expanded ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s', display: 'inline-block' }}>&#9654;</span>
                        COACH FEEDBACK
                    </button>
                    {expanded && (
                        <div style={{ marginTop: 10, fontSize: 12, color: '#ccc', lineHeight: 1.5 }}>
                            {feedback.type === 'approved' && <p style={{ color: '#FFF469' }}>{feedback.message}</p>}
                            {feedback.type === 'challenges' && (<>
                                {feedback.encouragement && <p style={{ color: '#FFF469', marginBottom: 8 }}>{feedback.encouragement}</p>}
                                {feedback.challenges && feedback.challenges.map((ch, i) => (
                                    <div key={i} style={{ marginBottom: 8, paddingLeft: 8, borderLeft: '2px solid #555' }}>
                                        <div style={{ fontSize: 10, color: '#999', marginBottom: 2 }}>{ch.question_text || ch.question_key}</div>
                                        <div>{ch.feedback}</div>
                                    </div>
                                ))}
                            </>)}
                        </div>
                    )}
                </div>
            );
        }

        function WizardSidebar({ currentStep, formData, onNavigate }) {
            const steps = [
                { num: 1, label: 'Dream Launcher', time: '~8 min' },
                { num: 2, label: 'Strengths', time: '~5 min' },
                { num: 3, label: 'Values', time: '~5 min' },
                { num: 4, label: 'Growth Plan', time: '~4 min' }
            ];
            const getSnippet = (n) => {
                if (n === 1 && formData.dream) return '"' + formData.dream.substring(0, 50) + (formData.dream.length > 50 ? '...' : '') + '"';
                if (n === 2 && formData.strengths[0]?.strength) { const f = formData.strengths.filter(s => s.strength?.trim()); return f.length + ' strength' + (f.length !== 1 ? 's' : '') + ' mapped'; }
                if (n === 3 && formData.values[0]?.value) { const f = formData.values.filter(v => v.value?.trim()); return f.length + ' value' + (f.length !== 1 ? 's' : '') + ' defined'; }
                if (n === 4 && formData.goals[0]?.goal) { const f = formData.goals.filter(g => g.goal?.trim()); return f.length + ' goal' + (f.length !== 1 ? 's' : '') + ' set'; }
                return null;
            };
            return (
                <div className="wizard-sidebar no-print">
                    <div className="wizard-sidebar-inner">
                        <div style={{ marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>KNOW THYSELF</div>
                            <div style={{ fontSize: 13, color: '#999' }}>~22 min total</div>
                        </div>
                        <div style={{ marginBottom: 16, fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#999' }}>Your journey</div>
                        {steps.map(s => {
                            const effectiveStep = Math.ceil(currentStep);
                            const isCompleted = effectiveStep > s.num, isActive = effectiveStep === s.num, isLocked = effectiveStep < s.num;
                            const snippet = isCompleted ? getSnippet(s.num) : null;
                            return (
                                <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                                    onClick={() => isCompleted && onNavigate && onNavigate(s.num)}
                                    title={isCompleted ? 'Click to review this step' : ''}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                        {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                                        <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                                    </div>
                                    {snippet && <div className="sidebar-snippet">{snippet}</div>}
                                </div>
                            );
                        })}
                        <CoachFeedbackPanel />
                    </div>
                </div>
            );
        }

        // Celebration Screen Component - Fast Track Style (Not Childish)
        function CelebrationScreen({ title, progress, final, onContinue }) {
            React.useEffect(() => {
                // Auto-advance after 2 seconds (quick, confident)
                const timer = setTimeout(() => {
                    onContinue();
                }, 2000);
                return () => clearTimeout(timer);
            }, [onContinue]);

            return (
                <div className="fixed inset-0 bg-black text-white flex items-center justify-center z-50 fade-in">
                    <div className="text-center px-8">
                        {/* Bold Statement - No cheerleading */}
                        <h1 className="plaak text-8xl md:text-9xl mb-8 animate-in">
                            {title}
                        </h1>
                        
                        {/* Progress Metric - Data, not emotion */}
                        <div className="max-w-2xl mx-auto mb-8 animate-in" style={{animationDelay: '0.1s'}}>
                            <div className="h-2 bg-gray-800 mb-4">
                                <div 
                                    className="h-full bg-white transition-all duration-1000"
                                    style={{width: `${progress}%`}}
                                ></div>
                            </div>
                            <p className="monument text-xl tracking-wider">
                                [{progress}% COMPLETE]
                            </p>
                        </div>

                        {/* Next Action - Clear, not playful */}
                        {!final && (
                            <p className="text-xl text-gray-400 animate-in" style={{animationDelay: '0.2s'}}>
                                Next section loading...
                            </p>
                        )}
                        
                        {final && (
                            <div className="animate-in" style={{animationDelay: '0.2s'}}>
                                <p className="text-3xl mb-8 font-bold">Self-knowledge locked in</p>
                                <button 
                                    onClick={onContinue}
                                    className="bg-white text-black plaak text-2xl px-12 py-4 border-4 border-white hover:bg-black hover:text-white hover:border-white transition-all"
                                >
                                    VIEW CANVAS →
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function DependencyContext({ deps }) {
            const [open, setOpen] = React.useState(false);
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '16px' }}>
                    <button onClick={() => setOpen(o => !o)} style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '8px 14px', fontSize: 12, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase', cursor: 'pointer', color: '#555', width: '100%' }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#DAA520" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        CONTEXT FROM PREVIOUS TOOLS ({deps.length})
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#999" strokeWidth="2" style={{ marginLeft: 'auto', transform: open ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    {open && (
                        <div style={{ border: '1px solid #F0E68C', borderTop: 'none', padding: '12px 14px' }}>
                            {deps.map((dep, i) => (
                                <div key={i} style={{ background: '#fff', padding: '8px 0', borderBottom: i < deps.length - 1 ? '1px solid #F0E68C' : 'none', fontSize: '13px' }}>
                                    <div style={{ fontWeight: 600, marginBottom: '2px', color: '#333', fontSize: '11px', fontFamily: "'Monument', monospace", letterSpacing: '0.04em', textTransform: 'uppercase' }}>{dep.label}</div>
                                    <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function KnowThyselfTool() {
            const [deps, setDeps] = useState([]);
            const [step, setStep] = useState(0); // 0=cover, 0.5=intro, 1-4=sections, 999=canvas
            const [subStep, setSubStep] = useState(0); // Track micro-steps within each section (0-based)
            // Define total substeps for each section
            const SUBSTEPS = {
                1: 10, // Dream Launcher: 80th birthday + 8 questions + final dream
                2: 3,  // Strengths: activities, strengths, actions
                3: 5,  // Values: 5 values (one at a time)
                4: 3   // Growth: 3 goals (one at a time)
            };
            
            const [formData, setFormData] = useState({
                // User Identification
                userName: '',
                userEmail: '',
                
                // Section 1: Dream Launcher - 80th Birthday Story & Guiding Questions
                birthdayStory: '', // THE CORE: Your 80th birthday vision
                whatLove: '',
                whatGoodAt: '',
                giveToWorld: '',
                paidFor: '',
                inspired: '',
                feltBest: '',
                likeAboutSelf: '',
                hardships: '',
                dream: '', // My reason to get up in the morning
                
                // Section 2: Strengths Amplifier
                activities: [
                    { activity: '', energy: '' },
                    { activity: '', energy: '' },
                    { activity: '', energy: '' }
                ],
                strengths: [
                    { strength: '', fitPercent: '' },
                    { strength: '', fitPercent: '' },
                    { strength: '', fitPercent: '' }
                ],
                doMore: '',
                doLess: '',
                startTo: '',
                
                // Section 3: Values Compass
                values: [
                    { value: '', howLive: '', alignment: '' },
                    { value: '', howLive: '', alignment: '' },
                    { value: '', howLive: '', alignment: '' },
                    { value: '', howLive: '', alignment: '' },
                    { value: '', howLive: '', alignment: '' }
                ],
                
                // Section 4: Personal Growth Blueprint
                goals: [
                    { goal: '', action: '', byWhen: '' },
                    { goal: '', action: '', byWhen: '' },
                    { goal: '', action: '', byWhen: '' }
                ]
            });

            const [validationErrors, setValidationErrors] = useState({});
            const [aiReviewing, setAiReviewing] = useState(false);
            const [aiMessage, setAiMessage] = useState('');
            const autosaveTimer = useRef(null);

            useEffect(() => {
                async function loadDeps() {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                    try {
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[' + CONFIG.TOOL_SLUG + '] Failed to load dependencies:', err);
                    }
                }
                loadDeps();
            }, []);

            // Load saved data
            useEffect(() => {
                // Check for reset parameter
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('reset') === 'true') {
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setFormData(parsed.formData || formData);
                        setStep(parsed.step || 0);
                    } catch (e) {
                        console.log('Error loading saved data:', e);
                    }
                }
            }, []);

            // Autosave
            useEffect(() => {
                if (autosaveTimer.current) {
                    clearTimeout(autosaveTimer.current);
                }
                
                autosaveTimer.current = setTimeout(() => {
                    const dataToSave = { formData, step, timestamp: new Date().toISOString() };
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(dataToSave));
                }, 1000);
                
                return () => {
                    if (autosaveTimer.current) {
                        clearTimeout(autosaveTimer.current);
                    }
                };
            }, [formData, step]);

            const updateFormData = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
                setValidationErrors(prev => ({ ...prev, [field]: null }));
            };

            const updateArrayField = (field, index, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: prev[field].map((item, i) => i === index ? value : item)
                }));
            };

            const updateObjectInArray = (field, index, key, value) => {
                setFormData(prev => ({
                    ...prev,
                    [field]: prev[field].map((item, i) => 
                        i === index ? { ...item, [key]: value } : item
                    )
                }));
            };

            // Validation
            const validateSection = (sectionNum) => {
                const errors = {};
                
                switch(sectionNum) {
                    case 1: // Dream Launcher
                        if (!formData.birthdayStory || formData.birthdayStory.trim().length < 50) {
                            errors.birthdayStory = 'Your 80th birthday story needs more detail (minimum 50 characters)';
                        }
                        if (!formData.dream || formData.dream.trim().length < 20) {
                            errors.dream = 'Your dream needs more detail (minimum 20 characters)';
                        }
                        break;
                    case 2: // Strengths Amplifier
                        // At least 3 activities required
                        const filledActivities = formData.activities.filter(a => a.activity && a.activity.trim().length > 0);
                        if (filledActivities.length < 3) {
                            errors.activities = 'Enter at least 3 activities';
                        }
                        // At least 3 strengths required
                        const filledStrengths = formData.strengths.filter(s => s.strength && s.strength.trim().length > 0);
                        if (filledStrengths.length < 3) {
                            errors.strengths = 'Enter at least 3 strengths';
                        }
                        break;
                    case 3: // Values Compass
                        const filledValues = formData.values.filter(v => v.value && v.value.trim().length > 0);
                        if (filledValues.length < 3) {
                            errors.values = 'Enter at least 3 core values';
                        }
                        break;
                    case 4: // Growth Blueprint
                        const filledGoals = formData.goals.filter(g => g.goal && g.goal.trim().length > 0);
                        if (filledGoals.length < 2) {
                            errors.goals = 'Enter at least 2 goals';
                        }
                        break;
                }
                
                setValidationErrors(errors);
                return Object.keys(errors).length === 0;
            };

            const canProceed = (sectionNum) => {
                return validateSection(sectionNum);
            };
            
            // Build section-specific answers for AI review
            const getSectionAnswers = (sectionNum) => {
                switch (sectionNum) {
                    case 1: return { birthday_story: formData.birthdayStory, dream: formData.dream, what_love: formData.whatLove, what_good_at: formData.whatGoodAt };
                    case 2: return { activities: formData.activities.filter(a => a.activity).map(a => `${a.activity} (${a.energy})`).join(', '), strengths: formData.strengths.filter(s => s.strength).map(s => s.strength).join(', ') };
                    case 3: return { values: formData.values.filter(v => v.value).map(v => v.value).join(', ') };
                    case 4: return { goals: formData.goals.filter(g => g.goal).map(g => g.goal).join(', ') };
                    default: return {};
                }
            };

            const SECTION_NAMES = { 1: 'Dream Launcher', 2: 'Strengths Amplifier', 3: 'Values Compass', 4: 'Growth Blueprint' };

            // Navigate to next sub-step or next section
            // AI challenge fires after every slide, not just the last one
            const nextSubStep = () => {
                const totalSubSteps = SUBSTEPS[step] || 0;
                const isLastSubStep = subStep >= totalSubSteps - 1;
                const sectionNum = Math.floor(step);
                const userId = localStorage.getItem('ft_user_id') || 'anon-' + Date.now();

                const advance = () => {
                    if (isLastSubStep) {
                        setSubStep(0);
                        setStep(step + 0.5);
                    } else {
                        setSubStep(subStep + 1);
                    }
                };

                setAiReviewing(true);
                window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, getSectionAnswers(sectionNum), SECTION_NAMES[sectionNum])
                    .then(function (canProceed) {
                        setAiReviewing(false);
                        if (canProceed) {
                            setAiMessage('');
                            advance();
                        } else {
                            setAiMessage(window.AIChallenge?.getLastFeedback?.()?.suggestion || 'Please expand your answer before continuing.');
                        }
                    })
                    .catch(function () {
                        setAiReviewing(false);
                        setAiMessage('');
                        advance();
                    });
            };
            
            // Navigate to previous sub-step or previous section
            const prevSubStep = () => {
                if (subStep > 0) {
                    setSubStep(subStep - 1);
                } else if (step > 1) {
                    // Go back to previous section's last substep
                    const prevSection = step - 1;
                    setStep(prevSection);
                    setSubStep(SUBSTEPS[prevSection] - 1);
                }
            };

            const clearCache = () => {
                localStorage.removeItem(CONFIG.STORAGE_KEY);
                window.location.reload();
            };

            // Cover Page (step 0)
            if (step === 0) {
                return (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                        <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url("https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80")', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.3 }} />
                        <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                            <h1 className="plaak" style={{ fontSize: 80, marginBottom: 16, textTransform: 'uppercase' }}>KNOW THYSELF</h1>
                            <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48 }}>The foundation of exceptional leadership</p>
                            <button onClick={() => setStep(0.5)}
                                style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease', minHeight: 44 }}
                                onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                onMouseOut={e => { e.target.style.background = '#fff'; }}
                            >START</button>
                        </div>
                    </div>
                );
            }

            // Intro Page (step 0.5)
            if (step === 0.5) { return <IntroPage onNext={() => setStep(1)} />; }


        // SECTION 4: Personal Growth Blueprint - TYPEFORM STYLE
        function Step4({ formData, updateObjectInArray, subStep, nextSubStep, prevSubStep, aiReviewing, aiMessage }) {
            
            const currentGoal = formData.goals[subStep];
            const canAdvance = currentGoal.goal && currentGoal.goal.trim().length > 0;

            return (
                <main className="min-h-screen flex items-center justify-center p-8">
                    <div className="max-w-4xl w-full animate-in">
                        {/* Progress */}
                        <div className="mb-8">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-bold">PERSONAL GROWTH BLUEPRINT</span>
                                <span className="text-sm">{subStep + 1} / 3</span>
                            </div>
                            <div className="h-1 bg-gray-200">
                                <div 
                                    className="h-full bg-black transition-all duration-300"
                                    style={{width: `${((subStep + 1) / 3) * 100}%`}}
                                ></div>
                            </div>
                        </div>
                        
                        {/* Goal Card */}
                        <div className="border-2 border-black p-8 bg-white mb-6">
                            <h2 className="plaak text-4xl mb-6">GOAL #{subStep + 1}</h2>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block font-bold mb-2 text-xl">What is your goal?</label>
                                    <textarea
                                        className="ft-input text-lg"
                                        value={currentGoal.goal}
                                        onChange={(e) => updateObjectInArray('goals', subStep, 'goal', e.target.value)}
                                        onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                        rows="3"
                                        style={{ resize: 'none', overflow: 'hidden' }}
                                        placeholder="e.g., Improve leadership presence, Build a high-performing team"
                                        autoFocus
                                    />
                                </div>
                                
                                <div>
                                    <label className="block font-bold mb-2 text-xl">How will you achieve it? (Action steps)</label>
                                    <textarea
                                        className="ft-input"
                                        value={currentGoal.action}
                                        onChange={(e) => updateObjectInArray('goals', subStep, 'action', e.target.value)}
                                        onInput={(e) => { e.target.style.height = 'auto'; e.target.style.height = e.target.scrollHeight + 'px'; }}
                                        rows="4"
                                        style={{ resize: 'none', overflow: 'hidden' }}
                                        placeholder="e.g., Join Toastmasters, deliver 2 presentations monthly, hire executive coach"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block font-bold mb-2 text-xl">By when? (Deadline)</label>
                                    <input
                                        type="date"
                                        className="ft-input text-lg"
                                        value={currentGoal.byWhen}
                                        onChange={(e) => updateObjectInArray('goals', subStep, 'byWhen', e.target.value)}
                                        min={new Date().toISOString().split('T')[0]}
                                    />
                                </div>
                            </div>
                        </div>
                        
                        {/* Navigation */}
                        <div className="flex justify-between items-center">
                            <button
                                className="btn-secondary py-3 px-6"
                                onClick={prevSubStep}
                            >
                                ← Back
                            </button>

                            <button
                                className="btn-primary py-4 px-8 text-lg"
                                onClick={nextSubStep}
                                disabled={!canAdvance || aiReviewing}
                            >
                                {aiReviewing ? 'Reviewing...' : (subStep === 2 ? 'Complete Blueprint →' : 'Next Goal')}
                            </button>
                        </div>
                        {aiMessage && <div style={{color:'#dc2626', fontSize:'13px', marginTop:'8px', padding:'8px 12px', background:'#fef2f2', borderRadius:'6px'}}>{aiMessage}</div>}

                        {!canAdvance && (
                            <p className="text-center text-gray-600 mt-4 text-sm">
                                Please enter a goal to continue
                            </p>
                        )}
                    </div>
                </main>
            );
        }

        // OLD CODE - KEEPING FOR REFERENCE
        function Step4Old({ formData, updateFormData, updateObjectInArray, validationErrors, canProceed, onBack, onNext }) {
            const handleNext = () => {
                if (canProceed()) {
                    onNext();
                }
            };

            return (
                <main className="p-12 max-w-6xl mx-auto">
                    <div className="animate-in">
                        <div className="numbered-section">[04] PERSONAL GROWTH BLUEPRINT - OLD</div>

                        {/* Fast Track Insight */}


                        {/* The Science */}
                        {/* TODO: add field condition */}
<div className="ft-reveal-science">
    <div className="ft-reveal-label">SCIENCE BEHIND IT</div>
    <p className="ft-reveal-text">Dr. Gail Matthews' research at Dominican University found that people who write down specific goals with action steps and deadlines are 76% more likely to achieve them. Longitudinal studies also show that individuals who review and adjust their personal growth plans quarterly maintain 60% higher alignment between their intentions and actual behavior. The structure creates psychological accountability that prevents strategic drift.</p>
  </div>

                        
                        <div className="border-2 border-black p-6 mb-8 bg-white">
                            <h3 className="plaak text-3xl mb-2">YOUR EXECUTION PLAN</h3>
                            <p className="text-xl">
                                Set specific goals with clear actions and deadlines. No vague aspirations.
                            </p>
                        </div>

                        <div className="space-y-6">
                            <div className="bg-gray-50 border-2 border-black p-6">
                                <h3 className="plaak text-xl mb-4">GUIDING QUESTIONS</h3>
                                <ul className="space-y-2 text-sm text-gray-700">
                                    <li>• How do you see yourself in the next 10 years? Next 3 years?</li>
                                    <li>• What would it TAKE to become the best version of yourself in the next 1 year?</li>
                                    <li>• What do you have to cut off? What is the price you are willing to pay?</li>
                                </ul>
                            </div>

                            <div>
                                <label className="block font-bold mb-4 text-xl">
                                    Your Plan
                                </label>
                                
                                {/* Examples */}
                                <div className="mb-4 grid grid-cols-2 gap-4">
                                    <div className="bg-gray-50 border-2 border-black p-3">
                                        <p className="font-bold mb-1 text-sm">GOOD EXAMPLE</p>
                                        <p className="text-xs italic"><strong>Goal:</strong> "Develop executive presence"</p>
                                        <p className="text-xs italic"><strong>Action:</strong> "Join Toastmasters, deliver 2 company presentations monthly"</p>
                                        <p className="text-xs italic"><strong>By when:</strong> "June 30, 2025"</p>
                                    </div>
                                    <div className="bg-red-50 border-2 border-red-500 p-3">
                                        <p className="font-bold mb-1 text-sm">COMMON PITFALL</p>
                                        <p className="text-xs italic"><strong>Goal:</strong> "Be better at leadership"</p>
                                        <p className="text-xs italic"><strong>Action:</strong> "Try harder"</p>
                                        <p className="text-xs italic"><strong>By when:</strong> "Soon"</p>
                                        <p className="text-xs mt-1">Everything is vague and unmeasurable</p>
                                    </div>
                                </div>
                                
                                <div className="overflow-x-auto">
                                    <table className="w-full border-2 border-black">
                                        <thead>
                                            <tr className="bg-black text-white">
                                                <th className="p-3 text-left border-r-2 border-white">Goals</th>
                                                <th className="p-3 text-left border-r-2 border-white">Action (how will you achieve the goal)</th>
                                                <th className="p-3 text-left">By when</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {formData.goals.map((goal, i) => (
                                                <tr key={i} className="border-t-2 border-black">
                                                    <td className="p-3 border-r-2 border-black align-top">
                                                        <textarea
                                                            className="ft-input"
                                                            value={goal.goal}
                                                            onChange={(e) => updateObjectInArray('goals', i, 'goal', e.target.value)}
                                                            placeholder="e.g., Improve leadership presence"
                                                            rows="3"
                                                        />
                                                    </td>
                                                    <td className="p-3 border-r-2 border-black align-top">
                                                        <textarea
                                                            className="ft-input"
                                                            value={goal.action}
                                                            onChange={(e) => updateObjectInArray('goals', i, 'action', e.target.value)}
                                                            placeholder="e.g., Join Toastmasters, practice weekly presentations"
                                                            rows="3"
                                                        />
                                                    </td>
                                                    <td className="p-3 align-top">
                                                        <input
                                                            type="date"
                                                            className="ft-input"
                                                            value={goal.byWhen}
                                                            onChange={(e) => updateObjectInArray('goals', i, 'byWhen', e.target.value)}
                                                            min={new Date().toISOString().split('T')[0]}
                                                        />
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            {validationErrors.goals && (
                                <div className="mt-4 p-4 bg-red-50 border-2 border-red-500 text-red-700">
                                    <p className="font-bold">{validationErrors.goals}</p>
                                </div>
                            )}
                        </div>

                        {/* Helper Content - Collapsible */}
                        <details className="border-2 border-black p-4 mt-8">
                            <summary className="font-bold cursor-pointer text-lg">Need Help? View Tips & Mistakes to Avoid</summary>
                            <div className="mt-4 space-y-4">
                                <div className="border-2 border-red-600 p-4">
                                    <p className="font-bold mb-3 text-lg">MISTAKES TO AVOID</p>
                                    <ul className="space-y-2 text-sm">
                                        <li><strong>Vagueness:</strong> Ensure goals are specific and measurable.</li>
                                        <li><strong>Inconsistency:</strong> Regularly review and adjust your plan.</li>
                                    </ul>
                                </div>
                                <div className="border-2 border-black p-4">
                                    <p className="font-bold mb-2">Pro Tip</p>
                                    <p className="text-sm">Specific beats vague. "Hire COO by March 1" beats "Improve delegation."</p>
                                </div>
                            </div>
                        </details>

                        <div className="flex justify-between mt-12">
                            <button className="btn-secondary text-lg py-3 px-6" onClick={onBack}>
                                ← Back
                            </button>
                            <button 
                                className="btn-primary text-xl py-4 px-8"
                                onClick={handleNext}
                            >
                                View Your Canvas →
                            </button>
                        </div>
                        
                        {validationErrors.goals && (
                            <div className="mt-4 p-4 bg-red-50 border-2 border-red-500 text-red-700 text-center">
                                <p className="font-bold text-lg">↑ Complete at least 2 goals to continue</p>
                            </div>
                        )}
                    </div>
                </main>
            );
        }

        // Canvas View Component - CAROUSEL STYLE
        function CanvasView({ formData, onBack }) {
            const [canvasView, setCanvasView] = useState(0); // 0=summary, 1=dream, 2=strengths, 3=values, 4=growth
            const [submitStatus, setSubmitStatus] = useState(null);
            const [submitMessage, setSubmitMessage] = useState('');

            const handleShare = () => {
                setSubmitMessage('SUBMITTED\n\nYour insights are now visible to your team. Bring this to your Guru-led meeting.'); setSubmitStatus('success');
            };

            const handleSubmit = async () => {
                try {
                    // Get user ID from localStorage
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) {
                        alert('User not authenticated. Please return to the dashboard.');
                        return;
                    }

                    // Guru summary — only high-level insights, no personal reflections
                    const guruSummary = {
                        dream: formData.dream,
                        top_strengths: formData.strengths.filter(s => s.strength?.trim()).map(s => s.strength).join(', '),
                        core_values: formData.values.filter(v => v.value?.trim()).map(v => v.value).join(', '),
                        avg_values_alignment: (() => {
                            const filled = formData.values.filter(v => v.alignment);
                            if (!filled.length) return null;
                            return Math.round(filled.reduce((sum, v) => sum + Number(v.alignment), 0) / filled.length) + '%';
                        })(),
                        goals: formData.goals.filter(g => g.goal?.trim()).map(g => g.goal + (g.byWhen ? ' (by ' + g.byWhen + ')' : '')).join('; '),
                        do_more_of: formData.doMore,
                        do_less_of: formData.doLess
                    };

                    const questionMappings = {
                        // Full answers (private — only visible to user)
                        birthdayStory: formData.birthdayStory,
                        whatLove: formData.whatLove,
                        whatGoodAt: formData.whatGoodAt,
                        giveToWorld: formData.giveToWorld,
                        paidFor: formData.paidFor,
                        inspired: formData.inspired,
                        feltBest: formData.feltBest,
                        likeAboutSelf: formData.likeAboutSelf,
                        hardships: formData.hardships,
                        dream: formData.dream,
                        activities: formData.activities,
                        strengths: formData.strengths,
                        doMore: formData.doMore,
                        doLess: formData.doLess,
                        startTo: formData.startTo,
                        value_1: formData.values?.[0],
                        value_2: formData.values?.[1],
                        value_3: formData.values?.[2],
                        value_4: formData.values?.[3],
                        value_5: formData.values?.[4],
                        goal_1: formData.goals?.[0],
                        goal_2: formData.goals?.[1],
                        goal_3: formData.goals?.[2],
                        // Guru-visible summary
                        guru_summary: guruSummary
                    };

                    await ToolDB.saveResponses(userId, 'know-thyself', questionMappings);
                    setSubmitStatus('success');
                    setSubmitMessage('LOCKED IN! Know Thyself complete.');

                } catch (error) {
                    console.error('Submit error:', error);
                    setSubmitStatus('error');
                    setSubmitMessage('SUBMISSION FAILED: ' + error.message);
                }
            };

            const handleExport = () => {
                window.print();
            };

            // Filter filled items
            const filledActivities = formData.activities.filter(a => a.activity && a.activity.trim());
            const filledStrengths = formData.strengths.filter(s => s.strength && s.strength.trim());
            const filledValues = formData.values.filter(v => v.value && v.value.trim());
            const filledGoals = formData.goals.filter(g => g.goal && g.goal.trim());
            
            // Carousel navigation
            const goToView = (view) => setCanvasView(view);
            const nextView = () => canvasView < 4 && setCanvasView(canvasView + 1);
            const prevView = () => canvasView > 0 && setCanvasView(canvasView - 1);

            return (
                <div className="min-h-screen bg-white">
                    {/* Summary Dashboard View */}
                    {canvasView === 0 && (
                        <div className="min-h-screen flex items-center justify-center p-8">
                            <div className="max-w-5xl w-full">
                                {/* Header */}
                                <div className="text-center mb-12">
                                    <h1 className="plaak text-6xl mb-4">YOUR CANVAS</h1>
                                    <p className="text-2xl text-gray-600">{formData.userName}</p>
                                </div>
                                
                                {/* Main Dream - Hero Section */}
                                <div className="border-4 border-black p-8 mb-8 bg-white">
                                    <h2 className="plaak text-3xl mb-4">MY DREAM</h2>
                                    <p className="text-xl leading-relaxed mb-4">
                                        {formData.dream ? formData.dream.substring(0, 200) + (formData.dream.length > 200 ? '...' : '') : 'Not specified'}
                                    </p>
                                    <button onClick={() => goToView(1)} className="btn-secondary text-sm">
                                        View Full Story →
                                    </button>
                                </div>
                                
                                {/* Summary Grid */}
                                <div className="grid grid-cols-3 gap-6 mb-8">
                                    {/* Strengths */}
                                    <div className="border-2 border-black p-6 bg-white">
                                        <h3 className="plaak text-xl mb-4">STRENGTHS</h3>
                                        <ul className="space-y-2 mb-4">
                                            {filledStrengths.slice(0, 3).map((s, i) => (
                                                <li key={i} className="text-sm">• {s.strength}</li>
                                            ))}
                                        </ul>
                                        <button onClick={() => goToView(2)} className="text-sm underline">
                                            View All →
                                        </button>
                                    </div>
                                    
                                    {/* Values */}
                                    <div className="border-2 border-black p-6 bg-white">
                                        <h3 className="plaak text-xl mb-4">VALUES</h3>
                                        <ul className="space-y-2 mb-4">
                                            {filledValues.slice(0, 3).map((v, i) => (
                                                <li key={i} className="text-sm">• {v.value}</li>
                                            ))}
                                        </ul>
                                        <button onClick={() => goToView(3)} className="text-sm underline">
                                            View All →
                                        </button>
                                    </div>
                                    
                                    {/* Goals */}
                                    <div className="border-2 border-black p-6 bg-white">
                                        <h3 className="plaak text-xl mb-4">GOALS</h3>
                                        <ul className="space-y-2 mb-4">
                                            {filledGoals.slice(0, 3).map((g, i) => (
                                                <li key={i} className="text-sm">• {g.goal.substring(0, 40)}...</li>
                                            ))}
                                        </ul>
                                        <button onClick={() => goToView(4)} className="text-sm underline">
                                            View All →
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Status Message */}
                                {submitMessage && (
                                    <div className={`p-4 mb-4 border-2 text-lg font-bold text-center ${submitStatus === 'success' ? 'bg-gray-50 border-black text-black' : submitStatus === 'error' ? 'bg-red-50 border-red-500 text-red-700' : 'bg-yellow-50 border-yellow-500 text-yellow-800'}`}>
                                        {submitMessage}
                                    </div>
                                )}

                                {/* Action Buttons */}
                                <div className="flex gap-4 justify-center">
                                    <button onClick={handleExport} className="btn-secondary flex-1 text-lg py-4">
                                        Export PDF
                                    </button>
                                    <button onClick={handleShare} className="btn-secondary flex-1 text-lg py-4">
                                        Submit Answers
                                    </button>
                                    <button onClick={handleSubmit} className="btn-primary flex-1 text-lg py-4">
                                        Save Your Answers
                                    </button>
                                </div>

                                {/* Case Study */}
                                <CaseStudy
                                    before={"Maria, a logistics company founder, had grown her business to 120 employees but felt increasingly disconnected from her work. She could not explain to her team why the company existed beyond making money. Turnover was rising, strategic decisions took weeks, and she was burning out chasing opportunities that did not align with who she was."}
                                    after={"After completing Know Thyself, Maria identified her core strength as systems thinking and her driving value as creating independence for others. She articulated a clear dream: build the most empowering workplace in her region. Within 6 months, employee turnover dropped by half, she declined 3 misaligned partnerships without hesitation, and her team began making autonomous decisions aligned with the shared vision."}
                                    quote={"Before this exercise, I was running a company. After it, I was leading a mission. The difference is everything. — Maria K., Logistics CEO"}
                                />
                                
                                <div className="text-center mt-8">
                                    <button onClick={onBack} className="text-gray-600 underline">
                                        ← Back to Edit
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Detail Views */}
                    {canvasView > 0 && (
                        <div className="min-h-screen p-8">
                            {/* Navigation Header */}
                            <div className="max-w-5xl mx-auto mb-8">
                                <div className="flex items-center justify-between">
                                    <button onClick={() => goToView(0)} className="btn-secondary">
                                        ← Back to Summary
                                    </button>
                                    <div className="text-sm font-bold">
                                        {canvasView} / 4
                                    </div>
                                </div>
                            </div>
                            
                            <div className="max-w-5xl mx-auto">
                                {/* View 1: Dream Launcher */}
                                {canvasView === 1 && (
                                    <div className="border-4 border-black p-8 bg-white mb-8">
                                <div className="numbered-section mb-6">[01] DREAM LAUNCHER</div>
                                {/* 80th Birthday Story */}
                                {formData.birthdayStory && (
                                    <div className="border-2 border-black p-6 mb-6 bg-white">
                                        <h3 className="plaak text-2xl mb-3">MY 80TH BIRTHDAY VISION</h3>
                                        <p className="text-lg italic leading-relaxed">{formData.birthdayStory}</p>
                                    </div>
                                )}
                                
                                {/* Final Dream */}
                                <div className="border-2 border-black p-6 mb-6 bg-white">
                                    <h3 className="plaak text-xl mb-2">MY REASON TO GET UP IN THE MORNING</h3>
                                    <p className="text-lg">{formData.dream || 'Not specified'}</p>
                                </div>
                                
                                {/* Guiding Questions */}
                                {(formData.whatLove || formData.whatGoodAt || formData.giveToWorld || formData.paidFor || 
                                  formData.inspired || formData.feltBest || formData.likeAboutSelf || formData.hardships) && (
                                    <details className="border-2 border-black p-4">
                                        <summary className="font-bold cursor-pointer">View Guiding Questions Reflections</summary>
                                        <div className="mt-4 space-y-2 text-sm">
                                            {formData.whatLove && <p><strong>What I love:</strong> {formData.whatLove}</p>}
                                            {formData.whatGoodAt && <p><strong>What I'm good at:</strong> {formData.whatGoodAt}</p>}
                                            {formData.giveToWorld && <p><strong>What I can give to the world:</strong> {formData.giveToWorld}</p>}
                                            {formData.paidFor && <p><strong>What I can be paid for:</strong> {formData.paidFor}</p>}
                                            {formData.inspired && <p><strong>What inspires me:</strong> {formData.inspired}</p>}
                                            {formData.feltBest && <p><strong>When I felt my best:</strong> {formData.feltBest}</p>}
                                            {formData.likeAboutSelf && <p><strong>What I like about myself:</strong> {formData.likeAboutSelf}</p>}
                                            {formData.hardships && <p><strong>Hardships I overcame:</strong> {formData.hardships}</p>}
                                        </div>
                                    </details>
                                )}
                                    </div>
                                )}
                                
                                {/* View 2: Strengths Amplifier */}
                                {canvasView === 2 && (
                                    <div className="border-4 border-black p-8 bg-white mb-8">
                                <div className="numbered-section mb-6">[02] STRENGTHS AMPLIFIER</div>
                                
                                {filledActivities.length > 0 && (
                                    <div className="mb-6">
                                        <h3 className="plaak text-lg mb-3">MY ACTIVITIES</h3>
                                        <div className="space-y-2">
                                            {filledActivities.map((act, i) => (
                                                <div key={i} className="bg-gray-50 border-l-4 border-gray-400 p-4 flex justify-between items-center">
                                                    <span className="font-bold">{act.activity}</span>
                                                    <span className={`text-2xl ${act.energy === '+' ? 'text-black' : 'text-red-600'}`}>
                                                        {act.energy}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {filledStrengths.length > 0 && (
                                    <div className="mb-6">
                                        <h3 className="plaak text-lg mb-3">MY STRENGTHS</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            {filledStrengths.map((str, i) => (
                                                <div key={i} className="border-2 border-black p-4 bg-white">
                                                    <div className="font-bold text-lg mb-1">{str.strength}</div>
                                                    <div className="text-sm text-gray-600">Fit: {str.fitPercent}%</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="border-2 border-black p-6 bg-white">
                                    <h3 className="plaak text-lg mb-3">ACTION PLAN</h3>
                                    {formData.doMore && <p className="mb-2"><strong>Do More:</strong> {formData.doMore}</p>}
                                    {formData.doLess && <p className="mb-2"><strong>Do Less:</strong> {formData.doLess}</p>}
                                    {formData.startTo && <p><strong>Start To:</strong> {formData.startTo}</p>}
                                </div>
                                    </div>
                                )}
                                
                                {/* View 3: Values Compass */}
                                {canvasView === 3 && (
                                    <div className="border-4 border-black p-8 bg-white mb-8">
                                <div className="numbered-section mb-6">[03] VALUES COMPASS</div>
                                {filledValues.length > 0 ? (
                                    <div className="space-y-4">
                                        {filledValues.map((val, i) => (
                                            <div key={i} className="border-2 border-black p-6 bg-white">
                                                <h3 className="plaak text-xl mb-2">{val.value}</h3>
                                                {val.howLive && <p className="mb-2 text-sm"><strong>How I live it:</strong> {val.howLive}</p>}
                                                {val.alignment && <p className="text-sm"><strong>Alignment:</strong> {val.alignment}%</p>}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No values specified</p>
                                )}
                                    </div>
                                )}
                                
                                {/* View 4: Personal Growth Blueprint */}
                                {canvasView === 4 && (
                                    <div className="border-4 border-black p-8 bg-white mb-8">
                                <div className="numbered-section mb-6">[04] PERSONAL GROWTH BLUEPRINT</div>
                                {filledGoals.length > 0 ? (
                                    <div className="space-y-4">
                                        {filledGoals.map((goal, i) => (
                                            <div key={i} className="border-2 border-black p-6 bg-white">
                                                <div className="font-bold text-xl mb-3">{goal.goal}</div>
                                                {goal.action && (
                                                    <div className="mb-2">
                                                        <strong className="text-sm">Action:</strong>
                                                        <p className="text-sm mt-1">{goal.action}</p>
                                                    </div>
                                                )}
                                                {goal.byWhen && (
                                                    <div className="text-sm">
                                                        <strong>Deadline:</strong> {new Date(goal.byWhen).toLocaleDateString()}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No goals specified</p>
                                )}
                                    </div>
                                )}
                                
                                {/* Navigation for Detail Views */}
                                <div className="flex justify-between items-center mt-8">
                                    <button 
                                        onClick={prevView}
                                        className="btn-secondary py-3 px-6"
                                        disabled={canvasView === 1}
                                    >
                                        ← Previous Section
                                    </button>
                                    <button 
                                        onClick={nextView}
                                        className="btn-secondary py-3 px-6"
                                        disabled={canvasView === 4}
                                    >
                                        Next Section →
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Render App
        ReactDOM.render(<KnowThyselfTool />, document.getElementById('root'));
    </script>
</body>
</html>


    function IntroPage({ onNext }) {
      return (
        <div className="bg-black text-white min-h-screen p-16">
          <div className="max-w-5xl mx-auto">
            <h1 className="plaak mb-16 animate-in" style={{fontSize: '100px'}}>
              BEFORE WE START
            </h1>

            {/* Sprint Info */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.08s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>SPRINT INFO</h2>
              <div className="bg-white text-black p-8">
                <p className="text-2xl font-bold mb-4">Sprint 1: Know Thyself</p>
                <p className="text-xl leading-relaxed mb-4">This is a personal reflection tool. Your guru will only see a short summary of your answers — not the full details. Be honest with yourself. The more truthful you are, the more valuable this exercise becomes.</p>
                <div className="border-l-4 border-black pl-4 italic text-lg">
                  "Knowing yourself is the beginning of all wisdom."
                </div>
              </div>
            </div>

            {/* Purpose */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <h2 className="plaak text-6xl mb-6">PURPOSE</h2>
              <div className="border-l-4 border-white pl-6 mb-6">
                <p className="text-3xl italic mb-2">"The unexamined life is not worth living."</p>
                <p className="text-xl text-gray-400">— Socrates</p>
              </div>
              <p className="text-3xl leading-relaxed mb-4">Build a complete self-portrait across your dreams, strengths, values, and goals. Most leaders operate on autopilot — this tool forces the clarity that separates high-performance executives from average ones.</p>
              <p className="text-2xl text-gray-400">Executives who regularly practise structured self-reflection outperform peers by 36% in leadership effectiveness (Harvard Business Review).</p>
            </div>

            {/* Mistakes to Avoid */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>MISTAKES TO AVOID</h2>
              <ul className="text-2xl space-y-4">
                <li className="flex items-start">
                  <span className="text-4xl mr-4">•</span>
                  <span>Rushing through answers to reach a quick result — depth beats speed here.</span>
                </li>
                <li className="flex items-start">
                  <span className="text-4xl mr-4">•</span>
                  <span>Being too self-critical or too self-lenient; aim for honest, specific accuracy.</span>
                </li>
                <li className="flex items-start">
                  <span className="text-4xl mr-4">•</span>
                  <span>Skipping sections that feel uncomfortable — those are exactly the ones that matter.</span>
                </li>
                <li className="flex items-start">
                  <span className="text-4xl mr-4">•</span>
                  <span>Treating this as a one-time exercise rather than an annual leadership reset.</span>
                </li>
              </ul>
            </div>

            {/* The Journey */}
            <div className="mb-16 animate-in" style={{animationDelay: '0.3s'}}>
              <h2 className="plaak text-6xl mb-8">THE JOURNEY</h2>
              <div className="grid grid-cols-4 gap-6 text-center">
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">01</div>
                  <p className="text-xl font-bold mb-2">DREAM LAUNCHER</p>
                  <p className="text-base text-gray-400">Envision your 80th birthday</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">02</div>
                  <p className="text-xl font-bold mb-2">STRENGTHS AMPLIFIER</p>
                  <p className="text-base text-gray-400">Map activities and strengths</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">03</div>
                  <p className="text-xl font-bold mb-2">VALUES COMPASS</p>
                  <p className="text-base text-gray-400">Discover your 5 core values</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">04</div>
                  <p className="text-xl font-bold mb-2">GROWTH BLUEPRINT</p>
                  <p className="text-base text-gray-400">Goals with actions and deadlines</p>
                </div>
              </div>
            </div>

            <button
              onClick={onNext}
              className="btn-primary w-full text-3xl py-8 plaak"
            >
              LET'S START →
            </button>
          </div>
        </div>
      );
    }

