<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Track - Team Assessment | Sprint 5 of 32</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Dependency Injection -->
    <script src="../../shared/js/dependency-injection.js"></script>
    <style>
        @font-face {
            font-family: 'Plaak';
            src: url('Plaak3Trial-43-Bold.woff2') format('woff2');
            font-weight: bold;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Riforma';
            src: url('RiformaLL-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Monument';
            src: url('MonumentGrotesk-Mono.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        :root {
            --black: #000000;
            --white: #FFFFFF;
            --grey-50: #F9FAFB;
            --grey-100: #F3F4F6;
            --grey-200: #E5E7EB;
            --grey-300: #D1D5DB;
            --grey-400: #9CA3AF;
            --grey-500: #6B7280;
            --grey-600: #4B5563;
            --grey-700: #374151;
            --grey-800: #1F2937;
            --grey-900: #111827;
            --yellow-50: #fffef5;
            --yellow-100: #fffde6;
            --yellow-200: #fffacc;
            --yellow-300: #fff7a3;
            --yellow-400: #fff469;
            --yellow-500: #f0e55a;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Riforma', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.7;
            font-size: 16px; /* ‚úÖ FIXED: Was 14px, now 16px per brand standard */
        }
        
        h1, h2, h3, h4, .heading {
            font-family: 'Plaak', Arial, sans-serif;
            font-weight: 700;
            line-height: 1.3;
            letter-spacing: -0.01em;
        }
        
        h1 { font-size: 36px; }
        h2 { font-size: 28px; }
        h3 { font-size: 20px; }
        h4 { font-size: 16px; }
        
        /* ‚úÖ NEW: Numbered Section Style */
        .numbered-section {
            background: var(--black);
            color: var(--white);
            padding: 10px 16px;
            font-size: 26px;
            font-weight: bold;
            letter-spacing: 0.5px;
            display: inline-block;
            margin-bottom: 12px;
            font-family: 'Plaak', sans-serif;
        }
        
        /* Icons */
        .icon { display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .icon svg { stroke-width: 2; }
        .icon-sm svg { width: 16px; height: 16px; }
        .icon-md svg { width: 20px; height: 20px; }
        .icon-lg svg { width: 24px; height: 24px; }
        
        /* Header */
        .header {
            background: var(--black);
            color: var(--white);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .sprint-badge {
            font-size: 13px;
            color: var(--grey-400);
        }
        
        .sprint-badge strong {
            color: var(--yellow-400);
        }
        
        /* ‚úÖ IMPROVED: FTP Display with Yellow Background */
        .ftp-display {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            background: var(--yellow-400);
            color: var(--black);
            padding: 6px 12px;
            border-radius: 4px;
        }
        
        .ftp-display .icon { color: var(--black); }
        
        .logo {
            background: var(--white);
            padding: 8px 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo img {
            height: 28px;
            width: auto;
            display: block;
        }
        
        /* ‚úÖ NEW: Layout with Persistent Sidebar */
        .main-layout {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 80px);
        }
        
        /* ‚úÖ NEW: WHY/WHAT/HOW Sidebar (Always Visible) */
        .context-sidebar {
            width: 320px;
            background: var(--grey-50);
            border-right: 4px solid var(--black);
            padding: 32px 24px;
            position: sticky;
            top: 64px;
            height: fit-content;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }
        
        .context-sidebar h2 {
            font-size: 36px;
            margin-bottom: 16px;
            color: var(--black);
        }
        
        .context-sidebar p {
            margin-bottom: 24px;
            color: var(--grey-700);
        }
        
        .context-sidebar .context-section {
            margin-bottom: 32px;
        }
        
        .context-sidebar .context-section:last-child {
            margin-bottom: 0;
        }
        
        .context-sidebar ol {
            padding-left: 20px;
            color: var(--grey-700);
        }
        
        .context-sidebar ol li {
            margin-bottom: 8px;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 32px 40px;
        }
        
        /* Container */
        .container {
            max-width: 800px;
        }
        
        /* Cards */
        .card {
            background: var(--white);
            border: 1px solid var(--grey-200);
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .card h3 {
            margin-bottom: 16px;
        }
        
        /* ‚úÖ IMPROVED: Context Box with 4px Border */
        .context-box {
            background: var(--grey-50);
            border-left: 4px solid var(--black);
            padding: 16px 20px;
            margin-bottom: 24px;
            border-radius: 2px;
        }
        
        .context-box p {
            margin-bottom: 8px;
        }
        
        .context-box p:last-child {
            margin-bottom: 0;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: 2px solid var(--black);
            background: var(--black);
            color: var(--white);
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover:not(:disabled) {
            background: var(--grey-900);
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--black);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--grey-50);
        }
        
        /* ‚úÖ NEW: Share Button with Yellow Accent */
        .btn-share {
            background: var(--yellow-400);
            color: var(--black);
            border-color: var(--yellow-400);
        }
        
        .btn-share:hover:not(:disabled) {
            background: var(--yellow-500);
            border-color: var(--yellow-500);
        }
        
        /* Assessment Grid - Typeform Style */
        .assessment-container {
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
        }
        
        .assessment-slide {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
            max-width: 700px;
            width: 100%;
        }
        
        .assessment-slide.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .question-number {
            font-family: 'Plaak', sans-serif;
            font-size: 18px;
            color: var(--grey-600);
            margin-bottom: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .statement {
            font-family: 'Plaak', sans-serif;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 32px;
            color: var(--black);
            line-height: 1.3;
        }
        
        .rating-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .rating-btn {
            width: 100%;
            padding: 20px 24px;
            border: 2px solid var(--grey-300);
            background: var(--white);
            color: var(--black);
            font-family: 'Riforma', sans-serif;
            font-size: 18px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .rating-btn:hover {
            border-color: var(--black);
            background: var(--grey-50);
            transform: translateX(8px);
        }
        
        .rating-btn.selected {
            border-color: var(--black);
            background: var(--black);
            color: var(--white);
            font-weight: 600;
            transform: translateX(8px);
        }
        
        
        /* Fun Fact Slide */
        .fun-fact-slide {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
            max-width: 700px;
            width: 100%;
            text-align: center;
        }
        
        .fun-fact-slide.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .fun-fact-icon {
            font-size: 64px;
            margin-bottom: 24px;
        }
        
        .fun-fact-title {
            font-family: 'Plaak', sans-serif;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--black);
        }
        
        .fun-fact-content {
            font-size: 20px;
            line-height: 1.6;
            color: var(--grey-700);
            margin-bottom: 32px;
        }
        
        /* Navigation Buttons */
        .slide-navigation {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-hint {
            font-size: 14px;
            color: var(--grey-500);
            font-style: italic;
        }
        
        /* Score Display */
        .score-card {
            background: var(--white);
            border: 2px solid var(--grey-200);
            border-radius: 4px;
            padding: 24px;
            margin-bottom: 16px;
        }
        
        .score-card.critical {
            border-color: #000000;
            background: #FEF2F2;
        }
        
        .score-card.moderate {
            border-color: #6B7280;
            background: #FFFBEB;
        }
        
        .score-card.healthy {
            border-color: #000000;
            background: #F0FDF4;
        }
        
        .score-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .score-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Plaak', sans-serif;
        }
        
        .score-card.critical .score-value { color: #000000; }
        .score-card.moderate .score-value { color: #6B7280; }
        .score-card.healthy .score-value { color: #000000; }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.critical {
            background: #000000;
            color: var(--white);
        }
        
        .status-badge.moderate {
            background: #6B7280;
            color: var(--white);
        }
        
        .status-badge.healthy {
            background: #000000;
            color: var(--white);
        }
        
        /* ‚úÖ NEW: Priority Badge with Yellow Highlight */
        .priority-badge {
            background: var(--yellow-400);
            color: var(--black);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        /* ‚úÖ NEW: Action Plan Section */
        .action-plan-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 24px;
        }
        
        .action-input-group {
            background: var(--grey-50);
            border: 2px solid var(--grey-200);
            border-radius: 4px;
            padding: 20px;
        }
        
        .action-input-group.complete {
            border-color: #000000;
        }
        
        .action-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--black);
        }
        
        .action-input-group input,
        .action-input-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .action-input-group input:focus,
        .action-input-group textarea:focus {
            outline: none;
            border-color: var(--black);
        }
        
        .action-input-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .action-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        /* Input Fields */
        input[type="text"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--grey-300);
            border-radius: 4px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--black);
        }
        
        /* Progress Indicator */
        .progress-bar {
            background: var(--grey-200);
            height: 8px;
            border-radius: 4px;
            margin-bottom: 32px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: var(--yellow-400);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: 4px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 80px;
            right: 24px;
            background: #000000;
            color: var(--white);
            padding: 16px 24px;
            border-radius: 4px;
            z-index: 3000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                flex-direction: column;
            }
            
            .context-sidebar {
                width: 100%;
                position: relative;
                top: 0;
                border-right: none;
                border-bottom: 4px solid var(--black);
            }
            
            .main-content {
                padding: 24px 20px;
            }
            
            .action-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Table Styles */
        table {
            font-size: 14px;
        }
        
        table th {
            font-family: 'Plaak', sans-serif;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        table td {
            font-family: 'Riforma', sans-serif;
        }
        
        /* Utility Classes */
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mb-4 { margin-bottom: 32px; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mt-4 { margin-top: 32px; }
        
        .text-center { text-align: center; }
        .text-grey { color: var(--grey-600); }
        .font-bold { font-weight: 600; }
        
        .hidden { display: none; }
        
        /* Smooth transitions */
        .smooth {
            transition: all 0.2s ease;
        }
        
        /* ‚úÖ NEW: Sharing Options Hover Effect */
        .sharing-option:hover {
            border-color: var(--black) !important;
            background: var(--grey-50) !important;
            transform: translateX(4px);
        }
        
        /* ‚úÖ NEW: Dysfunction Radio Option Styling */
        .dysfunction-radio-option:hover {
            border-color: var(--grey-600) !important;
            background: var(--grey-50) !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="logo">
                    <img src="fast track tool logo.png" alt="Fast Track">
                </div>
                <div class="sprint-badge">
                    Sprint <strong>5</strong> of 32
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <button onclick="showGuruModal()" style="background: var(--yellow-400); color: var(--black); border: none; padding: 8px 16px; border-radius: 4px; font-family: 'Riforma', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer;">
                    <span class="icon icon-sm" style="color: var(--black);"><i data-lucide="users"></i></span>
                    Guru Mode
                </button>
                <div class="ftp-display">
                    <span class="icon icon-sm"><i data-lucide="zap"></i></span>
                    <span id="ftp-counter">0</span> FTP
                </div>
            </div>
        </div>
    </div>
    
    <!-- Guru Modal -->
    <div id="guru-modal" class="modal">
        <div class="modal-content">
            <h2 class="mb-3">Guru Mode Access</h2>
            <p class="text-grey mb-3">Enter the Guru password to access team compilation features.</p>
            <input type="password" id="guru-password" placeholder="Enter Guru password" style="margin-bottom: 16px;">
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="validateGuruAccess()">
                    <span class="icon icon-sm"><i data-lucide="unlock"></i></span>
                    Access Guru Mode
                </button>
                <button class="btn btn-secondary" onclick="closeGuruModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- ‚úÖ NEW: Persistent WHY/WHAT/HOW Sidebar -->
        <aside class="context-sidebar">
            <div class="context-section">
                <h2>WHY</h2>
                <p>Teams fail when trust breaks down. This tool exposes the cracks before they become disasters.</p>
                <p>Your ‚Ç¨20M growth target requires a team that operates like special forces‚Äînot a dysfunctional committee.</p>
            </div>
            
            <div class="context-section">
                <h2>WHAT</h2>
                <p>You'll assess your team across 5 critical dimensions based on Lencioni's model:</p>
                <p><strong>15 statements. 3 ratings each.</strong></p>
                <p>The tool identifies your top 3 weaknesses and forces immediate action.</p>
            </div>
            
            <div class="context-section">
                <h2>HOW</h2>
                <ol>
                    <li><strong>Rate honestly</strong> - 15 statements, brutal truth</li>
                    <li><strong>See your scores</strong> - Tool calculates dysfunctions</li>
                    <li><strong>Pick ONE to fix</strong> - Specific action + deadline</li>
                    <li><strong>Make it public</strong> - Accountability drives results</li>
                    <li><strong>Submit to Guru</strong> - Team meeting discussion</li>
                </ol>
            </div>
            
            <div class="context-box">
                <p style="font-size: 14px; color: var(--grey-600);"><strong>‚è±Ô∏è Time Required:</strong> 12-15 minutes</p>
                <p style="font-size: 14px; color: var(--grey-600);"><strong>üéØ Outcome:</strong> Scores + ONE specific commitment + public accountability</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container">
                <!-- Step 1: Assessment -->
                <div id="step-assessment">
                    <!-- Progress -->
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    
                    <!-- Assessment Container -->
                    <div class="assessment-container">
                        <div id="assessment-slides">
                            <!-- Slides will be inserted here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="slide-navigation">
                        <button class="btn btn-secondary" id="btn-prev" onclick="previousSlide()" style="visibility: hidden;">
                            <span class="icon icon-sm"><i data-lucide="arrow-left"></i></span>
                            Previous
                        </button>
                        <div class="nav-hint" id="nav-hint">Press Enter or click your answer ‚Üë</div>
                        <button class="btn" id="btn-next" onclick="nextSlide()" disabled>
                            Next
                            <span class="icon icon-sm"><i data-lucide="arrow-right"></i></span>
                        </button>
                    </div>
                </div>
                
                <!-- Step 2: Scores -->
                <div id="step-scores" class="hidden">
                    <h1 class="mb-2">Your Team Scores</h1>
                    <p class="text-grey mb-4">Lower scores = Higher dysfunction. Focus on your bottom 3.</p>
                    
                    <div id="scores-grid">
                        <!-- Score cards will be inserted here -->
                    </div>
                    
                    <div class="context-box mt-4">
                        <p><strong>üìã What Happens Next:</strong></p>
                        <p>1. Pick ONE dysfunction to fix (you can't fix everything at once)</p>
                        <p>2. Define a SPECIFIC action with a deadline</p>
                        <p>3. Make it public (accountability = results)</p>
                        <p>4. Submit to Guru for team compilation</p>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn" onclick="showActionPlan()">
                            Create My Action Plan
                            <span class="icon icon-sm"><i data-lucide="arrow-right"></i></span>
                        </button>
                        <button class="btn btn-secondary" onclick="goToAssessment()">
                            <span class="icon icon-sm"><i data-lucide="arrow-left"></i></span>
                            Back to Assessment
                        </button>
                    </div>
                </div>
                
                <!-- ‚úÖ NEW STEP 3: PERSONAL ACTION PLAN (Decision-Forcing) -->
                <div id="step-action-plan" class="hidden">
                    <h1 class="mb-2">Your Personal Action Plan</h1>
                    <p class="text-grey mb-4">You can't fix everything. Pick your #1 and commit to ONE specific action.</p>
                    
                    <!-- 1. Select Dysfunction -->
                    <div class="card">
                        <h3 class="mb-2">1. Which dysfunction will YOU fix first?</h3>
                        <p class="text-grey mb-3" style="font-size: 14px;">Choose from your bottom 3 scores (highest dysfunction):</p>
                        
                        <div id="dysfunction-selection" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Radio buttons will be inserted here -->
                        </div>
                    </div>
                    
                    <!-- 2. Define Specific Action -->
                    <div class="card">
                        <h3 class="mb-2">2. What SPECIFIC action will you take?</h3>
                        <p class="text-grey mb-3" style="font-size: 14px;">Be concrete. Vague commitments fail. Good commitments have WHO, WHAT, WHEN, WHERE.</p>
                        
                        <textarea id="action-input" placeholder="Example: I will admit one mistake I made this week in Monday's 9am standup and ask the team for help fixing it." style="min-height: 100px; margin-bottom: 8px;"></textarea>
                        
                        <div id="action-validation" style="padding: 12px; border-radius: 4px; margin-bottom: 16px; display: none;">
                            <span id="validation-message"></span>
                        </div>
                        
                        <div style="font-size: 13px; color: var(--grey-500); margin-bottom: 16px;">
                            <span id="char-count">0</span> characters (min 20, recommended 50-100)
                        </div>
                        
                        <!-- Examples -->
                        <details style="margin-bottom: 16px;">
                            <summary style="cursor: pointer; font-weight: 600; color: var(--grey-700);">Show Good vs Bad Examples</summary>
                            <div style="margin-top: 12px;">
                                <div id="examples-container">
                                    <!-- Examples will be inserted based on selected dysfunction -->
                                </div>
                            </div>
                        </details>
                    </div>
                    
                    <!-- 3. Set Deadline -->
                    <div class="card">
                        <h3 class="mb-2">3. By when will you do this?</h3>
                        <p class="text-grey mb-3" style="font-size: 14px;">Fast Track = fast action. No "eventually". Max 7 days from today.</p>
                        
                        <input type="date" id="deadline-input" style="margin-bottom: 8px;">
                        <div id="deadline-warning" style="display: none; color: #6B7280; font-size: 14px; margin-top: 8px;">
                            ‚ö†Ô∏è Fast Track = fast action. Sure about this date?
                        </div>
                    </div>
                    
                    <!-- 4. Accountability Partner -->
                    <div class="card">
                        <h3 class="mb-2">4. Who will check if you did it?</h3>
                        <p class="text-grey mb-3" style="font-size: 14px;">Accountability = someone asks "Did you do it?" Pick a team member.</p>
                        
                        <input type="text" id="partner-input" placeholder="e.g., Sarah, Alex, the CEO">
                    </div>
                    
                    <!-- 5. Preview Commitment -->
                    <div class="card" style="background: var(--yellow-50); border: 2px solid var(--yellow-400);" id="commitment-preview">
                        <h3 class="mb-3">üéØ Your Commitment Preview</h3>
                        <div id="preview-content" style="background: var(--white); padding: 20px; border-radius: 4px; border-left: 4px solid var(--black);">
                            <p style="font-size: 14px; color: var(--grey-500); margin-bottom: 8px;">Fill out all fields above to see your commitment</p>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn" id="btn-lock-commitment" onclick="lockCommitment()" disabled>
                            <span class="icon icon-sm"><i data-lucide="lock"></i></span>
                            Lock This In
                        </button>
                        <button class="btn btn-secondary" onclick="goToScores()">
                            <span class="icon icon-sm"><i data-lucide="arrow-left"></i></span>
                            Back to Scores
                        </button>
                    </div>
                </div>
                
                <!-- ‚úÖ NEW STEP 4: PUBLIC COMMITMENT (Accountability) -->
                <div id="step-public-commitment" class="hidden">
                    <h1 class="mb-2">Make It Public</h1>
                    <p class="text-grey mb-4">Private commitments fail. Public commitments create accountability.</p>
                    
                    <!-- Display Locked Commitment -->
                    <div class="card" style="background: var(--yellow-50); border: 2px solid var(--yellow-400);">
                        <h3 class="mb-3">üéØ Your Locked Commitment</h3>
                        <div id="locked-commitment-display" style="background: var(--white); padding: 20px; border-radius: 4px; border-left: 4px solid var(--black);">
                            <!-- Commitment will be displayed here -->
                        </div>
                    </div>
                    
                    <!-- Sharing Options -->
                    <div class="card">
                        <h3 class="mb-3">Choose How You'll Share (Pick ONE):</h3>
                        
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <!-- Option 1: Slack -->
                            <div class="sharing-option" style="border: 2px solid var(--grey-300); border-radius: 4px; padding: 20px; cursor: pointer; transition: all 0.2s ease;" onclick="selectSharingOption('slack')">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <h4 style="margin-bottom: 4px;">üì± Post to Team Slack</h4>
                                        <p style="font-size: 14px; color: var(--grey-600);">Share directly to your team channel</p>
                                    </div>
                                    <div style="background: #000000; color: var(--white); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">+100 FTP</div>
                                </div>
                            </div>
                            
                            <!-- Option 2: Email -->
                            <div class="sharing-option" style="border: 2px solid var(--grey-300); border-radius: 4px; padding: 20px; cursor: pointer; transition: all 0.2s ease;" onclick="selectSharingOption('email')">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <h4 style="margin-bottom: 4px;">‚úâÔ∏è Email to Team</h4>
                                        <p style="font-size: 14px; color: var(--grey-600);">Send commitment via email to entire team</p>
                                    </div>
                                    <div style="background: #000000; color: var(--white); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">+100 FTP</div>
                                </div>
                            </div>
                            
                            <!-- Option 3: Copy & Share -->
                            <div class="sharing-option" style="border: 2px solid var(--grey-300); border-radius: 4px; padding: 20px; cursor: pointer; transition: all 0.2s ease;" onclick="selectSharingOption('manual')">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <h4 style="margin-bottom: 4px;">üìã Copy & Share Manually</h4>
                                        <p style="font-size: 14px; color: var(--grey-600);">Copy text and paste wherever you want</p>
                                    </div>
                                    <div style="background: #6B7280; color: var(--white); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">+50 FTP</div>
                                </div>
                            </div>
                            
                            <!-- Option 4: Keep Private (Penalty) -->
                            <div class="sharing-option" style="border: 2px solid var(--grey-300); border-radius: 4px; padding: 20px; cursor: pointer; transition: all 0.2s ease;" onclick="selectSharingOption('private')">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <h4 style="margin-bottom: 4px; color: var(--grey-500);">üö´ Keep Private</h4>
                                        <p style="font-size: 14px; color: var(--grey-500);">Not recommended - private commitments fail 80% of the time</p>
                                    </div>
                                    <div style="background: #000000; color: var(--white); padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700;">-50 FTP</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-secondary" onclick="goToActionPlan()">
                            <span class="icon icon-sm"><i data-lucide="arrow-left"></i></span>
                            Edit Commitment
                        </button>
                    </div>
                </div>
                
                <!-- Step 5: Submission (was Step 3) -->
                <div id="step-submission" class="hidden">
                    <h1 class="mb-2">Submit Your Assessment</h1>
                    <p class="text-grey mb-4">Submit your scores to get your code for the Guru to compile.</p>
                    
                    <div class="card">
                        <h3 class="mb-2">Your Details</h3>
                        <div class="mb-3">
                            <label class="mb-1 font-bold">Full Name *</label>
                            <input type="text" id="input-name" placeholder="e.g., Alex Thompson">
                        </div>
                        <div class="mb-3">
                            <label class="mb-1 font-bold">Role/Title *</label>
                            <input type="text" id="input-role" placeholder="e.g., CEO / CTO / Head of Sales">
                        </div>
                        <div class="mb-3">
                            <label class="mb-1 font-bold">Email</label>
                            <input type="email" id="input-email" placeholder="alex@company.com (optional)">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn" onclick="submitAssessment()">
                            <span class="icon icon-sm"><i data-lucide="check"></i></span>
                            Submit Assessment
                        </button>
                        <button class="btn btn-secondary" onclick="goToScores()">
                            <span class="icon icon-sm"><i data-lucide="arrow-left"></i></span>
                            Back to Scores
                        </button>
                    </div>
                </div>
                
                <!-- Step 6: Confirmation (was Step 4) -->
                <div id="step-confirmation" class="hidden">
                    <div class="text-center">
                        <div style="font-size: 64px; margin-bottom: 24px;">‚úì</div>
                        <h1 class="mb-2">Assessment Submitted</h1>
                        <p class="text-grey mb-4">Your submission code is below. Share it with your team guru for compilation.</p>
                    </div>
                    
                    <!-- ‚úÖ NEW: Show Committed Action -->
                    <div class="card" style="background: var(--yellow-50); border: 2px solid var(--yellow-400);">
                        <h3 class="mb-3">üéØ Your Commitment</h3>
                        <div id="final-commitment-display" style="background: var(--white); padding: 20px; border-radius: 4px;">
                            <!-- Commitment will be displayed here -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3 class="mb-2">Your Submission Code</h3>
                        <div style="background: var(--grey-100); padding: 16px; border-radius: 4px; font-family: monospace; font-size: 14px; word-break: break-all; margin-bottom: 16px;" id="submission-code"></div>
                        <button class="btn btn-secondary" onclick="copySubmissionCode()">
                            <span class="icon icon-sm"><i data-lucide="copy"></i></span>
                            Copy Code
                        </button>
                    </div>
                    
                    <!-- ‚úÖ NEW: Share Options -->
                    <div class="card mt-3">
                        <h3 class="mb-2">Share Your Results</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-share" onclick="exportToPDF()">
                                <span class="icon icon-sm"><i data-lucide="file-text"></i></span>
                                Export PDF
                            </button>
                            <button class="btn btn-secondary" onclick="shareViaEmail()">
                                <span class="icon icon-sm"><i data-lucide="mail"></i></span>
                                Email Team
                            </button>
                            <button class="btn btn-secondary" onclick="copyShareableLink()">
                                <span class="icon icon-sm"><i data-lucide="link"></i></span>
                                Copy Link
                            </button>
                        </div>
                    </div>
                    
                    <div class="context-box mt-4">
                        <p><strong>Next Steps:</strong></p>
                        <p>1. Send your code to the team guru</p>
                        <p>2. Guru will compile all assessments</p>
                        <p>3. Team meeting discusses results + actions</p>
                        <p>4. Review progress in 30 days</p>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-secondary" onclick="resetTool()">
                            <span class="icon icon-sm"><i data-lucide="refresh-cw"></i></span>
                            Start New Assessment
                        </button>
                    </div>
                </div>
                
                <!-- ‚úÖ NEW: Guru Mode -->
                <div id="guru-mode" class="hidden">
                    <h1 class="mb-2">Guru Mode: Team Compilation</h1>
                    <p class="text-grey mb-4">Import team member submission codes to create the team summary for your 90-minute meeting.</p>
                    
                    <!-- Import Section -->
                    <div class="card">
                        <h3 class="mb-2">Import Team Member Codes</h3>
                        <p class="text-grey mb-3" style="font-size: 14px;">Collect submission codes from each team member and import them below.</p>
                        
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <input type="text" id="import-code-input" placeholder="Paste team member submission code here" style="flex: 1;">
                            <button class="btn" onclick="importMemberCode()">
                                <span class="icon icon-sm"><i data-lucide="plus"></i></span>
                                Import
                            </button>
                        </div>
                        
                        <div class="context-box">
                            <p><strong>Imported: <span id="imported-count">0</span> team members</strong></p>
                        </div>
                        
                        <div id="imported-members" style="margin-top: 16px;">
                            <!-- Imported members will appear here -->
                        </div>
                    </div>
                    
                    <!-- Team Summary Section -->
                    <div id="team-summary-section" class="hidden">
                        <!-- Top 3 Priorities -->
                        <div class="card" style="background: var(--yellow-50); border: 2px solid var(--yellow-400);">
                            <h3 class="mb-3">üéØ Top 3 Focus Areas for Team Meeting</h3>
                            <div id="team-priorities" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                <!-- Priority cards will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Variance Alerts -->
                        <div id="variance-alerts">
                            <!-- Variance alerts will be inserted here -->
                        </div>
                        
                        <!-- Team Summary Table -->
                        <div class="card">
                            <h3 class="mb-3">Team Dysfunction Scores</h3>
                            <div style="overflow-x: auto;">
                                <table id="team-summary-table" style="width: 100%; border-collapse: collapse;">
                                    <!-- Table will be inserted here -->
                                </table>
                            </div>
                        </div>
                        
                        <!-- Export Options -->
                        <div class="card">
                            <h3 class="mb-2">Export for Team Meeting</h3>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn btn-share" onclick="exportTeamSummary()">
                                    <span class="icon icon-sm"><i data-lucide="file-text"></i></span>
                                    Export Summary
                                </button>
                                <button class="btn btn-secondary" onclick="copyTeamSummary()">
                                    <span class="icon icon-sm"><i data-lucide="copy"></i></span>
                                    Copy to Clipboard
                                </button>
                                <button class="btn btn-secondary" onclick="printTeamSummary()">
                                    <span class="icon icon-sm"><i data-lucide="printer"></i></span>
                                    Print
                                </button>
                            </div>
                        </div>
                        
                        <!-- Meeting Agenda Reminder -->
                        <div class="context-box">
                            <h4 class="mb-2">üìã 90-Minute Team Meeting Agenda</h4>
                            <ol style="padding-left: 20px; font-size: 14px;">
                                <li><strong>Do Better Than Last Time</strong> (10 min)</li>
                                <li><strong>Present Results</strong> (20 min) - Show this summary</li>
                                <li><strong>Discuss Dysfunctions</strong> (30 min) - Focus on variance</li>
                                <li><strong>Create Action Plan</strong> (20 min) - WHO/WHAT/WHEN</li>
                                <li><strong>Reflection</strong> (10 min)</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-secondary" onclick="exitGuruMode()">
                            <span class="icon icon-sm"><i data-lucide="arrow-left"></i></span>
                            Exit Guru Mode
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://vpfayzzjnegdefjrnyoc.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwZmF5enpqbmVnZGVmanJueW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzAwODUsImV4cCI6MjA4NTcwNjA4NX0.7qwzd9kwyRG0Wx9DDSc8F9a1SRD0CoC6CGS-9M1sxIs',
            TOOL_SLUG: 'team',
            SPRINT_NUMBER: 4,
            SCHEMA_NAME: 'sprint_04_team',
            AUTOSAVE_DELAY: 2000
        };

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // Make Supabase client globally available for dependency injection
        window.supabaseClient = supabaseClient;

        // Initialize dependency injection to load data from Values
        DependencyInjection.init(CONFIG.TOOL_SLUG, CONFIG.SCHEMA_NAME);

        // Assessment Data
        const DYSFUNCTIONS = [
            {
                id: 'trust',
                name: 'Absence of Trust',
                shortName: 'Trust',
                description: 'Team members are reluctant to be vulnerable with one another',
                statements: [
                    'Team members openly admit their mistakes',
                    'Team members willingly ask for help',
                    'Team members are comfortable being vulnerable'
                ]
            },
            {
                id: 'conflict',
                name: 'Fear of Conflict',
                shortName: 'Conflict',
                description: 'Teams avoid productive ideological debates',
                statements: [
                    'Team meetings are passionate and productive',
                    'The team confronts and resolves issues quickly',
                    'Team members voice their opinions freely'
                ]
            },
            {
                id: 'commitment',
                name: 'Lack of Commitment',
                shortName: 'Commitment',
                description: 'Without conflict, team members rarely buy in to decisions',
                statements: [
                    'Team leaves meetings with clear action items',
                    'Team decisions are made and executed quickly',
                    'Team members commit to decisions even when they initially disagreed'
                ]
            },
            {
                id: 'accountability',
                name: 'Avoidance of Accountability',
                shortName: 'Accountability',
                description: 'Team members hesitate to call out peers on behaviors',
                statements: [
                    'Team members hold each other accountable for deliverables',
                    'Poor performance is addressed immediately',
                    'Team members call out counterproductive behaviors'
                ]
            },
            {
                id: 'results',
                name: 'Inattention to Results',
                shortName: 'Results',
                description: 'Team members put individual needs above collective goals',
                statements: [
                    'Team willingly makes sacrifices for collective success',
                    'Team celebrates when collective goals are achieved',
                    'Individual agendas are subordinate to team goals'
                ]
            }
        ];

        // State
        let responses = {};
        let scores = {};
        let ftpPoints = 0;
        let teamAssessments = [];
        let currentSlide = 0;
        let totalSlides = 0;
        const GURU_PASSWORD = 'FASTTRACK2024'; // Change this to your desired password
        
        // ‚úÖ NEW: Commitment State
        let commitment = {
            dysfunction: null,
            dysfunctionName: null,
            dysfunctionScore: null,
            action: '',
            deadline: null,
            accountabilityPartner: '',
            madePublic: null, // 'slack', 'email', 'manual', 'private'
            publicUrl: null
        };
        let actionValidated = false;
        
        // Team Management Facts
        const TEAM_FACTS = [
            {
                icon: 'üéØ',
                title: 'Did You Know?',
                content: 'Teams that openly discuss mistakes are 3x more likely to innovate. Vulnerability breeds creativity.'
            },
            {
                icon: '‚ö°',
                title: 'Shocking Stat',
                content: '86% of workplace failures are caused by poor collaboration, not individual incompetence. The team dynamic is everything.'
            },
            {
                icon: 'üí°',
                title: 'Research Shows',
                content: 'High-performing teams spend 50% more time in productive conflict than dysfunctional teams. Disagreement done right accelerates progress.'
            }
        ];
        
        // ‚úÖ NEW: Action Examples by Dysfunction
        const ACTION_EXAMPLES = {
            trust: {
                good: [
                    '‚úÖ Admit one mistake I made this week in Monday\'s 9am standup',
                    '‚úÖ Ask Sarah for help with the Q4 forecast in our 1-on-1 on Tuesday',
                    '‚úÖ Share my biggest concern about the product roadmap in Thursday\'s leadership meeting'
                ],
                bad: [
                    '‚ùå Be more vulnerable',
                    '‚ùå Try to trust the team more',
                    '‚ùå Improve my openness'
                ]
            },
            conflict: {
                good: [
                    '‚úÖ Challenge the pricing decision in Monday\'s product meeting and argue my alternative',
                    '‚úÖ Tell Alex I disagree with his marketing approach in our Tuesday call',
                    '‚úÖ Debate the pros/cons of the new hire for 20 minutes in Friday\'s meeting'
                ],
                bad: [
                    '‚ùå Have more productive debates',
                    '‚ùå Be better at confronting issues',
                    '‚ùå Improve team conflict'
                ]
            },
            commitment: {
                good: [
                    '‚úÖ Say "I commit to this decision" out loud in Monday\'s meeting even though I disagree',
                    '‚úÖ Send a Slack message by end of Tuesday confirming my ownership of the Q1 launch',
                    '‚úÖ Create a one-page action plan by Wednesday 5pm showing my commitment to the new strategy'
                ],
                bad: [
                    '‚ùå Be more committed to decisions',
                    '‚ùå Support team decisions better',
                    '‚ùå Show more buy-in'
                ]
            },
            accountability: {
                good: [
                    '‚úÖ Tell John directly on Monday that his report was 3 days late and ask him to commit to Friday deadlines',
                    '‚úÖ Call out anyone who misses their committed deadline in Tuesday\'s standup',
                    '‚úÖ Send an email to Sarah by Wednesday asking why she didn\'t deliver the analysis she promised'
                ],
                bad: [
                    '‚ùå Hold people more accountable',
                    '‚ùå Address poor performance better',
                    '‚ùå Call out bad behavior more'
                ]
            },
            results: {
                good: [
                    '‚úÖ Cancel my personal project this week to help the team hit the Q4 revenue target',
                    '‚úÖ Volunteer to work late on Thursday to finish the team deliverable even though it\'s not "my job"',
                    '‚úÖ Publicly celebrate the team hitting 10k users in Friday\'s all-hands instead of promoting my own work'
                ],
                bad: [
                    '‚ùå Focus more on team goals',
                    '‚ùå Put team first more often',
                    '‚ùå Celebrate team wins better'
                ]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderAssessmentSlides();
            updateFTPDisplay();
            lucide.createIcons();
        });

        // Render Assessment Slides (Typeform Style)
        function renderAssessmentSlides() {
            const container = document.getElementById('assessment-slides');
            let slideIndex = 0;
            let questionNumber = 1;
            
            DYSFUNCTIONS.forEach((dysfunction, dIndex) => {
                dysfunction.statements.forEach((statement, sIndex) => {
                    const itemId = `${dysfunction.id}-${sIndex}`;
                    const dysfunctionNumber = String(dIndex + 1).padStart(2, '0');
                    
                    // Create question slide
                    const slide = document.createElement('div');
                    slide.className = 'assessment-slide';
                    slide.dataset.slideIndex = slideIndex;
                    slide.dataset.itemId = itemId;
                    
                    slide.innerHTML = `
                        <div class="question-number">Question ${questionNumber} of 15</div>
                        <div class="statement">${statement}</div>
                        <div class="rating-buttons">
                            <button class="rating-btn" onclick="selectRatingSlide('${itemId}', 1, ${slideIndex})">
                                <span class="rating-label">Rarely - This almost never happens in our team</span>
                            </button>
                            <button class="rating-btn" onclick="selectRatingSlide('${itemId}', 2, ${slideIndex})">
                                <span class="rating-label">Sometimes - This happens occasionally</span>
                            </button>
                            <button class="rating-btn" onclick="selectRatingSlide('${itemId}', 3, ${slideIndex})">
                                <span class="rating-label">Usually - This happens regularly in our team</span>
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(slide);
                    slideIndex++;
                    
                    // Insert fun fact after every 5th question
                    if (questionNumber % 5 === 0 && questionNumber < 15) {
                        const factIndex = (questionNumber / 5) - 1;
                        const fact = TEAM_FACTS[factIndex];
                        
                        const factSlide = document.createElement('div');
                        factSlide.className = 'fun-fact-slide';
                        factSlide.dataset.slideIndex = slideIndex;
                        
                        factSlide.innerHTML = `
                            <div class="fun-fact-icon">${fact.icon}</div>
                            <div class="fun-fact-title">${fact.title}</div>
                            <div class="fun-fact-content">${fact.content}</div>
                        `;
                        
                        container.appendChild(factSlide);
                        slideIndex++;
                    }
                    
                    questionNumber++;
                });
            });
            
            // Add final "Calculate Scores" slide
            const finalSlide = document.createElement('div');
            finalSlide.className = 'assessment-slide';
            finalSlide.dataset.slideIndex = slideIndex;
            finalSlide.innerHTML = `
                <div class="fun-fact-icon">üéâ</div>
                <div class="statement">Assessment Complete!</div>
                <p class="text-grey mb-4" style="font-size: 18px;">You've rated all 15 statements. Ready to see your team's dysfunction scores?</p>
                <button class="btn" onclick="calculateScoresFromSlides()" style="width: 100%; padding: 20px; font-size: 18px;">
                    <span class="icon icon-md"><i data-lucide="bar-chart"></i></span>
                    Calculate My Scores
                </button>
            `;
            container.appendChild(finalSlide);
            
            totalSlides = slideIndex;
            
            // Show first slide
            showSlide(0);
        }

        // Show Slide
        function showSlide(index) {
            // Hide all slides
            document.querySelectorAll('.assessment-slide, .fun-fact-slide').forEach(slide => {
                slide.classList.remove('active');
            });
            
            // Show current slide
            const slides = document.querySelectorAll('.assessment-slide, .fun-fact-slide');
            if (slides[index]) {
                slides[index].classList.add('active');
                currentSlide = index;
                
                // Update progress
                const questionsAnswered = Object.keys(responses).length;
                const percentage = (questionsAnswered / 15) * 100;
                document.getElementById('progress-fill').style.width = percentage + '%';
                
                // Update navigation buttons
                updateNavigationButtons();
                
                // Re-initialize Lucide icons
                lucide.createIcons();
            }
        }
        
        // Update Navigation Buttons
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('btn-prev');
            const nextBtn = document.getElementById('btn-next');
            const slides = document.querySelectorAll('.assessment-slide, .fun-fact-slide');
            const currentSlideEl = slides[currentSlide];
            
            // Show/hide previous button
            if (currentSlide === 0) {
                prevBtn.style.visibility = 'hidden';
            } else {
                prevBtn.style.visibility = 'visible';
            }
            
            // Handle next button
            if (currentSlide === totalSlides) {
                // Last slide (Calculate button)
                nextBtn.style.display = 'none';
            } else if (currentSlideEl.classList.contains('fun-fact-slide')) {
                // Fun fact slide - always enabled
                nextBtn.disabled = false;
                nextBtn.style.display = 'flex';
            } else if (currentSlideEl.dataset.itemId) {
                // Question slide - enable if answered
                const itemId = currentSlideEl.dataset.itemId;
                nextBtn.disabled = !responses[itemId];
                nextBtn.style.display = 'flex';
            }
        }
        
        // Select Rating in Slide
        function selectRatingSlide(itemId, value, slideIndex) {
            responses[itemId] = value;
            
            // Update button states in current slide
            const slide = document.querySelector(`[data-slide-index="${slideIndex}"]`);
            const buttons = slide.querySelectorAll('.rating-btn');
            buttons.forEach((btn, index) => {
                if (index + 1 === value) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            // Award FTP (only once per question)
            if (!slide.dataset.awarded) {
                ftpPoints += 5;
                updateFTPDisplay();
                slide.dataset.awarded = 'true';
            }
            
            // Enable next button
            document.getElementById('btn-next').disabled = false;
            
            // Auto-advance after a short delay (optional, feels smooth)
            setTimeout(() => {
                nextSlide();
            }, 300);
        }
        
        // Previous Slide
        function previousSlide() {
            if (currentSlide > 0) {
                showSlide(currentSlide - 1);
            }
        }
        
        // Next Slide
        function nextSlide() {
            const slides = document.querySelectorAll('.assessment-slide, .fun-fact-slide');
            if (currentSlide < slides.length - 1) {
                showSlide(currentSlide + 1);
            }
        }
        
        // Calculate Scores from Slides
        function calculateScoresFromSlides() {
            calculateScores();
            showScores();
            
            // Bonus FTP for completion
            ftpPoints += 25;
            updateFTPDisplay();
            showToast('‚úì Assessment complete! +25 FTP');
        }

        // Update FTP Display
        function updateFTPDisplay() {
            document.getElementById('ftp-counter').textContent = ftpPoints;
        }

        // Calculate Scores
        function calculateScores() {
            DYSFUNCTIONS.forEach(dysfunction => {
                let total = 0;
                dysfunction.statements.forEach((_, index) => {
                    const itemId = `${dysfunction.id}-${index}`;
                    total += responses[itemId] || 0;
                });
                scores[dysfunction.id] = total;
            });
        }

        // Show Scores
        function showScores() {
            document.getElementById('step-assessment').classList.add('hidden');
            document.getElementById('step-scores').classList.remove('hidden');
            
            const grid = document.getElementById('scores-grid');
            grid.innerHTML = '';
            
            // Sort by score (lowest first = highest dysfunction)
            const sortedDysfunctions = [...DYSFUNCTIONS].sort((a, b) => 
                scores[a.id] - scores[b.id]
            );
            
            sortedDysfunctions.forEach((dysfunction, index) => {
                const score = scores[dysfunction.id];
                const maxScore = 9;
                const status = score >= 8 ? 'healthy' : score >= 6 ? 'moderate' : 'critical';
                
                const card = document.createElement('div');
                card.className = `score-card ${status}`;
                
                let priorityBadge = '';
                if (index < 3) {
                    priorityBadge = `<div class="priority-badge">PRIORITY #${index + 1}</div>`;
                }
                
                const dysfunctionNumber = String(DYSFUNCTIONS.indexOf(dysfunction) + 1).padStart(2, '0');
                
                card.innerHTML = `
                    ${priorityBadge}
                    <div class="numbered-section mb-2">[${dysfunctionNumber}] ${dysfunction.name.toUpperCase()}</div>
                    <div class="score-header">
                        <div>
                            <div class="score-value">${score}/${maxScore}</div>
                            <p class="text-grey" style="font-size: 14px; margin-top: 4px;">${dysfunction.description}</p>
                        </div>
                        <div class="status-badge ${status}">
                            ${status === 'critical' ? '‚ö†Ô∏è Critical' : status === 'moderate' ? '‚ö° Moderate' : '‚úì Healthy'}
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            window.scrollTo(0, 0);
        }

        // ===== NEW: ACTION PLAN FUNCTIONS =====
        
        // Show Action Plan
        function showActionPlan() {
            document.getElementById('step-scores').classList.add('hidden');
            document.getElementById('step-action-plan').classList.remove('hidden');
            
            // Render dysfunction selection (bottom 3)
            renderDysfunctionSelection();
            
            // Set up date picker constraints
            setupDatePicker();
            
            // Set up real-time validation
            setupActionValidation();
            
            window.scrollTo(0, 0);
        }
        
        // Render Dysfunction Selection (Bottom 3)
        function renderDysfunctionSelection() {
            const container = document.getElementById('dysfunction-selection');
            
            // Sort by score (lowest first = highest dysfunction)
            const sortedDysfunctions = [...DYSFUNCTIONS]
                .map(d => ({ ...d, score: scores[d.id] }))
                .sort((a, b) => a.score - b.score)
                .slice(0, 3); // Only bottom 3
            
            container.innerHTML = sortedDysfunctions.map((d, index) => {
                const status = d.score >= 8 ? 'healthy' : d.score >= 6 ? 'moderate' : 'critical';
                const statusColor = status === 'critical' ? '#000000' : status === 'moderate' ? '#6B7280' : '#000000';
                
                return `
                    <label style="border: 2px solid var(--grey-300); border-radius: 4px; padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 16px; transition: all 0.2s ease;" class="dysfunction-radio-option">
                        <input type="radio" name="dysfunction" value="${d.id}" onchange="selectDysfunction('${d.id}', '${d.name}', ${d.score})" style="width: 20px; height: 20px;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: between; align-items: center; gap: 12px; margin-bottom: 4px;">
                                <strong style="font-size: 16px;">${d.name}</strong>
                                <span class="priority-badge" style="margin: 0;">PRIORITY #${index + 1}</span>
                            </div>
                            <div style="font-size: 14px; color: var(--grey-600);">${d.description}</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; font-family: 'Plaak', sans-serif; color: ${statusColor};">
                            ${d.score}/9
                        </div>
                    </label>
                `;
            }).join('');
        }
        
        // Select Dysfunction
        function selectDysfunction(id, name, score) {
            commitment.dysfunction = id;
            commitment.dysfunctionName = name;
            commitment.dysfunctionScore = score;
            
            // Update examples
            updateExamples(id);
            
            // Update preview
            updateCommitmentPreview();
            
            // Add visual feedback
            document.querySelectorAll('.dysfunction-radio-option').forEach(opt => {
                opt.style.borderColor = 'var(--grey-300)';
                opt.style.background = 'var(--white)';
            });
            event.target.closest('.dysfunction-radio-option').style.borderColor = 'var(--black)';
            event.target.closest('.dysfunction-radio-option').style.background = 'var(--grey-50)';
        }
        
        // Update Examples Based on Selected Dysfunction
        function updateExamples(dysfunctionId) {
            const examples = ACTION_EXAMPLES[dysfunctionId];
            const container = document.getElementById('examples-container');
            
            container.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <h4 style="color: #000000; margin-bottom: 8px;">‚úÖ Good Examples (Specific):</h4>
                    ${examples.good.map(ex => `<p style="margin-bottom: 6px; padding-left: 12px; border-left: 3px solid #000000;">${ex}</p>`).join('')}
                </div>
                <div>
                    <h4 style="color: #000000; margin-bottom: 8px;">‚ùå Bad Examples (Too Vague):</h4>
                    ${examples.bad.map(ex => `<p style="margin-bottom: 6px; padding-left: 12px; border-left: 3px solid #000000; text-decoration: line-through; color: var(--grey-500);">${ex}</p>`).join('')}
                </div>
            `;
        }
        
        // Setup Date Picker
        function setupDatePicker() {
            const dateInput = document.getElementById('deadline-input');
            const today = new Date();
            const maxDate = new Date(today);
            maxDate.setDate(maxDate.getDate() + 7);
            
            // Set min to today
            dateInput.min = today.toISOString().split('T')[0];
            
            // Set max to 7 days from now
            dateInput.max = maxDate.toISOString().split('T')[0];
            
            // Set default to 3 days from now
            const defaultDate = new Date(today);
            defaultDate.setDate(defaultDate.getDate() + 3);
            dateInput.value = defaultDate.toISOString().split('T')[0];
            commitment.deadline = dateInput.value;
            
            // Add change listener
            dateInput.addEventListener('change', function() {
                commitment.deadline = this.value;
                
                // Check if date is >5 days away
                const selectedDate = new Date(this.value);
                const daysAway = Math.floor((selectedDate - today) / (1000 * 60 * 60 * 24));
                
                const warningEl = document.getElementById('deadline-warning');
                if (daysAway > 5) {
                    warningEl.style.display = 'block';
                } else {
                    warningEl.style.display = 'none';
                }
                
                updateCommitmentPreview();
            });
        }
        
        // Setup Action Validation (Real-time)
        function setupActionValidation() {
            const actionInput = document.getElementById('action-input');
            const charCountEl = document.getElementById('char-count');
            const validationEl = document.getElementById('action-validation');
            const validationMsg = document.getElementById('validation-message');
            
            actionInput.addEventListener('input', function() {
                const text = this.value;
                commitment.action = text;
                
                // Update character count
                charCountEl.textContent = text.length;
                
                // Validate if >20 characters
                if (text.length >= 20) {
                    const result = validateActionSpecificity(text);
                    
                    validationEl.style.display = 'block';
                    validationMsg.textContent = result.message;
                    
                    if (result.valid) {
                        validationEl.style.background = '#F0FDF4';
                        validationEl.style.border = '1px solid #000000';
                        validationEl.style.color = '#000000';
                        actionValidated = true;
                    } else {
                        validationEl.style.background = '#FEF2F2';
                        validationEl.style.border = '1px solid #000000';
                        validationEl.style.color = '#000000';
                        actionValidated = false;
                    }
                } else {
                    validationEl.style.display = 'none';
                    actionValidated = false;
                }
                
                updateCommitmentPreview();
            });
            
            // Partner input
            document.getElementById('partner-input').addEventListener('input', function() {
                commitment.accountabilityPartner = this.value.trim();
                updateCommitmentPreview();
            });
        }
        
        // Validate Action Specificity
        function validateActionSpecificity(actionText) {
            const vaguePhrases = [
                'improve', 'be better', 'try to', 'work on', 'focus on',
                'enhance', 'increase', 'more', 'less', 'communicate better'
            ];
            
            const hasVaguePhrase = vaguePhrases.some(phrase => 
                actionText.toLowerCase().includes(phrase)
            );
            
            const hasSpecifics = /\b(monday|tuesday|wednesday|thursday|friday|saturday|sunday|meeting|standup|1-on-1|email|slack|call|today|tomorrow|morning|afternoon|am|pm|o'clock)\b/i.test(actionText);
            
            const hasAction = /\b(admit|ask|share|say|write|send|schedule|call|present|discuss|tell|challenge|debate|argue|volunteer|cancel|celebrate|create|deliver|finish)\b/i.test(actionText);
            
            if (actionText.length < 20) {
                return { valid: false, message: '‚ùå Too short. Be more specific.' };
            }
            
            if (hasVaguePhrase && !hasSpecifics) {
                return { valid: false, message: '‚ùå Too vague. Add WHEN and WHERE you\'ll do this.' };
            }
            
            if (!hasAction) {
                return { valid: false, message: '‚ùå What ACTION will you take? Start with a verb.' };
            }
            
            if (hasSpecifics && hasAction) {
                return { valid: true, message: '‚úÖ Specific enough! Good commitment.' };
            }
            
            return { valid: false, message: '‚ùå Add more detail about when/where/how.' };
        }
        
        // Update Commitment Preview
        function updateCommitmentPreview() {
            const previewContent = document.getElementById('preview-content');
            const lockButton = document.getElementById('btn-lock-commitment');
            
            // Check if all fields are filled
            const allFilled = commitment.dysfunction && 
                            commitment.action && 
                            commitment.deadline && 
                            commitment.accountabilityPartner &&
                            actionValidated;
            
            if (allFilled) {
                const deadlineFormatted = new Date(commitment.deadline).toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'long', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                previewContent.innerHTML = `
                    <p style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">
                        I, <span style="color: var(--black);">[YOUR NAME]</span>, will fix: <span style="color: var(--black);">${commitment.dysfunctionName}</span>
                    </p>
                    <div style="margin-bottom: 16px;">
                        <strong style="text-transform: uppercase; font-size: 13px; color: var(--grey-600);">My Specific Action:</strong>
                        <p style="font-size: 16px; margin-top: 8px; padding: 12px; background: var(--grey-50); border-radius: 4px;">
                            "${commitment.action}"
                        </p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <strong style="text-transform: uppercase; font-size: 13px; color: var(--grey-600);">Deadline:</strong>
                            <p style="font-size: 16px; margin-top: 4px;">${deadlineFormatted}</p>
                        </div>
                        <div>
                            <strong style="text-transform: uppercase; font-size: 13px; color: var(--grey-600);">Accountability Partner:</strong>
                            <p style="font-size: 16px; margin-top: 4px;">${commitment.accountabilityPartner}</p>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding: 12px; background: var(--yellow-100); border-radius: 4px;">
                        <strong>‚ö†Ô∏è This commitment will be made public.</strong> No excuses.
                    </div>
                `;
                
                lockButton.disabled = false;
            } else {
                previewContent.innerHTML = `
                    <p style="font-size: 14px; color: var(--grey-500);">Fill out all fields above to see your commitment</p>
                `;
                lockButton.disabled = true;
            }
        }
        
        // Lock Commitment (Proceed to Public Step)
        function lockCommitment() {
            if (!commitment.dysfunction || !actionValidated || !commitment.deadline || !commitment.accountabilityPartner) {
                alert('Please complete all fields with valid inputs');
                return;
            }
            
            // Award FTP for completing action plan
            ftpPoints += 50;
            updateFTPDisplay();
            showToast('‚úì Action plan locked! +50 FTP');
            
            // Show public commitment step
            document.getElementById('step-action-plan').classList.add('hidden');
            document.getElementById('step-public-commitment').classList.remove('hidden');
            
            // Display locked commitment
            displayLockedCommitment();
            
            window.scrollTo(0, 0);
        }
        
        // Display Locked Commitment
        function displayLockedCommitment() {
            const container = document.getElementById('locked-commitment-display');
            const deadlineFormatted = new Date(commitment.deadline).toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            container.innerHTML = `
                <p style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">
                    I will fix: <span style="color: var(--black);">${commitment.dysfunctionName}</span>
                </p>
                <div style="margin-bottom: 16px;">
                    <strong style="text-transform: uppercase; font-size: 13px; color: var(--grey-600);">My Specific Action:</strong>
                    <p style="font-size: 16px; margin-top: 8px; padding: 12px; background: var(--grey-50); border-radius: 4px;">
                        "${commitment.action}"
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <strong style="text-transform: uppercase; font-size: 13px; color: var(--grey-600);">Deadline:</strong>
                        <p style="font-size: 16px; margin-top: 4px;">${deadlineFormatted}</p>
                    </div>
                    <div>
                        <strong style="text-transform: uppercase; font-size: 13px; color: var(--grey-600);">Accountability Partner:</strong>
                        <p style="font-size: 16px; margin-top: 4px;">${commitment.accountabilityPartner}</p>
                    </div>
                </div>
            `;
        }
        
        // Select Sharing Option
        function selectSharingOption(method) {
            commitment.madePublic = method;
            
            const deadlineFormatted = new Date(commitment.deadline).toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            // Note: Name will be filled in submission step
            const commitmentText = `üéØ TEAM DYSFUNCTION COMMITMENT - Sprint 5

I am committing to fix: ${commitment.dysfunctionName}

MY SPECIFIC ACTION:
"${commitment.action}"

DEADLINE: ${deadlineFormatted}

ACCOUNTABILITY PARTNER: ${commitment.accountabilityPartner}

This is public. No excuses.

#FastTrack #TeamCommitment #Sprint5`;
            
            if (method === 'slack') {
                // Copy to clipboard
                navigator.clipboard.writeText(commitmentText).then(() => {
                    ftpPoints += 100;
                    updateFTPDisplay();
                    showToast('‚úì Copied to clipboard! Paste in Slack. +100 FTP');
                    
                    // Proceed to submission
                    setTimeout(() => {
                        showSubmission();
                    }, 2000);
                });
            } else if (method === 'email') {
                const subject = encodeURIComponent(`Team Commitment - Sprint 5`);
                const body = encodeURIComponent(commitmentText);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
                
                ftpPoints += 100;
                updateFTPDisplay();
                showToast('‚úì Email opened! Send to team. +100 FTP');
                
                setTimeout(() => {
                    showSubmission();
                }, 2000);
            } else if (method === 'manual') {
                navigator.clipboard.writeText(commitmentText).then(() => {
                    ftpPoints += 50;
                    updateFTPDisplay();
                    showToast('‚úì Copied to clipboard! Share it anywhere. +50 FTP');
                    
                    setTimeout(() => {
                        showSubmission();
                    }, 2000);
                });
            } else if (method === 'private') {
                if (confirm('Are you sure? Private commitments fail 80% of the time. Fast Track is about public accountability.')) {
                    ftpPoints -= 50;
                    updateFTPDisplay();
                    showToast('You\'re going solo on this. Risky move. -50 FTP');
                    
                    setTimeout(() => {
                        showSubmission();
                    }, 2000);
                }
            }
        }
        
        // Show Submission
        function showSubmission() {
            document.getElementById('step-public-commitment').classList.add('hidden');
            document.getElementById('step-submission').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // Submit Assessment
        async function submitAssessment() {
            const name = document.getElementById('input-name').value.trim();
            const role = document.getElementById('input-role').value.trim();
            const email = document.getElementById('input-email').value.trim();

            if (!name || !role) {
                alert('Please enter your name and role');
                return;
            }

            try {
                // Get user ID from localStorage
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) {
                    alert('User not authenticated. Please return to the dashboard.');
                    return;
                }

                // Prepare submission data
                const submissionData = {
                    name,
                    role,
                    email,
                    scores,
                    timestamp: new Date().toISOString(),
                    ftpPoints,
                    commitment: {
                        dysfunction: commitment.dysfunction,
                        dysfunctionName: commitment.dysfunctionName,
                        dysfunctionScore: commitment.dysfunctionScore,
                        action: commitment.action,
                        deadline: commitment.deadline,
                        accountabilityPartner: commitment.accountabilityPartner,
                        madePublic: commitment.madePublic,
                        publicUrl: commitment.publicUrl
                    }
                };

                // Submit using RPC function (handles schema-specific tables)
                const { data: result, error: submitError } = await supabaseClient
                    .rpc('submit_tool_data', {
                        p_schema_name: CONFIG.SCHEMA_NAME,
                        p_user_id: userId,
                        p_data: submissionData,
                        p_tool_slug: CONFIG.TOOL_SLUG
                    });

                if (submitError) throw submitError;

                if (!result || !result.success) {
                    throw new Error(result?.message || 'Submission failed');
                }

                console.log('Submission ID:', result.submission_id);
                localStorage.setItem('lastSubmissionId', result.submission_id);

                // Generate code for display
                const code = btoa(JSON.stringify(submissionData));

                // Show confirmation
                document.getElementById('step-submission').classList.add('hidden');
                document.getElementById('step-confirmation').classList.remove('hidden');
                document.getElementById('submission-code').textContent = code;

                // Display final commitment
                displayFinalCommitment(name, role);

                // Bonus FTP
                ftpPoints += 50;
                updateFTPDisplay();
                showToast('üéâ Submission complete! +50 FTP');

                localStorage.setItem('lastSubmissionId', submission.id);
                window.scrollTo(0, 0);

            } catch (error) {
                console.error('Submit error:', error);
                alert('Submission failed: ' + error.message);
            }
        }
        
        // ‚úÖ NEW: Display Final Commitment on Confirmation Page
        function displayFinalCommitment(name, role) {
            const container = document.getElementById('final-commitment-display');
            const deadlineFormatted = new Date(commitment.deadline).toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            const publicStatus = commitment.madePublic !== 'private' ? 
                '<span style="color: #000000; font-weight: 600;">‚úì Made Public</span>' : 
                '<span style="color: var(--grey-500);">Kept Private</span>';
            
            container.innerHTML = `
                <p style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">
                    ${name} will fix: <span style="color: var(--black);">${commitment.dysfunctionName}</span>
                </p>
                <div style="margin-bottom: 12px;">
                    <strong style="text-transform: uppercase; font-size: 12px; color: var(--grey-600);">Action:</strong>
                    <p style="font-size: 15px; margin-top: 6px; padding: 10px; background: var(--grey-50); border-radius: 4px;">
                        ${commitment.action}
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                    <div>
                        <strong style="text-transform: uppercase; font-size: 12px; color: var(--grey-600);">Deadline:</strong>
                        <p style="margin-top: 4px;">${deadlineFormatted}</p>
                    </div>
                    <div>
                        <strong style="text-transform: uppercase; font-size: 12px; color: var(--grey-600);">Accountability:</strong>
                        <p style="margin-top: 4px;">${commitment.accountabilityPartner}</p>
                    </div>
                </div>
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--grey-200);">
                    ${publicStatus}
                </div>
            `;
        }

        // Copy Submission Code
        function copySubmissionCode() {
            const code = document.getElementById('submission-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('‚úì Code copied to clipboard');
            });
        }

        // ‚úÖ NEW: Export to PDF
        function exportToPDF() {
            showToast('üìÑ Generating PDF...');
            
            setTimeout(() => {
                // This would use jsPDF to generate PDF
                // For now, show success message
                showToast('‚úì PDF export ready (feature coming soon)');
            }, 1000);
        }

        // ‚úÖ NEW: Share via Email
        function shareViaEmail() {
            const name = document.getElementById('input-name').value;
            const subject = encodeURIComponent(`Team Assessment Results - ${name}`);
            const body = encodeURIComponent(`I've completed my Fast Track team assessment.\n\nMy submission code is:\n${document.getElementById('submission-code').textContent}\n\nPlease compile this with the team results.`);
            
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // ‚úÖ NEW: Copy Shareable Link
        function copyShareableLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showToast('‚úì Link copied to clipboard');
            });
        }

        // Navigation Functions
        function goToAssessment() {
            document.getElementById('step-scores').classList.add('hidden');
            document.getElementById('step-assessment').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function goToScores() {
            // Hide all steps
            document.getElementById('step-submission').classList.add('hidden');
            document.getElementById('step-action-plan').classList.add('hidden');
            document.getElementById('step-public-commitment').classList.add('hidden');
            // Show scores
            document.getElementById('step-scores').classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        // ‚úÖ NEW: Navigate to Action Plan
        function goToActionPlan() {
            document.getElementById('step-public-commitment').classList.add('hidden');
            document.getElementById('step-action-plan').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        // Reset Tool
        function resetTool() {
            if (confirm('Start a new assessment? Your current data will be lost.')) {
                responses = {};
                scores = {};
                ftpPoints = 0;
                
                document.getElementById('step-confirmation').classList.add('hidden');
                document.getElementById('step-assessment').classList.remove('hidden');
                
                // Reset all inputs
                document.querySelectorAll('input').forEach(input => input.value = '');
                document.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('selected'));
                document.querySelectorAll('.assessment-item').forEach(item => {
                    item.classList.remove('answered');
                    delete item.dataset.awarded;
                });
                
                updateProgress();
                updateFTPDisplay();
                window.scrollTo(0, 0);
            }
        }
        
        // ===== GURU MODE FUNCTIONS =====
        
        // Show Guru Modal
        function showGuruModal() {
            document.getElementById('guru-modal').classList.add('active');
            document.getElementById('guru-password').value = '';
            document.getElementById('guru-password').focus();
        }
        
        // Close Guru Modal
        function closeGuruModal() {
            document.getElementById('guru-modal').classList.remove('active');
        }
        
        // Validate Guru Access
        function validateGuruAccess() {
            const password = document.getElementById('guru-password').value;
            if (password === GURU_PASSWORD) {
                closeGuruModal();
                enterGuruMode();
            } else {
                alert('Incorrect password. Please try again.');
                document.getElementById('guru-password').value = '';
            }
        }
        
        // Enter Guru Mode
        function enterGuruMode() {
            // Hide all individual steps
            document.getElementById('step-assessment').classList.add('hidden');
            document.getElementById('step-scores').classList.add('hidden');
            document.getElementById('step-submission').classList.add('hidden');
            document.getElementById('step-confirmation').classList.add('hidden');
            
            // Show Guru Mode
            document.getElementById('guru-mode').classList.remove('hidden');
            
            // Render imported list
            renderImportedList();
            
            window.scrollTo(0, 0);
            showToast('‚úì Guru Mode activated');
        }
        
        // Exit Guru Mode
        function exitGuruMode() {
            document.getElementById('guru-mode').classList.add('hidden');
            document.getElementById('step-assessment').classList.remove('hidden');
            window.scrollTo(0, 0);
        }
        
        // Import Member Code
        function importMemberCode() {
            const input = document.getElementById('import-code-input');
            const code = input.value.trim();
            
            if (!code) {
                alert('Please enter a submission code');
                return;
            }
            
            try {
                const data = JSON.parse(atob(code));
                
                // Validate data structure
                if (!data.name || !data.scores) {
                    throw new Error('Invalid code format');
                }
                
                // Check for duplicate
                if (teamAssessments.find(a => a.name === data.name)) {
                    alert(`${data.name} has already been imported`);
                    return;
                }
                
                // Add to array
                teamAssessments.push(data);
                
                // Clear input
                input.value = '';
                
                // Update UI
                renderImportedList();
                
                // Show summary if 2+ members
                if (teamAssessments.length >= 2) {
                    renderTeamSummary();
                }
                
                // Show success feedback
                showToast(`‚úì ${data.name} imported successfully`);
                
            } catch (e) {
                alert('Invalid submission code. Please check and try again.');
                console.error('Import error:', e);
            }
        }
        
        // Remove Imported Member
        function removeImportedMember(index) {
            teamAssessments.splice(index, 1);
            renderImportedList();
            if (teamAssessments.length >= 2) {
                renderTeamSummary();
            } else {
                document.getElementById('team-summary-section').classList.add('hidden');
            }
        }
        
        // Render Imported List
        function renderImportedList() {
            const container = document.getElementById('imported-members');
            const countEl = document.getElementById('imported-count');
            
            countEl.textContent = teamAssessments.length;
            
            if (teamAssessments.length === 0) {
                container.innerHTML = '<p style="color: var(--grey-500); font-style: italic;">No team members imported yet</p>';
            } else {
                container.innerHTML = teamAssessments.map((member, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--grey-50); border: 1px solid var(--grey-200); border-radius: 4px; margin-bottom: 8px;">
                        <div>
                            <strong>${member.name}</strong>
                            ${member.role ? `<span style="color: var(--grey-600);"> - ${member.role}</span>` : ''}
                        </div>
                        <button onclick="removeImportedMember(${index})" style="background: none; border: none; cursor: pointer; color: var(--grey-400);">
                            <span class="icon icon-sm"><i data-lucide="x"></i></span>
                        </button>
                    </div>
                `).join('');
            }
            
            lucide.createIcons();
        }
        
        // Render Team Summary
        function renderTeamSummary() {
            if (teamAssessments.length < 2) return;
            
            document.getElementById('team-summary-section').classList.remove('hidden');
            
            // Calculate team averages
            const teamAverages = {};
            const varianceData = {};
            
            DYSFUNCTIONS.forEach(d => {
                const teamScores = teamAssessments.map(a => a.scores[d.id] || 0);
                const avg = teamScores.reduce((a, b) => a + b, 0) / teamScores.length;
                const min = Math.min(...teamScores);
                const max = Math.max(...teamScores);
                
                teamAverages[d.id] = {
                    avg: avg.toFixed(1),
                    min: min,
                    max: max,
                    range: max - min,
                    status: avg >= 8 ? 'healthy' : avg >= 6 ? 'moderate' : 'critical'
                };
                
                varianceData[d.id] = { range: max - min, min, max };
            });
            
            // Render priorities (top 3 lowest scores = highest dysfunctions)
            const sorted = Object.entries(teamAverages)
                .map(([id, data]) => ({ id, ...DYSFUNCTIONS.find(d => d.id === id), ...data }))
                .sort((a, b) => parseFloat(a.avg) - parseFloat(b.avg));
            
            const prioritiesContainer = document.getElementById('team-priorities');
            prioritiesContainer.innerHTML = sorted.slice(0, 3).map((d, i) => `
                <div style="background: var(--white); border: 2px solid ${d.status === 'critical' ? '#000000' : d.status === 'moderate' ? '#6B7280' : '#000000'}; border-radius: 4px; padding: 16px; text-align: center;">
                    <div class="priority-badge">PRIORITY #${i + 1}</div>
                    <h4 style="margin: 8px 0;">${d.name}</h4>
                    <div style="font-size: 32px; font-weight: 700; font-family: 'Plaak', sans-serif; color: ${d.status === 'critical' ? '#000000' : d.status === 'moderate' ? '#6B7280' : '#000000'};">${d.avg}/9</div>
                    <div class="status-badge ${d.status}" style="display: inline-block; margin-top: 8px;">
                        ${d.status === 'critical' ? '‚ö†Ô∏è Critical' : d.status === 'moderate' ? '‚ö° Moderate' : '‚úì Healthy'}
                    </div>
                </div>
            `).join('');
            
            // Render variance alerts
            const alertsContainer = document.getElementById('variance-alerts');
            const highVariance = Object.entries(varianceData)
                .filter(([id, data]) => data.range >= 3)
                .map(([id, data]) => ({ id, ...DYSFUNCTIONS.find(d => d.id === id), ...data }));
            
            if (highVariance.length > 0) {
                alertsContainer.innerHTML = `
                    <div class="card" style="background: #6B7280; background: #FFF3CD; border: 2px solid #6B7280;">
                        <h3 style="margin-bottom: 16px;">
                            <span class="icon icon-md"><i data-lucide="alert-triangle"></i></span>
                            Variance Alerts - Discuss These First
                        </h3>
                        ${highVariance.map(d => `
                            <div style="background: var(--white); border-left: 4px solid #6B7280; padding: 16px; margin-bottom: 12px; border-radius: 4px;">
                                <h4 style="margin-bottom: 8px;">
                                    <span class="icon icon-sm"><i data-lucide="alert-triangle"></i></span>
                                    High Variance: ${d.name}
                                </h4>
                                <p style="color: var(--grey-700);">
                                    Scores range from <strong>${d.min}</strong> to <strong>${d.max}</strong> (${d.range} point spread).
                                    This disagreement is worth discussing with the team to understand different perspectives.
                                </p>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                alertsContainer.innerHTML = '';
            }
            
            // Render table
            const table = document.getElementById('team-summary-table');
            table.innerHTML = `
                <thead style="background: var(--grey-100);">
                    <tr>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--grey-300);">Team Member</th>
                        ${DYSFUNCTIONS.map(d => `<th style="padding: 12px; text-align: center; border-bottom: 2px solid var(--grey-300);">${d.shortName}</th>`).join('')}
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid var(--grey-300);">Commitment</th>
                    </tr>
                </thead>
                <tbody>
                    ${teamAssessments.map(member => `
                        <tr style="border-bottom: 1px solid var(--grey-200);">
                            <td style="padding: 12px;"><strong>${member.name}</strong>${member.role ? ` <span style="color: var(--grey-500); font-weight: 400;">(${member.role})</span>` : ''}</td>
                            ${DYSFUNCTIONS.map(d => {
                                const score = member.scores[d.id] || 0;
                                const status = score >= 8 ? 'healthy' : score >= 6 ? 'moderate' : 'critical';
                                const color = status === 'healthy' ? '#000000' : status === 'moderate' ? '#6B7280' : '#000000';
                                return `<td style="padding: 12px; text-align: center; font-weight: 600; color: ${color};">${score}</td>`;
                            }).join('')}
                            <td style="padding: 12px; font-size: 13px;">
                                ${member.commitment && member.commitment.action ? `
                                    <strong style="display: block; margin-bottom: 4px;">Fix: ${member.commitment.dysfunctionName}</strong>
                                    <div style="color: var(--grey-600); margin-bottom: 4px;">${member.commitment.action.substring(0, 100)}${member.commitment.action.length > 100 ? '...' : ''}</div>
                                    <div style="color: var(--grey-500); font-size: 12px;">
                                        By: ${new Date(member.commitment.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} | 
                                        Partner: ${member.commitment.accountabilityPartner}
                                    </div>
                                    ${member.commitment.madePublic !== 'private' ? '<span style="color: #000000;">‚úì Public</span>' : '<span style="color: var(--grey-400);">Private</span>'}
                                ` : '<span style="color: var(--grey-400); font-style: italic;">No commitment</span>'}
                            </td>
                        </tr>
                    `).join('')}
                    <tr style="background: var(--grey-100); font-weight: 700;">
                        <td style="padding: 12px;">TEAM AVERAGE</td>
                        ${DYSFUNCTIONS.map(d => {
                            const data = teamAverages[d.id];
                            const color = data.status === 'healthy' ? '#000000' : data.status === 'moderate' ? '#6B7280' : '#000000';
                            return `<td style="padding: 12px; text-align: center; color: ${color};">${data.avg}</td>`;
                        }).join('')}
                        <td style="padding: 12px;"></td>
                    </tr>
                </tbody>
            `;
            
            lucide.createIcons();
        }
        
        // Export Team Summary
        function exportTeamSummary() {
            showToast('üìÑ Generating export...');
            setTimeout(() => {
                showToast('‚úì Export ready (PDF feature coming soon)');
            }, 1000);
        }
        
        // Copy Team Summary
        function copyTeamSummary() {
            if (teamAssessments.length < 2) return;
            
            // Calculate averages
            const teamAverages = {};
            DYSFUNCTIONS.forEach(d => {
                const teamScores = teamAssessments.map(a => a.scores[d.id] || 0);
                teamAverages[d.id] = (teamScores.reduce((a, b) => a + b, 0) / teamScores.length).toFixed(1);
            });
            
            // Build text summary
            let summary = `TEAM DYSFUNCTION SUMMARY\n`;
            summary += `Sprint 5 - ${teamAssessments.length} Team Members\n`;
            summary += `${'='.repeat(50)}\n\n`;
            
            summary += `INDIVIDUAL SCORES:\n`;
            summary += `-`.repeat(50) + `\n`;
            teamAssessments.forEach(m => {
                summary += `${m.name} (${m.role || 'N/A'}): `;
                summary += DYSFUNCTIONS.map(d => `${d.shortName}: ${m.scores[d.id]}`).join(' | ');
                summary += `\n`;
            });
            
            summary += `\nTEAM AVERAGES:\n`;
            summary += `-`.repeat(50) + `\n`;
            DYSFUNCTIONS.forEach(d => {
                const avg = teamAverages[d.id];
                const status = avg >= 8 ? '‚úì Healthy' : avg >= 6 ? '‚ö† Moderate' : '‚úó Critical';
                summary += `${d.name}: ${avg}/9 - ${status}\n`;
            });
            
            // ‚úÖ NEW: Add commitments section
            summary += `\n\nTEAM COMMITMENTS:\n`;
            summary += `-`.repeat(50) + `\n`;
            teamAssessments.forEach(m => {
                if (m.commitment && m.commitment.action) {
                    summary += `\n${m.name}:\n`;
                    summary += `  Fix: ${m.commitment.dysfunctionName}\n`;
                    summary += `  Action: ${m.commitment.action}\n`;
                    summary += `  Deadline: ${new Date(m.commitment.deadline).toLocaleDateString()}\n`;
                    summary += `  Accountability: ${m.commitment.accountabilityPartner}\n`;
                    summary += `  Status: ${m.commitment.madePublic !== 'private' ? 'Public ‚úì' : 'Private'}\n`;
                } else {
                    summary += `\n${m.name}: No commitment submitted\n`;
                }
            });
            
            navigator.clipboard.writeText(summary).then(() => {
                showToast('‚úì Summary copied to clipboard');
            });
        }
        
        // Print Team Summary
        function printTeamSummary() {
            window.print();
        }

        // Show Toast
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Keyboard Support
        document.addEventListener('keydown', function(e) {
            // Guru modal
            if (document.getElementById('guru-modal').classList.contains('active')) {
                if (e.key === 'Enter') {
                    validateGuruAccess();
                } else if (e.key === 'Escape') {
                    closeGuruModal();
                }
                return;
            }
            
            // Assessment navigation
            if (!document.getElementById('step-assessment').classList.contains('hidden')) {
                if (e.key === 'Enter' && !document.getElementById('btn-next').disabled) {
                    e.preventDefault();
                    nextSlide();
                } else if (e.key === 'ArrowRight' && !document.getElementById('btn-next').disabled) {
                    e.preventDefault();
                    nextSlide();
                } else if (e.key === 'ArrowLeft' && currentSlide > 0) {
                    e.preventDefault();
                    previousSlide();
                } else if (e.key >= '1' && e.key <= '3') {
                    // Quick select with number keys
                    const slides = document.querySelectorAll('.assessment-slide, .fun-fact-slide');
                    const currentSlideEl = slides[currentSlide];
                    if (currentSlideEl && currentSlideEl.dataset.itemId) {
                        const itemId = currentSlideEl.dataset.itemId;
                        const slideIndex = parseInt(currentSlideEl.dataset.slideIndex);
                        selectRatingSlide(itemId, parseInt(e.key), slideIndex);
                    }
                }
            }
        });

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>