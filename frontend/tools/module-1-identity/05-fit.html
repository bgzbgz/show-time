<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT Assessment | Fast Track Program</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Font preloading to prevent FOUT -->
    <link rel="preload" href="Plaak3Trial-43-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="RiformaLL-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="MonumentGrotesk-Mono.woff2" as="font" type="font/woff2" crossorigin>

    <style>
        /* === FONT FACES === */
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); font-display: swap; }

        /* === BASE RESET === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Riforma', -apple-system, sans-serif;
            font-size: 16px;
            color: #000;
            background: #000;
            -webkit-font-smoothing: antialiased;
        }

        /* === CUSTOM SCROLLBAR === */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        * { scrollbar-width: thin; scrollbar-color: #000 transparent; }

        /* === TYPOGRAPHY HELPERS === */
        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        /* === LAYOUT FRAME === */
        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        /* === WIZARD LAYOUT === */
        .wizard-layout { display: flex; flex-direction: row-reverse; min-height: 100vh; }
        .wizard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fff;
        }
        .wizard-content {
            max-width: 720px;
            width: 100%;
            margin: 0 auto;
            padding: 48px 32px;
            flex: 1;
        }

        /* === SIDEBAR === */
        .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }
        .wizard-sidebar-inner {
            padding: 32px 24px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .sidebar-step-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }

        /* === Phase header in sidebar === */
        .sidebar-phase-header {
            font-family: 'Monument', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #FFF469;
            padding: 8px 12px;
            margin-top: 16px;
            margin-bottom: 4px;
        }

        /* === STEP HEADER === */
        .step-indicator {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-time {
            font-family: 'Monument', monospace;
            font-size: 11px;
            color: #6B7280;
        }
        .step-heading {
            font-family: 'Plaak', sans-serif;
            font-weight: bold;
            font-size: 32px;
            text-transform: uppercase;
            letter-spacing: -0.01em;
            line-height: 1.2;
            color: #000;
            margin-bottom: 6px;
        }
        .step-hint {
            font-size: 16px;
            color: #6B7280;
            line-height: 1.5;
            margin: 0 0 32px 0;
        }

        /* === FORM ELEMENTS === */
        .ft-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Monument', monospace;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 8px;
        }
        .ft-required { color: #DC2626; font-weight: 700; }

        .ft-input {
            width: 100%;
            height: 44px;
            padding: 8px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }
        .ft-input.has-error {
            border: 2px solid #DC2626;
            padding-right: 40px;
        }
        .ft-input.has-error:focus {
            border-color: #DC2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }

        .ft-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            resize: none !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-textarea:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }
        .ft-textarea.has-error {
            border: 2px solid #DC2626;
        }
        .ft-textarea.has-error:focus {
            border-color: #DC2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }

        .ft-help {
            font-size: 14px;
            color: #6B7280;
            margin-top: 4px;
            line-height: 1.5;
        }
        .ft-error-msg {
            font-size: 14px;
            font-weight: 600;
            color: #DC2626;
            margin-top: 4px;
            line-height: 1.4;
        }
        .ft-field-group {
            margin-bottom: 24px;
        }
        .ft-field-group:last-child { margin-bottom: 0; }
        .ft-section { margin-bottom: 32px; }

        /* === YELLOW INSIGHT BOX === */
        .ft-insight {
            background: #FFF469;
            border: 3px solid #000;
            padding: 16px;
            margin-bottom: 32px;
        }

        /* === EXAMPLE BOX === */
        .ft-example {
            background: #F3F4F6;
            padding: 16px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #1F2937;
        }

        /* === ERROR SUMMARY === */
        .ft-error-summary {
            border: 2px solid #DC2626;
            background: #fff;
            padding: 16px;
            margin-bottom: 24px;
        }
        .ft-error-summary a {
            color: #DC2626;
            text-decoration: underline;
            cursor: pointer;
        }
        .ft-error-summary a:hover { text-decoration: none; }

        /* === BUTTON FOOTER === */
        .btn-footer {
            position: sticky;
            bottom: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-top: 1px solid #E5E7EB;
            background: #fff;
            width: 100%;
        }
        .btn-back {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-back:hover { background: #F3F4F6; }
        .btn-next {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E5E7EB; color: #9CA3AF; border-color: #E5E7EB; cursor: not-allowed; }

        /* === CLOSING MESSAGE === */
        .closing-box {
            border-top: 1px solid #E5E7EB;
            padding: 20px 0 0 0;
            margin-top: 8px;
            text-align: center;
        }
        .closing-box p { font-size: 14px; color: #6B7280; }
        .closing-box .closing-title {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 6px;
        }

        /* === MOBILE STEP BAR === */
        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; background: #F3F4F6; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E5E7EB; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }

        /* === CANVAS STYLES === */
        .numbered-section { background: #000; color: #fff; padding: 8px 14px; font-size: 14px; font-weight: bold; letter-spacing: 0.5px; display: inline-block; font-family: 'Monument', monospace; }

        /* === ANIMATIONS === */
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }

        /* === PRINT === */
        @media print { .no-print { display: none !important; } }

        /* === RESPONSIVE === */
        @media (min-width: 769px) and (max-width: 1024px) {
            .wizard-sidebar { width: 220px; }
            .wizard-sidebar-inner { padding: 24px 16px; }
        }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .mobile-step-bar { display: block; }
            .wizard-content { padding: 24px 16px; }
            .step-heading { font-size: 24px; }
            .btn-footer { padding: 12px 16px; }
            .fit-columns { grid-template-columns: 1fr !important; gap: 24px !important; }
        }
        @media (max-width: 480px) {
            .step-heading { font-size: 20px; }
            .wizard-content { padding: 20px 12px; }
        }

        /* === TOOL-SPECIFIC: Range Slider Styles === */
        .fit-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #E5E7EB;
            outline: none;
            border-radius: 4px;
        }
        .fit-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #000;
            border-radius: 50%;
            cursor: pointer;
        }
        .fit-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #000;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* === TOOL-SPECIFIC: FIT Columns Layout === */
        .fit-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }
        .fit-column-header {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #000;
        }

        /* === TOOL-SPECIFIC: Buttons === */
        .btn-primary {
            background: #000;
            color: #fff;
            padding: 16px 32px;
            border: 2px solid #000;
            font-family: 'Riforma', sans-serif;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary:disabled { background: #E0E0E0; color: #9CA3AF; cursor: not-allowed; opacity: 0.5; }
        .btn-secondary {
            background: #fff;
            color: #000;
            padding: 12px 24px;
            border: 2px solid #000;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover { background: #F8F8F8; }

        /* === Spinner === */
        .spinner {
            border: 4px solid #E0E0E0;
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* === ABC Matrix === */
        .abc-matrix-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1;
            border: 2px solid #000;
            margin: 0 auto 24px;
        }
        .abc-quadrant {
            position: absolute;
            width: 50%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Plaak', sans-serif;
            font-size: 28px;
            font-weight: bold;
            opacity: 0.15;
        }
        .abc-quadrant-tl { top: 0; left: 0; background: #FEF3C7; }
        .abc-quadrant-tr { top: 0; right: 0; background: #D1FAE5; }
        .abc-quadrant-bl { bottom: 0; left: 0; background: #FEE2E2; }
        .abc-quadrant-br { bottom: 0; right: 0; background: #DBEAFE; }
        .abc-dot {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #000;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Riforma', sans-serif;
            transform: translate(-50%, -50%);
            z-index: 5;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .abc-axis-label {
            position: absolute;
            font-family: 'Monument', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
        }

        /* === Badge Styles === */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-yellow { background: #FFF469; color: #000; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
            TOOL_SLUG: 'fit',
            AUTOSAVE_DELAY: 2000
        };

        const STORAGE_KEY = 'fasttrack_fit_tool';

        const supabaseClient = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        window.supabaseClient = supabaseClient;

        ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);

        CognitiveLoad.init('fit', {"insights":["FIT forces honest conversations about whether people are in the right roles.","A-players in wrong seats destroy more value than B-players in right seats."],"caseStudy":{"before":"A mid-size manufacturer discovered that 6 out of 15 team members were misaligned -- high performers in wrong seats draining energy and producing mediocre results despite strong talent.","after":"After completing the FIT and ABC analysis, targeted role changes and coaching plans moved 4 of 6 misaligned members into better-fit positions, lifting team productivity by 25% within one quarter.","quote":"The FIT tool forced us to stop avoiding the hard conversations. We realized our best people were burning out in roles that didn't match their strengths -- fixing that changed everything."}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

        /* ============================================================
           FIT DIMENSIONS DATA
           ============================================================ */

        const FIT_DIMENSIONS = [
            {
                key: 'values',
                title: 'VALUES ALIGNMENT',
                stepTitle: 'THE VALUES',
                youLabel: 'Your Personal Values',
                youHint: 'List 3 values that are most important to you personally.',
                youPlaceholders: ['e.g. Integrity', 'e.g. Innovation', 'e.g. Work-life balance'],
                theirLabel: "The Company's Values",
                theirHint: "List 3 core values of your company.",
                theirPlaceholders: ['e.g. Customer first', 'e.g. Excellence', 'e.g. Teamwork'],
                fitQuestion: 'What % fit do you think there is between your values and the company values?'
            },
            {
                key: 'job',
                title: 'JOB FIT',
                stepTitle: 'THE JOB',
                youLabel: 'Your Strengths & Capabilities',
                youHint: 'List 3 key strengths you bring to your role.',
                youPlaceholders: ['e.g. Strategic thinking', 'e.g. Data analysis', 'e.g. Team leadership'],
                theirLabel: 'Job Requirements',
                theirHint: 'List 3 key capabilities your job demands.',
                theirPlaceholders: ['e.g. Project management', 'e.g. Stakeholder communication', 'e.g. Budget oversight'],
                fitQuestion: 'What % fit do you think there is between your strengths and your job requirements?'
            },
            {
                key: 'team',
                title: 'TEAM DYNAMICS',
                stepTitle: 'THE TEAM',
                youLabel: 'Your Working Style & Personality',
                youHint: 'Describe 3 aspects of how you prefer to work.',
                youPlaceholders: ['e.g. Prefer autonomy', 'e.g. Direct communicator', 'e.g. Detail-oriented'],
                theirLabel: 'Team Culture & Dynamics',
                theirHint: 'Describe 3 aspects of how your team operates.',
                theirPlaceholders: ['e.g. Collaborative decision-making', 'e.g. Fast-paced', 'e.g. Open-door culture'],
                fitQuestion: 'What % fit do you think there is between your working style and the team dynamics?'
            },
            {
                key: 'boss',
                title: 'LEADERSHIP FIT',
                stepTitle: 'THE BOSS',
                youLabel: 'Your Ideal Boss',
                youHint: 'Describe 3 qualities you value most in a leader.',
                youPlaceholders: ['e.g. Gives clear direction', 'e.g. Trusts me to deliver', 'e.g. Open to feedback'],
                theirLabel: "Your Boss's Leadership Style",
                theirHint: "Describe 3 characteristics of your boss's actual style.",
                theirPlaceholders: ['e.g. Hands-on management', 'e.g. Results-focused', 'e.g. Weekly check-ins'],
                fitQuestion: "What % fit do you think there is between your ideal boss and your actual boss's style?"
            }
        ];

        /* ============================================================
           TRANSITION CONTENT
           ============================================================ */

        const TRANSITION_CONTENT = {
            1: {
                title: 'VALUES MAPPED.',
                text: "You've compared your personal values with the company's. Now assess your job fit.",
                brutalTruth: "Values misalignment is the silent killer of careers. You can tolerate a bad job or a difficult boss for years, but working for an organization whose values clash with yours erodes your identity. If your values score is below 60%, no amount of salary or perks will make you feel fulfilled.",
                peerProof: '"I scored my values fit at 45% and tried to ignore it for two years. When I finally moved to a company whose values matched mine, my energy levels doubled and I got promoted within six months. The FIT score was right all along." -- Marketing Director, B2B SaaS'
            },
            2: {
                title: 'JOB ASSESSED.',
                text: "You've evaluated your strengths against job demands. Now look at team dynamics.",
                brutalTruth: "High job fit means you are energized by what you do every day. Low job fit means you are spending willpower instead of talent. Most people confuse competence with fit -- just because you can do something does not mean you should. The best performers are in roles that feel like play, not punishment.",
                peerProof: '"My job fit was 55% -- I was good at my role but it drained me. After moving to a position that matched my natural strengths, my output increased by 40% and I stopped dreading Monday mornings." -- Operations Lead, manufacturing firm'
            },
            3: {
                title: 'TEAM EVALUATED.',
                text: "You've assessed team dynamics. Now reflect on leadership alignment.",
                brutalTruth: "Team dynamics are a force multiplier. A high-fit individual in a low-fit team produces average results. A mediocre talent in a high-fit team often outperforms stars who work in isolation. The uncomfortable truth: if your team fit is below 60%, you are either in the wrong team or you are the problem. Both require action.",
                peerProof: '"Our team scored 40% on dynamics fit. We assumed it was personality clashes, but the FIT tool showed it was a working-style mismatch. Once we restructured meeting formats and communication channels to accommodate different styles, collaboration improved dramatically." -- CTO, fintech startup'
            },
            4: {
                title: 'FIT COMPLETE.',
                text: "All four dimensions assessed. Your total FIT score reveals your alignment.",
                brutalTruth: "An average FIT score below 60% is a clear signal: something fundamental needs to change. Above 80% means you are in the right place -- protect it fiercely. Between 60-80% means targeted interventions can close the gap. The worst thing you can do now is nothing. These scores have a half-life -- within two weeks, the honesty fades and comfortable denial returns.",
                peerProof: '"I shared my FIT scores with my boss the day after completing them. That conversation was uncomfortable but it led to a role adjustment that transformed my career trajectory. The data gave me permission to have the conversation I had been avoiding for months." -- Senior Product Manager'
            }
        };

        /* ============================================================
           SHARED COMPONENTS
           ============================================================ */

        function CheckIcon({ color = "#fff", size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
        }

        function LockIcon({ size = 20, color = "#9CA3AF" }) {
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0110 0v4" />
                </svg>
            );
        }

        function ButtonFooter({ onBack, onNext, nextLabel = 'Next', showBack = true, disabled = false }) {
            return (
                <div className="btn-footer no-print">
                    {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                    <button className="btn-next" disabled={disabled} onClick={onNext}>{nextLabel} &rarr;</button>
                </div>
            );
        }

        function MobileStepBar({ currentStep, totalSteps }) {
            const total = totalSteps || 4;
            const progress = Math.round((Math.min(currentStep, total) / total) * 100);
            return (
                <div className="mobile-step-bar no-print">
                    <div className="bar-text">Step {Math.min(currentStep, total)} of {total}</div>
                    <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${progress}%` }} /></div>
                </div>
            );
        }

        function CoachFeedbackPanel() {
            const [expanded, setExpanded] = useState(false);
            const [feedback, setFeedback] = useState(null);

            useEffect(() => {
                const check = () => {
                    if (window.AIChallenge && window.AIChallenge.getLastFeedback) {
                        setFeedback(window.AIChallenge.getLastFeedback());
                    }
                };
                check();
                const interval = setInterval(check, 2000);
                return () => clearInterval(interval);
            }, []);

            if (!feedback) return null;

            return (
                <div style={{ marginTop: 24, borderTop: '1px solid #333', paddingTop: 16 }}>
                    <button
                        onClick={() => setExpanded(!expanded)}
                        style={{ background: 'none', border: 'none', color: '#FFF469', cursor: 'pointer', fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', display: 'flex', alignItems: 'center', gap: 6, padding: 0, width: '100%' }}
                    >
                        <span style={{ transform: expanded ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s', display: 'inline-block' }}>&#9654;</span>
                        COACH FEEDBACK
                    </button>
                    {expanded && (
                        <div style={{ marginTop: 10, fontSize: 12, color: '#ccc', lineHeight: 1.5 }}>
                            {feedback.type === 'approved' && (
                                <p style={{ color: '#FFF469' }}>{feedback.message}</p>
                            )}
                            {feedback.type === 'challenges' && (
                                <>
                                    {feedback.encouragement && <p style={{ color: '#FFF469', marginBottom: 8 }}>{feedback.encouragement}</p>}
                                    {feedback.challenges && feedback.challenges.map((ch, i) => (
                                        <div key={i} style={{ marginBottom: 8, paddingLeft: 8, borderLeft: '2px solid #555' }}>
                                            <div style={{ fontSize: 10, color: '#999', marginBottom: 2 }}>{ch.question_text || ch.question_key}</div>
                                            <div>{ch.feedback}</div>
                                        </div>
                                    ))}
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function DependencyContext({ deps }) {
            const [open, setOpen] = React.useState(false);
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '16px' }}>
                    <button onClick={() => setOpen(o => !o)} style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '8px 14px', fontSize: 12, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase', cursor: 'pointer', color: '#555', width: '100%' }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#DAA520" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        CONTEXT FROM PREVIOUS TOOLS ({deps.length})
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#999" strokeWidth="2" style={{ marginLeft: 'auto', transform: open ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    {open && (
                        <div style={{ border: '1px solid #F0E68C', borderTop: 'none', padding: '12px 14px' }}>
                            {deps.map((dep, i) => (
                                <div key={i} style={{ background: '#fff', padding: '8px 0', borderBottom: i < deps.length - 1 ? '1px solid #F0E68C' : 'none', fontSize: '13px' }}>
                                    <div style={{ fontWeight: 600, marginBottom: '2px', color: '#333', fontSize: '11px', fontFamily: "'Monument', monospace", letterSpacing: '0.04em', textTransform: 'uppercase' }}>{dep.label}</div>
                                    <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        /* ============================================================
           SIDEBAR
           ============================================================ */

        function WizardSidebar({ currentStep, mode, fitData, teamData, abcData, onNavigate }) {
            const individualSteps = [
                { num: 1, label: 'Values' },
                { num: 2, label: 'Job' },
                { num: 3, label: 'Team' },
                { num: 4, label: 'Boss' }
            ];
            const abcSteps = [
                { num: 5, label: 'ABC Matrix' },
                { num: 6, label: 'Review & Submit' }
            ];
            const teamSteps = [
                { num: 7, label: 'Team FIT Summary' },
                { num: 8, label: 'Meeting & Review' }
            ];

            const effectiveStep = Math.ceil(currentStep);

            const getSnippet = (n) => {
                if (mode === 'individual') {
                    const dimIndex = n - 1;
                    const dim = FIT_DIMENSIONS[dimIndex];
                    if (!dim) return null;
                    const d = fitData[dim.key];
                    if (d && d.fit > 0 && d.you.some(v => v.trim())) {
                        return d.fit + '% fit';
                    }
                } else if (mode === 'abc') {
                    if (n === 5 && abcData && abcData.members && abcData.members.length > 0) {
                        return abcData.members.length + ' member' + (abcData.members.length !== 1 ? 's' : '');
                    }
                    if (n === 6) return 'Ready to submit';
                } else if (mode === 'team') {
                    if (n === 7 && teamData.teamMembers.length > 0) {
                        return teamData.teamMembers.length + ' member' + (teamData.teamMembers.length !== 1 ? 's' : '');
                    }
                    if (n === 8) return 'Meeting agenda';
                }
                return null;
            };

            const renderStepItem = (s) => {
                const isCompleted = effectiveStep > s.num;
                const isActive = effectiveStep === s.num;
                const isLocked = effectiveStep < s.num;
                const snippet = isCompleted ? getSnippet(s.num) : null;

                return (
                    <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                        onClick={() => isCompleted && onNavigate && onNavigate(s.num)}
                        title={isCompleted ? 'Click to review this step' : ''}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                            {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                            <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                        </div>
                        {snippet && <div className="sidebar-snippet">{snippet}</div>}
                    </div>
                );
            };

            const timeLabel = mode === 'individual' ? '~20 min' : mode === 'abc' ? '~15 min' : '~90 min';

            return (
                <div className="wizard-sidebar no-print">
                    <div className="wizard-sidebar-inner">
                        <div style={{ marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>THE FIT</div>
                            <div style={{ fontSize: 13, color: '#999' }}>{timeLabel}</div>
                        </div>

                        {mode === 'individual' && (
                            <>
                                <div className="sidebar-phase-header">Individual Phase</div>
                                {individualSteps.map(renderStepItem)}
                            </>
                        )}

                        {mode === 'abc' && (
                            <>
                                <div className="sidebar-phase-header">ABC Matrix (CEO)</div>
                                {abcSteps.map(renderStepItem)}
                            </>
                        )}

                        {mode === 'team' && (
                            <>
                                <div className="sidebar-phase-header">Team Meeting (CEO)</div>
                                {teamSteps.map(renderStepItem)}
                            </>
                        )}

                        <CoachFeedbackPanel />
                    </div>
                </div>
            );
        }

        /* ============================================================
           INDIVIDUAL PHASE: STEPS 1-4 (One per dimension)
           ============================================================ */

        function FitDimensionStep({ dimension, stepNum, fitData, setFitData }) {
            const d = fitData[dimension.key];

            const updateYou = (index, value) => {
                setFitData(prev => {
                    const newYou = [...prev[dimension.key].you];
                    newYou[index] = value;
                    return { ...prev, [dimension.key]: { ...prev[dimension.key], you: newYou } };
                });
            };

            const updateThem = (index, value) => {
                setFitData(prev => {
                    const newThem = [...prev[dimension.key].them];
                    newThem[index] = value;
                    return { ...prev, [dimension.key]: { ...prev[dimension.key], them: newThem } };
                });
            };

            const updateFit = (value) => {
                setFitData(prev => ({
                    ...prev,
                    [dimension.key]: { ...prev[dimension.key], fit: parseInt(value) }
                }));
            };

            const fitColor = d.fit < 60 ? '#DC2626' : d.fit <= 90 ? '#D97706' : '#059669';

            return (
                <div className="animate-in">
                    <div className="step-indicator">
                        <span>Individual Phase -- Step {stepNum} of 4</span>
                        <span className="step-time">~5 min</span>
                    </div>
                    <h2 className="step-heading">{dimension.title}</h2>
                    <p className="step-hint">Compare your attributes with the organization's to assess alignment in this dimension.</p>

                                                                                
                    <div className="fit-columns">
                        {/* LEFT: YOU */}
                        <div>
                            <div className="fit-column-header">YOU</div>
                            <div style={{ marginBottom: 8 }}>
                                <label className="ft-label">{dimension.youLabel} <span className="ft-required">*</span></label>
                                <p className="ft-help" style={{ marginBottom: 12, marginTop: 0 }}>{dimension.youHint}</p>
                            </div>
                            {[0, 1, 2].map(i => (
                                <div key={i} className="ft-field-group">
                                    <input
                                        type="text"
                                        className="ft-input"
                                        value={d.you[i]}
                                        onChange={(e) => updateYou(i, e.target.value)}
                                        placeholder={dimension.youPlaceholders[i]}
                                    />
                                </div>
                            ))}
                        </div>

                        {/* RIGHT: THEM */}
                        <div>
                            <div className="fit-column-header">{dimension.key === 'values' ? 'THE COMPANY' : dimension.key === 'job' ? 'THE JOB' : dimension.key === 'team' ? 'THE TEAM' : 'THE BOSS'}</div>
                            <div style={{ marginBottom: 8 }}>
                                <label className="ft-label">{dimension.theirLabel} <span className="ft-required">*</span></label>
                                <p className="ft-help" style={{ marginBottom: 12, marginTop: 0 }}>{dimension.theirHint}</p>
                            </div>
                            {[0, 1, 2].map(i => (
                                <div key={i} className="ft-field-group">
                                    <input
                                        type="text"
                                        className="ft-input"
                                        value={d.them[i]}
                                        onChange={(e) => updateThem(i, e.target.value)}
                                        placeholder={dimension.theirPlaceholders[i]}
                                    />
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* FIT RATING */}
                    <div style={{ border: '2px solid #E5E7EB', padding: 24, marginBottom: 24 }}>
                        <label className="ft-label" style={{ marginBottom: 16 }}>{dimension.fitQuestion} <span className="ft-required">*</span></label>
                        <div style={{ textAlign: 'center', marginBottom: 16 }}>
                            <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 56, fontWeight: 'bold', color: fitColor, lineHeight: 1 }}>{d.fit}</span>
                            <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 28, fontWeight: 'bold', color: fitColor }}>%</span>
                        </div>
                        <input
                            type="range"
                            min="0"
                            max="100"
                            value={d.fit}
                            onChange={(e) => updateFit(e.target.value)}
                            className="fit-slider"
                        />
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 8 }}>
                            <span style={{ fontSize: 12, color: '#6B7280', fontFamily: "'Monument', monospace" }}>0% -- No fit</span>
                            <span style={{ fontSize: 12, color: '#6B7280', fontFamily: "'Monument', monospace" }}>100% -- Perfect fit</span>
                        </div>
                    </div>
                </div>
            );
        }

        /* ============================================================
           ABC HELPERS
           ============================================================ */

        function getCategory(member) {
            const valScore = member.valuesFit || 0;
            const perfScore = member.performance || 0;
            if (valScore >= 50 && perfScore >= 50) return 'A';
            if (valScore >= 50 && perfScore < 50) return 'B+';
            if (valScore < 50 && perfScore >= 50) return 'B';
            return 'C';
        }

        function getCategoryLabel(cat) {
            if (cat === 'A') return 'A-Player: High values + High performance';
            if (cat === 'B+') return 'B+-Player: High values + Low performance';
            if (cat === 'B') return 'B-Player: Low values + High performance';
            return 'C-Player: Low values + Low performance';
        }

        function getCategoryRec(cat) {
            if (cat === 'A') return 'Retain, develop, and promote. These are your stars in the right seats.';
            if (cat === 'B+') return 'Coach and develop. Strong culture fit but needs performance support. Invest in training.';
            if (cat === 'B') return 'Warning zone. High performer but values misalignment. Have an honest conversation about culture fit.';
            return 'Address urgently. Misaligned on both dimensions. Consider role change or exit.';
        }

        function getCategoryColor(cat) {
            if (cat === 'A') return '#059669';
            if (cat === 'B+') return '#D97706';
            if (cat === 'B') return '#2563EB';
            return '#DC2626';
        }

        /* ============================================================
           ABC MATRIX VISUALIZATION (shared between ABC and Review)
           ============================================================ */

        function ABCMatrixVisualization({ members }) {
            if (!members || members.length === 0) return null;
            return (
                <div className="ft-section">
                    <div className="ft-label" style={{ marginBottom: 12 }}>ABC Matrix Visualization</div>
                    <div style={{ position: 'relative', paddingLeft: 40, paddingBottom: 40 }}>
                        <div className="abc-axis-label" style={{ left: 0, top: '50%', transform: 'rotate(-90deg) translateX(-50%)', transformOrigin: '0 0', whiteSpace: 'nowrap' }}>
                            VALUES (0-100)
                        </div>
                        <div className="abc-axis-label" style={{ bottom: 8, left: '50%', transform: 'translateX(-50%)', whiteSpace: 'nowrap' }}>
                            PERFORMANCE (0-100)
                        </div>
                        <div className="abc-matrix-container">
                            <div className="abc-quadrant abc-quadrant-tl">B+</div>
                            <div className="abc-quadrant abc-quadrant-tr">A</div>
                            <div className="abc-quadrant abc-quadrant-bl">C</div>
                            <div className="abc-quadrant abc-quadrant-br">B</div>
                            <div style={{ position: 'absolute', left: '50%', top: 0, bottom: 0, borderLeft: '1px dashed #999', zIndex: 2 }} />
                            <div style={{ position: 'absolute', top: '50%', left: 0, right: 0, borderTop: '1px dashed #999', zIndex: 2 }} />
                            {members.map(member => {
                                const x = (member.performance || 0) / 100 * 100;
                                const y = (1 - (member.valuesFit || 0) / 100) * 100;
                                const initial = member.name.charAt(0).toUpperCase();
                                return (
                                    <div
                                        key={member.id}
                                        className="abc-dot"
                                        style={{ left: x + '%', top: y + '%' }}
                                        title={member.name + ' (V:' + member.valuesFit + '% P:' + member.performance + '%)'}
                                    >
                                        {initial}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        function ABCMemberClassification({ members }) {
            if (!members || members.length === 0) return null;
            return (
                <div className="ft-section">
                    <div className="ft-label" style={{ marginBottom: 12 }}>Member Classification</div>
                    {members.map(member => {
                        const cat = getCategory(member);
                        return (
                            <div key={member.id} style={{ border: '1px solid #E5E7EB', borderLeft: '4px solid ' + getCategoryColor(cat), padding: 16, marginBottom: 8 }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
                                    <span style={{ fontWeight: 600, fontSize: 15 }}>{member.name}</span>
                                    <span style={{ fontWeight: 700, color: getCategoryColor(cat), fontSize: 18 }}>{cat}</span>
                                </div>
                                <div style={{ fontSize: 13, color: '#6B7280', marginBottom: 4 }}>{getCategoryLabel(cat)}</div>
                                <div style={{ fontSize: 13, color: '#374151', fontStyle: 'italic' }}>{getCategoryRec(cat)}</div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        /* ============================================================
           ABC MODE: STEP 5 - ABC Talent Matrix (add members + rate + visualize)
           ============================================================ */

        function ABCMatrixStep({ abcData, setAbcData }) {
            const [newMemberName, setNewMemberName] = useState('');
            const members = abcData.members || [];

            const addMember = () => {
                const name = newMemberName.trim();
                if (!name) return;
                const newMember = {
                    id: Date.now().toString(),
                    name: name,
                    valuesFit: 0,
                    performance: 0
                };
                setAbcData(prev => ({
                    ...prev,
                    members: [...(prev.members || []), newMember]
                }));
                setNewMemberName('');
            };

            const removeMember = (id) => {
                setAbcData(prev => ({
                    ...prev,
                    members: (prev.members || []).filter(m => m.id !== id)
                }));
            };

            const updateMemberField = (memberId, field, value) => {
                const num = parseInt(value);
                const val = isNaN(num) ? 0 : Math.min(100, Math.max(0, num));
                setAbcData(prev => ({
                    ...prev,
                    members: (prev.members || []).map(m =>
                        m.id === memberId ? { ...m, [field]: val } : m
                    )
                }));
            };

            return (
                <div className="animate-in">
                    <div className="step-indicator">
                        <span>ABC Matrix -- Step 1 of 2</span>
                        <span className="step-time">~10 min</span>
                    </div>
                    <h2 className="step-heading">ABC Talent Matrix</h2>
                    <p className="step-hint">Add each team member and rate their values alignment and performance. These are your own subjective ratings as CEO.</p>



                    {/* Add member */}
                    <div className="ft-field-group">
                        <label className="ft-label">Add Team Member</label>
                        <div style={{ display: 'flex', gap: 8 }}>
                            <input
                                type="text"
                                value={newMemberName}
                                onChange={(e) => setNewMemberName(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && addMember()}
                                placeholder="Member name"
                                className="ft-input"
                            />
                            <button onClick={addMember} className="btn-next" style={{ whiteSpace: 'nowrap', minWidth: 100 }}>
                                Add
                            </button>
                        </div>
                    </div>

                    {/* Member rating cards */}
                    {members.length > 0 && (
                        <div>
                            <div className="ft-label" style={{ marginBottom: 16 }}>
                                Team Members ({members.length})
                            </div>
                            {members.map(member => {
                                const cat = getCategory(member);
                                return (
                                    <div key={member.id} style={{ border: '1px solid #E5E7EB', padding: 16, marginBottom: 12 }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                                            <span style={{ fontWeight: 600, fontSize: 15 }}>{member.name}</span>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                                <span className="badge" style={{ background: getCategoryColor(cat) + '20', color: getCategoryColor(cat), fontWeight: 600 }}>
                                                    {cat}
                                                </span>
                                                <button onClick={() => removeMember(member.id)} style={{ background: 'none', border: 'none', color: '#DC2626', cursor: 'pointer', fontSize: 13 }}>Remove</button>
                                            </div>
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                            <div>
                                                <label style={{ fontSize: 13, color: '#6B7280', display: 'block', marginBottom: 4 }}>Values Alignment (%)</label>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="100"
                                                    value={member.valuesFit || 0}
                                                    onChange={(e) => updateMemberField(member.id, 'valuesFit', e.target.value)}
                                                    className="fit-slider"
                                                    style={{ marginBottom: 4 }}
                                                />
                                                <div style={{ textAlign: 'center', fontWeight: 600, fontSize: 14 }}>{member.valuesFit || 0}%</div>
                                            </div>
                                            <div>
                                                <label style={{ fontSize: 13, color: '#6B7280', display: 'block', marginBottom: 4 }}>Performance (%)</label>
                                                <input
                                                    type="range"
                                                    min="0"
                                                    max="100"
                                                    value={member.performance || 0}
                                                    onChange={(e) => updateMemberField(member.id, 'performance', e.target.value)}
                                                    className="fit-slider"
                                                    style={{ marginBottom: 4 }}
                                                />
                                                <div style={{ textAlign: 'center', fontWeight: 600, fontSize: 14 }}>{member.performance || 0}%</div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Visual Matrix */}
                    <ABCMatrixVisualization members={members} />

                    {/* Member classification */}
                    <ABCMemberClassification members={members} />
                </div>
            );
        }

        /* ============================================================
           ABC MODE: STEP 6 - ABC Review & Submit
           ============================================================ */

        function ABCReviewStep({ abcData, onExportPDF, onSubmit, submitStatus, submitMessage }) {
            const members = abcData.members || [];

            return (
                <div className="animate-in" id="canvas-content">
                    <div className="step-indicator">
                        <span>ABC Matrix -- Step 2 of 2</span>
                        <span className="step-time">~5 min</span>
                    </div>
                    <h2 className="step-heading">Review & Submit</h2>
                    <p className="step-hint">Review your ABC talent matrix assessment before submitting.</p>

                    {/* ABC Summary list */}
                    <div className="ft-section">
                        <div className="ft-label" style={{ marginBottom: 12 }}>ABC Matrix Summary</div>
                        {members.map(member => {
                            const cat = getCategory(member);
                            return (
                                <div key={member.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 16px', borderBottom: '1px solid #E5E7EB' }}>
                                    <span style={{ fontSize: 14 }}>{member.name}</span>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                                        <span style={{ fontSize: 12, color: '#6B7280' }}>V:{member.valuesFit}% P:{member.performance}%</span>
                                        <span style={{ fontWeight: 700, color: getCategoryColor(cat) }}>{cat}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Visual Matrix */}
                    <ABCMatrixVisualization members={members} />

                    {/* Member classification */}
                    <ABCMemberClassification members={members} />

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: 16, justifyContent: 'center', flexWrap: 'wrap', marginBottom: 24 }}>
                        <button onClick={onExportPDF} className="btn-secondary" style={{ display: 'inline-flex', alignItems: 'center', gap: 8 }}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            Export PDF
                        </button>
                        <button onClick={onSubmit} className="btn-primary" disabled={submitStatus === 'success'}>
                            {submitStatus === 'success' ? 'Submitted' : 'Submit ABC Assessment'}
                        </button>
                    </div>

                    {submitMessage && (
                        <div style={{ textAlign: 'center', padding: 12, background: submitStatus === 'success' ? '#D1FAE5' : '#FEE2E2', fontSize: 14, marginBottom: 16 }}>
                            {submitMessage}
                        </div>
                    )}

                    <CaseStudy />
                </div>
            );
        }

        /* ============================================================
           TEAM MODE: STEP 7 - Team FIT Summary (compile scores during meeting)
           ============================================================ */

        function TeamFITSummaryStep({ teamData, setTeamData, myCeoScores }) {
            const [newMemberName, setNewMemberName] = useState('');

            const addMember = () => {
                const name = newMemberName.trim();
                if (!name) return;
                const newMember = {
                    id: Date.now().toString(),
                    name: name,
                    valuesFit: 0,
                    jobFit: 0,
                    teamFit: 0,
                    bossFit: 0,
                    performance: 0
                };
                setTeamData(prev => ({
                    ...prev,
                    teamMembers: [...prev.teamMembers, newMember]
                }));
                setNewMemberName('');
            };

            const removeMember = (id) => {
                setTeamData(prev => ({
                    ...prev,
                    teamMembers: prev.teamMembers.filter(m => m.id !== id)
                }));
            };

            const updateMemberField = (memberId, field, value) => {
                const num = parseInt(value);
                const val = isNaN(num) ? 0 : Math.min(100, Math.max(0, num));
                setTeamData(prev => ({
                    ...prev,
                    teamMembers: prev.teamMembers.map(m =>
                        m.id === memberId ? { ...m, [field]: val } : m
                    )
                }));
            };

            const members = teamData.teamMembers;
            const calcDimAvg = (field) => {
                if (members.length === 0) return 0;
                const sum = members.reduce((acc, m) => acc + (m[field] || 0), 0);
                return Math.round(sum / members.length);
            };

            const dimAverages = {
                values: calcDimAvg('valuesFit'),
                job: calcDimAvg('jobFit'),
                team: calcDimAvg('teamFit'),
                boss: calcDimAvg('bossFit')
            };
            const totalFit = Math.round((dimAverages.values + dimAverages.job + dimAverages.team + dimAverages.boss) / 4);
            const getFitColor = (v) => v < 60 ? '#DC2626' : v <= 90 ? '#D97706' : '#059669';

            return (
                <div className="animate-in">
                    <div className="step-indicator">
                        <span>Team Meeting -- Step 1 of 2</span>
                        <span className="step-time">~15 min</span>
                    </div>
                    <h2 className="step-heading">Team FIT Summary</h2>
                    <p className="step-hint">Compile each team member's FIT scores from their individual assessments.</p>



                    {/* CEO's own scores if available */}
                    {myCeoScores && (
                        <div style={{ background: '#F0FDF4', border: '1px solid #D1FAE5', padding: 16, marginBottom: 24 }}>
                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#065F46', marginBottom: 12 }}>
                                Your Scores (auto-populated from individual phase)
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 14 }}>
                                    <span>Values:</span><strong>{myCeoScores.values}%</strong>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 14 }}>
                                    <span>Job:</span><strong>{myCeoScores.job}%</strong>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 14 }}>
                                    <span>Team:</span><strong>{myCeoScores.team}%</strong>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: 14 }}>
                                    <span>Boss:</span><strong>{myCeoScores.boss}%</strong>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add member */}
                    <div className="ft-field-group">
                        <label className="ft-label">Add Team Member</label>
                        <div style={{ display: 'flex', gap: 8 }}>
                            <input
                                type="text"
                                value={newMemberName}
                                onChange={(e) => setNewMemberName(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && addMember()}
                                placeholder="Member name"
                                className="ft-input"
                            />
                            <button onClick={addMember} className="btn-next" style={{ whiteSpace: 'nowrap', minWidth: 100 }}>
                                Add
                            </button>
                        </div>
                    </div>

                    {/* Member cards with 4 FIT fields */}
                    {members.length > 0 && (
                        <div>
                            <div className="ft-label" style={{ marginBottom: 16 }}>
                                Team Members ({members.length})
                            </div>
                            {members.map(member => {
                                const memberAvg = Math.round((member.valuesFit + member.jobFit + member.teamFit + member.bossFit) / 4);
                                return (
                                    <div key={member.id} style={{ border: '1px solid #E5E7EB', padding: 16, marginBottom: 12 }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                                            <span style={{ fontWeight: 600, fontSize: 15 }}>{member.name}</span>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                                <span style={{ fontSize: 13, color: '#6B7280' }}>Avg: <strong style={{ color: getFitColor(memberAvg) }}>{memberAvg}%</strong></span>
                                                <button onClick={() => removeMember(member.id)} style={{ background: 'none', border: 'none', color: '#DC2626', cursor: 'pointer', fontSize: 13 }}>Remove</button>
                                            </div>
                                        </div>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                                            {[
                                                { field: 'valuesFit', label: 'Values FIT (%)' },
                                                { field: 'jobFit', label: 'Job FIT (%)' },
                                                { field: 'teamFit', label: 'Team FIT (%)' },
                                                { field: 'bossFit', label: 'Boss FIT (%)' }
                                            ].map(item => (
                                                <div key={item.field} style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                                    <label style={{ flex: 1, fontSize: 13 }}>{item.label}</label>
                                                    <input
                                                        type="number"
                                                        min="0"
                                                        max="100"
                                                        value={member[item.field] || ''}
                                                        onChange={(e) => updateMemberField(member.id, item.field, e.target.value)}
                                                        className="ft-input"
                                                        style={{ width: 70 }}
                                                        placeholder="0-100"
                                                    />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Summary table */}
                    {members.length > 0 && (
                        <div className="ft-section" style={{ marginTop: 24 }}>
                            <div className="ft-label" style={{ marginBottom: 12 }}>Team FIT Summary</div>
                            <div style={{ border: '1px solid #E5E7EB', overflow: 'hidden' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead style={{ background: '#F9FAFB' }}>
                                        <tr>
                                            <th style={{ padding: '8px 16px', textAlign: 'left', fontSize: 13, fontWeight: 600 }}>Dimension</th>
                                            <th style={{ padding: '8px 16px', textAlign: 'center', fontSize: 13, fontWeight: 600 }}>Team Average</th>
                                            <th style={{ padding: '8px 16px', textAlign: 'center', fontSize: 13, fontWeight: 600 }}>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {[
                                            { label: 'Values', val: dimAverages.values },
                                            { label: 'Job', val: dimAverages.job },
                                            { label: 'Team', val: dimAverages.team },
                                            { label: 'Boss', val: dimAverages.boss }
                                        ].map(row => (
                                            <tr key={row.label} style={{ borderTop: '1px solid #E5E7EB' }}>
                                                <td style={{ padding: '8px 16px', fontSize: 14 }}>{row.label}</td>
                                                <td style={{ padding: '8px 16px', textAlign: 'center', fontWeight: 600, color: getFitColor(row.val) }}>{row.val}%</td>
                                                <td style={{ padding: '8px 16px', textAlign: 'center' }}>
                                                    <span className={`badge ${row.val < 60 ? 'badge-red' : row.val <= 90 ? 'badge-yellow' : 'badge-green'}`}>
                                                        {row.val < 60 ? 'Needs attention' : row.val <= 90 ? 'Moderate' : 'Strong'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                        <tr style={{ borderTop: '2px solid #000', background: '#F9FAFB' }}>
                                            <td style={{ padding: '10px 16px', fontSize: 14, fontWeight: 700 }}>Total FIT</td>
                                            <td style={{ padding: '10px 16px', textAlign: 'center', fontWeight: 700, fontSize: 18, color: getFitColor(totalFit) }}>{totalFit}%</td>
                                            <td style={{ padding: '10px 16px', textAlign: 'center' }}>
                                                <span className={`badge ${totalFit < 60 ? 'badge-red' : totalFit <= 90 ? 'badge-yellow' : 'badge-green'}`}>
                                                    {totalFit < 60 ? 'Low alignment' : totalFit <= 90 ? 'Moderate alignment' : 'Strong alignment'}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        /* ============================================================
           TEAM MODE: STEP 8 - Team Meeting & Review
           ============================================================ */

        const MEETING_AGENDA = [
            {
                num: 1,
                title: 'Do Better Than Last Time',
                duration: '10 min',
                description: "Reflect on the previous sprint's outcomes. What was the most significant learning?",
                keyQuestion: null,
                pitfall: 'Focusing too much on negatives without identifying actionable steps.'
            },
            {
                num: 2,
                title: 'Sharing FIT and ABC Insights',
                duration: '25 min',
                description: 'Each team member shares their FIT and ABC results with key insights about alignment.',
                keyQuestion: 'How does your result influence not only your role but your contribution to team success?',
                pitfall: 'Focusing too much on individual challenges, neglecting broader team context.'
            },
            {
                num: 3,
                title: 'Discussion on Team Dynamics and Fit',
                duration: '25 min',
                description: 'Structured discussion on overall team fit. Address common themes and explore strategies.',
                keyQuestion: 'What specific changes could lead to immediate improvements in performance and collaboration?',
                pitfall: 'Conversation staying surface-level, missing deeper underlying issues.'
            },
            {
                num: 4,
                title: 'Decision Making on Next Steps',
                duration: '20 min',
                description: 'Decide on actions to enhance team fit and assign responsibilities.',
                keyQuestion: 'Who takes ownership, and how do we ensure decisions lead to tangible outcomes?',
                pitfall: 'Decisions without clear accountability, leading to inaction.'
            },
            {
                num: 5,
                title: 'Reflection Time',
                duration: '10 min',
                description: 'Conclude with reflection on meeting outcomes. Address remaining questions.',
                keyQuestion: 'What is the one takeaway that will have the most significant impact moving forward?',
                pitfall: 'Reflection lacking depth, leaving unresolved issues on the table.'
            }
        ];

        function TeamMeetingStep({ teamData, meetingNotes, setMeetingNotes, onExportPDF, onSubmit, submitStatus, submitMessage }) {
            const members = teamData.teamMembers;
            const calcDimAvg = (field) => {
                if (members.length === 0) return 0;
                const sum = members.reduce((acc, m) => acc + (m[field] || 0), 0);
                return Math.round(sum / members.length);
            };
            const dimAverages = {
                values: calcDimAvg('valuesFit'),
                job: calcDimAvg('jobFit'),
                team: calcDimAvg('teamFit'),
                boss: calcDimAvg('bossFit')
            };
            const totalFit = Math.round((dimAverages.values + dimAverages.job + dimAverages.team + dimAverages.boss) / 4);
            const getFitColor = (v) => v < 60 ? '#DC2626' : v <= 90 ? '#D97706' : '#059669';

            return (
                <div className="animate-in" id="canvas-content">
                    <div className="step-indicator">
                        <span>Team Meeting -- Step 2 of 2</span>
                        <span className="step-time">~90 min</span>
                    </div>
                    <h2 className="step-heading">Team Meeting & Review</h2>
                    <p className="step-hint">Follow the meeting agenda, capture notes and action items, then submit.</p>

                    {/* Quick FIT Overview */}
                    {members.length > 0 && (
                        <div className="ft-section">
                            <div className="ft-label" style={{ marginBottom: 12 }}>Team FIT Overview</div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr 1fr', gap: 8, marginBottom: 16 }}>
                                {[
                                    { label: 'Values', val: dimAverages.values },
                                    { label: 'Job', val: dimAverages.job },
                                    { label: 'Team', val: dimAverages.team },
                                    { label: 'Boss', val: dimAverages.boss },
                                    { label: 'Total', val: totalFit }
                                ].map(item => (
                                    <div key={item.label} style={{ textAlign: 'center', border: '1px solid #E5E7EB', padding: '8px 4px' }}>
                                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, textTransform: 'uppercase', color: '#6B7280', marginBottom: 4 }}>{item.label}</div>
                                        <div style={{ fontWeight: 700, fontSize: 18, color: getFitColor(item.val) }}>{item.val}%</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Meeting Agenda */}
                    <div className="ft-section">
                        <div className="ft-label" style={{ marginBottom: 16 }}>Meeting Agenda -- 90 Minutes</div>
                        {MEETING_AGENDA.map(segment => (
                            <div key={segment.num} style={{ border: '1px solid #E5E7EB', padding: 20, marginBottom: 12 }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                        <span style={{ background: '#000', color: '#fff', width: 28, height: 28, borderRadius: '50%', display: 'inline-flex', alignItems: 'center', justifyContent: 'center', fontSize: 13, fontWeight: 600 }}>
                                            {segment.num}
                                        </span>
                                        <span style={{ fontWeight: 600, fontSize: 15 }}>{segment.title}</span>
                                    </div>
                                    <span className="badge badge-yellow" style={{ fontFamily: "'Monument', monospace", fontSize: 11 }}>{segment.duration}</span>
                                </div>
                                <p style={{ fontSize: 14, color: '#374151', lineHeight: 1.6, marginBottom: 8 }}>{segment.description}</p>
                                {segment.keyQuestion && (
                                    <div style={{ background: '#F0FDF4', border: '1px solid #D1FAE5', padding: '8px 12px', marginBottom: 8, fontSize: 13 }}>
                                        <strong style={{ color: '#065F46' }}>Key Q:</strong> <span style={{ color: '#374151' }}>{segment.keyQuestion}</span>
                                    </div>
                                )}
                                <div style={{ background: '#FEF3C7', border: '1px solid #FDE68A', padding: '8px 12px', fontSize: 13 }}>
                                    <strong style={{ color: '#92400E' }}>Pitfall:</strong> <span style={{ color: '#78350F' }}>{segment.pitfall}</span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Meeting Notes */}
                    <div className="ft-section">
                        <div className="ft-field-group">
                            <label className="ft-label">Meeting Notes & Action Items</label>
                            <p className="ft-help" style={{ marginBottom: 8, marginTop: 0 }}>Capture key decisions, action items, and owners from the meeting.</p>
                            <textarea
                                className="ft-textarea"
                                value={meetingNotes}
                                onChange={(e) => setMeetingNotes(e.target.value)}
                                placeholder="Write your meeting notes, action items, and next steps here..."
                                style={{ minHeight: 180 }}
                            />
                        </div>
                    </div>

                    {/* Actions */}
                    <div style={{ display: 'flex', gap: 16, justifyContent: 'center', flexWrap: 'wrap', marginBottom: 24 }}>
                        <button onClick={onExportPDF} className="btn-secondary" style={{ display: 'inline-flex', alignItems: 'center', gap: 8 }}>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                            Export PDF
                        </button>
                        <button onClick={onSubmit} className="btn-primary" disabled={submitStatus === 'success'}>
                            {submitStatus === 'success' ? 'Submitted' : 'Submit Team Meeting'}
                        </button>
                    </div>

                    {submitMessage && (
                        <div style={{ textAlign: 'center', padding: 12, background: submitStatus === 'success' ? '#D1FAE5' : '#FEE2E2', fontSize: 14, marginBottom: 16 }}>
                            {submitMessage}
                        </div>
                    )}

                    <CaseStudy />
                </div>
            );
        }

        /* ============================================================
           MAIN APP
           ============================================================ */

        function App() {
            const [step, setStep] = useState(0);
            const [mode, setMode] = useState(null); // 'individual' | 'abc' | 'team'
            const [deps, setDeps] = useState([]);
            const [aiReviewing, setAiReviewing] = useState(false);
            const [aiMessage, setAiMessage] = useState('');
            const [submitStatus, setSubmitStatus] = useState(null);
            const [submitMessage, setSubmitMessage] = useState('');
            const [individualSubmitted, setIndividualSubmitted] = useState(false);
            const [teamToolUnlocked, setTeamToolUnlocked] = useState(true); // always unlocked
            const [checkingTeamUnlock, setCheckingTeamUnlock] = useState(false);
            const [meetingNotes, setMeetingNotes] = useState('');

            // Individual phase data
            const [fitData, setFitData] = useState({
                values: { you: ['', '', ''], them: ['', '', ''], fit: 50 },
                job: { you: ['', '', ''], them: ['', '', ''], fit: 50 },
                team: { you: ['', '', ''], them: ['', '', ''], fit: 50 },
                boss: { you: ['', '', ''], them: ['', '', ''], fit: 50 }
            });

            // ABC Matrix data (CEO pre-meeting)
            const [abcData, setAbcData] = useState({
                members: []
            });

            // Team meeting data (CEO, compiled scores)
            const [teamData, setTeamData] = useState({
                teamMembers: []
            });

            // Load saved data from localStorage
            useEffect(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const data = JSON.parse(saved);

                        // Migration: clear old format data
                        if (data.individual || data.toolType || data.data) {
                            console.warn('[FIT] Clearing old format data from localStorage');
                            localStorage.removeItem(STORAGE_KEY);
                            return;
                        }

                        if (data.fitData) setFitData(data.fitData);
                        if (data.abcData) setAbcData(data.abcData);
                        if (data.teamData) setTeamData(data.teamData);
                        if (data.meetingNotes) setMeetingNotes(data.meetingNotes);
                        // Don't restore step/mode  always start from cover page
                    }
                } catch (e) {
                    console.warn('[FIT] Failed to load saved data:', e);
                }
            }, []);

            // Autosave to localStorage
            useEffect(() => {
                const timer = setTimeout(() => {
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify({
                            fitData,
                            abcData,
                            teamData,
                            meetingNotes,
                            step,
                            mode
                        }));
                    } catch (e) {
                        console.warn('[FIT] Failed to save:', e);
                    }
                }, CONFIG.AUTOSAVE_DELAY);
                return () => clearTimeout(timer);
            }, [fitData, abcData, teamData, meetingNotes, step, mode]);

            // Load dependencies
            useEffect(() => {
                const loadDeps = async () => {
                    try {
                        const userId = localStorage.getItem('ft_user_id');
                        if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[FIT] Failed to load dependencies:', err);
                    }
                };
                loadDeps();
            }, []);

            // Check if team tool should be unlocked
            const checkTeamUnlock = async () => {
                setCheckingTeamUnlock(true);
                try {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) { setCheckingTeamUnlock(false); return; }

                    const { data: userData } = await supabaseClient
                        .from('users')
                        .select('organization_id')
                        .eq('id', userId)
                        .single();

                    if (!userData?.organization_id) {
                        console.warn('[FIT] No organization found -- team tool stays locked');
                        setCheckingTeamUnlock(false);
                        return;
                    }

                    // Count org members
                    const { data: orgMembers } = await supabaseClient
                        .from('users')
                        .select('id')
                        .eq('organization_id', userData.organization_id);

                    if (!orgMembers || orgMembers.length === 0) {
                        setCheckingTeamUnlock(false);
                        return;
                    }

                    // Count who submitted fit-individual
                    const memberIds = orgMembers.map(m => m.id);
                    const { data: submissions } = await supabaseClient
                        .from('user_responses')
                        .select('user_id')
                        .eq('tool_slug', 'fit-individual')
                        .in('user_id', memberIds);

                    const submittedCount = submissions ? new Set(submissions.map(s => s.user_id)).size : 0;
                    const allSubmitted = submittedCount >= orgMembers.length;

                    setTeamToolUnlocked(allSubmitted);
                } catch (e) {
                    console.warn('[FIT] Team unlock check failed:', e);
                } finally {
                    setCheckingTeamUnlock(false);
                }
            };

            // Check team unlock on intro page
            useEffect(() => {
                if (step === 0.5) {
                    checkTeamUnlock();
                }
            }, [step]);

            // AI-gated step navigation
            const handleStepNext = async (nextStepValue, stepAnswers, stepName) => {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) {
                    setStep(nextStepValue);
                    return;
                }
                if (window.AIChallenge) {
                    setAiReviewing(true);
                    try {
                        const canGo = await window.AIChallenge.reviewStep(userId, 'fit', stepAnswers, stepName);
                        if (!canGo) {
                            setAiMessage(window.AIChallenge?.getLastFeedback?.()?.suggestion || 'Please expand your answer before continuing.');
                            return;
                        }
                        setAiMessage('');
                    } catch (err) {
                        console.warn('AI review error, allowing passage:', err);
                    } finally {
                        setAiReviewing(false);
                    }
                }
                setStep(nextStepValue);
            };

            // Submit individual phase
            const submitIndividualPhase = async () => {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) {
                    setIndividualSubmitted(true);
                    return;
                }
                try {
                    const avgFit = Math.round((fitData.values.fit + fitData.job.fit + fitData.team.fit + fitData.boss.fit) / 4);
                    const questionMappings = {
                        values_fit: fitData.values,
                        job_fit: fitData.job,
                        team_fit: fitData.team,
                        boss_fit: fitData.boss,
                        average_fit: avgFit
                    };
                    await ToolDB.save(userId, questionMappings, 'fit-individual');
                    setIndividualSubmitted(true);
                } catch (err) {
                    console.error('[FIT] Failed to submit individual phase:', err);
                    setSubmitMessage('Failed to submit. Please try again.'); setSubmitStatus('success');
                }
            };

            // Submit ABC assessment
            const handleABCSubmit = async () => {
                try {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) {
                        alert('User not authenticated.');
                        return;
                    }
                    const questionMappings = {
                        abc_matrix: (abcData.members || []).map(m => ({
                            name: m.name,
                            values: m.valuesFit,
                            performance: m.performance,
                            category: getCategory(m)
                        }))
                    };

                    await window.AIChallenge.submitWithChallenge(userId, 'fit-abc', questionMappings, {
                        onReviewStart: () => { setSubmitMessage('AI coach is reviewing...'); },
                        onRevise: () => { setSubmitStatus(null); setSubmitMessage(''); },
                        onSubmitAnyway: () => { setSubmitStatus('success'); setSubmitMessage('ABC assessment submitted successfully!'); },
                        onError: (err) => { setSubmitStatus('error'); setSubmitMessage('Failed to save: ' + err.message); }
                    });
                } catch (error) {
                    console.error('[FIT] ABC submit error:', error);
                    setSubmitStatus('error');
                    setSubmitMessage('Failed to submit: ' + error.message);
                }
            };

            // Submit team meeting
            const handleTeamSubmit = async () => {
                try {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) {
                        alert('User not authenticated.');
                        return;
                    }
                    const questionMappings = {
                        team_fit_summary: teamData.teamMembers,
                        meeting_notes: meetingNotes,
                        team_averages: (() => {
                            const members = teamData.teamMembers;
                            const calcAvg = (field) => {
                                if (members.length === 0) return 0;
                                return Math.round(members.reduce((acc, m) => acc + (m[field] || 0), 0) / members.length);
                            };
                            return {
                                values: calcAvg('valuesFit'),
                                job: calcAvg('jobFit'),
                                team: calcAvg('teamFit'),
                                boss: calcAvg('bossFit')
                            };
                        })()
                    };

                    await window.AIChallenge.submitWithChallenge(userId, 'fit-team', questionMappings, {
                        onReviewStart: () => { setSubmitMessage('AI coach is reviewing...'); },
                        onRevise: () => { setSubmitStatus(null); setSubmitMessage(''); },
                        onSubmitAnyway: () => { setSubmitStatus('success'); setSubmitMessage('Team meeting submitted successfully!'); },
                        onError: (err) => { setSubmitStatus('error'); setSubmitMessage('Failed to save: ' + err.message); }
                    });
                } catch (error) {
                    console.error('[FIT] Team submit error:', error);
                    setSubmitStatus('error');
                    setSubmitMessage('Failed to submit: ' + error.message);
                }
            };

            // PDF export
            const exportPDF = async () => {
                try {
                    const element = document.getElementById('canvas-content');
                    if (!element) return;
                    const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    pdf.addImage(imgData, 'PNG', imgX, 10, imgWidth * ratio, imgHeight * ratio);
                    pdf.save('fit-assessment.pdf');
                } catch (error) {
                    console.error('PDF export error:', error);
                    alert('Failed to export PDF');
                }
            };

            // Validation for individual steps
            const canProceedIndividual = (stepNum) => {
                const dim = FIT_DIMENSIONS[stepNum - 1];
                if (!dim) return false;
                const d = fitData[dim.key];
                const allYouFilled = d.you.every(v => v.trim().length > 0);
                const allThemFilled = d.them.every(v => v.trim().length > 0);
                return allYouFilled && allThemFilled && d.fit > 0;
            };

            // Validation for ABC steps
            const canProceedABC = (stepNum) => {
                if (stepNum === 5) {
                    const members = abcData.members || [];
                    return members.length >= 1 && members.every(m => m.name && m.name.trim() && m.valuesFit > 0 && m.performance > 0);
                }
                return true;
            };

            // Validation for team steps
            const canProceedTeam = (stepNum) => {
                if (stepNum === 7) return teamData.teamMembers.length >= 1 && teamData.teamMembers.every(m => m.name.trim());
                return true;
            };

            // CEO scores for team phase
            const myCeoScores = {
                values: fitData.values.fit,
                job: fitData.job.fit,
                team: fitData.team.fit,
                boss: fitData.boss.fit
            };

            // handleRedo  resets all state and clears saved data
            const handleRedo = () => {
                const emptyData = {};
                localStorage.removeItem(STORAGE_KEY);
                setFitData({
                    values: { you: ['', '', ''], them: ['', '', ''], fit: 50 },
                    job: { you: ['', '', ''], them: ['', '', ''], fit: 50 },
                    team: { you: ['', '', ''], them: ['', '', ''], fit: 50 },
                    boss: { you: ['', '', ''], them: ['', '', ''], fit: 50 }
                });
                setAbcData({ members: [] });
                setTeamData({ teamMembers: [] });
                setMeetingNotes('');
                setMode(null);
                setStep(0);
                setSubmitStatus(null);
                setSubmitMessage('');
                setIndividualSubmitted(false);
            };
            // clearCache alias for compatibility
            const clearCache = handleRedo;

            // Get next step label for individual
            const getIndividualNextLabel = () => {
                if (step === 1) return 'Job Fit';
                if (step === 2) return 'Team Dynamics';
                if (step === 3) return 'Leadership Fit';
                if (step === 4) return 'View Summary';
                return 'Next';
            };

            // Render
            return (
                <>
                    {/* ===== STEP 0: COVER SCREEN ===== */}
                    {step === 0 && (
                        <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                            <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url("https://images.unsplash.com/photo-1551836022-d5d88e9218df?w=1920&q=80")', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.3 }} />
                            <div style={{ textAlign: 'center', padding: '0 32px', position: 'relative' }} className="animate-in">
                                <h1 className="plaak" style={{ fontSize: 72, color: '#fff', marginBottom: 12, lineHeight: 1.1 }}>THE FIT</h1>
                                <p style={{ fontSize: 18, color: '#999', marginBottom: 48, maxWidth: 480, margin: '0 auto 48px' }}>
                                    Evaluate your alignment with the company, job, team, and leadership
                                </p>
                                <button
                                    onClick={() => setStep(0.5)}
                                    style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Riforma', sans-serif", cursor: 'pointer', transition: 'all 0.2s ease', fontWeight: 600 }}
                                    onMouseOver={(e) => { e.target.style.background = '#FFF469'; }}
                                    onMouseOut={(e) => { e.target.style.background = '#fff'; }}
                                >
                                    START
                                </button>
                                <div style={{ marginTop: 24 }}>
                                    <button onClick={clearCache} style={{ background: 'none', border: 'none', color: '#555', fontSize: 12, cursor: 'pointer', fontFamily: "'Monument', monospace" }}>
                                        CLEAR SAVED DATA
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== STEP 0.5: INTRO / PATH SELECT (3 boxes) ===== */}
                    {step === 0.5 && (
                        <div style={{ minHeight: '100vh', background: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ maxWidth: 720, width: '100%', padding: '48px 32px' }} className="animate-in">
                                <div style={{ textAlign: 'center', marginBottom: 48 }}>
                                    <div className="monument" style={{ fontSize: 12, color: '#6B7280', letterSpacing: '0.1em', marginBottom: 8 }}>TOOL 05</div>
                                    <h1 className="plaak" style={{ fontSize: 42, color: '#000', marginBottom: 8 }}>THE FIT</h1>
                                    <p style={{ fontSize: 16, color: '#6B7280' }}>Choose your path below</p>
                                </div>

                                {/* Box 1: Individual Assessment (always available) */}
                                <div style={{ border: '2px solid #000', padding: 32, marginBottom: 24 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                        <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 600 }}>Individual Assessment</div>
                                        <span className="monument" style={{ fontSize: 11, color: '#6B7280' }}>~20 MIN</span>
                                    </div>
                                    <p style={{ fontSize: 15, color: '#374151', lineHeight: 1.6, marginBottom: 24 }}>
                                        Rate your alignment across 4 dimensions: values, job, team, and boss. Your honest self-assessment helps identify strengths and growth areas.
                                    </p>
                                    <button
                                        onClick={() => { setMode('individual'); setStep(1); }}
                                        className="btn-primary"
                                        style={{ width: '100%' }}
                                    >
                                        START INDIVIDUAL ASSESSMENT
                                    </button>
                                </div>

                                {/* Box 2: ABC Talent Matrix -- CEO Pre-Meeting (always available, NOT locked) */}
                                <div style={{ border: '2px solid #000', padding: 32, marginBottom: 24 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                        <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 600 }}>
                                            ABC Talent Matrix -- CEO Pre-Meeting
                                        </div>
                                        <span className="monument" style={{ fontSize: 11, color: '#6B7280' }}>~15 MIN</span>
                                    </div>
                                    <p style={{ fontSize: 15, color: '#374151', lineHeight: 1.6, marginBottom: 24 }}>
                                        Rate each team member's values alignment and performance. Complete this before the team meeting.
                                    </p>
                                    <button
                                        onClick={() => { setMode('abc'); setStep(5); }}
                                        className="btn-primary"
                                        style={{ width: '100%' }}
                                    >
                                        START ABC MATRIX
                                    </button>
                                </div>

                                {/* Box 3: Team Meeting Tool (LOCKED until all individuals submit) */}
                                <div style={{ border: '2px solid ' + (teamToolUnlocked ? '#000' : '#E5E7EB'), padding: 32, marginBottom: 32, opacity: teamToolUnlocked ? 1 : 0.7 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                            {!teamToolUnlocked && <LockIcon size={16} />}
                                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 600 }}>
                                                Team Meeting Tool (CEO Only)
                                            </div>
                                        </div>
                                        <span className="monument" style={{ fontSize: 11, color: '#6B7280' }}>~90 MIN</span>
                                    </div>
                                    {teamToolUnlocked ? (
                                        <>
                                            <p style={{ fontSize: 15, color: '#374151', lineHeight: 1.6, marginBottom: 24 }}>
                                                Compile team FIT results and facilitate the 90-minute team meeting. All team members have completed their individual assessments.
                                            </p>
                                            <button
                                                onClick={() => { setMode('team'); setStep(7); }}
                                                className="btn-primary"
                                                style={{ width: '100%' }}
                                            >
                                                START TEAM MEETING
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            <p style={{ fontSize: 15, color: '#6B7280', lineHeight: 1.6, marginBottom: 24 }}>
                                                Locked until all team members complete their individual FIT assessment. The CEO compiles team scores and facilitates the 90-minute team meeting.
                                            </p>
                                            <div
                                                onClick={(e) => {
                                                    if (e.shiftKey) {
                                                        console.log('[DEV] Force-unlocking team tool');
                                                        setTeamToolUnlocked(true);
                                                    }
                                                }}
                                                style={{ background: '#F3F4F6', padding: '12px 16px', textAlign: 'center', color: '#9CA3AF', fontFamily: "'Monument', monospace", fontSize: 12, cursor: 'default' }}
                                                title="Shift+Click to force unlock (dev only)"
                                            >
                                                {checkingTeamUnlock ? 'CHECKING...' : 'LOCKED -- WAITING FOR TEAM'}
                                            </div>
                                        </>
                                    )}
                                </div>

                                {/* Journey Overview (3 columns) */}
                                <div style={{ marginBottom: 32 }}>
                                    <div className="monument" style={{ fontSize: 11, color: '#6B7280', letterSpacing: '0.05em', marginBottom: 12, textTransform: 'uppercase' }}>Journey Overview</div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>
                                        <div>
                                            <div className="monument" style={{ fontSize: 10, color: '#000', marginBottom: 8, fontWeight: 600 }}>Phase 1: Individual</div>
                                            <div style={{ fontSize: 13, color: '#374151', lineHeight: 2 }}>
                                                01 Values<br/>02 Job<br/>03 Team<br/>04 Boss
                                            </div>
                                        </div>
                                        <div>
                                            <div className="monument" style={{ fontSize: 10, color: '#000', marginBottom: 8, fontWeight: 600 }}>Phase 2: ABC Matrix</div>
                                            <div style={{ fontSize: 13, color: '#374151', lineHeight: 2 }}>
                                                05 ABC Matrix
                                            </div>
                                        </div>
                                        <div style={{ opacity: teamToolUnlocked ? 1 : 0.4 }}>
                                            <div className="monument" style={{ fontSize: 10, color: '#6B7280', marginBottom: 8, fontWeight: 600 }}>Phase 3: Team Meeting</div>
                                            <div style={{ fontSize: 13, color: '#6B7280', lineHeight: 2 }}>
                                                06 Team Summary<br/>07 Meeting Agenda
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style={{ textAlign: 'center' }}>
                                    <button onClick={() => setStep(0)} style={{ background: 'none', border: '2px solid #E5E7EB', color: '#6B7280', padding: '10px 24px', fontSize: 14, cursor: 'pointer', fontFamily: "'Riforma', sans-serif" }}>
                                        &larr; Back to Cover
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== TRANSITION SCREENS (between individual steps) ===== */}
                    {[1.5, 2.5, 3.5].includes(step) && (() => {
                        const completedStep = Math.floor(step);
                        const nextStep = completedStep + 1;
                        const t = TRANSITION_CONTENT[completedStep];
                        if (!t) { setStep(nextStep); return null; }
                        return (
                            <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                    <div className="monument" style={{ fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>
                                        STEP {completedStep} OF 4 COMPLETE
                                    </div>
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 12 }}>{t.title}</h1>
                                    <p style={{ fontSize: 16, color: '#ccc', marginBottom: 48 }}>{t.text}</p>

                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>{t.brutalTruth}</p>
                                    </div>
                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                                    </div>

                                    <button
                                        onClick={() => setStep(nextStep)}
                                        style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Riforma', sans-serif", cursor: 'pointer', transition: 'all 0.2s ease', fontWeight: 600 }}
                                        onMouseOver={(e) => { e.target.style.background = '#FFF469'; }}
                                        onMouseOut={(e) => { e.target.style.background = '#fff'; }}
                                    >
                                        CONTINUE TO STEP {nextStep}
                                    </button>
                                </div>
                            </div>
                        );
                    })()}

                    {/* ===== STEP 4.5: INDIVIDUAL PHASE GATE ===== */}
                    {step === 4.5 && (() => {
                        const t = TRANSITION_CONTENT[4];
                        const avgFit = Math.round((fitData.values.fit + fitData.job.fit + fitData.team.fit + fitData.boss.fit) / 4);
                        const fitColor = avgFit < 60 ? '#DC2626' : avgFit <= 90 ? '#D97706' : '#059669';
                        return (
                            <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                    {/* Checkmark */}
                                    <div style={{ width: 64, height: 64, borderRadius: '50%', background: '#FFF469', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 24px' }}>
                                        <CheckIcon color="#000" size={32} />
                                    </div>

                                    <h1 className="plaak" style={{ fontSize: 42, color: '#FFF469', marginBottom: 16 }}>INDIVIDUAL PHASE COMPLETE</h1>

                                    {/* Show average FIT */}
                                    <div style={{ marginBottom: 32 }}>
                                        <div className="monument" style={{ fontSize: 11, color: '#999', marginBottom: 8 }}>YOUR TOTAL FIT SCORE</div>
                                        <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 64, fontWeight: 'bold', color: fitColor }}>{avgFit}%</span>
                                    </div>

                                    {/* Quick dimension breakdown */}
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 32, maxWidth: 360, margin: '0 auto 32px' }}>
                                        {FIT_DIMENSIONS.map(dim => {
                                            const val = fitData[dim.key].fit;
                                            const c = val < 60 ? '#DC2626' : val <= 90 ? '#D97706' : '#059669';
                                            return (
                                                <div key={dim.key} style={{ background: '#111', border: '1px solid #333', padding: '12px 16px', textAlign: 'center' }}>
                                                    <div className="monument" style={{ fontSize: 10, color: '#999', marginBottom: 4 }}>{dim.stepTitle}</div>
                                                    <div style={{ fontSize: 24, fontWeight: 'bold', color: c }}>{val}%</div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* Brutal truth / peer proof */}
                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>{t.brutalTruth}</p>
                                    </div>
                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                                    </div>

                                    {!individualSubmitted ? (
                                        <>
                                            <p style={{ fontSize: 16, color: '#ccc', marginBottom: 24 }}>Submit your FIT scores to your CEO.</p>
                                            <button
                                                onClick={submitIndividualPhase}
                                                style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Riforma', sans-serif", cursor: 'pointer', transition: 'all 0.2s ease', fontWeight: 600 }}
                                                onMouseOver={(e) => { e.target.style.background = '#FFF469'; }}
                                                onMouseOut={(e) => { e.target.style.background = '#fff'; }}
                                            >
                                                SUBMIT MY SCORES
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            <p style={{ fontSize: 16, color: '#FFF469', marginBottom: 8 }}>Your FIT assessment has been submitted.</p>
                                            <p style={{ fontSize: 14, color: '#999', marginBottom: 32 }}>You can close this page or review your scores.</p>
                                            <div style={{ display: 'flex', gap: 16, justifyContent: 'center', flexWrap: 'wrap' }}>
                                                <button
                                                    onClick={() => setStep(1)}
                                                    style={{ background: 'none', border: '2px solid #555', color: '#999', padding: '12px 24px', fontSize: 14, cursor: 'pointer', fontFamily: "'Riforma', sans-serif" }}
                                                >
                                                    Review My Scores
                                                </button>
                                                <button
                                                    onClick={() => setStep(0.5)}
                                                    style={{ background: 'none', border: '2px solid #555', color: '#999', padding: '12px 24px', fontSize: 14, cursor: 'pointer', fontFamily: "'Riforma', sans-serif" }}
                                                >
                                                    Back to Overview
                                                </button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        );
                    })()}

                    {/* ===== STEP 5.5: ABC TRANSITION (between matrix and review) ===== */}
                    {step === 5.5 && (
                        <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                <div className="monument" style={{ fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>
                                    ABC MATRIX COMPLETE
                                </div>
                                <h1 className="plaak" style={{ fontSize: 48, marginBottom: 12 }}>MATRIX PLOTTED.</h1>
                                <p style={{ fontSize: 16, color: '#ccc', marginBottom: 48 }}>
                                    You have plotted every team member on the values-versus-performance matrix. Now review the complete picture and submit.
                                </p>

                                <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                    <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                    <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>The ABC matrix exposes the truth most leaders avoid: high performers with low values alignment are the most dangerous people on your team. They deliver results while quietly destroying culture. The hardest decision a CEO makes is letting go of a B-player who hits their numbers.</p>
                                </div>
                                <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                    <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                    <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>"We had three B-players -- high performance, low values fit. I kept avoiding the conversation because the numbers were good. After the ABC matrix made it undeniable, I had direct talks with all three. One self-corrected, one moved to a better-fit role, one left. Within six months, team engagement scores hit an all-time high." -- CEO, 50-person agency</p>
                                </div>

                                <button
                                    onClick={() => setStep(6)}
                                    style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Riforma', sans-serif", cursor: 'pointer', transition: 'all 0.2s ease', fontWeight: 600 }}
                                    onMouseOver={(e) => { e.target.style.background = '#FFF469'; }}
                                    onMouseOut={(e) => { e.target.style.background = '#fff'; }}
                                >
                                    REVIEW & SUBMIT
                                </button>
                            </div>
                        </div>
                    )}

                    {/* ===== STEP 7.5: TEAM TRANSITION (between summary and meeting) ===== */}
                    {step === 7.5 && (
                        <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                <div className="monument" style={{ fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>
                                    TEAM SCORES COMPILED
                                </div>
                                <h1 className="plaak" style={{ fontSize: 48, marginBottom: 12 }}>SCORES READY.</h1>
                                <p style={{ fontSize: 16, color: '#ccc', marginBottom: 48 }}>
                                    All team FIT scores have been compiled. Now facilitate the 90-minute team meeting using the structured agenda.
                                </p>

                                <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                    <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                    <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>The team meeting is where data becomes action. Without a structured conversation, FIT scores become interesting numbers that change nothing. The 90 minutes you invest here determine whether this exercise transforms your team or becomes another forgotten assessment.</p>
                                </div>
                                <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                    <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                    <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>"We almost skipped the team meeting because everyone was busy. But the structured agenda forced conversations we had been avoiding for months. Three role adjustments came out of that single 90-minute session, and team productivity jumped 20% in the following quarter." -- CEO, 30-person consulting firm</p>
                                </div>

                                <button
                                    onClick={() => setStep(8)}
                                    style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Riforma', sans-serif", cursor: 'pointer', transition: 'all 0.2s ease', fontWeight: 600 }}
                                    onMouseOver={(e) => { e.target.style.background = '#FFF469'; }}
                                    onMouseOut={(e) => { e.target.style.background = '#fff'; }}
                                >
                                    START TEAM MEETING
                                </button>
                            </div>
                        </div>
                    )}

                    {/* ===== WIZARD LAYOUT: INDIVIDUAL STEPS 1-4 ===== */}
                    {mode === 'individual' && Number.isInteger(step) && step >= 1 && step <= 4 && (
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={step} totalSteps={4} />
                                <div className="wizard-content">
                                    {step === 1 && <DependencyContext deps={deps} />}
                                    <FitDimensionStep
                                        dimension={FIT_DIMENSIONS[step - 1]}
                                        stepNum={step}
                                        fitData={fitData}
                                        setFitData={setFitData}
                                    />
                                </div>
                                <ButtonFooter
                                    onBack={() => step === 1 ? setStep(0.5) : setStep(step - 1)}
                                    onNext={() => {
                                        const dim = FIT_DIMENSIONS[step - 1];
                                        const answers = {};
                                        answers[dim.key + '_fit'] = fitData[dim.key];
                                        if (step < 4) {
                                            handleStepNext(step + 0.5, answers, dim.title);
                                        } else {
                                            handleStepNext(4.5, answers, dim.title);
                                        }
                                    }}
                                    nextLabel={aiReviewing ? 'Reviewing...' : getIndividualNextLabel()}
                                    showBack={true}
                                    disabled={!canProceedIndividual(step) || aiReviewing}
                                />
                                {aiMessage && <div style={{color:'#dc2626',fontSize:'13px',marginTop:'8px',padding:'8px 12px',background:'#fef2f2',borderRadius:'6px',margin:'8px 24px 0'}}>{aiMessage}</div>}
                            </div>
                            <WizardSidebar
                                currentStep={step}
                                mode="individual"
                                fitData={fitData}
                                teamData={teamData}
                                abcData={abcData}
                                onNavigate={(s) => setStep(s)}
                            />
                        </div>
                    )}

                    {/* ===== WIZARD LAYOUT: ABC STEPS 5-6 ===== */}
                    {mode === 'abc' && Number.isInteger(step) && step >= 5 && step <= 6 && (
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={step - 4} totalSteps={2} />
                                <div className="wizard-content">
                                    {step === 5 && (
                                        <ABCMatrixStep
                                            abcData={abcData}
                                            setAbcData={setAbcData}
                                        />
                                    )}
                                    {step === 6 && (
                                        <ABCReviewStep
                                            abcData={abcData}
                                            onExportPDF={exportPDF}
                                            onSubmit={handleABCSubmit}
                                            submitStatus={submitStatus}
                                            submitMessage={submitMessage}
                                        />
                                    )}
                                </div>
                                <ButtonFooter
                                    onBack={() => {
                                        if (step === 5) setStep(0.5);
                                        else setStep(5);
                                    }}
                                    onNext={() => {
                                        if (step === 5) {
                                            setStep(5.5);
                                        } else if (step === 6) {
                                            handleABCSubmit();
                                        }
                                    }}
                                    nextLabel={aiReviewing ? 'Reviewing...' : (step === 5 ? 'Review' : 'Submit ABC')}
                                    showBack={true}
                                    disabled={
                                        (step === 5 && !canProceedABC(5)) ||
                                        aiReviewing
                                    }
                                />
                                {aiMessage && <div style={{color:'#dc2626',fontSize:'13px',marginTop:'8px',padding:'8px 12px',background:'#fef2f2',borderRadius:'6px',margin:'8px 24px 0'}}>{aiMessage}</div>}
                            </div>
                            <WizardSidebar
                                currentStep={step}
                                mode="abc"
                                fitData={fitData}
                                teamData={teamData}
                                abcData={abcData}
                                onNavigate={(s) => setStep(s)}
                            />
                        </div>
                    )}

                    {/* ===== WIZARD LAYOUT: TEAM STEPS 7-8 ===== */}
                    {mode === 'team' && Number.isInteger(step) && step >= 7 && step <= 8 && (
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={step - 6} totalSteps={2} />
                                <div className="wizard-content">
                                    {step === 7 && (
                                        <TeamFITSummaryStep
                                            teamData={teamData}
                                            setTeamData={setTeamData}
                                            myCeoScores={fitData.values.you.some(v => v.trim()) ? myCeoScores : null}
                                        />
                                    )}
                                    {step === 8 && (
                                        <TeamMeetingStep
                                            teamData={teamData}
                                            meetingNotes={meetingNotes}
                                            setMeetingNotes={setMeetingNotes}
                                            onExportPDF={exportPDF}
                                            onSubmit={handleTeamSubmit}
                                            submitStatus={submitStatus}
                                            submitMessage={submitMessage}
                                        />
                                    )}
                                </div>
                                <ButtonFooter
                                    onBack={() => {
                                        if (step === 7) setStep(0.5);
                                        else setStep(7);
                                    }}
                                    onNext={() => {
                                        if (step === 7) {
                                            setStep(7.5);
                                        } else if (step === 8) {
                                            handleTeamSubmit();
                                        }
                                    }}
                                    nextLabel={aiReviewing ? 'Reviewing...' : (step === 7 ? 'Meeting Agenda' : 'Submit Team Meeting')}
                                    showBack={true}
                                    disabled={
                                        (step === 7 && !canProceedTeam(7)) ||
                                        aiReviewing
                                    }
                                />
                                {aiMessage && <div style={{color:'#dc2626',fontSize:'13px',marginTop:'8px',padding:'8px 12px',background:'#fef2f2',borderRadius:'6px',margin:'8px 24px 0'}}>{aiMessage}</div>}
                            </div>
                            <WizardSidebar
                                currentStep={step}
                                mode="team"
                                fitData={fitData}
                                teamData={teamData}
                                abcData={abcData}
                                onNavigate={(s) => setStep(s)}
                            />
                        </div>
                    )}
                </>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
