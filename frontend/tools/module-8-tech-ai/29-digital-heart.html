<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Heart - Data Lake | Fast Track Program</title>

  <!-- React & ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../shared/js/tool-db.js"></script>
  <script src="../../shared/js/ai-challenge.js"></script>
  <script src="../../shared/js/dependency-injection.js"></script>
  <script src="../../shared/js/transition-screen.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

  <!-- jsPDF + html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Font Face Declarations */
    @font-face {
      font-family: 'Plaak';
      src: url('Plaak3Trial-43-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
    }

    @font-face {
      font-family: 'Riforma';
      src: url('RiformaLL-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: 'Monument';
      src: url('MonumentGrotesk-Mono.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Riforma', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .plaak {
      font-family: 'Plaak', sans-serif;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: -0.02em;
    }

    .riforma-bold {
      font-family: 'Riforma', sans-serif;
      font-weight: bold;
    }

    .monument {
      font-family: 'Monument', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .transition-animate-in {
      animation: slideIn 0.6s ease-out;
    }

    /* Button Styles */
    .btn-primary {
      background: #000000;
      color: #FFFFFF;
      padding: 16px 32px;
      border: 2px solid #000000;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: normal;
    }

    .btn-primary:hover:not(:disabled) {
      transform: scale(1.02);
    }

    .btn-primary:disabled {
      background: #E0E0E0;
      border-color: #E0E0E0;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #FFFFFF;
      color: #000000;
      padding: 12px 24px;
      border: 2px solid #000000;
      font-size: 16px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #F8F8F8;
    }

    .btn-small {
      background: #FFFFFF;
      color: #000000;
      padding: 8px 16px;
      border: 1px solid #000000;
      font-size: 14px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-small:hover {
      background: #F8F8F8;
    }

    .btn-remove {
      background: #FFFFFF;
      color: #000000;
      padding: 8px 16px;
      border: 1px solid #E0E0E0;
      font-size: 14px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-remove:hover {
      border-color: #EF4444;
      color: #EF4444;
    }

    /* Form Styles */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      border: 1px solid #E0E0E0;
      padding: 12px 16px;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      width: 100%;
      transition: border-color 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #000000;
    }

    textarea {
      min-height: 120px;
      resize: none !important;
    }

    textarea::placeholder {
      white-space: pre-line;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: #E0E0E0;
      outline: none;
      border-radius: 4px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      background: #000000;
      cursor: pointer;
      border-radius: 50%;
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: #000000;
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }

    /* Numbered Section Badge */
    .numbered-section {
      background: #000000;
      color: #FFFFFF;
      padding: 10px 16px;
      font-family: 'Plaak', sans-serif;
      font-size: 26px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }

    /* Help Button */
    .help-button {
      position: fixed;
      top: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #000000;
      color: #FFFFFF;
      font-size: 28px;
      border: none;
      cursor: pointer;
      z-index: 40;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Riforma', sans-serif;
    }

    .help-button:hover {
      background: #FFF469;
      color: #000000;
      transform: scale(1.1);
    }

    /* Progress Indicator */
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #E0E0E0;
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background: #000000;
      transform: scale(1.3);
    }

    .progress-dot.completed {
      background: #000000;
    }

    .progress-line {
      height: 2px;
      background: #E0E0E0;
      flex: 1;
    }

    /* Character Counter */
    .char-counter {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }

    .char-counter.invalid {
      color: #EF4444;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 24px;
    }

    .modal-content {
      background: #FFFFFF;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 32px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #000000;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #EF4444;
    }

    /* Canvas Styles */
    .canvas-section {
      border: 2px solid #000000;
      padding: 24px;
      margin-bottom: 24px;
      background: #FFFFFF;
    }

    .canvas-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    /* Highlight Styles */
    .highlight-box {
      background: #FFF469;
      border: 2px solid #000000;
      padding: 24px;
      margin: 16px 0;
    }

    .info-box {
      background: #F8F8F8;
      border-left: 4px solid #000000;
      padding: 16px;
      margin: 16px 0;
    }

    .warning-box {
      background: #FEF2F2;
      border-left: 4px solid #EF4444;
      padding: 16px;
      margin: 16px 0;
    }

    /* Checklist Styles */
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid #E0E0E0;
    }

    .checklist-item:last-child {
      border-bottom: none;
    }

    .checkbox-custom {
      width: 20px;
      height: 20px;
      border: 2px solid #000000;
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .checkbox-custom.checked {
      background: #000000;
    }

    /* Decision Card */
    .decision-card {
      border: 2px solid #E0E0E0;
      padding: 20px;
      margin-bottom: 16px;
      background: #FFFFFF;
      transition: all 0.2s ease;
    }

    .decision-card:hover {
      border-color: #000000;
    }

    .decision-card.priority-high {
      border-color: #FFF469;
      background: #FFFEF0;
    }

    /* Priority Badge */
    .priority-badge {
      display: inline-block;
      padding: 4px 12px;
      font-size: 14px;
      font-family: 'Monument', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .priority-badge.high {
      background: #FFF469;
      color: #000000;
    }

    .priority-badge.medium {
      background: #E0E0E0;
      color: #000000;
    }

    .priority-badge.low {
      background: #F8F8F8;
      color: #666;
    }

    /* Matrix Grid */
    .matrix-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 8px;
      border: 2px solid #000000;
      padding: 16px;
      background: #FFFFFF;
    }

    .matrix-cell {
      border: 1px solid #E0E0E0;
      padding: 12px;
      min-height: 80px;
      font-size: 14px;
      background: #F8F8F8;
    }

    .matrix-cell.high-priority {
      background: #FFF469;
      font-weight: bold;
    }

    /* Data Source Tag */
    .data-tag {
      display: inline-block;
      padding: 6px 12px;
      border: 1px solid #000000;
      margin: 4px;
      font-size: 14px;
      background: #FFFFFF;
    }

    .data-tag.internal {
      background: #F0F9FF;
      border-color: #0284C7;
    }

    .data-tag.external {
      background: #FEF2F2;
      border-color: #DC2626;
    }

    /* Architecture Diagram */
    .arch-layer {
      border: 2px solid #000000;
      padding: 16px;
      margin: 12px 0;
      background: #FFFFFF;
      position: relative;
    }

    .arch-layer::before {
      content: attr(data-layer);
      position: absolute;
      top: -12px;
      left: 12px;
      background: #000000;
      color: #FFFFFF;
      padding: 4px 12px;
      font-size: 12px;
      font-family: 'Monument', monospace;
      text-transform: uppercase;
    }

    /* Timeline */
    .timeline-item {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      position: relative;
    }

    .timeline-marker {
      width: 40px;
      height: 40px;
      border: 2px solid #000000;
      background: #FFFFFF;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Monument', monospace;
      font-size: 14px;
      flex-shrink: 0;
    }

    .timeline-marker.active {
      background: #FFF469;
    }

    .timeline-content {
      flex: 1;
      padding-top: 8px;
    }

    /* Wizard Layout */
    .wizard-layout { display: flex; min-height: 100vh; }
    .wizard-main { flex: 1; overflow-y: auto; }
    .wizard-content { padding: 48px 64px; max-width: 860px; }
    .wizard-footer { display: flex; justify-content: space-between; align-items: center; padding: 24px 64px; border-top: 2px solid #e5e7eb; background: #fff; position: sticky; bottom: 0; }
    .btn-wiz-back { font-family: 'Monument', monospace; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; background: transparent; border: 2px solid #000; padding: 14px 28px; cursor: pointer; }
    .btn-wiz-back:hover { background: #f5f5f5; }
    .btn-wiz-next { font-family: 'Monument', monospace; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; background: #000; color: #fff; border: 2px solid #000; padding: 14px 28px; cursor: pointer; }
    .btn-wiz-next:hover:not(:disabled) { background: #333; }
    .btn-wiz-next:disabled { opacity: 0.4; cursor: not-allowed; }
    .wizard-sidebar { width: 280px; min-width: 280px; background: #1a1a1a; color: #fff; padding: 48px 32px; position: sticky; top: 0; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, Fragment } = React;

    const CONFIG = {
        SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
        SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
        TOOL_SLUG: 'digital-heart',
        AUTOSAVE_DELAY: 2000,
        TRANSITION_CONTENT: {
            1: {
                brutalTruth: 'AI will not replace your business — but competitors who use AI effectively will. The question is not whether to digitize — it is whether you will lead the transition or react to it when it is already too late.',
                peerProof: '"A traditional recruitment firm integrated AI screening tools. Senior recruiters spent 40% less time on CVs and 40% more time on relationships. Revenue per recruiter increased 30% in one year. The tool cost €400/month."'
            },
            2: {
                brutalTruth: 'The AI tools that deliver ROI are not the most sophisticated ones — they are the ones built around a single, clear, high-frequency task your team does today. Start there. Not with a grand digital strategy.',
                peerProof: '"A law firm used AI to draft first-pass client summaries. Partners went from writing 45 minutes per brief to reviewing 8 minutes per brief. They handled 35% more clients with the same team. The implementation took 2 weeks."'
            },
            3: {
                brutalTruth: 'Governance without experimentation is how companies fall behind. A policy that requires 3 approval layers before testing a new AI tool will ensure you are always running last year\'s technology.',
                peerProof: '"A €40M financial services firm created a \'test and learn\' budget of €5k/month for AI experiments. In 18 months, 4 experiments failed and 2 succeeded. The 2 successes saved €180k/year in manual processing. Total investment: €90k."'
            },
            4: {
                brutalTruth: 'APIs are the nervous system of the digital business. Companies that expose their data via well-designed APIs can partner, scale, and automate in weeks — not years.',
                peerProof: '"A property management firm opened their data to 3 API integrations — accounting, tenancy, maintenance. Admin time dropped 60%. Their platform became the integration hub for the entire stack."'
            }
        },
        CLOSING_MESSAGES: {
            1: { title: 'DECISIONS MAPPED', text: 'You have identified the critical decisions to digitalize. Next: map your data sources.' },
            2: { title: 'DATA SOURCES MAPPED', text: 'Every decision now has a data foundation. Next: design the technology layer.' },
            3: { title: 'TECHNOLOGY DESIGNED', text: 'Your tech stack is planned. Next: define the APIs and data access layer.' },
            4: { title: 'APIs DEFINED', text: 'Your Digital Heart architecture is complete. View the full canvas.' }
        }
    };

    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    // Make Supabase client globally available for dependency injection
    window.supabaseClient = supabaseClient;

    // Initialize dependency injection to load data from previous tools
    ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);

        // Initialize cognitive load components
        CognitiveLoad.init('digital-heart', {"insights":["Data without a strategy is just storage costs.","The Digital Heart connects all data sources into one source of truth."],"caseStudy":{"before":"A mid-size manufacturer had sales data in a CRM, production data in spreadsheets, and customer feedback in emails. Decisions took weeks because managers had to manually compile reports from five different systems. No single source of truth existed, so every leadership meeting started with arguments about whose numbers were correct.","after":"After building a unified data lake with real-time dashboards, every KPI from sales to production to customer satisfaction fed into one platform. Decision-making time dropped from weeks to hours, and the company identified a 15% cost reduction hidden in cross-departmental data that no single team could have spotted alone.","quote":"Before the data lake, we were flying blind with five different maps. Now we have one cockpit with every instrument we need. -- COO, Industrial Manufacturing Firm"}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

        function DependencyContext({ deps }) {
            const [open, setOpen] = React.useState(false);
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '16px' }}>
                    <button onClick={() => setOpen(o => !o)} style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '8px 14px', fontSize: 12, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase', cursor: 'pointer', color: '#555', width: '100%' }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#DAA520" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        CONTEXT FROM PREVIOUS TOOLS ({deps.length})
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#999" strokeWidth="2" style={{ marginLeft: 'auto', transform: open ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    {open && (
                        <div style={{ border: '1px solid #F0E68C', borderTop: 'none', padding: '12px 14px' }}>
                            {deps.map((dep, i) => (
                                <div key={i} style={{ background: '#fff', padding: '8px 0', borderBottom: i < deps.length - 1 ? '1px solid #F0E68C' : 'none', fontSize: '13px' }}>
                                    <div style={{ fontWeight: 600, marginBottom: '2px', color: '#333', fontSize: '11px', fontFamily: "'Monument', monospace", letterSpacing: '0.04em', textTransform: 'uppercase' }}>{dep.label}</div>
                                    <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

    // Transition Screen Component
    function TransitionScreen({ message, progress, stepNum }) {
      const t = stepNum && CONFIG.TRANSITION_CONTENT && CONFIG.TRANSITION_CONTENT[stepNum];
      return (
        <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999, padding: '48px 32px' }}>
          <div style={{ maxWidth: 640, width: '100%', textAlign: 'center' }} className="animate-in">
            <h1 className="plaak" style={{ fontSize: 64, marginBottom: 24, textTransform: 'uppercase', lineHeight: 1.1 }}>STEP COMPLETE</h1>
            <div style={{ marginBottom: 32 }}>
              <div style={{ height: 4, background: '#333', marginBottom: 8 }}>
                <div style={{ height: '100%', background: '#FFF469', width: progress + '%', transition: 'width 1s ease' }} />
              </div>
              <p style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#ccc', letterSpacing: '0.08em', textTransform: 'uppercase' }}>{message}</p>
            </div>
            {t && t.brutalTruth && (
              <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 20, textAlign: 'left' }}>
                <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8, letterSpacing: '0.08em', textTransform: 'uppercase' }}>BRUTAL TRUTH</span>
                <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, margin: 0 }}>{t.brutalTruth}</p>
              </div>
            )}
            {t && t.peerProof && (
              <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', textAlign: 'left' }}>
                <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#999', display: 'block', marginBottom: 8, letterSpacing: '0.08em', textTransform: 'uppercase' }}>PEER PROOF</span>
                <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic', margin: 0 }}>{t.peerProof}</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    function WizardSidebar({ currentStep, stepLabels, totalSteps }) {
      return (
        <div className="wizard-sidebar">
          <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.12em', color: '#888', textTransform: 'uppercase', marginBottom: 32 }}>
            SPRINT 29 / DIGITAL HEART
          </div>
          <div style={{ flex: 1 }}>
            {stepLabels.map((label, i) => {
              const stepNum = i + 1;
              const isDone = currentStep > stepNum;
              const isActive = Math.floor(currentStep) === stepNum;
              return (
                <div key={stepNum} style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 20 }}>
                  <div style={{
                    width: 28, height: 28, borderRadius: '50%', border: `2px solid ${isDone ? '#FFF469' : isActive ? '#fff' : '#444'}`,
                    display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0,
                    background: isDone ? '#FFF469' : 'transparent', color: isDone ? '#000' : isActive ? '#fff' : '#444',
                    fontSize: 13, fontWeight: 'bold'
                  }}>
                    {isDone ? '✓' : stepNum}
                  </div>
                  <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.06em', textTransform: 'uppercase', color: isDone ? '#FFF469' : isActive ? '#fff' : '#555' }}>
                    {label}
                  </span>
                </div>
              );
            })}
          </div>
          <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#444', letterSpacing: '0.06em' }}>
            STEP {Math.floor(currentStep)} OF {totalSteps}
          </div>
        </div>
      );
    }

    // Main App Component
    function DigitalHeartApp() {
            const [deps, setDeps] = useState([]);
      const [step, setStep] = useState(0);
      const [aiReviewing, setAiReviewing] = useState(false);
      const [aiMessage, setAiMessage] = useState('');

      const [data, setData] = useState({
        decisions: [
          {
            id: 1,
            decisionName: '',
            frequency: '',
            impactLevel: '',
            currentProcess: '',
            dataNeededDescription: '',
            priority: 5
          }
        ],
        dataSources: [],
        technology: [],
        apis: [],
        implementation: {
          phase1Timeline: '',
          phase1Actions: '',
          quickWins: '',
          resourcesNeeded: '',
          estimatedCost: '',
          successMetrics: ''
        }
      });

            useEffect(() => {
                async function loadDeps() {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                    try {
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[' + CONFIG.TOOL_SLUG + '] Failed to load dependencies:', err);
                    }
                }
                loadDeps();
            }, []);

      // Load from localStorage
      useEffect(() => {
        const saved = localStorage.getItem('digital-heart-data');
        if (saved) {
          try {
            setData(JSON.parse(saved));
          } catch (e) {
            console.error('Failed to parse saved data');
          }
        }
      }, []);

      // Auto-save every 2 seconds
      useEffect(() => {
        const interval = setInterval(() => {
          localStorage.setItem('digital-heart-data', JSON.stringify(data));
        }, 2000);
        return () => clearInterval(interval);
      }, [data]);

      // Validation
      const canProceed = () => {
        if (step === 0 || step === 0.5) return true;

        if (step === 1) {
          const decisions = data.decisions || [];
          if (decisions.length < 3) return false;
          return decisions.every(d =>
            (d.decisionName || '').length >= 50 &&
            d.frequency &&
            d.impactLevel &&
            (d.currentProcess || '').length >= 100 &&
            (d.dataNeededDescription || '').length >= 100 &&
            d.priority >= 1 && d.priority <= 10
          );
        }

        if (step === 2) {
          const sources = data.dataSources || [];
          const decisions = data.decisions || [];
          if (sources.length < decisions.length) return false;
          return sources.every(s =>
            (s.internalSources || []).length >= 2 &&
            (s.externalSources || []).length >= 1 &&
            s.dataQuality &&
            s.dataGaps
          );
        }

        if (step === 3) {
          const tech = data.technology || [];
          const decisions = data.decisions || [];
          if (tech.length < decisions.length) return false;
          return tech.every(t =>
            t.collectionMethod &&
            t.storageSystem &&
            (t.algorithms || []).length >= 1 &&
            t.processingFrequency &&
            t.dataIntegration &&
            t.securityRequirements
          );
        }

        if (step === 4) {
          const apis = data.apis || [];
          const decisions = data.decisions || [];
          if (apis.length < decisions.length) return false;
          return apis.every(a =>
            (a.apiEndpoints || []).length >= 1 &&
            a.accessMethod &&
            a.userInterface &&
            a.updateFrequency &&
            a.userTraining &&
            a.accessControls
          );
        }

        return true;
      };

      const nextStep = async () => {
        if (step === 0) { setStep(0.5); return; }
        if (step === 0.5) {
          setStep(1);
          const decisions = data.decisions || [];
          if ((data.dataSources || []).length === 0) {
            setData(prev => ({
              ...prev,
              dataSources: decisions.map(d => ({
                decisionId: d.id,
                decisionName: d.decisionName,
                internalSources: [{ id: 1, source: '', description: '', availability: '' }],
                externalSources: [{ id: 1, source: '', description: '', cost: '' }],
                dataQuality: '',
                dataGaps: ''
              }))
            }));
          }
          return;
        }
        if (step >= 1 && step <= 4) {
          const userId = localStorage.getItem('ft_user_id');
          if (userId) {
            setAiReviewing(true);
            try {
              let stepAnswers = {};
              let stepName = '';
              if (step === 1) { stepName = 'Core Decisions'; stepAnswers = { decisions: data.decisions }; }
              else if (step === 2) { stepName = 'Data Sources'; stepAnswers = { dataSources: data.dataSources }; }
              else if (step === 3) { stepName = 'Technology Platform'; stepAnswers = { technology: data.technology }; }
              else if (step === 4) { stepName = 'APIs & Access'; stepAnswers = { apis: data.apis }; }
              const proceed = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, stepAnswers, stepName);
              if (!proceed) {
                setAiMessage(window.AIChallenge?.getLastFeedback?.()?.suggestion || 'Please expand your answer before continuing.');
                setAiReviewing(false);
                return;
              }
              setAiMessage('');
            } catch (err) {
              console.warn('[AIChallenge] Error, allowing passage:', err);
            } finally {
              setAiReviewing(false);
            }
          }

          // Data initializations before transition
          if (step === 1) {
            const decisions = data.decisions || [];
            if ((data.technology || []).length === 0) {
              setData(prev => ({
                ...prev,
                technology: decisions.map(d => ({
                  decisionId: d.id,
                  decisionName: d.decisionName,
                  collectionMethod: '',
                  storageSystem: '',
                  algorithms: [{ id: 1, algorithm: '', purpose: '', complexity: '' }],
                  processingFrequency: '',
                  dataIntegration: '',
                  securityRequirements: ''
                }))
              }));
            }
          } else if (step === 2) {
            const decisions = data.decisions || [];
            if ((data.apis || []).length === 0) {
              setData(prev => ({
                ...prev,
                apis: decisions.map(d => ({
                  decisionId: d.id,
                  decisionName: d.decisionName,
                  apiEndpoints: [{ id: 1, endpoint: '', purpose: '', users: '' }],
                  accessMethod: '',
                  userInterface: '',
                  updateFrequency: '',
                  userTraining: '',
                  accessControls: ''
                }))
              }));
            }
          }

          if (step < 4) {
            setStep(step + 0.5);
          } else {
            setStep(5);
          }
        }
      };

      const prevStep = () => {
        if (step === 0.5) setStep(0);
        else if (step > 1) setStep(step - 1);
        else if (step === 1) setStep(0.5);
      };

      return (
        <div>
          {step === 0 && <CoverPage onStart={nextStep} />}
          {step === 0.5 && <IntroductionPage onNext={nextStep} onBack={prevStep} />}
          {(() => {
            const transitionRender = window.renderTransitionScreen(step, CONFIG, 4, setStep);
            if (transitionRender) return transitionRender;
            return null;
          })()}
          {step >= 1 && step <= 4 && (() => {
            const stepLabels = ['Core Decisions', 'Data Sources', 'Technology', 'APIs & Access'];
            const nextLabels = { 1: 'NEXT: DATA SOURCES →', 2: 'NEXT: TECHNOLOGY →', 3: 'NEXT: APIS & ACCESS →', 4: 'VIEW CANVAS →' };
            return (
              <div className="wizard-layout">
                <div className="wizard-main">
                  <div className="wizard-content animate-in">
                    {step === 1 && <><DependencyContext deps={deps} /><Step1Decisions data={data} setData={setData} /></>}
                    {step === 2 && <Step2DataSources data={data} setData={setData} />}
                    {step === 3 && <Step3Technology data={data} setData={setData} />}
                    {step === 4 && <Step4APIs data={data} setData={setData} />}
                  </div>
                  <div className="wizard-footer" style={{flexDirection:'column',alignItems:'stretch',gap:'0'}}>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                      <button className="btn-wiz-back" onClick={prevStep}>← BACK</button>
                      <button className="btn-wiz-next" disabled={aiReviewing || !canProceed()} onClick={nextStep}>
                        {aiReviewing ? 'AI COACH REVIEWING...' : (nextLabels[step] || 'NEXT →')}
                      </button>
                    </div>
                    {aiMessage && <div style={{color:'#dc2626',fontSize:'13px',marginTop:'8px',padding:'8px 12px',background:'#fef2f2',borderRadius:'6px'}}>{aiMessage}</div>}
                  </div>
                </div>
                <WizardSidebar currentStep={step} stepLabels={stepLabels} totalSteps={4} />
              </div>
            );
          })()}
          {step === 5 && <Step5Canvas data={data} onBack={prevStep} />}
        </div>
      );
    }

    // Cover Page
    function CoverPage({ onStart }) {
      return (
        <div className="relative min-h-screen flex items-center justify-center bg-black">
          <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url("https://images.unsplash.com/photo-1677442135703-1787eea5ce01?w=1920&q=80")', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.3 }} />
          <div className="absolute inset-0" style={{background: 'linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.85))'}}></div>

          <div className="relative z-10 text-center text-white px-8 max-w-5xl mx-auto">
            <h1 className="plaak animate-in" style={{fontSize: '100px', lineHeight: '1', marginBottom: '32px'}}>
              DIGITAL HEART
            </h1>
            <h2 className="plaak animate-in" style={{fontSize: '80px', lineHeight: '1', marginBottom: '32px', color: '#FFF469', animationDelay: '0.1s'}}>
              DATA LAKE
            </h2>
            <p className="text-4xl mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              Create the foundation for data-driven decisions and AI transformation.
            </p>
            <button
              onClick={onStart}
              className="bg-white text-black plaak px-16 py-6 border-4 border-white hover:bg-black hover:text-white transition-all text-3xl animate-in"
              style={{animationDelay: '0.4s'}}
            >
              START
            </button>
          </div>
        </div>
      );
    }

    // Introduction Page
    function IntroductionPage({ onNext, onBack }) {
      return (
        <div className="min-h-screen bg-white p-8 md:p-16 animate-in" style={{ paddingBottom: '120px' }}>
          <div className="max-w-4xl mx-auto">
            <h1 className="plaak text-5xl md:text-6xl mb-8">
              DIGITALIZATION MADE SIMPLE
            </h1>

            <div className="info-box mb-8">
              <p className="text-xl riforma-bold mb-4">
                The quality of a business depends to a huge extent on the quality of the decisions taken. The managers who have a vast amount of data and the ability to interpret the data are in a position to make much better and faster decisions than their counterparts.
              </p>
              <p className="text-xl">
                Data is quickly becoming the ultimate fuel for speed and growth in companies.
              </p>
            </div>

            <h2 className="plaak text-3xl mb-6">
              THE SIX CORE ELEMENTS DETERMINING ORGANIZATIONAL SPEED
            </h2>

            <div className="space-y-6 mb-12">
              <div className="numbered-section" style={{ fontSize: '20px', marginBottom: '12px' }}>01</div>
              <div className="ml-8">
                <h3 className="riforma-bold text-xl mb-2">Ability to generate ideas fast</h3>
                <p className="text-lg text-gray-700">
                  This usually is a function of the creativity of teams, but also the access to versatile and seemingly unrelated information. We have observed a strong correlation between how much the team members read and their ability to generate new ideas.
                </p>
              </div>

              <div className="numbered-section" style={{ fontSize: '20px', marginBottom: '12px' }}>02</div>
              <div className="ml-8">
                <h3 className="riforma-bold text-xl mb-2">Ability to test ideas quickly</h3>
                <p className="text-lg text-gray-700">
                  Test ideas on a small scale with minimum resources before deciding.
                </p>
              </div>

              <div className="numbered-section" style={{ fontSize: '20px', marginBottom: '12px' }}>03</div>
              <div className="ml-8">
                <h3 className="riforma-bold text-xl mb-2">Speed of decision-making</h3>
                <p className="text-lg text-gray-700">
                  Critical for staying competitive in fast-moving markets.
                </p>
              </div>

              <div className="numbered-section" style={{ fontSize: '20px', marginBottom: '12px' }}>04</div>
              <div className="ml-8">
                <h3 className="riforma-bold text-xl mb-2">Ability to quickly allocate resources</h3>
                <p className="text-lg text-gray-700">
                  E.g. people, time, cash and other resources to support decisions taken.
                </p>
              </div>

              <div className="numbered-section" style={{ fontSize: '20px', marginBottom: '12px' }}>05</div>
              <div className="ml-8">
                <h3 className="riforma-bold text-xl mb-2">Ability to adjust organizational structure</h3>
                <p className="text-lg text-gray-700">
                  Usually, this might require a fundamental shift in the priorities and structure of the organization, which is often the biggest impediment to moving fast.
                </p>
              </div>

              <div className="numbered-section" style={{ fontSize: '20px', marginBottom: '12px' }}>06</div>
              <div className="ml-8">
                <h3 className="riforma-bold text-xl mb-2">Decentralized decision-making</h3>
                <p className="text-lg text-gray-700">
                  In traditional organizations decisions are taken sequentially, where information has to move from one department to another - both horizontally and vertically. The sequential process of decision-making not only slows the organizations down but dilutes responsibility and accountability and feeds the devil of bureaucracy.
                </p>
              </div>
            </div>

            <h2 className="plaak text-3xl mb-6">
              THE ESSENCE OF AGILE
            </h2>

            <p className="text-lg mb-6 text-gray-700">
              Agile is a methodology traditionally introduced and used by IT and software companies. However, this methodology has been successfully adopted and used by many multinational companies like Unilever, Johnson & Johnson, L'Oreal, etc. It has huge benefits in terms of the speed of organizational development and the ability to solve issues quickly and execute them faster.
            </p>

            <div className="highlight-box mb-12">
              <p className="text-xl riforma-bold">
                Agile transformation is a lengthy process that if done correctly could be a game changer in how a company operates.
              </p>
            </div>

            <h2 className="plaak text-3xl mb-6">
              YOUR 4-STEP DIGITALIZATION JOURNEY
            </h2>

            <div className="space-y-4">
              <div className="flex gap-4 items-start">
                <div className="numbered-section" style={{ fontSize: '18px' }}>1</div>
                <p className="text-lg flex-1">
                  Determine the core decisions that could be digitalized
                </p>
              </div>

              <div className="flex gap-4 items-start">
                <div className="numbered-section" style={{ fontSize: '18px' }}>2</div>
                <p className="text-lg flex-1">
                  Identify the sources of data (internal and external) that will facilitate decision-making
                </p>
              </div>

              <div className="flex gap-4 items-start">
                <div className="numbered-section" style={{ fontSize: '18px' }}>3</div>
                <p className="text-lg flex-1">
                  Create the technology platform and algorithms to collect and make sense of the data
                </p>
              </div>

              <div className="flex gap-4 items-start">
                <div className="numbered-section" style={{ fontSize: '18px' }}>4</div>
                <p className="text-lg flex-1">
                  Create APIs to enable people in the organization to access and use data in real-time
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Progress Indicator Component
    function ProgressIndicator({ currentStep }) {
      const steps = [
        { label: 'Decisions', step: 1 },
        { label: 'Data', step: 2 },
        { label: 'Platform', step: 3 },
        { label: 'Access', step: 4 }
      ];

      return (
        <div className="mb-12">
          <div className="flex items-center justify-center gap-4">
            {steps.map((s, idx) => (
              <Fragment key={s.step}>
                <div className="flex flex-col items-center gap-2">
                  <div className={`progress-dot ${currentStep === s.step ? 'active' : currentStep > s.step ? 'completed' : ''}`} />
                  <span className="monument text-xs">{s.label}</span>
                </div>
                {idx < steps.length - 1 && <div className="progress-line" style={{ width: '60px' }} />}
              </Fragment>
            ))}
          </div>
        </div>
      );
    }

    // Step 1: Core Decisions to Digitalize
    function Step1Decisions({ data, setData }) {
      const decisions = data.decisions || [];

      const addDecision = () => {
        const newId = Math.max(0, ...decisions.map(d => d.id)) + 1;
        setData({
          ...data,
          decisions: [...decisions, {
            id: newId,
            decisionName: '',
            frequency: '',
            impactLevel: '',
            currentProcess: '',
            dataNeededDescription: '',
            priority: 5
          }]
        });
      };

      const removeDecision = (id) => {
        if (decisions.length > 1) {
          setData({
            ...data,
            decisions: decisions.filter(d => d.id !== id)
          });
        }
      };

      const updateDecision = (id, field, value) => {
        setData({
          ...data,
          decisions: decisions.map(d =>
            d.id === id ? { ...d, [field]: value } : d
          )
        });
      };

      const sortedDecisions = [...decisions].sort((a, b) => b.priority - a.priority);

      return (
        <div>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 1 OF 5
            </div>

            <h1 className="plaak text-5xl mb-4">
              STEP 1: CORE DECISIONS TO DIGITALIZE
            </h1>

            <p className="text-xl mb-8 text-gray-700">
              Identify the key decisions in your organization that could benefit from data-driven insights. Think about decisions that are frequent, high-impact, and currently made with limited data.
            </p>

            <div className="info-box mb-8">
              <p className="riforma-bold mb-2">Required: Minimum 3 decisions</p>
              <p className="text-gray-700">For each decision, describe what it is, how it's currently made, and what data would improve it. Then prioritize all decisions from 1-10.</p>
            </div>

            <div className="space-y-6 mb-8">
              {decisions.map((decision, index) => (
                <div key={decision.id} className={`decision-card ${decision.priority >= 8 ? 'priority-high' : ''}`}>
                  <div className="flex justify-between items-start mb-4">
                    <div className="numbered-section" style={{ fontSize: '20px' }}>
                      {String(index + 1).padStart(2, '0')}
                    </div>

                    {/* Fast Track Insight */}

                    {/* The Science */}
                    <ScienceBox collapsible={true}>
                        Research from MIT Sloan Management Review (2023) found that companies with a clearly defined "digital core" -- a single source of truth connecting operational data to decision-making -- outperformed peers by 26% in revenue growth and 21% in profit margins. A McKinsey Global Survey (2022) showed that organizations prioritizing data-driven decision-making were 23 times more likely to acquire customers and 19 times more likely to be profitable. The key driver: writing down which decisions matter most forces executive teams to confront data gaps they would otherwise ignore.
                    </ScienceBox>

                    {/* Common Mistake */}

                    {decisions.length > 1 && (
                      <button
                        className="btn-remove"
                        onClick={() => removeDecision(decision.id)}
                      >
                        Remove
                      </button>
                    )}
                  </div>

                  <div className="space-y-4">
                    <div>
                      <label className="monument text-sm block mb-2">Decision Name</label>
                      <ScienceBookmarkIcon>
                          Bain &amp; Company found that companies which explicitly name and rank their top decisions grow revenue 5-6% faster than competitors who leave decision authority ambiguous.
                      </ScienceBookmarkIcon>
                      <input
                        type="text"
                        value={decision.decisionName || ''}
                        onChange={(e) => updateDecision(decision.id, 'decisionName', e.target.value)}
                        placeholder="e.g., Product pricing strategy for new market segments"
                      />
                      <div className={`char-counter ${(decision.decisionName || '').length < 50 ? 'invalid' : ''}`}>
                        {(decision.decisionName || '').length} / 50 characters minimum
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="monument text-sm block mb-2">Frequency</label>
                        <ScienceBookmarkIcon>
                            High-frequency decisions (daily/weekly) benefit most from digitalization. BCG research shows automating these yields 3-5x more ROI than digitalizing infrequent strategic decisions.
                        </ScienceBookmarkIcon>
                        <select
                          value={decision.frequency || ''}
                          onChange={(e) => updateDecision(decision.id, 'frequency', e.target.value)}
                        >
                          <option value="">Select frequency</option>
                          <option value="Daily">Daily</option>
                          <option value="Weekly">Weekly</option>
                          <option value="Monthly">Monthly</option>
                          <option value="Quarterly">Quarterly</option>
                          <option value="Annually">Annually</option>
                        </select>
                      </div>

                      <div>
                        <label className="monument text-sm block mb-2">Impact Level</label>
                        <ScienceBookmarkIcon>
                            McKinsey found that high-impact decisions -- those affecting revenue, cost, or customer experience -- account for 20% of all business decisions but determine 80% of value creation.
                        </ScienceBookmarkIcon>
                        <select
                          value={decision.impactLevel || ''}
                          onChange={(e) => updateDecision(decision.id, 'impactLevel', e.target.value)}
                        >
                          <option value="">Select impact</option>
                          <option value="High">High</option>
                          <option value="Medium">Medium</option>
                          <option value="Low">Low</option>
                        </select>
                      </div>
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Current Process</label>
                      <textarea
                        value={decision.currentProcess || ''}
                        onChange={(e) => updateDecision(decision.id, 'currentProcess', e.target.value)}
                        placeholder="Describe how this decision is currently made. Who makes it? What information do they use? What are the challenges?"
                      />
                      <div className={`char-counter ${(decision.currentProcess || '').length < 100 ? 'invalid' : ''}`}>
                        {(decision.currentProcess || '').length} / 100 characters minimum
                      </div>
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Data Needed Description</label>
                      <textarea
                        value={decision.dataNeededDescription || ''}
                        onChange={(e) => updateDecision(decision.id, 'dataNeededDescription', e.target.value)}
                        placeholder="What data would help make this decision better? What insights would you like to have? What questions would you like the data to answer?"
                      />
                      <div className={`char-counter ${(decision.dataNeededDescription || '').length < 100 ? 'invalid' : ''}`}>
                        {(decision.dataNeededDescription || '').length} / 100 characters minimum
                      </div>
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Priority (1-10)</label>
                      <div className="flex items-center gap-4">
                        <input
                          type="range"
                          min="1"
                          max="10"
                          value={decision.priority || 5}
                          onChange={(e) => updateDecision(decision.id, 'priority', parseInt(e.target.value))}
                        />
                        <span className="text-2xl riforma-bold" style={{ minWidth: '40px' }}>
                          {decision.priority || 5}
                        </span>
                      </div>
                      <p className="text-sm text-gray-600 mt-2">
                        1 = Low priority, 10 = Highest priority
                      </p>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <button className="btn-secondary mb-12" onClick={addDecision}>
              + Add Another Decision
            </button>

            {decisions.length >= 3 && (
              <div className="highlight-box">
                <h3 className="plaak text-2xl mb-4">PRIORITY RANKING</h3>
                <div className="space-y-3">
                  {sortedDecisions.map((decision, index) => (
                    <div key={decision.id} className="flex items-center gap-4 p-3 bg-white border-2 border-black">
                      <div className="riforma-bold text-2xl" style={{ minWidth: '40px' }}>
                        #{index + 1}
                      </div>
                      <div className="flex-1">
                        <div className="riforma-bold text-lg">{decision.decisionName || 'Unnamed decision'}</div>
                        <div className="text-sm text-gray-600">
                          {decision.frequency} • {decision.impactLevel} Impact
                        </div>
                      </div>
                      <div className="text-3xl riforma-bold">
                        {decision.priority}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
        </div>
      );
    }

    // Step 2: Data Sources
    function Step2DataSources({ data, setData }) {
      const decisions = data.decisions || [];
      const dataSources = data.dataSources || [];

      const updateDataSource = (decisionId, field, value) => {
        setData({
          ...data,
          dataSources: dataSources.map(ds =>
            ds.decisionId === decisionId ? { ...ds, [field]: value } : ds
          )
        });
      };

      const addInternalSource = (decisionId) => {
        setData({
          ...data,
          dataSources: dataSources.map(ds => {
            if (ds.decisionId === decisionId) {
              const sources = ds.internalSources || [];
              const newId = Math.max(0, ...sources.map(s => s.id)) + 1;
              return {
                ...ds,
                internalSources: [...sources, { id: newId, source: '', description: '', availability: '' }]
              };
            }
            return ds;
          })
        });
      };

      const removeInternalSource = (decisionId, sourceId) => {
        setData({
          ...data,
          dataSources: dataSources.map(ds => {
            if (ds.decisionId === decisionId) {
              const sources = ds.internalSources || [];
              if (sources.length > 1) {
                return {
                  ...ds,
                  internalSources: sources.filter(s => s.id !== sourceId)
                };
              }
            }
            return ds;
          })
        });
      };

      const updateInternalSource = (decisionId, sourceId, field, value) => {
        setData({
          ...data,
          dataSources: dataSources.map(ds => {
            if (ds.decisionId === decisionId) {
              return {
                ...ds,
                internalSources: (ds.internalSources || []).map(s =>
                  s.id === sourceId ? { ...s, [field]: value } : s
                )
              };
            }
            return ds;
          })
        });
      };

      const addExternalSource = (decisionId) => {
        setData({
          ...data,
          dataSources: dataSources.map(ds => {
            if (ds.decisionId === decisionId) {
              const sources = ds.externalSources || [];
              const newId = Math.max(0, ...sources.map(s => s.id)) + 1;
              return {
                ...ds,
                externalSources: [...sources, { id: newId, source: '', description: '', cost: '' }]
              };
            }
            return ds;
          })
        });
      };

      const removeExternalSource = (decisionId, sourceId) => {
        setData({
          ...data,
          dataSources: dataSources.map(ds => {
            if (ds.decisionId === decisionId) {
              const sources = ds.externalSources || [];
              if (sources.length > 1) {
                return {
                  ...ds,
                  externalSources: sources.filter(s => s.id !== sourceId)
                };
              }
            }
            return ds;
          })
        });
      };

      const updateExternalSource = (decisionId, sourceId, field, value) => {
        setData({
          ...data,
          dataSources: dataSources.map(ds => {
            if (ds.decisionId === decisionId) {
              return {
                ...ds,
                externalSources: (ds.externalSources || []).map(s =>
                  s.id === sourceId ? { ...s, [field]: value } : s
                )
              };
            }
            return ds;
          })
        });
      };

      return (
        <div>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 2 OF 5
            </div>

            <h1 className="plaak text-5xl mb-4">
              STEP 2: DATA SOURCES
            </h1>

            <p className="text-xl mb-8 text-gray-700">
              For each core decision, identify the internal and external data sources that will help you make better decisions. Think broadly about all possible sources of information.
            </p>

            <div className="info-box mb-8">
              <p className="riforma-bold mb-2">Required for each decision:</p>
              <ul className="list-disc list-inside text-gray-700 space-y-1">
                <li>Minimum 2 internal data sources</li>
                <li>Minimum 1 external data source</li>
                <li>Data quality assessment</li>
                <li>Data gaps identification</li>
              </ul>
            </div>

            <div className="space-y-12">
              {dataSources.map((ds, index) => (
                <div key={ds.decisionId} className="decision-card">
                  <div className="numbered-section mb-4" style={{ fontSize: '20px' }}>
                    {String(index + 1).padStart(2, '0')}
                  </div>

                  {/* Fast Track Insight */}

                  {/* The Science */}
                  <ScienceBox collapsible={true}>
                      A Harvard Business Review study (2023) on 1,500 enterprises found that companies with well-mapped data sources made decisions 2.5x faster and with 30% fewer errors than those relying on ad-hoc data gathering. Gartner reports that through 2025, 80% of organizations seeking to scale digital business will fail because they do not take a modern approach to data management. The critical factor: knowing exactly where your data lives, its quality, and its gaps before building any technology platform.
                  </ScienceBox>


                  <h3 className="riforma-bold text-2xl mb-6">
                    {ds.decisionName || 'Decision Name'}
                  </h3>

                  {/* Internal Sources */}
                  <div className="mb-6">
                    <h4 className="monument text-lg mb-4 flex items-center gap-2">
                      <span className="data-tag internal">INTERNAL SOURCES</span>
                    </h4>

                    <div className="space-y-4 mb-4">
                      {(ds.internalSources || []).map((source, idx) => (
                        <div key={source.id} className="border border-gray-300 p-4 bg-gray-50">
                          <div className="flex justify-between items-start mb-3">
                            <span className="monument text-sm">Internal Source {idx + 1}</span>
                            {(ds.internalSources || []).length > 1 && (
                              <button
                                className="btn-remove"
                                onClick={() => removeInternalSource(ds.decisionId, source.id)}
                              >
                                Remove
                              </button>
                            )}
                          </div>

                          <div className="space-y-3">
                            <div>
                              <label className="monument text-xs block mb-1">Source Name</label>
                              <input
                                type="text"
                                value={source.source || ''}
                                onChange={(e) => updateInternalSource(ds.decisionId, source.id, 'source', e.target.value)}
                                placeholder="e.g., CRM System (Salesforce), ERP (SAP), Financial Database"
                              />
                            </div>

                            <div>
                              <label className="monument text-xs block mb-1">Description</label>
                              <textarea
                                value={source.description || ''}
                                onChange={(e) => updateInternalSource(ds.decisionId, source.id, 'description', e.target.value)}
                                placeholder="What data does this source contain? How is it relevant to the decision?"
                                style={{ minHeight: '80px' }}
                              />
                            </div>

                            <div>
                              <label className="monument text-xs block mb-1">Availability</label>
                              <input
                                type="text"
                                value={source.availability || ''}
                                onChange={(e) => updateInternalSource(ds.decisionId, source.id, 'availability', e.target.value)}
                                placeholder="e.g., Real-time API access, Daily exports, Manual reports"
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>

                    <button
                      className="btn-small"
                      onClick={() => addInternalSource(ds.decisionId)}
                    >
                      + Add Internal Source
                    </button>
                  </div>

                  {/* External Sources */}
                  <div className="mb-6">
                    <h4 className="monument text-lg mb-4 flex items-center gap-2">
                      <span className="data-tag external">EXTERNAL SOURCES</span>
                    </h4>

                    <div className="space-y-4 mb-4">
                      {(ds.externalSources || []).map((source, idx) => (
                        <div key={source.id} className="border border-gray-300 p-4 bg-gray-50">
                          <div className="flex justify-between items-start mb-3">
                            <span className="monument text-sm">External Source {idx + 1}</span>
                            {(ds.externalSources || []).length > 1 && (
                              <button
                                className="btn-remove"
                                onClick={() => removeExternalSource(ds.decisionId, source.id)}
                              >
                                Remove
                              </button>
                            )}
                          </div>

                          <div className="space-y-3">
                            <div>
                              <label className="monument text-xs block mb-1">Source Name</label>
                              <input
                                type="text"
                                value={source.source || ''}
                                onChange={(e) => updateExternalSource(ds.decisionId, source.id, 'source', e.target.value)}
                                placeholder="e.g., Market Research (Gartner), Social Media Analytics, Industry Reports"
                              />
                            </div>

                            <div>
                              <label className="monument text-xs block mb-1">Description</label>
                              <textarea
                                value={source.description || ''}
                                onChange={(e) => updateExternalSource(ds.decisionId, source.id, 'description', e.target.value)}
                                placeholder="What insights does this source provide? Why is it valuable?"
                                style={{ minHeight: '80px' }}
                              />
                            </div>

                            <div>
                              <label className="monument text-xs block mb-1">Cost Estimate</label>
                              <input
                                type="text"
                                value={source.cost || ''}
                                onChange={(e) => updateExternalSource(ds.decisionId, source.id, 'cost', e.target.value)}
                                placeholder="e.g., $5,000/year subscription, Free, $500/month"
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>

                    <button
                      className="btn-small"
                      onClick={() => addExternalSource(ds.decisionId)}
                    >
                      + Add External Source
                    </button>
                  </div>

                  {/* Data Quality & Gaps */}
                  <div className="space-y-4 mt-6">
                    <div>
                      <label className="monument text-sm block mb-2">Data Quality Assessment</label>
                      <textarea
                        value={ds.dataQuality || ''}
                        onChange={(e) => updateDataSource(ds.decisionId, 'dataQuality', e.target.value)}
                        placeholder="Assess the current quality of available data. Is it accurate? Complete? Timely? What are the quality issues?"
                      />
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Data Gaps</label>
                      <textarea
                        value={ds.dataGaps || ''}
                        onChange={(e) => updateDataSource(ds.decisionId, 'dataGaps', e.target.value)}
                        placeholder="What data is missing? What additional information would be valuable? What are the blind spots?"
                      />
                    </div>
                  </div>
                </div>
              ))}
            </div>
        </div>
      );
    }

    // Step 3: Technology Platform & Algorithms
    function Step3Technology({ data, setData }) {
      const decisions = data.decisions || [];
      const technology = data.technology || [];

      const updateTechnology = (decisionId, field, value) => {
        setData({
          ...data,
          technology: technology.map(t =>
            t.decisionId === decisionId ? { ...t, [field]: value } : t
          )
        });
      };

      const addAlgorithm = (decisionId) => {
        setData({
          ...data,
          technology: technology.map(t => {
            if (t.decisionId === decisionId) {
              const algorithms = t.algorithms || [];
              const newId = Math.max(0, ...algorithms.map(a => a.id)) + 1;
              return {
                ...t,
                algorithms: [...algorithms, { id: newId, algorithm: '', purpose: '', complexity: '' }]
              };
            }
            return t;
          })
        });
      };

      const removeAlgorithm = (decisionId, algId) => {
        setData({
          ...data,
          technology: technology.map(t => {
            if (t.decisionId === decisionId) {
              const algorithms = t.algorithms || [];
              if (algorithms.length > 1) {
                return {
                  ...t,
                  algorithms: algorithms.filter(a => a.id !== algId)
                };
              }
            }
            return t;
          })
        });
      };

      const updateAlgorithm = (decisionId, algId, field, value) => {
        setData({
          ...data,
          technology: technology.map(t => {
            if (t.decisionId === decisionId) {
              return {
                ...t,
                algorithms: (t.algorithms || []).map(a =>
                  a.id === algId ? { ...a, [field]: value } : a
                )
              };
            }
            return t;
          })
        });
      };

      return (
        <div>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 3 OF 5
            </div>

            <h1 className="plaak text-5xl mb-4">
              STEP 3: TECHNOLOGY PLATFORM & ALGORITHMS
            </h1>

            <p className="text-xl mb-8 text-gray-700">
              Define how you will collect, store, and process the data. This is where you build your data lake infrastructure.
            </p>

            <div className="info-box mb-8">
              <p className="riforma-bold mb-2">For each decision, define:</p>
              <ul className="list-disc list-inside text-gray-700 space-y-1">
                <li>How data will be collected</li>
                <li>Where it will be stored</li>
                <li>What algorithms will process it</li>
                <li>Processing frequency</li>
                <li>How different sources integrate</li>
                <li>Security requirements</li>
              </ul>
            </div>

            <div className="space-y-12">
              {technology.map((tech, index) => (
                <div key={tech.decisionId} className="decision-card">
                  <div className="numbered-section mb-4" style={{ fontSize: '20px' }}>
                    {String(index + 1).padStart(2, '0')}
                  </div>

                  {/* Fast Track Insight */}

                  {/* The Science */}
                  <ScienceBox collapsible={true}>
                      A Deloitte meta-analysis of 200+ digital transformation initiatives (2023) found that organizations which documented their technology architecture before implementation had 35% higher execution rates and 40% lower cost overruns. MIT CISR research shows that companies with a well-designed data platform generate 32% more revenue from their data assets. The key insight: choosing algorithms and processing frequencies upfront prevents the most expensive mistake in digitalization -- building technology that does not match how decisions are actually made.
                  </ScienceBox>


                  <h3 className="riforma-bold text-2xl mb-6">
                    {tech.decisionName || 'Decision Name'}
                  </h3>

                  <div className="space-y-6">
                    <div>
                      <label className="monument text-sm block mb-2">Collection Method</label>
                      <textarea
                        value={tech.collectionMethod || ''}
                        onChange={(e) => updateTechnology(tech.decisionId, 'collectionMethod', e.target.value)}
                        placeholder="How will data be collected? (e.g., API integrations, automated scraping, manual uploads, IoT sensors, webhooks)"
                        style={{ minHeight: '100px' }}
                      />
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Storage System</label>
                      <div className="space-y-2">
                        <label className="flex items-center gap-3 p-3 border border-gray-300 cursor-pointer hover:bg-gray-50">
                          <input
                            type="radio"
                            name={`storage-${tech.decisionId}`}
                            value="Cloud"
                            checked={tech.storageSystem === 'Cloud'}
                            onChange={(e) => updateTechnology(tech.decisionId, 'storageSystem', e.target.value)}
                          />
                          <div>
                            <div className="riforma-bold">Cloud-based</div>
                            <div className="text-sm text-gray-600">AWS, Azure, Google Cloud, Snowflake</div>
                          </div>
                        </label>

                        <label className="flex items-center gap-3 p-3 border border-gray-300 cursor-pointer hover:bg-gray-50">
                          <input
                            type="radio"
                            name={`storage-${tech.decisionId}`}
                            value="On-Premise"
                            checked={tech.storageSystem === 'On-Premise'}
                            onChange={(e) => updateTechnology(tech.decisionId, 'storageSystem', e.target.value)}
                          />
                          <div>
                            <div className="riforma-bold">On-Premise</div>
                            <div className="text-sm text-gray-600">Local servers, data center</div>
                          </div>
                        </label>

                        <label className="flex items-center gap-3 p-3 border border-gray-300 cursor-pointer hover:bg-gray-50">
                          <input
                            type="radio"
                            name={`storage-${tech.decisionId}`}
                            value="Hybrid"
                            checked={tech.storageSystem === 'Hybrid'}
                            onChange={(e) => updateTechnology(tech.decisionId, 'storageSystem', e.target.value)}
                          />
                          <div>
                            <div className="riforma-bold">Hybrid</div>
                            <div className="text-sm text-gray-600">Combination of cloud and on-premise</div>
                          </div>
                        </label>
                      </div>
                    </div>

                    {/* Algorithms */}
                    <div>
                      <label className="monument text-sm block mb-3">Algorithms & Processing Logic</label>

                      <div className="space-y-4 mb-4">
                        {(tech.algorithms || []).map((alg, idx) => (
                          <div key={alg.id} className="border border-gray-300 p-4 bg-gray-50">
                            <div className="flex justify-between items-start mb-3">
                              <span className="monument text-sm">Algorithm {idx + 1}</span>
                              {(tech.algorithms || []).length > 1 && (
                                <button
                                  className="btn-remove"
                                  onClick={() => removeAlgorithm(tech.decisionId, alg.id)}
                                >
                                  Remove
                                </button>
                              )}
                            </div>

                            <div className="space-y-3">
                              <div>
                                <label className="monument text-xs block mb-1">Algorithm Name/Type</label>
                                <input
                                  type="text"
                                  value={alg.algorithm || ''}
                                  onChange={(e) => updateAlgorithm(tech.decisionId, alg.id, 'algorithm', e.target.value)}
                                  placeholder="e.g., Linear Regression, Classification Model, Clustering, Recommendation Engine"
                                />
                              </div>

                              <div>
                                <label className="monument text-xs block mb-1">Purpose</label>
                                <textarea
                                  value={alg.purpose || ''}
                                  onChange={(e) => updateAlgorithm(tech.decisionId, alg.id, 'purpose', e.target.value)}
                                  placeholder="What does this algorithm do? What insights does it generate?"
                                  style={{ minHeight: '70px' }}
                                />
                              </div>

                              <div>
                                <label className="monument text-xs block mb-1">Complexity Level</label>
                                <select
                                  value={alg.complexity || ''}
                                  onChange={(e) => updateAlgorithm(tech.decisionId, alg.id, 'complexity', e.target.value)}
                                >
                                  <option value="">Select complexity</option>
                                  <option value="Simple">Simple (basic calculations, aggregations)</option>
                                  <option value="Moderate">Moderate (statistical analysis, simple ML)</option>
                                  <option value="Complex">Complex (advanced ML, deep learning, AI)</option>
                                </select>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>

                      <button
                        className="btn-small"
                        onClick={() => addAlgorithm(tech.decisionId)}
                      >
                        + Add Algorithm
                      </button>
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Processing Frequency</label>
                      <select
                        value={tech.processingFrequency || ''}
                        onChange={(e) => updateTechnology(tech.decisionId, 'processingFrequency', e.target.value)}
                      >
                        <option value="">Select frequency</option>
                        <option value="Real-time">Real-time (continuous processing)</option>
                        <option value="Hourly">Hourly</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="On-demand">On-demand</option>
                      </select>
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Data Integration Approach</label>
                      <textarea
                        value={tech.dataIntegration || ''}
                        onChange={(e) => updateTechnology(tech.decisionId, 'dataIntegration', e.target.value)}
                        placeholder="How will different data sources be combined and integrated? What are the integration challenges? How will you ensure data consistency?"
                      />
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Security Requirements</label>
                      <textarea
                        value={tech.securityRequirements || ''}
                        onChange={(e) => updateTechnology(tech.decisionId, 'securityRequirements', e.target.value)}
                        placeholder="What security measures are needed? (e.g., encryption, access controls, data privacy, compliance requirements like GDPR)"
                      />
                    </div>
                  </div>
                </div>
              ))}
            </div>
        </div>
      );
    }

    // Step 4: APIs & Access
    function Step4APIs({ data, setData }) {
      const decisions = data.decisions || [];
      const apis = data.apis || [];

      const updateAPI = (decisionId, field, value) => {
        setData({
          ...data,
          apis: apis.map(a =>
            a.decisionId === decisionId ? { ...a, [field]: value } : a
          )
        });
      };

      const toggleAccessMethod = (decisionId, method) => {
        setData({
          ...data,
          apis: apis.map(a => {
            if (a.decisionId === decisionId) {
              const current = a.accessMethod || '';
              const methods = current.split(',').map(m => m.trim()).filter(Boolean);
              const hasMethod = methods.includes(method);

              let newMethods;
              if (hasMethod) {
                newMethods = methods.filter(m => m !== method);
              } else {
                newMethods = [...methods, method];
              }

              return { ...a, accessMethod: newMethods.join(', ') };
            }
            return a;
          })
        });
      };

      const addEndpoint = (decisionId) => {
        setData({
          ...data,
          apis: apis.map(a => {
            if (a.decisionId === decisionId) {
              const endpoints = a.apiEndpoints || [];
              const newId = Math.max(0, ...endpoints.map(e => e.id)) + 1;
              return {
                ...a,
                apiEndpoints: [...endpoints, { id: newId, endpoint: '', purpose: '', users: '' }]
              };
            }
            return a;
          })
        });
      };

      const removeEndpoint = (decisionId, endpointId) => {
        setData({
          ...data,
          apis: apis.map(a => {
            if (a.decisionId === decisionId) {
              const endpoints = a.apiEndpoints || [];
              if (endpoints.length > 1) {
                return {
                  ...a,
                  apiEndpoints: endpoints.filter(e => e.id !== endpointId)
                };
              }
            }
            return a;
          })
        });
      };

      const updateEndpoint = (decisionId, endpointId, field, value) => {
        setData({
          ...data,
          apis: apis.map(a => {
            if (a.decisionId === decisionId) {
              return {
                ...a,
                apiEndpoints: (a.apiEndpoints || []).map(e =>
                  e.id === endpointId ? { ...e, [field]: value } : e
                )
              };
            }
            return a;
          })
        });
      };

      return (
        <div>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 4 OF 5
            </div>

            <h1 className="plaak text-5xl mb-4">
              STEP 4: APIs & ACCESS
            </h1>

            <p className="text-xl mb-8 text-gray-700">
              Define how people in your organization will access and use the data. Make data accessible in real-time through user-friendly interfaces and APIs.
            </p>

            <div className="info-box mb-8">
              <p className="riforma-bold mb-2">For each decision, define:</p>
              <ul className="list-disc list-inside text-gray-700 space-y-1">
                <li>API endpoints for data access</li>
                <li>Access methods (dashboard, mobile, API, etc.)</li>
                <li>User interface design</li>
                <li>Data refresh frequency</li>
                <li>User training needs</li>
                <li>Access controls and permissions</li>
              </ul>
            </div>

            <div className="space-y-12">
              {apis.map((api, index) => (
                <div key={api.decisionId} className="decision-card">
                  <div className="numbered-section mb-4" style={{ fontSize: '20px' }}>
                    {String(index + 1).padStart(2, '0')}
                  </div>

                  {/* Fast Track Insight */}

                  {/* The Science */}
                  <ScienceBox collapsible={true}>
                      BCG longitudinal research (2023) tracking 150 organizations over 3 years found that companies which designed user-friendly data access layers and revisited their data lake architecture quarterly maintained 60% higher strategic alignment scores. Forrester data shows that organizations where employees can self-serve analytics see 5x faster adoption of data-driven decision-making. The research is clear: the last mile of data delivery -- how people actually interact with insights -- determines whether a data lake becomes a strategic asset or an expensive swamp.
                  </ScienceBox>


                  <h3 className="riforma-bold text-2xl mb-6">
                    {api.decisionName || 'Decision Name'}
                  </h3>

                  <div className="space-y-6">
                    {/* API Endpoints */}
                    <div>
                      <label className="monument text-sm block mb-3">API Endpoints</label>

                      <div className="space-y-4 mb-4">
                        {(api.apiEndpoints || []).map((endpoint, idx) => (
                          <div key={endpoint.id} className="border border-gray-300 p-4 bg-gray-50">
                            <div className="flex justify-between items-start mb-3">
                              <span className="monument text-sm">Endpoint {idx + 1}</span>
                              {(api.apiEndpoints || []).length > 1 && (
                                <button
                                  className="btn-remove"
                                  onClick={() => removeEndpoint(api.decisionId, endpoint.id)}
                                >
                                  Remove
                                </button>
                              )}
                            </div>

                            <div className="space-y-3">
                              <div>
                                <label className="monument text-xs block mb-1">Endpoint Name</label>
                                <input
                                  type="text"
                                  value={endpoint.endpoint || ''}
                                  onChange={(e) => updateEndpoint(api.decisionId, endpoint.id, 'endpoint', e.target.value)}
                                  placeholder="e.g., /api/pricing/recommendations, /api/inventory/status"
                                />
                              </div>

                              <div>
                                <label className="monument text-xs block mb-1">Purpose</label>
                                <textarea
                                  value={endpoint.purpose || ''}
                                  onChange={(e) => updateEndpoint(api.decisionId, endpoint.id, 'purpose', e.target.value)}
                                  placeholder="What data does this endpoint provide? What questions does it answer?"
                                  style={{ minHeight: '70px' }}
                                />
                              </div>

                              <div>
                                <label className="monument text-xs block mb-1">Target Users</label>
                                <input
                                  type="text"
                                  value={endpoint.users || ''}
                                  onChange={(e) => updateEndpoint(api.decisionId, endpoint.id, 'users', e.target.value)}
                                  placeholder="e.g., Product Managers, Sales Team, Executive Dashboard"
                                />
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>

                      <button
                        className="btn-small"
                        onClick={() => addEndpoint(api.decisionId)}
                      >
                        + Add Endpoint
                      </button>
                    </div>

                    {/* Access Methods */}
                    <div>
                      <label className="monument text-sm block mb-3">Access Methods (Select all that apply)</label>
                      <div className="space-y-2">
                        {['Dashboard', 'Mobile App', 'API Calls', 'Email Reports', 'Slack/Teams Integration'].map(method => (
                          <label key={method} className="flex items-center gap-3 p-3 border border-gray-300 cursor-pointer hover:bg-gray-50">
                            <input
                              type="checkbox"
                              checked={(api.accessMethod || '').includes(method)}
                              onChange={() => toggleAccessMethod(api.decisionId, method)}
                            />
                            <span className="riforma-bold">{method}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">User Interface Description</label>
                      <textarea
                        value={api.userInterface || ''}
                        onChange={(e) => updateAPI(api.decisionId, 'userInterface', e.target.value)}
                        placeholder="Describe the user interface. What will users see? How will they interact with the data? What visualizations will be provided? (e.g., dashboards with KPIs, charts, alerts, recommendations)"
                      />
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Update Frequency</label>
                      <select
                        value={api.updateFrequency || ''}
                        onChange={(e) => updateAPI(api.decisionId, 'updateFrequency', e.target.value)}
                      >
                        <option value="">Select frequency</option>
                        <option value="Real-time">Real-time (live updates)</option>
                        <option value="Every 5 minutes">Every 5 minutes</option>
                        <option value="Hourly">Hourly</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="On-demand">On-demand (user-triggered)</option>
                      </select>
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">User Training Requirements</label>
                      <textarea
                        value={api.userTraining || ''}
                        onChange={(e) => updateAPI(api.decisionId, 'userTraining', e.target.value)}
                        placeholder="What training will users need? How will they learn to use the system? What documentation is needed?"
                      />
                    </div>

                    <div>
                      <label className="monument text-sm block mb-2">Access Controls & Permissions</label>
                      <textarea
                        value={api.accessControls || ''}
                        onChange={(e) => updateAPI(api.decisionId, 'accessControls', e.target.value)}
                        placeholder="Who has access to what data? Define role-based access controls. What are the permission levels? (e.g., Admin: full access, Manager: read/write, Employee: read-only)"
                      />
                    </div>
                  </div>
                </div>
              ))}
            </div>

            {/* Implementation Section */}
            <div className="mt-12 highlight-box">
              <h2 className="plaak text-3xl mb-6">IMPLEMENTATION ROADMAP</h2>

              <div className="space-y-6">
                <div>
                  <label className="monument text-sm block mb-2">Phase 1 Timeline</label>
                  <input
                    type="text"
                    value={data.implementation.phase1Timeline || ''}
                    onChange={(e) => setData({
                      ...data,
                      implementation: { ...data.implementation, phase1Timeline: e.target.value }
                    })}
                    placeholder="e.g., 3 months for MVP, 6 months for full implementation"
                  />
                </div>

                <div>
                  <label className="monument text-sm block mb-2">Phase 1 Actions</label>
                  <textarea
                    value={data.implementation.phase1Actions || ''}
                    onChange={(e) => setData({
                      ...data,
                      implementation: { ...data.implementation, phase1Actions: e.target.value }
                    })}
                    placeholder="What are the key actions for Phase 1? What will you build first?"
                  />
                </div>

                <div>
                  <label className="monument text-sm block mb-2">Quick Wins (30-Day Actions)</label>
                  <textarea
                    value={data.implementation.quickWins || ''}
                    onChange={(e) => setData({
                      ...data,
                      implementation: { ...data.implementation, quickWins: e.target.value }
                    })}
                    placeholder="What can be done in the next 30 days? What quick wins can demonstrate value early?"
                  />
                </div>

                <div>
                  <label className="monument text-sm block mb-2">Resources Needed</label>
                  <textarea
                    value={data.implementation.resourcesNeeded || ''}
                    onChange={(e) => setData({
                      ...data,
                      implementation: { ...data.implementation, resourcesNeeded: e.target.value }
                    })}
                    placeholder="What resources are needed? (e.g., data engineers, cloud infrastructure, software licenses, consultants)"
                  />
                </div>

                <div>
                  <label className="monument text-sm block mb-2">Estimated Cost</label>
                  <input
                    type="text"
                    value={data.implementation.estimatedCost || ''}
                    onChange={(e) => setData({
                      ...data,
                      implementation: { ...data.implementation, estimatedCost: e.target.value }
                    })}
                    placeholder="e.g., $50,000 for Phase 1, $200,000 total"
                  />
                </div>

                <div>
                  <label className="monument text-sm block mb-2">Success Metrics</label>
                  <textarea
                    value={data.implementation.successMetrics || ''}
                    onChange={(e) => setData({
                      ...data,
                      implementation: { ...data.implementation, successMetrics: e.target.value }
                    })}
                    placeholder="How will you measure success? (e.g., decision-making speed improved by 50%, data quality score >90%, user adoption >80%)"
                  />
                </div>
              </div>
            </div>
        </div>
      );
    }

    // Step 5: Canvas
    function Step5Canvas({ data, onBack }) {
      const canvasRef = useRef(null);

      const handleSubmit = async () => {
        const userId = localStorage.getItem('ft_user_id');
        if (!userId) {
          alert('User not authenticated. Please return to the dashboard.');
          return false;
        }

        try {
          const questionMappings = {
            blueprint: {
              decisions: data.decisions,
              dataSources: data.dataSources,
              technology: data.technology,
              apis: data.apis
            },
            implementation_plan: {
              implementation: data.implementation
            }
          };

          await window.AIChallenge.submitWithChallenge(userId, CONFIG.TOOL_SLUG, questionMappings, {
            onReviewStart: () => {},
            onRevise: () => { onBack(); },
            onSubmitAnyway: () => { alert('Digital Heart (Data Lake) plan submitted successfully!'); },
            onError: (err) => { alert('Submission failed: ' + err.message); }
          });
          return true;
        } catch (error) {
          console.error('Supabase submission error:', error);
          alert('Submission failed. Please try again.');
          return false;
        }
      };

      const exportPDF = async () => {
        const canvas = canvasRef.current;
        if (!canvas) return;

        try {
          const jsPDF = window.jspdf.jsPDF;
          const pdf = new jsPDF('p', 'mm', 'a4');

          const sections = canvas.querySelectorAll('.canvas-section');

          for (let i = 0; i < sections.length; i++) {
            if (i > 0) pdf.addPage();

            const section = sections[i];
            const canvas = await html2canvas(section, {
              scale: 2,
              logging: false,
              backgroundColor: '#FFFFFF'
            });

            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 190;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
          }

          pdf.save('digital-heart-data-lake.pdf');
        } catch (error) {
          console.error('PDF export failed:', error);
          alert('Failed to export PDF. Please try again.');
        }
      };

      const decisions = data.decisions || [];
      const dataSources = data.dataSources || [];
      const technology = data.technology || [];
      const apis = data.apis || [];
      const implementation = data.implementation || {};

      const sortedDecisions = [...decisions].sort((a, b) => b.priority - a.priority);

      return (
        <div className="min-h-screen bg-white p-8 md:p-16 animate-in">
          <div className="max-w-6xl mx-auto">
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 5 OF 5
            </div>
            <div className="flex justify-between items-start mb-8">
              <h1 className="plaak text-5xl">
                DIGITAL HEART CANVAS
              </h1>
              <button className="btn-primary" onClick={exportPDF}>
                Export PDF
              </button>
            </div>

            <div ref={canvasRef}>
              {/* Core Decisions Overview */}
              <div className="canvas-section">
                <h2 className="plaak text-3xl mb-6">CORE DECISIONS TO DIGITALIZE</h2>

                <div className="space-y-4">
                  {sortedDecisions.map((decision, index) => (
                    <div key={decision.id} className="border-2 border-black p-4" style={{
                      background: decision.priority >= 8 ? '#FFF469' : '#FFFFFF'
                    }}>
                      <div className="flex items-start gap-4">
                        <div className="riforma-bold text-3xl" style={{ minWidth: '50px' }}>
                          #{index + 1}
                        </div>
                        <div className="flex-1">
                          <h3 className="riforma-bold text-xl mb-2">{decision.decisionName}</h3>
                          <div className="grid grid-cols-3 gap-4 text-sm">
                            <div>
                              <span className="monument text-xs">FREQUENCY:</span>
                              <div>{decision.frequency}</div>
                            </div>
                            <div>
                              <span className="monument text-xs">IMPACT:</span>
                              <div>{decision.impactLevel}</div>
                            </div>
                            <div>
                              <span className="monument text-xs">PRIORITY:</span>
                              <div className="text-2xl riforma-bold">{decision.priority}/10</div>
                            </div>
                          </div>
                          <div className="mt-3">
                            <span className="monument text-xs">CURRENT PROCESS:</span>
                            <p className="text-sm">{decision.currentProcess}</p>
                          </div>
                          <div className="mt-2">
                            <span className="monument text-xs">DATA NEEDED:</span>
                            <p className="text-sm">{decision.dataNeededDescription}</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Data Lake Architecture */}
              <div className="canvas-section">
                <h2 className="plaak text-3xl mb-6">DATA LAKE ARCHITECTURE</h2>

                {decisions.map((decision, index) => {
                  const ds = dataSources.find(d => d.decisionId === decision.id);
                  const tech = technology.find(t => t.decisionId === decision.id);
                  const api = apis.find(a => a.decisionId === decision.id);

                  return (
                    <div key={decision.id} className="mb-8 border-2 border-black p-6">
                      <h3 className="riforma-bold text-2xl mb-6">{decision.decisionName}</h3>

                      {/* Layer 1: Data Sources */}
                      <div className="arch-layer mb-4" data-layer="DATA SOURCES">
                        <div className="grid grid-cols-2 gap-6">
                          <div>
                            <h4 className="monument text-sm mb-3">INTERNAL SOURCES</h4>
                            <div className="space-y-2">
                              {(ds?.internalSources || []).map(source => (
                                <div key={source.id} className="data-tag internal">
                                  {source.source}
                                </div>
                              ))}
                            </div>
                          </div>
                          <div>
                            <h4 className="monument text-sm mb-3">EXTERNAL SOURCES</h4>
                            <div className="space-y-2">
                              {(ds?.externalSources || []).map(source => (
                                <div key={source.id} className="data-tag external">
                                  {source.source}
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Layer 2: Technology Platform */}
                      <div className="arch-layer mb-4" data-layer="TECHNOLOGY PLATFORM">
                        <div className="grid grid-cols-2 gap-6">
                          <div>
                            <h4 className="monument text-sm mb-2">STORAGE</h4>
                            <p className="riforma-bold">{tech?.storageSystem || 'N/A'}</p>
                          </div>
                          <div>
                            <h4 className="monument text-sm mb-2">PROCESSING</h4>
                            <p className="riforma-bold">{tech?.processingFrequency || 'N/A'}</p>
                          </div>
                        </div>
                        <div className="mt-4">
                          <h4 className="monument text-sm mb-2">ALGORITHMS</h4>
                          <div className="space-y-2">
                            {(tech?.algorithms || []).map(alg => (
                              <div key={alg.id} className="text-sm">
                                <span className="riforma-bold">{alg.algorithm}</span> - {alg.purpose}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>

                      {/* Layer 3: Access Layer */}
                      <div className="arch-layer" data-layer="ACCESS LAYER">
                        <div className="grid grid-cols-2 gap-6">
                          <div>
                            <h4 className="monument text-sm mb-2">ACCESS METHODS</h4>
                            <p>{api?.accessMethod || 'N/A'}</p>
                          </div>
                          <div>
                            <h4 className="monument text-sm mb-2">UPDATE FREQUENCY</h4>
                            <p className="riforma-bold">{api?.updateFrequency || 'N/A'}</p>
                          </div>
                        </div>
                        <div className="mt-4">
                          <h4 className="monument text-sm mb-2">API ENDPOINTS</h4>
                          <div className="space-y-1">
                            {(api?.apiEndpoints || []).map(endpoint => (
                              <div key={endpoint.id} className="text-sm">
                                <span className="riforma-bold">{endpoint.endpoint}</span> - {endpoint.purpose}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              {/* Implementation Roadmap */}
              <div className="canvas-section">
                <h2 className="plaak text-3xl mb-6">IMPLEMENTATION ROADMAP</h2>

                <div className="space-y-6">
                  <div className="timeline-item">
                    <div className="timeline-marker active">30D</div>
                    <div className="timeline-content">
                      <h3 className="monument text-sm mb-2">QUICK WINS</h3>
                      <p>{implementation.quickWins || 'Not specified'}</p>
                    </div>
                  </div>

                  <div className="timeline-item">
                    <div className="timeline-marker">P1</div>
                    <div className="timeline-content">
                      <h3 className="monument text-sm mb-2">PHASE 1: {implementation.phase1Timeline || 'Timeline TBD'}</h3>
                      <p>{implementation.phase1Actions || 'Not specified'}</p>
                    </div>
                  </div>

                  <div className="bg-gray-100 p-6 border-2 border-black">
                    <div className="grid grid-cols-2 gap-6">
                      <div>
                        <h4 className="monument text-sm mb-2">RESOURCES NEEDED</h4>
                        <p>{implementation.resourcesNeeded || 'Not specified'}</p>
                      </div>
                      <div>
                        <h4 className="monument text-sm mb-2">ESTIMATED COST</h4>
                        <p className="riforma-bold text-xl">{implementation.estimatedCost || 'Not specified'}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Success Metrics */}
              <div className="canvas-section">
                <h2 className="plaak text-3xl mb-6">SUCCESS METRICS</h2>

                <div className="highlight-box">
                  <p className="text-lg whitespace-pre-line">
                    {implementation.successMetrics || 'Not specified'}
                  </p>
                </div>

                <div className="mt-6 info-box">
                  <h3 className="riforma-bold text-lg mb-3">Key Benefits of Your Digital Heart</h3>
                  <ul className="list-disc list-inside space-y-2">
                    <li>Faster, data-driven decision making</li>
                    <li>Real-time access to critical business insights</li>
                    <li>Improved accuracy and reduced bias in decisions</li>
                    <li>Decentralized access to information across the organization</li>
                    <li>Foundation for AI and machine learning initiatives</li>
                    <li>Competitive advantage through superior data capabilities</li>
                  </ul>
                </div>
              </div>
            </div>

            <div className="mt-12 flex gap-4 justify-center">
              <button className="btn-secondary" onClick={onBack}>
                Back to Edit
              </button>
              <button className="btn-primary" onClick={exportPDF}>
                Export PDF
              </button>
            </div>

            {/* Case Study */}
            <CaseStudy
                before={"A European logistics company had customer data in Salesforce, fleet data in SAP, and route optimization in spreadsheets. Each department ran its own reports. When leadership needed a cross-functional view -- say, which clients were most profitable after accounting for delivery costs -- it took two analysts a full week to manually combine data. Strategic decisions were delayed by months."}
                after={"After implementing a centralized data lake connecting all three systems, with real-time dashboards and automated API feeds, the same cross-functional analysis took 10 minutes. Within 6 months, the company discovered that 12% of their routes were unprofitable, renegotiated contracts, and increased margins by 8%. AI-powered route optimization was layered on top within the first year, reducing fuel costs by an additional 15%."}
                quote={"We thought digitalization meant buying new software. It actually meant connecting the data we already had into one place where it could finally talk to each other. That single shift changed everything. -- CEO, European Logistics Firm"}
            />
          </div>
        </div>
      );
    }

    // Help Modal
    function HelpModal({ step, onClose }) {
      const helpContent = {
        1: {
          title: 'Core Decisions to Digitalize',
          content: (
            <div className="space-y-4">
              <p>Identify decisions that are:</p>
              <ul className="list-disc list-inside space-y-2">
                <li><strong>Frequent:</strong> Made regularly (daily, weekly, monthly)</li>
                <li><strong>High-impact:</strong> Significantly affect business outcomes</li>
                <li><strong>Data-dependent:</strong> Could be improved with better data</li>
              </ul>

              <div className="info-box mt-4">
                <h4 className="riforma-bold mb-2">Examples:</h4>
                <ul className="list-disc list-inside space-y-1">
                  <li>Product pricing strategy</li>
                  <li>Inventory replenishment</li>
                  <li>Marketing budget allocation</li>
                  <li>Hiring decisions</li>
                  <li>Product feature prioritization</li>
                  <li>Customer segment targeting</li>
                  <li>Sales territory assignments</li>
                </ul>
              </div>
            </div>
          )
        },
        2: {
          title: 'Data Sources',
          content: (
            <div className="space-y-4">
              <p>Think broadly about all possible data sources:</p>

              <div className="info-box">
                <h4 className="riforma-bold mb-2">Internal Sources Examples:</h4>
                <ul className="list-disc list-inside space-y-1">
                  <li>CRM (Salesforce, HubSpot)</li>
                  <li>ERP (SAP, Oracle)</li>
                  <li>Financial systems</li>
                  <li>HR databases</li>
                  <li>Production/operations data</li>
                  <li>Customer service records</li>
                  <li>Website analytics</li>
                </ul>
              </div>

              <div className="info-box mt-4">
                <h4 className="riforma-bold mb-2">External Sources Examples:</h4>
                <ul className="list-disc list-inside space-y-1">
                  <li>Market research (Gartner, Forrester)</li>
                  <li>Social media analytics</li>
                  <li>Industry benchmarks</li>
                  <li>Economic indicators</li>
                  <li>Competitor intelligence</li>
                  <li>Weather data</li>
                  <li>Public datasets</li>
                </ul>
              </div>
            </div>
          )
        },
        3: {
          title: 'Technology Platform & Algorithms',
          content: (
            <div className="space-y-4">
              <div className="info-box">
                <h4 className="riforma-bold mb-2">Storage Options:</h4>
                <ul className="list-disc list-inside space-y-1">
                  <li><strong>Cloud:</strong> AWS (S3, Redshift), Azure (Data Lake), Google Cloud (BigQuery), Snowflake</li>
                  <li><strong>On-Premise:</strong> Local data centers, servers</li>
                  <li><strong>Hybrid:</strong> Combination for security and flexibility</li>
                </ul>
              </div>

              <div className="info-box mt-4">
                <h4 className="riforma-bold mb-2">Algorithm Examples:</h4>
                <ul className="list-disc list-inside space-y-1">
                  <li><strong>Regression:</strong> Predicting prices, demand, sales</li>
                  <li><strong>Classification:</strong> Customer segmentation, churn prediction</li>
                  <li><strong>Clustering:</strong> Pattern discovery, grouping similar items</li>
                  <li><strong>Recommendation:</strong> Product suggestions, next best action</li>
                  <li><strong>Time Series:</strong> Forecasting, trend analysis</li>
                </ul>
              </div>
            </div>
          )
        },
        4: {
          title: 'APIs & Access',
          content: (
            <div className="space-y-4">
              <div className="info-box">
                <h4 className="riforma-bold mb-2">Access Method Examples:</h4>
                <ul className="list-disc list-inside space-y-1">
                  <li><strong>Dashboard:</strong> Tableau, Power BI, Looker, custom web dashboards</li>
                  <li><strong>Mobile App:</strong> iOS/Android apps for on-the-go access</li>
                  <li><strong>API Calls:</strong> REST APIs, GraphQL for system integrations</li>
                  <li><strong>Email Reports:</strong> Scheduled automated reports</li>
                  <li><strong>Integrations:</strong> Slack, Teams, other tools</li>
                </ul>
              </div>

              <div className="info-box mt-4">
                <h4 className="riforma-bold mb-2">Best Practices:</h4>
                <ul className="list-disc list-inside space-y-1">
                  <li>Design for user experience first</li>
                  <li>Provide different views for different roles</li>
                  <li>Enable drill-down for detailed analysis</li>
                  <li>Include alerts and notifications</li>
                  <li>Make it mobile-friendly</li>
                  <li>Ensure data security and compliance</li>
                </ul>
              </div>
            </div>
          )
        }
      };

      const content = helpContent[step] || { title: 'Help', content: <p>No help available for this step.</p> };

      return (
        <div className="modal-overlay fade-in" onClick={onClose}>
          <div className="modal-content animate-in" onClick={(e) => e.stopPropagation()}>
            <button className="modal-close" onClick={onClose}>×</button>
            <h2 className="plaak text-3xl mb-6">{content.title}</h2>
            {content.content}
          </div>
        </div>
      );
    }

    // Render App
        ReactDOM.render(<DigitalHeartApp />, document.getElementById('root'));
  </script>
</body>
</html>
