<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Target Segment Deep Dive | Fast Track Program</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>

    <style>
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Riforma', -apple-system, sans-serif;
            font-size: 16px;
            color: #000;
            background: #000;
            -webkit-font-smoothing: antialiased;
        }

        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fff;
            padding: 0 48px;
        }
        .wizard-sidebar {
            width: 280px;
            background: #000;
            border-left: 1px solid #000;
            flex-shrink: 0;
        }
        .wizard-sidebar-inner {
            position: sticky;
            top: 0;
            padding: 32px 24px;
            max-height: 100vh;
            overflow-y: auto;
        }

        .step-content { max-width: 100%; padding: 40px 0; flex: 1; }
        .step-indicator {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #666;
            margin-bottom: 8px;
        }

        .opening-box { margin-bottom: 32px; }
        .opening-box .step-heading {
            font-family: 'Plaak', sans-serif;
            font-weight: bold;
            font-size: 32px;
            letter-spacing: -0.01em;
            line-height: 1.2;
            color: #000;
            margin-bottom: 6px;
        }
        .opening-box .step-hint {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin: 0;
        }

        .questions-grid { display: flex; flex-direction: column; gap: 0; margin-bottom: 32px; }

        .closing-box {
            border-top: 1px solid #E0E0E0;
            padding: 20px 0 0 0;
            margin-top: 8px;
            text-align: center;
        }
        .closing-box p { font-size: 14px; color: #666; }
        .closing-box .closing-title {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 6px;
        }

        .field-group { margin-bottom: 40px; }
        .field-group:last-child { margin-bottom: 0; }
        .field-label {
            font-weight: 600;
            font-size: 16px;
            color: #000;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .field-input {
            border: 1px solid #E0E0E0;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            width: 100%;
            color: #000;
            background: #fff;
            transition: border-color 0.2s ease;
        }
        .field-input:focus { outline: none; border-color: #000; }
        .field-textarea {
            border: 1px solid #E0E0E0;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            width: 100%;
            min-height: 100px;
            resize: vertical;
            color: #000;
            background: #fff;
            transition: border-color 0.2s ease;
        }
        .field-textarea:focus { outline: none; border-color: #000; }
        .field-select {
            border: 1px solid #E0E0E0;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            width: 100%;
            color: #000;
            background: #fff;
            transition: border-color 0.2s ease;
            appearance: auto;
        }
        .field-select:focus { outline: none; border-color: #000; }
        .field-help { font-size: 13px; color: #666; margin-top: 4px; }
        .field-error { font-size: 13px; color: #DC2626; margin-top: 4px; }

        .help-icon-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #E0E0E0;
            border: 1.5px solid #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }
        .help-icon-btn:hover { background: #000; color: #fff; border-color: #000; }

        .help-accordion {
            background: #F5F5F5;
            border: 1px solid #E0E0E0;
            border-left: 3px solid #000;
            padding: 14px 16px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #333;
            line-height: 1.5;
            animation: accordionOpen 0.2s ease-out;
        }
        @keyframes accordionOpen {
            from { opacity: 0; max-height: 0; padding-top: 0; padding-bottom: 0; }
            to { opacity: 1; max-height: 300px; }
        }

        .learn-more-toggle {
            font-family: 'Monument', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            background: #F5F5F5;
            border: 1px solid #E0E0E0;
            cursor: pointer;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 32px;
            transition: background 0.15s ease;
        }
        .learn-more-toggle:hover { background: #EBEBEB; }
        .learn-more-content {
            border-left: 3px solid #000;
            background: #F5F5F5;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #333;
            line-height: 1.7;
        }

        .ft-insight {
            display: flex;
            gap: 14px;
            align-items: flex-start;
            background: #F5F5F5;
            border: 1px solid #E0E0E0;
            border-left: 4px solid #FFF469;
            padding: 16px 20px;
            margin-bottom: 32px;
        }
        .ft-insight-icon {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            background: #FFF469;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ft-insight-label {
            font-family: 'Monument', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 4px;
        }
        .ft-insight-text {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
        }

        .btn-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-top: 1px solid #E0E0E0;
            background: #fff;
            width: 100%;
        }
        .btn-back {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-back:hover { background: #F5F5F5; }
        .btn-next {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E0E0E0; color: #9CA3AF; border-color: #E0E0E0; cursor: not-allowed; }

        .sidebar-step-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }

        .numbered-section { background: #000; color: #fff; padding: 8px 14px; font-size: 14px; font-weight: bold; letter-spacing: 0.5px; display: inline-block; font-family: 'Monument', monospace; }
        .canvas-section-box { background: #FAFAFA; border-left: 4px solid #000; padding: 20px; margin-bottom: 16px; }

        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E0E0E0; background: #F5F5F5; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E0E0E0; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }

        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }

        @media print { .no-print { display: none !important; } }

        @media (min-width: 769px) and (max-width: 1024px) {
            .wizard-sidebar { width: 220px; }
            .wizard-sidebar-inner { padding: 24px 16px; }
        }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .mobile-step-bar { display: block; }
            .step-content { padding: 20px 16px; }
            .opening-box .step-heading { font-size: 24px; }
            .btn-footer { padding: 12px 16px; }
            .wizard-main { padding: 0 16px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /* ============================================================
           CONFIG
           ============================================================ */
        const CONFIG = {
            SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
            TOOL_SLUG: 'target-segment',
            TOOL_TITLE: 'TARGET SEGMENT DEEP DIVE',
            TIME_ESTIMATE: '~45 min',
            COVER_IMAGE: 'cover.jpg',
            AUTOSAVE_DELAY: 2000,
            STEPS: [
                { num: 1, label: 'Interview Guide' },
                { num: 2, label: 'Interview Notes' },
                { num: 3, label: 'Prioritization' },
                { num: 4, label: 'Summary' }
            ],
            CLOSING_MESSAGES: {
                1: { title: 'INTERVIEW GUIDE READY', text: 'Your questions are set. Next: go talk to real customers.' },
                2: { title: 'INTERVIEWS CAPTURED', text: 'Raw data collected. Next: prioritize what matters most.' },
                3: { title: 'PRIORITIES RANKED', text: 'Your matrices are scored. Next: synthesize the insights.' },
                4: { title: 'ALL STEPS COMPLETE', text: 'Your deep dive is ready. View your canvas.' }
            }
        };

        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        window.supabaseClient = supabaseClient;
        ToolDB.init(CONFIG.TOOL_SLUG);
        DependencyInjection.init(CONFIG.TOOL_SLUG);
        CognitiveLoad.init(CONFIG.TOOL_SLUG);

        /* ============================================================
           REUSABLE COMPONENTS
           ============================================================ */

        function CheckIcon({ color = "#fff", size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
        }

        function LightbulbIcon({ size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill="#000"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>;
        }

        function LearnMore({ children }) {
            const [open, setOpen] = useState(false);
            return (
                <div style={{ marginBottom: open ? 0 : 12 }}>
                    <button className="learn-more-toggle" onClick={() => setOpen(!open)}>WHY THIS MATTERS {open ? '\u2212' : '+'}</button>
                    {open && <div className="learn-more-content">{children}</div>}
                </div>
            );
        }

        function FastTrackInsight({ children, label = 'Fast Track Insight' }) {
            return (
                <div className="ft-insight">
                    <div className="ft-insight-icon"><LightbulbIcon size={16} /></div>
                    <div>
                        <div className="ft-insight-label">{label}</div>
                        <div className="ft-insight-text">{children}</div>
                    </div>
                </div>
            );
        }

        function HelpAccordion({ id, activeHelp, setActiveHelp, children }) {
            const isOpen = activeHelp === id;
            return (
                <>
                    <button className="help-icon-btn" onClick={() => setActiveHelp(isOpen ? null : id)} title="Help">?</button>
                    {isOpen && <div className="help-accordion" style={{ marginTop: 6 }}>{children}</div>}
                </>
            );
        }

        function ButtonFooter({ onBack, onNext, nextLabel = 'Next', canProceed, showBack = true }) {
            return (
                <div className="btn-footer no-print">
                    {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                    <button className="btn-next" disabled={!canProceed} onClick={onNext}>{nextLabel} &rarr;</button>
                </div>
            );
        }

        function MobileStepBar({ currentStep, totalSteps }) {
            const progress = currentStep >= 999 ? 100 : Math.round((currentStep / totalSteps) * 100);
            return (
                <div className="mobile-step-bar no-print">
                    <div className="bar-text">Step {Math.min(currentStep, totalSteps)} of {totalSteps}</div>
                    <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${progress}%` }} /></div>
                </div>
            );
        }

        function WizardSidebar({ currentStep, steps, toolTitle, timeEstimate, getSnippet, onNavigate }) {
            return (
                <div className="wizard-sidebar no-print">
                    <div className="wizard-sidebar-inner">
                        <div style={{ marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>{toolTitle}</div>
                            <div style={{ fontSize: 13, color: '#999' }}>{timeEstimate}</div>
                        </div>
                        <div style={{ marginBottom: 16, fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#999' }}>Your journey</div>
                        {steps.map(s => {
                            const isCompleted = currentStep > s.num, isActive = currentStep === s.num, isLocked = currentStep < s.num;
                            const snippet = isCompleted && getSnippet ? getSnippet(s.num) : null;
                            return (
                                <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                                    onClick={() => isCompleted && onNavigate && onNavigate(s.num)}
                                    title={isCompleted ? 'Click to review this step' : ''}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                        {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                                        <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                                    </div>
                                    {snippet && <div className="sidebar-snippet">{snippet}</div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }


        /* ============================================================
           MAIN TOOL
           ============================================================ */

        function ToolApp() {
            const [step, setStep] = useState(0);
            const [questionHelp, setQuestionHelp] = useState(null);
            const [authState, setAuthState] = useState({ loading: true, authenticated: false, user: null, progress: null, error: null });
            const [submitStatus, setSubmitStatus] = useState(null);
            const [submitMessage, setSubmitMessage] = useState('');

            /* ── Data state ── */
            const [data, setData] = useState({
                companyId: '', userId: '',
                // Step 1: Interview Guide
                targetSegment: '',
                interviewObjective: '',
                interviewQuestions: [
                    { category: 'Past Behavior', question: '' },
                    { category: 'Specific Challenges', question: '' },
                    { category: 'Current Solutions', question: '' }
                ],
                // Step 2: Interview Notes
                interviews: [{ customerName: '', customerProfile: '', pains: '', needs: '', gains: '', quotes: '', observations: '' }],
                // Step 3: Prioritization
                painsPriority: [{ pain: '', severity: '', frequency: '', impact: '' }],
                needsPriority: [{ need: '', severity: '', frequency: '', impact: '' }],
                gainsPriority: [{ gain: '', severity: '', frequency: '', impact: '' }],
                // Step 4: Summary
                coreCustomer: '',
                topPains: '', topNeeds: '', topGains: '',
                keyInsights: '', strategicImplications: ''
            });

            const autosaveTimer = useRef(null);
            const updateData = (key, value) => setData(prev => ({ ...prev, [key]: value }));

            /* ── Validation ── */
            const totalSteps = CONFIG.STEPS.length;
            const canProceedStep1 = data.targetSegment.length >= 20 && data.interviewObjective.length >= 10 && data.interviewQuestions.filter(q => q.question.length > 5).length >= 3;
            const canProceedStep2 = data.interviews.length >= 1 && data.interviews.every(i => i.customerName && i.pains.length > 5 && i.needs.length > 5 && i.gains.length > 5);
            const canProceedStep3 = data.painsPriority.length >= 1 && data.painsPriority.every(p => p.pain && p.severity && p.frequency && p.impact)
                && data.needsPriority.length >= 1 && data.needsPriority.every(n => n.need && n.severity && n.frequency && n.impact)
                && data.gainsPriority.length >= 1 && data.gainsPriority.every(g => g.gain && g.severity && g.frequency && g.impact);
            const canProceedStep4 = data.topPains.length >= 10 && data.topNeeds.length >= 10 && data.topGains.length >= 10 && data.keyInsights.length >= 10;

            /* ── Sidebar snippets ── */
            const getSnippet = (n) => {
                if (n === 1 && data.targetSegment) return '"' + data.targetSegment.substring(0, 50) + (data.targetSegment.length > 50 ? '...' : '') + '"';
                if (n === 2) { const count = data.interviews.filter(i => i.customerName).length; return count + ' interview' + (count !== 1 ? 's' : '') + ' recorded'; }
                if (n === 3) return data.painsPriority.length + ' pains, ' + data.needsPriority.length + ' needs, ' + data.gainsPriority.length + ' gains';
                if (n === 4 && data.topPains) return 'Summary complete';
                return null;
            };

            /* ── Auth (handled by ToolDB.init → identifyUser) ── */
            useEffect(() => {
                setAuthState({ loading: false, authenticated: true, user: null, progress: { completed_tools: [], unlocked_tools: [CONFIG.TOOL_SLUG] }, isUnlocked: true, isCompleted: false, error: null });
            }, []);

            /* ── Tool access control ── */
            useEffect(() => {
                if (authState.authenticated && authState.progress && window.toolAccessControl) {
                    window.toolAccessControl.initialize(authState.progress, CONFIG.TOOL_SLUG, CONFIG.SPRINT_NUMBER);
                }
            }, [authState.authenticated]);

            /* ── Auto-save to localStorage ── */
            useEffect(() => {
                if (step < 1) return;
                clearTimeout(autosaveTimer.current);
                autosaveTimer.current = setTimeout(() => {
                    localStorage.setItem(`ft_${CONFIG.TOOL_SLUG}_autosave`, JSON.stringify({ step, data, savedAt: new Date().toISOString() }));
                    console.log(`[${CONFIG.TOOL_SLUG}] Auto-saved`);
                }, CONFIG.AUTOSAVE_DELAY);
                return () => clearTimeout(autosaveTimer.current);
            }, [data, step]);

            /* ── Load saved data ── */
            useEffect(() => {
                try {
                    const saved = localStorage.getItem(`ft_${CONFIG.TOOL_SLUG}_autosave`);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        if (parsed.data) {
                            setData(prev => ({ ...prev, ...parsed.data }));
                            if (parsed.step) setStep(parsed.step);
                            console.log(`[${CONFIG.TOOL_SLUG}] Restored from auto-save`);
                        }
                    }
                } catch (e) { console.warn('Failed to restore auto-save:', e); }
            }, []);

            /* ── Submit to Supabase ── */
            const handleSubmit = async () => {
                try {
                    setSubmitStatus('saving');
                    setSubmitMessage('');
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) { setSubmitStatus('error'); setSubmitMessage('User not authenticated.'); return; }

                    const questionMappings = {
                        pains_matrix: { painsPriority: data.painsPriority, needsPriority: data.needsPriority, gainsPriority: data.gainsPriority },
                        persona: { targetSegment: data.targetSegment, coreCustomer: data.coreCustomer },
                        needs_gains: { topPains: data.topPains, topNeeds: data.topNeeds, topGains: data.topGains },
                        interview_summary: { interviews: data.interviews, keyInsights: data.keyInsights, strategicImplications: data.strategicImplications }
                    };
                    await ToolDB.save(userId, questionMappings);
                    await ToolDB.markComplete(userId);

                    setSubmitStatus('success');
                    setSubmitMessage('Submission saved successfully!');
                } catch (error) {
                    console.error(`[${CONFIG.TOOL_SLUG} Submit] Error:`, error);
                    setSubmitStatus('error');
                    setSubmitMessage('Failed to save: ' + error.message);
                }
            };

            /* ── PDF Export ── */
            const handleExport = async (e) => {
                try {
                    const btn = e.target; btn.disabled = true; btn.textContent = 'Generating...';
                    const { jsPDF } = window.jspdf;
                    const el = document.getElementById('canvas-content');
                    if (!el) throw new Error('Canvas not found.');
                    const canvas = await html2canvas(el, { scale: 2, useCORS: false, backgroundColor: '#fff', logging: false });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfW = pdf.internal.pageSize.getWidth(), pdfH = pdf.internal.pageSize.getHeight();
                    const imgW = pdfW - 20, imgH = (canvas.height * imgW) / canvas.width;
                    if (imgH <= pdfH - 20) {
                        pdf.addImage(imgData, 'PNG', 10, 10, imgW, imgH);
                    } else {
                        let srcY = 0;
                        while (srcY < canvas.height) {
                            const sliceH = Math.min(canvas.height - srcY, (canvas.width * (pdfH - 20)) / imgW);
                            const sliceCanvas = document.createElement('canvas'); sliceCanvas.width = canvas.width; sliceCanvas.height = sliceH;
                            sliceCanvas.getContext('2d').drawImage(canvas, 0, srcY, canvas.width, sliceH, 0, 0, canvas.width, sliceH);
                            pdf.addImage(sliceCanvas.toDataURL('image/png'), 'PNG', 10, 10, imgW, (sliceH * imgW) / canvas.width);
                            srcY += sliceH;
                            if (srcY < canvas.height) pdf.addPage();
                        }
                    }
                    pdf.save(`${CONFIG.TOOL_SLUG}-canvas.pdf`);
                    btn.disabled = false; btn.textContent = 'Export PDF';
                } catch (err) { alert('PDF export failed: ' + err.message); e.target.disabled = false; e.target.textContent = 'Export PDF'; }
            };

            /* ── Array helpers ── */
            const updateInterviewQuestion = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    interviewQuestions: prev.interviewQuestions.map((q, i) => i === index ? { ...q, [field]: value } : q)
                }));
            };
            const addInterviewQuestion = () => {
                if (data.interviewQuestions.length >= 8) return;
                setData(prev => ({ ...prev, interviewQuestions: [...prev.interviewQuestions, { category: '', question: '' }] }));
            };
            const removeInterviewQuestion = (index) => {
                if (data.interviewQuestions.length <= 3) return;
                setData(prev => ({ ...prev, interviewQuestions: prev.interviewQuestions.filter((_, i) => i !== index) }));
            };

            const updateInterview = (index, field, value) => {
                setData(prev => ({
                    ...prev,
                    interviews: prev.interviews.map((interview, i) => i === index ? { ...interview, [field]: value } : interview)
                }));
            };
            const addInterview = () => {
                if (data.interviews.length >= 5) return;
                setData(prev => ({ ...prev, interviews: [...prev.interviews, { customerName: '', customerProfile: '', pains: '', needs: '', gains: '', quotes: '', observations: '' }] }));
            };
            const removeInterview = (index) => {
                if (data.interviews.length <= 1) return;
                setData(prev => ({ ...prev, interviews: prev.interviews.filter((_, i) => i !== index) }));
            };

            const updatePriority = (type, index, field, value) => {
                setData(prev => ({
                    ...prev,
                    [type]: prev[type].map((item, i) => i === index ? { ...item, [field]: value } : item)
                }));
            };
            const addPriority = (type, emptyItem) => {
                if (data[type].length >= 8) return;
                setData(prev => ({ ...prev, [type]: [...prev[type], emptyItem] }));
            };
            const removePriority = (type, index) => {
                if (data[type].length <= 1) return;
                setData(prev => ({ ...prev, [type]: prev[type].filter((_, i) => i !== index) }));
            };

            const calcScore = (item) => {
                const s = parseInt(item.severity) || 0;
                const f = parseInt(item.frequency) || 0;
                const imp = parseInt(item.impact) || 0;
                return (s + f + imp) * 2;
            };

            /* ============================================================
               RENDER
               ============================================================ */
            return (
                <div className="tool-frame">
                    <div className="tool-inner">

                        {/* Loading */}
                        {authState.loading && (
                            <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#000' }}>
                                <div style={{ textAlign: 'center', color: '#fff' }}>
                                    <div className="plaak" style={{ fontSize: 32, marginBottom: 12 }}>Loading...</div>
                                </div>
                            </div>
                        )}

                        {/* Auth error */}
                        {!authState.loading && !authState.authenticated && (
                            <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#000' }}>
                                <div style={{ textAlign: 'center', color: '#fff', padding: '0 32px', maxWidth: 640 }}>
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 24 }}>AUTHENTICATION REQUIRED</h1>
                                    <p style={{ fontSize: 20, marginBottom: 32 }}>Please access this tool from your LearnWorlds course.</p>
                                    <p style={{ fontSize: 16, color: '#999' }}>{authState.error || 'No active session found'}</p>
                                </div>
                            </div>
                        )}

                        {/* ── STEP 0: Cover ── */}
                        {step === 0 && authState.authenticated && (
                            <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                                <div style={{ position: 'absolute', inset: 0, backgroundImage: `url(${CONFIG.COVER_IMAGE})`, backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.5 }} />
                                <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                                    <h1 className="plaak" style={{ fontSize: 80, marginBottom: 16 }}>{CONFIG.TOOL_TITLE}</h1>
                                    <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48 }}>Uncover what your target customers truly need</p>
                                    <button onClick={() => setStep(0.5)} style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }}
                                        onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                        onMouseOut={e => { e.target.style.background = '#fff'; }}
                                    >START</button>
                                </div>
                            </div>
                        )}

                        {/* ── STEP 0.5: Setup ── */}
                        {step === 0.5 && (
                            <div style={{ minHeight: '100vh', background: '#fff', display: 'flex', flexDirection: 'column', padding: '0 48px' }}>
                                <div className="step-content animate-in" style={{ maxWidth: 560, margin: '0 auto' }}>
                                    <p className="step-indicator">SETUP</p>
                                    <div className="opening-box">
                                        <h1 className="step-heading">Before We Start</h1>
                                        <p className="step-hint">This tool guides you through customer interviews and prioritization to build a deep understanding of your target segment's pains, needs, and gains.</p>
                                    </div>

                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 24 }}>
                                        <div className="field-group">
                                            <label className="field-label">Company ID</label>
                                            <input type="text" className="field-input" value={data.companyId} onChange={e => updateData('companyId', e.target.value)} placeholder="Enter company ID" />
                                        </div>
                                        <div className="field-group">
                                            <label className="field-label">Username ID</label>
                                            <input type="text" className="field-input" value={data.userId} onChange={e => updateData('userId', e.target.value)} placeholder="Enter username ID" />
                                        </div>
                                    </div>
                                </div>
                                <div className="btn-footer no-print">
                                    <button className="btn-back" onClick={() => setStep(0)}>&larr; Back</button>
                                    <button className="btn-next" disabled={!data.companyId || !data.userId} onClick={() => setStep(1)}>Let's Start &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* ── STEPS 1–4: Wizard ── */}
                        {step >= 1 && step <= totalSteps && (
                            <div className="wizard-layout">
                                <div className="wizard-main">
                                    <MobileStepBar currentStep={step} totalSteps={totalSteps} />

                                    {/* ── STEP 1: Interview Guide ── */}
                                    {step === 1 && (
                                        <div className="step-content animate-in">
                                            <p className="step-indicator">STEP 1 OF {totalSteps}</p>
                                            <div className="opening-box">
                                                <h1 className="step-heading">Interview Guide</h1>
                                                <p className="step-hint">Define your target segment and prepare interview questions that reveal real behaviors.</p>
                                            </div>

                                            <LearnMore>
                                                Understanding your customers' pains, needs, and gains is the cornerstone of a successful strategy. By conducting interviews guided by The Mom Test principles, you gather real behavioral evidence rather than assumptions.
                                            </LearnMore>

                                            <FastTrackInsight>
                                                Focus on behaviors, not opinions. Ask about the past, not hypothetical futures. The Mom Test: even your mom would lie to avoid hurting your feelings.
                                            </FastTrackInsight>

                                            <div className="questions-grid">
                                                <div className="field-group">
                                                    <label className="field-label">
                                                        Target Segment Description
                                                        <HelpAccordion id="targetSegment" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                                            Describe WHO you are targeting: demographics, firmographics, behaviors, and characteristics that define this customer group.
                                                        </HelpAccordion>
                                                    </label>
                                                    <textarea className="field-textarea" value={data.targetSegment} onChange={e => updateData('targetSegment', e.target.value)} placeholder="e.g. SME owners in manufacturing sector, 20-100 employees, actively seeking digital transformation, based in DACH region..." maxLength={500} />
                                                    <p className="field-help">{data.targetSegment.length}/500 (min 20)</p>
                                                </div>

                                                <div className="field-group">
                                                    <label className="field-label">
                                                        Interview Objective
                                                        <HelpAccordion id="interviewObj" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                                            What specific insight are you hoping to validate or discover through these interviews?
                                                        </HelpAccordion>
                                                    </label>
                                                    <textarea className="field-textarea" style={{ minHeight: 80 }} value={data.interviewObjective} onChange={e => updateData('interviewObjective', e.target.value)} placeholder="e.g. Understand the biggest operational pain points that prevent SMEs from scaling..." maxLength={300} />
                                                    <p className="field-help">{data.interviewObjective.length}/300 (min 10)</p>
                                                </div>

                                                <div className="field-group">
                                                    <label className="field-label">Interview Questions (min 3)</label>
                                                    {data.interviewQuestions.map((q, idx) => (
                                                        <div key={idx} style={{ display: 'flex', gap: 12, marginBottom: 12, alignItems: 'flex-start' }}>
                                                            <div style={{ flex: '0 0 160px' }}>
                                                                <input type="text" className="field-input" value={q.category} onChange={e => updateInterviewQuestion(idx, 'category', e.target.value)} placeholder="Category" style={{ fontSize: 14 }} />
                                                            </div>
                                                            <div style={{ flex: 1 }}>
                                                                <input type="text" className="field-input" value={q.question} onChange={e => updateInterviewQuestion(idx, 'question', e.target.value)} placeholder={idx === 0 ? '"Tell me about the last time you..."' : idx === 1 ? '"What\'s the hardest part about..."' : '"How do you currently handle..."'} />
                                                            </div>
                                                            {data.interviewQuestions.length > 3 && (
                                                                <button onClick={() => removeInterviewQuestion(idx)} style={{ background: 'none', border: 'none', fontSize: 18, cursor: 'pointer', color: '#999', padding: '12px 4px' }}>&times;</button>
                                                            )}
                                                        </div>
                                                    ))}
                                                    {data.interviewQuestions.length < 8 && (
                                                        <button onClick={addInterviewQuestion} style={{ width: '100%', padding: '10px 0', border: '2px dashed #E0E0E0', background: 'none', fontSize: 14, cursor: 'pointer', color: '#666', marginTop: 4 }}>
                                                            + Add Question
                                                        </button>
                                                    )}
                                                </div>
                                            </div>

                                            {canProceedStep1 && (
                                                <div className="closing-box animate-in">
                                                    <p className="closing-title">{CONFIG.CLOSING_MESSAGES[1].title}</p>
                                                    <p>{CONFIG.CLOSING_MESSAGES[1].text}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* ── STEP 2: Interview Notes ── */}
                                    {step === 2 && (
                                        <div className="step-content animate-in">
                                            <p className="step-indicator">STEP 2 OF {totalSteps}</p>
                                            <div className="opening-box">
                                                <h1 className="step-heading">Interview Notes</h1>
                                                <p className="step-hint">Capture real data from 1–5 customer interviews. Focus on specifics, not generalities.</p>
                                            </div>

                                            <LearnMore>
                                                The interviews capture raw qualitative data — specific behaviors, quotes, and profile validations. Data from customers who don't fit the target segment contaminates the strategy.
                                            </LearnMore>

                                            <FastTrackInsight>
                                                Look for workarounds — what customers already do to solve their problems is a clue to their priorities. Seek specific stories, not general feedback.
                                            </FastTrackInsight>

                                            <div className="questions-grid">
                                                {data.interviews.map((interview, idx) => (
                                                    <div key={idx} style={{ border: '1px solid #E0E0E0', padding: 24, marginBottom: 24, background: '#FAFAFA' }}>
                                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                                            <span className="monument" style={{ fontSize: 11, textTransform: 'uppercase', color: '#666' }}>INTERVIEW {idx + 1}</span>
                                                            {data.interviews.length > 1 && (
                                                                <button onClick={() => removeInterview(idx)} style={{ background: 'none', border: 'none', fontSize: 18, cursor: 'pointer', color: '#999' }}>&times;</button>
                                                            )}
                                                        </div>

                                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 16 }}>
                                                            <div>
                                                                <label className="field-label">Customer Name</label>
                                                                <input type="text" className="field-input" value={interview.customerName} onChange={e => updateInterview(idx, 'customerName', e.target.value)} placeholder="Name or identifier" />
                                                            </div>
                                                            <div>
                                                                <label className="field-label">
                                                                    Profile Fit
                                                                    <HelpAccordion id={`profileFit${idx}`} activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                                                        Does this person match your target segment description? Note key characteristics.
                                                                    </HelpAccordion>
                                                                </label>
                                                                <input type="text" className="field-input" value={interview.customerProfile} onChange={e => updateInterview(idx, 'customerProfile', e.target.value)} placeholder="e.g. CEO, 50 employees, manufacturing" />
                                                            </div>
                                                        </div>

                                                        <div className="field-group" style={{ marginBottom: 16 }}>
                                                            <label className="field-label">Pains (what frustrates them?)</label>
                                                            <textarea className="field-textarea" style={{ minHeight: 70 }} value={interview.pains} onChange={e => updateInterview(idx, 'pains', e.target.value)} placeholder="What problems, frustrations, and undesirable outcomes did they describe?" />
                                                        </div>

                                                        <div className="field-group" style={{ marginBottom: 16 }}>
                                                            <label className="field-label">Needs (what do they require?)</label>
                                                            <textarea className="field-textarea" style={{ minHeight: 70 }} value={interview.needs} onChange={e => updateInterview(idx, 'needs', e.target.value)} placeholder="What functional, social, or emotional jobs are they trying to get done?" />
                                                        </div>

                                                        <div className="field-group" style={{ marginBottom: 16 }}>
                                                            <label className="field-label">Gains (what do they desire?)</label>
                                                            <textarea className="field-textarea" style={{ minHeight: 70 }} value={interview.gains} onChange={e => updateInterview(idx, 'gains', e.target.value)} placeholder="What outcomes, benefits, or aspirations excite them?" />
                                                        </div>

                                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                                            <div className="field-group" style={{ marginBottom: 0 }}>
                                                                <label className="field-label">Key Quotes</label>
                                                                <textarea className="field-textarea" style={{ minHeight: 60 }} value={interview.quotes} onChange={e => updateInterview(idx, 'quotes', e.target.value)} placeholder="Exact words they used..." />
                                                            </div>
                                                            <div className="field-group" style={{ marginBottom: 0 }}>
                                                                <label className="field-label">Observations</label>
                                                                <textarea className="field-textarea" style={{ minHeight: 60 }} value={interview.observations} onChange={e => updateInterview(idx, 'observations', e.target.value)} placeholder="Body language, emotions, workarounds..." />
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}

                                                {data.interviews.length < 5 && (
                                                    <button onClick={addInterview} style={{ width: '100%', padding: '12px 0', border: '2px dashed #E0E0E0', background: 'none', fontSize: 14, cursor: 'pointer', color: '#666' }}>
                                                        + Add Interview ({data.interviews.length}/5)
                                                    </button>
                                                )}
                                            </div>

                                            {canProceedStep2 && (
                                                <div className="closing-box animate-in">
                                                    <p className="closing-title">{CONFIG.CLOSING_MESSAGES[2].title}</p>
                                                    <p>{CONFIG.CLOSING_MESSAGES[2].text}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* ── STEP 3: Prioritization Matrices ── */}
                                    {step === 3 && (
                                        <div className="step-content animate-in">
                                            <p className="step-indicator">STEP 3 OF {totalSteps}</p>
                                            <div className="opening-box">
                                                <h1 className="step-heading">Prioritization Matrices</h1>
                                                <p className="step-hint">Score each pain, need, and gain by severity, frequency, and impact. The vital few rise to the top.</p>
                                            </div>

                                            <LearnMore>
                                                The prioritization matrices convert qualitative insights into ranked opportunities. Items that are severe, frequent, AND impactful rise to the top.
                                            </LearnMore>

                                            <FastTrackInsight>
                                                Score = (Severity + Frequency + Impact) &times; 2. Select only the Top 3 from each matrix — the vital few that represent highest-value opportunities.
                                            </FastTrackInsight>

                                            {/* Pains Matrix */}
                                            <div style={{ marginBottom: 40 }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
                                                    <span className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#000', background: '#FFF469', padding: '4px 10px' }}>PAINS MATRIX</span>
                                                </div>
                                                <PriorityMatrix
                                                    items={data.painsPriority}
                                                    itemKey="pain"
                                                    itemLabel="Pain"
                                                    itemPlaceholder="e.g. No visibility into cash flow"
                                                    onUpdate={(idx, field, val) => updatePriority('painsPriority', idx, field, val)}
                                                    onAdd={() => addPriority('painsPriority', { pain: '', severity: '', frequency: '', impact: '' })}
                                                    onRemove={(idx) => removePriority('painsPriority', idx)}
                                                    calcScore={calcScore}
                                                />
                                            </div>

                                            {/* Needs Matrix */}
                                            <div style={{ marginBottom: 40 }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
                                                    <span className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#000', background: '#F5F5F5', padding: '4px 10px', border: '1px solid #E0E0E0' }}>NEEDS MATRIX</span>
                                                </div>
                                                <PriorityMatrix
                                                    items={data.needsPriority}
                                                    itemKey="need"
                                                    itemLabel="Need"
                                                    itemPlaceholder="e.g. Real-time financial dashboard"
                                                    onUpdate={(idx, field, val) => updatePriority('needsPriority', idx, field, val)}
                                                    onAdd={() => addPriority('needsPriority', { need: '', severity: '', frequency: '', impact: '' })}
                                                    onRemove={(idx) => removePriority('needsPriority', idx)}
                                                    calcScore={calcScore}
                                                />
                                            </div>

                                            {/* Gains Matrix */}
                                            <div style={{ marginBottom: 32 }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 }}>
                                                    <span className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#000', background: '#F5F5F5', padding: '4px 10px', border: '1px solid #E0E0E0' }}>GAINS MATRIX</span>
                                                </div>
                                                <PriorityMatrix
                                                    items={data.gainsPriority}
                                                    itemKey="gain"
                                                    itemLabel="Gain"
                                                    itemPlaceholder="e.g. Confident decision-making"
                                                    onUpdate={(idx, field, val) => updatePriority('gainsPriority', idx, field, val)}
                                                    onAdd={() => addPriority('gainsPriority', { gain: '', severity: '', frequency: '', impact: '' })}
                                                    onRemove={(idx) => removePriority('gainsPriority', idx)}
                                                    calcScore={calcScore}
                                                />
                                            </div>

                                            {canProceedStep3 && (
                                                <div className="closing-box animate-in">
                                                    <p className="closing-title">{CONFIG.CLOSING_MESSAGES[3].title}</p>
                                                    <p>{CONFIG.CLOSING_MESSAGES[3].text}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* ── STEP 4: Summary ── */}
                                    {step === 4 && (
                                        <div className="step-content animate-in">
                                            <p className="step-indicator">STEP 4 OF {totalSteps}</p>
                                            <div className="opening-box">
                                                <h1 className="step-heading">Summary</h1>
                                                <p className="step-hint">Synthesize your findings into a single source of truth for your value proposition.</p>
                                            </div>

                                            <LearnMore>
                                                The summary aggregates your final decisions into a single source of truth. It forces focus on the vital few priorities using the 80/20 rule.
                                            </LearnMore>

                                            <FastTrackInsight>
                                                This summary answers: "Who are we serving and what matters most to them?" It's the foundational block for your value proposition.
                                            </FastTrackInsight>

                                            <div className="questions-grid">
                                                <div className="field-group">
                                                    <label className="field-label">
                                                        Core Customer Description
                                                        <HelpAccordion id="coreCustomer" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                                            Write a concise profile of your ideal customer based on interview evidence. Who are they? What defines them?
                                                        </HelpAccordion>
                                                    </label>
                                                    <textarea className="field-textarea" value={data.coreCustomer} onChange={e => updateData('coreCustomer', e.target.value)} placeholder="Based on our interviews, our core customer is..." maxLength={500} />
                                                    <p className="field-help">{data.coreCustomer.length}/500</p>
                                                </div>

                                                <div className="field-group">
                                                    <label className="field-label">Top 3 Pains</label>
                                                    <textarea className="field-textarea" value={data.topPains} onChange={e => updateData('topPains', e.target.value)} placeholder="1. &#10;2. &#10;3. " maxLength={500} />
                                                    <p className="field-help">{data.topPains.length}/500 (min 10)</p>
                                                </div>

                                                <div className="field-group">
                                                    <label className="field-label">Top 3 Needs</label>
                                                    <textarea className="field-textarea" value={data.topNeeds} onChange={e => updateData('topNeeds', e.target.value)} placeholder="1. &#10;2. &#10;3. " maxLength={500} />
                                                    <p className="field-help">{data.topNeeds.length}/500 (min 10)</p>
                                                </div>

                                                <div className="field-group">
                                                    <label className="field-label">Top 3 Gains</label>
                                                    <textarea className="field-textarea" value={data.topGains} onChange={e => updateData('topGains', e.target.value)} placeholder="1. &#10;2. &#10;3. " maxLength={500} />
                                                    <p className="field-help">{data.topGains.length}/500 (min 10)</p>
                                                </div>

                                                <div className="field-group">
                                                    <label className="field-label">
                                                        Key Insights
                                                        <HelpAccordion id="keyInsights" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                                            What patterns or surprises emerged? What did you learn that you didn't expect?
                                                        </HelpAccordion>
                                                    </label>
                                                    <textarea className="field-textarea" value={data.keyInsights} onChange={e => updateData('keyInsights', e.target.value)} placeholder="The most surprising finding was..." maxLength={500} />
                                                    <p className="field-help">{data.keyInsights.length}/500 (min 10)</p>
                                                </div>

                                                <div className="field-group">
                                                    <label className="field-label">
                                                        Strategic Implications
                                                        <HelpAccordion id="stratImpl" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                                            What does this mean for your business? How should this shape your value proposition and go-to-market?
                                                        </HelpAccordion>
                                                    </label>
                                                    <textarea className="field-textarea" value={data.strategicImplications} onChange={e => updateData('strategicImplications', e.target.value)} placeholder="Based on these findings, we should..." maxLength={500} />
                                                    <p className="field-help">{data.strategicImplications.length}/500</p>
                                                </div>
                                            </div>

                                            {canProceedStep4 && (
                                                <div className="closing-box animate-in">
                                                    <p className="closing-title">{CONFIG.CLOSING_MESSAGES[4].title}</p>
                                                    <p>{CONFIG.CLOSING_MESSAGES[4].text}</p>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <ButtonFooter
                                        onBack={() => setStep(step === 1 ? 0.5 : step - 1)}
                                        onNext={() => setStep(step === totalSteps ? 999 : step + 1)}
                                        canProceed={step === 1 ? canProceedStep1 : step === 2 ? canProceedStep2 : step === 3 ? canProceedStep3 : canProceedStep4}
                                        nextLabel={step === totalSteps ? 'View Your Canvas' : 'Next'}
                                        showBack={true}
                                    />
                                </div>
                                <WizardSidebar
                                    currentStep={step}
                                    steps={CONFIG.STEPS}
                                    toolTitle={CONFIG.TOOL_TITLE}
                                    timeEstimate={CONFIG.TIME_ESTIMATE}
                                    getSnippet={getSnippet}
                                    onNavigate={setStep}
                                />
                            </div>
                        )}

                        {/* ── STEP 999: Canvas / Results ── */}
                        {step === 999 && (
                            <div style={{ minHeight: '100vh', background: '#fff' }}>
                                <header className="no-print" style={{ borderBottom: '2px solid #000', padding: '16px 24px' }}>
                                    <div style={{ maxWidth: 960, margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <div>
                                            <h1 className="plaak" style={{ fontSize: 28, marginBottom: 4 }}>YOUR TARGET SEGMENT CANVAS</h1>
                                            <p style={{ fontSize: 14, color: '#666' }}>Who are we serving and what matters most to them?</p>
                                        </div>
                                        <button onClick={() => setStep(totalSteps)} className="btn-back">&larr; Edit</button>
                                    </div>
                                </header>

                                <div style={{ maxWidth: 960, margin: '0 auto', padding: '32px 24px' }}>
                                    <div id="canvas-content" style={{ border: '2px solid #000', padding: 32, marginBottom: 24 }}>

                                        {/* Section 1: Target Segment */}
                                        <div style={{ marginBottom: 32 }}>
                                            <div className="numbered-section" style={{ marginBottom: 12 }}>01 — TARGET SEGMENT</div>
                                            <div className="canvas-section-box">
                                                <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>DESCRIPTION</p>
                                                <p style={{ marginBottom: 12 }}>{data.targetSegment}</p>
                                                <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>INTERVIEW OBJECTIVE</p>
                                                <p>{data.interviewObjective}</p>
                                            </div>
                                        </div>

                                        {/* Section 2: Interviews */}
                                        <div style={{ marginBottom: 32 }}>
                                            <div className="numbered-section" style={{ marginBottom: 12 }}>02 — INTERVIEW FINDINGS</div>
                                            {data.interviews.filter(i => i.customerName).map((interview, idx) => (
                                                <div key={idx} className="canvas-section-box" style={{ marginBottom: 12 }}>
                                                    <p style={{ fontWeight: 600, marginBottom: 8 }}>{interview.customerName} {interview.customerProfile && <span style={{ fontWeight: 400, color: '#666' }}>— {interview.customerProfile}</span>}</p>
                                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12 }}>
                                                        <div>
                                                            <p style={{ fontWeight: 600, fontSize: 12, color: '#DC2626', marginBottom: 4 }}>PAINS</p>
                                                            <p style={{ fontSize: 14 }}>{interview.pains}</p>
                                                        </div>
                                                        <div>
                                                            <p style={{ fontWeight: 600, fontSize: 12, color: '#2563EB', marginBottom: 4 }}>NEEDS</p>
                                                            <p style={{ fontSize: 14 }}>{interview.needs}</p>
                                                        </div>
                                                        <div>
                                                            <p style={{ fontWeight: 600, fontSize: 12, color: '#16A34A', marginBottom: 4 }}>GAINS</p>
                                                            <p style={{ fontSize: 14 }}>{interview.gains}</p>
                                                        </div>
                                                    </div>
                                                    {interview.quotes && <p style={{ fontStyle: 'italic', fontSize: 13, color: '#666', marginTop: 8 }}>"{interview.quotes}"</p>}
                                                </div>
                                            ))}
                                        </div>

                                        {/* Section 3: Prioritization */}
                                        <div style={{ marginBottom: 32 }}>
                                            <div className="numbered-section" style={{ marginBottom: 12 }}>03 — PRIORITIZATION</div>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>
                                                <div>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 8, color: '#DC2626' }}>PAINS (ranked)</p>
                                                    {[...data.painsPriority].sort((a, b) => calcScore(b) - calcScore(a)).map((p, i) => (
                                                        <div key={i} style={{ padding: '6px 0', borderBottom: '1px solid #E0E0E0', fontSize: 14 }}>
                                                            <span style={{ fontWeight: 600, marginRight: 6 }}>{calcScore(p)}</span> {p.pain}
                                                        </div>
                                                    ))}
                                                </div>
                                                <div>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 8, color: '#2563EB' }}>NEEDS (ranked)</p>
                                                    {[...data.needsPriority].sort((a, b) => calcScore(b) - calcScore(a)).map((n, i) => (
                                                        <div key={i} style={{ padding: '6px 0', borderBottom: '1px solid #E0E0E0', fontSize: 14 }}>
                                                            <span style={{ fontWeight: 600, marginRight: 6 }}>{calcScore(n)}</span> {n.need}
                                                        </div>
                                                    ))}
                                                </div>
                                                <div>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 8, color: '#16A34A' }}>GAINS (ranked)</p>
                                                    {[...data.gainsPriority].sort((a, b) => calcScore(b) - calcScore(a)).map((g, i) => (
                                                        <div key={i} style={{ padding: '6px 0', borderBottom: '1px solid #E0E0E0', fontSize: 14 }}>
                                                            <span style={{ fontWeight: 600, marginRight: 6 }}>{calcScore(g)}</span> {g.gain}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Section 4: Summary */}
                                        <div>
                                            <div className="numbered-section" style={{ marginBottom: 12 }}>04 — SUMMARY</div>
                                            {data.coreCustomer && (
                                                <div className="canvas-section-box" style={{ marginBottom: 12 }}>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>CORE CUSTOMER</p>
                                                    <p>{data.coreCustomer}</p>
                                                </div>
                                            )}
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 12 }}>
                                                <div className="canvas-section-box" style={{ borderLeftColor: '#DC2626' }}>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#DC2626' }}>TOP 3 PAINS</p>
                                                    <p style={{ fontSize: 14, whiteSpace: 'pre-line' }}>{data.topPains}</p>
                                                </div>
                                                <div className="canvas-section-box" style={{ borderLeftColor: '#2563EB' }}>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#2563EB' }}>TOP 3 NEEDS</p>
                                                    <p style={{ fontSize: 14, whiteSpace: 'pre-line' }}>{data.topNeeds}</p>
                                                </div>
                                                <div className="canvas-section-box" style={{ borderLeftColor: '#16A34A' }}>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#16A34A' }}>TOP 3 GAINS</p>
                                                    <p style={{ fontSize: 14, whiteSpace: 'pre-line' }}>{data.topGains}</p>
                                                </div>
                                            </div>
                                            {data.keyInsights && (
                                                <div className="canvas-section-box" style={{ marginBottom: 12 }}>
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>KEY INSIGHTS</p>
                                                    <p style={{ fontSize: 14 }}>{data.keyInsights}</p>
                                                </div>
                                            )}
                                            {data.strategicImplications && (
                                                <div className="canvas-section-box">
                                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>STRATEGIC IMPLICATIONS</p>
                                                    <p style={{ fontSize: 14 }}>{data.strategicImplications}</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Action buttons */}
                                    <div className="no-print" style={{ display: 'flex', gap: 12 }}>
                                        <button onClick={() => setStep(totalSteps)} className="btn-back" style={{ flex: 1 }}>&larr; Back to editing</button>
                                        <button onClick={handleExport} className="btn-back" style={{ flex: 1 }}>Export PDF</button>
                                        <button id="submit-button" onClick={handleSubmit} className="btn-next" style={{ flex: 1 }} disabled={submitStatus === 'saving'}>
                                            {submitStatus === 'saving' ? 'Saving...' : 'Final Submit'}
                                        </button>
                                    </div>
                                    {submitStatus && (
                                        <div style={{ marginTop: 16, padding: '12px 16px', textAlign: 'center', background: submitStatus === 'success' ? '#f0fdf4' : submitStatus === 'error' ? '#fef2f2' : '#f5f5f5', border: `1px solid ${submitStatus === 'success' ? '#bbf7d0' : submitStatus === 'error' ? '#fecaca' : '#e0e0e0'}`, fontSize: 14 }}>
                                            <span style={{ color: submitStatus === 'success' ? '#166534' : submitStatus === 'error' ? '#991b1b' : '#333' }}>{submitMessage}</span>
                                        </div>
                                    )}
                                    <div style={{ marginTop: 24, textAlign: 'center' }}><p className="monument" style={{ fontSize: 11, color: '#999' }}>DEEP DIVE COMPLETE — INSIGHTS LOCKED IN</p></div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }


        /* ============================================================
           PRIORITY MATRIX COMPONENT
           ============================================================ */

        function PriorityMatrix({ items, itemKey, itemLabel, itemPlaceholder, onUpdate, onAdd, onRemove, calcScore }) {
            const scoreOptions = [
                { value: '', label: '—' },
                { value: '1', label: '1 — Low' },
                { value: '2', label: '2' },
                { value: '3', label: '3 — Mid' },
                { value: '4', label: '4' },
                { value: '5', label: '5 — High' }
            ];

            return (
                <div>
                    {/* Header row */}
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 100px 100px 100px 60px 30px', gap: 8, marginBottom: 8, alignItems: 'center' }}>
                        <span className="monument" style={{ fontSize: 10, textTransform: 'uppercase', color: '#666' }}>{itemLabel}</span>
                        <span className="monument" style={{ fontSize: 10, textTransform: 'uppercase', color: '#666', textAlign: 'center' }}>Severity</span>
                        <span className="monument" style={{ fontSize: 10, textTransform: 'uppercase', color: '#666', textAlign: 'center' }}>Frequency</span>
                        <span className="monument" style={{ fontSize: 10, textTransform: 'uppercase', color: '#666', textAlign: 'center' }}>Impact</span>
                        <span className="monument" style={{ fontSize: 10, textTransform: 'uppercase', color: '#666', textAlign: 'center' }}>Score</span>
                        <span></span>
                    </div>

                    {items.map((item, idx) => {
                        const score = calcScore(item);
                        return (
                            <div key={idx} style={{ display: 'grid', gridTemplateColumns: '1fr 100px 100px 100px 60px 30px', gap: 8, marginBottom: 8, alignItems: 'center' }}>
                                <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14 }} value={item[itemKey]} onChange={e => onUpdate(idx, itemKey, e.target.value)} placeholder={itemPlaceholder} />
                                <select className="field-select" style={{ padding: '8px 4px', fontSize: 14 }} value={item.severity} onChange={e => onUpdate(idx, 'severity', e.target.value)}>
                                    {scoreOptions.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                                </select>
                                <select className="field-select" style={{ padding: '8px 4px', fontSize: 14 }} value={item.frequency} onChange={e => onUpdate(idx, 'frequency', e.target.value)}>
                                    {scoreOptions.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                                </select>
                                <select className="field-select" style={{ padding: '8px 4px', fontSize: 14 }} value={item.impact} onChange={e => onUpdate(idx, 'impact', e.target.value)}>
                                    {scoreOptions.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                                </select>
                                <div style={{ textAlign: 'center', fontWeight: 600, fontSize: 16, color: score >= 24 ? '#16A34A' : score >= 18 ? '#000' : '#999' }}>
                                    {score > 0 ? score : '—'}
                                </div>
                                {items.length > 1 ? (
                                    <button onClick={() => onRemove(idx)} style={{ background: 'none', border: 'none', fontSize: 18, cursor: 'pointer', color: '#999' }}>&times;</button>
                                ) : <span></span>}
                            </div>
                        );
                    })}

                    {items.length < 8 && (
                        <button onClick={onAdd} style={{ width: '100%', padding: '8px 0', border: '2px dashed #E0E0E0', background: 'none', fontSize: 13, cursor: 'pointer', color: '#666', marginTop: 4 }}>
                            + Add {itemLabel}
                        </button>
                    )}
                </div>
            );
        }


        ReactDOM.render(<ToolApp />, document.getElementById('root'));
    </script>
</body>
</html>
