<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organizational Redesign | Fast Track Program</title>

  <!-- React & ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../shared/js/tool-db.js"></script>
  <script src="../../shared/js/ai-challenge.js"></script>
  <script src="../../shared/js/dependency-injection.js"></script>
  <script src="../../shared/js/transition-screen.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

  <!-- jsPDF + html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Font Face Declarations */
    @font-face {
      font-family: 'Plaak';
      src: url('Plaak3Trial-43-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
    }

    @font-face {
      font-family: 'Riforma';
      src: url('RiformaLL-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: 'Monument';
      src: url('MonumentGrotesk-Mono.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Riforma', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .plaak {
      font-family: 'Plaak', sans-serif;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: -0.02em;
    }

    .riforma-bold {
      font-family: 'Riforma', sans-serif;
      font-weight: bold;
    }

    .monument {
      font-family: 'Monument', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .transition-animate-in {
      animation: slideIn 0.6s ease-out;
    }

    /* Button Styles */
    .btn-primary {
      background: #000000;
      color: #FFFFFF;
      padding: 16px 32px;
      border: 2px solid #000000;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: normal;
    }

    .btn-primary:hover:not(:disabled) {
      transform: scale(1.02);
    }

    .btn-primary:disabled {
      background: #E0E0E0;
      border-color: #E0E0E0;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #FFFFFF;
      color: #000000;
      padding: 12px 24px;
      border: 2px solid #000000;
      font-size: 16px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #F8F8F8;
    }

    .btn-add {
      background: #FFF469;
      color: #000000;
      padding: 12px 24px;
      border: 2px solid #000000;
      font-size: 16px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: bold;
    }

    .btn-add:hover {
      background: #FFE600;
    }

    .btn-remove {
      background: #FFFFFF;
      color: #EF4444;
      padding: 8px 16px;
      border: 2px solid #EF4444;
      font-size: 14px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-remove:hover {
      background: #FEE2E2;
    }

    /* Form Styles */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="date"],
    textarea,
    select {
      border: 1px solid #E0E0E0;
      padding: 12px 16px;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      width: 100%;
      transition: border-color 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #000000;
    }

    textarea {
      min-height: 100px;
      resize: none !important;
    }

    textarea::placeholder {
      white-space: pre-line;
    }

    /* Numbered Section Badge */
    .numbered-section {
      background: #000000;
      color: #FFFFFF;
      padding: 10px 16px;
      font-family: 'Plaak', sans-serif;
      font-size: 26px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }

    /* Help Button */
    .help-button {
      position: fixed;
      top: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #000000;
      color: #FFFFFF;
      font-size: 28px;
      border: none;
      cursor: pointer;
      z-index: 40;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Riforma', sans-serif;
    }

    .help-button:hover {
      background: #FFF469;
      color: #000000;
      transform: scale(1.1);
    }

    /* Progress Indicator */
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #E0E0E0;
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background: #000000;
      transform: scale(1.3);
    }

    .progress-dot.completed {
      background: #000000;
    }

    .progress-line {
      height: 2px;
      background: #E0E0E0;
      flex: 1;
    }

    /* FIT Score Styles */
    .fit-indicator {
      display: inline-block;
      padding: 4px 12px;
      font-family: 'Monument', monospace;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
    }

    .fit-excellent {
      background: #10B981;
      color: #FFFFFF;
    }

    .fit-good {
      background: #FFF469;
      color: #000000;
    }

    .fit-moderate {
      background: #F59E0B;
      color: #FFFFFF;
    }

    .fit-poor {
      background: #EF4444;
      color: #FFFFFF;
    }

    /* Matrix Cell Styles */
    .matrix-cell {
      border: 1px solid #E0E0E0;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .matrix-cell:hover {
      background: #F8F8F8;
    }

    .matrix-cell.score-excellent {
      background: #D1FAE5;
      border-color: #10B981;
    }

    .matrix-cell.score-good {
      background: #FEF9C3;
      border-color: #F59E0B;
    }

    .matrix-cell.score-moderate {
      background: #FFEDD5;
      border-color: #F97316;
    }

    .matrix-cell.score-poor {
      background: #FEE2E2;
      border-color: #EF4444;
    }

    /* Category Badge */
    .category-badge {
      display: inline-block;
      padding: 6px 12px;
      font-family: 'Monument', monospace;
      font-size: 12px;
      border-radius: 4px;
      font-weight: bold;
    }

    .category-immediate {
      background: #10B981;
      color: #FFFFFF;
    }

    .category-development {
      background: #F59E0B;
      color: #FFFFFF;
    }

    .category-transition {
      background: #EF4444;
      color: #FFFFFF;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }

    .modal-content {
      background: white;
      max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
      border: 4px solid #000000;
    }

    /* Slider Styles */
    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: #E0E0E0;
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #000000;
      cursor: pointer;
      border: 2px solid #FFFFFF;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #000000;
      cursor: pointer;
      border: 2px solid #FFFFFF;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* Skill Chip */
    .skill-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #F3F4F6;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      font-size: 14px;
    }

    .skill-chip button {
      background: none;
      border: none;
      color: #EF4444;
      cursor: pointer;
      font-weight: bold;
      padding: 0;
      font-size: 16px;
    }

    /* Timeline Checkpoint */
    .checkpoint-box {
      border-left: 4px solid #000000;
      padding-left: 16px;
      margin-bottom: 16px;
    }

    /* Wizard Layout */
    .wizard-layout { display: flex; min-height: 100vh; }
    .wizard-main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
    .wizard-content { flex: 1; padding: 48px 64px; max-width: 860px; }
    .wizard-footer { padding: 24px 64px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }
    .btn-wiz-back { background: transparent; border: 2px solid #d1d5db; color: #6b7280; padding: 14px 28px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s; }
    .btn-wiz-back:hover { border-color: #000; color: #000; }
    .btn-wiz-next { background: #000; color: #fff; border: 2px solid #000; padding: 14px 32px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s; }
    .btn-wiz-next:hover:not(:disabled) { background: #222; }
    .btn-wiz-next:disabled { background: #e5e7eb; border-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, Fragment } = React;

    const CONFIG = {
        SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
        SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
        TOOL_SLUG: 'org-redesign',
        AUTOSAVE_DELAY: 2000,
        TRANSITION_CONTENT: {
            1: {
                brutalTruth: 'Most org charts reflect history, not strategy. Companies structure themselves around the people they have rather than the work they need to do. Your structure is either accelerating your strategy or fighting it.',
                peerProof: '"A €30M company restructured from functional silos to two business units aligned with their core customer segments. Accountability became clearer. Cross-functional conflict dropped. Revenue per head increased 18% in 12 months."'
            },
            2: {
                brutalTruth: 'Reorganizations fail not because of the structure chosen, but because of what was not addressed: unclear decision rights, informal power structures, and roles created for people rather than outcomes.',
                peerProof: '"A tech company redesigned their org twice in three years without improvement. On the third attempt, they mapped informal influence alongside formal structure. They discovered their \'VP of Engineering\' had no actual engineering authority — it was held by a senior developer 2 levels down."'
            },
            3: {
                brutalTruth: 'The best organizational structure is the one your team can actually operate. A theoretically perfect org chart with confused humans is worse than an imperfect chart with aligned ones. Design for clarity, not elegance.',
                peerProof: '"A €15M professional services firm replaced a complex matrix structure with a simple pod model. Three months of confusion followed. Then clarity hit — pods set their own goals, managed their own P&L, and overall revenue grew 31% the next year."'
            },
            4: {
                brutalTruth: 'Personal development plans that sit in a folder do not develop people. PDPs only work when they are tied to real business needs, reviewed quarterly, and connected to visible career progression. Otherwise they are performance review theatre.',
                peerProof: '"One company tied PDPs to a role-advancement framework visible to all employees. Voluntary turnover dropped 35% in 18 months. The highest performers cited \'clarity about the path forward\' as the primary reason they stayed."'
            },
            5: {
                brutalTruth: 'An org chart without a 90-day execution plan is just a slide deck. Structural redesigns that lack a clear activation timeline revert to old patterns within 60 days because informal authority fills the vacuum.',
                peerProof: '"A €20M logistics company completed their redesign canvas and committed to a hard 90-day activation window with weekly leadership check-ins. Six months later, every key role was filled, every PDP had a sponsor, and net revenue per head was up 22%."'
            }
        },
        CLOSING_MESSAGES: {
            1: { title: 'TEAM ASSESSED', text: 'You now have a clear picture of where each person stands. This data drives everything that follows.' },
            2: { title: 'ROLES DEFINED', text: 'Your new structure is taking shape. Now you match people to those roles with precision.' },
            3: { title: 'MATRIX COMPLETE', text: 'The data doesn\'t lie. You can now see exactly where the fits are strong and where gaps exist.' },
            4: { title: 'ACTION PLAN SET', text: 'Every person has a clear path forward. Now develop the ones who need it.' },
            5: { title: 'REDESIGN COMPLETE', text: 'You have a full people strategy: placements, development plans, and a 90-day execution roadmap.' }
        }
    };

    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    // Make Supabase client globally available for dependency injection
    window.supabaseClient = supabaseClient;

    // Initialize ToolDB and dependency injection
    ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);

        // Initialize cognitive load components
        CognitiveLoad.init('org-redesign', {"insights":["Structure follows strategy, never the reverse.","Every role should have a clear owner, clear metrics, and clear authority."],"caseStudy":{"before":"A 200-person B2B services firm kept the same org chart for 5 years while tripling in size. Roles were designed around personalities, not functions. Span of control reached 14 direct reports for the CEO. Decision bottlenecks delayed client delivery by weeks.","after":"Redesigned around 5 core value streams with clear process owners and 3-7 span of control. FIT analysis placed A-players in mission-critical roles, created PDPs for B+ players, and transitioned 3 poor-fit team members within 90 days. Decision speed doubled. Client satisfaction rose 34%.","quote":"We finally stopped designing the org around who we had and started designing it around what the business needed. The hardest part was admitting our current structure was built for comfort, not performance. - CEO, B2B Services Company"}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

        function DependencyContext({ deps }) {
            const [open, setOpen] = React.useState(false);
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '16px' }}>
                    <button onClick={() => setOpen(o => !o)} style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '8px 14px', fontSize: 12, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase', cursor: 'pointer', color: '#555', width: '100%' }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#DAA520" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        CONTEXT FROM PREVIOUS TOOLS ({deps.length})
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#999" strokeWidth="2" style={{ marginLeft: 'auto', transform: open ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    {open && (
                        <div style={{ border: '1px solid #F0E68C', borderTop: 'none', padding: '12px 14px' }}>
                            {deps.map((dep, i) => (
                                <div key={i} style={{ background: '#fff', padding: '8px 0', borderBottom: i < deps.length - 1 ? '1px solid #F0E68C' : 'none', fontSize: '13px' }}>
                                    <div style={{ fontWeight: 600, marginBottom: '2px', color: '#333', fontSize: '11px', fontFamily: "'Monument', monospace", letterSpacing: '0.04em', textTransform: 'uppercase' }}>{dep.label}</div>
                                    <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

    // Main App Component
    function OrganizationalRedesignApp() {
            const [deps, setDeps] = useState([]);
      const [step, setStep] = useState(0);
      const [aiReviewing, setAiReviewing] = useState(false);

      const [data, setData] = useState({
        // Sheet 1: Current Team Assessment
        currentTeam: [
          {
            id: 1,
            name: '',
            currentPosition: '',
            companyFit: 0,
            jobFit: 0,
            bossFit: 0,
            teamFit: 0,
            totalFit: 0
          }
        ],

        // Sheet 2: Define New Roles
        newRoles: [
          {
            id: 1,
            roleTitle: '',
            criticality: 5,
            requiredSkills: ['', '', '']
          }
        ],

        // Sheet 3: Decision Matrix
        decisionMatrix: [],

        // Sheet 4: Action Plan
        actionPlan: {
          immediate: [],
          development: [],
          transition: []
        },

        // Sheet 5: PDPs
        pdps: []
      });

            useEffect(() => {
                async function loadDeps() {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                    try {
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[' + CONFIG.TOOL_SLUG + '] Failed to load dependencies:', err);
                    }
                }
                loadDeps();
            }, []);

      // Load from localStorage
      useEffect(() => {
        const saved = localStorage.getItem('organizational-redesign-data');
        if (saved) {
          try {
            const savedData = JSON.parse(saved);
            setData(savedData);
          } catch (e) {
            console.error('Error loading saved data:', e);
          }
        }
      }, []);

      // Auto-save every 2 seconds
      useEffect(() => {
        const interval = setInterval(() => {
          localStorage.setItem('organizational-redesign-data', JSON.stringify(data));
        }, 2000);
        return () => clearInterval(interval);
      }, [data]);

      const updateData = (field, value) => {
        setData({ ...data, [field]: value });
      };

      // Team Member Management
      const addTeamMember = () => {
        const newMember = {
          id: Date.now(),
          name: '',
          currentPosition: '',
          companyFit: 0,
          jobFit: 0,
          bossFit: 0,
          teamFit: 0,
          totalFit: 0
        };
        updateData('currentTeam', [...(data.currentTeam || []), newMember]);
      };

      const removeTeamMember = (id) => {
        if ((data.currentTeam || []).length > 1) {
          updateData('currentTeam', (data.currentTeam || []).filter(m => m.id !== id));
        }
      };

      const updateTeamMember = (id, field, value) => {
        const updated = (data.currentTeam || []).map(m => {
          if (m.id === id) {
            const updatedMember = { ...m, [field]: value };
            // Auto-calculate Total FIT
            if (['companyFit', 'jobFit', 'bossFit', 'teamFit'].includes(field)) {
              const total = (
                (parseFloat(updatedMember.companyFit) || 0) +
                (parseFloat(updatedMember.jobFit) || 0) +
                (parseFloat(updatedMember.bossFit) || 0) +
                (parseFloat(updatedMember.teamFit) || 0)
              ) / 4;
              updatedMember.totalFit = Math.round(total * 100) / 100;
            }
            return updatedMember;
          }
          return m;
        });
        updateData('currentTeam', updated);
      };

      // Role Management
      const addRole = () => {
        const newRole = {
          id: Date.now(),
          roleTitle: '',
          criticality: 5,
          requiredSkills: ['', '', '']
        };
        updateData('newRoles', [...(data.newRoles || []), newRole]);
      };

      const removeRole = (id) => {
        if ((data.newRoles || []).length > 1) {
          updateData('newRoles', (data.newRoles || []).filter(r => r.id !== id));
        }
      };

      const updateRole = (id, field, value) => {
        const updated = (data.newRoles || []).map(r => r.id === id ? { ...r, [field]: value } : r);
        updateData('newRoles', updated);
      };

      const addSkill = (roleId) => {
        const updated = (data.newRoles || []).map(r => {
          if (r.id === roleId && (r.requiredSkills || []).length < 7) {
            return { ...r, requiredSkills: [...(r.requiredSkills || []), ''] };
          }
          return r;
        });
        updateData('newRoles', updated);
      };

      const removeSkill = (roleId, skillIndex) => {
        const updated = (data.newRoles || []).map(r => {
          if (r.id === roleId && (r.requiredSkills || []).length > 3) {
            return {
              ...r,
              requiredSkills: (r.requiredSkills || []).filter((_, i) => i !== skillIndex)
            };
          }
          return r;
        });
        updateData('newRoles', updated);
      };

      const updateSkill = (roleId, skillIndex, value) => {
        const updated = (data.newRoles || []).map(r => {
          if (r.id === roleId) {
            const skills = [...(r.requiredSkills || [])];
            skills[skillIndex] = value;
            return { ...r, requiredSkills: skills };
          }
          return r;
        });
        updateData('newRoles', updated);
      };

      // Decision Matrix Management
      const initializeMatrix = () => {
        const matrix = (data.currentTeam || []).map(person => ({
          personId: person.id,
          personName: person.name || '',
          roleScores: {}
        }));
        updateData('decisionMatrix', matrix);
      };

      const updateMatrixScore = (personId, roleId, score) => {
        const updated = (data.decisionMatrix || []).map(entry => {
          if (entry.personId === personId) {
            return {
              ...entry,
              roleScores: { ...entry.roleScores, [roleId]: parseFloat(score) || 0 }
            };
          }
          return entry;
        });
        updateData('decisionMatrix', updated);
      };

      // Action Plan Management
      const categorizeActionPlan = () => {
        const immediate = [];
        const development = [];
        const transition = [];

        (data.decisionMatrix || []).forEach(entry => {
          const person = (data.currentTeam || []).find(p => p.id === entry.personId);
          if (!person) return;

          const scores = Object.entries(entry.roleScores || {});
          const bestScore = Math.max(...scores.map(([_, score]) => score), 0);
          const bestRole = scores.find(([_, score]) => score === bestScore);

          if (bestScore >= 0.8 && bestRole) {
            const roleTitle = (data.newRoles || []).find(r => r.id.toString() === bestRole[0])?.roleTitle || '';
            immediate.push({
              personId: person.id,
              name: person.name,
              assignedRole: roleTitle,
              fitScore: bestScore,
              startDate: '',
              successMetrics: ''
            });
          } else if (bestScore >= 0.6 && bestRole) {
            const roleTitle = (data.newRoles || []).find(r => r.id.toString() === bestRole[0])?.roleTitle || '';
            development.push({
              personId: person.id,
              name: person.name,
              targetRole: roleTitle,
              fitScore: bestScore,
              developmentTimeline: '',
              mentor: ''
            });
          } else {
            transition.push({
              personId: person.id,
              name: person.name,
              currentRole: person.currentPosition,
              transitionType: '',
              timeline: '',
              notes: ''
            });
          }
        });

        updateData('actionPlan', { immediate, development, transition });
      };

      const updateActionPlanItem = (category, personId, field, value) => {
        const updated = { ...data.actionPlan };
        updated[category] = (updated[category] || []).map(item =>
          item.personId === personId ? { ...item, [field]: value } : item
        );
        updateData('actionPlan', updated);
      };

      // PDP Management
      const initializePDPs = () => {
        const pdps = (data.actionPlan?.development || []).map(dev => ({
          personId: dev.personId,
          name: dev.name,
          targetRole: dev.targetRole,
          coreActivity: '',
          capabilities: [
            {
              id: 1,
              capability: '',
              currentFulfillment: 0,
              gap: 100,
              what: '',
              when: '',
              byWhom: ''
            }
          ],
          checkpoint30Days: '',
          checkpoint60Days: '',
          checkpoint90Days: ''
        }));
        updateData('pdps', pdps);
      };

      const updatePDP = (personId, field, value) => {
        const updated = (data.pdps || []).map(pdp =>
          pdp.personId === personId ? { ...pdp, [field]: value } : pdp
        );
        updateData('pdps', updated);
      };

      const addCapability = (personId) => {
        const updated = (data.pdps || []).map(pdp => {
          if (pdp.personId === personId) {
            return {
              ...pdp,
              capabilities: [...(pdp.capabilities || []), {
                id: Date.now(),
                capability: '',
                currentFulfillment: 0,
                gap: 100,
                what: '',
                when: '',
                byWhom: ''
              }]
            };
          }
          return pdp;
        });
        updateData('pdps', updated);
      };

      const removeCapability = (personId, capabilityId) => {
        const updated = (data.pdps || []).map(pdp => {
          if (pdp.personId === personId && (pdp.capabilities || []).length > 1) {
            return {
              ...pdp,
              capabilities: (pdp.capabilities || []).filter(c => c.id !== capabilityId)
            };
          }
          return pdp;
        });
        updateData('pdps', updated);
      };

      const updateCapability = (personId, capabilityId, field, value) => {
        const updated = (data.pdps || []).map(pdp => {
          if (pdp.personId === personId) {
            return {
              ...pdp,
              capabilities: (pdp.capabilities || []).map(cap => {
                if (cap.id === capabilityId) {
                  const updatedCap = { ...cap, [field]: value };
                  if (field === 'currentFulfillment') {
                    updatedCap.gap = 100 - (parseFloat(value) || 0);
                  }
                  return updatedCap;
                }
                return cap;
              })
            };
          }
          return pdp;
        });
        updateData('pdps', updated);
      };

      const goNext = async () => {
        if (step === 0.5) {
          setStep(1);
        } else if (step >= 1 && step <= 5) {
          const userId = localStorage.getItem('ft_user_id');
          if (userId) {
            setAiReviewing(true);
            try {
              let stepAnswers = {};
              let stepName = '';
              if (step === 1) {
                stepName = 'Current Team Assessment';
                stepAnswers = { current_team: (data.currentTeam || []).map(m => ({ name: m.name, currentPosition: m.currentPosition, companyFit: m.companyFit, jobFit: m.jobFit, bossFit: m.bossFit, teamFit: m.teamFit, totalFit: m.totalFit })) };
              } else if (step === 2) {
                stepName = 'Define New Roles';
                stepAnswers = { new_roles: (data.newRoles || []).map(r => ({ roleTitle: r.roleTitle, criticality: r.criticality, requiredSkills: r.requiredSkills })) };
              } else if (step === 3) {
                stepName = 'Decision Matrix';
                stepAnswers = { decision_matrix: data.decisionMatrix || [] };
              } else if (step === 4) {
                stepName = 'Action Plan';
                stepAnswers = { action_plan: data.actionPlan || {} };
              } else if (step === 5) {
                stepName = 'PDPs';
                stepAnswers = { pdps: data.pdps || [] };
              }
              const canProceed = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, stepAnswers, stepName);
              if (!canProceed) { setAiReviewing(false); return; }
            } catch (err) {
              console.warn('[AIChallenge] Error, allowing passage:', err);
            } finally {
              setAiReviewing(false);
            }
          }

          if (step === 1) {
            setStep(1.5);
          } else if (step === 2) {
            initializeMatrix();
            setStep(2.5);
          } else if (step === 3) {
            categorizeActionPlan();
            setStep(3.5);
          } else if (step === 4) {
            initializePDPs();
            setStep(4.5);
          } else if (step === 5) {
            setStep(5.5);
          }
        } else if (step === 0) {
          setStep(0.5);
        }
      };

      const goBack = () => {
        if (step === 6) {
          setStep(5);
        } else if (step > 1) {
          setStep(step - 1);
        } else if (step === 1) {
          setStep(0.5);
        }
      };

      // Validation functions
      const isStep1Valid = () => {
        return (data.currentTeam || []).length >= 1 &&
               (data.currentTeam || []).every(m =>
                 (m.name || '').trim().length >= 2 &&
                 (m.currentPosition || '').trim().length >= 2 &&
                 m.companyFit >= 0 && m.companyFit <= 1 &&
                 m.jobFit >= 0 && m.jobFit <= 1 &&
                 m.bossFit >= 0 && m.bossFit <= 1 &&
                 m.teamFit >= 0 && m.teamFit <= 1
               );
      };

      const isStep2Valid = () => {
        return (data.newRoles || []).length >= 1 &&
               (data.newRoles || []).every(r =>
                 (r.roleTitle || '').trim().length >= 2 &&
                 r.criticality >= 1 && r.criticality <= 10 &&
                 (r.requiredSkills || []).length >= 3 &&
                 (r.requiredSkills || []).filter(s => (s || '').trim().length > 0).length >= 3
               );
      };

      const isStep3Valid = () => {
        return (data.decisionMatrix || []).length > 0 &&
               (data.decisionMatrix || []).every(entry => {
                 const scores = Object.values(entry.roleScores || {});
                 return scores.length === (data.newRoles || []).length;
               });
      };

      const isStep4Valid = () => {
        const immediate = data.actionPlan?.immediate || [];
        const development = data.actionPlan?.development || [];
        const transition = data.actionPlan?.transition || [];
        return (immediate.length + development.length + transition.length) > 0;
      };

      const isStep5Valid = () => {
        const devCount = (data.actionPlan?.development || []).length;
        if (devCount === 0) return true;

        return (data.pdps || []).every(pdp =>
          (pdp.coreActivity || '').length >= 2 &&
          (pdp.capabilities || []).length >= 1 &&
          (pdp.capabilities || []).every(cap =>
            (cap.capability || '').length >= 2 &&
            cap.currentFulfillment >= 0 && cap.currentFulfillment <= 100
          )
        );
      };

      const exportPDF = async () => {
        try {
          const canvas = document.getElementById('canvas-content');
          if (!canvas) {
            alert('Canvas not found');
            return;
          }

          const canvasImage = await html2canvas(canvas, {
            scale: 2,
            logging: false,
            backgroundColor: '#ffffff'
          });

          const imgWidth = 190;
          const imgHeight = (canvasImage.height * imgWidth) / canvasImage.width;

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgData = canvasImage.toDataURL('image/png');

          pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
          pdf.save('organizational-redesign.pdf');
        } catch (error) {
          console.error('PDF export error:', error);
          alert('Failed to export PDF: ' + error.message);
        }
      };

      const handleSubmit = async () => {
        const userId = localStorage.getItem('ft_user_id');
        if (!userId) {
          alert('User not authenticated. Please return to the dashboard.');
          return false;
        }

        try {
          const questionMappings = {
            machine_blueprint: {
              currentTeam: (data.currentTeam || []).map(m => ({
                name: m.name,
                currentPosition: m.currentPosition,
                companyFit: m.companyFit,
                jobFit: m.jobFit,
                bossFit: m.bossFit,
                teamFit: m.teamFit,
                totalFit: m.totalFit
              })),
              newRoles: (data.newRoles || []).map(r => ({
                roleTitle: r.roleTitle,
                criticality: r.criticality,
                requiredSkills: r.requiredSkills
              }))
            },
            right_seats: {
              decisionMatrix: data.decisionMatrix || [],
              actionPlan: data.actionPlan || {}
            },
            strategy_shadow: {
              pdps: data.pdps || []
            }
          };
          await window.AIChallenge.submitWithChallenge(userId, CONFIG.TOOL_SLUG, questionMappings, {
            onReviewStart: () => {},
            onRevise: () => { setStep(5); },
            onSubmitAnyway: () => { alert('Organizational Redesign submitted successfully!'); },
            onError: (err) => { alert('Submission failed: ' + err.message); }
          });
          return true;
        } catch (error) {
          console.error('Supabase submission error:', error);
          alert('Submission failed. Please try again.');
          return false;
        }
      };

      // Render different pages based on step
      if ([1.5, 2.5, 3.5, 4.5, 5.5].includes(step)) {
        return window.renderTransitionScreen(step, CONFIG, 5, setStep);
      }

      if (step === 0) {
        return <CoverPage onStart={goNext} />;
      }

      if (step === 0.5) {
        return <IntroPage onNext={goNext} />;
      }

      // Steps 1-5: Wizard layout
      if (step >= 1 && step <= 5) {
        const stepLabels = ['Team Assessment', 'Define New Roles', 'Decision Matrix', 'Action Plan', 'Dev Plans'];
        const isValid = step === 1 ? isStep1Valid() : step === 2 ? isStep2Valid() : step === 3 ? isStep3Valid() : step === 4 ? isStep4Valid() : isStep5Valid();
        const canProceed = !aiReviewing && isValid;
        const nextLabels = { 1: 'NEXT: DEFINE NEW ROLES →', 2: 'NEXT: DECISION MATRIX →', 3: 'NEXT: ACTION PLAN →', 4: 'NEXT: DEV PLANS →', 5: 'VIEW CANVAS →' };
        return (
          <div className="wizard-layout">
            <div className="wizard-main">
              <div className="wizard-content animate-in">
                <DependencyContext deps={deps} />
                {step === 1 && <Step1Page data={data} updateTeamMember={updateTeamMember} addTeamMember={addTeamMember} removeTeamMember={removeTeamMember} />}
                {step === 2 && <Step2Page data={data} updateRole={updateRole} addRole={addRole} removeRole={removeRole} addSkill={addSkill} removeSkill={removeSkill} updateSkill={updateSkill} />}
                {step === 3 && <Step3Page data={data} updateMatrixScore={updateMatrixScore} />}
                {step === 4 && <Step4Page data={data} updateActionPlanItem={updateActionPlanItem} />}
                {step === 5 && <Step5Page data={data} updatePDP={updatePDP} addCapability={addCapability} removeCapability={removeCapability} updateCapability={updateCapability} />}
              </div>
              <div className="wizard-footer">
                <button className="btn-wiz-back" onClick={goBack}>← BACK</button>
                <button className="btn-wiz-next" disabled={!canProceed} onClick={goNext}>
                  {aiReviewing ? 'AI COACH REVIEWING...' : (nextLabels[step] || 'NEXT →')}
                </button>
              </div>
            </div>
            <WizardSidebar currentStep={step} stepLabels={stepLabels} totalSteps={5} />
          </div>
        );
      }

      if (step === 6) {
        return (
          <CanvasPage
            data={data}
            onExport={exportPDF}
            onSubmit={handleSubmit}
          />
        );
      }

      return null;
    }

    // Cover Page Component
    function CoverPage({ onStart }) {
      return (
        <div className="relative min-h-screen flex items-center justify-center bg-black">
          <div
            className="absolute inset-0 w-full h-full"
            style={{
              backgroundImage: 'url("https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=1920&q=80")',
              backgroundSize: 'cover',
              backgroundPosition: 'center',
              opacity: 0.3
            }}
          ></div>
          <div className="absolute inset-0" style={{background: 'linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.85))'}}></div>

          <div className="relative z-10 text-center text-white px-8 max-w-5xl mx-auto">
            <h1 className="plaak animate-in" style={{fontSize: '100px', lineHeight: '1', marginBottom: '32px'}}>
              ORGANIZATIONAL
            </h1>
            <h2 className="plaak animate-in" style={{fontSize: '80px', lineHeight: '1', marginBottom: '32px', color: '#FFF469', animationDelay: '0.1s'}}>
              REDESIGN
            </h2>
            <p className="text-4xl mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              Transform structure into reality. Match people to roles with precision and create a 90-day implementation roadmap.
            </p>
            <button
              onClick={onStart}
              className="bg-white text-black plaak px-16 py-6 border-4 border-white hover:bg-black hover:text-white transition-all text-3xl animate-in"
              style={{animationDelay: '0.4s'}}
            >
              START
            </button>
          </div>
        </div>
      );
    }

    // Intro Page Component
    function IntroPage({ onNext }) {
      return (
        <div className="bg-black text-white min-h-screen p-16">
          <div className="max-w-5xl mx-auto">
            <h1 className="plaak mb-16 animate-in" style={{fontSize: '100px'}}>
              BEFORE WE START
            </h1>

            {/* Sprint Info */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.05s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>SPRINT INFO</h2>
              <div className="bg-white text-black p-8">
                <p className="text-2xl font-bold mb-4">Sprint 25: Organizational Redesign & Personal Development Plans</p>
                <p className="text-xl leading-relaxed mb-4">
                  Only 12% of organizational transformations achieve their full potential, primarily due to failures in managing the people side of change. A-players are 400% more productive than average performers in complex roles - meaning one wrong person in a key position can derail your entire organizational structure.
                </p>
                <p className="text-xl leading-relaxed mb-4">
                  This sprint is where strategy meets reality: your ideal structure becomes operational through the right human capital decisions.
                </p>
                <div className="border-l-4 border-black pl-4 italic text-lg">
                  This tool integrates Sprint 22 (structure), Sprint 23 (capabilities), and Sprint 24 (people assessment) into an actionable 90-day implementation roadmap.
                </div>
              </div>
            </div>

            {/* Integration Logic */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <h2 className="plaak text-6xl mb-6">INTEGRATION LOGIC</h2>
              <div className="grid grid-cols-3 gap-6">
                <div className="border-4 border-white p-6">
                  <h3 className="plaak text-3xl mb-4" style={{color: '#FFF469'}}>SPRINT 22</h3>
                  <p className="text-lg mb-2 font-bold">Structure Foundation</p>
                  <ul className="text-base space-y-2">
                    <li>5 core activities</li>
                    <li>3 critical processes</li>
                    <li>9 KPIs</li>
                    <li>Org chart</li>
                  </ul>
                </div>

                <div className="border-4 border-white p-6">
                  <h3 className="plaak text-3xl mb-4" style={{color: '#FFF469'}}>SPRINT 23</h3>
                  <p className="text-lg mb-2 font-bold">Capabilities Framework</p>
                  <ul className="text-base space-y-2">
                    <li>Key decisions</li>
                    <li>Required capabilities</li>
                    <li>Gap analysis</li>
                    <li>Data requirements</li>
                  </ul>
                </div>

                <div className="border-4 border-white p-6">
                  <h3 className="plaak text-3xl mb-4" style={{color: '#FFF469'}}>SPRINT 24</h3>
                  <p className="text-lg mb-2 font-bold">People Assessment</p>
                  <ul className="text-base space-y-2">
                    <li>FIT scores (4 dimensions)</li>
                    <li>ABC player ratings</li>
                    <li>Honest evaluation</li>
                    <li>Development potential</li>
                  </ul>
                </div>
              </div>
            </div>

            {/* Tool Structure */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.15s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>5-SHEET TOOLKIT</h2>
              <div className="space-y-4">
                <div className="border-2 border-white p-6 flex items-start gap-6">
                  <div className="text-6xl plaak">01</div>
                  <div>
                    <h3 className="text-2xl font-bold mb-2">CURRENT TEAM ASSESSMENT</h3>
                    <p className="text-lg">Import FIT scores from Sprint 24. Calculate Total FIT. Identify at-risk placements.</p>
                  </div>
                </div>
                <div className="border-2 border-white p-6 flex items-start gap-6">
                  <div className="text-6xl plaak">02</div>
                  <div>
                    <h3 className="text-2xl font-bold mb-2">DEFINE NEW ROLES</h3>
                    <p className="text-lg">Document roles from Sprint 22 structure. Score criticality (1-10). List required skills from Sprint 23.</p>
                  </div>
                </div>
                <div className="border-2 border-white p-6 flex items-start gap-6">
                  <div className="text-6xl plaak">03</div>
                  <div>
                    <h3 className="text-2xl font-bold mb-2">DECISION MATRIX</h3>
                    <p className="text-lg">Match people to roles with FIT scoring. Identify gaps, conflicts, and optimal placements.</p>
                  </div>
                </div>
                <div className="border-2 border-white p-6 flex items-start gap-6">
                  <div className="text-6xl plaak">04</div>
                  <div>
                    <h3 className="text-2xl font-bold mb-2">ACTION PLAN</h3>
                    <p className="text-lg">Categorize: Immediate (0.8+ FIT), Development (0.6-0.79), Transition (below 0.6). Set timelines.</p>
                  </div>
                </div>
                <div className="border-2 border-white p-6 flex items-start gap-6">
                  <div className="text-6xl plaak">05</div>
                  <div>
                    <h3 className="text-2xl font-bold mb-2">PERSONAL DEVELOPMENT PLANS</h3>
                    <p className="text-lg">Create PDPs for development category. Define capability gaps, what/when/by whom, 30-60-90 checkpoints.</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Critical Success Factors */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              <h2 className="plaak text-6xl mb-6">CRITICAL SUCCESS FACTORS</h2>
              <div className="bg-white text-black p-6 space-y-4">
                <div className="flex items-start gap-4">
                  <span className="text-3xl font-bold">1.</span>
                  <div>
                    <p className="text-xl font-bold">Brutal Honesty in Assessment</p>
                    <p className="text-lg">Sugar-coating FIT scores leads to wrong placements. Model honest self-assessment from CEO down.</p>
                  </div>
                </div>
                <div className="flex items-start gap-4">
                  <span className="text-3xl font-bold">2.</span>
                  <div>
                    <p className="text-xl font-bold">Speed Over Perfection</p>
                    <p className="text-lg">Better to make good decision in 4 hours than perfect decision in 4 weeks. Market won't wait.</p>
                  </div>
                </div>
                <div className="flex items-start gap-4">
                  <span className="text-3xl font-bold">3.</span>
                  <div>
                    <p className="text-xl font-bold">Clear Communication</p>
                    <p className="text-lg">People can handle hard truths if delivered with respect and clarity. Ambiguity creates fear.</p>
                  </div>
                </div>
                <div className="flex items-start gap-4">
                  <span className="text-3xl font-bold">4.</span>
                  <div>
                    <p className="text-xl font-bold">Follow-Through on PDPs</p>
                    <p className="text-lg">60% of development plans fail due to lack of accountability. Weekly check-ins are essential.</p>
                  </div>
                </div>
                <div className="flex items-start gap-4">
                  <span className="text-3xl font-bold">5.</span>
                  <div>
                    <p className="text-xl font-bold">Compassionate Exits</p>
                    <p className="text-lg">How you treat people on the way out determines whether A-players trust you going forward.</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Next Button */}
            <button
              onClick={onNext}
              className="btn-primary w-full text-3xl py-8 plaak"
            >
              LET'S START →
            </button>
          </div>
        </div>
      );
    }

    // Wizard Sidebar Component
    function WizardSidebar({ currentStep, stepLabels, totalSteps }) {
      return (
        <div className="wizard-sidebar">
          <div style={{ marginBottom: 48 }}>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 8 }}>SPRINT 25</div>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 13, color: '#fff', letterSpacing: '0.06em', textTransform: 'uppercase', lineHeight: 1.4 }}>ORG REDESIGN</div>
          </div>
          <div style={{ flex: 1 }}>
            {stepLabels.map((label, i) => {
              const stepNum = i + 1;
              const isDone = stepNum < currentStep;
              const isActive = stepNum === Math.floor(currentStep);
              return (
                <div key={stepNum} style={{ display: 'flex', alignItems: 'flex-start', gap: 16, marginBottom: 28 }}>
                  <div style={{ width: 28, height: 28, borderRadius: '50%', border: `2px solid ${isDone ? '#FFF469' : isActive ? '#fff' : '#444'}`, background: isDone ? '#FFF469' : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, marginTop: 2 }}>
                    {isDone ? <span style={{ color: '#000', fontSize: 13, fontWeight: 700 }}>✓</span> : <span style={{ color: isActive ? '#fff' : '#555', fontSize: 12, fontFamily: "'Monument', monospace" }}>{stepNum}</span>}
                  </div>
                  <div>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: isDone ? '#FFF469' : isActive ? '#fff' : '#555', letterSpacing: '0.08em', textTransform: 'uppercase', lineHeight: 1.5 }}>{label}</div>
                  </div>
                </div>
              );
            })}
          </div>
          <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#444', letterSpacing: '0.08em', textTransform: 'uppercase' }}>STEP {Math.floor(currentStep)} OF {totalSteps}</div>
        </div>
      );
    }

    // Helper function to get FIT interpretation
    function getFitInterpretation(fitScore) {
      if (fitScore >= 0.8) return { label: 'EXCELLENT FIT', class: 'fit-excellent', text: 'A-player in right seat' };
      if (fitScore >= 0.6) return { label: 'GOOD FIT', class: 'fit-good', text: 'B+ player with development potential' };
      if (fitScore >= 0.4) return { label: 'MODERATE FIT', class: 'fit-moderate', text: 'Needs significant development or role change' };
      return { label: 'POOR FIT', class: 'fit-poor', text: 'Likely wrong seat or wrong bus' };
    }

    // Helper function to get criticality label
    function getCriticalityLabel(score) {
      if (score === 10) return 'MISSION-CRITICAL';
      if (score >= 7) return 'HIGHLY IMPORTANT';
      if (score >= 4) return 'IMPORTANT';
      return 'NICE TO HAVE';
    }

    // Helper function to get matrix cell class
    function getMatrixCellClass(score) {
      if (score >= 0.8) return 'score-excellent';
      if (score >= 0.6) return 'score-good';
      if (score >= 0.4) return 'score-moderate';
      return 'score-poor';
    }

    // Step 1: Current Team Assessment Component
    function Step1Page({ data, updateTeamMember, addTeamMember, removeTeamMember }) {
      return (
        <div>
            <div className="mb-8 animate-in">
              <div className="numbered-section mb-4">STEP 01</div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  Research on person-environment fit shows that multi-dimensional assessment (Company-Job-Boss-Team) predicts job performance and retention significantly better than single-factor evaluations (Kristof-Brown et al., 2005, Personnel Psychology). Only 12% of organizational transformations achieve their full potential, primarily due to failures in managing the people side of change (McKinsey, 2023). Structured FIT scoring eliminates the subjectivity bias that causes 87% of restructurings to misalign people.
              </ScienceBox>

              {/* Common Mistake */}

              <h1 className="plaak text-6xl mb-4">CURRENT TEAM ASSESSMENT</h1>
              <p className="text-2xl text-gray-600 mb-4">
                Import FIT scores from Sprint 24. Total FIT auto-calculates as average of all 4 dimensions.
              </p>
              <div className="bg-yellow-100 border-l-4 border-yellow-600 p-4">
                <p className="text-lg"><strong>Remember:</strong> Use 0-1 scale (e.g., 0.85, 0.70, 0.45). Total FIT = (Company + Job + Boss + Team) / 4</p>
              </div>
            </div>

            {/* Team Members */}
            <div className="space-y-6 mb-8">
              {(data.currentTeam || []).map((member, index) => {
                const fitInterpretation = getFitInterpretation(member.totalFit || 0);

                return (
                  <div key={member.id} className="border-4 border-black p-6 animate-in" style={{animationDelay: `${index * 0.1}s`}}>
                    <div className="flex justify-between items-start mb-4">
                      <h3 className="plaak text-3xl">TEAM MEMBER {index + 1}</h3>
                      {(data.currentTeam || []).length > 1 && (
                        <button
                          onClick={() => removeTeamMember(member.id)}
                          className="btn-remove"
                        >
                          REMOVE
                        </button>
                      )}
                    </div>

                    <div className="grid grid-cols-2 gap-6 mb-6">
                      <div>
                        <label className="monument text-sm block mb-2">NAME</label>
                        <ScienceBookmarkIcon>
                            Geoff Smart's "Who" method shows that precisely identifying individuals by name and role eliminates the vagueness that causes 62% of placement failures. Specificity drives accountability.
                        </ScienceBookmarkIcon>
                        <input
                          type="text"
                          value={member.name || ''}
                          onChange={(e) => updateTeamMember(member.id, 'name', e.target.value)}
                          placeholder="Full name"
                          className="w-full"
                        />
                      </div>

                      <div>
                        <label className="monument text-sm block mb-2">CURRENT POSITION</label>
                        <ScienceBookmarkIcon>
                            Collins' "First Who, Then What" principle: documenting current positions exposes structural gaps. Companies that map existing roles before redesigning outperform those that skip this step by 3x (Good to Great, Jim Collins).
                        </ScienceBookmarkIcon>
                        <input
                          type="text"
                          value={member.currentPosition || ''}
                          onChange={(e) => updateTeamMember(member.id, 'currentPosition', e.target.value)}
                          placeholder="Current role"
                          className="w-full"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-4 gap-4 mb-6">
                      <div>
                        <label className="monument text-sm block mb-2">COMPANY FIT (0-1)</label>
                        <ScienceBookmarkIcon>
                            Four-dimensional FIT analysis (Company-Job-Boss-Team) predicts retention and performance 2.4x better than single-factor assessments. Missing any dimension creates hidden failure points (Kristof-Brown et al., Personnel Psychology).
                        </ScienceBookmarkIcon>
                        <input
                          type="number"
                          min="0"
                          max="1"
                          step="0.01"
                          value={member.companyFit || 0}
                          onChange={(e) => updateTeamMember(member.id, 'companyFit', parseFloat(e.target.value) || 0)}
                          className="w-full"
                        />
                      </div>

                      <div>
                        <label className="monument text-sm block mb-2">JOB FIT (0-1)</label>
                        <input
                          type="number"
                          min="0"
                          max="1"
                          step="0.01"
                          value={member.jobFit || 0}
                          onChange={(e) => updateTeamMember(member.id, 'jobFit', parseFloat(e.target.value) || 0)}
                          className="w-full"
                        />
                      </div>

                      <div>
                        <label className="monument text-sm block mb-2">BOSS FIT (0-1)</label>
                        <input
                          type="number"
                          min="0"
                          max="1"
                          step="0.01"
                          value={member.bossFit || 0}
                          onChange={(e) => updateTeamMember(member.id, 'bossFit', parseFloat(e.target.value) || 0)}
                          className="w-full"
                        />
                      </div>

                      <div>
                        <label className="monument text-sm block mb-2">TEAM FIT (0-1)</label>
                        <input
                          type="number"
                          min="0"
                          max="1"
                          step="0.01"
                          value={member.teamFit || 0}
                          onChange={(e) => updateTeamMember(member.id, 'teamFit', parseFloat(e.target.value) || 0)}
                          className="w-full"
                        />
                      </div>
                    </div>

                    {/* Total FIT Display */}
                    <div className="bg-gray-100 p-4 border-l-4 border-black">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="monument text-sm mb-1">TOTAL FIT SCORE</p>
                          <p className="text-4xl font-bold">{(member.totalFit || 0).toFixed(2)}</p>
                        </div>
                        <div className="text-right">
                          <span className={`fit-indicator ${fitInterpretation.class}`}>
                            {fitInterpretation.label}
                          </span>
                          <p className="text-sm text-gray-600 mt-2">{fitInterpretation.text}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Add Team Member Button */}
            <button
              onClick={addTeamMember}
              className="btn-add w-full mb-8 py-4 text-xl"
            >
              + ADD TEAM MEMBER
            </button>

        </div>
      );
    }

    // Step 2: Define New Roles Component
    function Step2Page({ data, updateRole, addRole, removeRole, addSkill, removeSkill, updateSkill }) {
      return (
        <div>
            <div className="mb-8 animate-in">
              <div className="numbered-section mb-4">STEP 02</div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  Research on organizational design shows that optimal span of control is 5-7 direct reports for complex knowledge work and up to 15-20 for routine operational roles (Mintzberg, "The Structuring of Organizations"). The Scorecard Method from "Who" by Geoff Smart demonstrates that roles defined by specific outcomes and competencies lead to 90% hiring success rates versus 50% for traditional job descriptions. Criticality-based role prioritization ensures A-player talent is concentrated where it creates maximum leverage.
              </ScienceBox>

              <h1 className="plaak text-6xl mb-4">DEFINE NEW ROLES</h1>
              <p className="text-2xl text-gray-600 mb-4">
                Document roles needed in your redesigned organization based on Sprint 22 structure.
              </p>
              <div className="bg-yellow-100 border-l-4 border-yellow-600 p-4">
                <p className="text-lg"><strong>Criticality Scale:</strong> 10 = Mission-Critical, 7-9 = Highly Important, 4-6 = Important, 1-3 = Nice to Have</p>
              </div>
            </div>

            {/* Roles */}
            <div className="space-y-6 mb-8">
              {(data.newRoles || []).map((role, index) => {
                const criticalityLabel = getCriticalityLabel(role.criticality || 5);

                return (
                  <div key={role.id} className="border-4 border-black p-6 animate-in" style={{animationDelay: `${index * 0.1}s`}}>
                    <div className="flex justify-between items-start mb-4">
                      <h3 className="plaak text-3xl">ROLE {index + 1}</h3>
                      {(data.newRoles || []).length > 1 && (
                        <button
                          onClick={() => removeRole(role.id)}
                          className="btn-remove"
                        >
                          REMOVE
                        </button>
                      )}
                    </div>

                    <div className="mb-6">
                      <label className="monument text-sm block mb-2">ROLE TITLE</label>
                      <input
                        type="text"
                        value={role.roleTitle || ''}
                        onChange={(e) => updateRole(role.id, 'roleTitle', e.target.value)}
                        placeholder="E.g., Head of Operations"
                        className="w-full"
                      />
                    </div>

                    <div className="mb-6">
                      <label className="monument text-sm block mb-2">CRITICALITY (1-10): {role.criticality || 5}</label>
                      <div className="flex items-center gap-4">
                        <span className="text-sm">1</span>
                        <input
                          type="range"
                          min="1"
                          max="10"
                          step="1"
                          value={role.criticality || 5}
                          onChange={(e) => updateRole(role.id, 'criticality', parseInt(e.target.value))}
                          className="flex-1"
                        />
                        <span className="text-sm">10</span>
                      </div>
                      <div className="mt-2 text-center">
                        <span className="inline-block px-4 py-2 bg-black text-white monument text-sm">
                          {criticalityLabel}
                        </span>
                      </div>
                    </div>

                    <div className="mb-4">
                      <label className="monument text-sm block mb-2">REQUIRED SKILLS (3-7)</label>
                      <div className="space-y-3">
                        {(role.requiredSkills || []).map((skill, skillIndex) => (
                          <div key={skillIndex} className="flex gap-2">
                            <input
                              type="text"
                              value={skill || ''}
                              onChange={(e) => updateSkill(role.id, skillIndex, e.target.value)}
                              placeholder={`Skill ${skillIndex + 1}`}
                              className="flex-1"
                            />
                            {(role.requiredSkills || []).length > 3 && (
                              <button
                                onClick={() => removeSkill(role.id, skillIndex)}
                                className="btn-remove"
                              >
                                X
                              </button>
                            )}
                          </div>
                        ))}
                      </div>
                      {(role.requiredSkills || []).length < 7 && (
                        <button
                          onClick={() => addSkill(role.id)}
                          className="btn-secondary mt-3 w-full"
                        >
                          + ADD SKILL
                        </button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Add Role Button */}
            <button
              onClick={addRole}
              className="btn-add w-full mb-8 py-4 text-xl"
            >
              + ADD ROLE
            </button>

        </div>
      );
    }

    // Step 3: Decision Matrix Component
    function Step3Page({ data, updateMatrixScore }) {
      return (
        <div>
            <div className="mb-8 animate-in">
              <div className="numbered-section mb-4">STEP 03</div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  Decision matrix approaches reduce placement bias by 40-60% compared to unstructured "gut feel" decisions (Kahneman, "Thinking, Fast and Slow"). A meta-analysis by Schmidt &amp; Hunter (Psychological Bulletin, 1998) found that structured assessments predict job performance with 0.51 validity, versus 0.38 for unstructured interviews. Companies with highly engaged, well-placed teams are 59% more likely to exceed performance targets during organizational transitions (Gallup, 2023).
              </ScienceBox>

              <h1 className="plaak text-6xl mb-4">DECISION MATRIX</h1>
              <p className="text-2xl text-gray-600 mb-4">
                Match current people against new roles. Score person-role FIT (0-1 scale) for each combination.
              </p>
              <div className="bg-yellow-100 border-l-4 border-yellow-600 p-4">
                <p className="text-lg"><strong>Scoring:</strong> 0.8+ (Excellent), 0.6-0.79 (Good), 0.4-0.59 (Moderate), Below 0.4 (Poor)</p>
              </div>
            </div>

            {/* Matrix Table */}
            <div className="overflow-x-auto mb-8 animate-in" style={{animationDelay: '0.1s'}}>
              <table className="w-full border-4 border-black">
                <thead>
                  <tr className="bg-black text-white">
                    <th className="p-4 text-left monument text-sm">PERSON</th>
                    {(data.newRoles || []).map((role) => (
                      <th key={role.id} className="p-4 text-center monument text-sm">
                        {(role.roleTitle || 'Role').substring(0, 20)}
                      </th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {(data.decisionMatrix || []).map((entry, index) => {
                    const person = (data.currentTeam || []).find(p => p.id === entry.personId);

                    return (
                      <tr key={entry.personId} className="border-b-2 border-black">
                        <td className="p-4 font-bold bg-gray-100">
                          {person?.name || 'Person'}
                        </td>
                        {(data.newRoles || []).map((role) => {
                          const score = entry.roleScores?.[role.id] || 0;
                          const cellClass = getMatrixCellClass(score);

                          return (
                            <td key={role.id} className={`matrix-cell ${cellClass}`}>
                              <input
                                type="number"
                                min="0"
                                max="1"
                                step="0.1"
                                value={score}
                                onChange={(e) => updateMatrixScore(entry.personId, role.id, e.target.value)}
                                className="w-20 text-center p-2 border-2 border-black"
                              />
                            </td>
                          );
                        })}
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>

            {/* Legend */}
            <div className="grid grid-cols-4 gap-4 mb-8 animate-in" style={{animationDelay: '0.2s'}}>
              <div className="score-excellent p-4 text-center">
                <p className="font-bold mb-1">0.8 - 1.0</p>
                <p className="text-sm">EXCELLENT</p>
                <p className="text-xs">Immediate placement</p>
              </div>
              <div className="score-good p-4 text-center">
                <p className="font-bold mb-1">0.6 - 0.79</p>
                <p className="text-sm">GOOD</p>
                <p className="text-xs">Development needed</p>
              </div>
              <div className="score-moderate p-4 text-center">
                <p className="font-bold mb-1">0.4 - 0.59</p>
                <p className="text-sm">MODERATE</p>
                <p className="text-xs">High risk</p>
              </div>
              <div className="score-poor p-4 text-center">
                <p className="font-bold mb-1">Below 0.4</p>
                <p className="text-sm">POOR</p>
                <p className="text-xs">Not recommended</p>
              </div>
            </div>

        </div>
      );
    }

    // Step 4: Action Plan Component
    function Step4Page({ data, updateActionPlanItem }) {
      return (
        <div>
            <div className="mb-8 animate-in">
              <div className="numbered-section mb-4">STEP 04</div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  Chip Heath and Dan Heath's "Switch" framework shows that successful change requires directing the rational mind (clear categories and timelines), motivating emotions (honest communication about why), and shaping the path (removing obstacles). Research from Kotter's 8-step change model confirms that organizations communicating changes within 2 weeks of decision see 73% higher adoption rates than those that delay (Harvard Business Review). The three-tier categorization approach reduces decision fatigue by 60% compared to case-by-case evaluation.
              </ScienceBox>

              <h1 className="plaak text-6xl mb-4">ACTION PLAN</h1>
              <p className="text-2xl text-gray-600 mb-4">
                Auto-categorized based on Decision Matrix scores. Add timelines and details for each category.
              </p>
              <div className="bg-yellow-100 border-l-4 border-yellow-600 p-4">
                <p className="text-lg"><strong>Categories:</strong> Immediate (0.8+), Development (0.6-0.79), Transition (below 0.6)</p>
              </div>
            </div>

            {/* Immediate Placement */}
            <div className="mb-8 animate-in" style={{animationDelay: '0.05s'}}>
              <div className="flex items-center gap-4 mb-4">
                <span className="category-badge category-immediate">IMMEDIATE PLACEMENT</span>
                <span className="text-xl">FIT Score 0.8+ - Ready for immediate placement</span>
              </div>

              {(data.actionPlan?.immediate || []).length === 0 ? (
                <div className="border-2 border-dashed border-gray-300 p-8 text-center text-gray-500">
                  No team members scored 0.8+ in any role. Consider external hiring for critical positions.
                </div>
              ) : (
                <div className="space-y-4">
                  {(data.actionPlan?.immediate || []).map((item, index) => (
                    <div key={item.personId} className="border-2 border-black p-6 bg-gray-50">
                      <h3 className="text-2xl font-bold mb-4">{item.name} → {item.assignedRole}</h3>
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="monument text-sm block mb-2">START DATE</label>
                          <input
                            type="date"
                            value={item.startDate || ''}
                            onChange={(e) => updateActionPlanItem('immediate', item.personId, 'startDate', e.target.value)}
                            className="w-full"
                          />
                        </div>
                        <div>
                          <label className="monument text-sm block mb-2">FIT SCORE</label>
                          <div className="text-3xl font-bold pt-2">{item.fitScore.toFixed(2)}</div>
                        </div>
                      </div>
                      <div className="mt-4">
                        <label className="monument text-sm block mb-2">SUCCESS METRICS (FIRST 90 DAYS)</label>
                        <textarea
                          value={item.successMetrics || ''}
                          onChange={(e) => updateActionPlanItem('immediate', item.personId, 'successMetrics', e.target.value)}
                          placeholder="Define measurable outcomes for first 90 days in role..."
                          className="w-full"
                        />
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Development Required */}
            <div className="mb-8 animate-in" style={{animationDelay: '0.1s'}}>
              <div className="flex items-center gap-4 mb-4">
                <span className="category-badge category-development">DEVELOPMENT REQUIRED</span>
                <span className="text-xl">FIT Score 0.6-0.79 - Needs development plan (Step 5)</span>
              </div>

              {(data.actionPlan?.development || []).length === 0 ? (
                <div className="border-2 border-dashed border-gray-300 p-8 text-center text-gray-500">
                  No team members in development category.
                </div>
              ) : (
                <div className="space-y-4">
                  {(data.actionPlan?.development || []).map((item, index) => (
                    <div key={item.personId} className="border-2 border-yellow-500 p-6 bg-yellow-50">
                      <h3 className="text-2xl font-bold mb-4">{item.name} → {item.targetRole}</h3>
                      <div className="grid grid-cols-3 gap-4">
                        <div>
                          <label className="monument text-sm block mb-2">FIT SCORE</label>
                          <div className="text-3xl font-bold pt-2">{item.fitScore.toFixed(2)}</div>
                        </div>
                        <div>
                          <label className="monument text-sm block mb-2">DEVELOPMENT TIMELINE</label>
                          <select
                            value={item.developmentTimeline || ''}
                            onChange={(e) => updateActionPlanItem('development', item.personId, 'developmentTimeline', e.target.value)}
                            className="w-full"
                          >
                            <option value="">Select...</option>
                            <option value="1-3 months">1-3 months</option>
                            <option value="3-6 months">3-6 months</option>
                            <option value="6-12 months">6-12 months</option>
                          </select>
                        </div>
                        <div>
                          <label className="monument text-sm block mb-2">ASSIGNED MENTOR</label>
                          <input
                            type="text"
                            value={item.mentor || ''}
                            onChange={(e) => updateActionPlanItem('development', item.personId, 'mentor', e.target.value)}
                            placeholder="Mentor name"
                            className="w-full"
                          />
                        </div>
                      </div>
                      <div className="mt-4 bg-white p-4 border-l-4 border-yellow-600">
                        <p className="text-sm font-bold">Note: Personal Development Plan will be created in Step 5</p>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Transition Out */}
            <div className="mb-8 animate-in" style={{animationDelay: '0.15s'}}>
              <div className="flex items-center gap-4 mb-4">
                <span className="category-badge category-transition">TRANSITION</span>
                <span className="text-xl">FIT Score below 0.6 for all roles - Needs transition plan</span>
              </div>

              {(data.actionPlan?.transition || []).length === 0 ? (
                <div className="border-2 border-dashed border-gray-300 p-8 text-center text-gray-500">
                  No team members in transition category.
                </div>
              ) : (
                <div className="space-y-4">
                  {(data.actionPlan?.transition || []).map((item, index) => (
                    <div key={item.personId} className="border-2 border-red-500 p-6 bg-red-50">
                      <h3 className="text-2xl font-bold mb-4">{item.name} - Current: {item.currentRole}</h3>
                      <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                          <label className="monument text-sm block mb-2">TRANSITION TYPE</label>
                          <select
                            value={item.transitionType || ''}
                            onChange={(e) => updateActionPlanItem('transition', item.personId, 'transitionType', e.target.value)}
                            className="w-full"
                          >
                            <option value="">Select...</option>
                            <option value="reassign">Reassignment to different role</option>
                            <option value="exit">Exit with dignity</option>
                            <option value="eliminate">Role elimination</option>
                          </select>
                        </div>
                        <div>
                          <label className="monument text-sm block mb-2">TIMELINE</label>
                          <select
                            value={item.timeline || ''}
                            onChange={(e) => updateActionPlanItem('transition', item.personId, 'timeline', e.target.value)}
                            className="w-full"
                          >
                            <option value="">Select...</option>
                            <option value="30 days">30 days</option>
                            <option value="60 days">60 days</option>
                            <option value="90 days">90 days</option>
                          </select>
                        </div>
                      </div>
                      <div>
                        <label className="monument text-sm block mb-2">NOTES / TRANSITION PLAN</label>
                        <textarea
                          value={item.notes || ''}
                          onChange={(e) => updateActionPlanItem('transition', item.personId, 'notes', e.target.value)}
                          placeholder="Communication plan, severance details, transition support..."
                          className="w-full"
                        />
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

        </div>
      );
    }

    // Step 5: Personal Development Plans Component
    function Step5Page({ data, updatePDP, addCapability, removeCapability, updateCapability }) {
      const [currentPdpIndex, setCurrentPdpIndex] = useState(0);

      return (
        <div>
            <div className="mb-8 animate-in">
              <div className="numbered-section mb-4">STEP 05</div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  Research on deliberate practice (Ericsson, "Peak") shows that targeted capability development with clear feedback loops accelerates skill acquisition by 3-5x compared to generic training. Lombardo and Eichinger's 70-20-10 model demonstrates that 70% of development comes from on-the-job challenges, 20% from mentoring and coaching, and only 10% from formal training. Organizations with structured PDPs and regular checkpoint reviews show 45% faster time-to-competence and 38% higher retention of high-potential employees (Corporate Leadership Council).
              </ScienceBox>

              <h1 className="plaak text-6xl mb-4">PERSONAL DEVELOPMENT PLANS</h1>
              <p className="text-2xl text-gray-600 mb-4">
                Create development roadmaps for everyone in the "Development Required" category.
              </p>
              <div className="bg-yellow-100 border-l-4 border-yellow-600 p-4">
                <p className="text-lg"><strong>Structure:</strong> Core activity → Capabilities → Gap analysis → What/When/ByWhom → 30-60-90 checkpoints</p>
              </div>
            </div>

            {/* PDPs */}
            {(data.pdps || []).length === 0 ? (
              <div className="border-4 border-dashed border-gray-300 p-12 text-center text-gray-500 mb-8">
                <p className="text-2xl mb-4">No PDPs needed - no team members in Development Required category.</p>
                <p className="text-xl">You can proceed to the final canvas.</p>
              </div>
            ) : (
              <div className="mb-8">
                {/* PDP Navigation Header */}
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 20, padding: '12px 16px', background: '#f9f9f9', border: '1px solid #e0e0e0' }}>
                    <button
                        onClick={() => setCurrentPdpIndex(Math.max(0, currentPdpIndex - 1))}
                        disabled={currentPdpIndex === 0}
                        style={{ fontFamily: "'Monument', monospace", fontSize: 11, background: 'none', border: '1px solid #000', padding: '8px 16px', cursor: currentPdpIndex === 0 ? 'not-allowed' : 'pointer', opacity: currentPdpIndex === 0 ? 0.3 : 1 }}
                    >
                        ← PREV
                    </button>
                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, letterSpacing: '0.06em' }}>
                        TEAM MEMBER {currentPdpIndex + 1} OF {(data.pdps || []).length}
                    </span>
                    <button
                        onClick={() => setCurrentPdpIndex(Math.min((data.pdps || []).length - 1, currentPdpIndex + 1))}
                        disabled={currentPdpIndex === (data.pdps || []).length - 1}
                        style={{ fontFamily: "'Monument', monospace", fontSize: 11, background: 'none', border: '1px solid #000', padding: '8px 16px', cursor: currentPdpIndex === (data.pdps || []).length - 1 ? 'not-allowed' : 'pointer', opacity: currentPdpIndex === (data.pdps || []).length - 1 ? 0.3 : 1 }}
                    >
                        NEXT →
                    </button>
                </div>

                {/* Current PDP */}
                {(data.pdps || []).length > 0 && (data.pdps || [])[currentPdpIndex] && (() => {
                  const pdp = (data.pdps || [])[currentPdpIndex];
                  return (
                  <div key={pdp.personId} className="border-4 border-black p-8 animate-in">
                    <h2 className="plaak text-4xl mb-6">{pdp.name} - PDP</h2>

                    <div className="grid grid-cols-2 gap-6 mb-6">
                      <div>
                        <label className="monument text-sm block mb-2">TARGET ROLE</label>
                        <input
                          type="text"
                          value={pdp.targetRole || ''}
                          disabled
                          className="w-full bg-gray-100"
                        />
                      </div>
                      <div>
                        <label className="monument text-sm block mb-2">CORE ACTIVITY (FROM SPRINT 22)</label>
                        <input
                          type="text"
                          value={pdp.coreActivity || ''}
                          onChange={(e) => updatePDP(pdp.personId, 'coreActivity', e.target.value)}
                          placeholder="E.g., Customer Acquisition"
                          className="w-full"
                        />
                      </div>
                    </div>

                    {/* Capabilities */}
                    <div className="mb-6">
                      <h3 className="plaak text-2xl mb-4">CAPABILITY GAPS</h3>
                      <div className="space-y-6">
                        {(pdp.capabilities || []).map((cap, capIndex) => (
                          <div key={cap.id} className="border-2 border-gray-300 p-6 bg-gray-50">
                            <div className="flex justify-between items-start mb-4">
                              <h4 className="font-bold text-xl">Capability {capIndex + 1}</h4>
                              {(pdp.capabilities || []).length > 1 && (
                                <button
                                  onClick={() => removeCapability(pdp.personId, cap.id)}
                                  className="btn-remove"
                                >
                                  REMOVE
                                </button>
                              )}
                            </div>

                            <div className="grid grid-cols-3 gap-4 mb-4">
                              <div className="col-span-2">
                                <label className="monument text-sm block mb-2">CAPABILITY NAME</label>
                                <input
                                  type="text"
                                  value={cap.capability || ''}
                                  onChange={(e) => updateCapability(pdp.personId, cap.id, 'capability', e.target.value)}
                                  placeholder="E.g., Data analysis & forecasting"
                                  className="w-full"
                                />
                              </div>
                              <div>
                                <label className="monument text-sm block mb-2">CURRENT FULFILLMENT (%)</label>
                                <input
                                  type="number"
                                  min="0"
                                  max="100"
                                  value={cap.currentFulfillment || 0}
                                  onChange={(e) => updateCapability(pdp.personId, cap.id, 'currentFulfillment', parseInt(e.target.value) || 0)}
                                  className="w-full"
                                />
                              </div>
                            </div>

                            <div className="mb-4 p-4 bg-white border-l-4 border-black">
                              <p className="monument text-sm mb-1">GAP TO CLOSE</p>
                              <p className="text-3xl font-bold">{cap.gap || 100}%</p>
                            </div>

                            <div className="grid grid-cols-3 gap-4">
                              <div>
                                <label className="monument text-sm block mb-2">WHAT (ACTION)</label>
                                <textarea
                                  value={cap.what || ''}
                                  onChange={(e) => updateCapability(pdp.personId, cap.id, 'what', e.target.value)}
                                  placeholder="Specific training, course, mentorship..."
                                  className="w-full"
                                />
                              </div>
                              <div>
                                <label className="monument text-sm block mb-2">WHEN (DEADLINE)</label>
                                <input
                                  type="date"
                                  value={cap.when || ''}
                                  onChange={(e) => updateCapability(pdp.personId, cap.id, 'when', e.target.value)}
                                  className="w-full"
                                />
                              </div>
                              <div>
                                <label className="monument text-sm block mb-2">BY WHOM (OWNER)</label>
                                <input
                                  type="text"
                                  value={cap.byWhom || ''}
                                  onChange={(e) => updateCapability(pdp.personId, cap.id, 'byWhom', e.target.value)}
                                  placeholder="Manager, HR, Trainer..."
                                  className="w-full"
                                />
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>

                      <button
                        onClick={() => addCapability(pdp.personId)}
                        className="btn-secondary w-full mt-4"
                      >
                        + ADD CAPABILITY
                      </button>
                    </div>

                    {/* Checkpoints */}
                    <div className="space-y-4">
                      <h3 className="plaak text-2xl mb-4">30-60-90 DAY CHECKPOINTS</h3>

                      <div className="checkpoint-box">
                        <label className="monument text-sm block mb-2">30-DAY CHECKPOINT</label>
                        <textarea
                          value={pdp.checkpoint30Days || ''}
                          onChange={(e) => updatePDP(pdp.personId, 'checkpoint30Days', e.target.value)}
                          placeholder="What should be achieved after 30 days? Initial training started, mentor assigned..."
                          className="w-full"
                        />
                      </div>

                      <div className="checkpoint-box">
                        <label className="monument text-sm block mb-2">60-DAY CHECKPOINT</label>
                        <textarea
                          value={pdp.checkpoint60Days || ''}
                          onChange={(e) => updatePDP(pdp.personId, 'checkpoint60Days', e.target.value)}
                          placeholder="What should be achieved after 60 days? 50% of development activities completed..."
                          className="w-full"
                        />
                      </div>

                      <div className="checkpoint-box">
                        <label className="monument text-sm block mb-2">90-DAY CHECKPOINT</label>
                        <textarea
                          value={pdp.checkpoint90Days || ''}
                          onChange={(e) => updatePDP(pdp.personId, 'checkpoint90Days', e.target.value)}
                          placeholder="What should be achieved after 90 days? Ready for role transition or decision made..."
                          className="w-full"
                        />
                      </div>
                    </div>
                  </div>
                  );
                })()}
              </div>
            )}

        </div>
      );
    }

    // Canvas Page Component
    function CanvasPage({ data, onExport, onSubmit }) {
      const totalTeam = (data.currentTeam || []).length;
      const immediatePlacements = (data.actionPlan?.immediate || []).length;
      const developmentNeeded = (data.actionPlan?.development || []).length;
      const transitions = (data.actionPlan?.transition || []).length;
      const externalHires = (data.newRoles || []).length - immediatePlacements - developmentNeeded;

      return (
        <div className="min-h-screen bg-white p-8">
          <div className="max-w-7xl mx-auto">
            <div id="canvas-content">
              {/* Header */}
              <div className="mb-12 text-center animate-in">
                <h1 className="plaak mb-6" style={{fontSize: '80px'}}>
                  ORGANIZATIONAL REDESIGN
                </h1>
                <h2 className="plaak text-5xl mb-4" style={{color: '#000000'}}>
                  90-DAY IMPLEMENTATION CANVAS
                </h2>
                <p className="text-2xl text-gray-600">
                  Your complete roadmap from current structure to optimized organization
                </p>
              </div>

              {/* Summary Stats */}
              <div className="grid grid-cols-5 gap-4 mb-12 animate-in" style={{animationDelay: '0.1s'}}>
                <div className="border-4 border-black p-6 text-center">
                  <div className="text-6xl plaak mb-2">{totalTeam}</div>
                  <p className="monument text-sm">CURRENT TEAM</p>
                </div>
                <div className="border-4 border-black p-6 text-center bg-gray-50">
                  <div className="text-6xl plaak mb-2">{immediatePlacements}</div>
                  <p className="monument text-sm">IMMEDIATE</p>
                </div>
                <div className="border-4 border-yellow-500 p-6 text-center bg-yellow-50">
                  <div className="text-6xl plaak mb-2">{developmentNeeded}</div>
                  <p className="monument text-sm">DEVELOPMENT</p>
                </div>
                <div className="border-4 border-red-500 p-6 text-center bg-red-50">
                  <div className="text-6xl plaak mb-2">{transitions}</div>
                  <p className="monument text-sm">TRANSITIONS</p>
                </div>
                <div className="border-4 border-black p-6 text-center bg-gray-50">
                  <div className="text-6xl plaak mb-2">{Math.max(0, externalHires)}</div>
                  <p className="monument text-sm">EXTERNAL HIRES</p>
                </div>
              </div>

              {/* FIT Score Distribution */}
              <div className="mb-12 animate-in" style={{animationDelay: '0.15s'}}>
                <h2 className="plaak text-4xl mb-6">CURRENT TEAM FIT DISTRIBUTION</h2>
                <div className="border-4 border-black p-6">
                  {(data.currentTeam || []).map((member) => {
                    const fitInterpretation = getFitInterpretation(member.totalFit || 0);
                    return (
                      <div key={member.id} className="flex items-center justify-between py-3 border-b-2 border-gray-200 last:border-b-0">
                        <div className="flex-1">
                          <p className="font-bold text-xl">{member.name || 'Team Member'}</p>
                          <p className="text-gray-600">{member.currentPosition || 'Position'}</p>
                        </div>
                        <div className="text-center px-6">
                          <p className="text-3xl font-bold">{(member.totalFit || 0).toFixed(2)}</p>
                          <span className={`fit-indicator ${fitInterpretation.class} mt-2`}>
                            {fitInterpretation.label}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Role Criticality */}
              <div className="mb-12 animate-in" style={{animationDelay: '0.2s'}}>
                <h2 className="plaak text-4xl mb-6">NEW ROLES BY CRITICALITY</h2>
                <div className="border-4 border-black p-6">
                  {(data.newRoles || [])
                    .sort((a, b) => (b.criticality || 0) - (a.criticality || 0))
                    .map((role) => (
                      <div key={role.id} className="py-4 border-b-2 border-gray-200 last:border-b-0">
                        <div className="flex items-center justify-between mb-2">
                          <p className="font-bold text-2xl">{role.roleTitle || 'Role'}</p>
                          <div className="flex items-center gap-4">
                            <span className="text-3xl font-bold">{role.criticality || 5}</span>
                            <span className="px-4 py-2 bg-black text-white monument text-sm">
                              {getCriticalityLabel(role.criticality || 5)}
                            </span>
                          </div>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-3">
                          {(role.requiredSkills || []).filter(s => (s || '').trim().length > 0).map((skill, index) => (
                            <span key={index} className="skill-chip">
                              {skill}
                            </span>
                          ))}
                        </div>
                      </div>
                    ))}
                </div>
              </div>

              {/* Action Plan Breakdown */}
              <div className="mb-12 animate-in" style={{animationDelay: '0.25s'}}>
                <h2 className="plaak text-4xl mb-6">ACTION PLAN BREAKDOWN</h2>

                {/* Immediate */}
                <div className="mb-6">
                  <div className="bg-black text-white p-4 plaak text-2xl">
                    IMMEDIATE PLACEMENT ({immediatePlacements})
                  </div>
                  <div className="border-4 border-black p-6 bg-gray-50">
                    {(data.actionPlan?.immediate || []).map((item) => (
                      <div key={item.personId} className="mb-4 pb-4 border-b-2 border-gray-200 last:border-b-0">
                        <p className="text-xl font-bold">{item.name} → {item.assignedRole}</p>
                        <p className="text-lg">FIT Score: {item.fitScore.toFixed(2)} | Start: {item.startDate || 'TBD'}</p>
                        {item.successMetrics && (
                          <p className="text-base text-gray-700 mt-2">Success: {item.successMetrics}</p>
                        )}
                      </div>
                    ))}
                    {immediatePlacements === 0 && (
                      <p className="text-gray-600">No immediate placements. Consider external hiring.</p>
                    )}
                  </div>
                </div>

                {/* Development */}
                <div className="mb-6">
                  <div className="bg-yellow-600 text-white p-4 plaak text-2xl">
                    DEVELOPMENT REQUIRED ({developmentNeeded})
                  </div>
                  <div className="border-4 border-yellow-600 p-6 bg-yellow-50">
                    {(data.actionPlan?.development || []).map((item) => (
                      <div key={item.personId} className="mb-4 pb-4 border-b-2 border-yellow-200 last:border-b-0">
                        <p className="text-xl font-bold">{item.name} → {item.targetRole}</p>
                        <p className="text-lg">FIT Score: {item.fitScore.toFixed(2)} | Timeline: {item.developmentTimeline || 'TBD'}</p>
                        {item.mentor && (
                          <p className="text-base text-gray-700 mt-2">Mentor: {item.mentor}</p>
                        )}
                      </div>
                    ))}
                    {developmentNeeded === 0 && (
                      <p className="text-gray-600">No development candidates.</p>
                    )}
                  </div>
                </div>

                {/* Transitions */}
                <div className="mb-6">
                  <div className="bg-red-600 text-white p-4 plaak text-2xl">
                    TRANSITIONS ({transitions})
                  </div>
                  <div className="border-4 border-red-600 p-6 bg-red-50">
                    {(data.actionPlan?.transition || []).map((item) => (
                      <div key={item.personId} className="mb-4 pb-4 border-b-2 border-red-200 last:border-b-0">
                        <p className="text-xl font-bold">{item.name} - {item.currentRole}</p>
                        <p className="text-lg">Type: {item.transitionType || 'TBD'} | Timeline: {item.timeline || 'TBD'}</p>
                        {item.notes && (
                          <p className="text-base text-gray-700 mt-2">{item.notes}</p>
                        )}
                      </div>
                    ))}
                    {transitions === 0 && (
                      <p className="text-gray-600">No transitions needed.</p>
                    )}
                  </div>
                </div>
              </div>

              {/* PDP Summary */}
              {(data.pdps || []).length > 0 && (
                <div className="mb-12 animate-in" style={{animationDelay: '0.3s'}}>
                  <h2 className="plaak text-4xl mb-6">PERSONAL DEVELOPMENT PLANS</h2>
                  {(data.pdps || []).map((pdp) => (
                    <div key={pdp.personId} className="border-4 border-black p-6 mb-6">
                      <h3 className="plaak text-3xl mb-4">{pdp.name} - {pdp.targetRole}</h3>
                      <p className="text-xl mb-4"><strong>Core Activity:</strong> {pdp.coreActivity || 'TBD'}</p>

                      <div className="mb-4">
                        <p className="monument text-sm mb-2">CAPABILITY GAPS ({(pdp.capabilities || []).length})</p>
                        {(pdp.capabilities || []).map((cap, index) => (
                          <div key={cap.id} className="bg-gray-100 p-4 mb-2">
                            <p className="font-bold text-lg">{cap.capability || `Capability ${index + 1}`}</p>
                            <div className="grid grid-cols-4 gap-4 mt-2 text-sm">
                              <div>
                                <span className="monument text-xs">CURRENT:</span>
                                <p className="font-bold">{cap.currentFulfillment || 0}%</p>
                              </div>
                              <div>
                                <span className="monument text-xs">GAP:</span>
                                <p className="font-bold">{cap.gap || 100}%</p>
                              </div>
                              <div>
                                <span className="monument text-xs">WHAT:</span>
                                <p>{cap.what || 'TBD'}</p>
                              </div>
                              <div>
                                <span className="monument text-xs">WHEN:</span>
                                <p>{cap.when || 'TBD'}</p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>

                      <div className="grid grid-cols-3 gap-4">
                        <div className="checkpoint-box">
                          <p className="monument text-xs mb-1">30 DAYS</p>
                          <p className="text-sm">{pdp.checkpoint30Days || 'TBD'}</p>
                        </div>
                        <div className="checkpoint-box">
                          <p className="monument text-xs mb-1">60 DAYS</p>
                          <p className="text-sm">{pdp.checkpoint60Days || 'TBD'}</p>
                        </div>
                        <div className="checkpoint-box">
                          <p className="monument text-xs mb-1">90 DAYS</p>
                          <p className="text-sm">{pdp.checkpoint90Days || 'TBD'}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* 90-Day Timeline */}
              <div className="mb-12 animate-in" style={{animationDelay: '0.35s'}}>
                <h2 className="plaak text-4xl mb-6">90-DAY IMPLEMENTATION TIMELINE</h2>
                <div className="border-4 border-black p-8 space-y-8">
                  <div>
                    <div className="bg-black text-white p-4 plaak text-2xl mb-4">WEEK 1-2</div>
                    <ul className="text-lg space-y-2 ml-6">
                      <li>Announce organizational changes to full company</li>
                      <li>Confirm immediate placements ({immediatePlacements} people)</li>
                      <li>Start exit conversations for transitions ({transitions} people)</li>
                      <li>Launch PDPs for development candidates ({developmentNeeded} people)</li>
                    </ul>
                  </div>

                  <div>
                    <div className="bg-black text-white p-4 plaak text-2xl mb-4">WEEK 3-4</div>
                    <ul className="text-lg space-y-2 ml-6">
                      <li>Begin recruitment for external hire roles ({Math.max(0, externalHires)} positions)</li>
                      <li>Execute first wave of transitions</li>
                      <li>30-day PDP checkpoints completed</li>
                    </ul>
                  </div>

                  <div>
                    <div className="bg-black text-white p-4 plaak text-2xl mb-4">MONTH 2</div>
                    <ul className="text-lg space-y-2 ml-6">
                      <li>Continue development programs</li>
                      <li>Interview external candidates</li>
                      <li>Second wave of internal transitions</li>
                      <li>60-day PDP checkpoints completed</li>
                    </ul>
                  </div>

                  <div>
                    <div className="bg-black text-white p-4 plaak text-2xl mb-4">MONTH 3</div>
                    <ul className="text-lg space-y-2 ml-6">
                      <li>Complete development assessments (90-day checkpoints)</li>
                      <li>Make final promote/exit decisions</li>
                      <li>External hires start onboarding</li>
                      <li>New structure fully operational</li>
                    </ul>
                  </div>
                </div>
              </div>

              {/* Critical Success Factors */}
              <div className="mb-12 animate-in" style={{animationDelay: '0.4s'}}>
                <h2 className="plaak text-4xl mb-6">CRITICAL SUCCESS FACTORS</h2>
                <div className="border-4 border-black p-8 bg-yellow-50">
                  <ul className="text-lg space-y-4">
                    <li className="flex items-start gap-4">
                      <span className="text-3xl font-bold">1.</span>
                      <div>
                        <p className="font-bold text-xl">Brutal Honesty in Assessment</p>
                        <p>Sugar-coating FIT scores leads to wrong placements. Model honest self-assessment from CEO down.</p>
                      </div>
                    </li>
                    <li className="flex items-start gap-4">
                      <span className="text-3xl font-bold">2.</span>
                      <div>
                        <p className="font-bold text-xl">Speed Over Perfection</p>
                        <p>Better to make good decision in 4 hours than perfect decision in 4 weeks. Market won't wait.</p>
                      </div>
                    </li>
                    <li className="flex items-start gap-4">
                      <span className="text-3xl font-bold">3.</span>
                      <div>
                        <p className="font-bold text-xl">Clear Communication</p>
                        <p>People can handle hard truths if delivered with respect and clarity. Ambiguity creates fear.</p>
                      </div>
                    </li>
                    <li className="flex items-start gap-4">
                      <span className="text-3xl font-bold">4.</span>
                      <div>
                        <p className="font-bold text-xl">Follow-Through on PDPs</p>
                        <p>60% of development plans fail due to lack of accountability. Weekly check-ins are essential.</p>
                      </div>
                    </li>
                    <li className="flex items-start gap-4">
                      <span className="text-3xl font-bold">5.</span>
                      <div>
                        <p className="font-bold text-xl">Compassionate Exits</p>
                        <p>How you treat people on the way out determines whether A-players trust you going forward.</p>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>

              {/* Next Steps */}
              <div className="mb-12 animate-in" style={{animationDelay: '0.45s'}}>
                <h2 className="plaak text-4xl mb-6">IMMEDIATE NEXT STEPS</h2>
                <div className="border-4 border-black p-8 space-y-6">
                  <div className="checkpoint-box">
                    <p className="monument text-sm mb-2">THIS WEEK</p>
                    <ul className="text-lg space-y-2">
                      <li>Schedule all-hands meeting to announce organizational changes</li>
                      <li>Prepare individual conversation scripts for all affected team members</li>
                      <li>Confirm start dates for immediate placements</li>
                    </ul>
                  </div>

                  <div className="checkpoint-box">
                    <p className="monument text-sm mb-2">NEXT 2 WEEKS</p>
                    <ul className="text-lg space-y-2">
                      <li>Complete all one-on-one placement conversations</li>
                      <li>Launch job postings for external hire positions</li>
                      <li>Assign mentors and initiate PDP kick-off meetings</li>
                    </ul>
                  </div>

                  <div className="checkpoint-box">
                    <p className="monument text-sm mb-2">MONTH 1</p>
                    <ul className="text-lg space-y-2">
                      <li>Track immediate placement performance against 90-day metrics</li>
                      <li>Conduct 30-day PDP checkpoint reviews</li>
                      <li>Begin candidate interviews for external hires</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-4 justify-center mt-12">
              <button
                onClick={onExport}
                className="btn-secondary text-xl px-12 py-6"
              >
                EXPORT PDF
              </button>
              <button
                onClick={onSubmit}
                className="btn-primary text-xl px-12 py-6"
              >
                SUBMIT ORGANIZATIONAL REDESIGN
              </button>
            </div>

            {/* Case Study */}
            <CaseStudy
                before={"A 200-person B2B services firm kept the same org chart for 5 years while tripling in size. Roles were designed around personalities, not functions. The CEO had 14 direct reports. Decision bottlenecks delayed client delivery by weeks, and B-players occupied mission-critical positions because nobody had the courage to make changes."}
                after={"Redesigned around 5 core value streams with clear process owners and optimal 5-7 span of control. Used four-dimensional FIT analysis to place A-players in critical roles, built 90-day PDPs for B+ players, and compassionately transitioned 3 poor-fit team members. Decision speed doubled. Client satisfaction rose 34%. Revenue per employee increased 28% within 6 months."}
                quote={"We finally stopped designing the org around who we had and started designing it around what the business needed. The hardest part was admitting our current structure was built for comfort, not performance. - CEO, B2B Services Company"}
            />
          </div>
        </div>
      );
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<OrganizationalRedesignApp />);
  </script>
</body>
</html>
