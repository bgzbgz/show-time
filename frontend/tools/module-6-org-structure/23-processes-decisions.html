<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Processes & Decisions | Fast Track Program</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

    <style>
        @font-face { font-family: 'Plaak';    src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; }
        @font-face { font-family: 'Riforma';  src: url('RiformaLL-Regular.woff2')   format('woff2'); font-weight: normal; }
        @font-face { font-family: 'Riforma';  src: url('RiformaLL-Regular.woff2')   format('woff2'); font-weight: 600; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Riforma', -apple-system, sans-serif; font-size: 16px; color: #000; background: #000; -webkit-font-smoothing: antialiased; }

        .plaak   { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        /* ── Wizard layout ── */
        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main { flex: 1; display: flex; flex-direction: column; min-height: 100vh; background: #fff; padding: 0 48px; }
        .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }

        /* ── Step content ── */
        .step-content { max-width: 100%; padding: 40px 0; flex: 1; }
        .step-indicator { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 8px; }
        .opening-box { margin-bottom: 32px; }
        .opening-box .step-heading { font-family: 'Plaak', sans-serif; font-weight: bold; font-size: 32px; letter-spacing: -0.01em; line-height: 1.2; color: #000; margin-bottom: 6px; }
        .opening-box .step-hint { font-size: 14px; color: #666; line-height: 1.5; margin: 0; }

        /* ── Fields ── */
        .field-group { margin-bottom: 40px; }
        .field-group:last-child { margin-bottom: 0; }
        .field-label { font-weight: 600; font-size: 16px; color: #000; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .field-input { border: 1px solid #E0E0E0; padding: 12px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; width: 100%; color: #000; background: #fff; transition: border-color 0.2s; }
        .field-input:focus { outline: none; border-color: #000; }
        .field-textarea { border: 1px solid #E0E0E0; padding: 12px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; width: 100%; min-height: 80px; resize: none !important; color: #000; background: #fff; transition: border-color 0.2s; }
        .field-textarea:focus { outline: none; border-color: #000; }
        .field-help  { font-size: 13px; color: #666; margin-top: 4px; }
        .field-error { font-size: 13px; color: #DC2626; margin-top: 4px; }

        /* ── Closing box ── */
        .closing-box { border-top: 1px solid #E0E0E0; padding: 20px 0 0 0; margin-top: 8px; text-align: center; }
        .closing-box p { font-size: 14px; color: #666; }
        .closing-box .closing-title { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #000; margin-bottom: 6px; }

        /* ── Wizard footer / buttons ── */
        .wizard-footer { display: flex; justify-content: space-between; align-items: center; padding: 24px 48px; border-top: 1px solid #e5e7eb; background: #fff; }
        .btn-wiz-back { background: transparent; border: 2px solid #d1d5db; color: #6b7280; padding: 12px 28px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-wiz-back:hover { border-color: #000; color: #000; }
        .btn-wiz-next { background: #000; color: #fff; border: 2px solid #000; padding: 12px 36px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-wiz-next:hover:not(:disabled) { background: #FFF469; color: #000; border-color: #FFF469; }
        .btn-wiz-next:disabled { background: #E0E0E0; color: #9CA3AF; border-color: #E0E0E0; cursor: not-allowed; }

        /* ── Learn more ── */
        .learn-more-toggle { font-family: 'Monument', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: #000; background: #F5F5F5; border: 1px solid #E0E0E0; cursor: pointer; padding: 10px 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 24px; width: 100%; }
        .learn-more-content { background: #F5F5F5; border: 1px solid #E0E0E0; border-top: none; padding: 16px; font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 24px; }

        /* ── Activity tab navigator ── */
        .activity-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .activity-tab { padding: 8px 18px; border: 2px solid #E0E0E0; background: #fff; font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
        .activity-tab.active { background: #000; color: #FFF469; border-color: #000; }
        .activity-tab.done { border-color: #000; color: #000; }

        /* ── Activity header banner ── */
        .activity-banner { background: #000; color: #fff; padding: '16px 20px'; margin-bottom: 28px; display: flex; align-items: center; gap: 16px; }

        /* ── Sub-section card ── */
        .subsection-card { border: 1px solid #E0E0E0; margin-bottom: 20px; }
        .subsection-card-header { background: #F5F5F5; padding: 10px 16px; border-bottom: 1px solid #E0E0E0; }
        .subsection-card-label { font-family: 'Monument', monospace; font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 0.1em; }
        .subsection-card-body { padding: 16px 20px; }

        /* ── Row list ── */
        .row-list-item { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .row-list-num { font-family: 'Monument', monospace; font-size: 11px; color: #999; min-width: 20px; }

        /* ── Context pill ── */
        .activity-context-pill { display: flex; align-items: center; gap: 12px; padding: '10px 16px'; background: #FFFDE7; border: 1px solid #FFF469; margin-bottom: 28px; }

        /* ── Capability grid ── */
        .capability-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        @media (max-width: 768px) { .capability-grid { grid-template-columns: 1fr; } }

        /* ── Sidebar ── */
        .sidebar-tool-num { font-family: 'Monument', monospace; font-size: 10px; color: #555; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 8px; }
        .sidebar-tool-title { font-family: 'Plaak', sans-serif; font-size: 22px; color: #fff; margin-bottom: 32px; line-height: 1.1; }
        .sidebar-step { padding: 8px 0; border-bottom: 1px solid #2a2a2a; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: opacity 0.2s; }
        .sidebar-step:last-child { border-bottom: none; }
        .sidebar-step-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; flex-shrink: 0; transition: background 0.2s; }
        .sidebar-step-dot.active { background: #FFF469; }
        .sidebar-step-dot.done   { background: #4ade80; }
        .sidebar-step-label { font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.08em; color: #555; text-transform: uppercase; transition: color 0.2s; }
        .sidebar-step-label.active { color: #FFF469; }
        .sidebar-step-label.done   { color: #4ade80; }
        .sidebar-activity-list { margin-top: 24px; border-top: 1px solid #2a2a2a; padding-top: 16px; }
        .sidebar-activity-item { font-size: 12px; color: #555; padding: 4px 0; line-height: 1.4; display: flex; gap: 8px; }
        .sidebar-activity-item.filled { color: #ccc; }
        .sidebar-activity-idx { font-family: 'Monument', monospace; font-size: 10px; color: #FFF469; flex-shrink: 0; }

        /* ── Mobile step bar ── */
        .mobile-step-bar { display: none; }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .wizard-main { padding: 0 24px; }
            .mobile-step-bar { display: flex; align-items: center; gap: 8px; padding: 16px 24px; background: #1a1a1a; }
            .mobile-step-dot { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: background 0.2s; }
            .mobile-step-dot.active { background: #FFF469; }
            .mobile-step-dot.done   { background: #4ade80; }
            .mobile-step-text { font-family: 'Monument', monospace; font-size: 11px; color: #fff; letter-spacing: 0.06em; }
            .wizard-footer { padding: 16px 24px; }
        }

        /* ── Transitions / cover ── */
        .animate-in { animation: fadeSlideIn 0.4s ease both; }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        /* ── AI message ── */
        .ai-message { background: #FFF9C4; border: 1px solid #FFF469; border-left: 4px solid #FFF469; padding: 12px 16px; font-size: 14px; color: #333; margin-bottom: 16px; line-height: 1.6; }

        /* ── Dependency context ── */
        .dep-context { border: 1px solid #E0E0E0; margin-bottom: 24px; }
        .dep-context-header { background: #F5F5F5; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .dep-context-label { font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.1em; color: #666; text-transform: uppercase; }
        .dep-context-body { padding: 14px 16px; font-size: 14px; color: #333; line-height: 1.6; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ── CONFIG ──────────────────────────────────────────────────────────────────
    const CONFIG = {
        TOOL_SLUG:    'processes-decisions',
        TOOL_TITLE:   'CORE PROCESSES & DECISIONS',
        TOOL_SUBTITLE:'Map the key decisions, KPIs and capabilities behind each core activity.',
        COVER_IMAGE:  'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1600&q=80',
        TOTAL_STEPS:  3,
        TRANSITION_CONTENT: {
            1: {
                brutalTruth: 'Most companies have no clear decision rights. When everyone decides, no one decides. Your core activities will stagnate until the right people own the right decisions — with the right data in front of them. Ambiguity is not inclusive leadership. It is an abdication of leadership.',
                peerProof: '"A leading European retailer reduced time-to-decision by 40% after mapping decision rights to their 5 core activities. They discovered that 60% of decisions were being made by people 2 levels too senior — creating bottlenecks at every level of the organisation."'
            },
            2: {
                brutalTruth: 'KPIs that don\'t change decisions are decorations. Most companies track what\'s easy to measure — not what matters. If you would not change your behaviour based on a shift in a number, replace it with something that actually drives the activity. You do not need more data. You need better data.',
                peerProof: '"Zara measures precisely 3 KPIs per core activity — sell-through rate, time to shelf, and customer return rate. That\'s 15 numbers. Their competitors track hundreds. Zara moves faster because their leadership team is aligned on a small number of decision-driving metrics."'
            },
            3: {
                brutalTruth: 'A capability gap is not a weakness — it\'s a roadmap. The companies that win are not those with the most capabilities today. They are those who know exactly what capabilities they need to build, hire, or partner for — and move first. Your gap analysis is only valuable if it becomes a to-do list with names and dates.',
                peerProof: '"A €30M professional services firm used their capability gap analysis to create 3 PDPs, make 1 strategic hire, and establish 2 technology partnerships — all within 90 days. Six months later their fastest-growing core activity had doubled its KPI score."'
            }
        },

        CLOSING_MESSAGES: {
            1: { title: 'CONTEXT CONFIRMED',  text: 'Your core activities are loaded. Now define the decisions and data that drive each one.' },
            2: { title: 'DECISIONS MAPPED',    text: 'Well done. Clear decision rights are the foundation of fast execution.' },
            3: { title: 'CAPABILITIES DEFINED', text: 'Your capability map is complete. Time to build your canvas.' },
        }
    };

    // ── Default data ─────────────────────────────────────────────────────────
    const makeDefaultActivities = () => Array(5).fill(null).map(() => ({ name: '' }));

    const makeDefaultDecisionsKpis = () => Array(5).fill(null).map(() => ({
        decisions: ['', '', ''],
        kpis: ['', '', '']
    }));

    const makeDefaultCapabilities = () => Array(5).fill(null).map(() => ({
        human: '',
        systemic: '',
        relational: '',
        gaps: ''
    }));

    const makeDefaultData = () => ({
        activities:    makeDefaultActivities(),
        decisionsKpis: makeDefaultDecisionsKpis(),
        capabilities:  makeDefaultCapabilities(),
    });

    // Safe merge loaded data into defaults
    const mergeLoaded = (saved, defaults) => {
        const merge = (arr, def) => {
            if (!Array.isArray(arr)) return def;
            return def.map((d, i) => arr[i] ? { ...d, ...arr[i] } : d);
        };
        return {
            activities:    merge(saved.activities,    defaults.activities),
            decisionsKpis: merge(saved.decisions_kpis, defaults.decisionsKpis),
            capabilities:  merge(saved.capabilities,   defaults.capabilities),
        };
    };

    // ── WizardSidebar ─────────────────────────────────────────────────────────
    function WizardSidebar({ currentStep, data }) {
        const steps = [
            { num: 1,        label: 'Core Activities' },
            { num: 2,        label: 'Decisions & KPIs' },
            { num: 3,        label: 'Capabilities' },
            { num: 'canvas', label: 'Canvas' },
        ];
        return (
            <div className="wizard-sidebar">
                <div className="sidebar-tool-num">SPRINT 23</div>
                <div className="sidebar-tool-title">{CONFIG.TOOL_TITLE}</div>
                {steps.map(s => {
                    const isCanvas = s.num === 'canvas';
                    const isDone   = isCanvas ? false : currentStep > s.num;
                    const isActive = isCanvas ? currentStep === 'canvas' : Math.floor(currentStep) === s.num;
                    const isFuture = isCanvas ? false : currentStep < s.num;
                    return (
                        <div key={s.num} className="sidebar-step"
                            style={{ opacity: isFuture ? 0.35 : 1, cursor: 'default' }}>
                            <div className={`sidebar-step-dot ${isActive ? 'active' : isDone ? 'done' : ''}`} />
                            <span className={`sidebar-step-label ${isActive ? 'active' : isDone ? 'done' : ''}`}>{s.label}</span>
                        </div>
                    );
                })}
                {currentStep >= 1 && (
                    <div className="sidebar-activity-list">
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 8 }}>CORE ACTIVITIES</div>
                        {data.activities.map((a, i) => (
                            <div key={i} className={`sidebar-activity-item ${a.name && a.name.trim() ? 'filled' : ''}`}>
                                <span className="sidebar-activity-idx">{String(i+1).padStart(2,'0')}</span>
                                <span>{(a.name && a.name.trim()) || '—'}</span>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    // ── MobileStepBar ─────────────────────────────────────────────────────────
    function MobileStepBar({ currentStep, totalSteps }) {
        return (
            <div className="mobile-step-bar">
                <span className="mobile-step-text">STEP {Math.ceil(currentStep)} OF {totalSteps}</span>
                {Array.from({ length: totalSteps }, (_, i) => {
                    const n = i + 1;
                    const isDone   = currentStep > n;
                    const isActive = Math.floor(currentStep) === n;
                    return <div key={n} className={`mobile-step-dot ${isActive ? 'active' : isDone ? 'done' : ''}`} />;
                })}
            </div>
        );
    }

    // ── DependencyContext ─────────────────────────────────────────────────────
    function DependencyContext({ deps }) {
        const [open, setOpen] = useState(false);
        if (!deps || Object.keys(deps).length === 0) return null;
        const entries = Object.entries(deps).filter(([, v]) => v);
        if (entries.length === 0) return null;
        return (
            <div className="dep-context">
                <div className="dep-context-header" onClick={() => setOpen(o => !o)}>
                    <span className="dep-context-label">Context from previous tools</span>
                    <span style={{ fontSize: 12, color: '#999' }}>{open ? '▲' : '▼'}</span>
                </div>
                {open && (
                    <div className="dep-context-body">
                        {entries.map(([k, v]) => (
                            <div key={k} style={{ marginBottom: 8 }}>
                                <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#999', textTransform: 'uppercase', letterSpacing: '0.08em' }}>{k.replace(/_/g,' ')}: </span>
                                <span>{typeof v === 'object' ? JSON.stringify(v) : String(v)}</span>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    // ── LearnMore ─────────────────────────────────────────────────────────────
    function LearnMore({ children }) {
        const [open, setOpen] = useState(false);
        return (
            <>
                <button className="learn-more-toggle" onClick={() => setOpen(o => !o)}>
                    <span>{open ? '▲' : '▼'}</span> {open ? 'Hide context' : 'Why this matters'}
                </button>
                {open && <div className="learn-more-content">{children}</div>}
            </>
        );
    }

    // ── ActivityNav ───────────────────────────────────────────────────────────
    function ActivityNav({ activities, activeIdx, onSelect, doneCheck }) {
        return (
            <div className="activity-tabs">
                {activities.map((a, i) => {
                    const isDone = doneCheck ? doneCheck(i) : false;
                    const isActive = activeIdx === i;
                    return (
                        <button key={i}
                            className={`activity-tab ${isActive ? 'active' : isDone ? 'done' : ''}`}
                            onClick={() => onSelect(i)}>
                            {String(i+1).padStart(2,'0')} {a.name ? a.name.substring(0, 16) + (a.name.length > 16 ? '…' : '') : '—'}
                        </button>
                    );
                })}
            </div>
        );
    }

    // ── ActivityBanner ────────────────────────────────────────────────────────
    function ActivityBanner({ idx, name }) {
        return (
            <div style={{ background: '#000', color: '#fff', padding: '16px 20px', marginBottom: 24, display: 'flex', alignItems: 'center', gap: 16 }}>
                <span className="plaak" style={{ fontSize: 32, color: '#FFF469' }}>{String(idx+1).padStart(2,'0')}</span>
                <div>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 4 }}>CORE ACTIVITY</div>
                    <div style={{ fontSize: 18, fontWeight: 600 }}>{name || '—'}</div>
                </div>
            </div>
        );
    }

    // ── Transition screen ─────────────────────────────────────────────────────
    function TransitionScreen({ stepNum, onNext }) {
        const t = CONFIG.TRANSITION_CONTENT[stepNum];
        if (!t) { onNext(); return null; }
        return (
            <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', zIndex: 200, overflowY: 'auto', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '64px 32px' }}>
                <div style={{ maxWidth: 720, width: '100%' }} className="animate-in">
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#555', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 32 }}>
                        SPRINT 23 — CORE PROCESSES & DECISIONS
                    </div>
                    <div style={{ borderLeft: '4px solid #DC2626', paddingLeft: 24, marginBottom: 48 }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#DC2626', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 12 }}>BRUTAL TRUTH</div>
                        <p className="plaak" style={{ fontSize: 26, lineHeight: 1.35 }}>{t.brutalTruth}</p>
                    </div>
                    <div style={{ borderLeft: '4px solid #FFF469', paddingLeft: 24, marginBottom: 64 }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 12 }}>PEER PROOF</div>
                        <p style={{ fontSize: 18, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                    </div>
                    <button onClick={onNext} className="plaak"
                        style={{ background: '#FFF469', color: '#000', border: 'none', padding: '18px 48px', fontSize: 18, cursor: 'pointer', letterSpacing: '0.05em', transition: 'all 0.2s' }}>
                        CONTINUE →
                    </button>
                </div>
            </div>
        );
    }

    // ── STEP 1: Core Activities Context ───────────────────────────────────────
    function Step1({ data, deps, aiMessage }) {
        const filledCount = data.activities.filter(a => a.name && a.name.trim()).length;
        return (
            <div className="step-content animate-in">
                <DependencyContext deps={deps} />
                <p className="step-indicator">STEP 1 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Core Activities</h1>
                    <p className="step-hint">Your 5 core activities have been pulled from Sprint 22. Review them before mapping decisions, KPIs and capabilities.</p>
                </div>
                <div style={{ background: '#F9F9F9', border: '1px solid #E0E0E0', padding: '20px 24px', marginBottom: 32 }}>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 16 }}>TOP 5 CORE ACTIVITIES (FROM SPRINT 22)</div>
                    {data.activities.map((a, i) => (
                        <div key={i} style={{ display: 'flex', alignItems: 'center', gap: 16, padding: '12px 0', borderBottom: i < 4 ? '1px solid #E0E0E0' : 'none' }}>
                            <span className="plaak" style={{ fontSize: 22, color: '#FFF469', background: '#000', padding: '4px 10px', minWidth: 44, textAlign: 'center' }}>{i+1}</span>
                            <span style={{ fontSize: 16, fontWeight: 600, color: (a.name && a.name.trim()) ? '#000' : '#bbb' }}>
                                {(a.name && a.name.trim()) || 'Not loaded from Sprint 22'}
                            </span>
                        </div>
                    ))}
                </div>

                {filledCount < 5 && (
                    <div style={{ background: '#FEF2F2', border: '1px solid #FCA5A5', borderLeft: '4px solid #DC2626', padding: 16, marginBottom: 20, fontSize: 14, color: '#333', lineHeight: 1.6 }}>
                        <strong>Only {filledCount} of 5 activities loaded.</strong> Please complete Sprint 22 (Core Activities) first — submit your answers there so they appear here.
                    </div>
                )}

                {aiMessage && <div className="ai-message">{aiMessage}</div>}

                {filledCount >= 1 && (
                    <div className="closing-box animate-in">
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[1].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[1].text}</p>
                    </div>
                )}
            </div>
        );
    }

    // ── STEP 2: Key Decisions & KPIs ─────────────────────────────────────────
    function Step2({ data, updateData, aiMessage }) {
        const [activeIdx, setActiveIdx] = useState(0);
        const activities    = data.activities;
        const decisionsKpis = data.decisionsKpis;
        const current       = decisionsKpis[activeIdx];
        const currentName   = activities[activeIdx] ? activities[activeIdx].name : '';

        const goNextActivity = () => { if (activeIdx < 4) setActiveIdx(i => i + 1); };

        const updateDecision = (dIdx, val) => {
            const newDecisions = current.decisions.map((d, di) => di === dIdx ? val : d);
            const next = decisionsKpis.map((item, i) => i === activeIdx ? { ...item, decisions: newDecisions } : item);
            updateData('decisionsKpis', next);
        };

        const updateKpi = (kIdx, val) => {
            const newKpis = current.kpis.map((k, ki) => ki === kIdx ? val : k);
            const next = decisionsKpis.map((item, i) => i === activeIdx ? { ...item, kpis: newKpis } : item);
            updateData('decisionsKpis', next);
        };

        const doneCheck = (i) => {
            const item = decisionsKpis[i];
            return item.decisions.some(d => d.trim()) && item.kpis.some(k => k.trim());
        };

        const filledCount = decisionsKpis.filter((_, i) => doneCheck(i)).length;

        return (
            <div className="step-content animate-in" key={activeIdx}>
                <p className="step-indicator">STEP 2 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Key Decisions & KPIs</h1>
                    <p className="step-hint">For each core activity, define the 3 decisions that must be made to execute it — and the KPIs that prove it's working. Use the tabs to navigate between activities.</p>
                </div>
                <ActivityNav
                    activities={activities}
                    activeIdx={activeIdx}
                    onSelect={setActiveIdx}
                    doneCheck={doneCheck}
                />

                <ActivityBanner idx={activeIdx} name={currentName} />

                <div className="subsection-card" style={{ marginBottom: 24 }}>
                    <div className="subsection-card-header">
                        <span className="subsection-card-label">KEY DECISIONS — Who decides what for this activity?</span>
                    </div>
                    <div className="subsection-card-body">
                        <p style={{ fontSize: 13, color: '#666', marginBottom: 16, lineHeight: 1.6 }}>
                            Name the 3 most important decisions that must be made to execute this activity. Be specific — include who makes the decision and what information they need.
                        </p>
                        {current.decisions.map((d, dIdx) => (
                            <div key={dIdx} className="row-list-item">
                                <span className="row-list-num" style={{ background: '#000', color: '#FFF469', padding: '2px 6px', fontFamily: "'Monument', monospace", fontSize: 10 }}>{String(dIdx+1).padStart(2,'0')}</span>
                                <input
                                    type="text"
                                    className="field-input"
                                    style={{ fontSize: 14, padding: '10px 14px' }}
                                    value={d}
                                    onChange={e => updateDecision(dIdx, e.target.value)}
                                    placeholder={
                                        dIdx === 0 ? 'e.g. Who approves budget allocation above €5K?' :
                                        dIdx === 1 ? 'e.g. Who decides which client projects to prioritise?' :
                                        'e.g. Who can override the standard process in urgent cases?'
                                    }
                                    maxLength={200}
                                />
                            </div>
                        ))}
                    </div>
                </div>

                <div className="subsection-card">
                    <div className="subsection-card-header">
                        <span className="subsection-card-label">OUTCOME KPIs — How do you measure success?</span>
                    </div>
                    <div className="subsection-card-body">
                        <p style={{ fontSize: 13, color: '#666', marginBottom: 16, lineHeight: 1.6 }}>
                            Define 3 KPIs that prove this activity is working. KPIs must drive decisions — if a number wouldn't change your behaviour when it moves, choose a better one.
                        </p>
                        {current.kpis.map((k, kIdx) => (
                            <div key={kIdx} className="row-list-item">
                                <span className="row-list-num" style={{ background: '#000', color: '#FFF469', padding: '2px 6px', fontFamily: "'Monument', monospace", fontSize: 10 }}>{String(kIdx+1).padStart(2,'0')}</span>
                                <input
                                    type="text"
                                    className="field-input"
                                    style={{ fontSize: 14, padding: '10px 14px' }}
                                    value={k}
                                    onChange={e => updateKpi(kIdx, e.target.value)}
                                    onKeyDown={kIdx === 2 ? (e => { if (e.key === 'Enter') { e.preventDefault(); goNextActivity(); } }) : undefined}
                                    placeholder={
                                        kIdx === 0 ? 'e.g. Customer acquisition cost (target: <€120)' :
                                        kIdx === 1 ? 'e.g. Monthly recurring revenue growth (target: +8%)' :
                                        'e.g. Net Promoter Score (target: >50)'
                                    }
                                    maxLength={150}
                                />
                            </div>
                        ))}
                        {activeIdx < 4 && (
                            <p style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#22c55e', letterSpacing: '0.06em', marginTop: 10 }}>
                                ↵ PRESS ENTER ON THE LAST KPI TO GO TO THE NEXT CORE ACTIVITY
                            </p>
                        )}
                    </div>
                </div>

                {aiMessage && <div className="ai-message" style={{ marginTop: 16 }}>{aiMessage}</div>}

                <p className="field-help" style={{ marginTop: 20 }}>{filledCount}/5 activities filled with decisions and KPIs.</p>

                {filledCount >= 5 && (
                    <div className="closing-box animate-in" style={{ marginTop: 24 }}>
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[2].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[2].text}</p>
                    </div>
                )}
            </div>
        );
    }

    // ── STEP 3: Capabilities ──────────────────────────────────────────────────
    function Step3({ data, updateData, aiMessage }) {
        const [activeIdx, setActiveIdx] = useState(0);
        const activities   = data.activities;
        const capabilities = data.capabilities;
        const current      = capabilities[activeIdx];
        const currentName  = activities[activeIdx] ? activities[activeIdx].name : '';

        const goNextActivity = () => { if (activeIdx < 4) setActiveIdx(i => i + 1); };

        const updateCap = (field, val) => {
            const updatedItem = { ...current, [field]: val };
            const next = capabilities.map((item, i) => i === activeIdx ? updatedItem : item);
            updateData('capabilities', next);
        };

        const doneCheck = (i) => {
            const item = capabilities[i];
            return !!(item.human.trim() || item.systemic.trim() || item.relational.trim());
        };

        const filledCount = capabilities.filter((_, i) => doneCheck(i)).length;

        return (
            <div className="step-content animate-in" key={activeIdx}>
                <p className="step-indicator">STEP 3 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Capabilities & Gaps</h1>
                    <p className="step-hint">For each core activity, define the capabilities you need — human, systemic and relational — and identify the gaps you must close.</p>
                </div>
                <ActivityNav
                    activities={activities}
                    activeIdx={activeIdx}
                    onSelect={setActiveIdx}
                    doneCheck={doneCheck}
                />

                <ActivityBanner idx={activeIdx} name={currentName} />

                <div className="capability-grid">
                    <div className="subsection-card" style={{ marginBottom: 0 }}>
                        <div className="subsection-card-header">
                            <span className="subsection-card-label">HUMAN CAPABILITIES</span>
                        </div>
                        <div className="subsection-card-body">
                            <p style={{ fontSize: 12, color: '#666', marginBottom: 12, lineHeight: 1.5 }}>Skills, expertise and behaviours your people need to execute this activity.</p>
                            <textarea
                                className="field-textarea"
                                style={{ minHeight: 100 }}
                                value={current.human}
                                onChange={e => updateCap('human', e.target.value)}
                                placeholder="e.g. Data analysts who can interpret customer behaviour patterns; Sales people with consultative selling skills"
                                maxLength={500}
                            />
                        </div>
                    </div>

                    <div className="subsection-card" style={{ marginBottom: 0 }}>
                        <div className="subsection-card-header">
                            <span className="subsection-card-label">SYSTEMIC CAPABILITIES</span>
                        </div>
                        <div className="subsection-card-body">
                            <p style={{ fontSize: 12, color: '#666', marginBottom: 12, lineHeight: 1.5 }}>Processes, technology and infrastructure required to execute this activity.</p>
                            <textarea
                                className="field-textarea"
                                style={{ minHeight: 100 }}
                                value={current.systemic}
                                onChange={e => updateCap('systemic', e.target.value)}
                                placeholder="e.g. CRM system with deal-stage tracking; Weekly pipeline review process with standardised scoring"
                                maxLength={500}
                            />
                        </div>
                    </div>
                </div>

                <div className="subsection-card">
                    <div className="subsection-card-header">
                        <span className="subsection-card-label">RELATIONAL CAPABILITIES</span>
                    </div>
                    <div className="subsection-card-body">
                        <p style={{ fontSize: 12, color: '#666', marginBottom: 12, lineHeight: 1.5 }}>Partnerships, networks and relationships that enable this activity to succeed.</p>
                        <textarea
                            className="field-textarea"
                            style={{ minHeight: 80 }}
                            value={current.relational}
                            onChange={e => updateCap('relational', e.target.value)}
                            placeholder="e.g. Distribution partners in 3 key markets; Trusted referral network of 10+ accountants and lawyers"
                            maxLength={500}
                        />
                    </div>
                </div>

                <div className="subsection-card">
                    <div className="subsection-card-header" style={{ borderBottom: '2px solid #000' }}>
                        <span className="subsection-card-label">CAPABILITY GAPS — What do you need to build or acquire?</span>
                    </div>
                    <div className="subsection-card-body">
                        <p style={{ fontSize: 12, color: '#666', marginBottom: 12, lineHeight: 1.5 }}>List the gaps between what you need and what you have today. Be direct — these become your action items.</p>
                        <textarea
                            className="field-textarea"
                            style={{ minHeight: 80 }}
                            value={current.gaps}
                            onChange={e => updateCap('gaps', e.target.value)}
                            onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); goNextActivity(); } }}
                            placeholder="e.g. Missing: senior data engineer (hire Q2); Need: marketing automation platform (evaluate HubSpot vs ActiveCampaign); Gap: no strategic partner in the Nordic market"
                            maxLength={600}
                        />
                        {activeIdx < 4 && (
                            <p style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#22c55e', letterSpacing: '0.06em', marginTop: 8 }}>
                                ↵ PRESS ENTER TO GO TO THE NEXT CORE ACTIVITY
                            </p>
                        )}
                    </div>
                </div>

                {aiMessage && <div className="ai-message" style={{ marginTop: 8 }}>{aiMessage}</div>}

                <p className="field-help" style={{ marginTop: 16 }}>{filledCount}/5 activities have capabilities defined.</p>

                {filledCount >= 5 && (
                    <div className="closing-box animate-in" style={{ marginTop: 24 }}>
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[3].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[3].text}</p>
                    </div>
                )}
            </div>
        );
    }

    // ── CANVAS STEP ───────────────────────────────────────────────────────────
    function CanvasStep({ data, onSubmit, submitState, aiMessage }) {
        const handlePrint = () => {
            const rows = data.activities.map((a, i) => {
                const dk = data.decisionsKpis[i] || { decisions: [], kpis: [] };
                const cap = data.capabilities[i] || { human: '', systemic: '', relational: '', gaps: '' };
                const decisionsList = dk.decisions.filter(d => d.trim()).map(d => `<li>${d}</li>`).join('') || '<li>—</li>';
                const kpisList = dk.kpis.filter(k => k.trim()).map(k => `<li>${k}</li>`).join('') || '<li>—</li>';
                return `<tr>
                    <td style="font-weight:bold;font-size:14px;vertical-align:top;padding:14px 10px;border:1px solid #ddd;background:#000;color:#fff;width:20%">
                        <span style="font-size:20px;color:#FFF469">${i+1}.</span><br/>${a.name || '—'}
                    </td>
                    <td style="vertical-align:top;padding:12px;border:1px solid #ddd;font-size:13px;width:20%"><ul style="padding-left:16px">${decisionsList}</ul></td>
                    <td style="vertical-align:top;padding:12px;border:1px solid #ddd;font-size:13px;width:20%"><ul style="padding-left:16px">${kpisList}</ul></td>
                    <td style="vertical-align:top;padding:12px;border:1px solid #ddd;font-size:13px;width:20%">
                        ${cap.human ? '<b>Human:</b> ' + cap.human + '<br/>' : ''}
                        ${cap.systemic ? '<b>Systemic:</b> ' + cap.systemic + '<br/>' : ''}
                        ${cap.relational ? '<b>Relational:</b> ' + cap.relational : ''}
                    </td>
                    <td style="vertical-align:top;padding:12px;border:1px solid #ddd;font-size:13px;background:#FEF2F2;width:20%">${cap.gaps || '—'}</td>
                </tr>`;
            }).join('');

            const win = window.open('', '_blank');
            win.document.write(`<!DOCTYPE html><html><head><title>Core Processes & Decisions Canvas</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;padding:40px;color:#000}h1{font-size:28px;font-weight:bold;margin-bottom:32px}table{width:100%;border-collapse:collapse;margin-bottom:36px}th{background:#000;color:#fff;padding:10px 12px;font-size:11px;text-transform:uppercase;letter-spacing:0.08em;border:1px solid #000}ul{margin:0;padding-left:16px}.case{background:#F9F9F9;padding:24px;border-left:4px solid #000;font-size:14px;line-height:1.7;color:#333;margin-top:32px}h2{font-size:13px;text-transform:uppercase;letter-spacing:0.1em;color:#666;margin-bottom:12px;padding-bottom:6px;border-bottom:2px solid #000}</style></head><body>
            <h1>CORE PROCESSES & DECISIONS CANVAS</h1>
            <table>
                <thead><tr>
                    <th>Core Activity</th>
                    <th>Key Decisions</th>
                    <th>KPIs</th>
                    <th>Capabilities</th>
                    <th>Capability Gaps</th>
                </tr></thead>
                <tbody>${rows}</tbody>
            </table>
            <h2>Case Study — Zara</h2>
            <div class="case">
                Zara's operational mastery came from mapping their 5 core activities to specific decision rights, KPIs and capabilities. For their <b>fast manufacturing</b> activity, the key decisions were owned by regional production managers (not headquarters), the KPI was "time from design approval to store shelf" (target: 14 days), and the human capability gap they closed was hiring logistics coordinators in each production region. This decision-capability mapping is what separated Zara from every fashion company that had the same strategic intent but never built the operational infrastructure to execute it.
            </div>
            </body></html>`);
            win.document.close();
            win.print();
        };

        if (submitState === 'success') {
            return (
                <div className="step-content animate-in">
                    <div style={{ background: '#f0fdf4', border: '1px solid #86efac', padding: 48, textAlign: 'center', marginTop: 32 }}>
                        <div style={{ fontSize: 48, marginBottom: 16 }}>✓</div>
                        <h2 className="plaak" style={{ fontSize: 32, marginBottom: 16 }}>SUBMITTED</h2>
                        <p style={{ fontSize: 16, color: '#555', marginBottom: 32 }}>Your Core Processes & Decisions Canvas has been saved. Your guru will review before Wednesday.</p>
                        <a href="/dashboard" style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#000', letterSpacing: '0.06em', textDecoration: 'underline' }}>← Back to Dashboard</a>
                    </div>
                </div>
            );
        }

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">CANVAS</p>
                <div className="opening-box">
                    <h1 className="step-heading">Core Processes & Decisions Canvas</h1>
                    <p className="step-hint">Review your complete output across all 5 core activities. Download as PDF for your team, then submit your answers.</p>
                </div>

                <div style={{ border: '2px solid #000', marginBottom: 32, overflowX: 'auto' }}>
                    {/* Table header */}
                    <div style={{ background: '#000', color: '#fff', display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr 1fr', gap: 0 }}>
                        {['CORE ACTIVITY', 'KEY DECISIONS', 'KPIS', 'CAPABILITIES', 'GAPS'].map(h => (
                            <div key={h} style={{ padding: '10px 14px', fontFamily: "'Monument', monospace", fontSize: 9, letterSpacing: '0.1em', color: '#FFF469', textTransform: 'uppercase', borderRight: '1px solid #333' }}>{h}</div>
                        ))}
                    </div>

                    {/* Activity rows */}
                    {data.activities.map((a, i) => {
                        const dk  = data.decisionsKpis[i] || { decisions: [], kpis: [] };
                        const cap = data.capabilities[i]  || { human: '', systemic: '', relational: '', gaps: '' };
                        return (
                            <div key={i} style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr 1fr', borderTop: '1px solid #E0E0E0' }}>
                                <div style={{ padding: '14px 16px', background: '#000', color: '#fff', borderRight: '1px solid #222' }}>
                                    <span className="plaak" style={{ fontSize: 20, color: '#FFF469' }}>{i+1}</span>
                                    <div style={{ fontSize: 13, fontWeight: 600, marginTop: 4 }}>{(a.name && a.name.trim()) || '—'}</div>
                                </div>
                                <div style={{ padding: '12px 14px', fontSize: 13, borderRight: '1px solid #E0E0E0', lineHeight: 1.5 }}>
                                    {dk.decisions.filter(d => d.trim()).map((d, di) => (
                                        <div key={di} style={{ marginBottom: 4, paddingLeft: 12, position: 'relative' }}>
                                            <span style={{ position: 'absolute', left: 0, color: '#FFF469', background: '#000', fontSize: 9, padding: '1px 4px' }}>{di+1}</span>
                                            {d}
                                        </div>
                                    ))}
                                    {!dk.decisions.some(d => d.trim()) && <span style={{ color: '#bbb' }}>—</span>}
                                </div>
                                <div style={{ padding: '12px 14px', fontSize: 13, borderRight: '1px solid #E0E0E0', lineHeight: 1.5 }}>
                                    {dk.kpis.filter(k => k.trim()).map((k, ki) => (
                                        <div key={ki} style={{ marginBottom: 4, paddingLeft: 12, position: 'relative' }}>
                                            <span style={{ position: 'absolute', left: 0, color: '#FFF469', background: '#000', fontSize: 9, padding: '1px 4px' }}>{ki+1}</span>
                                            {k}
                                        </div>
                                    ))}
                                    {!dk.kpis.some(k => k.trim()) && <span style={{ color: '#bbb' }}>—</span>}
                                </div>
                                <div style={{ padding: '12px 14px', fontSize: 12, borderRight: '1px solid #E0E0E0', lineHeight: 1.5 }}>
                                    {cap.human    && <div style={{ marginBottom: 6 }}><span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#22c55e', display: 'block' }}>HUMAN</span>{cap.human}</div>}
                                    {cap.systemic && <div style={{ marginBottom: 6 }}><span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#3b82f6', display: 'block' }}>SYSTEMIC</span>{cap.systemic}</div>}
                                    {cap.relational && <div><span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#f59e0b', display: 'block' }}>RELATIONAL</span>{cap.relational}</div>}
                                    {!cap.human && !cap.systemic && !cap.relational && <span style={{ color: '#bbb' }}>—</span>}
                                </div>
                                <div style={{ padding: '12px 14px', fontSize: 12, background: '#FEF2F2', lineHeight: 1.5 }}>
                                    {cap.gaps || <span style={{ color: '#bbb' }}>—</span>}
                                </div>
                            </div>
                        );
                    })}

                    {/* Case Study */}
                    <div style={{ padding: '24px 28px', background: '#000', color: '#fff', borderTop: '2px solid #222' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>CASE STUDY — ZARA</div>
                        <p style={{ fontSize: 14, lineHeight: 1.8, color: '#ccc' }}>
                            Zara's operational mastery came from mapping their 5 core activities to specific decision rights, KPIs and capabilities. For their <strong style={{ color: '#fff' }}>fast manufacturing</strong> activity, the key decisions were owned by regional production managers — not headquarters — keeping decision velocity high. The KPI was "time from design approval to store shelf" (target: 14 days). The human capability gap they identified and closed was logistics coordinators in each production region. This decision-capability mapping is what separated Zara from every fashion company that had the same strategic intent but never built the operational infrastructure to execute it.
                        </p>
                    </div>
                </div>

                {aiMessage && <div className="ai-message" style={{ marginBottom: 16 }}>{aiMessage}</div>}

                <div style={{ display: 'flex', gap: 16 }}>
                    <button onClick={handlePrint} className="btn-wiz-back"
                        style={{ flex: 1, padding: 16, fontSize: 13, border: '2px solid #000', color: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>
                        ↓ DOWNLOAD PDF
                    </button>
                    <button onClick={onSubmit} disabled={submitState === 'saving'} className="btn-wiz-next"
                        style={{ flex: 2, padding: 16, fontSize: 13 }}>
                        {submitState === 'saving' ? 'SAVING…' : 'SUBMIT ANSWERS →'}
                    </button>
                </div>
            </div>
        );
    }

    // ── IntroPage ─────────────────────────────────────────────────────────────
    function IntroPage({ onNext }) {
        return (
            <div style={{ background: '#000', color: '#fff', minHeight: '100vh', padding: '64px' }}>
                <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
                    <h1 className="plaak animate-in" style={{ fontSize: '100px', marginBottom: '64px' }}>
                        BEFORE WE START
                    </h1>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.08s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', color: '#FFF469', marginBottom: '24px' }}>SPRINT INFO</h2>
                        <div style={{ background: '#fff', color: '#000', padding: '32px' }}>
                            <p style={{ fontSize: '22px', fontWeight: 'bold', marginBottom: '16px' }}>Sprint 23: Core Processes & Decisions</p>
                            <p style={{ fontSize: '18px', lineHeight: 1.6, marginBottom: '16px' }}>
                                This is a team meeting tool. Building on Sprint 22, you will now define the key decisions, KPIs and capabilities required to execute each of your 5 core activities. The output is an operational blueprint — bridging strategy and execution.
                            </p>
                            <div style={{ borderLeft: '4px solid #000', paddingLeft: '16px', fontStyle: 'italic', fontSize: '16px' }}>
                                "The essence of strategy is choosing what not to do." — Michael Porter
                            </div>
                        </div>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.1s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', marginBottom: '24px' }}>PURPOSE</h2>
                        <div style={{ borderLeft: '4px solid #fff', paddingLeft: '24px', marginBottom: '24px' }}>
                            <p style={{ fontSize: '28px', fontStyle: 'italic', marginBottom: '8px' }}>
                                "Strategy without execution is a hallucination. Execution without decision rights is chaos."
                            </p>
                            <p style={{ fontSize: '18px', color: '#999' }}>— Fast Track Program</p>
                        </div>
                        <p style={{ fontSize: '22px', lineHeight: 1.6 }}>
                            You will leave this sprint with a complete Core Processes & Decisions table: for each of your 5 core activities, you will have mapped the key decisions (and who makes them), the KPIs that prove it's working, the capabilities required (human, systemic, relational), and the gaps you must close.
                        </p>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.2s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', color: '#FFF469', marginBottom: '24px' }}>MISTAKES TO AVOID</h2>
                        <ul style={{ fontSize: '20px', listStyle: 'none', padding: 0 }}>
                            {[
                                'Vague decisions — "The CEO decides" is not a decision right. Name the decision, the criteria, and the data needed.',
                                'Vanity KPIs — Track what changes behaviour, not what looks good in a board deck. 3 decision-driving KPIs beat 20 activity metrics.',
                                'Ignoring capability gaps — A gap is not a failure. It is a roadmap. Name the gap, name the solution (hire, train, partner, build).',
                                'Doing this alone — This is a team tool. The people who execute each activity must be in the room to validate the decisions and KPIs.',
                            ].map((item, i) => (
                                <li key={i} style={{ display: 'flex', alignItems: 'flex-start', marginBottom: '16px' }}>
                                    <span style={{ fontSize: '32px', marginRight: '16px', lineHeight: 1, flexShrink: 0 }}>•</span>
                                    <span>{item}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '64px', animationDelay: '0.3s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', marginBottom: '32px' }}>THE JOURNEY</h2>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', textAlign: 'center' }}>
                            {[
                                ['01', 'ACTIVITIES', 'Review top 5 from Sprint 22'],
                                ['02', 'DECISIONS & KPIs', 'Map decisions + metrics'],
                                ['03', 'CAPABILITIES', 'Define what you need'],
                                ['04', 'CANVAS', 'Review, PDF & submit'],
                            ].map(([num, title, sub]) => (
                                <div key={num} style={{ border: '2px solid #fff', padding: '20px 12px' }}>
                                    <div className="plaak" style={{ fontSize: '52px', marginBottom: '12px' }}>{num}</div>
                                    <p style={{ fontWeight: 'bold', marginBottom: '6px', fontSize: '13px' }}>{title}</p>
                                    <p style={{ fontSize: '12px', color: '#999' }}>{sub}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    <button onClick={onNext} className="plaak"
                        style={{ width: '100%', padding: '32px', background: '#FFF469', color: '#000', border: 'none', fontSize: '28px', cursor: 'pointer', letterSpacing: '0.05em', transition: 'opacity 0.2s' }}>
                        LET'S START →
                    </button>
                </div>
            </div>
        );
    }

    // ── Main App ──────────────────────────────────────────────────────────────
    function ProcessesDecisionsApp() {
        const [step, setStep]               = useState(0);
        const [data, setData]               = useState(makeDefaultData());
        const [userId, setUserId]           = useState(null);
        const [deps, setDeps]               = useState({});
        const [authState, setAuthState]     = useState({ loading: true, authenticated: false, error: null });
        const [submitState, setSubmitState] = useState('idle');
        const [aiReviewing, setAiReviewing] = useState(false);
        const [aiMessage, setAiMessage]     = useState('');

        const totalSteps = CONFIG.TOTAL_STEPS;

        // ── Init ──
        useEffect(() => {
            ToolDB.init(CONFIG.TOOL_SLUG);

            ToolDB.whenReady().then(async () => {
                const uid = await ToolDB.identifyUser();
                if (!uid) {
                    setAuthState({ loading: false, authenticated: false, error: 'No active session found.' });
                    return;
                }
                setUserId(uid);
                setAuthState({ loading: false, authenticated: true, error: null });

                // Load saved data
                const saved = await ToolDB.load(uid);
                if (saved && Object.keys(saved).length > 0) {
                    setData(mergeLoaded(saved, makeDefaultData()));
                }

                // Load dependencies — pull core activities from Sprint 22
                try {
                    const coreActivities = await ToolDB.getDependency(uid, 'core_activities.activities');
                    if (coreActivities && Array.isArray(coreActivities)) {
                        const names = coreActivities.slice(0, 5).map(a => typeof a === 'string' ? a : (a.name || ''));
                        setData(prev => ({
                            ...prev,
                            activities: prev.activities.map((act, i) => ({
                                ...act,
                                name: act.name && act.name.trim() ? act.name : (names[i] || '')
                            }))
                        }));
                        setDeps(d => ({ ...d, 'Core Activities (Sprint 22)': names.filter(Boolean).join(', ') }));
                    } else {
                        // Try alternative reference key
                        const top5 = await ToolDB.getDependency(uid, 'org.activities.top5');
                        if (top5 && Array.isArray(top5)) {
                            const names = top5.slice(0, 5).map(a => typeof a === 'string' ? a : (a.name || ''));
                            setData(prev => ({
                                ...prev,
                                activities: prev.activities.map((act, i) => ({
                                    ...act,
                                    name: act.name && act.name.trim() ? act.name : (names[i] || '')
                                }))
                            }));
                            setDeps(d => ({ ...d, 'Core Activities (Sprint 22)': names.filter(Boolean).join(', ') }));
                        }
                    }

                    const vp = await ToolDB.getDependency(uid, 'core_activities.value_proposition');
                    if (vp) setDeps(d => ({ ...d, 'Value Proposition': typeof vp === 'string' ? vp : JSON.stringify(vp) }));
                } catch (_) {}
            });
        }, []);

        const updateData = useCallback((field, val) => {
            setData(prev => ({ ...prev, [field]: val }));
            setAiMessage('');
        }, []);

        // ── canProceed per step ──
        const canProceed = () => {
            if (step === 1) return data.activities.some(a => a.name && a.name.trim());
            if (step === 2) return data.decisionsKpis.some(item => item.decisions.some(d => d.trim()) && item.kpis.some(k => k.trim()));
            if (step === 3) return data.capabilities.some(item => item.human.trim() || item.systemic.trim() || item.relational.trim());
            return true;
        };

        // ── handleNext ──
        const handleNext = async () => {
            setAiMessage('');
            if (!canProceed()) {
                if (step === 1) setAiMessage('Please complete Sprint 22 first — your core activities need to be loaded before you can proceed.');
                if (step === 2) setAiMessage('Define at least one key decision and one KPI for at least one activity before continuing.');
                if (step === 3) setAiMessage('Define at least one capability (human, systemic or relational) for at least one activity before continuing.');
                return;
            }

            // AI review step 2 — decisions quality
            if (step === 2 && window.AIChallenge) {
                const examples = data.decisionsKpis
                    .map((item, i) => {
                        const actName = data.activities[i] ? data.activities[i].name : '';
                        const decs = item.decisions.filter(d => d.trim());
                        const kpis = item.kpis.filter(k => k.trim());
                        if (!decs.length && !kpis.length) return null;
                        return `Activity ${i+1} (${actName}):\nDecisions: ${decs.join('; ')}\nKPIs: ${kpis.join('; ')}`;
                    })
                    .filter(Boolean)
                    .join('\n\n');
                if (examples) {
                    setAiReviewing(true);
                    const ok = await window.AIChallenge.reviewStep(
                        userId,
                        CONFIG.TOOL_SLUG,
                        { decisions_and_kpis: examples },
                        'Key Decisions & KPIs'
                    );
                    setAiReviewing(false);
                    if (!ok) return;
                }
            }

            // AI review step 3 — capabilities quality
            if (step === 3 && window.AIChallenge) {
                const examples = data.capabilities
                    .map((item, i) => {
                        const actName = data.activities[i] ? data.activities[i].name : '';
                        const parts = [
                            item.human.trim()     ? 'Human: ' + item.human.trim()       : null,
                            item.systemic.trim()  ? 'Systemic: ' + item.systemic.trim() : null,
                            item.relational.trim() ? 'Relational: ' + item.relational.trim() : null,
                            item.gaps.trim()      ? 'Gaps: ' + item.gaps.trim()         : null,
                        ].filter(Boolean);
                        if (!parts.length) return null;
                        return `Activity ${i+1} (${actName}):\n${parts.join('\n')}`;
                    })
                    .filter(Boolean)
                    .join('\n\n');
                if (examples) {
                    setAiReviewing(true);
                    const ok = await window.AIChallenge.reviewStep(
                        userId,
                        CONFIG.TOOL_SLUG,
                        { capabilities: examples },
                        'Capabilities & Gaps'
                    );
                    setAiReviewing(false);
                    if (!ok) return;
                }
            }

            // After last wizard step → transition, then canvas
            setStep(step + 0.5);
        };

        // ── handleTransitionNext ──
        const handleTransitionNext = () => {
            if (Math.floor(step) === totalSteps) {
                setStep('canvas');
            } else {
                setStep(Math.floor(step) + 1);
            }
        };

        // ── handleBack ──
        const handleBack = () => {
            if (step === 'canvas') { setStep(totalSteps); return; }
            if (step === 1)       { setStep(0.5); return; }
            setStep(step - 1);
        };

        // ── handleSubmit ──
        const handleSubmit = async () => {
            setSubmitState('saving');
            try {
                await ToolDB.save(userId, {
                    activities:    data.activities,
                    decisions_kpis: data.decisionsKpis,
                    capabilities:  data.capabilities,
                });
                await ToolDB.markComplete(userId);
                setSubmitState('success');
            } catch (err) {
                console.error('[ProcessesDecisions] Submit error:', err);
                setSubmitState('error');
                setAiMessage('Submission failed. Please try again.');
            }
        };

        const isWizardStep = Number.isInteger(step) && step >= 1 && step <= totalSteps;
        const isTransition = !Number.isInteger(step) && step !== 0;

        // ── Loading / auth screens ──
        if (authState.loading) {
            return (
                <div style={{ background: '#000', color: '#fff', minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 12, letterSpacing: '0.1em', color: '#555' }}>LOADING…</div>
                </div>
            );
        }

        if (!authState.authenticated) {
            return (
                <div style={{ background: '#000', color: '#fff', minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', flexDirection: 'column', gap: 16 }}>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 12, letterSpacing: '0.1em', color: '#DC2626' }}>ACCESS DENIED</div>
                    <div style={{ fontSize: 14, color: '#666' }}>{authState.error || 'No active session. Please access this tool from your Fast Track dashboard.'}</div>
                </div>
            );
        }

        // ── Render ──
        return (
            <div className="tool-frame">
                {/* Cover page — step 0 */}
                {step === 0 && (
                    <div style={{ position: 'relative', width: '100%', minHeight: '100vh', background: '#000', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', overflow: 'hidden' }}>
                        <div style={{ position: 'absolute', inset: 0, backgroundImage: `url('${CONFIG.COVER_IMAGE}')`, backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.35 }} />
                        <div style={{ position: 'relative', zIndex: 2, textAlign: 'center', padding: '0 32px', maxWidth: 800 }}>
                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.15em', textTransform: 'uppercase', marginBottom: 24 }}>SPRINT 23</div>
                            <h1 className="plaak animate-in" style={{ fontSize: 'clamp(48px, 8vw, 96px)', color: '#fff', marginBottom: 24, lineHeight: 1 }}>
                                {CONFIG.TOOL_TITLE}
                            </h1>
                            <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48, lineHeight: 1.6 }}>{CONFIG.TOOL_SUBTITLE}</p>
                            <button className="plaak" onClick={() => setStep(0.5)}
                                style={{ background: '#FFF469', color: '#000', border: 'none', padding: '20px 56px', fontSize: 20, cursor: 'pointer', letterSpacing: '0.05em', transition: 'opacity 0.2s' }}>
                                START →
                            </button>
                        </div>
                    </div>
                )}

                {/* Intro page — step 0.5 */}
                {step === 0.5 && <IntroPage onNext={() => setStep(1)} />}

                {/* Transition screens — half steps */}
                {isTransition && step > 0.5 && (
                    <TransitionScreen stepNum={Math.floor(step)} onNext={handleTransitionNext} />
                )}

                {/* Wizard steps 1–3 */}
                {isWizardStep && (
                    <div className="wizard-layout">
                        <MobileStepBar currentStep={step} totalSteps={totalSteps} />
                        <div className="wizard-main">
                            {step === 1 && <Step1 data={data} deps={deps} aiMessage={aiMessage} />}
                            {step === 2 && <Step2 data={data} updateData={updateData} aiMessage={aiMessage} />}
                            {step === 3 && <Step3 data={data} updateData={updateData} aiMessage={aiMessage} />}

                            <div className="wizard-footer">
                                <button className="btn-wiz-back" onClick={handleBack}>← BACK</button>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                                    {aiReviewing && (
                                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#666', letterSpacing: '0.06em' }}>AI REVIEWING…</span>
                                    )}
                                    <button className="btn-wiz-next" onClick={handleNext} disabled={aiReviewing}>
                                        {aiReviewing ? 'REVIEWING…' : step === totalSteps ? 'FINISH →' : 'NEXT →'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <WizardSidebar currentStep={step} data={data} />
                    </div>
                )}

                {/* Canvas step */}
                {step === 'canvas' && (
                    <div className="wizard-layout">
                        <div className="wizard-main">
                            <CanvasStep data={data} onSubmit={handleSubmit} submitState={submitState} aiMessage={aiMessage} />
                            <div className="wizard-footer">
                                <button className="btn-wiz-back" onClick={handleBack}>← BACK</button>
                                <div />
                            </div>
                        </div>
                        <WizardSidebar currentStep="canvas" data={data} />
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.render(<ProcessesDecisionsApp />, document.getElementById('root'));
</script>
</body>
</html>
