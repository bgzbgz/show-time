<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Core Decisions & Capabilities | Fast Track Program</title>

  <!-- React & ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../shared/js/tool-db.js"></script>
  <script src="../../shared/js/ai-challenge.js"></script>
  <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../shared/js/transition-screen.js"></script>
    <script src="../../js/tool-access-control.js"></script>

  <!-- jsPDF + html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Font Face Declarations */
    @font-face {
      font-family: 'Plaak';
      src: url('Plaak3Trial-43-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
    }

    @font-face {
      font-family: 'Riforma';
      src: url('RiformaLL-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: 'Monument';
      src: url('MonumentGrotesk-Mono.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Riforma', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .plaak {
      font-family: 'Plaak', sans-serif;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: -0.02em;
    }

    .riforma-bold {
      font-family: 'Riforma', sans-serif;
      font-weight: bold;
    }

    .monument {
      font-family: 'Monument', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .transition-animate-in {
      animation: slideIn 0.6s ease-out;
    }

    /* Button Styles */
    .btn-primary {
      background: #000000;
      color: #FFFFFF;
      padding: 16px 32px;
      border: 2px solid #000000;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: normal;
    }

    .btn-primary:hover:not(:disabled) {
      transform: scale(1.02);
    }

    .btn-primary:disabled {
      background: #E0E0E0;
      border-color: #E0E0E0;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #FFFFFF;
      color: #000000;
      padding: 12px 24px;
      border: 2px solid #000000;
      font-size: 16px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #F8F8F8;
    }

    /* Form Styles */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      border: 1px solid #E0E0E0;
      padding: 12px 16px;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      width: 100%;
      transition: border-color 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #000000;
    }

    textarea {
      min-height: 120px;
      resize: none !important;
    }

    textarea::placeholder {
      white-space: pre-line;
    }

    /* Numbered Section Badge */
    .numbered-section {
      background: #000000;
      color: #FFFFFF;
      padding: 10px 16px;
      font-family: 'Plaak', sans-serif;
      font-size: 26px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }

    /* Progress Indicator */
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #E0E0E0;
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background: #000000;
      transform: scale(1.3);
    }

    .progress-dot.completed {
      background: #000000;
    }

    .progress-line {
      height: 2px;
      background: #E0E0E0;
      flex: 1;
    }

    /* Character Counter */
    .char-counter {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }

    .char-counter.invalid {
      color: #EF4444;
    }
    /* Dark theme inputs */
    input[type="text"], input[type="number"], input[type="email"], textarea, select {
        background: #1a1a1a !important;
        color: #fff !important;
        border-color: #444 !important;
    }
    input::placeholder, textarea::placeholder { color: #666 !important; }
    input:focus, textarea:focus, select:focus {
        outline: 2px solid #FFF469 !important;
        border-color: #FFF469 !important;
    }
    select option { background: #1a1a1a; color: #fff; }
    /* Fix bg-yellow-50 cards on dark bg */
    .bg-yellow-50 { background: #2a2500 !important; }
    /* Fix canvas content (keep white for PDF) */
    #canvas-content { background: #fff !important; color: #000 !important; }
    #canvas-content input, #canvas-content textarea { background: #fff !important; color: #000 !important; }

    /* === WIZARD LAYOUT === */
    .wizard-layout { display: flex; min-height: 100vh; }
    .wizard-main { flex: 1; display: flex; flex-direction: column; min-height: 100vh; background: #fff; }
    .wizard-content { max-width: 720px; width: 100%; margin: 0 auto; padding: 48px 32px; flex: 1; }
    .wizard-sidebar { width: 280px; background: #000; border-left: 1px solid #000; flex-shrink: 0; position: sticky; top: 0; height: 100vh; overflow: hidden; }
    .wizard-sidebar-inner { padding: 32px 24px; height: 100%; overflow-y: auto; }
    .sidebar-step-item { padding: 12px; margin-bottom: 8px; border-left: 3px solid transparent; transition: all 0.2s ease; cursor: default; }
    .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
    .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
    .sidebar-step-item.completed:hover { background: #E0E0E0; }
    .sidebar-step-item.locked { opacity: 0.5; }
    .wizard-footer { border-top: 1px solid #e0e0e0; padding: 20px 32px; display: flex; gap: 16px; justify-content: space-between; background: #fff; }
    .btn-wiz-back { background: #fff; color: #000; border: 1px solid #000; padding: 14px 28px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; }
    .btn-wiz-back:hover { background: #f3f3f3; }
    .btn-wiz-next { background: #000; color: #fff; border: none; padding: 14px 40px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; flex: 1; }
    .btn-wiz-next:hover { background: #222; }
    .btn-wiz-next:disabled { background: #ccc; cursor: default; }
    /* Override dark inputs for wizard content */
    .wizard-main input[type="text"], .wizard-main input[type="number"], .wizard-main textarea, .wizard-main select {
        background: #f9f9f9 !important; color: #000 !important; border-color: #ccc !important;
    }
    .wizard-main input::placeholder, .wizard-main textarea::placeholder { color: #999 !important; }
    .wizard-main input:focus, .wizard-main textarea:focus, .wizard-main select:focus {
        outline: 2px solid #000 !important; border-color: #000 !important;
    }
    @media (max-width: 768px) { .wizard-sidebar { display: none; } .wizard-content { padding: 24px 16px; } }

  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, Fragment } = React;

    const CONFIG = {
        SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
        SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
        TOOL_SLUG: 'processes-decisions',
        AUTOSAVE_DELAY: 2000,
        TRANSITION_CONTENT: {
            1: {
                brutalTruth: 'Ambiguous decision rights cost organizations more than bad decisions. When everyone thinks someone else is responsible, nothing gets decided — or everything escalates to the CEO, who becomes the bottleneck.',
                peerProof: '"A €15M company implemented RACI for their top 20 recurring decisions. The CEO\'s direct-intervention rate dropped 60% in 90 days. Their ops director called it \'unlocking a year\'s worth of backlog.\'"'
            },
            2: {
                brutalTruth: 'Process maps are not bureaucracy — they are the difference between a business that scales and one that depends on tribal knowledge. When your best person leaves, do they take the process with them?',
                peerProof: '"A 40-person company documented their top 15 processes before a key operations manager left. New hire was onboarded in 3 weeks instead of 3 months. The manager\'s departure became a growth event, not a crisis."'
            },
            3: {
                brutalTruth: 'Improving a broken process makes it break faster. Before you optimize, verify the process is actually necessary. 30% of documented processes in growing companies no longer serve the business that now exists.',
                peerProof: '"A €6M logistics firm mapped their quoting process and found 7 approval steps for orders under €500. Removing 5 of them cut quote turnaround from 4 days to 4 hours. Revenue increased 18% from faster response alone."'
            }
        },
        CLOSING_MESSAGES: {
            1: { title: 'DECISIONS MAPPED.', text: 'You\'ve identified the key decisions that drive each core activity. Now let\'s add the data and metrics.' },
            2: { title: 'DATA & KPIS SET.', text: 'Your decision engine has feedback loops. Now let\'s define the capabilities you need to win.' },
            3: { title: 'CAPABILITIES DEFINED.', text: 'You know what it takes to execute. Now let\'s close the gap between where you are and where you need to be.' }
        }
    };

    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    // Make Supabase client globally available for dependency injection
    window.supabaseClient = supabaseClient;

    // Initialize ToolDB and dependency injection
    ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);

        // Initialize cognitive load components
        CognitiveLoad.init('processes-decisions', {"insights":["A decision not made is worse than a wrong decision.","Capabilities take years to build and seconds to lose."],"caseStudy":{"before":"All decisions funneled through the CEO. Weekly design reviews took 3 weeks to schedule. Store managers had no authority to pull underperforming SKUs. The result: 60% slower time-to-shelf than competitors and mounting inventory waste.","after":"Zara implemented a tiered decision framework. Store managers gained authority over local assortment pulls. Design teams were empowered to greenlight trend items in daily syncs. Only strategic bets above a threshold escalated to leadership. Result: 80% of operational decisions now made within 24 hours.","quote":"Once we stopped funneling every call through the top, our people started making better decisions faster than we ever could centrally. The framework did not remove control\u2014it distributed intelligence. \u2014 Retail Operations Director, Zara"}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

        function DependencyContext({ deps }) {
            const [open, setOpen] = React.useState(false);
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '16px' }}>
                    <button onClick={() => setOpen(o => !o)} style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '8px 14px', fontSize: 12, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase', cursor: 'pointer', color: '#555', width: '100%' }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#DAA520" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        CONTEXT FROM PREVIOUS TOOLS ({deps.length})
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#999" strokeWidth="2" style={{ marginLeft: 'auto', transform: open ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    {open && (
                        <div style={{ border: '1px solid #F0E68C', borderTop: 'none', padding: '12px 14px' }}>
                            {deps.map((dep, i) => (
                                <div key={i} style={{ background: '#fff', padding: '8px 0', borderBottom: i < deps.length - 1 ? '1px solid #F0E68C' : 'none', fontSize: '13px' }}>
                                    <div style={{ fontWeight: 600, marginBottom: '2px', color: '#333', fontSize: '11px', fontFamily: "'Monument', monospace", letterSpacing: '0.04em', textTransform: 'uppercase' }}>{dep.label}</div>
                                    <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

    // Main App Component
    function CoreDecisionsApp() {
            const [deps, setDeps] = useState([]);
      const [step, setStep] = useState(0);
      const [aiReviewing, setAiReviewing] = useState(false);

      const [data, setData] = useState({
        coreActivities: [
          {
            id: 1,
            name: '',
            decisions: [{ id: 1, decision: '', frequency: '', impact: '' }],
            dataInputs: '',
            kpis: [{ id: 1, kpi: '', target: '' }],
            requiredCapabilities: '',
            currentCapabilities: '',
            capabilityGap: '',
            developmentPlan: ''
          }
        ]
      });

            useEffect(() => {
                async function loadDeps() {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                    try {
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[' + CONFIG.TOOL_SLUG + '] Failed to load dependencies:', err);
                    }
                }
                loadDeps();
            }, []);

      // Load from localStorage
      useEffect(() => {
        const saved = localStorage.getItem('core-decisions-data');
        if (saved) {
          try {
            const savedData = JSON.parse(saved);
            setData(savedData);
          } catch (e) {
            console.error('Error loading saved data:', e);
          }
        }
      }, []);

      // Auto-save every 2 seconds
      useEffect(() => {
        const interval = setInterval(() => {
          localStorage.setItem('core-decisions-data', JSON.stringify(data));
        }, 2000);
        return () => clearInterval(interval);
      }, [data]);

      const updateData = (field, value) => {
        setData({ ...data, [field]: value });
      };

      const addActivity = () => {
        const newActivity = {
          id: Date.now(),
          name: '',
          decisions: [{ id: Date.now(), decision: '', frequency: '', impact: '' }],
          dataInputs: '',
          kpis: [{ id: Date.now() + 1, kpi: '', target: '' }],
          requiredCapabilities: '',
          currentCapabilities: '',
          capabilityGap: '',
          developmentPlan: ''
        };
        updateData('coreActivities', [...(data.coreActivities || []), newActivity]);
      };

      const removeActivity = (id) => {
        if ((data.coreActivities || []).length > 1) {
          updateData('coreActivities', (data.coreActivities || []).filter(a => a.id !== id));
        }
      };

      const updateActivity = (id, field, value) => {
        const updated = (data.coreActivities || []).map(a => a.id === id ? { ...a, [field]: value } : a);
        updateData('coreActivities', updated);
      };

      const addDecision = (activityId) => {
        const updated = (data.coreActivities || []).map(a => {
          if (a.id === activityId) {
            return {
              ...a,
              decisions: [...(a.decisions || []), { id: Date.now(), decision: '', frequency: '', impact: '' }]
            };
          }
          return a;
        });
        updateData('coreActivities', updated);
      };

      const removeDecision = (activityId, decisionId) => {
        const updated = (data.coreActivities || []).map(a => {
          if (a.id === activityId && (a.decisions || []).length > 1) {
            return {
              ...a,
              decisions: (a.decisions || []).filter(d => d.id !== decisionId)
            };
          }
          return a;
        });
        updateData('coreActivities', updated);
      };

      const updateDecision = (activityId, decisionId, field, value) => {
        const updated = (data.coreActivities || []).map(a => {
          if (a.id === activityId) {
            return {
              ...a,
              decisions: (a.decisions || []).map(d => d.id === decisionId ? { ...d, [field]: value } : d)
            };
          }
          return a;
        });
        updateData('coreActivities', updated);
      };

      const addKpi = (activityId) => {
        const updated = (data.coreActivities || []).map(a => {
          if (a.id === activityId) {
            return {
              ...a,
              kpis: [...(a.kpis || []), { id: Date.now(), kpi: '', target: '' }]
            };
          }
          return a;
        });
        updateData('coreActivities', updated);
      };

      const removeKpi = (activityId, kpiId) => {
        const updated = (data.coreActivities || []).map(a => {
          if (a.id === activityId && (a.kpis || []).length > 1) {
            return {
              ...a,
              kpis: (a.kpis || []).filter(k => k.id !== kpiId)
            };
          }
          return a;
        });
        updateData('coreActivities', updated);
      };

      const updateKpi = (activityId, kpiId, field, value) => {
        const updated = (data.coreActivities || []).map(a => {
          if (a.id === activityId) {
            return {
              ...a,
              kpis: (a.kpis || []).map(k => k.id === kpiId ? { ...k, [field]: value } : k)
            };
          }
          return a;
        });
        updateData('coreActivities', updated);
      };

      const goNext = async () => {
        if (step === 0.5) {
          setStep(1);
        } else if (step >= 1 && step <= 4) {
          const userId = localStorage.getItem('ft_user_id');
          if (userId && step >= 1 && step <= 4) {
            setAiReviewing(true);
            try {
              let stepAnswers = {};
              let stepName = '';
              if (step === 1) {
                stepName = 'Core Decisions';
                stepAnswers = {
                  decision_rights: (data.coreActivities || []).map(a => ({
                    name: a.name,
                    decisions: (a.decisions || []).map(d => ({
                      decision: d.decision,
                      frequency: d.frequency,
                      impact: d.impact
                    }))
                  }))
                };
              } else if (step === 2) {
                stepName = 'Data & KPIs';
                stepAnswers = {
                  top3_per_activity: (data.coreActivities || []).map(a => ({
                    name: a.name,
                    dataInputs: a.dataInputs,
                    kpis: (a.kpis || []).map(k => ({
                      kpi: k.kpi,
                      target: k.target
                    }))
                  }))
                };
              } else if (step === 3) {
                stepName = 'Capabilities';
                stepAnswers = {
                  capabilities: (data.coreActivities || []).map(a => ({
                    name: a.name,
                    requiredCapabilities: a.requiredCapabilities
                  }))
                };
              } else if (step === 4) {
                stepName = 'Gap Analysis';
                stepAnswers = {
                  kpi_scoreboard: (data.coreActivities || []).map(a => ({
                    name: a.name,
                    currentCapabilities: a.currentCapabilities,
                    capabilityGap: a.capabilityGap,
                    developmentPlan: a.developmentPlan
                  }))
                };
              }
              const canProceed = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, stepAnswers, stepName);
              if (!canProceed) { setAiReviewing(false); return; }
            } catch (err) {
              console.warn('[AIChallenge] Error, allowing passage:', err);
            } finally {
              setAiReviewing(false);
            }
          }

          if (step >= 1 && step <= 4) {
            setStep(step + 0.5);
          }
        } else if (step === 0) {
          setStep(0.5);
        }
      };

      const goBack = () => {
        if (step === 5) {
          setStep(4);
        } else if (step > 1) {
          setStep(step - 1);
        } else if (step === 1) {
          setStep(0.5);
        }
      };

      // Validation functions
      const isStep1Valid = () => {
        return (data.coreActivities || []).length >= 1 &&
               (data.coreActivities || []).every(a =>
                 (a.name || '').trim().length >= 5 &&
                 (a.decisions || []).length >= 3 &&
                 (a.decisions || []).every(d =>
                   (d.decision || '').trim().length >= 20 &&
                   (d.frequency || '').trim().length >= 3 &&
                   (d.impact || '').trim().length >= 10
                 )
               );
      };

      const isStep2Valid = () => {
        return (data.coreActivities || []).every(a =>
          (a.dataInputs || '').length >= 50 &&
          (a.kpis || []).length >= 2 &&
          (a.kpis || []).every(k =>
            (k.kpi || '').trim().length >= 10 &&
            (k.target || '').trim().length >= 5
          )
        );
      };

      const isStep3Valid = () => {
        return (data.coreActivities || []).every(a =>
          (a.requiredCapabilities || '').length >= 100
        );
      };

      const isStep4Valid = () => {
        return (data.coreActivities || []).every(a =>
          (a.currentCapabilities || '').length >= 50 &&
          (a.capabilityGap || '').length >= 50 &&
          (a.developmentPlan || '').length >= 100
        );
      };

      const exportPDF = async () => {
        try {
          const canvas = document.getElementById('canvas-content');
          if (!canvas) {
            alert('Canvas not found');
            return;
          }

          const images = canvas.querySelectorAll('img');
          const imageStates = [];
          images.forEach(img => {
            imageStates.push({ img, display: img.style.display });
            img.style.display = 'none';
          });

          const canvasImage = await html2canvas(canvas, {
            scale: 2,
            logging: false,
            backgroundColor: '#ffffff'
          });

          imageStates.forEach(({ img, display }) => {
            img.style.display = display;
          });

          const imgWidth = 190;
          const imgHeight = (canvasImage.height * imgWidth) / canvasImage.width;

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'mm', 'a4');
          const imgData = canvasImage.toDataURL('image/png');

          pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
          pdf.save('core-decisions-capabilities.pdf');
        } catch (error) {
          console.error('PDF export error:', error);
          alert('Failed to export PDF: ' + error.message);
        }
      };

      const handleSubmit = async () => {
        const userId = localStorage.getItem('ft_user_id');
        if (!userId) {
          alert('User not authenticated. Please return to the dashboard.');
          return false;
        }

        try {
          const questionMappings = {
            decision_rights: (data.coreActivities || []).map(a => ({
              name: a.name,
              decisions: (a.decisions || []).map(d => ({
                decision: d.decision,
                frequency: d.frequency,
                impact: d.impact
              }))
            })),
            top3_per_activity: (data.coreActivities || []).map(a => ({
              name: a.name,
              dataInputs: a.dataInputs,
              kpis: (a.kpis || []).map(k => ({
                kpi: k.kpi,
                target: k.target
              }))
            })),
            capabilities: (data.coreActivities || []).map(a => ({
              name: a.name,
              requiredCapabilities: a.requiredCapabilities
            })),
            kpi_scoreboard: (data.coreActivities || []).map(a => ({
              name: a.name,
              currentCapabilities: a.currentCapabilities,
              capabilityGap: a.capabilityGap,
              developmentPlan: a.developmentPlan
            }))
          };
          await ToolDB.saveResponses(userId, CONFIG.TOOL_SLUG, questionMappings);
          alert('Core Decisions & Capabilities submitted successfully!');
          return true;
        } catch (error) {
          console.error('Supabase submission error:', error);
          alert('Submission failed. Please try again.');
          return false;
        }
      };

      // Transition screens (half-step values)
      if ([1.5, 2.5, 3.5].includes(step)) {
        return window.renderTransitionScreen(step, CONFIG, 4, setStep);
      }

      if (step === 0) return <CoverPage onStart={goNext} />;
      if (step === 0.5) return <IntroPage onNext={goNext} />;

      if (step === 4.5 || step === 5) {
        return <CanvasPage data={data} onExport={exportPDF} onSubmit={handleSubmit} />;
      }

      const canProceed = !aiReviewing && (
        step === 1 ? isStep1Valid() :
        step === 2 ? isStep2Valid() :
        step === 3 ? isStep3Valid() :
        step === 4 ? isStep4Valid() : false
      );

      const stepLabels = ['', 'Core Decisions', 'Data & KPIs', 'Capabilities', 'Gap Analysis'];

      return (
        <div className="wizard-layout">
          <div className="wizard-main">
            <div className="wizard-content animate-in">
              <DependencyContext deps={deps} />
              {step === 1 && <Step1Page data={data} updateActivity={updateActivity} addActivity={addActivity} removeActivity={removeActivity} addDecision={addDecision} removeDecision={removeDecision} updateDecision={updateDecision} aiReviewing={aiReviewing} />}
              {step === 2 && <Step2Page data={data} updateActivity={updateActivity} addKpi={addKpi} removeKpi={removeKpi} updateKpi={updateKpi} aiReviewing={aiReviewing} />}
              {step === 3 && <Step3Page data={data} updateActivity={updateActivity} aiReviewing={aiReviewing} />}
              {step === 4 && <Step4Page data={data} updateActivity={updateActivity} aiReviewing={aiReviewing} />}
            </div>
            <div className="wizard-footer">
              <button className="btn-wiz-back" onClick={goBack}>← BACK</button>
              <button className="btn-wiz-next" disabled={!canProceed} onClick={goNext}>
                {aiReviewing ? 'AI COACH REVIEWING...' : step === 4 ? 'VIEW CANVAS →' : 'NEXT →'}
              </button>
            </div>
          </div>
          <WizardSidebar currentStep={step} stepLabels={stepLabels} totalSteps={4} />
        </div>
      );
    }

    function WizardSidebar({ currentStep, stepLabels, totalSteps }) {
      return (
        <div className="wizard-sidebar">
          <div className="wizard-sidebar-inner">
            <div style={{ marginBottom: 24 }}>
              <div style={{ fontFamily: "'Monument', monospace", fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>SPRINT 23</div>
              <div style={{ fontSize: 13, color: '#999' }}>Core Decisions & Capabilities</div>
            </div>
            <div style={{ marginBottom: 16, fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#999' }}>Your journey</div>
            {Array.from({ length: totalSteps }, (_, i) => i + 1).map(n => {
              const effectiveStep = Math.ceil(currentStep);
              const isCompleted = effectiveStep > n, isActive = effectiveStep === n, isLocked = effectiveStep < n;
              return (
                <div key={n} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                    {isCompleted
                      ? <span style={{ color: '#000', fontWeight: 700 }}>✓</span>
                      : <span style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: isActive ? '#FFF469' : '#666' }}>{String(n).padStart(2, '0')}</span>}
                    <span style={{ fontSize: 14, color: isLocked ? '#555' : isCompleted ? '#000' : '#fff' }}>{stepLabels[n]}</span>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    // Cover Page Component
    function CoverPage({ onStart }) {
      return (
        <div className="relative min-h-screen flex items-center justify-center bg-black">
          <div
            className="absolute inset-0 w-full h-full"
            style={{
              backgroundImage: 'url("https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=1920&q=80")',
              backgroundSize: 'cover',
              backgroundPosition: 'center'
            }}
          ></div>
          <div className="absolute inset-0" style={{background: 'linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.85))'}}></div>

          <div className="relative z-10 text-center text-white px-8 max-w-5xl mx-auto">
            <h1 className="plaak animate-in" style={{fontSize: '100px', lineHeight: '1', marginBottom: '32px'}}>
              CORE DECISIONS
            </h1>
            <h2 className="plaak animate-in" style={{fontSize: '80px', lineHeight: '1', marginBottom: '32px', color: '#FFF469', animationDelay: '0.1s'}}>
              & CAPABILITIES
            </h2>
            <p className="text-4xl mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              Build the engine room of your company. Define decisions, measure outcomes, build capabilities.
            </p>
            <button
              onClick={onStart}
              className="bg-white text-black plaak px-16 py-6 border-4 border-white hover:bg-black hover:text-white transition-all text-3xl animate-in"
              style={{animationDelay: '0.4s'}}
            >
              START
            </button>
          </div>
        </div>
      );
    }

    // Intro Page Component
    function IntroPage({ onNext }) {
      return (
        <div className="bg-black text-white min-h-screen p-16">
          <div className="max-w-5xl mx-auto">
            <h1 className="plaak mb-16 animate-in" style={{fontSize: '100px'}}>
              BEFORE WE START
            </h1>

            {/* Sprint Info */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.05s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>SPRINT INFO</h2>
              <div className="bg-white text-black p-8">
                <p className="text-2xl font-bold mb-4">Sprint 23: Core Decisions & Capabilities</p>
                <p className="text-xl leading-relaxed mb-4">
                  Think of this sprint like laying down train tracks before a high-speed journey. If the tracks aren't properly mapped and reinforced, the train can't move at speed—or worse, it crashes. This sprint is all about identifying and strengthening the decision points and capabilities that will keep us moving fast and in the right direction.
                </p>
                <div className="border-l-4 border-black pl-4 italic text-lg">
                  Companies that clarify decision rights and match them with capabilities are 5x more likely to achieve their strategic goals.
                </div>
              </div>
            </div>

            {/* Purpose */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <h2 className="plaak text-6xl mb-6">PURPOSE</h2>

              <div className="border-l-4 border-white pl-6 mb-6">
                <p className="text-3xl italic mb-2">"Smart people slow down in broken systems. Average people speed up in well-designed systems."</p>
                <p className="text-xl text-gray-400">— FAST TRACK PRINCIPLE</p>
              </div>

              <p className="text-3xl leading-relaxed mb-4">
                Strategy without execution is just a dream. This sprint turns your core activities into something operational, measurable, and manageable. You will clarify decisions, identify KPIs, and specify capabilities needed to deliver results repeatedly and at speed.
              </p>
            </div>

            {/* Mistakes to Avoid */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>MISTAKES TO AVOID</h2>

              <div className="bg-white text-black p-6 mb-6 border-4 border-yellow-400">
                <p className="riforma-bold text-2xl mb-4">COMMON EXECUTION FAILURES:</p>
                <ul className="text-xl space-y-3">
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">1.</span>
                    <span><strong>Treating everything as a core decision:</strong> Focus only on what truly moves the needle, not every choice</span>
                  </li>
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">2.</span>
                    <span><strong>Blurred ownership:</strong> Unclear responsibilities stall execution and lead to poor decisions</span>
                  </li>
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">3.</span>
                    <span><strong>Being vague about KPIs:</strong> "Increase sales" isn't a KPI—"Lead conversion rate" is</span>
                  </li>
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">4.</span>
                    <span><strong>Ignoring capability gaps:</strong> Don't assume current strength equals sufficient strength</span>
                  </li>
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">5.</span>
                    <span><strong>No feedback loops:</strong> Without data, you can't improve decisions or measure impact</span>
                  </li>
                </ul>
              </div>
            </div>

            {/* The Journey */}
            <div className="mb-16 animate-in" style={{animationDelay: '0.3s'}}>
              <h2 className="plaak text-6xl mb-8">THE JOURNEY</h2>
              <div className="grid grid-cols-4 gap-4 text-center">
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">01</div>
                  <p className="text-xl font-bold mb-2">DECISIONS</p>
                  <p className="text-base text-gray-400">Key recurring choices</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">02</div>
                  <p className="text-xl font-bold mb-2">DATA & KPIs</p>
                  <p className="text-base text-gray-400">Inputs and outcomes</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">03</div>
                  <p className="text-xl font-bold mb-4">CAPABILITIES</p>
                  <p className="text-base text-gray-400">Skills and systems</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">04</div>
                  <p className="text-xl font-bold mb-2">GAP ANALYSIS</p>
                  <p className="text-base text-gray-400">Close the gaps</p>
                </div>
              </div>
            </div>

            {/* Next Button */}
            <button
              onClick={onNext}
              className="btn-primary w-full text-3xl py-8 plaak"
            >
              LET'S START →
            </button>
          </div>
        </div>
      );
    }

    // Step 1: Core Decisions
    function Step1Page({ data, updateActivity, addActivity, removeActivity, addDecision, removeDecision, updateDecision, onNext, onBack, canProceed, setShowHelp, aiReviewing }) {
      return (
        <div>

            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 1 OF 4
            </div>
            <div className="numbered-section mb-8 animate-in">01. CORE DECISIONS</div>

            {/* Fast Track Insight */}

            {/* The Science */}
            

            {/* Common Mistake */}


            <h3 className="riforma-bold text-5xl mb-8 animate-in" style={{animationDelay: '0.05s'}}>
              Identify the key recurring decisions that drive each core activity
            </h3>

            <div className="border-l-4 border-yellow-400 pl-6 mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <p className="text-2xl italic">
                "Zara makes weekly decisions: Which trend-based items to greenlight? How many SKUs to release and where? What gets pulled from stores? That speed is their competitive advantage."
              </p>
            </div>

            <p className="text-xl mb-8 text-gray-300">
              For each core activity, define 3-5 key decisions that are made often, directly affect outcomes, need data not opinions, and create visible impact when delayed or wrong. These are leverage points that determine execution speed and quality.
            </p>

            <div className="space-y-8 mb-12">
              {(data.coreActivities || []).map((activity, actIndex) => (
                <div key={activity.id} className="border-4 border-gray-700 p-6 animate-in" style={{animationDelay: `${0.15 + actIndex * 0.05}s`}}>
                  <div className="flex justify-between items-start mb-6">
                    <h4 className="riforma-bold text-3xl">Core Activity {actIndex + 1}</h4>
                    {(data.coreActivities || []).length > 1 && (
                      <button
                        onClick={() => removeActivity(activity.id)}
                        className="text-red-600 hover:text-red-800 text-sm"
                      >
                        REMOVE ACTIVITY
                      </button>
                    )}
                  </div>

                  <div className="mb-6">
                    <label className="monument text-sm block mb-2">ACTIVITY NAME <span className="text-red-500">*</span></label>
                    
                    <input
                      type="text"
                      value={activity.name || ''}
                      onChange={(e) => updateActivity(activity.id, 'name', e.target.value)}
                      placeholder="Fast Fashion Design / Course Development / Customer Onboarding"
                      className="w-full"
                    />
                    <div className="char-counter">{(activity.name || '').length}/200 (min 5)</div>
                  </div>

                  <div className="mb-4">
                    <h5 className="riforma-bold text-2xl mb-3">Key Decisions (minimum 3)</h5>
                    {(activity.decisions || []).map((decision, decIndex) => (
                      <div key={decision.id} className="border-2 border-gray-700 p-4 mb-4" style={{background:"#1a1a1a"}}>
                        <div className="flex justify-between items-center mb-3">
                          <span className="monument text-xs">DECISION {decIndex + 1}</span>
                          {(activity.decisions || []).length > 1 && (
                            <button
                              onClick={() => removeDecision(activity.id, decision.id)}
                              className="text-red-600 hover:text-red-800 text-sm"
                            >
                              REMOVE
                            </button>
                          )}
                        </div>

                        <div className="space-y-3">
                          <div>
                            <label className="monument text-xs block mb-1">DECISION DESCRIPTION <span className="text-red-500">*</span></label>
                            
                            <textarea
                              value={decision.decision || ''}
                              onChange={(e) => updateDecision(activity.id, decision.id, 'decision', e.target.value)}
                              placeholder="Which features do we prioritize this sprint based on user feedback and strategic goals?"
                              className="w-full"
                              rows={3}
                            />
                            <div className="char-counter text-xs">{(decision.decision || '').length}/500 (min 20)</div>
                          </div>

                          <div className="grid grid-cols-2 gap-3">
                            <div>
                              <label className="monument text-xs block mb-1">FREQUENCY <span className="text-red-500">*</span></label>
                              
                              <input
                                type="text"
                                value={decision.frequency || ''}
                                onChange={(e) => updateDecision(activity.id, decision.id, 'frequency', e.target.value)}
                                placeholder="Weekly / Monthly / Quarterly"
                                className="w-full"
                              />
                              <div className="char-counter text-xs">{(decision.frequency || '').length}/50 (min 3)</div>
                            </div>
                            <div>
                              <label className="monument text-xs block mb-1">IMPACT LEVEL <span className="text-red-500">*</span></label>
                              <input
                                type="text"
                                value={decision.impact || ''}
                                onChange={(e) => updateDecision(activity.id, decision.id, 'impact', e.target.value)}
                                placeholder="High / Critical / Medium"
                                className="w-full"
                              />
                              <div className="char-counter text-xs">{(decision.impact || '').length}/50 (min 10)</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                    <button
                      onClick={() => addDecision(activity.id)}
                      className="btn-secondary text-sm w-full"
                    >
                      + ADD DECISION
                    </button>
                  </div>
                </div>
              ))}

              <button onClick={addActivity} className="btn-secondary w-full">
                + ADD CORE ACTIVITY
              </button>
            </div>
        </div>
      );
    }

    // Step 2: Decision Data & KPIs
    function Step2Page({ data, updateActivity, addKpi, removeKpi, updateKpi, onNext, onBack, canProceed, setShowHelp, aiReviewing }) {
      return (
        <div>

            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 2 OF 4
            </div>
            <div className="numbered-section mb-8 animate-in">02. DECISION DATA & KPIs</div>

            {/* Fast Track Insight */}

            {/* The Science */}
            


            <h3 className="riforma-bold text-5xl mb-8 animate-in" style={{animationDelay: '0.05s'}}>
              Define data inputs needed and KPIs to measure outcomes
            </h3>

            <div className="border-l-4 border-yellow-400 pl-6 mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <p className="text-2xl italic">
                "Zara's Design KPIs: Time from sketch to shelf (speed), SKU success rate (hit ratio), weekly trend adoption rate (customer alignment). These signals tell them if they're building momentum or wasting cycles."
              </p>
            </div>

            <p className="text-xl mb-8 text-gray-300">
              Every decision needs feedback. Decision data fuels smarter choices before decisions are made. Outcome KPIs measure whether decisions drove desired results. Without both, you're flying blind.
            </p>

            <div className="space-y-8 mb-12">
              {(data.coreActivities || []).map((activity, actIndex) => (
                <div key={activity.id} className="border-4 border-gray-700 p-6 animate-in" style={{animationDelay: `${0.15 + actIndex * 0.05}s`}}>
                  <h4 className="riforma-bold text-3xl mb-6">
                    {(activity.name || '').substring(0, 50) || `Activity ${actIndex + 1}`}
                  </h4>

                  <div className="mb-6 border-2 border-gray-700 p-6" style={{background:"#1a1a1a"}}>
                    <label className="monument text-sm block mb-2">DECISION DATA INPUTS <span className="text-red-500">*</span></label>
                    <p className="text-sm text-gray-400 mb-2">What information is needed to make smart decisions for this activity?</p>
                    <textarea
                      value={activity.dataInputs || ''}
                      onChange={(e) => updateActivity(activity.id, 'dataInputs', e.target.value)}
                      placeholder="Real-time sales data by region, inventory levels, customer feedback scores, competitor trend analysis, store manager reports"
                      className="w-full"
                      rows={4}
                    />
                    <div className="char-counter">{(activity.dataInputs || '').length}/1000 (min 50)</div>
                  </div>

                  <div>
                    <h5 className="riforma-bold text-2xl mb-3">Outcome KPIs (minimum 2)</h5>
                    {(activity.kpis || []).map((kpi, kpiIndex) => (
                      <div key={kpi.id} className="border-2 border-gray-700 p-4 mb-4" style={{background:"#1a1a1a"}}>
                        <div className="flex justify-between items-center mb-3">
                          <span className="monument text-xs">KPI {kpiIndex + 1}</span>
                          {(activity.kpis || []).length > 1 && (
                            <button
                              onClick={() => removeKpi(activity.id, kpi.id)}
                              className="text-red-600 hover:text-red-800 text-sm"
                            >
                              REMOVE
                            </button>
                          )}
                        </div>

                        <div className="space-y-3">
                          <div>
                            <label className="monument text-xs block mb-1">KPI METRIC <span className="text-red-500">*</span></label>
                            <input
                              type="text"
                              value={kpi.kpi || ''}
                              onChange={(e) => updateKpi(activity.id, kpi.id, 'kpi', e.target.value)}
                              placeholder="Time from sketch to shelf / Lead conversion rate / Employee satisfaction score"
                              className="w-full"
                            />
                            <div className="char-counter text-xs">{(kpi.kpi || '').length}/300 (min 10)</div>
                          </div>

                          <div>
                            <label className="monument text-xs block mb-1">TARGET / BENCHMARK <span className="text-red-500">*</span></label>
                            <input
                              type="text"
                              value={kpi.target || ''}
                              onChange={(e) => updateKpi(activity.id, kpi.id, 'target', e.target.value)}
                              placeholder="Under 14 days / Above 15% / 8/10 or higher"
                              className="w-full"
                            />
                            <div className="char-counter text-xs">{(kpi.target || '').length}/200 (min 5)</div>
                          </div>
                        </div>
                      </div>
                    ))}
                    <button
                      onClick={() => addKpi(activity.id)}
                      className="btn-secondary text-sm w-full"
                    >
                      + ADD KPI
                    </button>
                  </div>
                </div>
              ))}
            </div>
        </div>
      );
    }

    // Step 3: Required Capabilities
    function Step3Page({ data, updateActivity, onNext, onBack, canProceed, setShowHelp, aiReviewing }) {
      return (
        <div>

            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 3 OF 4
            </div>
            <div className="numbered-section mb-8 animate-in">03. REQUIRED CAPABILITIES</div>

            {/* Fast Track Insight */}

            {/* The Science */}
            


            <h3 className="riforma-bold text-5xl mb-8 animate-in" style={{animationDelay: '0.05s'}}>
              Define skills, systems, and resources needed for excellence
            </h3>

            <div className="border-l-4 border-yellow-400 pl-6 mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <p className="text-2xl italic">
                "Zara's Design Capabilities: Designers and buyers in daily sync making real-time calls, rapid prototyping labs, tight feedback loops from stores and data systems. Without these, their speed model collapses."
              </p>
            </div>

            <p className="text-xl mb-8 text-gray-300">
              Capabilities are the real-world skills, systems, and resources needed to win. They may be human (expertise), systemic (tools, workflows), or relational (partnerships). No capability means no delivery.
            </p>

            <div className="space-y-8 mb-12">
              {(data.coreActivities || []).map((activity, actIndex) => (
                <div key={activity.id} className="border-4 border-gray-700 p-6 animate-in" style={{animationDelay: `${0.15 + actIndex * 0.05}s`}}>
                  <h4 className="riforma-bold text-3xl mb-6">
                    {(activity.name || '').substring(0, 50) || `Activity ${actIndex + 1}`}
                  </h4>

                  <div className="border-2 border-gray-700 p-6" style={{background:"#1a1a1a"}}>
                    <label className="monument text-sm block mb-2">REQUIRED CAPABILITIES <span className="text-red-500">*</span></label>
                    <p className="text-sm text-gray-400 mb-2">What skills, systems, and resources are required to execute this activity at world-class level?</p>
                    <textarea
                      value={activity.requiredCapabilities || ''}
                      onChange={(e) => updateActivity(activity.id, 'requiredCapabilities', e.target.value)}
                      placeholder="HUMAN: Curriculum designers who understand regulation AND pedagogy, experienced facilitators with 5+ years teaching experience&#10;&#10;SYSTEMIC: Fast modular content production system, LMS platform with analytics, quality assurance workflow&#10;&#10;RELATIONAL: Direct input from 10+ industry partners, collaboration with regulatory bodies, peer review network"
                      className="w-full"
                      rows={10}
                    />
                    <div className="char-counter">{(activity.requiredCapabilities || '').length}/2000 (min 100)</div>
                  </div>
                </div>
              ))}
            </div>
        </div>
      );
    }

    // Step 4: Gap Analysis
    function Step4Page({ data, updateActivity, onNext, onBack, canProceed, setShowHelp, aiReviewing }) {
      return (
        <div>

            <div style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 8 }}>
              STEP 4 OF 4
            </div>
            <div className="numbered-section mb-8 animate-in">04. GAP ANALYSIS</div>

            {/* Fast Track Insight */}

            {/* The Science */}
            


            <h3 className="riforma-bold text-5xl mb-8 animate-in" style={{animationDelay: '0.05s'}}>
              Compare current vs required capabilities and define development plans
            </h3>

            <div className="border-l-4 border-yellow-400 pl-6 mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <p className="text-2xl italic">
                "The gap between required and current capabilities becomes your training agenda, hiring spec, partner criteria, and Personal Development Plans. It's not about blaming people—it's about designing success."
              </p>
            </div>

            <p className="text-xl mb-8 text-gray-300">
              Be brutally honest about current state. Document what you have, what you need, specific gaps, and concrete actions to close them. This is your roadmap for scaling.
            </p>

            <div className="space-y-8 mb-12">
              {(data.coreActivities || []).map((activity, actIndex) => (
                <div key={activity.id} className="border-4 border-gray-700 p-6 animate-in" style={{animationDelay: `${0.15 + actIndex * 0.05}s`}}>
                  <h4 className="riforma-bold text-3xl mb-6">
                    {(activity.name || '').substring(0, 50) || `Activity ${actIndex + 1}`}
                  </h4>

                  <div className="space-y-6">
                    <div className="border-2 border-gray-700 p-6" style={{background:"#1a1a1a"}}>
                      <label className="monument text-sm block mb-2">CURRENT CAPABILITIES <span className="text-red-500">*</span></label>
                      <p className="text-sm text-gray-400 mb-2">What skills, systems, and resources do we have today?</p>
                      <textarea
                        value={activity.currentCapabilities || ''}
                        onChange={(e) => updateActivity(activity.id, 'currentCapabilities', e.target.value)}
                        placeholder="HUMAN: 2 curriculum designers (1 with healthcare background, 1 with education background), 3 part-time facilitators&#10;&#10;SYSTEMIC: Basic LMS platform (no analytics), manual content review process&#10;&#10;RELATIONAL: 3 industry partners, informal relationships with 2 regulatory contacts"
                        className="w-full"
                        rows={6}
                      />
                      <div className="char-counter">{(activity.currentCapabilities || '').length}/2000 (min 50)</div>
                    </div>

                    <div className="bg-yellow-50 border-2 border-yellow-400 p-6">
                      <label className="monument text-sm block mb-2">CAPABILITY GAPS <span className="text-red-500">*</span></label>
                      <p className="text-sm text-gray-400 mb-2">What are the specific gaps between current and required?</p>
                      <textarea
                        value={activity.capabilityGap || ''}
                        onChange={(e) => updateActivity(activity.id, 'capabilityGap', e.target.value)}
                        placeholder="HUMAN GAPS: Need 1 senior designer with both regulation AND pedagogy expertise, need 2 more experienced facilitators&#10;&#10;SYSTEMIC GAPS: LMS lacks analytics module, no automated QA workflow, content production too slow&#10;&#10;RELATIONAL GAPS: Need 7 more industry partners, formal partnerships with regulatory bodies, no peer review network"
                        className="w-full"
                        rows={6}
                      />
                      <div className="char-counter">{(activity.capabilityGap || '').length}/2000 (min 50)</div>
                    </div>

                    <div className="bg-neutral-900 border-2 border-black p-6">
                      <label className="monument text-sm block mb-2">DEVELOPMENT PLAN <span className="text-red-500">*</span></label>
                      <p className="text-sm text-gray-400 mb-2">Concrete actions to close gaps (training, hiring, partnering, systems investment)</p>
                      <textarea
                        value={activity.developmentPlan || ''}
                        onChange={(e) => updateActivity(activity.id, 'developmentPlan', e.target.value)}
                        placeholder="Q2 2025: Hire senior curriculum designer with dual expertise (budget: $120K)&#10;Q2 2025: Send current designers to regulatory training program (2-day workshop)&#10;Q3 2025: Upgrade LMS to include analytics module (investment: $50K)&#10;Q3 2025: Build QA automation workflow with operations team&#10;Q4 2025: Partner outreach campaign to secure 7 new industry partners&#10;Q1 2026: Recruit 2 experienced facilitators (budget: $80K each)"
                        className="w-full"
                        rows={8}
                      />
                      <div className="char-counter">{(activity.developmentPlan || '').length}/3000 (min 100)</div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
        </div>
      );
    }

    // Canvas Page
    function CanvasPage({ data, onExport, onSubmit }) {
      return (
        <div className="bg-black text-white min-h-screen p-16">
          <div className="max-w-6xl mx-auto">
            {/* Canvas Content */}
            <div id="canvas-content" className="bg-white p-16 mb-8">
              <div className="border-b-4 border-black pb-8 mb-8">
                <h1 className="plaak text-7xl mb-2">CORE DECISIONS & CAPABILITIES</h1>
                <p className="text-2xl text-gray-400">Sprint 23 - Build The Engine Room</p>
              </div>

              {(data.coreActivities || []).map((activity, index) => (
                <div key={activity.id} className="mb-12 pb-8 border-b-2 border-gray-700">
                  {/* Activity Header */}
                  <div className="mb-6">
                    <h2 className="riforma-bold text-4xl mb-2">
                      {(activity.name || '').substring(0, 80) || `Core Activity ${index + 1}`}
                    </h2>
                  </div>

                  {/* Decisions */}
                  <div className="mb-6">
                    <h3 className="riforma-bold text-2xl mb-3">Key Decisions</h3>
                    <div className="space-y-2">
                      {(activity.decisions || []).slice(0, 5).map((decision, i) => (
                        <div key={i} className="p-4 border-l-4 border-yellow-400" style={{background:"#1a1a1a"}}>
                          <p className="text-base mb-1">{(decision.decision || '').substring(0, 150)}</p>
                          <p className="text-sm text-gray-400">
                            Frequency: {decision.frequency || 'N/A'} | Impact: {decision.impact || 'N/A'}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* KPIs */}
                  <div className="mb-6">
                    <h3 className="riforma-bold text-2xl mb-3">KPIs</h3>
                    <div className="grid grid-cols-2 gap-3">
                      {(activity.kpis || []).slice(0, 4).map((kpi, i) => (
                        <div key={i} className="bg-yellow-50 p-3 border-l-4 border-yellow-400">
                          <p className="riforma-bold text-base mb-1">{(kpi.kpi || '').substring(0, 80)}</p>
                          <p className="text-sm text-gray-400">Target: {(kpi.target || '').substring(0, 50)}</p>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Capability Gap */}
                  <div className="mb-6">
                    <h3 className="riforma-bold text-2xl mb-3">Capability Gap</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-4 border-l-4 border-yellow-400" style={{background:"#1a1a1a"}}>
                        <p className="riforma-bold text-lg mb-2">Current</p>
                        <p className="text-sm">{(activity.currentCapabilities || '').substring(0, 200)}...</p>
                      </div>
                      <div className="p-4 border-l-4 border-yellow-400" style={{background:"#1a1a1a"}}>
                        <p className="riforma-bold text-lg mb-2">Required</p>
                        <p className="text-sm">{(activity.requiredCapabilities || '').substring(0, 200)}...</p>
                      </div>
                    </div>
                  </div>

                  {/* Development Plan */}
                  <div className="bg-neutral-900 p-4 border-2 border-gray-300">
                    <h3 className="riforma-bold text-xl mb-2">Development Plan</h3>
                    <p className="text-sm">{(activity.developmentPlan || '').substring(0, 300)}...</p>
                  </div>
                </div>
              ))}

              <div className="mt-12 pt-8 border-t-2 border-gray-700 text-center text-sm text-gray-500">
                <p>Generated: {new Date().toLocaleDateString()}</p>
                <p className="mt-1">Fast Track Sprint 23 - Core Decisions & Capabilities</p>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-6 mb-6">
              <button onClick={onExport} className="btn-primary flex-1">
                EXPORT PDF
              </button>
              <button onClick={onSubmit} className="btn-primary flex-1">
                SUBMIT
              </button>
            </div>

            {/* Case Study */}
            <CaseStudy
                before={"All decisions funneled through the CEO. Weekly design reviews took 3 weeks to schedule. Store managers had no authority to pull underperforming SKUs. The result: 60% slower time-to-shelf than competitors and mounting inventory waste."}
                after={"Zara implemented a tiered decision framework. Store managers gained authority over local assortment pulls. Design teams were empowered to greenlight trend items in daily syncs. Only strategic bets above a threshold escalated to leadership. Result: 80% of operational decisions now made within 24 hours."}
                quote={"Once we stopped funneling every call through the top, our people started making better decisions faster than we ever could centrally. The framework did not remove control \u2014 it distributed intelligence. \u2014 Retail Operations Director, Zara"}
            />
          </div>
        </div>
      );
    }

    // Progress Indicator
    function ProgressIndicator({ currentStep }) {
      const steps = [
        { number: 1, label: 'Decisions' },
        { number: 2, label: 'Data & KPIs' },
        { number: 3, label: 'Capabilities' },
        { number: 4, label: 'Gap Analysis' }
      ];

      return (
        <div className="flex items-center justify-center gap-4 mb-12">
          {steps.map((step, index) => (
            <Fragment key={step.number}>
              <div className="flex flex-col items-center">
                <div className={`progress-dot ${step.number === currentStep ? 'active' : ''} ${step.number < currentStep ? 'completed' : ''}`}></div>
                <div className="monument text-xs mt-2">{step.label}</div>
              </div>
              {index < steps.length - 1 && <div className="progress-line w-12"></div>}
            </Fragment>
          ))}
        </div>
      );
    }

    // Render App
        ReactDOM.render(<CoreDecisionsApp />, document.getElementById('root'));
  </script>
</body>
</html>
