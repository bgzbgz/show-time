<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Size Tool | Fast Track</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

    <!-- Font preloading to prevent FOUT -->
    <link rel="preload" href="Plaak3Trial-43-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="RiformaLL-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="MonumentGrotesk-Mono.woff2" as="font" type="font/woff2" crossorigin>

    <style>
        /* === FONT FACES === */
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); font-display: swap; }

        /* === BASE RESET === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Riforma', -apple-system, sans-serif;
            font-size: 16px;
            color: #000;
            background: #000;
            -webkit-font-smoothing: antialiased;
        }

        /* === CUSTOM SCROLLBAR === */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        * { scrollbar-width: thin; scrollbar-color: #000 transparent; }

        /* === TYPOGRAPHY HELPERS === */
        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        /* === LAYOUT FRAME === */
        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        /* === WIZARD LAYOUT === */
        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fff;
        }
        .wizard-content {
            max-width: 640px;
            width: 100%;
            margin: 0 auto;
            padding: 48px 32px;
            flex: 1;
        }
        /* Step 3 needs wider content for side-by-side matrix */
        .wizard-content-wide {
            max-width: 960px;
            width: 100%;
            margin: 0 auto;
            padding: 48px 32px;
            flex: 1;
        }

        /* === SIDEBAR === */
        .wizard-sidebar {
            width: 280px;
            background: #000;
            border-left: 1px solid #000;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: hidden;
        }
        .wizard-sidebar-inner {
            padding: 32px 24px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .sidebar-step-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }

        /* === STEP HEADER === */
        .step-indicator {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-time { font-family: 'Monument', monospace; font-size: 11px; color: #6B7280; }
        .step-heading {
            font-family: 'Plaak', sans-serif;
            font-weight: bold;
            font-size: 32px;
            text-transform: uppercase;
            letter-spacing: -0.01em;
            line-height: 1.2;
            color: #000;
            margin-bottom: 6px;
        }
        .step-hint {
            font-size: 16px;
            color: #6B7280;
            line-height: 1.5;
            margin: 0 0 32px 0;
        }

        /* === FORM ELEMENTS === */
        .ft-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Monument', monospace;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 8px;
        }
        .ft-required { color: #DC2626; font-weight: 700; }

        .ft-input {
            width: 100%;
            height: 44px;
            padding: 8px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }
        .ft-input.has-error { border: 2px solid #DC2626; }

        .ft-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            resize: none !important;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-textarea:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }

        /* Small input for matrix cells */
        .ft-input-sm {
            width: 64px;
            height: 36px;
            padding: 4px 8px;
            font-family: 'Riforma', sans-serif;
            font-size: 14px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            text-align: center;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-input-sm:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }

        .ft-help { font-size: 14px; color: #6B7280; margin-top: 4px; line-height: 1.5; }
        .ft-field-group { margin-bottom: 24px; }
        .ft-field-group:last-child { margin-bottom: 0; }
        .ft-section { margin-bottom: 32px; }

        /* === YELLOW INSIGHT BOX === */
        .ft-insight {
            background: #FFF469;
            border: 3px solid #000;
            padding: 16px;
            margin-bottom: 32px;
        }

        /* === EXAMPLE BOX === */
        .ft-example {
            background: #F3F4F6;
            padding: 16px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #1F2937;
        }

        /* === ERROR SUMMARY === */
        .ft-error-summary {
            border: 2px solid #DC2626;
            background: #fff;
            padding: 16px;
            margin-bottom: 24px;
        }

        /* === BUTTON FOOTER === */
        .btn-footer {
            position: sticky;
            bottom: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-top: 1px solid #E5E7EB;
            background: #fff;
            width: 100%;
        }
        .btn-back {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-back:hover { background: #F3F4F6; }
        .btn-next {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E5E7EB; color: #9CA3AF; border-color: #E5E7EB; cursor: not-allowed; }

        /* === MOBILE STEP BAR === */
        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; background: #F3F4F6; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E5E7EB; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }

        /* === CANVAS / RESULT STYLES === */
        .numbered-section { background: #000; color: #fff; padding: 8px 14px; font-size: 14px; font-weight: bold; letter-spacing: 0.5px; display: inline-block; font-family: 'Monument', monospace; }

        .result-card {
            background: #FFFFFF;
            border: 2px solid #000000;
            padding: 24px;
            transition: all 0.2s ease;
        }
        .result-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* === TOOL-SPECIFIC: slider === */
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #000000;
            cursor: pointer;
            border-radius: 50%;
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #000000;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        /* === TOOL-SPECIFIC: force row === */
        .force-row {
            border: 1px solid #E5E7EB;
            transition: all 0.2s ease;
        }
        .force-row:hover {
            border-color: #000000;
            background: #F9FAFB;
        }

        /* === TOOL-SPECIFIC: add/remove buttons === */
        .add-btn {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 10px 20px;
            font-family: 'Riforma', sans-serif;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            text-align: center;
        }
        .add-btn:hover { background: #F3F4F6; }

        /* === ANIMATIONS === */
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }

        /* === PRINT === */
        @media print { .no-print { display: none !important; } }

        /* === RESPONSIVE === */
        @media (min-width: 769px) and (max-width: 1024px) {
            .wizard-sidebar { width: 220px; }
            .wizard-sidebar-inner { padding: 24px 16px; }
        }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .mobile-step-bar { display: block; }
            .wizard-content { padding: 24px 16px; }
            .wizard-content-wide { padding: 24px 16px; }
            .step-heading { font-size: 24px; }
            .btn-footer { padding: 12px 16px; }
        }
        @media (max-width: 480px) {
            .step-heading { font-size: 20px; }
            .wizard-content { padding: 20px 12px; }
            .wizard-content-wide { padding: 20px 12px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
            TOOL_SLUG: 'market-size',
            AUTOSAVE_DELAY: 2000
        };

        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // Make Supabase client globally available for dependency injection
        window.supabaseClient = supabaseClient;

        // Initialize ToolDB and dependency injection
        ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);


        // Initialize cognitive load components
        CognitiveLoad.init('market-size', {"insights":["TAM-SAM-SOM determines whether your dream is even possible.","Most companies overestimate TAM and underestimate effort to capture SAM."],"caseStudy":{"before":"A European food company estimated their market at 500M+ consumers based on total population. They pursued an aggressive expansion across six countries simultaneously, spreading resources thin with no prioritization framework.","after":"After applying TAM-SAM-SOM analysis, they discovered their realistic serviceable market was only 12% of total population. They refocused on two high-margin segments in three countries, doubling revenue within 18 months while cutting expansion costs by 60%.","quote":"We thought bigger meant better. The market sizing discipline showed us that a focused 12% of the right customers was worth more than chasing 100% of the wrong ones. - Fast Track Alumni, FMCG Sector"}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

        const LOGO_WHITE = '../../../Designs/02. logos/FastTrack_F_White.png';

        /* ============================================================
           TRANSITION CONTENT
           ============================================================ */
        const TRANSITION_CONTENT = {
            1: {
                title: 'MARKET SIZED.',
                text: "You know your Total Addressable Market and Profit Pool. Now let's identify the forces that will change these numbers over the next 3 years.",
                brutalTruth: 'Most TAM numbers are wrong — not because of bad math, but because founders confuse the market that exists with the market they can actually reach. A €50B TAM is meaningless if your addressable slice is €2M.',
                peerProof: '"A SaaS founder calculated a €4B TAM and raised €500k. Their first 18 months revealed the real SAM was €35M. Reframing around serviceable market changed their ICP, pricing, and channel strategy — and saved the company."'
            },
            2: {
                title: 'FORCES RANKED.',
                text: "Your top driving forces are identified and prioritized. Now estimate their actual impact on your market variables over the next 3 years.",
                brutalTruth: 'Growth rate matters more than market size. A €500M market growing at 25% is far more attractive than a €5B market growing at 2%. The mistake is optimizing for size when you should be optimizing for trajectory.',
                peerProof: '"A B2B analytics company chose a €300M niche market that was growing 40% annually over a €3B traditional market growing 4%. Three years later, they had 8% market share in the growing niche — versus near-zero in the established one."'
            }
        };

        /* ============================================================
           SHARED COMPONENTS
           ============================================================ */

        function CheckIcon({ color = "#fff", size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
        }

        function ButtonFooter({ onBack, onNext, nextLabel = 'Next', showBack = true, disabled = false, extraButtons }) {
            return (
                <div className="btn-footer no-print">
                    {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                    <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                        {extraButtons}
                        <button className="btn-next" disabled={disabled} onClick={onNext}>{nextLabel} &rarr;</button>
                    </div>
                </div>
            );
        }

        function MobileStepBar({ currentStep, totalSteps }) {
            const total = totalSteps || 3;
            const progress = Math.round((Math.min(currentStep, total) / total) * 100);
            return (
                <div className="mobile-step-bar no-print">
                    <div className="bar-text">Step {Math.min(currentStep, total)} of {total}</div>
                    <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${progress}%` }} /></div>
                </div>
            );
        }

        function WizardSidebar({ currentStep, marketSize, profitPool, rankedForces, onNavigate }) {
            const steps = [
                { num: 1, label: 'Market Size', time: '~2 min' },
                { num: 2, label: 'Driving Forces', time: '~5 min' },
                { num: 3, label: 'Future Impact', time: '~5 min' }
            ];
            const formatCurrencyShort = (v) => v >= 1000000 ? (v/1000000).toFixed(1) + 'M' : v >= 1000 ? Math.round(v/1000) + 'K' : Math.round(v);
            const getSnippet = (n) => {
                if (n === 1 && marketSize > 0) return 'TAM: ' + formatCurrencyShort(marketSize);
                if (n === 2 && rankedForces.length >= 3) return rankedForces.length + ' forces ranked';
                return null;
            };
            return (
                <div className="wizard-sidebar no-print">
                    <div className="wizard-sidebar-inner">
                        <div style={{ marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>MARKET SIZE</div>
                            <div style={{ fontSize: 13, color: '#999' }}>~12 min total</div>
                        </div>
                        <div style={{ marginBottom: 16, fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#999' }}>Your journey</div>
                        {steps.map(s => {
                            const isCompleted = currentStep > s.num, isActive = currentStep === s.num, isLocked = currentStep < s.num;
                            const snippet = isCompleted ? getSnippet(s.num) : null;
                            return (
                                <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                                    onClick={() => isCompleted && onNavigate && onNavigate(s.num)}
                                    title={isCompleted ? 'Click to review this step' : ''}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                        {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                                        <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                                    </div>
                                    {snippet && <div className="sidebar-snippet">{snippet}</div>}
                                </div>
                            );
                        })}

                        {/* Coach Feedback Panel */}
                        <CoachFeedbackPanel />
                    </div>
                </div>
            );
        }

        function CoachFeedbackPanel() {
            const [expanded, setExpanded] = useState(false);
            const [feedback, setFeedback] = useState(null);
            useEffect(() => {
                const check = () => { if (window.AIChallenge && window.AIChallenge.getLastFeedback) setFeedback(window.AIChallenge.getLastFeedback()); };
                check();
                const interval = setInterval(check, 2000);
                return () => clearInterval(interval);
            }, []);
            if (!feedback) return null;
            return (
                <div style={{ marginTop: 24, borderTop: '1px solid #333', paddingTop: 16 }}>
                    <button onClick={() => setExpanded(!expanded)} style={{ background: 'none', border: 'none', color: '#FFF469', cursor: 'pointer', fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', display: 'flex', alignItems: 'center', gap: 6, padding: 0, width: '100%' }}>
                        <span style={{ transform: expanded ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s', display: 'inline-block' }}>&#9654;</span>
                        COACH FEEDBACK
                    </button>
                    {expanded && (
                        <div style={{ marginTop: 10, fontSize: 12, color: '#ccc', lineHeight: 1.5 }}>
                            {feedback.type === 'approved' && <p style={{ color: '#FFF469' }}>{feedback.message}</p>}
                            {feedback.type === 'challenges' && (<>
                                {feedback.encouragement && <p style={{ color: '#FFF469', marginBottom: 8 }}>{feedback.encouragement}</p>}
                                {feedback.challenges && feedback.challenges.map((ch, i) => (
                                    <div key={i} style={{ marginBottom: 8, paddingLeft: 8, borderLeft: '2px solid #555' }}>
                                        <div style={{ fontSize: 10, color: '#999', marginBottom: 2 }}>{ch.question_text || ch.question_key}</div>
                                        <div>{ch.feedback}</div>
                                    </div>
                                ))}
                            </>)}
                        </div>
                    )}
                </div>
            );
        }

        function DependencyContext({ deps }) {
            const [open, setOpen] = React.useState(false);
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '16px' }}>
                    <button onClick={() => setOpen(o => !o)} style={{ display: 'flex', alignItems: 'center', gap: 8, background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '8px 14px', fontSize: 12, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase', cursor: 'pointer', color: '#555', width: '100%' }}>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#DAA520" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        CONTEXT FROM PREVIOUS TOOLS ({deps.length})
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#999" strokeWidth="2" style={{ marginLeft: 'auto', transform: open ? 'rotate(180deg)' : 'none', transition: 'transform 0.2s' }}><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    {open && (
                        <div style={{ border: '1px solid #F0E68C', borderTop: 'none', padding: '12px 14px' }}>
                            {deps.map((dep, i) => (
                                <div key={i} style={{ background: '#fff', padding: '8px 0', borderBottom: i < deps.length - 1 ? '1px solid #F0E68C' : 'none', fontSize: '13px' }}>
                                    <div style={{ fontWeight: 600, marginBottom: '2px', color: '#333', fontSize: '11px', fontFamily: "'Monument', monospace", letterSpacing: '0.04em', textTransform: 'uppercase' }}>{dep.label}</div>
                                    <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        /* ============================================================
           HELPER FUNCTIONS
           ============================================================ */
        const formatCurrency = (value, currency = '\u20AC') => {
            if (!value && value !== 0) return '-';
            return `${currency} ${Math.round(value).toLocaleString('en-US')}`;
        };

        // Supabase Submission Function
        const submitToSupabase = async (submissionData) => {
            try {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) {
                    alert('User not authenticated. Please return to the dashboard.');
                    return { success: false, error: 'User not authenticated' };
                }

                const questionMappings = {
                    tam: { totalCustomers: submissionData.marketData.totalCustomers, avgSpending: submissionData.marketData.avgSpending, purchasesPerYear: submissionData.marketData.purchasesPerYear, grossMargin: submissionData.marketData.grossMargin, marketSize: submissionData.marketData.marketSize, profitPool: submissionData.marketData.profitPool, forecast: { currentYear: submissionData.forecast.currentYear, futureYear: submissionData.forecast.futureYear, futureMarketSize: submissionData.forecast.futureMarketSize, futureProfitPool: submissionData.forecast.futureProfitPool } },
                    driving_forces: submissionData.drivingForces
                };

                await ToolDB.saveResponses(userId, CONFIG.TOOL_SLUG, questionMappings);
                return { success: true };
            } catch (error) {
                console.error('Supabase submission error:', error);
                return { success: false, error: error.message };
            }
        };

        /* ============================================================
           MAIN APP COMPONENT
           ============================================================ */
        function MarketSizeTool() {
            const [deps, setDeps] = useState([]);
            const [step, setStep] = useState(0);
            const [step1Phase, setStep1Phase] = useState(1);
            const [step2Phase, setStep2Phase] = useState('list');
            // userEmail removed — no longer collected
            const [aiReviewing, setAiReviewing] = useState(false);

            const [marketData, setMarketData] = useState({
                totalCustomers: '',
                avgSpending: '',
                purchasesPerYear: '',
                grossMargin: ''
            });

            const [drivingForces, setDrivingForces] = useState([
                { id: 1, name: '', impact: 3, probability: 3 },
                { id: 2, name: '', impact: 3, probability: 3 },
                { id: 3, name: '', impact: 3, probability: 3 }
            ]);
            const [impactData, setImpactData] = useState({});

            // Calculations
            const currentYear = new Date().getFullYear();
            const futureYear = currentYear + 3;

            const marketSize = marketData.totalCustomers && marketData.avgSpending && marketData.purchasesPerYear
                ? marketData.totalCustomers * marketData.avgSpending * marketData.purchasesPerYear
                : 0;

            const profitPool = marketSize && marketData.grossMargin
                ? marketSize * (marketData.grossMargin / 100)
                : 0;

            const calculateScore = (impact, probability) => (2 * impact) + probability;

            const rankedForces = drivingForces
                .filter(f => f.name.trim())
                .map(f => ({
                    ...f,
                    score: calculateScore(f.impact, f.probability)
                }))
                .sort((a, b) => b.score - a.score);

            const topForces = rankedForces.slice(0, 7);

            // Future calculations
            const calculateFuture = () => {
                if (!marketSize) return { customers: 0, marketSize: 0, profitPool: 0, margin: 0, growth: 0 };
                let customerMultiplier = 1;
                let spendingMultiplier = 1;
                let purchasesMultiplier = 1;
                let marginChange = 0;
                topForces.forEach(force => {
                    const impact = impactData[force.id] || { customers: 0, spending: 0, purchases: 0, margin: 0 };
                    customerMultiplier *= (1 + impact.customers / 100);
                    spendingMultiplier *= (1 + impact.spending / 100);
                    purchasesMultiplier *= (1 + impact.purchases / 100);
                    marginChange += impact.margin;
                });
                const futureCustomers = Math.round(marketData.totalCustomers * customerMultiplier);
                const futureMarketSize = marketSize * customerMultiplier * spendingMultiplier * purchasesMultiplier;
                const futureMargin = parseFloat(marketData.grossMargin) + marginChange;
                const futureProfitPool = futureMarketSize * (futureMargin / 100);
                return {
                    customers: futureCustomers,
                    marketSize: futureMarketSize,
                    profitPool: futureProfitPool,
                    margin: futureMargin,
                    growth: marketSize > 0 ? ((futureMarketSize - marketSize) / marketSize) * 100 : 0
                };
            };

            const future = calculateFuture();

            // AI-gated step navigation
            const handleNext = async (fromStep, transitionStep) => {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) { setStep(transitionStep); return; }
                setAiReviewing(true);
                try {
                    let stepAnswers = {};
                    let stepName = '';
                    if (fromStep === 1) {
                        stepName = 'Market Size';
                        stepAnswers = { tam: { totalCustomers: marketData.totalCustomers, avgSpending: marketData.avgSpending, purchasesPerYear: marketData.purchasesPerYear, grossMargin: marketData.grossMargin, marketSize: marketSize, profitPool: profitPool } };
                    } else if (fromStep === 2) {
                        stepName = 'Driving Forces';
                        stepAnswers = { driving_forces: drivingForces.filter(f => f.name.trim()).map(f => ({ name: f.name, impact: f.impact, probability: f.probability, score: (2 * f.impact) + f.probability })) };
                    }
                    const canProceed = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, stepAnswers, stepName);
                    if (canProceed) setStep(transitionStep);
                } catch (err) {
                    console.warn('[AIChallenge] Error, allowing passage:', err);
                    setStep(transitionStep);
                } finally {
                    setAiReviewing(false);
                }
            };

            useEffect(() => {
                async function loadDeps() {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                    try {
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[' + CONFIG.TOOL_SLUG + '] Failed to load dependencies:', err);
                    }
                }
                loadDeps();
            }, []);

            // Auto-save functionality (no email required)
            useEffect(() => {
                if (step > 0) {
                    const autoSaveData = { lastSaved: new Date().toISOString(), currentStep: step, marketData, drivingForces, impactData };
                    localStorage.setItem('marketSizeTool_autosave', JSON.stringify(autoSaveData));
                }
            }, [marketData, drivingForces, impactData, step]);

            // Load auto-save on mount
            useEffect(() => {
                const savedData = localStorage.getItem('marketSizeTool_autosave');
                if (savedData && !marketData.totalCustomers) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed.marketData && confirm('Would you like to restore your previous session?')) {
                            setMarketData(parsed.marketData || marketData);
                            setDrivingForces(parsed.drivingForces || drivingForces);
                            setImpactData(parsed.impactData || {});
                            setStep(parsed.currentStep || 0);
                        }
                    } catch (e) {
                        console.error('Failed to restore session:', e);
                    }
                }
            }, []);

            // Validation
            const canProceedStep1Phase1 = marketData.totalCustomers > 0 && marketData.avgSpending > 0 && marketData.purchasesPerYear > 0;
            const canProceedStep1 = canProceedStep1Phase1 && marketData.grossMargin > 0 && marketData.grossMargin <= 100;
            const canProceedStep2 = rankedForces.length >= 3;

            /* ============================================================
               RENDER
               ============================================================ */
            return (
                <div className="tool-frame">
                    <div className="tool-inner">

                        {/* Step 0: Cover */}
                        {step === 0 && (
                            <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                                <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url("https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=1920&q=80")', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.4 }} />
                                <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                                    <div className="monument" style={{ fontSize: 14, color: '#FFF469', letterSpacing: '0.15em', marginBottom: 24 }}>TOOL 12</div>
                                    <h1 className="plaak" style={{ fontSize: 80, marginBottom: 16, textTransform: 'uppercase' }}>MARKET SIZE</h1>
                                    <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48 }}>Calculate your Total Addressable Market and 3-year forecast</p>
                                    <button onClick={() => setStep(0.5)}
                                        style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease', minHeight: 44 }}
                                        onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                        onMouseOut={e => { e.target.style.background = '#fff'; }}
                                    >START</button>
                                </div>
                            </div>
                        )}

                        {/* Step 0.5: Intro */}
                        {step === 0.5 && (
                            <div style={{ minHeight: '100vh', background: '#000', color: '#fff', padding: '64px 32px' }}>
                                <div style={{ maxWidth: 640, margin: '0 auto' }} className="animate-in">
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 32, textTransform: 'uppercase' }}>BEFORE WE START</h1>

                                    <div style={{ marginBottom: 32 }}>
                                        <h2 className="plaak" style={{ fontSize: 28, marginBottom: 16, textTransform: 'uppercase' }}>PURPOSE</h2>
                                        <p style={{ fontSize: 16, lineHeight: 1.6 }}>
                                            Calculate your Total Addressable Market and forecast changes over 3 years
                                            using your team's knowledge -- no expensive research needed.
                                        </p>
                                        <p style={{ fontSize: 14, color: '#999', marginTop: 8 }}>
                                            Use 60-70% accuracy with internal team knowledge instead of aiming for 100%.
                                        </p>
                                    </div>

                                    <div style={{ marginBottom: 32 }}>
                                        <h2 className="plaak" style={{ fontSize: 28, marginBottom: 16, textTransform: 'uppercase', color: '#FFF469' }}>MISTAKES TO AVOID</h2>
                                        <ul style={{ fontSize: 16, lineHeight: 2 }}>
                                            <li>Missing top 3-5 high-impact forces</li>
                                            <li>Not understanding industry impact</li>
                                            <li>Aiming for 100% accuracy (60-70% is the goal)</li>
                                            <li>Underestimating technology speed</li>
                                            <li>Ignoring blind spots</li>
                                        </ul>
                                    </div>

                                    <div style={{ marginBottom: 48 }}>
                                        <h2 className="plaak" style={{ fontSize: 28, marginBottom: 16, textTransform: 'uppercase' }}>THE JOURNEY</h2>
                                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12 }}>
                                            {[
                                                { num: '01', label: 'MARKET SIZE', time: '2 min' },
                                                { num: '02', label: 'DRIVING FORCES', time: '5 min' },
                                                { num: '03', label: 'FUTURE IMPACT', time: '5 min' }
                                            ].map(s => (
                                                <div key={s.num} style={{ border: '2px solid #fff', padding: 16, textAlign: 'center' }}>
                                                    <div className="plaak" style={{ fontSize: 32, marginBottom: 8 }}>{s.num}</div>
                                                    <div style={{ fontSize: 13, fontWeight: 'bold', marginBottom: 4 }}>{s.label}</div>
                                                    <div style={{ fontSize: 12, color: '#999' }}>{s.time}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <button
                                        onClick={() => setStep(1)}
                                        style={{ width: '100%', background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease', minHeight: 44 }}
                                        onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                        onMouseOut={e => { e.target.style.background = '#fff'; }}
                                    >LET'S START</button>
                                </div>
                            </div>
                        )}

                        {/* Steps 1-3: Wizard Layout */}
                        {[1,2,3].includes(step) && (
                            <div className="wizard-layout">
                                <div className="wizard-main">
                                    <MobileStepBar currentStep={step} totalSteps={3} />

                                    <div className={step === 3 ? "wizard-content-wide animate-in" : "wizard-content animate-in"}>
                                        {step === 1 && <><DependencyContext deps={deps} /><Step1Content marketData={marketData} setMarketData={setMarketData} marketSize={marketSize} profitPool={profitPool} currentYear={currentYear} phase={step1Phase} setPhase={setStep1Phase} canProceedPhase1={canProceedStep1Phase1} canProceed={canProceedStep1} /></>}
                                        {step === 2 && <Step2Content drivingForces={drivingForces} setDrivingForces={setDrivingForces} rankedForces={rankedForces} topForces={topForces} phase={step2Phase} setPhase={setStep2Phase} canProceed={canProceedStep2} />}
                                        {step === 3 && <Step3Content topForces={topForces} impactData={impactData} setImpactData={setImpactData} marketData={marketData} marketSize={marketSize} profitPool={profitPool} future={future} currentYear={currentYear} futureYear={futureYear} drivingForces={drivingForces} />}
                                    </div>

                                    <ButtonFooter
                                        onBack={() => {
                                            if (step === 1) setStep(0.5);
                                            else if (step === 2) { setStep(1); setStep1Phase(4); }
                                            else if (step === 3) { setStep(2); setStep2Phase('rank'); }
                                        }}
                                        onNext={() => {
                                            if (step === 1) {
                                                if (step1Phase < 4) {
                                                    if (step1Phase === 1 && canProceedStep1Phase1) setStep1Phase(2);
                                                    else if (step1Phase === 2) setStep1Phase(3);
                                                    else if (step1Phase === 3 && canProceedStep1) setStep1Phase(4);
                                                } else {
                                                    handleNext(1, 1.5);
                                                }
                                            } else if (step === 2) {
                                                if (step2Phase === 'list' && canProceedStep2) setStep2Phase('score');
                                                else if (step2Phase === 'score') setStep2Phase('rank');
                                                else if (step2Phase === 'rank') handleNext(2, 2.5);
                                            } else if (step === 3) {
                                                // Submit handled inline
                                            }
                                        }}
                                        disabled={aiReviewing || (step === 1 && step1Phase === 1 && !canProceedStep1Phase1) || (step === 1 && step1Phase === 3 && !canProceedStep1) || (step === 2 && step2Phase === 'list' && !canProceedStep2)}
                                        nextLabel={
                                            aiReviewing ? 'AI Coach Reviewing...' :
                                            step === 1 && step1Phase < 4 ? (step1Phase === 1 ? 'Calculate Market Size' : step1Phase === 2 ? 'Continue to Profit Pool' : 'Calculate Profit Pool') :
                                            step === 1 && step1Phase === 4 ? 'Next: Driving Forces' :
                                            step === 2 && step2Phase === 'list' ? 'Continue to Scoring' :
                                            step === 2 && step2Phase === 'score' ? 'Show Rankings' :
                                            step === 2 && step2Phase === 'rank' ? 'Next: Impact Analysis' :
                                            step === 3 ? 'Save & Submit' : 'Next'
                                        }
                                        showBack={true}
                                        extraButtons={step === 3 ? (
                                            <button className="btn-back" onClick={() => window.print()}>Print</button>
                                        ) : null}
                                    />
                                </div>
                                <WizardSidebar currentStep={step} marketSize={marketSize} profitPool={profitPool} rankedForces={rankedForces} onNavigate={(s) => { setStep(s); if (s === 1) setStep1Phase(4); if (s === 2) setStep2Phase('rank'); }} />
                            </div>
                        )}

                        {/* Transition Screens */}
                        {[1.5, 2.5].includes(step) && (() => {
                            const completedStep = Math.floor(step);
                            const nextStep = completedStep + 1;
                            const t = TRANSITION_CONTENT[completedStep];

                            // Custom content for step 1.5 (shows market numbers)
                            if (completedStep === 1) {
                                return (
                                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                        <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                            <div className="monument" style={{ fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>
                                                STEP 1 OF 3 COMPLETE
                                            </div>
                                            <h1 className="plaak" style={{ fontSize: 48, marginBottom: 24 }}>{t.title}</h1>

                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 32 }}>
                                                <div style={{ border: '2px solid #fff', padding: 20 }}>
                                                    <div style={{ fontSize: 14, color: '#999', marginBottom: 8 }}>Market Size</div>
                                                    <div className="plaak" style={{ fontSize: 28 }}>{formatCurrency(marketSize)}</div>
                                                </div>
                                                <div style={{ border: '2px solid #fff', padding: 20 }}>
                                                    <div style={{ fontSize: 14, color: '#999', marginBottom: 8 }}>Profit Pool</div>
                                                    <div className="plaak" style={{ fontSize: 28 }}>{formatCurrency(profitPool)}</div>
                                                </div>
                                            </div>

                                            <p style={{ fontSize: 16, color: '#ccc', marginBottom: 32 }}>{t.text}</p>

                                            <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                                <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                                <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>{t.brutalTruth}</p>
                                            </div>

                                            <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                                <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                                <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                                            </div>

                                            <button
                                                onClick={() => setStep(nextStep)}
                                                style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }}
                                                onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                                onMouseOut={e => { e.target.style.background = '#fff'; }}
                                            >CONTINUE TO STEP {nextStep}</button>
                                        </div>
                                    </div>
                                );
                            }

                            // Standard transition for step 2.5
                            return (
                                <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                    <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                        <div className="monument" style={{ fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>
                                            STEP {completedStep} OF 3 COMPLETE
                                        </div>
                                        <h1 className="plaak" style={{ fontSize: 48, marginBottom: 12 }}>{t.title}</h1>
                                        <p style={{ fontSize: 16, color: '#ccc', marginBottom: 48 }}>{t.text}</p>

                                        <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                            <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                            <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>{t.brutalTruth}</p>
                                        </div>

                                        <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                            <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                            <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                                        </div>

                                        <button
                                            onClick={() => setStep(nextStep)}
                                            style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }}
                                            onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                            onMouseOut={e => { e.target.style.background = '#fff'; }}
                                        >CONTINUE TO STEP {nextStep}</button>
                                    </div>
                                </div>
                            );
                        })()}

                    </div>
                </div>
            );
        }

        /* ============================================================
           STEP 1: MARKET SIZE
           ============================================================ */
        function Step1Content({ marketData, setMarketData, marketSize, profitPool, currentYear, phase, setPhase, canProceedPhase1, canProceed }) {
            return (
                <div>
                    <div className="step-indicator">
                        <span>STEP 01 OF 03</span>
                        <span className="step-time">~2 min</span>
                    </div>
                    <h2 className="step-heading">MARKET SIZE</h2>
                    <p className="step-hint">Calculate your Total Addressable Market and Profit Pool using simple multiplication.</p>



                    {phase >= 2 && (
                        <div className="ft-reveal">
                            <div className="ft-reveal-label">FAST TRACK INSIGHT</div>
                            <p className="ft-reveal-text">Research by Gadiesh and Gilbert in the Harvard Business Review found that companies mapping their industry's profit pool -- segmenting by profitability rather than just revenue size -- consistently identified high-margin opportunities invisible to competitors. Porter's Five Forces framework further demonstrates that analyzing market structure before setting strategy improves positioning decisions. Studies show that teams using structured estimation frameworks make resource allocation decisions 30-40% faster (McKinsey Quarterly, 2021).</p>
                        </div>
                    )}

                    {/* Phase 1: Inputs */}
                    {phase === 1 && (
                        <div>
                            <div className="ft-field-group">
                                <label className="ft-label">TOTAL NUMBER OF CUSTOMERS</label>
                                <input type="number" className="ft-input" placeholder="e.g., 10000" value={marketData.totalCustomers} onChange={(e) => setMarketData({...marketData, totalCustomers: parseFloat(e.target.value) || ''})} />
                                <div className="ft-help">All potential buyers in your market</div>
                            </div>

                            <div className="ft-field-group">
                                <label className="ft-label">AVERAGE SPENDING PER CUSTOMER</label>
                                <input type="number" className="ft-input" placeholder="e.g., 35000" value={marketData.avgSpending} onChange={(e) => setMarketData({...marketData, avgSpending: parseFloat(e.target.value) || ''})} />
                                <div className="ft-help">Average price per product/service</div>
                            </div>

                            <div className="ft-field-group">
                                <label className="ft-label">AVERAGE PURCHASES PER YEAR</label>
                                <input type="number" className="ft-input" placeholder="e.g., 1" value={marketData.purchasesPerYear} onChange={(e) => setMarketData({...marketData, purchasesPerYear: parseFloat(e.target.value) || ''})} />
                                <div className="ft-help">Purchase frequency per customer per year</div>
                            </div>
                        </div>
                    )}

                    {/* Phase 2: Market Size Result */}
                    {phase === 2 && (
                        <div style={{ background: '#000', color: '#fff', border: '4px solid #000', padding: 48, textAlign: 'center', marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, color: '#FFF469', marginBottom: 16, letterSpacing: '0.1em' }}>MARKET SIZE CALCULATED</div>
                            <div style={{ fontSize: '64px', fontWeight: '900', fontFamily: "'Plaak', sans-serif", textAlign: 'center', lineHeight: 1 }}>{formatCurrency(marketSize)}</div>
                            <div style={{ fontSize: 14, color: '#999', marginTop: 12 }}>{currentYear}</div>
                        </div>
                    )}

                    {/* Phase 3: Margin Input */}
                    {phase === 3 && (
                        <div>
                            <div style={{ background: '#000', color: '#fff', padding: 20, marginBottom: 24 }}>
                                <div style={{ fontSize: 14, color: '#999' }}>Market Size: <span className="plaak" style={{ color: '#fff' }}>{formatCurrency(marketSize)}</span></div>
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">GROSS PROFIT MARGIN (%)</label>
                                <input type="number" className="ft-input" placeholder="e.g., 15" value={marketData.grossMargin} onChange={(e) => setMarketData({...marketData, grossMargin: parseFloat(e.target.value) || ''})} />
                                <div className="ft-help">Your company's gross margin (0-100)</div>
                            </div>
                        </div>
                    )}

                    {/* Phase 4: Complete Results */}
                    {phase === 4 && (
                        <div style={{ marginBottom: 24 }}>
                            <div style={{ background: '#000', color: '#fff', border: '4px solid #000', padding: 48, textAlign: 'center', marginBottom: 16 }}>
                                <div className="monument" style={{ fontSize: 11, color: '#FFF469', marginBottom: 12, letterSpacing: '0.1em' }}>MARKET SIZE</div>
                                <div style={{ fontSize: '64px', fontWeight: '900', fontFamily: "'Plaak', sans-serif", textAlign: 'center', lineHeight: 1 }}>{formatCurrency(marketSize)}</div>
                                <div style={{ fontSize: 13, color: '#999', marginTop: 10 }}>{currentYear}</div>
                            </div>
                            <div style={{ background: '#111', color: '#fff', border: '4px solid #FFF469', padding: 48, textAlign: 'center' }}>
                                <div className="monument" style={{ fontSize: 11, color: '#FFF469', marginBottom: 12, letterSpacing: '0.1em' }}>PROFIT POOL</div>
                                <div style={{ fontSize: '64px', fontWeight: '900', fontFamily: "'Plaak', sans-serif", textAlign: 'center', lineHeight: 1 }}>{formatCurrency(profitPool)}</div>
                                <div style={{ fontSize: 13, color: '#999', marginTop: 10 }}>{currentYear}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        /* ============================================================
           STEP 2: DRIVING FORCES
           ============================================================ */
        function Step2Content({ drivingForces, setDrivingForces, rankedForces, topForces, phase, setPhase, canProceed }) {
            const addForce = () => {
                const newId = Math.max(...drivingForces.map(f => f.id), 0) + 1;
                setDrivingForces([...drivingForces, { id: newId, name: '', impact: 3, probability: 3 }]);
            };
            const updateForce = (id, field, value) => {
                setDrivingForces(drivingForces.map(f => f.id === id ? { ...f, [field]: value } : f));
            };
            const removeForce = (id) => {
                if (drivingForces.length > 3) setDrivingForces(drivingForces.filter(f => f.id !== id));
            };
            const calculateScore = (impact, probability) => (2 * impact) + probability;

            return (
                <div>
                    <div className="step-indicator">
                        <span>STEP 02 OF 03</span>
                        <span className="step-time">~5 min</span>
                    </div>
                    <h2 className="step-heading">DRIVING FORCES</h2>
                    <p className="step-hint">Identify and rank the forces that will change your market over the next 3 years.</p>



                    {(drivingForces[0] && (drivingForces[0].name || '').length >= 20) && (
                        <div className="ft-reveal">
                            <div className="ft-reveal-label">FAST TRACK INSIGHT</div>
                            <p className="ft-reveal-text">Senge's systems thinking research (The Fifth Discipline, 1990) demonstrates that teams addressing forces holistically make significantly better strategic predictions. Cross-functional brainstorming reduces blind spots by up to 40% (MIT Sloan Management Review, 2020). The weighted scoring method (2x Impact + Probability) is derived from scenario planning frameworks validated across 150+ Fortune 500 strategy exercises.</p>
                        </div>
                    )}

                    {/* LIST Phase */}
                    {phase === 'list' && (
                        <div>
                            {drivingForces.map((force, index) => (
                                <div key={force.id} style={{ display: 'flex', gap: 12, alignItems: 'center', marginBottom: 12 }}>
                                    <div style={{ width: 36, height: 36, background: '#000', color: '#fff', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 'bold', fontSize: 14, flexShrink: 0 }}>
                                        {index + 1}
                                    </div>
                                    <input type="text" className="ft-input" style={{ flex: 1 }} placeholder="e.g., AI automation, new regulations, market consolidation..." value={force.name} onChange={(e) => updateForce(force.id, 'name', e.target.value)} />
                                    {drivingForces.length > 3 && (
                                        <button onClick={() => removeForce(force.id)} style={{ background: 'none', border: 'none', cursor: 'pointer', fontSize: 24, color: '#999' }}>x</button>
                                    )}
                                </div>
                            ))}
                            <button className="add-btn" onClick={addForce} style={{ marginTop: 8 }}>+ Add Force</button>
                        </div>
                    )}

                    {/* SCORE Phase */}
                    {phase === 'score' && (
                        <div>
                            {drivingForces.map((force, index) => (
                                <div key={force.id} className="force-row" style={{ padding: 16, marginBottom: 12, borderRadius: 4 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                                        <div style={{ width: 36, height: 36, background: '#000', color: '#fff', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 'bold', fontSize: 14, flexShrink: 0 }}>
                                            {index + 1}
                                        </div>
                                        <div style={{ flex: 1, fontWeight: 600 }}>{force.name}</div>
                                        {force.name && (
                                            <div style={{ textAlign: 'right' }}>
                                                <span style={{ fontSize: 13, color: '#6B7280' }}>Score: </span>
                                                <span className="plaak" style={{ fontSize: 20 }}>{calculateScore(force.impact, force.probability)}</span>
                                            </div>
                                        )}
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                        <div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                                                <span style={{ fontWeight: 600, fontSize: 14 }}>Impact: {force.impact}</span>
                                                <span style={{ fontSize: 12, color: '#6B7280' }}>1 (Low) - 5 (High)</span>
                                            </div>
                                            <input type="range" min="1" max="5" className="slider" value={force.impact} onChange={(e) => updateForce(force.id, 'impact', parseInt(e.target.value))} />
                                        </div>
                                        <div>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                                                <span style={{ fontWeight: 600, fontSize: 14 }}>Likelihood: {force.probability}</span>
                                                <span style={{ fontSize: 12, color: '#6B7280' }}>1 (Low) - 5 (High)</span>
                                            </div>
                                            <input type="range" min="1" max="5" className="slider" value={force.probability} onChange={(e) => updateForce(force.id, 'probability', parseInt(e.target.value))} />
                                        </div>
                                    </div>
                                </div>
                            ))}
                            <button className="add-btn" onClick={addForce} style={{ marginTop: 8 }}>+ Add Force</button>
                        </div>
                    )}

                    {/* RANK Phase */}
                    {phase === 'rank' && (
                        <div>
                            {rankedForces.slice(0, 7).map((force, index) => (
                                <div key={force.id} style={{ padding: 20, border: '2px solid #000', marginBottom: 12, display: 'flex', alignItems: 'center', gap: 16 }}>
                                    <div style={{ width: 48, height: 48, background: '#000', color: '#fff', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 18, fontWeight: 'bold', flexShrink: 0 }}>
                                        #{index + 1}
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div className="plaak" style={{ fontSize: 20, marginBottom: 4 }}>{force.name}</div>
                                        <div style={{ fontSize: 14, color: '#6B7280' }}>
                                            Impact: <strong>{force.impact}</strong> | Likelihood: <strong>{force.probability}</strong> | Score: <strong>{force.score}</strong>
                                        </div>
                                    </div>
                                    <div style={{ background: '#000', color: '#FFF469', padding: '6px 12px', fontSize: 12, fontWeight: 'bold', fontFamily: "'Monument', monospace" }}>TOP FORCE</div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        /* ============================================================
           STEP 3: FUTURE IMPACT
           ============================================================ */
        function Step3Content({ topForces, impactData, setImpactData, marketData, marketSize, profitPool, future, currentYear, futureYear, drivingForces }) {
            const updateImpact = (forceId, field, value) => {
                setImpactData({
                    ...impactData,
                    [forceId]: {
                        ...(impactData[forceId] || { customers: 0, spending: 0, purchases: 0, margin: 0 }),
                        [field]: parseFloat(value) || 0
                    }
                });
            };
            const getTotalChange = (field) => {
                return topForces.reduce((sum, force) => {
                    const impact = impactData[force.id];
                    return sum + (impact ? impact[field] : 0);
                }, 0);
            };

            const handleSubmitToSupabase = async () => {
                const submissionData = {
                    completedAt: new Date().toISOString(),
                    marketData: { totalCustomers: marketData.totalCustomers, avgSpending: marketData.avgSpending, purchasesPerYear: marketData.purchasesPerYear, grossMargin: marketData.grossMargin, marketSize, profitPool },
                    drivingForces: drivingForces.filter(f => f.name.trim()).map(f => ({ name: f.name, impact: f.impact, probability: f.probability, score: (2 * f.impact) + f.probability })),
                    topForces: topForces.map(f => ({ name: f.name, impact: f.impact, probability: f.probability, score: f.score })),
                    impactAnalysis: impactData,
                    forecast: { currentYear, futureYear, currentMarketSize: marketSize, currentProfitPool: profitPool, futureMarketSize: future.marketSize, futureProfitPool: future.profitPool, futureCustomers: future.customers, futureMargin: future.margin, growthPercentage: future.growth }
                };
                const result = await submitToSupabase(submissionData);
                if (result.success) { alert('Submission saved successfully!'); }
                else if (!result.revised) { alert('Submission failed. Please try again.'); }
                return result.success;
            };

            return (
                <div>
                    <div className="step-indicator">
                        <span>STEP 03 OF 03</span>
                        <span className="step-time">~5 min</span>
                    </div>
                    <h2 className="step-heading">FUTURE IMPACT</h2>
                    <p className="step-hint">Estimate how each driving force will change your market variables over the next 3 years.</p>



                    {(topForces.length > 0 && (topForces[0].name || '').length >= 20) && (
                        <div className="ft-reveal">
                            <div className="ft-reveal-label">FAST TRACK INSIGHT</div>
                            <p className="ft-reveal-text">Research on strategic forecasting shows that teams using structured impact estimation -- breaking future change into component variables (customers, spending, frequency, margin) -- produce forecasts 2-3x more accurate than single-number guesses (Tetlock, Superforecasting, 2015).</p>
                        </div>
                    )}

                    {/* Side by side: Matrix + Forecast */}
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 32, marginBottom: 32 }}>
                        {/* LEFT: Impact Matrix */}
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ width: '100%', borderCollapse: 'collapse', border: '2px solid #000' }}>
                                <thead>
                                    <tr style={{ background: '#000', color: '#fff' }}>
                                        <th style={{ padding: '14px 16px', textAlign: 'left', fontSize: 13 }}>Variable</th>
                                        {topForces.map((force, idx) => (
                                            <th key={force.id} style={{ padding: '14px 8px', textAlign: 'center', fontSize: 11 }}>
                                                <div style={{ fontWeight: 'bold' }}>#{idx + 1}</div>
                                                <div style={{ fontWeight: 'normal', opacity: 0.8 }}>{force.name.slice(0, 12)}{force.name.length > 12 ? '..' : ''}</div>
                                            </th>
                                        ))}
                                        <th style={{ padding: '14px 16px', textAlign: 'center', fontSize: 13, background: '#333' }}>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {['customers', 'spending', 'purchases', 'margin'].map(field => (
                                        <tr key={field} style={{ borderTop: '1px solid #E5E7EB' }}>
                                            <td style={{ padding: '16px 16px', fontWeight: 600, background: '#F9FAFB', fontSize: 14, textTransform: 'capitalize' }}>{field}</td>
                                            {topForces.map(force => (
                                                <td key={force.id} style={{ padding: '12px 6px', textAlign: 'center' }}>
                                                    <input type="number" className="ft-input-sm" placeholder="0" value={impactData[force.id]?.[field] || ''} onChange={(e) => updateImpact(force.id, field, e.target.value)} style={{ width: 72, height: 44 }} />
                                                    <div style={{ fontSize: 10, color: '#9CA3AF', marginTop: 4 }}>{field === 'margin' ? 'pts' : '%'}</div>
                                                </td>
                                            ))}
                                            <td style={{ padding: '16px 16px', textAlign: 'center', fontWeight: 'bold', background: '#F3F4F6' }}>
                                                <span className="plaak" style={{ fontSize: 18 }}>{getTotalChange(field).toFixed(1)}{field === 'margin' ? ' pts' : '%'}</span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* RIGHT: Live 3-Year Forecast */}
                        <div style={{ background: '#000', color: '#fff', padding: 32, border: '4px solid #000' }}>
                            <h2 className="plaak" style={{ fontSize: 24, marginBottom: 32, textAlign: 'center' }}>3-YEAR FORECAST</h2>

                            <div style={{ textAlign: 'center', marginBottom: 28, paddingBottom: 28, borderBottom: '1px solid #333' }}>
                                <div style={{ color: '#999', fontSize: 13, marginBottom: 10, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase' }}>{currentYear} — NOW</div>
                                <div className="plaak" style={{ fontSize: 36, fontWeight: 900, marginBottom: 6, lineHeight: 1 }}>{formatCurrency(marketSize)}</div>
                                <div style={{ fontSize: 12, color: '#999', marginBottom: 12 }}>Current Market Size</div>
                                <div style={{ fontSize: 14, color: '#666' }}>
                                    Profit Pool: <span className="plaak" style={{ color: '#fff', fontSize: 18 }}>{formatCurrency(profitPool)}</span>
                                </div>
                            </div>

                            <div style={{ textAlign: 'center' }}>
                                <div style={{ color: '#FFF469', fontSize: 13, marginBottom: 10, fontFamily: "'Monument', monospace", letterSpacing: '0.05em', textTransform: 'uppercase' }}>{futureYear} — FORECAST</div>
                                <div className="plaak" style={{ fontSize: 40, fontWeight: 900, marginBottom: 6, lineHeight: 1, color: '#FFF469' }}>{formatCurrency(future.marketSize)}</div>
                                <div style={{ fontSize: 12, color: '#FFF469', marginBottom: 12 }}>Future Market Size</div>
                                <div className="plaak" style={{ fontSize: 22, fontWeight: 900, marginBottom: 12 }}>
                                    {future.growth >= 0 ? '+' : ''}{future.growth.toFixed(1)}% GROWTH
                                </div>
                                <div style={{ fontSize: 14, color: '#666' }}>
                                    Profit Pool: <span className="plaak" style={{ color: '#fff', fontSize: 18 }}>{formatCurrency(future.profitPool)}</span>
                                </div>
                            </div>

                            <div style={{ borderTop: '1px solid #333', marginTop: 24, paddingTop: 20 }}>
                                <div className="monument" style={{ fontSize: 10, color: '#FFF469', textAlign: 'center', marginBottom: 16 }}>BREAKDOWN</div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, textAlign: 'center', fontSize: 13 }}>
                                    <div>
                                        <div style={{ color: '#999', fontSize: 11, marginBottom: 4 }}>Customers</div>
                                        <div style={{ fontWeight: 600 }}>{marketData.totalCustomers?.toLocaleString()} &rarr; {future.customers?.toLocaleString()}</div>
                                    </div>
                                    <div>
                                        <div style={{ color: '#999', fontSize: 11, marginBottom: 4 }}>Margin</div>
                                        <div style={{ fontWeight: 600 }}>{marketData.grossMargin}% &rarr; {future.margin?.toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Submit button */}
                    <div style={{ textAlign: 'center', marginTop: 16 }}>
                        <button className="btn-next" style={{ padding: '16px 48px', fontSize: 16 }} onClick={handleSubmitToSupabase}>
                            Save & Submit Answers
                        </button>
                    </div>

                    {/* Case Study */}
                    <div style={{ marginTop: 32 }}>
                        <CaseStudy
                            before={"A European food company estimated their market at 500M+ consumers based on total population. They pursued an aggressive expansion across six countries simultaneously, spreading resources thin with no prioritization framework."}
                            after={"After applying TAM-SAM-SOM analysis, they discovered their realistic serviceable market was only 12% of total population. They refocused on two high-margin segments in three countries, doubling revenue within 18 months while cutting expansion costs by 60%."}
                            quote={"We thought bigger meant better. The market sizing discipline showed us that a focused 12% of the right customers was worth more than chasing 100% of the wrong ones. - Fast Track Alumni, FMCG Sector"}
                        />
                    </div>
                </div>
            );
        }

        // Render App
        ReactDOM.render(<MarketSizeTool />, document.getElementById('root'));
    </script>
</body>
</html>
