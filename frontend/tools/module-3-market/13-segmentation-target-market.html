<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Segmentation & Target Market | Fast Track Program</title>

  <!-- React & ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../shared/js/tool-db.js"></script>
  <script src="../../shared/js/ai-challenge.js"></script>
  <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

  <!-- jsPDF + html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Transition Screen -->
  <script src="../../shared/js/transition-screen.js"></script>

  <style>
    /* Font Face Declarations */
    @font-face {
      font-family: 'Plaak';
      src: url('Plaak3Trial-43-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
    }

    @font-face {
      font-family: 'Riforma';
      src: url('RiformaLL-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    @font-face {
      font-family: 'Monument';
      src: url('MonumentGrotesk-Mono.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }

    /* Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Riforma', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .plaak {
      font-family: 'Plaak', sans-serif;
      text-transform: uppercase;
      font-weight: bold;
      letter-spacing: -0.02em;
    }

    .riforma-bold {
      font-family: 'Riforma', sans-serif;
      font-weight: bold;
    }

    .monument {
      font-family: 'Monument', monospace;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Animations */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    .transition-animate-in {
      animation: slideIn 0.6s ease-out;
    }

    /* Button Styles */
    .btn-primary {
      background: #000000;
      color: #FFFFFF;
      padding: 16px 32px;
      border: 2px solid #000000;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: normal;
    }

    .btn-primary:hover:not(:disabled) {
      transform: scale(1.02);
    }

    .btn-primary:disabled {
      background: #E0E0E0;
      border-color: #E0E0E0;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #FFFFFF;
      color: #000000;
      padding: 12px 24px;
      border: 2px solid #000000;
      font-size: 16px;
      font-family: 'Riforma', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #F8F8F8;
    }

    /* Form Styles */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      border: 1px solid #E0E0E0;
      padding: 12px 16px;
      font-size: 18px;
      font-family: 'Riforma', sans-serif;
      width: 100%;
      transition: border-color 0.2s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: #000000;
    }

    textarea {
      min-height: 120px;
      resize: none !important;
    }

    textarea::placeholder {
      white-space: pre-line;
    }

    /* Numbered Section Badge */
    .numbered-section {
      background: #000000;
      color: #FFFFFF;
      padding: 10px 16px;
      font-family: 'Plaak', sans-serif;
      font-size: 26px;
      display: inline-block;
      text-transform: uppercase;
      letter-spacing: -0.02em;
    }

    /* Progress Indicator */
    .progress-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #E0E0E0;
      transition: all 0.3s ease;
    }

    .progress-dot.active {
      background: #000000;
      transform: scale(1.3);
    }

    .progress-dot.completed {
      background: #000000;
    }

    .progress-line {
      height: 2px;
      background: #E0E0E0;
      flex: 1;
    }

    /* Print Styles */
    @media print {
      .no-print {
        display: none !important;
      }
    }

    /* Character Counter */
    .char-counter {
      font-size: 14px;
      color: #666;
      margin-top: 4px;
    }

    .char-counter.invalid {
      color: #EF4444;
    }

    /* Wizard Layout */
    .wizard-layout { display: flex; min-height: 100vh; }
    .wizard-main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
    .wizard-content { flex: 1; padding: 48px 64px; max-width: 860px; }
    .wizard-footer { padding: 24px 64px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }
    .btn-wiz-back { background: transparent; border: 2px solid #d1d5db; color: #6b7280; padding: 14px 28px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s; }
    .btn-wiz-back:hover { border-color: #000; color: #000; }
    .btn-wiz-next { background: #000; color: #fff; border: 2px solid #000; padding: 14px 32px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; cursor: pointer; transition: all 0.2s; }
    .btn-wiz-next:hover:not(:disabled) { background: #222; }
    .btn-wiz-next:disabled { background: #e5e7eb; border-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Configuration
    const CONFIG = {
      SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
      TOOL_SLUG: 'segmentation-target-market',
      AUTOSAVE_DELAY: 2000,
      TRANSITION_CONTENT: {
        1: {
          brutalTruth: '"We serve everyone" is a strategy for going broke slowly. The most profitable companies in every sector serve a narrow slice of the market better than anyone else. Segment or stagnate.',
          peerProof: '"A €5M services firm stopped trying to serve all SMEs and focused exclusively on manufacturing companies with 50-250 employees. Average deal size increased 3x. Close rate went from 15% to 41% in 9 months."'
        },
        2: {
          brutalTruth: 'Demographic segmentation tells you who your customers are. Psychographic segmentation tells you why they buy. The companies that dominate segments win on the second dimension — they know their customers better than competitors do.',
          peerProof: '"A B2B SaaS company ran 12 customer interviews and discovered their buyers were not actually the CEOs they targeted — it was the ops managers who \'sold up.\' Repositioning their messaging to ops managers cut their sales cycle in half."'
        },
        3: {
          brutalTruth: 'Attractiveness scoring is not an academic exercise. It is the decision framework that tells you where to concentrate resources. The company that tries to win every segment wins none of them.',
          peerProof: '"A €20M distribution company scored 8 potential segments on 5 criteria. Two clear winners emerged — segments they had been treating as secondary. Refocusing sales effort on those two increased revenue 28% without adding headcount."'
        },
        4: {
          brutalTruth: 'A target market without a market share goal is a wish. A goal without a timeline is a fantasy. The companies that win are the ones who commit to specific numbers and hold themselves accountable to them.',
          peerProof: '"A €8M B2B software company set a concrete goal: 15% market share in a 200-company segment within 24 months. Breaking it to monthly new-customer targets made the goal feel real. They hit 18% in 20 months because every weekly standup started with the number."'
        }
      },
      CLOSING_MESSAGES: {
        1: { title: 'SEGMENTS MAPPED', text: 'Your market segments are defined. Next: score them against what matters most to your growth.' },
        2: { title: 'CRITERIA SET', text: 'Your scoring framework is built. Next: rank each segment to find your highest-value focus area.' },
        3: { title: 'TARGET LOCKED', text: 'Your primary segment is chosen. This is where your energy goes. Everything else is optional.' },
        4: { title: 'STRATEGY COMPLETE', text: 'Your target market is defined with concrete goals. This is your growth north star.' }
      }
    };

    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    // Make Supabase client globally available for dependency injection
    window.supabaseClient = supabaseClient;

    // Initialize ToolDB and dependency injection
    ToolDB.init(CONFIG.TOOL_SLUG);
    ToolAccessControl.init(CONFIG.TOOL_SLUG);

        // Initialize cognitive load components
        CognitiveLoad.init('segmentation', {"insights":["Trying to serve everyone means serving no one well.","The best segments are underserved, accessible, and profitable."],"caseStudy":{"before":"A mid-size telecom company marketed the same bundle to all customers. Churn was 22% annually, acquisition costs were rising, and marketing ROI was declining quarter over quarter because messages resonated with nobody in particular.","after":"After implementing behavior-based segmentation, they identified 3 high-value clusters: loyalty-driven subscribers, price-sensitive switchers, and tech-early-adopters. Tailored retention offers reduced churn to 14%, customer acquisition cost dropped 35%, and marketing ROI improved by 48% within 9 months.","quote":"Once we stopped trying to be everything to everyone, we became the obvious choice for the customers who actually mattered. Our NPS jumped 22 points in one quarter."}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

    function DependencyContext({ deps }) {
        if (!deps || deps.length === 0) return null;
        return (
            <div style={{ marginBottom: '24px' }}>
                <div style={{ fontFamily: "'Monument', monospace", fontSize: '11px', textTransform: 'uppercase', letterSpacing: '0.05em', color: '#666', marginBottom: '8px' }}>
                    CONTEXT FROM PREVIOUS TOOLS
                </div>
                {deps.map((dep, i) => (
                    <div key={i} style={{ background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '12px 16px', marginBottom: '8px', fontSize: '14px' }}>
                        <div style={{ fontWeight: 600, marginBottom: '4px', color: '#333' }}>{dep.label}</div>
                        <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                    </div>
                ))}
            </div>
        );
    }

    // Main App Component
    function SegmentationApp() {
      const [deps, setDeps] = useState([]);
      const [step, setStep] = useState(0); // 0=cover, 0.5=intro, 1-4=steps, 5=canvas
      const [aiReviewing, setAiReviewing] = useState(false);
      const [openAttractivenessIdx, setOpenAttractivenessIdx] = useState(0);
      const [openGoalIdx, setOpenGoalIdx] = useState(0);

      const [data, setData] = useState({
        // User details
        name: '',
        email: '',
        company: '',
        role: '',

        // Step 1: Define Segments
        customerBehaviors: '',
        segments: [
          { name: '', description: '', behaviors: '' }
        ],

        // Step 2: Quantify Segments
        segmentSizes: [
          { segment: '', totalMarket: '', accessibleMarket: '', avgRevenue: '', totalValue: '' }
        ],

        // Step 3: Attractiveness Index
        attractivenessCriteria: [
          { segment: '', size: '', growth: '', profitability: '', fit: '', total: '' }
        ],
        criteriaWeights: { size: '25', growth: '25', profitability: '30', fit: '20' },

        // Step 4: Target Market & Goals
        targetSegments: '',
        marketShareGoals: [
          { segment: '', currentShare: '', targetShare: '', timeline: '', strategy: '' }
        ],
        endGame: ''
      });

      useEffect(() => {
          async function loadDeps() {
              const userId = localStorage.getItem('ft_user_id');
              if (!userId || !window.ToolDB || !window.DependencyInjection) return;
              try {
                  await ToolDB.whenReady();
                  const config = DependencyInjection.getDependenciesConfig();
                  const toolConfig = config[CONFIG.TOOL_SLUG];
                  if (!toolConfig || !toolConfig.fields) return;
                  const loaded = [];
                  for (const field of toolConfig.fields) {
                      const val = await ToolDB.getDependency(userId, field.source_field);
                      if (val) {
                          loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                      }
                  }
                  setDeps(loaded);
              } catch (err) {
                  console.warn('[' + CONFIG.TOOL_SLUG + '] Failed to load dependencies:', err);
              }
          }
          loadDeps();
      }, []);

      // Auto-save to localStorage
      useEffect(() => {
        const interval = setInterval(() => {
          localStorage.setItem('segmentationData', JSON.stringify({
            data,
            timestamp: new Date().toISOString()
          }));
        }, 2000);

        return () => clearInterval(interval);
      }, [data]);

      // Load saved data on mount
      useEffect(() => {
        const saved = localStorage.getItem('segmentationData');
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            if (parsed.data) {
              setData(parsed.data);
            }
          } catch (e) {
            console.error('Failed to parse saved data');
          }
        }
      }, []);

      const updateData = (field, value) => {
        setData(prev => ({ ...prev, [field]: value }));
      };

      // Array management functions
      const addSegment = () => {
        setData(prev => ({
          ...prev,
          segments: [...prev.segments, { name: '', description: '', behaviors: '' }]
        }));
      };

      const removeSegment = (index) => {
        if (data.segments.length > 1) {
          setData(prev => ({
            ...prev,
            segments: prev.segments.filter((_, i) => i !== index)
          }));
        }
      };

      const updateSegment = (index, field, value) => {
        setData(prev => ({
          ...prev,
          segments: prev.segments.map((s, i) =>
            i === index ? { ...s, [field]: value } : s
          )
        }));
      };

      const addSegmentSize = () => {
        setData(prev => ({
          ...prev,
          segmentSizes: [...prev.segmentSizes, { segment: '', totalMarket: '', accessibleMarket: '', avgRevenue: '', totalValue: '' }]
        }));
      };

      const removeSegmentSize = (index) => {
        if (data.segmentSizes.length > 1) {
          setData(prev => ({
            ...prev,
            segmentSizes: prev.segmentSizes.filter((_, i) => i !== index)
          }));
        }
      };

      const updateSegmentSize = (index, field, value) => {
        setData(prev => ({
          ...prev,
          segmentSizes: prev.segmentSizes.map((s, i) => {
            if (i === index) {
              const updated = { ...s, [field]: value };
              // Auto-calculate total value
              if (field === 'accessibleMarket' || field === 'avgRevenue') {
                const accessible = parseFloat(updated.accessibleMarket) || 0;
                const avgRev = parseFloat(updated.avgRevenue) || 0;
                updated.totalValue = (accessible * avgRev).toFixed(0);
              }
              return updated;
            }
            return s;
          })
        }));
      };

      const addAttractiveness = () => {
        setData(prev => ({
          ...prev,
          attractivenessCriteria: [...prev.attractivenessCriteria, { segment: '', size: '', growth: '', profitability: '', fit: '', total: '' }]
        }));
      };

      const removeAttractiveness = (index) => {
        if (data.attractivenessCriteria.length > 1) {
          setData(prev => ({
            ...prev,
            attractivenessCriteria: prev.attractivenessCriteria.filter((_, i) => i !== index)
          }));
        }
      };

      const updateAttractiveness = (index, field, value) => {
        setData(prev => ({
          ...prev,
          attractivenessCriteria: prev.attractivenessCriteria.map((a, i) => {
            if (i === index) {
              const updated = { ...a, [field]: value };
              // Auto-calculate total score
              if (field !== 'segment' && field !== 'total') {
                const size = (parseFloat(updated.size) || 0) * (parseFloat(data.criteriaWeights.size) / 100);
                const growth = (parseFloat(updated.growth) || 0) * (parseFloat(data.criteriaWeights.growth) / 100);
                const profitability = (parseFloat(updated.profitability) || 0) * (parseFloat(data.criteriaWeights.profitability) / 100);
                const fit = (parseFloat(updated.fit) || 0) * (parseFloat(data.criteriaWeights.fit) / 100);
                updated.total = (size + growth + profitability + fit).toFixed(1);
              }
              return updated;
            }
            return a;
          })
        }));
      };

      const addMarketShareGoal = () => {
        setData(prev => ({
          ...prev,
          marketShareGoals: [...prev.marketShareGoals, { segment: '', currentShare: '', targetShare: '', timeline: '', strategy: '' }]
        }));
      };

      const removeMarketShareGoal = (index) => {
        if (data.marketShareGoals.length > 1) {
          setData(prev => ({
            ...prev,
            marketShareGoals: prev.marketShareGoals.filter((_, i) => i !== index)
          }));
        }
      };

      const updateMarketShareGoal = (index, field, value) => {
        setData(prev => ({
          ...prev,
          marketShareGoals: prev.marketShareGoals.map((g, i) =>
            i === index ? { ...g, [field]: value } : g
          )
        }));
      };

      const doTransition = (nextStep) => {
        setStep(step + 0.5);
      };

      const goNext = async () => {
        if (step === 0) { setStep(0.5); return; }
        if (step === 0.5) { setStep(1); return; }

        // AI-gated steps 1-4
        if (step >= 1 && step <= 4) {
          const userId = localStorage.getItem('ft_user_id');
          if (!userId) { alert('User not authenticated.'); return; }
          setAiReviewing(true);
          try {
            let stepAnswers = {};
            let stepName = '';
            if (step === 1) {
              stepName = 'Define Segments';
              stepAnswers = { segments_define: { customerBehaviors: data.customerBehaviors, segments: data.segments } };
            } else if (step === 2) {
              stepName = 'Quantify Segments';
              stepAnswers = { segments_quantify: { segmentSizes: data.segmentSizes } };
            } else if (step === 3) {
              stepName = 'Attractiveness Index';
              stepAnswers = { segments_rank: { attractivenessCriteria: data.attractivenessCriteria, criteriaWeights: data.criteriaWeights } };
            } else if (step === 4) {
              stepName = 'Target Market & Goals';
              stepAnswers = { primary_target: { targetSegments: data.targetSegments, marketShareGoals: data.marketShareGoals, endGame: data.endGame } };
            }
            const canProceed = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, stepAnswers, stepName);
            if (canProceed) {
              doTransition(step === 4 ? 5 : step + 1);
            }
          } catch (err) {
            console.warn('[AIChallenge] Error, allowing passage:', err);
            doTransition(step === 4 ? 5 : step + 1);
          } finally {
            setAiReviewing(false);
          }
          return;
        }
      };

      const goBack = () => {
        if (step === 5) {
          setStep(4);
        } else if (step > 1) {
          setStep(step - 1);
        } else if (step === 1) {
          setStep(0.5);
        }
      };

      // Validation functions
      const canProceedFromIntro = () => {
        return data.name.length > 0 && data.email.length > 0 && data.company.length > 0;
      };

      const canProceedFromStep1 = () => {
        return data.customerBehaviors.length >= 50 &&
               data.segments.every(s => s.name.length >= 3 && s.description.length >= 30);
      };

      const canProceedFromStep2 = () => {
        return data.segmentSizes.every(s =>
          s.segment.length >= 3 && s.totalMarket.length > 0 && s.accessibleMarket.length > 0
        );
      };

      const canProceedFromStep3 = () => {
        return data.attractivenessCriteria.every(a =>
          a.segment.length >= 3 && a.size.length > 0 && a.growth.length > 0
        );
      };

      const canProceedFromStep4 = () => {
        return data.targetSegments.length >= 30 &&
               data.marketShareGoals.every(g => g.segment.length >= 3 && g.targetShare.length > 0) &&
               data.endGame.length >= 50;
      };

      const exportPDF = async () => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        const canvas = document.getElementById('canvas-content');
        if (canvas) {
          const canvasImage = await html2canvas(canvas, {
            scale: 2,
            useCORS: true,
            logging: false
          });

          const imgData = canvasImage.toDataURL('image/png');
          const imgWidth = 190;
          const imgHeight = (canvasImage.height * imgWidth) / canvasImage.width;

          pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);

          const filename = `Segmentation-Target-Market-Canvas-${new Date().toISOString().split('T')[0]}.pdf`;
          pdf.save(filename);
        }
      };

      const [submitStatus, setSubmitStatus] = useState(null);
      const [submitMessage, setSubmitMessage] = useState('');

      const handleSubmit = async () => {
        try {
          const userId = localStorage.getItem('ft_user_id');
          if (!userId) {
            alert('User not authenticated. Please return to the dashboard.');
            return;
          }

          const questionMappings = {
              segments_list: { customerBehaviors: data.customerBehaviors, segments: data.segments, segmentSizes: data.segmentSizes, attractivenessCriteria: data.attractivenessCriteria, criteriaWeights: data.criteriaWeights },
              primary_target: { targetSegments: data.targetSegments, marketShareGoals: data.marketShareGoals, endGame: data.endGame }
          };

          await ToolDB.saveResponses(userId, CONFIG.TOOL_SLUG, questionMappings);
          setSubmitStatus('success');
          setSubmitMessage('Submission saved successfully!');
          alert('Segmentation & Target Market plan submitted successfully!');
        } catch (error) {
          console.error('Submit error:', error);
          alert('Submission failed: ' + error.message + '\n\nYour data is still saved locally. Please try again or contact support.');
        }
      };

      // Render different pages based on step
      if ([1.5, 2.5, 3.5, 4.5].includes(step)) {
        return window.renderTransitionScreen(step, CONFIG, 4, setStep);
      }

      if (step === 0) {
        return <CoverPage onStart={goNext} />;
      }

      if (step === 0.5) {
        return <IntroPage data={data} updateData={updateData} onNext={goNext} canProceed={canProceedFromIntro()} />;
      }

      // Steps 1-4: Wizard layout
      if (step >= 1 && step <= 4) {
        const stepLabels = ['Define Segments', 'Quantify Segments', 'Rank Segments', 'Target Market'];
        const isValid = step === 1 ? canProceedFromStep1() : step === 2 ? canProceedFromStep2() : step === 3 ? canProceedFromStep3() : canProceedFromStep4();
        const canProceed = !aiReviewing && isValid;
        const nextLabels = { 1: 'NEXT: QUANTIFY SEGMENTS →', 2: 'NEXT: RANK SEGMENTS →', 3: 'NEXT: TARGET MARKET →', 4: 'VIEW CANVAS →' };
        return (
          <div className="wizard-layout">
            <div className="wizard-main">
              <div className="wizard-content animate-in">
                <DependencyContext deps={deps} />
                {step === 1 && <Step1Page data={data} updateData={updateData} addSegment={addSegment} removeSegment={removeSegment} updateSegment={updateSegment} />}
                {step === 2 && <Step2Page data={data} updateData={updateData} addSegmentSize={addSegmentSize} removeSegmentSize={removeSegmentSize} updateSegmentSize={updateSegmentSize} />}
                {step === 3 && <Step3Page data={data} updateData={updateData} addAttractiveness={addAttractiveness} removeAttractiveness={removeAttractiveness} updateAttractiveness={updateAttractiveness} />}
                {step === 4 && <Step4Page data={data} updateData={updateData} addMarketShareGoal={addMarketShareGoal} removeMarketShareGoal={removeMarketShareGoal} updateMarketShareGoal={updateMarketShareGoal} />}
              </div>
              <div className="wizard-footer">
                <button className="btn-wiz-back" onClick={goBack}>← BACK</button>
                <button className="btn-wiz-next" disabled={!canProceed} onClick={goNext}>
                  {aiReviewing ? 'AI COACH REVIEWING...' : (nextLabels[step] || 'NEXT →')}
                </button>
              </div>
            </div>
            <WizardSidebar currentStep={step} stepLabels={stepLabels} totalSteps={4} />
          </div>
        );
      }

      if (step === 5) {
        return (
          <CanvasPage
            data={data}
            onBack={goBack}
            onExport={exportPDF}
            onSubmit={handleSubmit}
          />
        );
      }

      return null;
    }

    // Cover Page Component
    function CoverPage({ onStart }) {
      return (
        <div className="relative min-h-screen flex items-center justify-center bg-black">
          <div
            className="absolute inset-0 w-full h-full"
            style={{
              backgroundImage: 'url("https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1920&q=80")',
              backgroundSize: 'cover',
              backgroundPosition: 'center'
            }}
          ></div>
          <div className="absolute inset-0" style={{background: 'linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.85))'}}></div>

          <div className="relative z-10 text-center text-white px-8 max-w-5xl mx-auto">
            <h1 className="plaak animate-in" style={{fontSize: '110px', lineHeight: '1', marginBottom: '32px'}}>
              SEGMENTATION & TARGET MARKET
            </h1>
            <p className="text-4xl mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              Focus on the vital few that matter most
            </p>
            <button
              onClick={onStart}
              className="bg-white text-black plaak px-16 py-6 border-4 border-white hover:bg-black hover:text-white transition-all text-3xl animate-in"
              style={{animationDelay: '0.4s'}}
            >
              START
            </button>
          </div>
        </div>
      );
    }

    // Intro Page Component
    function IntroPage({ data, updateData, onNext, canProceed }) {
      return (
        <div className="bg-black text-white min-h-screen p-16">
          <div className="max-w-5xl mx-auto">
            <h1 className="plaak mb-16 animate-in" style={{fontSize: '100px'}}>
              BEFORE WE START
            </h1>

            {/* User Details */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.05s'}}>
              <h2 className="plaak text-6xl mb-6">YOUR DETAILS</h2>
              <div className="space-y-6 bg-white text-black p-8">
                <div>
                  <label className="monument text-sm block mb-2">NAME <span className="text-red-500">*</span></label>
                  <input
                    type="text"
                    value={data.name}
                    onChange={(e) => updateData('name', e.target.value)}
                    placeholder="Marcus Chen"
                    className="w-full"
                  />
                </div>
                <div>
                  <label className="monument text-sm block mb-2">EMAIL <span className="text-red-500">*</span></label>
                  <input
                    type="email"
                    value={data.email}
                    onChange={(e) => updateData('email', e.target.value)}
                    placeholder="marcus.chen@company.com"
                    className="w-full"
                  />
                </div>
                <div>
                  <label className="monument text-sm block mb-2">COMPANY <span className="text-red-500">*</span></label>
                  <input
                    type="text"
                    value={data.company}
                    onChange={(e) => updateData('company', e.target.value)}
                    placeholder="TechVenture Solutions"
                    className="w-full"
                  />
                </div>
                <div>
                  <label className="monument text-sm block mb-2">ROLE</label>
                  <input
                    type="text"
                    value={data.role}
                    onChange={(e) => updateData('role', e.target.value)}
                    placeholder="Chief Marketing Officer"
                    className="w-full"
                  />
                </div>
              </div>
            </div>

            {/* Sprint Info */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.08s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>SPRINT INFO</h2>
              <div className="bg-white text-black p-8">
                <p className="text-2xl font-bold mb-4">Sprint 13: Segmentation & Target Market</p>
                <p className="text-xl leading-relaxed mb-4">
                  Transform customer data into actionable behavior-driven segments. Identify and prioritize distinct customer clusters based on shared needs and behaviors, allowing for targeted strategies and optimized resource allocation.
                </p>
                <div className="border-l-4 border-black pl-4 italic text-lg">
                  "Use the 80/20 rule - concentrate on the vital few segments that drive the majority of opportunities. Traditional segmentation often misses the mark because it doesn't account for why customers 'hire' a product."
                </div>
              </div>
            </div>

            {/* Purpose */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.1s'}}>
              <h2 className="plaak text-6xl mb-6">PURPOSE</h2>

              <div className="border-l-4 border-white pl-6 mb-6">
                <p className="text-3xl italic mb-2">"Behavior-based segmentation: understand behaviors to identify unmet needs."</p>
                <p className="text-xl text-gray-400">— MICHAEL E. PORTER, Competitive Advantage</p>
              </div>

              <p className="text-3xl leading-relaxed mb-4">
                Enable clear identification of core customer segments based on behaviors, not just demographics. This sets the stage for precise targeting and strategic alignment.
              </p>
              <p className="text-2xl text-gray-400">
                Teams using behavior-based segmentation see 30% higher customer retention than those using traditional demographic approaches.
              </p>
            </div>

            {/* Mistakes to Avoid */}
            <div className="mb-12 animate-in" style={{animationDelay: '0.2s'}}>
              <h2 className="plaak text-6xl mb-6" style={{color: '#FFF469'}}>MISTAKES TO AVOID</h2>

              <div className="bg-white text-black p-6 mb-6 border-4 border-yellow-400">
                <p className="riforma-bold text-2xl mb-4">THE FOUR SEGMENTATION SINS:</p>
                <ul className="text-xl space-y-3">
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">•</span>
                    <span><strong>Overanalysis Paralysis:</strong> Striving for unnecessary precision. Use the 70% rule - focus on actionable insights, not perfect data</span>
                  </li>
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">•</span>
                    <span><strong>Resistance to Change:</strong> Hesitating to shift from traditional segments. Challenge assumptions about who your real customers are</span>
                  </li>
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">•</span>
                    <span><strong>Resource Misalignment:</strong> Struggling to align resources with prioritized segments. Define clear ownership for each target segment</span>
                  </li>
                  <li className="flex items-start">
                    <span className="text-3xl mr-3">•</span>
                    <span><strong>Unclear Criteria Weights:</strong> Disagreements on how to prioritize. Use collaborative workshops to agree on weights for size, profitability, and fit</span>
                  </li>
                </ul>
              </div>

              <ul className="text-2xl space-y-4">
                <li className="flex items-start">
                  <span className="text-4xl mr-4">•</span>
                  <span>Creating overlapping segments. Segments must be mutually exclusive - no customer should fit in multiple segments.</span>
                </li>
                <li className="flex items-start">
                  <span className="text-4xl mr-4">•</span>
                  <span>Basing segments on demographics alone. Focus on behaviors and needs, not just age or location.</span>
                </li>
                <li className="flex items-start">
                  <span className="text-4xl mr-4">•</span>
                  <span>Setting unrealistic market share targets. Be ambitious but grounded in competitive analysis and resources.</span>
                </li>
              </ul>
            </div>

            {/* The Journey */}
            <div className="mb-16 animate-in" style={{animationDelay: '0.3s'}}>
              <h2 className="plaak text-6xl mb-8">THE JOURNEY</h2>
              <div className="grid grid-cols-4 gap-6 text-center">
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">01</div>
                  <p className="text-xl font-bold mb-2">DEFINE SEGMENTS</p>
                  <p className="text-base text-gray-400">Behavior-based customer clusters</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">02</div>
                  <p className="text-xl font-bold mb-2">QUANTIFY</p>
                  <p className="text-base text-gray-400">Size and value each segment</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">03</div>
                  <p className="text-xl font-bold mb-2">RANK</p>
                  <p className="text-base text-gray-400">Attractiveness index scoring</p>
                </div>
                <div className="border-2 border-white p-6">
                  <div className="text-8xl plaak mb-4">04</div>
                  <p className="text-xl font-bold mb-2">TARGET</p>
                  <p className="text-base text-gray-400">Focus and set market share goals</p>
                </div>
              </div>
            </div>

            <button
              onClick={onNext}
              disabled={!canProceed}
              className="btn-primary w-full text-3xl py-8 plaak"
            >
              LET'S START →
            </button>
          </div>
        </div>
      );
    }

    // Transition Screen Component
    // Wizard Sidebar Component
    function WizardSidebar({ currentStep, stepLabels, totalSteps }) {
      return (
        <div className="wizard-sidebar">
          <div style={{ marginBottom: 48 }}>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 8 }}>SPRINT 13</div>
            <div style={{ fontFamily: "'Monument', monospace", fontSize: 13, color: '#fff', letterSpacing: '0.06em', textTransform: 'uppercase', lineHeight: 1.4 }}>SEGMENTATION & TARGET MARKET</div>
          </div>
          <div style={{ flex: 1 }}>
            {stepLabels.map((label, i) => {
              const stepNum = i + 1;
              const isDone = stepNum < currentStep;
              const isActive = stepNum === Math.floor(currentStep);
              return (
                <div key={stepNum} style={{ display: 'flex', alignItems: 'flex-start', gap: 16, marginBottom: 28 }}>
                  <div style={{ width: 28, height: 28, borderRadius: '50%', border: `2px solid ${isDone ? '#FFF469' : isActive ? '#fff' : '#444'}`, background: isDone ? '#FFF469' : 'transparent', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0, marginTop: 2 }}>
                    {isDone ? <span style={{ color: '#000', fontSize: 13, fontWeight: 700 }}>✓</span> : <span style={{ color: isActive ? '#fff' : '#555', fontSize: 12, fontFamily: "'Monument', monospace" }}>{stepNum}</span>}
                  </div>
                  <div>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: isDone ? '#FFF469' : isActive ? '#fff' : '#555', letterSpacing: '0.08em', textTransform: 'uppercase', lineHeight: 1.5 }}>{label}</div>
                  </div>
                </div>
              );
            })}
          </div>
          <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#444', letterSpacing: '0.08em', textTransform: 'uppercase' }}>STEP {Math.floor(currentStep)} OF {totalSteps}</div>
        </div>
      );
    }

    // Step 1: Define Segments
    function Step1Page({ data, updateData, addSegment, removeSegment, updateSegment }) {
      return (
        <div>
            <div className="animate-in">
              <div className="numbered-section mb-8">
                [01] DEFINE MARKET SEGMENTS
              </div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  Clayton Christensen's Jobs-to-be-Done research (Harvard Business School) found that products segmented by customer intent rather than demographics succeed at 5x the rate. Porter's work on competitive advantage confirms that behavior-based segmentation identifies unmet needs invisible to traditional approaches. A Bain & Company study of 81 companies found that those using needs-based segmentation achieved 10% higher profit margins than industry peers over a 5-year period.
              </ScienceBox>

              {/* Common Mistake */}


              <div className="bg-black text-white border-4 border-black p-6 mb-8">
                <h3 className="riforma-bold text-3xl mb-2">Identify Behavior-Based Segments</h3>
                <p className="text-xl mb-4">
                  Define 5-7 distinct customer segments based on behaviors, not demographics. Focus on how they buy, what they value, and why they choose solutions.
                </p>
                <p className="text-lg italic border-l-4 border-yellow-400 pl-4">
                  "Traditional segmentation often misses the mark because it doesn't account for why customers 'hire' a product. Jobs-to-be-Done segmentation understands customer intents rather than demographics." — Clayton Christensen
                </p>
              </div>

              <div className="space-y-8">
                <div>
                  <label className="monument text-sm block mb-2">
                    CUSTOMER BEHAVIORS OBSERVED <span className="text-red-500">*</span>
                  </label>
                  <ScienceBookmarkIcon>
                      Porter's value chain analysis shows that mapping observable customer behaviors -- purchase frequency, channel preference, price sensitivity -- predicts segment profitability 3x better than demographic profiling alone (Competitive Advantage, M. Porter).
                  </ScienceBookmarkIcon>
                  <textarea
                    value={data.customerBehaviors}
                    onChange={(e) => updateData('customerBehaviors', e.target.value)}
                    placeholder="Price-sensitive buyers who compare 3+ options before purchase. Early adopters who value innovation over price. Loyal customers who purchase monthly on subscription. B2B decision-makers who require 90-day approval cycles. Last-minute impulse buyers triggered by scarcity."
                    className="w-full"
                    style={{minHeight: '120px'}}
                  />
                  <div className={`char-counter ${data.customerBehaviors.length < 50 ? 'invalid' : ''}`}>
                    {data.customerBehaviors.length}/1000 characters (min 50)
                  </div>
                </div>

                <div>
                  <h4 className="riforma-bold text-2xl mb-4">Market Segments (5-7 segments)</h4>
                  <p className="text-lg mb-4 text-gray-600">
                    Each segment must be mutually exclusive (no overlap) and collectively exhaustive (covers entire market).
                  </p>

                  {data.segments.map((segment, index) => (
                    <div key={index} className="bg-gray-50 p-6 mb-4 border-2 border-gray-200">
                      <div className="flex justify-between items-start mb-4">
                        <span className="monument text-xs">SEGMENT {index + 1}</span>
                        {data.segments.length > 1 && (
                          <button
                            onClick={() => removeSegment(index)}
                            className="text-sm text-red-600 hover:text-red-800"
                          >
                            × Remove
                          </button>
                        )}
                      </div>

                      <div className="space-y-4">
                        <div>
                          <label className="monument text-xs block mb-2">SEGMENT NAME <span className="text-red-500">*</span></label>
                          <ScienceBookmarkIcon>
                              Kim and Mauborgne's Blue Ocean Strategy research shows that clear, behavior-based segment naming increases cross-team alignment by 40%. Names should describe what the customer does, not who they are.
                          </ScienceBookmarkIcon>
                          <input
                            type="text"
                            value={segment.name}
                            onChange={(e) => updateSegment(index, 'name', e.target.value)}
                            placeholder="Price-Conscious Comparers"
                            className="w-full text-base"
                          />
                          <div className={`char-counter ${segment.name.length < 3 ? 'invalid' : ''}`}>
                            {segment.name.length} characters (min 3)
                          </div>
                        </div>

                        <div>
                          <label className="monument text-xs block mb-2">SEGMENT DESCRIPTION <span className="text-red-500">*</span></label>
                          <ScienceBookmarkIcon>
                              Christensen's Jobs-to-be-Done framework found that detailed segment descriptions including decision triggers, timeline, and deal size improve targeting accuracy by 60% vs. vague persona sketches (The Innovator's Solution, C. Christensen).
                          </ScienceBookmarkIcon>
                          <textarea
                            value={segment.description}
                            onChange={(e) => updateSegment(index, 'description', e.target.value)}
                            placeholder="Mid-market B2B companies (50-200 employees) who research extensively before purchase. They compare 3-5 vendors, focus heavily on ROI calculations, and require detailed case studies. Decision cycle: 60-90 days. Average deal size: $15K-$50K."
                            className="w-full text-base"
                            style={{minHeight: '100px'}}
                          />
                          <div className={`char-counter ${segment.description.length < 30 ? 'invalid' : ''}`}>
                            {segment.description.length}/500 characters (min 30)
                          </div>
                        </div>

                        <div>
                          <label className="monument text-xs block mb-2">KEY BEHAVIORS & NEEDS</label>
                          <textarea
                            value={segment.behaviors}
                            onChange={(e) => updateSegment(index, 'behaviors', e.target.value)}
                            placeholder="Compare multiple vendors rigorously. Request detailed ROI analysis. Require references from similar companies. Negotiate on price but value quality. Need implementation support and training."
                            className="w-full text-base"
                            style={{minHeight: '80px'}}
                          />
                        </div>
                      </div>
                    </div>
                  ))}

                  <button
                    onClick={addSegment}
                    className="btn-secondary w-full"
                  >
                    + Add Segment
                  </button>
                </div>
              </div>

            </div>
        </div>
      );
    }

    // Step 2: Quantify Segments
    function Step2Page({ data, updateData, addSegmentSize, removeSegmentSize, updateSegmentSize }) {
      return (
        <div>
            <div className="animate-in">
              <div className="numbered-section mb-8">
                [02] QUANTIFY SEGMENTS
              </div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  McKinsey's research on resource allocation found that companies that systematically quantify market segments reallocate capital 2.5x more aggressively to high-value opportunities, generating 30% higher total shareholder returns over 15 years. Porter's profit pool analysis demonstrates that segment profitability can vary by 10x within the same industry -- making quantification essential, not optional (McKinsey Quarterly, "How to Put Your Money Where Your Strategy Is").
              </ScienceBox>


              <div className="bg-black text-white border-4 border-black p-6 mb-8">
                <h3 className="riforma-bold text-3xl mb-2">Size The Prize</h3>
                <p className="text-xl mb-4">
                  Calculate the total market size, your accessible portion, and the revenue potential for each segment. This data drives prioritization.
                </p>
                <p className="text-lg italic border-l-4 border-yellow-400 pl-4">
                  "Focus on profit pools: analyze segment profitability to guide strategy. Build an attractiveness index emphasizing high-margin segments." — Michael E. Porter
                </p>
              </div>

              <div className="space-y-8">
                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                  <p className="riforma-bold text-lg mb-2">Formula:</p>
                  <p className="text-base">Total Segment Value = Accessible Market (# customers) × Average Revenue per Customer</p>
                </div>

                {data.segmentSizes.map((size, index) => (
                  <div key={index} className="border-2 border-black p-6 mb-4">
                    <div className="flex justify-between items-start mb-4">
                      <span className="monument text-xs">SEGMENT {index + 1}</span>
                      {data.segmentSizes.length > 1 && (
                        <button
                          onClick={() => removeSegmentSize(index)}
                          className="text-sm text-red-600 hover:text-red-800"
                        >
                          × Remove
                        </button>
                      )}
                    </div>

                    <div className="space-y-4">
                      <div>
                        <label className="monument text-xs block mb-2">SEGMENT NAME <span className="text-red-500">*</span></label>
                        <input
                          type="text"
                          value={size.segment}
                          onChange={(e) => updateSegmentSize(index, 'segment', e.target.value)}
                          placeholder="Price-Conscious Comparers"
                          className="w-full text-base"
                        />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="monument text-xs block mb-2">TOTAL MARKET (# customers) <span className="text-red-500">*</span></label>
                          <input
                            type="number"
                            value={size.totalMarket}
                            onChange={(e) => updateSegmentSize(index, 'totalMarket', e.target.value)}
                            placeholder="50000"
                            className="w-full text-base"
                          />
                        </div>
                        <div>
                          <label className="monument text-xs block mb-2">ACCESSIBLE MARKET (# customers) <span className="text-red-500">*</span></label>
                          <input
                            type="number"
                            value={size.accessibleMarket}
                            onChange={(e) => updateSegmentSize(index, 'accessibleMarket', e.target.value)}
                            placeholder="15000"
                            className="w-full text-base"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <label className="monument text-xs block mb-2">AVG REVENUE PER CUSTOMER ($)</label>
                          <input
                            type="number"
                            value={size.avgRevenue}
                            onChange={(e) => updateSegmentSize(index, 'avgRevenue', e.target.value)}
                            placeholder="2500"
                            className="w-full text-base"
                          />
                        </div>
                        <div>
                          <label className="monument text-xs block mb-2">TOTAL SEGMENT VALUE ($)</label>
                          <input
                            type="text"
                            value={size.totalValue}
                            readOnly
                            className="w-full text-base bg-gray-100 font-bold"
                            placeholder="Auto-calculated"
                          />
                        </div>
                      </div>
                    </div>
                  </div>
                ))}

                <button
                  onClick={addSegmentSize}
                  className="btn-secondary w-full"
                >
                  + Add Segment
                </button>
              </div>

            </div>
        </div>
      );
    }

    // Step 3: Attractiveness Index
    function Step3Page({ data, updateData, addAttractiveness, removeAttractiveness, updateAttractiveness }) {
      return (
        <div>
            <div className="animate-in">
              <div className="numbered-section mb-8">
                [03] ATTRACTIVENESS INDEX
              </div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  A BCG study of 200+ companies found that firms using weighted multi-criteria evaluation frameworks for segment prioritization achieved 35% higher strategic execution rates than those relying on intuition. The key mechanism: structured scoring forces teams to make implicit assumptions explicit, reducing groupthink and anchoring bias. Kahneman's research on decision-making confirms that systematic scoring outperforms expert judgment in complex multi-variable assessments (BCG Henderson Institute; Kahneman, "Thinking, Fast and Slow").
              </ScienceBox>


              <div className="bg-black text-white border-4 border-black p-6 mb-8">
                <h3 className="riforma-bold text-3xl mb-2">Rank By Strategic Value</h3>
                <p className="text-xl mb-4">
                  Score each segment on size, growth potential, profitability, and strategic fit. This weighted index reveals where to focus resources.
                </p>
                <p className="text-lg italic border-l-4 border-yellow-400 pl-4">
                  "Use the attractiveness index to pinpoint high-potential markets. Target emerging growth areas with nascent but promising segments." — Clayton Christensen
                </p>
              </div>

              <div className="space-y-8">
                <div className="bg-gray-50 border-2 border-black p-6 mb-6">
                  <h4 className="riforma-bold text-xl mb-4">Criteria Weights (must total 100%)</h4>
                  <div className="grid grid-cols-4 gap-4">
                    <div>
                      <label className="monument text-xs block mb-2">SIZE (%)</label>
                      <input
                        type="number"
                        value={data.criteriaWeights.size}
                        onChange={(e) => updateData('criteriaWeights', {...data.criteriaWeights, size: e.target.value})}
                        className="w-full text-base"
                      />
                    </div>
                    <div>
                      <label className="monument text-xs block mb-2">GROWTH (%)</label>
                      <input
                        type="number"
                        value={data.criteriaWeights.growth}
                        onChange={(e) => updateData('criteriaWeights', {...data.criteriaWeights, growth: e.target.value})}
                        className="w-full text-base"
                      />
                    </div>
                    <div>
                      <label className="monument text-xs block mb-2">PROFITABILITY (%)</label>
                      <input
                        type="number"
                        value={data.criteriaWeights.profitability}
                        onChange={(e) => updateData('criteriaWeights', {...data.criteriaWeights, profitability: e.target.value})}
                        className="w-full text-base"
                      />
                    </div>
                    <div>
                      <label className="monument text-xs block mb-2">STRATEGIC FIT (%)</label>
                      <input
                        type="number"
                        value={data.criteriaWeights.fit}
                        onChange={(e) => updateData('criteriaWeights', {...data.criteriaWeights, fit: e.target.value})}
                        className="w-full text-base"
                      />
                    </div>
                  </div>
                  <p className="text-sm text-gray-600 mt-2">
                    Total: {parseInt(data.criteriaWeights.size || 0) + parseInt(data.criteriaWeights.growth || 0) + parseInt(data.criteriaWeights.profitability || 0) + parseInt(data.criteriaWeights.fit || 0)}%
                    {(parseInt(data.criteriaWeights.size || 0) + parseInt(data.criteriaWeights.growth || 0) + parseInt(data.criteriaWeights.profitability || 0) + parseInt(data.criteriaWeights.fit || 0)) !== 100 &&
                      <span className="text-red-500 ml-2">(Must equal 100%)</span>
                    }
                  </p>
                </div>

                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                  <p className="riforma-bold text-lg mb-2">Scoring Guide:</p>
                  <p className="text-base">Rate each criterion 1-10 (10 = most attractive). Total score auto-calculates using your weights above.</p>
                </div>

                {data.attractivenessCriteria.map((criteria, index) => (
                  <div key={index} style={{ marginBottom: 8 }}>
                    <button
                      onClick={() => setOpenAttractivenessIdx(openAttractivenessIdx === index ? null : index)}
                      style={{
                        width: '100%', display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        background: openAttractivenessIdx === index ? '#000' : '#f9f9f9',
                        color: openAttractivenessIdx === index ? '#fff' : '#000',
                        border: '2px solid #000', padding: '12px 16px', cursor: 'pointer',
                        fontFamily: "'Monument', monospace", fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.06em'
                      }}
                    >
                      <span>SEGMENT {index + 1}{criteria.segment ? ' — ' + criteria.segment : ''}</span>
                      <span style={{ fontSize: 18, fontWeight: 'bold' }}>{openAttractivenessIdx === index ? '−' : '+'}</span>
                    </button>
                    {openAttractivenessIdx === index && (
                      <div style={{ border: '2px solid #000', borderTop: 'none', padding: '24px', background: '#f9f9f9' }}>
                        <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 16 }}>
                          {data.attractivenessCriteria.length > 1 && (
                            <button
                              onClick={() => { removeAttractiveness(index); setOpenAttractivenessIdx(0); }}
                              className="text-sm text-red-600 hover:text-red-800"
                            >
                              × Remove
                            </button>
                          )}
                        </div>

                        <div className="space-y-4">
                          <div>
                            <label className="monument text-xs block mb-2">SEGMENT NAME <span className="text-red-500">*</span></label>
                            <input
                              type="text"
                              value={criteria.segment}
                              onChange={(e) => updateAttractiveness(index, 'segment', e.target.value)}
                              placeholder="Price-Conscious Comparers"
                              className="w-full text-base"
                            />
                          </div>

                          <div className="grid grid-cols-5 gap-4">
                            <div>
                              <label className="monument text-xs block mb-2">SIZE (1-10) <span className="text-red-500">*</span></label>
                              <input
                                type="number"
                                min="1"
                                max="10"
                                value={criteria.size}
                                onChange={(e) => updateAttractiveness(index, 'size', e.target.value)}
                                className="w-full text-base"
                              />
                            </div>
                            <div>
                              <label className="monument text-xs block mb-2">GROWTH (1-10) <span className="text-red-500">*</span></label>
                              <input
                                type="number"
                                min="1"
                                max="10"
                                value={criteria.growth}
                                onChange={(e) => updateAttractiveness(index, 'growth', e.target.value)}
                                className="w-full text-base"
                              />
                            </div>
                            <div>
                              <label className="monument text-xs block mb-2">PROFIT (1-10)</label>
                              <input
                                type="number"
                                min="1"
                                max="10"
                                value={criteria.profitability}
                                onChange={(e) => updateAttractiveness(index, 'profitability', e.target.value)}
                                className="w-full text-base"
                              />
                            </div>
                            <div>
                              <label className="monument text-xs block mb-2">FIT (1-10)</label>
                              <input
                                type="number"
                                min="1"
                                max="10"
                                value={criteria.fit}
                                onChange={(e) => updateAttractiveness(index, 'fit', e.target.value)}
                                className="w-full text-base"
                              />
                            </div>
                            <div>
                              <label className="monument text-xs block mb-2">TOTAL SCORE</label>
                              <input
                                type="text"
                                value={criteria.total}
                                readOnly
                                className="w-full text-base bg-gray-100 font-bold"
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))}

                <button
                  onClick={addAttractiveness}
                  className="btn-secondary w-full"
                >
                  + Add Segment
                </button>
              </div>

            </div>
        </div>
      );
    }

    // Step 4: Target Market & Goals
    function Step4Page({ data, updateData, addMarketShareGoal, removeMarketShareGoal, updateMarketShareGoal }) {
      return (
        <div>
            <div className="animate-in">
              <div className="numbered-section mb-8">
                [04] TARGET MARKET & GOALS
              </div>

              {/* Fast Track Insight */}

              {/* The Science */}
              <ScienceBox collapsible={true}>
                  Longitudinal research by Bain & Company across 1,600 companies shows that organizations with clearly defined target segments and measurable market share goals achieve 60% higher revenue growth than competitors who "serve everyone." Porter's sustainable differentiation principle confirms that segment-specific value propositions generate 2-3x higher customer retention. Teams that revisit their target market quarterly maintain strategic alignment and catch market shifts before competitors do (Bain "Founder's Mentality"; Porter, "Competitive Advantage").
              </ScienceBox>


              <div className="bg-black text-white border-4 border-black p-6 mb-8">
                <h3 className="riforma-bold text-3xl mb-2">Set Market Share Targets</h3>
                <p className="text-xl mb-4">
                  Choose your top 2-3 segments and set clear, measurable market share goals. Define your end game - what does winning look like?
                </p>
                <p className="text-lg italic border-l-4 border-yellow-400 pl-4">
                  "Sustainable differentiation: tailor offerings to stand out in key segments. Highlight segment-specific value propositions in marketing." — Michael E. Porter
                </p>
              </div>

              <div className="space-y-8">
                <div>
                  <label className="monument text-sm block mb-2">
                    TARGET SEGMENTS SELECTED (Top 2-3 segments) <span className="text-red-500">*</span>
                  </label>
                  <textarea
                    value={data.targetSegments}
                    onChange={(e) => updateData('targetSegments', e.target.value)}
                    placeholder="Based on our attractiveness index, we will focus on: (1) Price-Conscious Comparers - highest score of 8.2, largest accessible market of 15,000 customers worth $37.5M; (2) Quality-Driven Enterprises - score 7.8, smaller market but 3x higher average deal size and strategic fit with our capabilities."
                    className="w-full"
                    style={{minHeight: '120px'}}
                  />
                  <div className={`char-counter ${data.targetSegments.length < 30 ? 'invalid' : ''}`}>
                    {data.targetSegments.length}/1000 characters (min 30)
                  </div>
                </div>

                <div>
                  <h4 className="riforma-bold text-2xl mb-4">Market Share Goals</h4>

                  {data.marketShareGoals.map((goal, index) => (
                    <div key={index} style={{ marginBottom: 8 }}>
                      <button
                        onClick={() => setOpenGoalIdx(openGoalIdx === index ? null : index)}
                        style={{
                          width: '100%', display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                          background: openGoalIdx === index ? '#000' : '#f9f9f9',
                          color: openGoalIdx === index ? '#fff' : '#000',
                          border: '2px solid #000', padding: '12px 16px', cursor: 'pointer',
                          fontFamily: "'Monument', monospace", fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.06em'
                        }}
                      >
                        <span>GOAL {index + 1}{goal.segment ? ' — ' + goal.segment : ''}</span>
                        <span style={{ fontSize: 18, fontWeight: 'bold' }}>{openGoalIdx === index ? '−' : '+'}</span>
                      </button>
                      {openGoalIdx === index && (
                        <div style={{ border: '2px solid #000', borderTop: 'none', padding: '24px', background: '#f9f9f9' }}>
                          <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: 16 }}>
                            {data.marketShareGoals.length > 1 && (
                              <button
                                onClick={() => { removeMarketShareGoal(index); setOpenGoalIdx(0); }}
                                className="text-sm text-red-600 hover:text-red-800"
                              >
                                × Remove
                              </button>
                            )}
                          </div>

                          <div className="space-y-4">
                            <div>
                              <label className="monument text-xs block mb-2">SEGMENT NAME <span className="text-red-500">*</span></label>
                              <input
                                type="text"
                                value={goal.segment}
                                onChange={(e) => updateMarketShareGoal(index, 'segment', e.target.value)}
                                placeholder="Price-Conscious Comparers"
                                className="w-full text-base"
                              />
                            </div>

                            <div className="grid grid-cols-3 gap-4">
                              <div>
                                <label className="monument text-xs block mb-2">CURRENT SHARE (%)</label>
                                <input
                                  type="number"
                                  value={goal.currentShare}
                                  onChange={(e) => updateMarketShareGoal(index, 'currentShare', e.target.value)}
                                  placeholder="3"
                                  className="w-full text-base"
                                />
                              </div>
                              <div>
                                <label className="monument text-xs block mb-2">TARGET SHARE (%) <span className="text-red-500">*</span></label>
                                <input
                                  type="number"
                                  value={goal.targetShare}
                                  onChange={(e) => updateMarketShareGoal(index, 'targetShare', e.target.value)}
                                  placeholder="12"
                                  className="w-full text-base"
                                />
                              </div>
                              <div>
                                <label className="monument text-xs block mb-2">TIMELINE</label>
                                <input
                                  type="text"
                                  value={goal.timeline}
                                  onChange={(e) => updateMarketShareGoal(index, 'timeline', e.target.value)}
                                  placeholder="18 months"
                                  className="w-full text-base"
                                />
                              </div>
                            </div>

                            <div>
                              <label className="monument text-xs block mb-2">STRATEGY TO ACHIEVE</label>
                              <textarea
                                value={goal.strategy}
                                onChange={(e) => updateMarketShareGoal(index, 'strategy', e.target.value)}
                                placeholder="Launch targeted ROI calculator tool. Partner with 3 industry analysts for case studies. Sponsor comparison websites. Offer 90-day money-back guarantee. Build dedicated sales team for mid-market."
                                className="w-full text-base"
                                style={{minHeight: '80px'}}
                              />
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}

                  <button
                    onClick={addMarketShareGoal}
                    className="btn-secondary w-full"
                  >
                    + Add Goal
                  </button>
                </div>

                <div>
                  <label className="monument text-sm block mb-2">
                    END GAME (What does winning look like in 3 years?) <span className="text-red-500">*</span>
                  </label>
                  <textarea
                    value={data.endGame}
                    onChange={(e) => updateData('endGame', e.target.value)}
                    placeholder="In 36 months, we are the #1 choice for Price-Conscious Comparers with 18% market share (2,700 customers generating $67.5M annual revenue). We are recognized as the ROI leader by analyst firms. Quality-Driven Enterprises see us as the premium option, with 8% market share (400 customers at $20M revenue). Combined, these two segments represent $87.5M in revenue - 75% of our total business."
                    className="w-full"
                    style={{minHeight: '140px'}}
                  />
                  <div className={`char-counter ${data.endGame.length < 50 ? 'invalid' : ''}`}>
                    {data.endGame.length}/1000 characters (min 50)
                  </div>
                </div>
              </div>

            </div>
        </div>
      );
    }

    // Canvas Page Component
    function CanvasPage({ data, onBack, onExport, onSubmit }) {
      // Sort segments by attractiveness score
      const rankedSegments = [...data.attractivenessCriteria].sort((a, b) =>
        parseFloat(b.total || 0) - parseFloat(a.total || 0)
      );

      return (
        <div className="min-h-screen bg-white">
          <header className="no-print border-b-4 border-black p-6">
            <div className="max-w-6xl mx-auto flex justify-between items-center">
              <div>
                <h1 className="plaak text-4xl mb-2">YOUR SEGMENTATION CANVAS</h1>
                <p className="text-gray-600">Focus on the vital few that matter most</p>
              </div>
              <button onClick={onBack} className="btn-secondary">
                ← Edit
              </button>
            </div>
          </header>

          <div className="max-w-6xl mx-auto p-12">
            <div id="canvas-content" className="border-4 border-black p-8 mb-8 bg-white">
              {/* User Info */}
              <div className="mb-8 pb-8 border-b-2 border-black">
                <h2 className="plaak text-3xl mb-4">PARTICIPANT</h2>
                <div className="grid grid-cols-2 gap-4 text-lg">
                  <div><span className="monument text-xs">NAME:</span> {data.name}</div>
                  <div><span className="monument text-xs">COMPANY:</span> {data.company}</div>
                  <div><span className="monument text-xs">EMAIL:</span> {data.email}</div>
                  <div><span className="monument text-xs">ROLE:</span> {data.role}</div>
                </div>
              </div>

              {/* Market Segments */}
              <div className="mb-8 pb-8 border-b-2 border-black">
                <h2 className="plaak text-3xl mb-4">MARKET SEGMENTS DEFINED</h2>
                <div className="mb-4 p-4 bg-gray-100">
                  <p className="monument text-xs mb-2">OBSERVED BEHAVIORS:</p>
                  <p className="text-base">{data.customerBehaviors}</p>
                </div>
                {data.segments.map((segment, index) => (
                  <div key={index} className="mb-4 p-4 bg-gray-50 border-l-4 border-black">
                    <h3 className="riforma-bold text-xl mb-2">{segment.name}</h3>
                    <p className="text-base mb-2">{segment.description}</p>
                    {segment.behaviors && (
                      <p className="text-sm text-gray-700"><span className="riforma-bold">Key Behaviors:</span> {segment.behaviors}</p>
                    )}
                  </div>
                ))}
              </div>

              {/* Segment Quantification */}
              <div className="mb-8 pb-8 border-b-2 border-black">
                <h2 className="plaak text-3xl mb-4">SEGMENT QUANTIFICATION</h2>
                <table className="w-full text-sm">
                  <thead className="bg-black text-white">
                    <tr>
                      <th className="text-left p-3">SEGMENT</th>
                      <th className="text-right p-3">TOTAL MARKET</th>
                      <th className="text-right p-3">ACCESSIBLE</th>
                      <th className="text-right p-3">AVG REVENUE</th>
                      <th className="text-right p-3">TOTAL VALUE</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.segmentSizes.map((size, index) => (
                      <tr key={index} className="border-b">
                        <td className="p-3 riforma-bold">{size.segment}</td>
                        <td className="text-right p-3">{size.totalMarket ? parseInt(size.totalMarket).toLocaleString() : '-'}</td>
                        <td className="text-right p-3">{size.accessibleMarket ? parseInt(size.accessibleMarket).toLocaleString() : '-'}</td>
                        <td className="text-right p-3">${size.avgRevenue ? parseInt(size.avgRevenue).toLocaleString() : '-'}</td>
                        <td className="text-right p-3 riforma-bold">${size.totalValue ? parseInt(size.totalValue).toLocaleString() : '-'}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Attractiveness Rankings */}
              <div className="mb-8 pb-8 border-b-2 border-black">
                <h2 className="plaak text-3xl mb-4">ATTRACTIVENESS INDEX RANKING</h2>
                <div className="mb-4 p-4 bg-gray-100">
                  <p className="monument text-xs mb-2">CRITERIA WEIGHTS:</p>
                  <p className="text-base">
                    Size: {data.criteriaWeights.size}% | Growth: {data.criteriaWeights.growth}% | Profitability: {data.criteriaWeights.profitability}% | Strategic Fit: {data.criteriaWeights.fit}%
                  </p>
                </div>
                {rankedSegments.map((criteria, index) => (
                  <div key={index} className={`mb-3 p-4 border-l-4 ${index === 0 ? 'bg-gray-200 border-black' : index === 1 ? 'bg-yellow-100 border-yellow-600' : 'bg-gray-100 border-gray-400'}`}>
                    <div className="flex justify-between items-center">
                      <div>
                        <span className="monument text-xs">#{index + 1}</span>
                        <h3 className="riforma-bold text-lg">{criteria.segment}</h3>
                      </div>
                      <div className="text-right">
                        <p className="text-3xl riforma-bold">{criteria.total}</p>
                        <p className="text-xs monument">TOTAL SCORE</p>
                      </div>
                    </div>
                    <div className="grid grid-cols-4 gap-2 mt-2 text-sm">
                      <div><span className="monument text-xs">SIZE:</span> {criteria.size}/10</div>
                      <div><span className="monument text-xs">GROWTH:</span> {criteria.growth}/10</div>
                      <div><span className="monument text-xs">PROFIT:</span> {criteria.profitability}/10</div>
                      <div><span className="monument text-xs">FIT:</span> {criteria.fit}/10</div>
                    </div>
                  </div>
                ))}
              </div>

              {/* Target Market & Goals */}
              <div className="mb-8">
                <h2 className="plaak text-3xl mb-4">TARGET MARKET & GOALS</h2>
                <div className="mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-600">
                  <p className="monument text-xs mb-2">SELECTED TARGET SEGMENTS:</p>
                  <p className="text-base">{data.targetSegments}</p>
                </div>

                <div className="mb-6">
                  <h3 className="riforma-bold text-xl mb-3">Market Share Goals:</h3>
                  {data.marketShareGoals.map((goal, index) => (
                    <div key={index} className="mb-4 p-4 bg-gray-50 border-2 border-black">
                      <div className="flex justify-between items-start mb-2">
                        <h4 className="riforma-bold text-lg">{goal.segment}</h4>
                        <div className="text-right">
                          <p className="text-sm monument">TARGET</p>
                          <p className="text-2xl riforma-bold">{goal.targetShare}%</p>
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-4 text-sm mb-2">
                        <div><span className="monument text-xs">CURRENT:</span> {goal.currentShare}%</div>
                        <div><span className="monument text-xs">TIMELINE:</span> {goal.timeline}</div>
                      </div>
                      {goal.strategy && (
                        <div className="text-sm">
                          <span className="monument text-xs">STRATEGY:</span> {goal.strategy}
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                <div className="p-6 bg-black text-white">
                  <h3 className="plaak text-2xl mb-3">THE END GAME</h3>
                  <p className="text-lg leading-relaxed">{data.endGame}</p>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-4 no-print">
              <button onClick={() => window.print()} className="btn-secondary flex-1">
                Print Canvas
              </button>
              <button onClick={onExport} className="btn-secondary flex-1">
                Export PDF
              </button>
              <button onClick={onSubmit} className="btn-primary flex-1">
                Submit to Team
              </button>
            </div>

            {/* Case Study */}
            <CaseStudy
                before={"A mid-size telecom company marketed the same bundle to all customers. Churn was 22% annually, acquisition costs were rising, and marketing ROI was declining quarter over quarter because messages resonated with nobody in particular."}
                after={"After implementing behavior-based segmentation, they identified 3 high-value clusters: loyalty-driven subscribers, price-sensitive switchers, and tech-early-adopters. Tailored retention offers reduced churn to 14%, customer acquisition cost dropped 35%, and marketing ROI improved by 48% within 9 months."}
                quote={"Once we stopped trying to be everything to everyone, we became the obvious choice for the customers who actually mattered. Our NPS jumped 22 points in one quarter."}
            />
          </div>
        </div>
      );
    }

    // Progress Indicator Component
    function ProgressIndicator({ currentStep }) {
      const steps = [
        { num: 1, name: 'DEFINE' },
        { num: 2, name: 'QUANTIFY' },
        { num: 3, name: 'RANK' },
        { num: 4, name: 'TARGET' }
      ];

      return (
        <div className="border-b border-gray-200 py-6 px-8 no-print">
          <div className="max-w-6xl mx-auto">
            <div className="flex items-center justify-between">
              {steps.map((step, index) => (
                <React.Fragment key={step.num}>
                  <div className="flex flex-col items-center">
                    <div
                      className={`progress-dot ${
                        currentStep === step.num ? 'active' :
                        currentStep > step.num ? 'completed' : ''
                      }`}
                    ></div>
                    <span className="monument text-xs mt-2">{step.name}</span>
                  </div>
                  {index < steps.length - 1 && (
                    <div className="progress-line" style={{width: '100px'}}></div>
                  )}
                </React.Fragment>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // Render App
        ReactDOM.render(<SegmentationApp />, document.getElementById('root'));
  </script>
</body>
</html>
