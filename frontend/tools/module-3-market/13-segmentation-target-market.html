<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segmentation &amp; Target Market | Fast Track Program</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

    <style>
        @font-face { font-family: 'Plaak';    src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; }
        @font-face { font-family: 'Riforma';  src: url('RiformaLL-Regular.woff2')   format('woff2'); font-weight: normal; }
        @font-face { font-family: 'Riforma';  src: url('RiformaLL-Regular.woff2')   format('woff2'); font-weight: 600; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Riforma', -apple-system, sans-serif; font-size: 16px; color: #000; background: #000; -webkit-font-smoothing: antialiased; }

        .plaak   { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main { flex: 1; display: flex; flex-direction: column; min-height: 100vh; background: #fff; padding: 0 48px; }
        .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }

        .step-content { max-width: 100%; padding: 40px 0; flex: 1; }
        .step-indicator { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 8px; }
        .opening-box { margin-bottom: 32px; }
        .opening-box .step-heading { font-family: 'Plaak', sans-serif; font-weight: bold; font-size: 32px; letter-spacing: -0.01em; line-height: 1.2; color: #000; margin-bottom: 6px; }
        .opening-box .step-hint { font-size: 14px; color: #666; line-height: 1.5; margin: 0; }

        .field-group { margin-bottom: 40px; }
        .field-group:last-child { margin-bottom: 0; }
        .field-label { font-weight: 600; font-size: 16px; color: #000; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .field-input { border: 1px solid #E0E0E0; padding: 12px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; width: 100%; color: #000; background: #fff; transition: border-color 0.2s; }
        .field-input:focus { outline: none; border-color: #000; }
        .field-textarea { border: 1px solid #E0E0E0; padding: 12px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; width: 100%; min-height: 100px; resize: none !important; color: #000; background: #fff; transition: border-color 0.2s; }
        .field-textarea:focus { outline: none; border-color: #000; }
        .field-help  { font-size: 13px; color: #666; margin-top: 4px; }
        .field-error { font-size: 13px; color: #DC2626; margin-top: 4px; }

        .closing-box { border-top: 1px solid #E0E0E0; padding: 20px 0 0 0; margin-top: 8px; text-align: center; }
        .closing-box p { font-size: 14px; color: #666; }
        .closing-box .closing-title { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #000; margin-bottom: 6px; }

        .wizard-footer { display: flex; justify-content: space-between; align-items: center; padding: 24px 48px; border-top: 1px solid #e5e7eb; background: #fff; }
        .btn-wiz-back { background: transparent; border: 2px solid #d1d5db; color: #6b7280; padding: 12px 28px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-wiz-back:hover { border-color: #000; color: #000; }
        .btn-wiz-next { background: #000; color: #fff; border: 2px solid #000; padding: 12px 36px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-wiz-next:hover:not(:disabled) { background: #FFF469; color: #000; border-color: #FFF469; }
        .btn-wiz-next:disabled { background: #E0E0E0; color: #9CA3AF; border-color: #E0E0E0; cursor: not-allowed; }

        .learn-more-toggle { font-family: 'Monument', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: #000; background: #F5F5F5; border: 1px solid #E0E0E0; cursor: pointer; padding: 10px 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 24px; width: 100%; }
        .learn-more-content { background: #F5F5F5; border: 1px solid #E0E0E0; border-top: none; padding: 16px; font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 24px; }

        .activity-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .activity-row-num { font-family: 'Monument', monospace; font-size: 11px; color: #999; min-width: 24px; }
        .btn-remove { background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 4px 8px; transition: color 0.2s; flex-shrink: 0; }
        .btn-remove:hover { color: #DC2626; }
        .btn-add { width: 100%; padding: 10px 0; border: 2px dashed #E0E0E0; background: none; font-family: 'Monument', monospace; font-size: 12px; color: #666; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; margin-top: 4px; transition: all 0.2s; }
        .btn-add:hover { border-color: #000; color: #000; }

        .sidebar-tool-num { font-family: 'Monument', monospace; font-size: 10px; color: #555; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 8px; }
        .sidebar-tool-title { font-family: 'Plaak', sans-serif; font-size: 22px; color: #fff; margin-bottom: 32px; line-height: 1.1; }
        .sidebar-step { padding: 8px 0; border-bottom: 1px solid #2a2a2a; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: opacity 0.2s; }
        .sidebar-step:last-child { border-bottom: none; }
        .sidebar-step-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; flex-shrink: 0; transition: background 0.2s; }
        .sidebar-step-dot.active { background: #FFF469; }
        .sidebar-step-dot.done   { background: #4ade80; }
        .sidebar-step-label { font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.08em; color: #555; text-transform: uppercase; transition: color 0.2s; }
        .sidebar-step-label.active { color: #FFF469; }
        .sidebar-step-label.done   { color: #4ade80; }
        .sidebar-activity-list { margin-top: 24px; border-top: 1px solid #2a2a2a; padding-top: 16px; }
        .sidebar-activity-item { font-size: 12px; color: #555; padding: 4px 0; line-height: 1.4; display: flex; gap: 8px; }
        .sidebar-activity-item.filled { color: #ccc; }
        .sidebar-activity-idx { font-family: 'Monument', monospace; font-size: 10px; color: #FFF469; flex-shrink: 0; }

        .mobile-step-bar { display: none; }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .wizard-main { padding: 0 24px; }
            .mobile-step-bar { display: flex; align-items: center; gap: 8px; padding: 16px 24px; background: #1a1a1a; }
            .mobile-step-dot { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: background 0.2s; }
            .mobile-step-dot.active { background: #FFF469; }
            .mobile-step-dot.done   { background: #4ade80; }
            .mobile-step-text { font-family: 'Monument', monospace; font-size: 11px; color: #fff; letter-spacing: 0.06em; }
            .wizard-footer { padding: 16px 24px; }
        }

        .animate-in { animation: fadeSlideIn 0.4s ease both; }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        .ai-message { background: #FFF9C4; border: 1px solid #FFF469; border-left: 4px solid #FFF469; padding: 12px 16px; font-size: 14px; color: #333; margin-bottom: 16px; line-height: 1.6; }

        .dep-context { border: 1px solid #E0E0E0; margin-bottom: 24px; }
        .dep-context-header { background: #F5F5F5; padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .dep-context-label { font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.1em; color: #666; text-transform: uppercase; }
        .dep-context-body { padding: 14px 16px; font-size: 14px; color: #333; line-height: 1.6; }

        .quant-card { border: 1px solid #E0E0E0; margin-bottom: 12px; }
        .quant-card-header { background: #000; color: #fff; padding: 10px 16px; display: flex; align-items: center; gap: 12px; }
        .quant-card-body { padding: 16px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .quant-input-group { display: flex; flex-direction: column; gap: 4px; }
        .quant-input-label { font-family: 'Monument', monospace; font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 0.1em; }
        .totals-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; padding: 12px 16px; background: #F9F9F9; border: 1px solid #E0E0E0; margin-top: 8px; }
        .total-item { text-align: center; }
        .total-label { font-family: 'Monument', monospace; font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 4px; }
        .total-value { font-family: 'Plaak', sans-serif; font-size: 22px; }
        .total-value.ok   { color: #22c55e; }
        .total-value.warn { color: #f59e0b; }
        .total-value.err  { color: #DC2626; }

        .rank-badge { display: inline-flex; align-items: center; justify-content: center; background: #000; color: #FFF469; font-family: 'Plaak', sans-serif; font-size: 18px; padding: 2px 10px; min-width: 36px; }

        .tab-nav { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 20px; }
        .tab-btn { padding: 6px 14px; font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.06em; cursor: pointer; border: 2px solid #E0E0E0; background: #fff; color: #999; transition: all 0.2s; text-transform: uppercase; }
        .tab-btn.active { background: #000; color: #FFF469; border-color: #000; }
        .tab-btn.scored { background: #F0F0F0; color: #000; border-color: #000; }

        .canvas-table { width: 100%; border-collapse: collapse; margin-bottom: 4px; }
        .canvas-table th { font-family: 'Monument', monospace; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; padding: 8px 12px; border-bottom: 2px solid #000; text-align: left; }
        .canvas-table td { padding: 10px 12px; border-bottom: 1px solid #E0E0E0; font-size: 14px; }
        .canvas-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    const CONFIG = {
        TOOL_SLUG:    'segmentation-target-market',
        TOOL_TITLE:   'SEGMENTATION & TARGET MARKET',
        TOOL_SUBTITLE:'Define your market segments, rank them by attractiveness, and set your market share targets.',
        COVER_IMAGE:  'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1600&q=80',
        TOTAL_STEPS:  4,
        SUPABASE_URL:     'https://lutzzfaedkbsmbobmrzx.supabase.co',
        SUPABASE_ANON_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
        TRANSITION_CONTENT: {
            1: {
                brutalTruth: 'Most companies skip segmentation and target the customer they already know. That is not strategy — it is inertia. The best market position is rarely in the largest segment. It is in the most underserved one. If you cannot name 5 distinct segments with different needs, you are not marketing. You are broadcasting.',
                peerProof: '"IKEA discovered their core segment was not people who want cheap furniture — it was people who value smart design but cannot afford luxury brands. That single reframe built a €40B company. The segment they chose to own was hiding in their brainstorm list all along."'
            },
            2: {
                brutalTruth: 'A segment without a number is an opinion. Quantification is not academic precision — it is the difference between pursuing a €50M opportunity and a €5M one with equal effort. Most teams argue about which segment to target. The data already knows. You just have not looked at it yet.',
                peerProof: '"A €8M manufacturing company ran Segment Quantification and discovered their most profitable segment was 12% of their customer base but represented 44% of total profit. They stopped marketing to everyone and focused on that 12%. Revenue grew 18% in 18 months."'
            },
            3: {
                brutalTruth: 'Every segment looks attractive when you do not have to choose. The Attractiveness Index forces honesty. The segment that feels right is often not the one that scores highest. Trust the framework, not the gut — then commit. Hedging between segments is how average companies stay average.',
                peerProof: '"A €20M B2B services firm scored 6 segments using the Attractiveness Index. Their highest-scoring segment was one they had previously ignored because it felt small. It was twice as profitable as their current focus. They reallocated 40% of their sales team. Pipeline grew 3x in one year."'
            },
            4: {
                brutalTruth: 'A market share target without a date is a wish. A market share target with a number, a segment, and a deadline is a strategy. Your team cannot rally around a direction they cannot measure. Set the number. Write it down. Everything else in this programme is built to get you there.',
                peerProof: '"Zara set a 1-year target of 15% market share in the trend-responsive mid-market segment before anyone else recognised it as a segment. That clarity of target — specific segment, specific share, specific year — guided every operational and marketing decision for the next 5 years."'
            }
        },
        CLOSING_MESSAGES: {
            1: { title: 'SEGMENTS DEFINED',    text: 'Your market map is taking shape. Now put numbers behind each segment.' },
            2: { title: 'QUANTIFICATION DONE', text: 'The numbers reveal the opportunity. Now rank the segments by attractiveness.' },
            3: { title: 'RANKING COMPLETE',    text: 'Your top segments are identified. Now commit to a target and set your ambition.' },
            4: { title: 'TARGETS SET',         text: 'Your strategy has a destination. Time to build your canvas.' },
        }
    };

    const makeDefaultData = () => ({
        needs:    Array(8).fill(''),
        clusters: Array(5).fill(''),
        segments: Array(7).fill(''),
        quantification: Array(7).fill(null).map(() => ({ customers: '', marketValue: '', profit: '' })),
        weights: { marketSize: 3, profitPool: 3, trend: 3, strategyFit: 3, custom: 3 },
        customFactor: '',
        scores: Array(7).fill(null).map(() => ({ marketSize: 0, profitPool: 0, trend: 0, strategyFit: 0, custom: 0 })),
        targetSalesShare3yr:  '',
        targetProfitShare3yr: '',
        targetSalesShare1yr:  '',
        targetProfitShare1yr: '',
        targetDescription:    '',
        additionalTargets: ['', '', ''],
    });

    const calcScore = (weights, s, customFactor) => {
        const base = (weights.marketSize * s.marketSize) +
                     (weights.profitPool  * s.profitPool)  +
                     (weights.trend       * s.trend)       +
                     (weights.strategyFit * s.strategyFit);
        const custom = (customFactor && customFactor.trim()) ? weights.custom * s.custom : 0;
        return base + custom;
    };

    const getRankedSegments = (data) => {
        return data.segments
            .map((name, idx) => ({ name, idx, score: calcScore(data.weights, data.scores[idx], data.customFactor) }))
            .filter(s => s.name.trim())
            .sort((a, b) => b.score - a.score);
    };

    function WizardSidebar({ currentStep, data, onNavigate }) {
        const steps = [
            { num: 1, label: 'Brainstorm' },
            { num: 2, label: 'Quantification' },
            { num: 3, label: 'Ranking' },
            { num: 4, label: 'Target Setting' },
            { num: 'canvas', label: 'Canvas' },
        ];
        return (
            <div className="wizard-sidebar">
                <div className="sidebar-tool-num">SPRINT 13</div>
                <div className="sidebar-tool-title">{CONFIG.TOOL_TITLE}</div>
                {steps.map(s => {
                    const isCanvas = s.num === 'canvas';
                    const isDone   = isCanvas ? false : (typeof currentStep === 'number' && currentStep > s.num);
                    const isActive = isCanvas ? currentStep === 'canvas' : (typeof currentStep === 'number' && Math.floor(currentStep) === s.num);
                    const isFuture = isCanvas ? false : (typeof currentStep === 'number' && currentStep < s.num);
                    return (
                        <div key={String(s.num)} className="sidebar-step"
                            onClick={() => isDone && onNavigate(s.num)}
                            style={{ opacity: isFuture ? 0.35 : 1, cursor: isDone ? 'pointer' : 'default' }}>
                            <div className={'sidebar-step-dot' + (isActive ? ' active' : isDone ? ' done' : '')} />
                            <span className={'sidebar-step-label' + (isActive ? ' active' : isDone ? ' done' : '')}>{s.label}</span>
                        </div>
                    );
                })}
                {data.segments.some(s => s.trim()) && (
                    <div className="sidebar-activity-list">
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 8 }}>SEGMENTS</div>
                        {data.segments.map((seg, i) => {
                            if (!seg.trim()) return null;
                            return (
                                <div key={i} className="sidebar-activity-item filled">
                                    <span className="sidebar-activity-idx">{String(i+1).padStart(2,'0')}</span>
                                    <span>{seg}</span>
                                </div>
                            );
                        })}
                    </div>
                )}
            </div>
        );
    }

    function MobileStepBar({ currentStep, totalSteps }) {
        const stepNum = typeof currentStep === 'number' ? currentStep : totalSteps + 1;
        return (
            <div className="mobile-step-bar">
                <span className="mobile-step-text">STEP {Math.ceil(stepNum)} OF {totalSteps}</span>
                {Array.from({ length: totalSteps }, (_, i) => {
                    const n = i + 1;
                    const isDone   = typeof currentStep === 'number' && currentStep > n;
                    const isActive = typeof currentStep === 'number' && Math.floor(currentStep) === n;
                    return <div key={n} className={'mobile-step-dot' + (isActive ? ' active' : isDone ? ' done' : '')} />;
                })}
            </div>
        );
    }

    function DependencyContext({ deps }) {
        const [open, setOpen] = useState(false);
        if (!deps || Object.keys(deps).length === 0) return null;
        const entries = Object.entries(deps).filter(([, v]) => v);
        if (entries.length === 0) return null;
        return (
            <div className="dep-context">
                <div className="dep-context-header" onClick={() => setOpen(o => !o)}>
                    <span className="dep-context-label">Context from previous tools</span>
                    <span style={{ fontSize: 12, color: '#999' }}>{open ? '▲' : '▼'}</span>
                </div>
                {open && (
                    <div className="dep-context-body">
                        {entries.map(([k, v]) => (
                            <div key={k} style={{ marginBottom: 8 }}>
                                <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#999', textTransform: 'uppercase', letterSpacing: '0.08em' }}>{k.replace(/_/g,' ')}: </span>
                                <span>{typeof v === 'object' ? JSON.stringify(v) : String(v)}</span>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    function LearnMore({ children }) {
        const [open, setOpen] = useState(false);
        return (
            <React.Fragment>
                <button className="learn-more-toggle" onClick={() => setOpen(o => !o)}>
                    <span>{open ? '▲' : '▼'}</span> {open ? 'Hide context' : 'Why this matters'}
                </button>
                {open && <div className="learn-more-content">{children}</div>}
            </React.Fragment>
        );
    }

    function TransitionScreen({ stepNum, onNext }) {
        const t = CONFIG.TRANSITION_CONTENT[stepNum];
        if (!t) { onNext(); return null; }
        return (
            <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', zIndex: 200, overflowY: 'auto', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '64px 32px' }}>
                <div style={{ maxWidth: 720, width: '100%' }} className="animate-in">
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#555', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 32 }}>
                        SPRINT 13 — SEGMENTATION &amp; TARGET MARKET
                    </div>
                    <div style={{ borderLeft: '4px solid #DC2626', paddingLeft: 24, marginBottom: 48 }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#DC2626', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 12 }}>BRUTAL TRUTH</div>
                        <p className="plaak" style={{ fontSize: 26, lineHeight: 1.35 }}>{t.brutalTruth}</p>
                    </div>
                    <div style={{ borderLeft: '4px solid #FFF469', paddingLeft: 24, marginBottom: 64 }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 12 }}>PEER PROOF</div>
                        <p style={{ fontSize: 18, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                    </div>
                    <button onClick={onNext} className="plaak"
                        style={{ background: '#FFF469', color: '#000', border: 'none', padding: '18px 48px', fontSize: 18, cursor: 'pointer', letterSpacing: '0.05em', transition: 'all 0.2s' }}>
                        CONTINUE →
                    </button>
                </div>
            </div>
        );
    }

    function RatingBtn({ label, selected, color, onClick }) {
        return (
            <button onClick={onClick} style={{
                padding: '5px 10px',
                border: '2px solid ' + (selected ? color : '#E0E0E0'),
                background: selected ? color : '#fff',
                color: selected ? (color === '#FFF469' ? '#000' : '#fff') : '#999',
                fontFamily: "'Monument', monospace",
                fontSize: 10,
                letterSpacing: '0.05em',
                cursor: 'pointer',
                transition: 'all 0.15s',
                textTransform: 'uppercase',
                whiteSpace: 'nowrap',
            }}>{label}</button>
        );
    }

    function Step1({ data, updateData, deps, aiMessage }) {
        const namedSegs = data.segments.filter(s => s.trim().length >= 3);
        const meceOk = namedSegs.length >= 5;

        const updateNeed = (idx, val) => {
            const next = data.needs.slice();
            next[idx] = val;
            updateData('needs', next);
        };
        const addNeed = () => {
            if (data.needs.length < 15) updateData('needs', data.needs.concat(''));
        };
        const removeNeed = (idx) => {
            if (data.needs.length <= 5) return;
            updateData('needs', data.needs.filter((_, i) => i !== idx));
        };
        const updateCluster = (idx, val) => {
            const next = data.clusters.slice();
            next[idx] = val;
            updateData('clusters', next);
        };
        const updateSegment = (idx, val) => {
            const next = data.segments.slice();
            next[idx] = val;
            updateData('segments', next);
        };

        const needPlaceholders = [
            'e.g. Price-sensitive buyers',
            'e.g. Quality-first purchasers',
            'e.g. Fast decision makers',
            'e.g. Loyal repeat customers',
            'e.g. Innovation seekers',
            'e.g. Service-first clients',
            'e.g. Volume purchasers',
            'e.g. Premium brand seekers',
        ];
        const clusterPlaceholders = [
            'e.g. Budget-focused',
            'e.g. Premium seekers',
            'e.g. Speed-first buyers',
            'e.g. Loyalty-driven clients',
            'e.g. Innovation seekers',
        ];
        const segPlaceholders = [
            'e.g. Budget-Conscious SMEs',
            'e.g. Growth-Stage Startups',
            'e.g. Enterprise Innovators',
            'e.g. Value-Maximising Buyers',
            'e.g. Loyalty-Driven Partners',
            'e.g. Speed-First Operators',
            'e.g. Premium Brand Seekers',
        ];

        return (
            <div className="step-content animate-in">
                <DependencyContext deps={deps} />
                <p className="step-indicator">STEP 1 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Segment Brainstorm</h1>
                    <p className="step-hint">Map your market in three stages: brainstorm customer needs, cluster them, then define 5-7 MECE segments. These segment names flow into all subsequent steps.</p>
                </div>
                <LearnMore>
                    MECE stands for Mutually Exclusive, Collectively Exhaustive. Every customer belongs in exactly one segment (mutually exclusive), and together the segments cover your entire market (collectively exhaustive). The goal is not to describe demographics — it is to capture distinct behavioural needs. Start with what customers need, then cluster those needs into coherent groups, then name each group precisely.
                </LearnMore>

                <div style={{ background: '#000', color: '#FFF469', padding: '8px 16px', marginBottom: 20, fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.1em', textTransform: 'uppercase' }}>
                    STEP 1 OF 3 — NEEDS BRAINSTORM
                </div>

                <div style={{ marginBottom: 32 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                        <label className="field-label" style={{ margin: 0 }}>What different needs do your customers have?</label>
                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#999' }}>{data.needs.filter(n => n.trim()).length} / {data.needs.length}</span>
                    </div>
                    {data.needs.map((need, idx) => (
                        <div key={idx} className="activity-row">
                            <span className="activity-row-num">{String(idx+1).padStart(2,'0')}</span>
                            <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14, flex: 1 }}
                                value={need}
                                onChange={e => updateNeed(idx, e.target.value)}
                                placeholder={needPlaceholders[idx] || 'Add a customer need…'}
                            />
                            <button className="btn-remove" onClick={() => removeNeed(idx)} disabled={data.needs.length <= 5} style={{ opacity: data.needs.length <= 5 ? 0.2 : 1 }}>×</button>
                        </div>
                    ))}
                    {data.needs.length < 15 && (
                        <button className="btn-add" onClick={addNeed}>+ Add Need</button>
                    )}
                </div>

                <div style={{ background: '#000', color: '#FFF469', padding: '8px 16px', marginBottom: 20, fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.1em', textTransform: 'uppercase' }}>
                    STEP 2 OF 3 — NEED CLUSTERS
                </div>

                <div style={{ marginBottom: 32 }}>
                    <p className="field-help" style={{ marginBottom: 12 }}>Group the needs above into 5 clusters of similar themes.</p>
                    {data.clusters.map((cluster, idx) => (
                        <div key={idx} className="activity-row">
                            <span className="activity-row-num">{String(idx+1).padStart(2,'0')}</span>
                            <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14, flex: 1 }}
                                value={cluster}
                                onChange={e => updateCluster(idx, e.target.value)}
                                placeholder={clusterPlaceholders[idx] || 'Cluster name…'}
                            />
                        </div>
                    ))}
                </div>

                <div style={{ background: '#000', color: '#FFF469', padding: '8px 16px', marginBottom: 20, fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.1em', textTransform: 'uppercase' }}>
                    STEP 3 OF 3 — CORE SEGMENTS (MECE)
                </div>

                <div style={{ marginBottom: 24 }}>
                    <div style={{ background: '#FFFDE7', border: '1px solid #FFF469', borderLeft: '4px solid #FFF469', padding: '12px 16px', marginBottom: 16, fontSize: 13, color: '#333', lineHeight: 1.6 }}>
                        These names flow into all subsequent steps. Be specific and distinct. Each customer must belong to exactly one segment.
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                        <label className="field-label" style={{ margin: 0 }}>Final MECE Segment Names (5-7 required)</label>
                        {meceOk && (
                            <span style={{ background: '#22c55e', color: '#fff', fontFamily: "'Monument', monospace", fontSize: 9, letterSpacing: '0.1em', padding: '4px 10px', textTransform: 'uppercase' }}>
                                {namedSegs.length}+ SEGMENTS DEFINED ✓
                            </span>
                        )}
                    </div>
                    {data.segments.map((seg, idx) => (
                        <div key={idx} className="activity-row">
                            <span className="activity-row-num">{String(idx+1).padStart(2,'0')}</span>
                            <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14, flex: 1, borderColor: seg.trim().length >= 3 ? '#000' : '#E0E0E0' }}
                                value={seg}
                                onChange={e => updateSegment(idx, e.target.value)}
                                placeholder={segPlaceholders[idx] || 'Segment name…'}
                            />
                        </div>
                    ))}
                    <p className="field-help" style={{ marginTop: 8 }}>
                        {namedSegs.length} of 7 slots filled. Minimum 5 required.
                    </p>
                </div>

                {aiMessage && <div className="ai-message">{aiMessage}</div>}

                {meceOk && (
                    <div className="closing-box animate-in">
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[1].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[1].text}</p>
                    </div>
                )}
            </div>
        );
    }

    function Step2({ data, updateData, deps, aiMessage }) {
        const namedSegments = data.segments
            .map((name, idx) => ({ name, idx }))
            .filter(s => s.name.trim());

        const updateQuant = (segIdx, field, val) => {
            const next = data.quantification.map((q, i) => i === segIdx ? Object.assign({}, q, { [field]: val }) : q);
            updateData('quantification', next);
        };

        const sumField = (field) => namedSegments.reduce((acc, s) => {
            const v = parseFloat(data.quantification[s.idx][field] || 0);
            return acc + (isNaN(v) ? 0 : v);
        }, 0);

        const sumCust   = sumField('customers');
        const sumMarket = sumField('marketValue');
        const sumProfit = sumField('profit');

        const totalClass = (val) => {
            if (val >= 95 && val <= 105) return 'ok';
            if (val >= 80 && val < 95) return 'warn';
            return 'err';
        };

        const hasAnyFilled = namedSegments.some(s => {
            const q = data.quantification[s.idx];
            return String(q.customers).trim() || String(q.marketValue).trim() || String(q.profit).trim();
        });

        const tamContext = deps['Market Size (Sprint 12)'];

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">STEP 2 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Segment Quantification</h1>
                    <p className="step-hint">Put numbers behind each segment. Estimate what percentage of your total customer base, total market value, and total profit pool each segment represents.</p>
                </div>
                <LearnMore>
                    You do not need exact data — you need directionally correct estimates. Start with customers (easiest), then market value, then profit pool (hardest). Use the 70% rule: if you are 70% confident in a number, write it down. The goal is to reveal relative magnitudes, not produce a financial report. Columns should each sum to 100%. Disagreements between team members are a signal — not a problem. Debate reveals insight.
                </LearnMore>

                {tamContext && (
                    <div style={{ background: '#F0F9FF', border: '1px solid #BAE6FD', borderLeft: '4px solid #0EA5E9', padding: '12px 16px', marginBottom: 24, fontSize: 13, color: '#0C4A6E', lineHeight: 1.6 }}>
                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 9, textTransform: 'uppercase', letterSpacing: '0.1em', display: 'block', marginBottom: 4, color: '#0369A1' }}>MARKET SIZE FROM SPRINT 12</span>
                        {tamContext}
                    </div>
                )}

                <div style={{ background: '#F9F9F9', border: '1px solid #E0E0E0', borderLeft: '4px solid #666', padding: '10px 16px', marginBottom: 20, fontSize: 13, color: '#555', lineHeight: 1.5 }}>
                    Each column should sum to 100%. Use the 70% rule — estimates are fine. Green = 95-105%, Yellow = 80-95%, Red = outside that range.
                </div>

                {namedSegments.length === 0 && (
                    <div style={{ padding: 32, textAlign: 'center', color: '#999', border: '2px dashed #E0E0E0' }}>
                        No segments defined yet. Go back to Step 1 to define your segments.
                    </div>
                )}

                {namedSegments.map(function(seg) {
                    var name = seg.name;
                    var idx = seg.idx;
                    var q = data.quantification[idx];
                    return (
                        <div key={idx} className="quant-card">
                            <div className="quant-card-header">
                                <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 20, color: '#FFF469', minWidth: 32 }}>{String(idx+1).padStart(2,'0')}</span>
                                <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, letterSpacing: '0.08em', color: '#fff', textTransform: 'uppercase' }}>{name}</span>
                            </div>
                            <div className="quant-card-body">
                                <div className="quant-input-group">
                                    <label className="quant-input-label">% of Customers</label>
                                    <input type="number" min="0" max="100" className="field-input" style={{ padding: '8px 12px', fontSize: 15 }}
                                        value={q.customers}
                                        onChange={e => updateQuant(idx, 'customers', e.target.value)}
                                        placeholder="0"
                                    />
                                </div>
                                <div className="quant-input-group">
                                    <label className="quant-input-label">% of Market Value</label>
                                    <input type="number" min="0" max="100" className="field-input" style={{ padding: '8px 12px', fontSize: 15 }}
                                        value={q.marketValue}
                                        onChange={e => updateQuant(idx, 'marketValue', e.target.value)}
                                        placeholder="0"
                                    />
                                </div>
                                <div className="quant-input-group">
                                    <label className="quant-input-label">% of Profit Pool</label>
                                    <input type="number" min="0" max="100" className="field-input" style={{ padding: '8px 12px', fontSize: 15 }}
                                        value={q.profit}
                                        onChange={e => updateQuant(idx, 'profit', e.target.value)}
                                        placeholder="0"
                                    />
                                </div>
                            </div>
                        </div>
                    );
                })}

                {namedSegments.length > 0 && (
                    <div className="totals-row">
                        <div className="total-item">
                            <div className="total-label">Customers Total</div>
                            <div className={'total-value ' + totalClass(sumCust)}>{Math.round(sumCust)}%</div>
                        </div>
                        <div className="total-item">
                            <div className="total-label">Market Value Total</div>
                            <div className={'total-value ' + totalClass(sumMarket)}>{Math.round(sumMarket)}%</div>
                        </div>
                        <div className="total-item">
                            <div className="total-label">Profit Pool Total</div>
                            <div className={'total-value ' + totalClass(sumProfit)}>{Math.round(sumProfit)}%</div>
                        </div>
                    </div>
                )}

                {aiMessage && <div className="ai-message" style={{ marginTop: 16 }}>{aiMessage}</div>}

                {hasAnyFilled && (
                    <div className="closing-box animate-in" style={{ marginTop: 24 }}>
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[2].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[2].text}</p>
                    </div>
                )}
            </div>
        );
    }

    function Step3({ data, updateData, aiMessage }) {
        const [activeSegIdx, setActiveSegIdx] = useState(0);

        const namedSegments = data.segments
            .map((name, idx) => ({ name, idx }))
            .filter(s => s.name.trim());

        const baseFactors = [
            { key: 'marketSize',  label: 'Market Size',       desc: 'How large is this segment in absolute terms?' },
            { key: 'profitPool',  label: 'Profit Pool',       desc: 'How profitable are customers in this segment?' },
            { key: 'trend',       label: 'Growth Trend',      desc: 'Is this segment growing, stable, or shrinking?' },
            { key: 'strategyFit', label: 'Fit with Strategy', desc: 'How well does this segment match your value proposition?' },
        ];
        const FACTORS = data.customFactor && data.customFactor.trim()
            ? baseFactors.concat([{ key: 'custom', label: data.customFactor.trim(), desc: 'Your custom attractiveness factor.' }])
            : baseFactors;

        const SCORE_COLORS = ['#94a3b8', '#94a3b8', '#f59e0b', '#f59e0b', '#22c55e'];

        const updateWeight = (key, val) => {
            updateData('weights', Object.assign({}, data.weights, { [key]: val }));
        };
        const updateScore = (segIdx, factorKey, val) => {
            const next = data.scores.map((s, i) => i === segIdx ? Object.assign({}, s, { [factorKey]: val }) : s);
            updateData('scores', next);
        };

        const ranked = getRankedSegments(data);
        const scoredCount = namedSegments.filter(s => {
            const sc = data.scores[s.idx];
            return sc.marketSize > 0 || sc.profitPool > 0 || sc.trend > 0 || sc.strategyFit > 0 || sc.custom > 0;
        }).length;
        const hasScored = scoredCount > 0;

        const safeActiveIdx = Math.min(activeSegIdx, namedSegments.length - 1);
        const activeSeg = namedSegments[safeActiveIdx] || null;
        const activeScore = activeSeg ? data.scores[activeSeg.idx] : null;
        const activeTotalScore = activeSeg ? calcScore(data.weights, data.scores[activeSeg.idx], data.customFactor) : 0;

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">STEP 3 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Segment Ranking</h1>
                    <p className="step-hint">Score each segment on 4-5 attractiveness factors. The weighted total determines your ranking. Adjust factor weights to reflect your strategic priorities.</p>
                </div>
                <LearnMore>
                    The Attractiveness Index is a structured way to make an objective decision. Set the weight for each factor (1=least important, 5=most important), then score each segment on each factor (1=poor, 5=excellent). The weighted total reveals which segment is genuinely most attractive — often not the one the leadership team initially expected. Run the model first, then discuss.
                </LearnMore>

                <div style={{ border: '1px solid #E0E0E0', marginBottom: 28, padding: 20 }}>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 16 }}>FACTOR WEIGHTS (1 = least important, 5 = most important)</div>
                    {['marketSize','profitPool','trend','strategyFit'].map(key => {
                        var label = { marketSize: 'Market Size', profitPool: 'Profit Pool', trend: 'Growth Trend', strategyFit: 'Fit with Strategy' }[key];
                        return (
                            <div key={key} style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 10 }}>
                                <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#000', minWidth: 140, textTransform: 'uppercase', letterSpacing: '0.06em' }}>{label}</span>
                                <div style={{ display: 'flex', gap: 4 }}>
                                    {[1,2,3,4,5].map(v => (
                                        <RatingBtn key={v} label={String(v)} selected={data.weights[key] === v}
                                            color={v <= 2 ? '#94a3b8' : v <= 4 ? '#f59e0b' : '#22c55e'}
                                            onClick={() => updateWeight(key, v)} />
                                    ))}
                                </div>
                                <span style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#000', fontWeight: 'bold' }}>W={data.weights[key]}</span>
                            </div>
                        );
                    })}
                    <div style={{ display: 'flex', alignItems: 'center', gap: 12, marginTop: 8 }}>
                        <input type="text" className="field-input" style={{ flex: 1, padding: '8px 12px', fontSize: 13, maxWidth: 220 }}
                            value={data.customFactor}
                            onChange={e => updateData('customFactor', e.target.value)}
                            placeholder="Custom factor (optional)"
                        />
                        {data.customFactor.trim() && (
                            <React.Fragment>
                                <div style={{ display: 'flex', gap: 4 }}>
                                    {[1,2,3,4,5].map(v => (
                                        <RatingBtn key={v} label={String(v)} selected={data.weights.custom === v}
                                            color={v <= 2 ? '#94a3b8' : v <= 4 ? '#f59e0b' : '#22c55e'}
                                            onClick={() => updateWeight('custom', v)} />
                                    ))}
                                </div>
                                <span style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#000', fontWeight: 'bold' }}>W={data.weights.custom}</span>
                            </React.Fragment>
                        )}
                    </div>
                </div>

                {namedSegments.length === 0 ? (
                    <div style={{ padding: 32, textAlign: 'center', color: '#999', border: '2px dashed #E0E0E0' }}>
                        No segments defined. Go back to Step 1 to define your segments.
                    </div>
                ) : (
                    <React.Fragment>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>
                            SCORE SEGMENTS — {scoredCount}/{namedSegments.length} SCORED
                        </div>

                        <div className="tab-nav">
                            {namedSegments.map((s, tabIdx) => {
                                const sc = data.scores[s.idx];
                                const hasScore = sc.marketSize > 0 || sc.profitPool > 0 || sc.trend > 0 || sc.strategyFit > 0 || sc.custom > 0;
                                return (
                                    <button key={tabIdx}
                                        className={'tab-btn' + (safeActiveIdx === tabIdx ? ' active' : hasScore ? ' scored' : '')}
                                        onClick={() => setActiveSegIdx(tabIdx)}>
                                        {String(s.idx+1).padStart(2,'0')} {s.name.length > 12 ? s.name.slice(0,12) + '…' : s.name}
                                    </button>
                                );
                            })}
                        </div>

                        {activeSeg && activeScore && (
                            <div style={{ border: '1px solid #E0E0E0', padding: 20, marginBottom: 20 }}>
                                <div style={{ background: '#000', color: '#fff', padding: '12px 16px', marginBottom: 16, display: 'flex', alignItems: 'center', gap: 16 }}>
                                    <span className="plaak" style={{ fontSize: 28, color: '#FFF469' }}>{String(activeSeg.idx+1).padStart(2,'0')}</span>
                                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, letterSpacing: '0.08em', textTransform: 'uppercase' }}>{activeSeg.name}</span>
                                    <span style={{ marginLeft: 'auto', fontFamily: "'Monument', monospace", fontSize: 13, color: '#FFF469', fontWeight: 'bold' }}>
                                        TOTAL: {activeTotalScore}
                                    </span>
                                </div>
                                <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>
                                    SCORE 1 (POOR) TO 5 (EXCELLENT)
                                </div>
                                {FACTORS.map(factor => (
                                    <div key={factor.key} style={{ display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12, padding: '10px 0', borderBottom: '1px solid #F0F0F0' }}>
                                        <div style={{ flex: 1 }}>
                                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#000', textTransform: 'uppercase', letterSpacing: '0.06em', marginBottom: 2 }}>
                                                {factor.label} <span style={{ color: '#999', fontSize: 9 }}>(W={data.weights[factor.key]})</span>
                                            </div>
                                            <div style={{ fontSize: 11, color: '#999' }}>{factor.desc}</div>
                                        </div>
                                        <div style={{ display: 'flex', gap: 4 }}>
                                            {[1,2,3,4,5].map(v => (
                                                <RatingBtn key={v} label={String(v)}
                                                    selected={activeScore[factor.key] === v}
                                                    color={SCORE_COLORS[v-1]}
                                                    onClick={() => updateScore(activeSeg.idx, factor.key, v)} />
                                            ))}
                                        </div>
                                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#666', minWidth: 80, textAlign: 'right' }}>
                                            {activeScore[factor.key] > 0 ? (activeScore[factor.key] + ' x ' + data.weights[factor.key] + ' = ' + (activeScore[factor.key] * data.weights[factor.key])) : '—'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {ranked.length >= 2 && hasScored && (
                            <div style={{ border: '1px solid #E0E0E0', padding: 16, marginBottom: 20 }}>
                                <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>LIVE RANKING — SORTED BY WEIGHTED SCORE</div>
                                {ranked.map((s, rank) => (
                                    <div key={rank} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: '8px 0', borderBottom: rank < ranked.length - 1 ? '1px solid #F0F0F0' : 'none' }}>
                                        <span className="rank-badge">{rank+1}</span>
                                        <span style={{ fontSize: 14, flex: 1 }}>{s.name}</span>
                                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 13, fontWeight: 'bold', color: '#DC2626' }}>{s.score}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </React.Fragment>
                )}

                {aiMessage && <div className="ai-message">{aiMessage}</div>}

                {hasScored && (
                    <div className="closing-box animate-in">
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[3].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[3].text}</p>
                    </div>
                )}
            </div>
        );
    }

    function Step4({ data, updateData, aiMessage }) {
        const ranked     = getRankedSegments(data);
        const namedSegs  = data.segments.map((name, idx) => ({ name, idx })).filter(s => s.name.trim());
        const core       = ranked[0] || (namedSegs[0] ? Object.assign({}, namedSegs[0], { score: 0 }) : null);
        const secondary  = ranked[1] || (namedSegs[1] ? Object.assign({}, namedSegs[1], { score: 0 }) : null);

        const updateAdditional = (idx, val) => {
            const next = data.additionalTargets.slice();
            next[idx] = val;
            updateData('additionalTargets', next);
        };

        const canShow = data.targetDescription.trim().length >= 20 ||
            String(data.targetSalesShare3yr).trim() || String(data.targetProfitShare3yr).trim() ||
            String(data.targetSalesShare1yr).trim() || String(data.targetProfitShare1yr).trim();

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">STEP 4 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Target Setting</h1>
                    <p className="step-hint">Based on your ranking, set specific market share targets for your core and secondary segments — both 3-year and 1-year milestones.</p>
                </div>
                <LearnMore>
                    A target is only actionable when it has a number, a segment, and a timeframe. "We want to grow" is not a target. "We will capture 18% of the Budget-Conscious SME segment within 3 years" is a target. Your 1-year target should represent meaningful progress toward the 3-year ambition — typically 30-40% of the distance. The description below should paint a vivid picture of the customer you are winning.
                </LearnMore>

                {!core && (
                    <div style={{ padding: 32, textAlign: 'center', color: '#999', border: '2px dashed #E0E0E0', marginBottom: 24 }}>
                        No segments defined. Go back to Steps 1-3 to define and rank your segments.
                    </div>
                )}

                {core && (
                    <React.Fragment>
                        <div style={{ display: 'grid', gridTemplateColumns: secondary ? '1fr 1fr' : '1fr', gap: 16, marginBottom: 24 }}>
                            <div>
                                <div style={{ background: '#000', color: '#fff', padding: '14px 20px', display: 'flex', alignItems: 'center', gap: 16, marginBottom: 12 }}>
                                    <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 26, color: '#FFF469' }}>01</span>
                                    <div>
                                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 2 }}>CORE SEGMENT</div>
                                        <div style={{ fontSize: 15, fontWeight: 600 }}>{core.name}</div>
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 }}>
                                    <div>
                                        <label style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', display: 'block', marginBottom: 4 }}>3-Year Sales Share %</label>
                                        <input type="number" min="0" max="100" className="field-input" style={{ padding: '8px 12px', fontSize: 15 }}
                                            value={data.targetSalesShare3yr}
                                            onChange={e => updateData('targetSalesShare3yr', e.target.value)}
                                            placeholder="e.g. 18"
                                        />
                                    </div>
                                    <div>
                                        <label style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', display: 'block', marginBottom: 4 }}>3-Year Profit Share %</label>
                                        <input type="number" min="0" max="100" className="field-input" style={{ padding: '8px 12px', fontSize: 15 }}
                                            value={data.targetProfitShare3yr}
                                            onChange={e => updateData('targetProfitShare3yr', e.target.value)}
                                            placeholder="e.g. 22"
                                        />
                                    </div>
                                    <div>
                                        <label style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', display: 'block', marginBottom: 4 }}>1-Year Sales Target %</label>
                                        <input type="number" min="0" max="100" className="field-input" style={{ padding: '8px 12px', fontSize: 15 }}
                                            value={data.targetSalesShare1yr}
                                            onChange={e => updateData('targetSalesShare1yr', e.target.value)}
                                            placeholder="e.g. 8"
                                        />
                                    </div>
                                    <div>
                                        <label style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', display: 'block', marginBottom: 4 }}>1-Year Profit Target %</label>
                                        <input type="number" min="0" max="100" className="field-input" style={{ padding: '8px 12px', fontSize: 15 }}
                                            value={data.targetProfitShare1yr}
                                            onChange={e => updateData('targetProfitShare1yr', e.target.value)}
                                            placeholder="e.g. 10"
                                        />
                                    </div>
                                </div>
                            </div>

                            {secondary && (
                                <div>
                                    <div style={{ background: '#333', color: '#fff', padding: '14px 20px', display: 'flex', alignItems: 'center', gap: 16, marginBottom: 12 }}>
                                        <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 26, color: '#ccc' }}>02</span>
                                        <div>
                                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#888', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 2 }}>SECONDARY SEGMENT</div>
                                            <div style={{ fontSize: 15, fontWeight: 600 }}>{secondary.name}</div>
                                        </div>
                                    </div>
                                    <div style={{ background: '#F9F9F9', border: '1px solid #E0E0E0', padding: '16px', fontSize: 13, color: '#666', lineHeight: 1.6 }}>
                                        Secondary segment targets can be documented in the description below or as additional targets.
                                    </div>
                                </div>
                            )}
                        </div>

                        <div style={{ marginBottom: 24 }}>
                            <label className="field-label">Target Segment Description</label>
                            <p style={{ fontSize: 13, color: '#666', marginBottom: 8 }}>
                                Describe your ideal target customer in one clear paragraph. Include: who they are, what problem they have, and why they choose you.
                            </p>
                            <textarea className="field-textarea" style={{ minHeight: 140 }}
                                value={data.targetDescription}
                                onChange={e => updateData('targetDescription', e.target.value)}
                                placeholder="e.g. Our core target is the growth-stage B2B software company (€2-10M ARR) experiencing rapid scaling pains. They struggle with operational fragmentation — too many tools, unclear processes, no single source of truth. They choose us because we consolidate their critical workflows into one platform, reducing their operational overhead by 30% in 90 days. They are pragmatic buyers who value speed-to-value over feature depth."
                                maxLength={800}
                            />
                            <p className="field-help">{data.targetDescription.length}/800 characters</p>
                        </div>

                        <div style={{ marginBottom: 24 }}>
                            <label className="field-label">Additional Targets (optional)</label>
                            {data.additionalTargets.map((t, idx) => (
                                <div key={idx} className="activity-row" style={{ marginBottom: 8 }}>
                                    <span className="activity-row-num">{String(idx+1).padStart(2,'0')}</span>
                                    <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14, flex: 1 }}
                                        value={t}
                                        onChange={e => updateAdditional(idx, e.target.value)}
                                        placeholder={idx === 0 ? 'e.g. Achieve NPS > 60 in core segment within 12 months' : idx === 1 ? 'e.g. Win 3 enterprise reference customers by Q3' : 'e.g. Reduce churn in core segment to below 5% annually'}
                                    />
                                </div>
                            ))}
                        </div>
                    </React.Fragment>
                )}

                {aiMessage && <div className="ai-message">{aiMessage}</div>}

                {canShow && (
                    <div className="closing-box animate-in">
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[4].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[4].text}</p>
                    </div>
                )}
            </div>
        );
    }

    function CanvasStep({ data, onSubmit, submitState, aiMessage }) {
        const ranked    = getRankedSegments(data);
        const namedSegs = data.segments.map((name, idx) => ({ name, idx })).filter(s => s.name.trim());
        const core      = ranked[0] || null;
        const secondary = ranked[1] || null;

        const handlePrint = () => {
            const segRows = namedSegs.map(function(s) {
                var q = data.quantification[s.idx];
                var rank = ranked.findIndex(function(r) { return r.idx === s.idx; });
                return '<tr><td style="padding:8px 12px;border-bottom:1px solid #eee">' + s.name + '</td><td style="padding:8px 12px;border-bottom:1px solid #eee;text-align:center">' + (q.customers || '—') + (q.customers ? '%' : '') + '</td><td style="padding:8px 12px;border-bottom:1px solid #eee;text-align:center">' + (q.marketValue || '—') + (q.marketValue ? '%' : '') + '</td><td style="padding:8px 12px;border-bottom:1px solid #eee;text-align:center">' + (q.profit || '—') + (q.profit ? '%' : '') + '</td><td style="padding:8px 12px;border-bottom:1px solid #eee;text-align:center;font-weight:bold">' + (rank >= 0 ? rank + 1 : '—') + '</td></tr>';
            }).join('');
            const win = window.open('', '_blank');
            win.document.write('<!DOCTYPE html><html><head><title>Segmentation Canvas</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;padding:48px;color:#000}h1{font-size:28px;font-weight:bold;margin-bottom:32px}h2{font-size:11px;text-transform:uppercase;letter-spacing:0.1em;color:#666;margin-bottom:10px;border-bottom:2px solid #000;padding-bottom:6px}.section{margin-bottom:32px}table{width:100%;border-collapse:collapse}th{font-size:10px;text-transform:uppercase;letter-spacing:0.1em;color:#666;padding:8px 12px;border-bottom:2px solid #000;text-align:left}.desc{font-size:14px;line-height:1.7;color:#333;padding:16px;background:#F9F9F9}</style></head><body><h1>SEGMENTATION &amp; TARGET MARKET CANVAS</h1><div class="section"><h2>Segment Map</h2><table><thead><tr><th>Segment</th><th>% Customers</th><th>% Market Value</th><th>% Profit Pool</th><th>Rank</th></tr></thead><tbody>' + segRows + '</tbody></table></div><div class="section"><h2>3-Year Targets</h2><p class="desc">Sales: ' + (data.targetSalesShare3yr || '—') + '% | Profit: ' + (data.targetProfitShare3yr || '—') + '%</p></div><div class="section"><h2>1-Year Targets</h2><p class="desc">Sales: ' + (data.targetSalesShare1yr || '—') + '% | Profit: ' + (data.targetProfitShare1yr || '—') + '%</p></div><div class="section"><h2>Target Description</h2><p class="desc">' + (data.targetDescription || '—') + '</p></div></body></html>');
            win.document.close();
            win.print();
        };

        if (submitState === 'success') {
            return (
                <div className="step-content animate-in">
                    <div style={{ background: '#f0fdf4', border: '1px solid #86efac', padding: 48, textAlign: 'center', marginTop: 32 }}>
                        <div style={{ fontSize: 48, marginBottom: 16 }}>✓</div>
                        <h2 className="plaak" style={{ fontSize: 32, marginBottom: 16 }}>SUBMITTED</h2>
                        <p style={{ fontSize: 16, color: '#555', marginBottom: 32 }}>Your Segmentation &amp; Target Market Canvas has been saved. Your guru will review before Wednesday.</p>
                        <a href="/dashboard" style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#000', letterSpacing: '0.06em', textDecoration: 'underline' }}>← Back to Dashboard</a>
                    </div>
                </div>
            );
        }

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">CANVAS</p>
                <div className="opening-box">
                    <h1 className="step-heading">Segmentation Canvas</h1>
                    <p className="step-hint">Review your complete output. Download a PDF to share with your team, then submit your answers.</p>
                </div>

                <div style={{ border: '2px solid #000', marginBottom: 32 }}>
                    <div style={{ padding: '20px 24px', borderBottom: '1px solid #E0E0E0' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>SECTION 1 — SEGMENT MAP</div>
                        {namedSegs.length === 0 ? (
                            <p style={{ color: '#999', fontSize: 14 }}>No segments defined.</p>
                        ) : (
                            <table className="canvas-table">
                                <thead>
                                    <tr>
                                        <th>Segment</th>
                                        <th>% Customers</th>
                                        <th>% Market Value</th>
                                        <th>% Profit Pool</th>
                                        <th>Rank</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {namedSegs.map((s, i) => {
                                        const q    = data.quantification[s.idx];
                                        const rank = ranked.findIndex(r => r.idx === s.idx);
                                        return (
                                            <tr key={i} style={{ background: rank === 0 ? '#FFFDE7' : rank === 1 ? '#F9F9F9' : '#fff' }}>
                                                <td style={{ fontWeight: rank <= 1 && rank >= 0 ? 600 : 400 }}>{s.name}</td>
                                                <td style={{ textAlign: 'center' }}>{q.customers ? q.customers + '%' : '—'}</td>
                                                <td style={{ textAlign: 'center' }}>{q.marketValue ? q.marketValue + '%' : '—'}</td>
                                                <td style={{ textAlign: 'center' }}>{q.profit ? q.profit + '%' : '—'}</td>
                                                <td style={{ textAlign: 'center' }}>
                                                    {rank >= 0 ? (
                                                        <span style={{ background: rank === 0 ? '#000' : '#E0E0E0', color: rank === 0 ? '#FFF469' : '#000', fontFamily: "'Plaak', sans-serif", fontSize: 14, padding: '2px 8px' }}>
                                                            {rank+1}
                                                        </span>
                                                    ) : '—'}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        )}
                    </div>

                    <div style={{ padding: '20px 24px', borderBottom: '1px solid #E0E0E0' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>SECTION 2 — TOP SEGMENTS</div>
                        <div style={{ display: 'grid', gridTemplateColumns: secondary ? '1fr 1fr' : '1fr', gap: 16 }}>
                            {core && (
                                <div>
                                    <div style={{ background: '#000', color: '#fff', padding: '10px 16px', display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                                        <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 20, color: '#FFF469' }}>01</span>
                                        <div>
                                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#555', textTransform: 'uppercase' }}>CORE SEGMENT</div>
                                            <div style={{ fontSize: 14, fontWeight: 600 }}>{core.name}</div>
                                        </div>
                                        <span style={{ marginLeft: 'auto', fontFamily: "'Monument', monospace", fontSize: 11, color: '#FFF469' }}>Score: {core.score}</span>
                                    </div>
                                    <div style={{ fontSize: 13, color: '#333' }}>
                                        <div style={{ display: 'flex', gap: 8, marginBottom: 4 }}>
                                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', minWidth: 80 }}>Customers:</span>
                                            <span>{data.quantification[core.idx] && data.quantification[core.idx].customers ? data.quantification[core.idx].customers + '%' : '—'}</span>
                                        </div>
                                        <div style={{ display: 'flex', gap: 8, marginBottom: 4 }}>
                                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', minWidth: 80 }}>Mkt Value:</span>
                                            <span>{data.quantification[core.idx] && data.quantification[core.idx].marketValue ? data.quantification[core.idx].marketValue + '%' : '—'}</span>
                                        </div>
                                        <div style={{ display: 'flex', gap: 8 }}>
                                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', minWidth: 80 }}>Profit Pool:</span>
                                            <span>{data.quantification[core.idx] && data.quantification[core.idx].profit ? data.quantification[core.idx].profit + '%' : '—'}</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {secondary && (
                                <div>
                                    <div style={{ background: '#333', color: '#fff', padding: '10px 16px', display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 }}>
                                        <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 20, color: '#ccc' }}>02</span>
                                        <div>
                                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#888', textTransform: 'uppercase' }}>SECONDARY SEGMENT</div>
                                            <div style={{ fontSize: 14, fontWeight: 600 }}>{secondary.name}</div>
                                        </div>
                                        <span style={{ marginLeft: 'auto', fontFamily: "'Monument', monospace", fontSize: 11, color: '#ccc' }}>Score: {secondary.score}</span>
                                    </div>
                                    <div style={{ fontSize: 13, color: '#333' }}>
                                        <div style={{ display: 'flex', gap: 8, marginBottom: 4 }}>
                                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', minWidth: 80 }}>Customers:</span>
                                            <span>{data.quantification[secondary.idx] && data.quantification[secondary.idx].customers ? data.quantification[secondary.idx].customers + '%' : '—'}</span>
                                        </div>
                                        <div style={{ display: 'flex', gap: 8, marginBottom: 4 }}>
                                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', minWidth: 80 }}>Mkt Value:</span>
                                            <span>{data.quantification[secondary.idx] && data.quantification[secondary.idx].marketValue ? data.quantification[secondary.idx].marketValue + '%' : '—'}</span>
                                        </div>
                                        <div style={{ display: 'flex', gap: 8 }}>
                                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', minWidth: 80 }}>Profit Pool:</span>
                                            <span>{data.quantification[secondary.idx] && data.quantification[secondary.idx].profit ? data.quantification[secondary.idx].profit + '%' : '—'}</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div style={{ padding: '20px 24px', borderBottom: '1px solid #E0E0E0' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>SECTION 3 — MARKET SHARE TARGETS</div>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 16 }}>
                            {[
                                { label: '3-Year Sales', value: data.targetSalesShare3yr },
                                { label: '3-Year Profit', value: data.targetProfitShare3yr },
                                { label: '1-Year Sales', value: data.targetSalesShare1yr },
                                { label: '1-Year Profit', value: data.targetProfitShare1yr },
                            ].map((item, i) => (
                                <div key={i} style={{ border: '1px solid #E0E0E0', padding: 16, textAlign: 'center' }}>
                                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#666', textTransform: 'uppercase', marginBottom: 8 }}>{item.label}</div>
                                    <div style={{ fontFamily: "'Plaak', sans-serif", fontSize: 28, color: item.value ? '#000' : '#ccc' }}>
                                        {item.value ? item.value + '%' : '—'}
                                    </div>
                                </div>
                            ))}
                        </div>
                        {data.targetDescription && (
                            <div style={{ background: '#F9F9F9', border: '1px solid #E0E0E0', borderLeft: '4px solid #000', padding: '12px 16px', fontSize: 14, color: '#333', lineHeight: 1.7 }}>
                                {data.targetDescription}
                            </div>
                        )}
                        {data.additionalTargets.some(t => t.trim()) && (
                            <div style={{ marginTop: 12 }}>
                                <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 8 }}>ADDITIONAL TARGETS</div>
                                {data.additionalTargets.filter(t => t.trim()).map((t, i) => (
                                    <div key={i} style={{ display: 'flex', gap: 8, fontSize: 14, color: '#333', padding: '4px 0' }}>
                                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#999' }}>•</span>
                                        <span>{t}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>

                    <div style={{ padding: '24px 28px', background: '#000', color: '#fff' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>CASE STUDY — IKEA</div>
                        <p style={{ fontSize: 14, lineHeight: 1.8, color: '#ccc' }}>
                            IKEA did not choose 'furniture buyers' as their target segment. Through rigorous segmentation, they identified a behavioural segment that no competitor had named: <strong style={{ color: '#fff' }}>design-conscious buyers who could not afford luxury but refused mediocrity</strong>. This segment turned out to be the largest unserved group in the furniture market. IKEA's targeting precision — combined with a value proposition built specifically for that segment — is why they became a €40B company. Every strategic decision since then has been anchored to that one insight: who exactly are we serving, and what do they want that nobody else provides?
                        </p>
                    </div>
                </div>

                {aiMessage && <div className="ai-message" style={{ marginBottom: 16 }}>{aiMessage}</div>}

                <div style={{ display: 'flex', gap: 16 }}>
                    <button onClick={handlePrint} className="btn-wiz-back"
                        style={{ flex: 1, padding: 16, fontSize: 13, border: '2px solid #000', color: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>
                        ↓ DOWNLOAD PDF
                    </button>
                    <button onClick={onSubmit} disabled={submitState === 'saving'} className="btn-wiz-next"
                        style={{ flex: 2, padding: 16, fontSize: 13 }}>
                        {submitState === 'saving' ? 'SAVING…' : 'SUBMIT ANSWERS →'}
                    </button>
                </div>
            </div>
        );
    }

    function IntroPage({ onNext }) {
        return (
            <div style={{ background: '#000', color: '#fff', minHeight: '100vh', padding: '64px' }}>
                <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
                    <h1 className="plaak animate-in" style={{ fontSize: '100px', marginBottom: '64px' }}>
                        BEFORE WE START
                    </h1>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.08s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', color: '#FFF469', marginBottom: '24px' }}>SPRINT INFO</h2>
                        <div style={{ background: '#fff', color: '#000', padding: '32px' }}>
                            <p style={{ fontSize: '22px', fontWeight: 'bold', marginBottom: '16px' }}>Sprint 13: Segmentation &amp; Target Market</p>
                            <p style={{ fontSize: '18px', lineHeight: 1.6, marginBottom: '16px' }}>
                                This sprint transforms your market data into a ranked segment map and sets your market share ambitions. You will leave with 5-7 defined segments, a ranked attractiveness index, and specific 3-year and 1-year targets for your core and secondary segments.
                            </p>
                            <div style={{ borderLeft: '4px solid #000', paddingLeft: '16px', fontStyle: 'italic', fontSize: '16px' }}>
                                "Not all customers are created equal. The art of strategy is choosing who you serve — and who you do not." — Michael Porter
                            </div>
                        </div>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.1s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', marginBottom: '24px' }}>PURPOSE</h2>
                        <p style={{ fontSize: '22px', lineHeight: 1.6, marginBottom: '16px' }}>
                            Most companies try to serve every customer equally. This sprint forces the choice. By the end, you will know which segments drive the most value, which are most aligned with your strategy, and where your market share ambition should be anchored.
                        </p>
                        <p style={{ fontSize: '18px', color: '#999' }}>
                            Companies with clearly defined target segments achieve 2-3x higher conversion rates and 40% lower customer acquisition costs compared to those who target broadly.
                        </p>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.2s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', color: '#FFF469', marginBottom: '24px' }}>MISTAKES TO AVOID</h2>
                        <ul style={{ fontSize: '20px', listStyle: 'none', padding: 0 }}>
                            {[
                                'Segmenting by demographics instead of behaviours — use needs and behaviours, not age or region',
                                'Creating segments that overlap (not MECE) — each customer belongs in exactly one segment',
                                'Letting gut feeling override the ranking score — run the index, then discuss',
                                'Setting targets without a reference point — always anchor to % of the segment, not absolute ambition',
                            ].map((item, i) => (
                                <li key={i} style={{ display: 'flex', alignItems: 'flex-start', marginBottom: '16px' }}>
                                    <span style={{ fontSize: '32px', marginRight: '16px', lineHeight: 1, flexShrink: 0 }}>•</span>
                                    <span>{item}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '64px', animationDelay: '0.3s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', marginBottom: '32px' }}>THE JOURNEY</h2>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px', textAlign: 'center' }}>
                            {[
                                ['01', 'BRAINSTORM',    'Map needs, clusters, segments'],
                                ['02', 'QUANTIFY',      'Put numbers behind each segment'],
                                ['03', 'RANK',          'Score attractiveness and rank'],
                                ['04', 'TARGET',        'Set 1-year and 3-year targets'],
                            ].map(function(row) {
                                var num = row[0]; var title = row[1]; var sub = row[2];
                                return (
                                    <div key={num} style={{ border: '2px solid #fff', padding: '20px 12px' }}>
                                        <div className="plaak" style={{ fontSize: '52px', marginBottom: '12px' }}>{num}</div>
                                        <p style={{ fontWeight: 'bold', marginBottom: '6px', fontSize: '13px' }}>{title}</p>
                                        <p style={{ fontSize: '12px', color: '#999' }}>{sub}</p>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <button onClick={onNext} className="plaak"
                        style={{ width: '100%', padding: '32px', background: '#FFF469', color: '#000', border: 'none', fontSize: '28px', cursor: 'pointer', letterSpacing: '0.05em', transition: 'opacity 0.2s' }}>
                        LET'S START →
                    </button>
                </div>
            </div>
        );
    }

    function SegmentationApp() {
        const [step, setStep]               = useState(0);
        const [data, setData]               = useState(makeDefaultData());
        const [userId, setUserId]           = useState(null);
        const [deps, setDeps]               = useState({});
        const [authState, setAuthState]     = useState({ loading: true, authenticated: false, error: null });
        const [submitState, setSubmitState] = useState('idle');
        const [aiReviewing, setAiReviewing] = useState(false);
        const [aiMessage, setAiMessage]     = useState('');

        const totalSteps = CONFIG.TOTAL_STEPS;

        useEffect(() => {
            const { createClient } = supabase;
            window.supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
            ToolDB.init(CONFIG.TOOL_SLUG);

            ToolDB.whenReady().then(async () => {
                const uid = await ToolDB.identifyUser();
                if (!uid) {
                    setAuthState({ loading: false, authenticated: false, error: 'No active session found.' });
                    return;
                }
                setUserId(uid);
                setAuthState({ loading: false, authenticated: true, error: null });

                try {
                    const saved = await ToolDB.load(uid);
                    if (saved && Object.keys(saved).length > 0) {
                        setData(prev => {
                            const segsFromDB = saved.segments_list && saved.segments_list.length
                                ? saved.segments_list.concat(Array(Math.max(0, 7 - saved.segments_list.length)).fill(''))
                                : prev.segments;
                            return Object.assign({}, prev, {
                                needs:    saved.brainstorm_data ? (saved.brainstorm_data.needs    || prev.needs)    : prev.needs,
                                clusters: saved.brainstorm_data ? (saved.brainstorm_data.clusters || prev.clusters) : prev.clusters,
                                segments: segsFromDB,
                                quantification: saved.segment_quantification || prev.quantification,
                                weights:       saved.segment_ranking ? (saved.segment_ranking.weights      || prev.weights)      : prev.weights,
                                customFactor:  saved.segment_ranking ? (saved.segment_ranking.customFactor || prev.customFactor) : prev.customFactor,
                                scores:        saved.segment_ranking ? (saved.segment_ranking.scores       || prev.scores)       : prev.scores,
                                targetDescription:    saved.primary_target ? (saved.primary_target.description || '') : '',
                                targetSalesShare3yr:  saved.target_setting ? (saved.target_setting.salesShare3yr  || '') : '',
                                targetProfitShare3yr: saved.target_setting ? (saved.target_setting.profitShare3yr || '') : '',
                                targetSalesShare1yr:  saved.target_setting ? (saved.target_setting.salesShare1yr  || '') : '',
                                targetProfitShare1yr: saved.target_setting ? (saved.target_setting.profitShare1yr || '') : '',
                                additionalTargets:    saved.target_setting ? (saved.target_setting.additionalTargets || ['', '', '']) : ['', '', ''],
                            });
                        });
                    }
                } catch (_) {}

                try {
                    const tam = await ToolDB.getDependency(uid, 'market.size.tam');
                    if (tam) setDeps(d => Object.assign({}, d, { 'Market Size (Sprint 12)': typeof tam === 'string' ? tam : JSON.stringify(tam) }));
                } catch (_) {}
            });
        }, []);

        const updateData = useCallback((field, val) => {
            setData(prev => Object.assign({}, prev, { [field]: val }));
            setAiMessage('');
        }, []);

        const canProceed = () => {
            if (step === 1) return data.segments.filter(s => s.trim().length >= 3).length >= 5;
            if (step === 2) {
                const namedSegs = data.segments.map((name, idx) => ({ name, idx })).filter(s => s.name.trim());
                return namedSegs.some(s => {
                    const q = data.quantification[s.idx];
                    return String(q.customers).trim() || String(q.marketValue).trim() || String(q.profit).trim();
                });
            }
            if (step === 3) {
                return data.segments.some((name, idx) => {
                    if (!name.trim()) return false;
                    const sc = data.scores[idx];
                    return sc.marketSize > 0 || sc.profitPool > 0 || sc.trend > 0 || sc.strategyFit > 0 || sc.custom > 0;
                });
            }
            if (step === 4) {
                return data.targetDescription.trim().length >= 20 ||
                    String(data.targetSalesShare3yr).trim() || String(data.targetProfitShare3yr).trim() ||
                    String(data.targetSalesShare1yr).trim() || String(data.targetProfitShare1yr).trim();
            }
            return true;
        };

        const handleNext = async () => {
            setAiMessage('');
            if (!canProceed()) {
                if (step === 1) setAiMessage('Please define at least 5 distinct segment names (min 3 characters each) before continuing.');
                if (step === 2) setAiMessage('Please fill in at least one quantification field for at least one segment before continuing.');
                if (step === 3) setAiMessage('Please score at least one segment on at least one factor before continuing.');
                if (step === 4) setAiMessage('Please fill in your target description (min 20 characters) or at least one market share target before continuing.');
                return;
            }

            if (step === 1 && window.AIChallenge) {
                setAiReviewing(true);
                const ok = await window.AIChallenge.reviewStep(
                    userId,
                    CONFIG.TOOL_SLUG,
                    { market_segments: data.segments.filter(s => s.trim()).map((s, i) => (i+1) + '. ' + s).join('\n') },
                    'Market Segment Brainstorm'
                );
                setAiReviewing(false);
                if (!ok) return;
            }

            if (step === 2 && window.AIChallenge) {
                const namedSegs = data.segments.map((name, idx) => ({ name, idx })).filter(s => s.name.trim());
                const segData = namedSegs.map(s => {
                    const q = data.quantification[s.idx];
                    return s.name + ': ' + (q.customers||0) + '% customers, ' + (q.marketValue||0) + '% market value, ' + (q.profit||0) + '% profit';
                }).join('\n');
                setAiReviewing(true);
                const ok = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, { segment_quantification: segData }, 'Segment Quantification');
                setAiReviewing(false);
                if (!ok) return;
            }

            if (step === 3 && window.AIChallenge) {
                const rankData = getRankedSegments(data).map((s, i) => (i+1) + '. ' + s.name + ' — Score: ' + s.score).join('\n');
                setAiReviewing(true);
                const ok = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, { segment_ranking: rankData }, 'Segment Ranking');
                setAiReviewing(false);
                if (!ok) return;
            }

            if (step === 4 && window.AIChallenge) {
                setAiReviewing(true);
                const ok = await window.AIChallenge.reviewStep(
                    userId,
                    CONFIG.TOOL_SLUG,
                    {
                        target_description: data.targetDescription,
                        targets_3yr: 'Sales: ' + data.targetSalesShare3yr + '%, Profit: ' + data.targetProfitShare3yr + '%'
                    },
                    'Target Setting'
                );
                setAiReviewing(false);
                if (!ok) return;
            }

            setStep(step + 0.5);
        };

        const handleTransitionNext = () => {
            if (Math.floor(step) === totalSteps) {
                setStep('canvas');
            } else {
                setStep(Math.floor(step) + 1);
            }
        };

        const handleBack = () => {
            if (step === 'canvas') { setStep(totalSteps); return; }
            if (step === 1) { setStep(0.5); return; }
            if (typeof step === 'number') setStep(step - 1);
        };

        const handleSubmit = async () => {
            setSubmitState('saving');
            try {
                const ranked = getRankedSegments(data);
                await ToolDB.save(userId, {
                    brainstorm_data: { needs: data.needs, clusters: data.clusters },
                    segments_list:   data.segments.filter(s => s.trim()),
                    segment_quantification: data.quantification,
                    segment_ranking: { weights: data.weights, customFactor: data.customFactor, scores: data.scores },
                    primary_target: {
                        core: ranked[0] ? Object.assign({ name: ranked[0].name, score: ranked[0].score }, data.quantification[ranked[0].idx]) : null,
                        secondary: ranked[1] ? Object.assign({ name: ranked[1].name, score: ranked[1].score }, data.quantification[ranked[1].idx]) : null,
                        description: data.targetDescription,
                    },
                    target_setting: {
                        salesShare3yr:     data.targetSalesShare3yr,
                        profitShare3yr:    data.targetProfitShare3yr,
                        salesShare1yr:     data.targetSalesShare1yr,
                        profitShare1yr:    data.targetProfitShare1yr,
                        additionalTargets: data.additionalTargets,
                    }
                });
                await ToolDB.markComplete(userId);
                setSubmitState('success');
            } catch (err) {
                console.error('[Segmentation] Submit error:', err);
                setSubmitState('error');
                setAiMessage('Submission failed. Please try again.');
            }
        };

        const isTransition = step === 1.5 || step === 2.5 || step === 3.5 || step === 4.5;

        return (
            <div className="tool-frame">
                {authState.loading && (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase' }}>Loading…</div>
                    </div>
                )}

                {!authState.loading && !authState.authenticated && (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <div style={{ textAlign: 'center', color: '#fff', padding: '0 32px', maxWidth: 640 }}>
                            <h1 className="plaak" style={{ fontSize: 48, marginBottom: 24 }}>AUTHENTICATION REQUIRED</h1>
                            <p style={{ fontSize: 20, marginBottom: 32 }}>Please access this tool from your LearnWorlds course.</p>
                            <p style={{ fontSize: 16, color: '#999' }}>{authState.error || 'No active session found'}</p>
                        </div>
                    </div>
                )}

                {step === 0 && authState.authenticated && (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                        <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url(' + CONFIG.COVER_IMAGE + ')', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.4 }} />
                        <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#FFF469', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 24 }}>
                                SPRINT 13 / MODULE 3 — MARKET
                            </div>
                            <h1 className="plaak" style={{ fontSize: 72, marginBottom: 16 }}>{CONFIG.TOOL_TITLE}</h1>
                            <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48, maxWidth: 560, margin: '0 auto 48px' }}>{CONFIG.TOOL_SUBTITLE}</p>
                            <button onClick={() => setStep(0.5)}
                                style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s' }}
                                onMouseOver={e => { e.currentTarget.style.background = '#FFF469'; }}
                                onMouseOut={e => { e.currentTarget.style.background = '#fff'; }}>
                                START
                            </button>
                        </div>
                    </div>
                )}

                {step === 0.5 && authState.authenticated && (
                    <IntroPage onNext={() => setStep(1)} />
                )}

                {isTransition && (
                    <TransitionScreen stepNum={Math.floor(step)} onNext={handleTransitionNext} />
                )}

                {Number.isInteger(step) && step >= 1 && step <= totalSteps && (
                    <div className="tool-inner">
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={step} totalSteps={totalSteps} />
                                <div style={{ flex: 1 }}>
                                    {step === 1 && <Step1 data={data} updateData={updateData} deps={deps} aiMessage={aiMessage} />}
                                    {step === 2 && <Step2 data={data} updateData={updateData} deps={deps} aiMessage={aiMessage} />}
                                    {step === 3 && <Step3 data={data} updateData={updateData} aiMessage={aiMessage} />}
                                    {step === 4 && <Step4 data={data} updateData={updateData} aiMessage={aiMessage} />}
                                </div>
                                <div className="wizard-footer">
                                    <button className="btn-wiz-back" onClick={handleBack}>← BACK</button>
                                    <button className="btn-wiz-next" onClick={handleNext} disabled={aiReviewing}>
                                        {aiReviewing ? 'REVIEWING…' : 'NEXT →'}
                                    </button>
                                </div>
                            </div>
                            <WizardSidebar
                                currentStep={step}
                                data={data}
                                onNavigate={s => { setStep(s); setAiMessage(''); }}
                            />
                        </div>
                    </div>
                )}

                {step === 'canvas' && (
                    <div className="tool-inner">
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={totalSteps + 1} totalSteps={totalSteps} />
                                <div style={{ flex: 1 }}>
                                    <CanvasStep data={data} onSubmit={handleSubmit} submitState={submitState} aiMessage={aiMessage} />
                                </div>
                                {submitState !== 'success' && (
                                    <div className="wizard-footer">
                                        <button className="btn-wiz-back" onClick={handleBack}>← BACK</button>
                                    </div>
                                )}
                            </div>
                            <WizardSidebar
                                currentStep="canvas"
                                data={data}
                                onNavigate={s => { setStep(s); setAiMessage(''); }}
                            />
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.render(<SegmentationApp />, document.getElementById('root'));
</script>
</body>
</html>
