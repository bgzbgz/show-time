<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Agile Teams | Fast Track Program</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>

    <style>
        @font-face { font-family: 'Plaak';    src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; }
        @font-face { font-family: 'Riforma';  src: url('RiformaLL-Regular.woff2')   format('woff2'); font-weight: normal; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Riforma', -apple-system, sans-serif; font-size: 16px; color: #000; background: #000; -webkit-font-smoothing: antialiased; }

        .plaak   { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main { flex: 1; display: flex; flex-direction: column; min-height: 100vh; background: #fff; padding: 0 48px; }
        .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }

        .step-content { max-width: 100%; padding: 40px 0; flex: 1; }
        .step-indicator { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 8px; }
        .opening-box { margin-bottom: 32px; }
        .opening-box .step-heading { font-family: 'Plaak', sans-serif; font-weight: bold; font-size: 32px; letter-spacing: -0.01em; line-height: 1.2; color: #000; margin-bottom: 6px; }
        .opening-box .step-hint { font-size: 14px; color: #666; line-height: 1.5; margin: 0; }

        .field-group { margin-bottom: 40px; }
        .field-group:last-child { margin-bottom: 0; }
        .field-label { font-weight: 600; font-size: 16px; color: #000; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .field-input { border: 1px solid #E0E0E0; padding: 12px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; width: 100%; color: #000; background: #fff; transition: border-color 0.2s; }
        .field-input:focus { outline: none; border-color: #000; }
        .field-textarea { border: 1px solid #E0E0E0; padding: 12px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; width: 100%; min-height: 100px; resize: none !important; color: #000; background: #fff; transition: border-color 0.2s; }
        .field-textarea:focus { outline: none; border-color: #000; }
        .field-help { font-size: 13px; color: #666; margin-top: 4px; }

        .closing-box { border-top: 1px solid #E0E0E0; padding: 20px 0 0 0; margin-top: 8px; text-align: center; }
        .closing-box p { font-size: 14px; color: #666; }
        .closing-box .closing-title { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #000; margin-bottom: 6px; }

        .wizard-footer { display: flex; justify-content: space-between; align-items: center; padding: 24px 48px; border-top: 1px solid #e5e7eb; background: #fff; }
        .btn-wiz-back { background: transparent; border: 2px solid #d1d5db; color: #6b7280; padding: 12px 28px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-wiz-back:hover { border-color: #000; color: #000; }
        .btn-wiz-next { background: #000; color: #fff; border: 2px solid #000; padding: 12px 36px; font-family: 'Monument', monospace; font-size: 12px; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.2s; }
        .btn-wiz-next:hover:not(:disabled) { background: #FFF469; color: #000; border-color: #FFF469; }
        .btn-wiz-next:disabled { background: #E0E0E0; color: #9CA3AF; border-color: #E0E0E0; cursor: not-allowed; }

        .learn-more-toggle { font-family: 'Monument', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: #000; background: #F5F5F5; border: 1px solid #E0E0E0; cursor: pointer; padding: 10px 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 24px; width: 100%; }
        .learn-more-content { background: #F5F5F5; border: 1px solid #E0E0E0; border-top: none; padding: 16px; font-size: 14px; color: #333; line-height: 1.7; margin-bottom: 24px; }

        .activity-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
        .activity-row-num { font-family: 'Monument', monospace; font-size: 11px; color: #999; min-width: 24px; }
        .btn-remove { background: none; border: none; color: #999; cursor: pointer; font-size: 18px; padding: 4px 8px; transition: color 0.2s; flex-shrink: 0; }
        .btn-remove:hover { color: #DC2626; }
        .btn-add { width: 100%; padding: 10px 0; border: 2px dashed #E0E0E0; background: none; font-family: 'Monument', monospace; font-size: 12px; color: #666; letter-spacing: 0.05em; text-transform: uppercase; cursor: pointer; margin-top: 4px; transition: all 0.2s; }
        .btn-add:hover { border-color: #000; color: #000; }

        .sidebar-tool-num { font-family: 'Monument', monospace; font-size: 10px; color: #555; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 8px; }
        .sidebar-tool-title { font-family: 'Plaak', sans-serif; font-size: 22px; color: #fff; margin-bottom: 32px; line-height: 1.1; }
        .sidebar-step { padding: 8px 0; border-bottom: 1px solid #2a2a2a; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: opacity 0.2s; }
        .sidebar-step:last-child { border-bottom: none; }
        .sidebar-step-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; flex-shrink: 0; transition: background 0.2s; }
        .sidebar-step-dot.active { background: #FFF469; }
        .sidebar-step-dot.done   { background: #4ade80; }
        .sidebar-step-label { font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.08em; color: #555; text-transform: uppercase; transition: color 0.2s; }
        .sidebar-step-label.active { color: #FFF469; }
        .sidebar-step-label.done   { color: #4ade80; }
        .sidebar-activity-list { margin-top: 24px; border-top: 1px solid #2a2a2a; padding-top: 16px; }
        .sidebar-activity-item { font-size: 12px; color: #555; padding: 4px 0; line-height: 1.4; display: flex; gap: 8px; }
        .sidebar-activity-item.filled { color: #ccc; }
        .sidebar-activity-idx { font-family: 'Monument', monospace; font-size: 10px; color: #FFF469; flex-shrink: 0; }

        .mobile-step-bar { display: none; }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .wizard-main { padding: 0 24px; }
            .mobile-step-bar { display: flex; align-items: center; gap: 8px; padding: 16px 24px; background: #1a1a1a; }
            .mobile-step-dot { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: background 0.2s; }
            .mobile-step-dot.active { background: #FFF469; }
            .mobile-step-dot.done   { background: #4ade80; }
            .mobile-step-text { font-family: 'Monument', monospace; font-size: 11px; color: #fff; letter-spacing: 0.06em; }
            .wizard-footer { padding: 16px 24px; }
        }

        .animate-in { animation: fadeSlideIn 0.4s ease both; }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        .ai-message { background: #FFF9C4; border: 1px solid #FFF469; border-left: 4px solid #FFF469; padding: 12px 16px; font-size: 14px; color: #333; margin-bottom: 16px; line-height: 1.6; }

        .tab-nav { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 20px; }
        .tab-btn { padding: 6px 14px; font-family: 'Monument', monospace; font-size: 10px; letter-spacing: 0.06em; cursor: pointer; border: 2px solid #E0E0E0; background: #fff; color: #999; transition: all 0.2s; text-transform: uppercase; }
        .tab-btn.active { background: #000; color: #FFF469; border-color: #000; }
        .tab-btn.done   { background: #F0F0F0; color: #000; border-color: #000; }

        .canvas-table { width: 100%; border-collapse: collapse; margin-bottom: 4px; }
        .canvas-table th { font-family: 'Monument', monospace; font-size: 9px; text-transform: uppercase; letter-spacing: 0.1em; color: #666; padding: 8px 12px; border-bottom: 2px solid #000; text-align: left; }
        .canvas-table td { padding: 10px 12px; border-bottom: 1px solid #E0E0E0; font-size: 14px; }
        .canvas-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const CONFIG = {
        TOOL_SLUG:    'agile-teams',
        TOOL_TITLE:   'SET AGILE TEAMS',
        TOOL_SUBTITLE:'Prioritise your biggest organisational challenges, then charter the agile squads to solve them.',
        COVER_IMAGE:  'https://images.unsplash.com/photo-1552664730-d307ca884978?w=1600&q=80',
        TOTAL_STEPS:  2,
        SUPABASE_URL:     'https://lutzzfaedkbsmbobmrzx.supabase.co',
        SUPABASE_ANON_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
        TRANSITION_CONTENT: {
            1: {
                brutalTruth: 'In most organisations, up to 80% of project time is consumed not by doing work but by waiting — on approvals, budgets, legal sign-offs, and planning cycles. Your teams are not slow because they lack talent. They are slow because the system was designed for control, not speed. The highest-scoring challenge on your matrix is the exact bottleneck costing you most right now.',
                peerProof: '"A €30M manufacturing firm ran the Impact/Ease Matrix and found their top-scoring initiative was something every team lead already knew about but nobody had been empowered to tackle. Three weeks after chartering an agile squad, the bottleneck that had cost them €400K per quarter was resolved."'
            },
            2: {
                brutalTruth: 'A team charter without a specific end-game is just a meeting. The squads that fail have vague missions — improve customer service, grow revenue. The squads that win have a single measurable metric, a hard deadline, and a team of 4–6 people who cannot pass the work to anyone else. One squad. One mission. No handoffs.',
                peerProof: '"We gave one squad a mission: reduce customer onboarding from 14 days to 5 days within 90 days. No approval chains, defined budget, 5 people. They hit 6 days in 60. The same change had been on our roadmap for 3 years with zero movement."'
            }
        },
        CLOSING_MESSAGES: {
            1: { title: 'TOP 3 IDENTIFIED',  text: 'Your priorities are clear. Now build the teams that will move them.' },
            2: { title: 'CHARTERS DRAFTED',  text: 'Three squads. Three missions. Time to build your canvas.' },
        }
    };

    const itemScore = (item) => (item.impact || 0) + (item.ease || 0);

    const makeDefaultData = () => ({
        items: Array(10).fill(null).map(() => ({ challenge: '', impact: 0, ease: 0 })),
        charters: Array(3).fill(null).map(() => ({
            endGame: '',
            rules: '',
            roles: ['', '', '', ''],
            kpis:  ['', '', '', ''],
        })),
    });

    const getTop3 = (items) =>
        items
            .map((item, idx) => Object.assign({}, item, { idx, score: itemScore(item) }))
            .filter(item => item.challenge.trim() && item.score > 0)
            .sort((a, b) => b.score - a.score)
            .slice(0, 3);

    // ── WizardSidebar ─────────────────────────────────────────────────────────
    function WizardSidebar({ currentStep, data, onNavigate }) {
        const steps = [
            { num: 1, label: 'Impact/Ease Matrix' },
            { num: 2, label: 'Team Charters' },
            { num: 'canvas', label: 'Canvas' },
        ];
        const top3 = getTop3(data.items);
        return (
            <div className="wizard-sidebar">
                <div className="sidebar-tool-num">SPRINT 27</div>
                <div className="sidebar-tool-title">{CONFIG.TOOL_TITLE}</div>
                {steps.map(s => {
                    const isCanvas = s.num === 'canvas';
                    const isDone   = isCanvas ? false : (typeof currentStep === 'number' && currentStep > s.num);
                    const isActive = isCanvas ? currentStep === 'canvas' : (typeof currentStep === 'number' && Math.floor(currentStep) === s.num);
                    const isFuture = isCanvas ? false : (typeof currentStep === 'number' && currentStep < s.num);
                    return (
                        <div key={String(s.num)} className="sidebar-step"
                            onClick={() => isDone && onNavigate(s.num)}
                            style={{ opacity: isFuture ? 0.35 : 1, cursor: isDone ? 'pointer' : 'default' }}>
                            <div className={'sidebar-step-dot' + (isActive ? ' active' : isDone ? ' done' : '')} />
                            <span className={'sidebar-step-label' + (isActive ? ' active' : isDone ? ' done' : '')}>{s.label}</span>
                        </div>
                    );
                })}
                {top3.length > 0 && (
                    <div className="sidebar-activity-list">
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 8 }}>TOP 3 INITIATIVES</div>
                        {top3.map((item, i) => (
                            <div key={i} className="sidebar-activity-item filled">
                                <span className="sidebar-activity-idx">{String(i+1).padStart(2,'0')}</span>
                                <span>{item.challenge.length > 26 ? item.challenge.slice(0, 26) + '…' : item.challenge}</span>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    }

    // ── MobileStepBar ─────────────────────────────────────────────────────────
    function MobileStepBar({ currentStep, totalSteps }) {
        const stepNum = typeof currentStep === 'number' ? currentStep : totalSteps + 1;
        return (
            <div className="mobile-step-bar">
                <span className="mobile-step-text">STEP {Math.ceil(stepNum)} OF {totalSteps}</span>
                {Array.from({ length: totalSteps }, (_, i) => {
                    const n = i + 1;
                    const isDone   = typeof currentStep === 'number' && currentStep > n;
                    const isActive = typeof currentStep === 'number' && Math.floor(currentStep) === n;
                    return <div key={n} className={'mobile-step-dot' + (isActive ? ' active' : isDone ? ' done' : '')} />;
                })}
            </div>
        );
    }

    // ── LearnMore ─────────────────────────────────────────────────────────────
    function LearnMore({ children }) {
        const [open, setOpen] = useState(false);
        return (
            <React.Fragment>
                <button className="learn-more-toggle" onClick={() => setOpen(o => !o)}>
                    <span>{open ? '▲' : '▼'}</span> {open ? 'Hide context' : 'Why this matters'}
                </button>
                {open && <div className="learn-more-content">{children}</div>}
            </React.Fragment>
        );
    }

    // ── TransitionScreen ──────────────────────────────────────────────────────
    function TransitionScreen({ stepNum, onNext }) {
        const t = CONFIG.TRANSITION_CONTENT[stepNum];
        if (!t) { onNext(); return null; }
        return (
            <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', zIndex: 200, overflowY: 'auto', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '64px 32px' }}>
                <div style={{ maxWidth: 720, width: '100%' }} className="animate-in">
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#555', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 32 }}>
                        SPRINT 27 — SET AGILE TEAMS
                    </div>
                    <div style={{ borderLeft: '4px solid #DC2626', paddingLeft: 24, marginBottom: 48 }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#DC2626', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 12 }}>BRUTAL TRUTH</div>
                        <p className="plaak" style={{ fontSize: 26, lineHeight: 1.35 }}>{t.brutalTruth}</p>
                    </div>
                    <div style={{ borderLeft: '4px solid #FFF469', paddingLeft: 24, marginBottom: 64 }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 12 }}>PEER PROOF</div>
                        <p style={{ fontSize: 18, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                    </div>
                    <button onClick={onNext} className="plaak"
                        style={{ background: '#FFF469', color: '#000', border: 'none', padding: '18px 48px', fontSize: 18, cursor: 'pointer', letterSpacing: '0.05em', transition: 'all 0.2s' }}>
                        CONTINUE →
                    </button>
                </div>
            </div>
        );
    }

    // ── RatingBtn ─────────────────────────────────────────────────────────────
    function RatingBtn({ label, selected, color, onClick }) {
        return (
            <button onClick={onClick} style={{
                padding: '5px 11px',
                border: '2px solid ' + (selected ? color : '#E0E0E0'),
                background: selected ? color : '#fff',
                color: selected ? (color === '#FFF469' ? '#000' : '#fff') : '#999',
                fontFamily: "'Monument', monospace",
                fontSize: 10,
                letterSpacing: '0.05em',
                cursor: 'pointer',
                transition: 'all 0.15s',
                textTransform: 'uppercase',
                whiteSpace: 'nowrap',
            }}>{label}</button>
        );
    }

    // ── STEP 1: Impact / Ease Matrix ──────────────────────────────────────────
    function Step1({ data, updateData, aiMessage }) {
        const items = data.items;
        const filled = items.filter(a => a.challenge.trim()).length;

        const updateItem = (idx, field, val) => {
            const next = items.map((item, i) => i === idx ? Object.assign({}, item, { [field]: val }) : item);
            updateData('items', next);
        };
        const addRow = () => {
            if (items.length < 20) updateData('items', items.concat([{ challenge: '', impact: 0, ease: 0 }]));
        };
        const removeRow = (idx) => {
            if (items.length <= 8) return;
            updateData('items', items.filter((_, i) => i !== idx));
        };

        const IMPACT_OPTS = [
            { label: '1 Low',  val: 1, color: '#94a3b8' },
            { label: '2 Med',  val: 2, color: '#f59e0b' },
            { label: '3 High', val: 3, color: '#22c55e' },
        ];
        const EASE_OPTS = [
            { label: '1 Hard', val: 1, color: '#DC2626' },
            { label: '2 Med',  val: 2, color: '#f59e0b' },
            { label: '3 Easy', val: 3, color: '#22c55e' },
        ];

        const scored = items
            .map((item, i) => Object.assign({}, item, { idx: i, score: itemScore(item) }))
            .filter(item => item.challenge.trim())
            .sort((a, b) => b.score - a.score);

        const top3Idxs = new Set(scored.slice(0, 3).map(s => s.idx));

        const PLACEHOLDERS = [
            'e.g. Slow customer onboarding process',
            'e.g. High product return rates',
            'e.g. Untested new market opportunity',
            'e.g. Recurring approval bottlenecks',
            'e.g. Misaligned team priorities',
            'e.g. Manual reporting consuming too much time',
            'e.g. Poor cross-functional coordination',
            'e.g. Outdated pricing model',
            'e.g. Low NPS in key customer segment',
            'e.g. Unclear decision ownership',
        ];

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">STEP 1 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Impact / Ease Matrix</h1>
                    <p className="step-hint">List at least 8 organisational challenges or growth opportunities. Rate each by impact and ease. The top 3 highest-scoring items automatically become your agile team initiatives.</p>
                </div>
                <LearnMore>
                    Impact (1–3): How big a difference will solving this make to the business? Ease (1–3): How quickly and cheaply can you tackle it? Score = Impact + Ease. Maximum is 6. The highest-scoring items are your best candidates — high impact, high feasibility. Be honest about ease: overrating it is the most common mistake. If in doubt, rate it lower.
                </LearnMore>

                <div style={{ display: 'flex', gap: 8, alignItems: 'center', marginBottom: 8, padding: '0 0 10px', borderBottom: '2px solid #000' }}>
                    <span style={{ minWidth: 28 }}></span>
                    <span style={{ flex: 1, fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.08em' }}>Challenge / Opportunity</span>
                    <div style={{ minWidth: 185, textAlign: 'center' }}>
                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#22c55e', textTransform: 'uppercase', letterSpacing: '0.08em' }}>IMPACT</span>
                    </div>
                    <div style={{ width: 1, height: 14, background: '#E0E0E0', flexShrink: 0 }}></div>
                    <div style={{ minWidth: 185, textAlign: 'center' }}>
                        <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#f59e0b', textTransform: 'uppercase', letterSpacing: '0.08em' }}>EASE</span>
                    </div>
                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.08em', minWidth: 48, textAlign: 'center' }}>Score</span>
                    <span style={{ minWidth: 28 }}></span>
                </div>

                {items.map((item, idx) => {
                    const score = itemScore(item);
                    const isTop3 = item.challenge.trim() && top3Idxs.has(idx);
                    const scoreColor = score >= 5 ? '#22c55e' : score === 4 ? '#f59e0b' : score > 0 ? '#94a3b8' : '#ddd';
                    return (
                        <div key={idx} style={{ display: 'flex', gap: 8, alignItems: 'center', marginBottom: 10, padding: '10px 8px', background: isTop3 ? '#FFFDE7' : '#fff', border: '1px solid ' + (isTop3 ? '#FFF469' : '#E0E0E0'), transition: 'all 0.2s' }}>
                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: isTop3 ? '#000' : '#bbb', minWidth: 28 }}>{String(idx+1).padStart(2,'0')}</span>
                            <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14, flex: 1 }}
                                value={item.challenge}
                                onChange={e => updateItem(idx, 'challenge', e.target.value)}
                                placeholder={PLACEHOLDERS[idx] || 'Add a challenge or opportunity…'}
                            />
                            <div style={{ display: 'flex', gap: 3, minWidth: 185, justifyContent: 'center' }}>
                                {IMPACT_OPTS.map(o => (
                                    <RatingBtn key={o.val} label={o.label} selected={item.impact === o.val} color={o.color}
                                        onClick={() => updateItem(idx, 'impact', o.val)} />
                                ))}
                            </div>
                            <div style={{ width: 1, height: 32, background: '#E0E0E0', flexShrink: 0 }}></div>
                            <div style={{ display: 'flex', gap: 3, minWidth: 185, justifyContent: 'center' }}>
                                {EASE_OPTS.map(o => (
                                    <RatingBtn key={o.val} label={o.label} selected={item.ease === o.val} color={o.color}
                                        onClick={() => updateItem(idx, 'ease', o.val)} />
                                ))}
                            </div>
                            <div style={{ textAlign: 'center', fontFamily: "'Monument', monospace", fontSize: score >= 5 ? 18 : 14, fontWeight: score >= 5 ? 'bold' : 'normal', color: scoreColor, minWidth: 48, transition: 'all 0.2s' }}>
                                {score > 0 ? score : '—'}
                            </div>
                            <button className="btn-remove" onClick={() => removeRow(idx)} disabled={items.length <= 8} style={{ opacity: items.length <= 8 ? 0.2 : 1, minWidth: 28 }}>×</button>
                        </div>
                    );
                })}

                {items.length < 20 && (
                    <button className="btn-add" onClick={addRow} style={{ marginTop: 4 }}>+ Add Challenge</button>
                )}

                <p className="field-help" style={{ marginTop: 12 }}>
                    {filled} items added (min 8). Highlighted rows = current Top 3 → these become your agile team charters in the next step.
                </p>

                {scored.length >= 3 && (
                    <div style={{ marginTop: 24, border: '1px solid #E0E0E0', padding: 16 }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>CURRENT TOP 3 BY SCORE</div>
                        {scored.slice(0, 3).map((item, rank) => (
                            <div key={rank} style={{ display: 'flex', alignItems: 'center', gap: 12, padding: '6px 0', borderBottom: rank < 2 ? '1px solid #F0F0F0' : 'none' }}>
                                <span style={{ fontFamily: "'Plaak', sans-serif", fontSize: 20, color: '#FFF469', background: '#000', padding: '2px 8px', minWidth: 36, textAlign: 'center' }}>{rank+1}</span>
                                <span style={{ fontSize: 13, flex: 1 }}>{item.challenge}</span>
                                <span style={{ fontFamily: "'Monument', monospace", fontSize: 12, fontWeight: 'bold', color: '#DC2626' }}>{item.score}</span>
                            </div>
                        ))}
                    </div>
                )}

                {aiMessage && <div className="ai-message" style={{ marginTop: 16 }}>{aiMessage}</div>}

                {filled >= 8 && scored.length >= 3 && (
                    <div className="closing-box animate-in" style={{ marginTop: 24 }}>
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[1].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[1].text}</p>
                    </div>
                )}
            </div>
        );
    }

    // ── STEP 2: Team Charters ─────────────────────────────────────────────────
    function Step2({ data, updateData, aiMessage }) {
        const [activeIdx, setActiveIdx] = useState(0);
        const top3 = getTop3(data.items);

        const updateCharter = (charterIdx, field, val) => {
            const next = data.charters.map((c, i) => i === charterIdx ? Object.assign({}, c, { [field]: val }) : c);
            updateData('charters', next);
        };
        const updateRole = (charterIdx, roleIdx, val) => {
            const next = data.charters.map((c, i) => {
                if (i !== charterIdx) return c;
                const roles = c.roles.slice();
                roles[roleIdx] = val;
                return Object.assign({}, c, { roles });
            });
            updateData('charters', next);
        };
        const updateKpi = (charterIdx, kpiIdx, val) => {
            const next = data.charters.map((c, i) => {
                if (i !== charterIdx) return c;
                const kpis = c.kpis.slice();
                kpis[kpiIdx] = val;
                return Object.assign({}, c, { kpis });
            });
            updateData('charters', next);
        };

        const safeIdx = Math.min(activeIdx, Math.max(0, top3.length - 1));
        const activeCharter = data.charters[safeIdx] || data.charters[0];
        const initiative = (top3[safeIdx] || {}).challenge || ('Initiative ' + (safeIdx + 1));

        const isCharterFilled = (c) => c && c.endGame.trim().length >= 10 && c.roles.some(r => r.trim()) && c.kpis.some(k => k.trim());
        const allFilled = top3.length >= 3 && data.charters.slice(0, 3).every(isCharterFilled);

        const goNextInitiative = () => { if (safeIdx < top3.length - 1) setActiveIdx(i => i + 1); };

        const ROLE_PLACEHOLDERS = ['e.g. Squad Lead', 'e.g. Customer Advocate', 'e.g. Process Owner', 'e.g. Metrics Champion'];
        const KPI_PLACEHOLDERS  = [
            'e.g. Onboarding time: 14 days → 5 days',
            'e.g. Decision cycle: < 48 hours',
            'e.g. NPS improvement: +15 points in 90 days',
            'e.g. Cost reduction: €50K in Q1',
        ];

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">STEP 2 OF {CONFIG.TOTAL_STEPS}</p>
                <div className="opening-box">
                    <h1 className="step-heading">Team Charters</h1>
                    <p className="step-hint">For each of your top 3 initiatives, define the exact mission, operating rules, team roles, and KPIs. One squad. One mission. No handoffs.</p>
                </div>
                <LearnMore>
                    A charter is the difference between a squad with momentum and a committee that meets forever. Project End-Game: state the exact metric you will move and by when. Playing-Field Rules: what budget, decisions, and scope does this squad own without asking anyone? Team Structure: 4–6 people maximum, each with a specific role. KPIs: 2–4 metrics — both output (what you do) and outcome (what changes as a result).
                </LearnMore>

                {top3.length < 3 && (
                    <div style={{ background: '#FFF9C4', border: '1px solid #FFF469', borderLeft: '4px solid #f59e0b', padding: '12px 16px', marginBottom: 20, fontSize: 13, color: '#333', lineHeight: 1.6 }}>
                        You need at least 3 scored challenges in Step 1 to charter 3 agile teams. Go back and add Impact/Ease ratings to more items.
                    </div>
                )}

                {top3.length >= 1 && (
                    <React.Fragment>
                        <div className="tab-nav">
                            {top3.map((item, tabIdx) => {
                                const c = data.charters[tabIdx];
                                const isFilled = isCharterFilled(c);
                                return (
                                    <button key={tabIdx}
                                        className={'tab-btn' + (safeIdx === tabIdx ? ' active' : isFilled ? ' done' : '')}
                                        onClick={() => setActiveIdx(tabIdx)}>
                                        SQUAD {tabIdx + 1}{item.challenge.length > 16 ? ': ' + item.challenge.slice(0, 16) + '…' : ': ' + item.challenge}
                                    </button>
                                );
                            })}
                        </div>

                        <div style={{ border: '1px solid #E0E0E0', padding: 24, marginBottom: 20 }}>
                            <div style={{ background: '#000', color: '#fff', padding: '14px 20px', marginBottom: 20, display: 'flex', alignItems: 'center', gap: 16 }}>
                                <span className="plaak" style={{ fontSize: 28, color: '#FFF469' }}>{String(safeIdx+1).padStart(2,'0')}</span>
                                <div>
                                    <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase', marginBottom: 2 }}>INITIATIVE</div>
                                    <div style={{ fontSize: 15, fontWeight: 600 }}>{initiative}</div>
                                </div>
                                <div style={{ marginLeft: 'auto', fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', letterSpacing: '0.08em' }}>
                                    SCORE: {(top3[safeIdx] || {}).score || 0}
                                </div>
                            </div>

                            <div style={{ marginBottom: 20 }}>
                                <label className="field-label">Project End-Game</label>
                                <p className="field-help" style={{ marginBottom: 8 }}>Be laser-specific. State the exact metric and the timeline. Not "improve onboarding" — "reduce onboarding from 14 to 5 days within 90 days."</p>
                                <textarea className="field-textarea" style={{ minHeight: 80 }}
                                    value={activeCharter.endGame}
                                    onChange={e => updateCharter(safeIdx, 'endGame', e.target.value)}
                                    placeholder="e.g. Reduce customer onboarding from 14 days to 5 days within 90 days, measured by median time from contract-signed to first-value."
                                    maxLength={400}
                                />
                                <p className="field-help">{activeCharter.endGame.length}/400</p>
                            </div>

                            <div style={{ marginBottom: 20 }}>
                                <label className="field-label">Playing-Field Rules</label>
                                <p className="field-help" style={{ marginBottom: 8 }}>What budget can they spend without approval? What decisions are theirs to make? What is out of scope?</p>
                                <textarea className="field-textarea" style={{ minHeight: 80 }}
                                    value={activeCharter.rules}
                                    onChange={e => updateCharter(safeIdx, 'rules', e.target.value)}
                                    placeholder="e.g. Budget: €15K discretionary. Decision rights: all process changes within onboarding workflow. Out of scope: pricing, contracts, legal terms."
                                    maxLength={400}
                                />
                                <p className="field-help">{activeCharter.rules.length}/400</p>
                            </div>

                            <div style={{ marginBottom: 20 }}>
                                <label className="field-label">Agile Team Roles (4–6 people, no handoffs)</label>
                                {activeCharter.roles.map((role, rIdx) => (
                                    <div key={rIdx} className="activity-row" style={{ marginBottom: 8 }}>
                                        <span className="activity-row-num">{String(rIdx+1).padStart(2,'0')}</span>
                                        <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14, flex: 1 }}
                                            value={role}
                                            onChange={e => updateRole(safeIdx, rIdx, e.target.value)}
                                            placeholder={ROLE_PLACEHOLDERS[rIdx] || 'Add a role…'}
                                        />
                                    </div>
                                ))}
                            </div>

                            <div>
                                <label className="field-label">KPIs (2–4 metrics — output AND outcome)</label>
                                <p className="field-help" style={{ marginBottom: 8 }}>Output: what the team does. Outcome: what changes as a result. Include both types.</p>
                                {activeCharter.kpis.map((kpi, kIdx) => (
                                    <div key={kIdx} className="activity-row" style={{ marginBottom: 8 }}>
                                        <span className="activity-row-num">{String(kIdx+1).padStart(2,'0')}</span>
                                        <input type="text" className="field-input" style={{ padding: '8px 12px', fontSize: 14, flex: 1 }}
                                            value={kpi}
                                            onChange={e => updateKpi(safeIdx, kIdx, e.target.value)}
                                            onKeyDown={kIdx === activeCharter.kpis.length - 1 ? (e => { if (e.key === 'Enter') { e.preventDefault(); goNextInitiative(); } }) : undefined}
                                            placeholder={KPI_PLACEHOLDERS[kIdx] || 'Add a KPI…'}
                                        />
                                    </div>
                                ))}
                                {safeIdx < top3.length - 1 && (
                                    <p style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#22c55e', letterSpacing: '0.06em', marginTop: 8 }}>
                                        ↵ PRESS ENTER ON THE LAST KPI TO GO TO THE NEXT SQUAD
                                    </p>
                                )}
                            </div>
                        </div>
                    </React.Fragment>
                )}

                {aiMessage && <div className="ai-message">{aiMessage}</div>}

                {allFilled && (
                    <div className="closing-box animate-in">
                        <p className="closing-title">{CONFIG.CLOSING_MESSAGES[2].title}</p>
                        <p>{CONFIG.CLOSING_MESSAGES[2].text}</p>
                    </div>
                )}
            </div>
        );
    }

    // ── Canvas ─────────────────────────────────────────────────────────────────
    function CanvasStep({ data, onSubmit, submitState, aiMessage }) {
        const top3 = getTop3(data.items);

        const handlePrint = () => {
            const rows = top3.map((item, i) => {
                const c = data.charters[i] || {};
                const filledRoles = (c.roles || []).filter(r => r.trim());
                const filledKpis  = (c.kpis  || []).filter(k => k.trim());
                return '<div style="margin-bottom:32px;page-break-inside:avoid">'
                    + '<h3 style="font-size:16px;font-weight:bold;background:#000;color:#FFD700;padding:10px 16px;margin-bottom:12px">SQUAD ' + (i+1) + ': ' + item.challenge + ' (Score: ' + item.score + ')</h3>'
                    + '<p style="margin-bottom:8px"><strong>End-Game:</strong> ' + (c.endGame || '—') + '</p>'
                    + '<p style="margin-bottom:8px"><strong>Rules:</strong> ' + (c.rules || '—') + '</p>'
                    + '<p style="margin-bottom:4px"><strong>Roles:</strong> ' + (filledRoles.length ? filledRoles.join(' | ') : '—') + '</p>'
                    + '<p style="margin-top:8px"><strong>KPIs:</strong> ' + (filledKpis.length ? filledKpis.map((k, j) => (j+1) + '. ' + k).join(' | ') : '—') + '</p>'
                    + '</div>';
            }).join('');
            const win = window.open('', '_blank');
            win.document.write('<!DOCTYPE html><html><head><title>Agile Teams Canvas</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Arial,sans-serif;padding:48px;color:#000}h1{font-size:28px;font-weight:bold;margin-bottom:32px}h2{font-size:11px;text-transform:uppercase;letter-spacing:0.1em;color:#666;margin-bottom:16px;border-bottom:2px solid #000;padding-bottom:6px}.section{margin-bottom:32px}</style></head><body><h1>SET AGILE TEAMS CANVAS</h1><div class="section">' + rows + '</div></body></html>');
            win.document.close();
            win.print();
        };

        if (submitState === 'success') {
            return (
                <div className="step-content animate-in">
                    <div style={{ background: '#f0fdf4', border: '1px solid #86efac', padding: 48, textAlign: 'center', marginTop: 32 }}>
                        <div style={{ fontSize: 48, marginBottom: 16 }}>✓</div>
                        <h2 className="plaak" style={{ fontSize: 32, marginBottom: 16 }}>SUBMITTED</h2>
                        <p style={{ fontSize: 16, color: '#555', marginBottom: 32 }}>Your Agile Teams Canvas has been saved. Your guru will review before Wednesday.</p>
                        <a href="/dashboard" style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#000', letterSpacing: '0.06em', textDecoration: 'underline' }}>← Back to Dashboard</a>
                    </div>
                </div>
            );
        }

        return (
            <div className="step-content animate-in">
                <p className="step-indicator">CANVAS</p>
                <div className="opening-box">
                    <h1 className="step-heading">Agile Teams Canvas</h1>
                    <p className="step-hint">Review your three agile team charters. Download a PDF for your team meeting, then submit your answers.</p>
                </div>

                <div style={{ border: '2px solid #000', marginBottom: 32 }}>
                    <div style={{ padding: '16px 24px', background: '#F5F5F5', borderBottom: '1px solid #E0E0E0' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#666', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>SECTION 1 — IMPACT / EASE RANKING</div>
                        <table className="canvas-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Challenge / Opportunity</th>
                                    <th style={{ textAlign: 'center' }}>Impact</th>
                                    <th style={{ textAlign: 'center' }}>Ease</th>
                                    <th style={{ textAlign: 'center' }}>Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {data.items
                                    .map((item, idx) => Object.assign({}, item, { idx, score: itemScore(item) }))
                                    .filter(item => item.challenge.trim() && item.score > 0)
                                    .sort((a, b) => b.score - a.score)
                                    .slice(0, 8)
                                    .map((item, i) => (
                                        <tr key={i} style={{ background: i < 3 ? '#FFFDE7' : '#fff' }}>
                                            <td>
                                                <span style={{ background: i < 3 ? '#000' : '#E0E0E0', color: i < 3 ? '#FFF469' : '#000', fontFamily: "'Plaak', sans-serif", fontSize: 14, padding: '2px 8px' }}>
                                                    {i+1}
                                                </span>
                                            </td>
                                            <td style={{ fontWeight: i < 3 ? 600 : 400 }}>{item.challenge}</td>
                                            <td style={{ textAlign: 'center' }}>{item.impact || '—'}</td>
                                            <td style={{ textAlign: 'center' }}>{item.ease || '—'}</td>
                                            <td style={{ textAlign: 'center', fontWeight: i < 3 ? 700 : 400, color: i < 3 ? '#DC2626' : '#000' }}>{item.score || '—'}</td>
                                        </tr>
                                    ))
                                }
                            </tbody>
                        </table>
                    </div>

                    {top3.map((item, i) => {
                        const c = data.charters[i] || {};
                        const filledRoles = (c.roles || []).filter(r => r.trim());
                        const filledKpis  = (c.kpis  || []).filter(k => k.trim());
                        return (
                            <div key={i} style={{ padding: '20px 24px', borderBottom: i < 2 ? '1px solid #E0E0E0' : 'none' }}>
                                <div style={{ background: '#000', color: '#fff', padding: '12px 20px', marginBottom: 16, display: 'flex', alignItems: 'center', gap: 16 }}>
                                    <span className="plaak" style={{ fontSize: 24, color: '#FFF469' }}>SQUAD {i+1}</span>
                                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, letterSpacing: '0.06em', textTransform: 'uppercase', flex: 1 }}>{item.challenge}</span>
                                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 11, color: '#999' }}>SCORE {item.score}</span>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 12 }}>
                                    <div>
                                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>PROJECT END-GAME</div>
                                        <p style={{ fontSize: 14, color: '#000', lineHeight: 1.6 }}>{c.endGame || '—'}</p>
                                    </div>
                                    <div>
                                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>PLAYING-FIELD RULES</div>
                                        <p style={{ fontSize: 14, color: '#000', lineHeight: 1.6 }}>{c.rules || '—'}</p>
                                    </div>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                    <div>
                                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>TEAM ROLES</div>
                                        {filledRoles.length > 0
                                            ? filledRoles.map((r, j) => (
                                                <div key={j} style={{ display: 'flex', gap: 8, fontSize: 14, padding: '2px 0' }}>
                                                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', background: '#000', padding: '1px 5px', flexShrink: 0 }}>{j+1}</span>
                                                    <span>{r}</span>
                                                </div>
                                            ))
                                            : <p style={{ fontSize: 14, color: '#999' }}>—</p>
                                        }
                                    </div>
                                    <div>
                                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 9, color: '#999', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 6 }}>KPIS</div>
                                        {filledKpis.length > 0
                                            ? filledKpis.map((k, j) => (
                                                <div key={j} style={{ display: 'flex', gap: 8, fontSize: 14, padding: '2px 0' }}>
                                                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#999' }}>•</span>
                                                    <span>{k}</span>
                                                </div>
                                            ))
                                            : <p style={{ fontSize: 14, color: '#999' }}>—</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        );
                    })}

                    <div style={{ padding: '24px 28px', background: '#000', color: '#fff' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#FFF469', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: 12 }}>FAST TRACK REMINDER</div>
                        <p style={{ fontSize: 14, lineHeight: 1.8, color: '#ccc' }}>
                            Treat each agile squad like a <strong style={{ color: '#fff' }}>micro-startup</strong>. Focus on one bold mission, move quickly, learn daily, and scale the winners. Kick off each squad with a 1-hour sprint-zero: align on mission, rules, and KPIs. Run 2-week iterations — build a minimal test, measure results, adjust or scale. Rotate or disband teams once the goal is met, then apply the same method to your next priority.
                        </p>
                    </div>
                </div>

                {aiMessage && <div className="ai-message" style={{ marginBottom: 16 }}>{aiMessage}</div>}

                <div style={{ display: 'flex', gap: 16 }}>
                    <button onClick={handlePrint} className="btn-wiz-back"
                        style={{ flex: 1, padding: 16, fontSize: 13, border: '2px solid #000', color: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 8 }}>
                        ↓ DOWNLOAD PDF
                    </button>
                    <button onClick={onSubmit} disabled={submitState === 'saving'} className="btn-wiz-next"
                        style={{ flex: 2, padding: 16, fontSize: 13 }}>
                        {submitState === 'saving' ? 'SAVING…' : 'SUBMIT ANSWERS →'}
                    </button>
                </div>
            </div>
        );
    }

    // ── IntroPage ─────────────────────────────────────────────────────────────
    function IntroPage({ onNext }) {
        return (
            <div style={{ background: '#000', color: '#fff', minHeight: '100vh', padding: '64px' }}>
                <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
                    <h1 className="plaak animate-in" style={{ fontSize: '100px', marginBottom: '64px' }}>BEFORE WE START</h1>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.08s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', color: '#FFF469', marginBottom: '24px' }}>SPRINT INFO</h2>
                        <div style={{ background: '#fff', color: '#000', padding: '32px' }}>
                            <p style={{ fontSize: '22px', fontWeight: 'bold', marginBottom: '16px' }}>Sprint 27: Set Agile Teams</p>
                            <p style={{ fontSize: '18px', lineHeight: 1.6, marginBottom: '16px' }}>
                                This sprint breaks through the three organisational speed killers — annual planning cycles, endless approvals, and sequential decision chains — by forming small cross-functional squads with a single mission, clear boundaries, and the authority to move without asking permission.
                            </p>
                            <div style={{ borderLeft: '4px solid #000', paddingLeft: '16px', fontStyle: 'italic', fontSize: '16px' }}>
                                "In most organisations, up to 80% of project time is consumed not by doing work, but by waiting." — Fast Track Brain Juice
                            </div>
                        </div>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '48px', animationDelay: '0.1s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', marginBottom: '24px' }}>MISTAKES TO AVOID</h2>
                        <ul style={{ fontSize: '20px', listStyle: 'none', padding: 0 }}>
                            {[
                                'Over-scoping the mission — one squad, one mission. Never bundle multiple objectives into one charter.',
                                'Incomplete charters — skipping budget or KPI definitions leads to drift. Fill every field.',
                                'Neglecting review cadence — without weekly check-ins, learning stalls. Commit to a fixed review slot.',
                                'Confusing output with outcome — track both what the team does AND what changes as a result.',
                            ].map((item, i) => (
                                <li key={i} style={{ display: 'flex', alignItems: 'flex-start', marginBottom: '16px' }}>
                                    <span style={{ fontSize: '32px', marginRight: '16px', lineHeight: 1, flexShrink: 0 }}>•</span>
                                    <span>{item}</span>
                                </li>
                            ))}
                        </ul>
                    </div>

                    <div className="animate-in" style={{ marginBottom: '64px', animationDelay: '0.2s' }}>
                        <h2 className="plaak" style={{ fontSize: '48px', marginBottom: '32px' }}>THE JOURNEY</h2>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px', textAlign: 'center' }}>
                            {[
                                ['01', 'PRIORITISE', 'Rate 8+ challenges on impact and ease — top 3 become your squads'],
                                ['02', 'CHARTER',    'Define end-game, rules, roles, and KPIs for each of the 3 squads'],
                            ].map(row => (
                                <div key={row[0]} style={{ border: '2px solid #fff', padding: '20px 12px' }}>
                                    <div className="plaak" style={{ fontSize: '52px', marginBottom: '12px' }}>{row[0]}</div>
                                    <p style={{ fontWeight: 'bold', marginBottom: '6px', fontSize: '13px' }}>{row[1]}</p>
                                    <p style={{ fontSize: '12px', color: '#999' }}>{row[2]}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    <button onClick={onNext} className="plaak"
                        style={{ width: '100%', padding: '32px', background: '#FFF469', color: '#000', border: 'none', fontSize: '28px', cursor: 'pointer', letterSpacing: '0.05em', transition: 'opacity 0.2s' }}>
                        LET'S START →
                    </button>
                </div>
            </div>
        );
    }

    // ── App ───────────────────────────────────────────────────────────────────
    function AgileTeamsApp() {
        const [step, setStep]               = useState(0);
        const [data, setData]               = useState(makeDefaultData());
        const [userId, setUserId]           = useState(null);
        const [authState, setAuthState]     = useState({ loading: true, authenticated: false, error: null });
        const [submitState, setSubmitState] = useState('idle');
        const [aiReviewing, setAiReviewing] = useState(false);
        const [aiMessage, setAiMessage]     = useState('');

        const totalSteps = CONFIG.TOTAL_STEPS;

        useEffect(() => {
            const { createClient } = supabase;
            window.supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
            ToolDB.init(CONFIG.TOOL_SLUG);

            ToolDB.whenReady().then(async () => {
                const uid = await ToolDB.identifyUser();
                if (!uid) {
                    setAuthState({ loading: false, authenticated: false, error: 'No active session found.' });
                    return;
                }
                setUserId(uid);
                setAuthState({ loading: false, authenticated: true, error: null });

                try {
                    const saved = await ToolDB.load(uid);
                    if (saved && Object.keys(saved).length > 0) {
                        setData(prev => Object.assign({}, prev, {
                            items:    saved.brainstorm_items || prev.items,
                            charters: saved.team_charters   || prev.charters,
                        }));
                    }
                } catch (_) {}
            });
        }, []);

        const updateData = useCallback((field, val) => {
            setData(prev => Object.assign({}, prev, { [field]: val }));
            setAiMessage('');
        }, []);

        const canProceed = () => {
            if (step === 1) {
                const filled = data.items.filter(a => a.challenge.trim()).length;
                return filled >= 8 && getTop3(data.items).length >= 3;
            }
            if (step === 2) {
                const top3 = getTop3(data.items);
                if (top3.length < 3) return false;
                return data.charters.slice(0, 3).some(c => c.endGame.trim().length >= 10 && c.roles.some(r => r.trim()));
            }
            return true;
        };

        const handleNext = async () => {
            setAiMessage('');
            if (!canProceed()) {
                if (step === 1) setAiMessage('Please add at least 8 challenges with Impact/Ease ratings so 3 can be identified as the Top 3 before continuing.');
                if (step === 2) setAiMessage('Please fill in at least one charter (End-Game + at least one Role) before continuing.');
                return;
            }

            if (step === 1 && window.AIChallenge) {
                const top3 = getTop3(data.items);
                setAiReviewing(true);
                const ok = await window.AIChallenge.reviewStep(
                    userId,
                    CONFIG.TOOL_SLUG,
                    { brainstorm_items: top3.map((item, i) => (i+1) + '. ' + item.challenge + ' (score: ' + item.score + ')').join('\n') },
                    'Impact/Ease Brainstorm'
                );
                setAiReviewing(false);
                if (!ok) return;
            }

            if (step === 2 && window.AIChallenge) {
                const top3 = getTop3(data.items);
                const charterSummary = top3.map((item, i) => {
                    const c = data.charters[i] || {};
                    return 'Squad ' + (i+1) + ' — ' + item.challenge + ': ' + (c.endGame || 'no end-game defined');
                }).join('\n');
                setAiReviewing(true);
                const ok = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, { team_charters: charterSummary }, 'Team Charters');
                setAiReviewing(false);
                if (!ok) return;
            }

            setStep(step + 0.5);
        };

        const handleTransitionNext = () => {
            if (Math.floor(step) === totalSteps) {
                setStep('canvas');
            } else {
                setStep(Math.floor(step) + 1);
            }
        };

        const handleBack = () => {
            if (step === 'canvas') { setStep(totalSteps); return; }
            if (step === 1) { setStep(0.5); return; }
            if (typeof step === 'number') setStep(step - 1);
        };

        const handleSubmit = async () => {
            setSubmitState('saving');
            try {
                await ToolDB.save(userId, {
                    brainstorm_items: data.items,
                    team_charters:    data.charters,
                });
                await ToolDB.markComplete(userId);
                setSubmitState('success');
            } catch (err) {
                console.error('[AgileTeams] Submit error:', err);
                setSubmitState('error');
                setAiMessage('Submission failed. Please try again.');
            }
        };

        const isTransition = step === 1.5 || step === 2.5;

        return (
            <div className="tool-frame">
                {authState.loading && (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <div style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#555', letterSpacing: '0.1em', textTransform: 'uppercase' }}>Loading…</div>
                    </div>
                )}

                {!authState.loading && !authState.authenticated && (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                        <div style={{ textAlign: 'center', color: '#fff', padding: '0 32px', maxWidth: 640 }}>
                            <h1 className="plaak" style={{ fontSize: 48, marginBottom: 24 }}>AUTHENTICATION REQUIRED</h1>
                            <p style={{ fontSize: 20, marginBottom: 32 }}>Please access this tool from your LearnWorlds course.</p>
                            <p style={{ fontSize: 16, color: '#999' }}>{authState.error || 'No active session found'}</p>
                        </div>
                    </div>
                )}

                {step === 0 && authState.authenticated && (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                        <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url(' + CONFIG.COVER_IMAGE + ')', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.4 }} />
                        <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                            <div style={{ fontFamily: "'Monument', monospace", fontSize: 12, color: '#FFF469', letterSpacing: '0.12em', textTransform: 'uppercase', marginBottom: 24 }}>
                                SPRINT 27 / MODULE 7 — PEOPLE &amp; LEADERSHIP
                            </div>
                            <h1 className="plaak" style={{ fontSize: 72, marginBottom: 16 }}>{CONFIG.TOOL_TITLE}</h1>
                            <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48, maxWidth: 560, margin: '0 auto 48px' }}>{CONFIG.TOOL_SUBTITLE}</p>
                            <button onClick={() => setStep(0.5)}
                                style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s' }}
                                onMouseOver={e => { e.currentTarget.style.background = '#FFF469'; }}
                                onMouseOut={e => { e.currentTarget.style.background = '#fff'; }}>
                                START
                            </button>
                        </div>
                    </div>
                )}

                {step === 0.5 && authState.authenticated && (
                    <IntroPage onNext={() => setStep(1)} />
                )}

                {isTransition && (
                    <TransitionScreen stepNum={Math.floor(step)} onNext={handleTransitionNext} />
                )}

                {Number.isInteger(step) && step >= 1 && step <= totalSteps && (
                    <div className="tool-inner">
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={step} totalSteps={totalSteps} />
                                <div style={{ flex: 1 }}>
                                    {step === 1 && <Step1 data={data} updateData={updateData} aiMessage={aiMessage} />}
                                    {step === 2 && <Step2 data={data} updateData={updateData} aiMessage={aiMessage} />}
                                </div>
                                <div className="wizard-footer">
                                    <button className="btn-wiz-back" onClick={handleBack}>← BACK</button>
                                    <button className="btn-wiz-next" onClick={handleNext} disabled={aiReviewing}>
                                        {aiReviewing ? 'REVIEWING…' : 'NEXT →'}
                                    </button>
                                </div>
                            </div>
                            <WizardSidebar currentStep={step} data={data} onNavigate={(s) => setStep(s)} />
                        </div>
                    </div>
                )}

                {step === 'canvas' && authState.authenticated && (
                    <div className="tool-inner">
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <div style={{ flex: 1 }}>
                                    <CanvasStep data={data} onSubmit={handleSubmit} submitState={submitState} aiMessage={aiMessage} />
                                </div>
                            </div>
                            <WizardSidebar currentStep="canvas" data={data} onNavigate={(s) => setStep(s)} />
                        </div>
                    </div>
                )}
            </div>
        );
    }

    ReactDOM.render(<AgileTeamsApp />, document.getElementById('root'));
</script>
</body>
</html>
