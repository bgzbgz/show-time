<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOOP Tool | Fast Track Program</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>

    <style>
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Riforma', -apple-system, sans-serif;
            font-size: 16px;
            color: #000;
            background: #000;
            -webkit-font-smoothing: antialiased;
        }

        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        /* Outer frame */
        .tool-frame {
            background: #fff;
            min-height: 100vh;
        }
        .tool-inner {
            background: #fff;
            min-height: 100vh;
        }

        /* Wizard layout */
        .wizard-layout {
            display: flex;
            min-height: 100vh;
        }
        .wizard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fff;
            padding: 0 48px;
        }
        .wizard-sidebar {
            width: 280px;
            background: #000;
            border-left: 1px solid #000;
            flex-shrink: 0;
        }
        .wizard-sidebar-inner {
            position: sticky;
            top: 0;
            padding: 32px 24px;
            max-height: 100vh;
            overflow-y: auto;
        }

        /* Step content area */
        .step-content {
            max-width: 100%;
            padding: 40px 0;
            flex: 1;
        }
        .step-indicator {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #666;
            margin-bottom: 8px;
        }

        /* Opening area — the one Plaak heading per page */
        .opening-box {
            margin-bottom: 32px;
        }
        .opening-box .step-heading {
            font-family: 'Plaak', sans-serif;
            font-weight: bold;
            font-size: 32px;
            letter-spacing: -0.01em;
            line-height: 1.2;
            color: #000;
            margin-bottom: 6px;
        }
        .opening-box .step-hint {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin: 0;
        }

        /* Questions layout */
        .questions-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 32px;
        }
        .questions-grid.single-col {
            /* same */
        }
        .question-box {
            /* no border, no box */
        }
        .question-box.full-width {
            /* no-op */
        }

        /* Closing area */
        .closing-box {
            border-top: 1px solid #E0E0E0;
            padding: 20px 0 0 0;
            margin-top: 8px;
            text-align: center;
        }
        .closing-box p {
            font-size: 14px;
            color: #666;
        }
        .closing-box .closing-title {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 6px;
        }

        /* Form elements */
        .field-group { margin-bottom: 40px; }
        .field-group:last-child { margin-bottom: 0; }
        .field-label {
            font-weight: 600;
            font-size: 16px;
            color: #000;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .field-input {
            border: 1px solid #E0E0E0;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            width: 100%;
            color: #000;
            background: #fff;
            transition: border-color 0.2s ease;
        }
        .field-input:focus { outline: none; border-color: #000; }
        .field-textarea {
            border: 1px solid #E0E0E0;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            width: 100%;
            min-height: 100px;
            resize: vertical;
            color: #000;
            background: #fff;
            transition: border-color 0.2s ease;
        }
        .field-textarea:focus { outline: none; border-color: #000; }
        .field-help { font-size: 13px; color: #666; margin-top: 4px; }
        .field-error { font-size: 13px; color: #DC2626; margin-top: 4px; }

        /* Help icon (?) */
        .help-icon-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #E0E0E0;
            border: 1.5px solid #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 11px;
            font-weight: 600;
            color: #666;
        }
        .help-icon-btn:hover { background: #000; color: #fff; border-color: #000; }

        /* Help accordion — drops down between label and field */
        .help-accordion {
            background: #F5F5F5;
            border: 1px solid #E0E0E0;
            border-left: 3px solid #000;
            padding: 14px 16px;
            margin-bottom: 8px;
            font-size: 13px;
            color: #333;
            line-height: 1.5;
            animation: accordionOpen 0.2s ease-out;
        }
        @keyframes accordionOpen {
            from { opacity: 0; max-height: 0; padding-top: 0; padding-bottom: 0; }
            to { opacity: 1; max-height: 300px; }
        }

        /* LearnMore expandable — prominent so users read before answering */
        .learn-more-toggle {
            font-family: 'Monument', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            background: #F5F5F5;
            border: 1px solid #E0E0E0;
            cursor: pointer;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 32px;
            transition: background 0.15s ease;
        }
        .learn-more-toggle:hover { background: #EBEBEB; }
        .learn-more-content {
            border-left: 3px solid #000;
            background: #F5F5F5;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #333;
            line-height: 1.7;
        }

        /* Button footer */
        .btn-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-top: 1px solid #E0E0E0;
            background: #fff;
            width: 100%;
        }
        .btn-back {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-back:hover { background: #F5F5F5; }
        .btn-next {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E0E0E0; color: #9CA3AF; border-color: #E0E0E0; cursor: not-allowed; }

        /* (Breadcrumb removed — navigation via sidebar) */

        /* Sidebar step items */
        .sidebar-step-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }

        /* Canvas styles */
        .numbered-section { background: #000; color: #fff; padding: 8px 14px; font-size: 14px; font-weight: bold; letter-spacing: 0.5px; display: inline-block; font-family: 'Monument', monospace; }
        .canvas-wish-box { background: #FAFAFA; border-left: 4px solid #000; padding: 20px; margin-bottom: 16px; }
        .canvas-step-box { border: 2px solid #000; background: #FAFAFA; padding: 16px; }
        .canvas-obstacle-box { background: #FAFAFA; border-left: 4px solid #DC2626; padding: 16px; margin-bottom: 12px; }
        .canvas-plan-box { border: 3px solid #000; background: #FAFAFA; padding: 24px; }

        /* Mobile step indicator */
        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E0E0E0; background: #F5F5F5; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E0E0E0; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }

        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }

        @media print { .no-print { display: none !important; } }

        @media (min-width: 769px) and (max-width: 1024px) {
            .wizard-sidebar { width: 220px; }
            .wizard-sidebar-inner { padding: 24px 16px; }
        }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .mobile-step-bar { display: block; }
            .step-content { padding: 20px 16px; }
            .opening-box .step-heading { font-size: 24px; }
            .btn-footer { padding: 12px 16px; }
            /* questions stack on mobile - already column */
            /* no header */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG = {
            SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
            TOOL_SLUG: 'woop',
            AUTOSAVE_DELAY: 2000
        };

        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        window.supabaseClient = supabaseClient;
        ToolDB.init(CONFIG.TOOL_SLUG);
        DependencyInjection.init(CONFIG.TOOL_SLUG);
        CognitiveLoad.init('woop');

        // --- Resolve logo path relative to HTML file ---
        const LOGO_WHITE = '../../../Designs/02. logos/FastTrack_F_White.png';

        // --- Small Components ---

        function CheckIcon({ color = "#fff", size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
        }

        /* Breadcrumb removed — navigation via sidebar steps */

        function LearnMore({ children }) {
            const [open, setOpen] = useState(false);
            return (
                <div style={{ marginBottom: open ? 0 : 12 }}>
                    <button className="learn-more-toggle" onClick={() => setOpen(!open)}>WHY THIS MATTERS {open ? '\u2212' : '+'}</button>
                    {open && <div className="learn-more-content">{children}</div>}
                </div>
            );
        }

        function ButtonFooter({ onBack, onNext, nextLabel = 'Save & Go Next', canProceed, showBack = true }) {
            return (
                <div className="btn-footer no-print">
                    {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                    <button className="btn-next" disabled={!canProceed} onClick={onNext}>{nextLabel} &rarr;</button>
                </div>
            );
        }

        function MobileStepBar({ currentStep }) {
            const progress = currentStep >= 999 ? 100 : Math.round((currentStep / 4) * 100);
            return (
                <div className="mobile-step-bar no-print">
                    <div className="bar-text">Step {Math.min(currentStep, 4)} of 4</div>
                    <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${progress}%` }} /></div>
                </div>
            );
        }

        function WizardSidebar({ currentStep, data, onNavigate }) {
            const steps = [{ num: 1, label: 'Wish' }, { num: 2, label: 'Outcome' }, { num: 3, label: 'Obstacle' }, { num: 4, label: 'Plan' }];
            const getSnippet = (n) => {
                if (n === 1 && data.outcome) return '"' + data.outcome.substring(0, 50) + (data.outcome.length > 50 ? '...' : '') + '"';
                if (n === 2 && data.steps[0]) { const f = data.steps.filter(s => s.trim()); return f.length + ' milestone' + (f.length !== 1 ? 's' : '') + ' defined'; }
                if (n === 3 && data.obstacles[0]?.problem) return data.obstacles.length + ' obstacle' + (data.obstacles.length !== 1 ? 's' : '') + ' planned';
                if (n === 4 && data.firstAction) return 'Deadline: ' + (data.deadline ? new Date(data.deadline).toLocaleDateString() : 'Not set');
                return null;
            };
            return (
                <div className="wizard-sidebar no-print">
                    <div className="wizard-sidebar-inner">
                        <div style={{ marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>WOOP</div>
                            <div style={{ fontSize: 13, color: '#999' }}>~15 min</div>
                        </div>
                        <div style={{ marginBottom: 16, fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#999' }}>Your journey</div>
                        {steps.map(s => {
                            const isCompleted = currentStep > s.num, isActive = currentStep === s.num, isLocked = currentStep < s.num;
                            const snippet = isCompleted ? getSnippet(s.num) : null;
                            return (
                                <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                                    onClick={() => isCompleted && onNavigate && onNavigate(s.num)}
                                    title={isCompleted ? 'Click to review this step' : ''}
                                >
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                        {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                                        <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                                    </div>
                                    {snippet && <div className="sidebar-snippet">{snippet}</div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Help accordion: renders ? icon inline, accordion drops BELOW the label, ABOVE the input
        function HelpAccordion({ id, activeHelp, setActiveHelp, children }) {
            const isOpen = activeHelp === id;
            return (
                <>
                    <button className="help-icon-btn" onClick={() => setActiveHelp(isOpen ? null : id)} title="Help">?</button>
                    {isOpen && <div className="help-accordion" style={{ marginTop: 6 }}>{children}</div>}
                </>
            );
        }

        // --- Main App ---

        function WOOPTool() {
            const [step, setStep] = useState(0);
            const [questionHelp, setQuestionHelp] = useState(null);

            const [authState, setAuthState] = useState({ loading: true, authenticated: false, user: null, progress: null, error: null });

            const [data, setData] = useState({
                companyId: '', userId: '', scopeType: '',
                outcome: '', worldChange: '', feeling: '',
                steps: ['', '', ''], mentallyRehearsed: false,
                obstacles: [{ problem: '', ifTrigger: '', thenPerson: '', thenAction: '', byWhen: '' }],
                bigChunks: '', firstAction: '', deadline: ''
            });

            const autosaveTimer = useRef(null);

            // --- Auth (handled by ToolDB.init → identifyUser) ---
            useEffect(() => {
                setAuthState({ loading: false, authenticated: true, user: null, progress: { completed_tools: [], unlocked_tools: ['woop'] }, isUnlocked: true, isCompleted: false, error: null });
            }, []);

            useEffect(() => {
                if (authState.authenticated && authState.progress && window.toolAccessControl) {
                    window.toolAccessControl.initialize(authState.progress, 'woop', 0);
                }
            }, [authState.authenticated]);

            // --- Auto-save ---
            useEffect(() => {
                if (autosaveTimer.current) clearTimeout(autosaveTimer.current);
                autosaveTimer.current = setTimeout(() => {
                    localStorage.setItem('woopData', JSON.stringify({ data, step, timestamp: new Date().toISOString() }));
                }, CONFIG.AUTOSAVE_DELAY);
                return () => { if (autosaveTimer.current) clearTimeout(autosaveTimer.current); };
            }, [data, step]);

            // --- Load saved data ---
            useEffect(() => {
                const saved = localStorage.getItem('woopData');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.data && Array.isArray(parsed.data.obstacles)) {
                            const migratedObstacles = parsed.data.obstacles.map(o => (o.solution !== undefined && !o.ifTrigger) ? { problem: o.problem || '', ifTrigger: '', thenPerson: '', thenAction: '', byWhen: '' } : o);
                            setData({ ...parsed.data, obstacles: migratedObstacles, scopeType: parsed.data.scopeType || '' });
                            let s = parsed.step; if (s === 1.5) s = 2; else if (s === 2.5) s = 3; else if (s === 3.5) s = 4;
                            setStep(s);
                        }
                    } catch (e) { localStorage.removeItem('woopData'); }
                }
            }, []);

            const updateData = (field, value) => setData(prev => ({ ...prev, [field]: value }));
            const updateStepField = (index, value) => setData(prev => ({ ...prev, steps: prev.steps.map((s, i) => i === index ? value : s) }));
            const updateObstacle = (index, field, value) => setData(prev => ({ ...prev, obstacles: prev.obstacles.map((o, i) => i === index ? { ...o, [field]: value } : o) }));
            const addObstacle = () => { if (data.obstacles.length >= 3) { alert('Maximum 3 obstacles allowed.\n\nStrategy is sacrifice.'); return; } setData(prev => ({ ...prev, obstacles: [...prev.obstacles, { problem: '', ifTrigger: '', thenPerson: '', thenAction: '', byWhen: '' }] })); };
            const removeObstacle = (index) => { if (data.obstacles.length > 1) setData(prev => ({ ...prev, obstacles: prev.obstacles.filter((_, i) => i !== index) })); };

            const canProceedStep1 = data.outcome.length >= 20 && data.worldChange.length >= 10 && data.feeling.length >= 3;
            const canProceedStep2 = data.steps.filter(s => s.trim().length > 5).length >= 3 && data.mentallyRehearsed;
            const canProceedStep3 = data.obstacles.length >= 1 && data.obstacles.every(o => o && o.problem && o.problem.trim().length > 5 && o.ifTrigger && o.ifTrigger.trim().length > 3 && o.thenPerson && o.thenPerson.trim().length > 2 && o.thenAction && o.thenAction.trim().length > 5 && o.byWhen && o.byWhen.trim().length > 0);
            const canProceedStep4 = data.bigChunks.length >= 10 && data.firstAction.length >= 10 && data.deadline !== '';

            // Step closing messages
            const closingMessages = {
                1: { title: 'WISH DEFINED', text: 'Your end game is clear. Next: map the milestones to get there.' },
                2: { title: 'OUTCOME MAPPED', text: 'Your route is planned and mentally rehearsed. Next: anticipate what could stop you.' },
                3: { title: 'OBSTACLES PREPARED', text: 'You have IF-THEN plans ready. Nothing will catch you off guard. Next: commit to action.' },
                4: { title: 'PLAN LOCKED', text: 'Your first action and deadline are set. Time to execute.' }
            };

            return (
                <div className="tool-frame">
                    <div className="tool-inner">
                        {/* Auth loading */}
                        {authState.loading && (
                            <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50 }}>
                                <div style={{ textAlign: 'center' }}>
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 16 }}>AUTHENTICATING</h1>
                                    <p style={{ fontSize: 18 }}>Please wait...</p>
                                </div>
                            </div>
                        )}

                        {/* Auth required */}
                        {!authState.loading && !authState.authenticated && (
                            <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 40 }}>
                                <div style={{ textAlign: 'center', padding: '0 32px', maxWidth: 640 }}>
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 24 }}>AUTHENTICATION REQUIRED</h1>
                                    <p style={{ fontSize: 20, marginBottom: 32 }}>Please access this tool from your LearnWorlds course.</p>
                                    <p style={{ fontSize: 16, color: '#999' }}>{authState.error || 'No active session found'}</p>
                                </div>
                            </div>
                        )}

                        {/* Step 0: Cover */}
                        {step === 0 && authState.authenticated && (
                            <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                                <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url(cover.jpg)', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.5 }} />
                                <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                                    <h1 className="plaak" style={{ fontSize: 80, marginBottom: 16 }}>WOOP</h1>
                                    <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48 }}>Transform your wish into an actionable plan</p>
                                    <button onClick={() => setStep(0.5)} style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }}
                                        onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                        onMouseOut={e => { e.target.style.background = '#fff'; }}
                                    >START</button>
                                </div>
                            </div>
                        )}

                        {/* Step 0.5: Setup */}
                        {step === 0.5 && (
                            <div style={{ minHeight: '100vh', background: '#fff', display: 'flex', flexDirection: 'column', padding: '0 48px' }}>
                                <div className="step-content animate-in" style={{ maxWidth: 560, margin: '0 auto' }}>
                                    <p className="step-indicator">SETUP</p>
                                    <div className="opening-box">
                                        <h1 className="step-heading">Before We Start</h1>
                                        <p className="step-hint">WOOP helps you translate aspirations into concrete, actionable steps using mental contrasting and implementation intentions.</p>
                                    </div>

                                    <div className="field-group">
                                        <label className="field-label" style={{ marginBottom: 12 }}>What are you defining a goal for?</label>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                                            <label style={{ display: 'block', padding: '14px 16px', border: '1px solid #E0E0E0', borderRadius: 4, cursor: 'pointer', transition: 'all 0.15s ease', background: data.scopeType === 'program' ? '#F5F5F5' : '#fff', borderColor: data.scopeType === 'program' ? '#000' : '#E0E0E0' }}>
                                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: 12 }}>
                                                    <input type="radio" name="scopeType" value="program" checked={data.scopeType === 'program'} onChange={e => updateData('scopeType', e.target.value)} style={{ marginTop: 3, accentColor: '#000' }} />
                                                    <div>
                                                        <div style={{ fontWeight: 600, marginBottom: 2 }}>Completing the Fast Track Program</div>
                                                        <div style={{ fontSize: 13, color: '#666' }}>e.g. "Finish all 30 sprints, implement 5 core tools"</div>
                                                    </div>
                                                </div>
                                            </label>
                                            <label style={{ display: 'block', padding: '14px 16px', border: '1px solid #E0E0E0', borderRadius: 4, cursor: 'pointer', transition: 'all 0.15s ease', background: data.scopeType === 'business' ? '#F5F5F5' : '#fff', borderColor: data.scopeType === 'business' ? '#000' : '#E0E0E0' }}>
                                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: 12 }}>
                                                    <input type="radio" name="scopeType" value="business" checked={data.scopeType === 'business'} onChange={e => updateData('scopeType', e.target.value)} style={{ marginTop: 3, accentColor: '#000' }} />
                                                    <div>
                                                        <div style={{ fontWeight: 600, marginBottom: 2 }}>Your company's strategic transformation</div>
                                                        <div style={{ fontSize: 13, color: '#666' }}>e.g. "Reach €10M revenue, enter 3 new markets"</div>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    {!data.scopeType && (
                                        <p className="field-error" style={{ marginTop: 16 }}>
                                            Select your focus.
                                        </p>
                                    )}
                                </div>
                                <div className="btn-footer no-print">
                                    <button className="btn-back" onClick={() => setStep(0)}>&larr; Back</button>
                                    <button className="btn-next" disabled={!data.scopeType} onClick={() => setStep(1)}>Let's Start &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Steps 1-4 */}
                        {step >= 1 && step <= 4 && (
                            <div className="wizard-layout">
                                <div className="wizard-main">
                                    <MobileStepBar currentStep={step} />

                                    {step === 1 && <Step1Content data={data} updateData={updateData} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} closing={closingMessages[1]} canProceed={canProceedStep1} />}
                                    {step === 2 && <Step2Content data={data} updateStep={updateStepField} updateData={updateData} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} closing={closingMessages[2]} canProceed={canProceedStep2} />}
                                    {step === 3 && <Step3Content data={data} updateObstacle={updateObstacle} addObstacle={addObstacle} removeObstacle={removeObstacle} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} closing={closingMessages[3]} canProceed={canProceedStep3} />}
                                    {step === 4 && <Step4Content data={data} updateData={updateData} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} closing={closingMessages[4]} canProceed={canProceedStep4} />}

                                    <ButtonFooter
                                        onBack={() => setStep(step === 1 ? 0.5 : step - 1)}
                                        onNext={() => setStep(step === 4 ? 999 : step + 1)}
                                        canProceed={step === 1 ? canProceedStep1 : step === 2 ? canProceedStep2 : step === 3 ? canProceedStep3 : canProceedStep4}
                                        nextLabel={step === 4 ? 'View Your Canvas' : 'Next'}
                                        showBack={true}
                                    />
                                </div>
                                <WizardSidebar currentStep={step} data={data} onNavigate={setStep} />
                            </div>
                        )}

                        {/* Step 999: Canvas */}
                        {step === 999 && <CanvasView data={data} onBack={() => setStep(4)} />}
                    </div>
                </div>
            );
        }

        // --- Step 1: Wish ---
        function Step1Content({ data, updateData, questionHelp, setQuestionHelp, closing, canProceed }) {
            const p = data.scopeType === 'program' ? {
                outcome: "It's 90 days from now. The Fast Track program is complete. All 30 sprints done. Our team is aligned on 3 core values.",
                worldChange: "My team makes decisions without me. Leadership meetings are productive. I have 10 hours/week for strategy.",
                feeling: "Energized. Clear. In control. Proud."
            } : {
                outcome: "It's 12 months from now. Revenue hit \u20AC10M. We've entered 3 new markets. Built an A-player leadership team of 5.",
                worldChange: "We're the market leader. Clients seek us out. Team is self-managing.",
                feeling: "Unstoppable. Fulfilled. Free. Excited."
            };

            return (
                <div className="step-content animate-in">
                    <p className="step-indicator">STEP 1 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Define Your Wish</h1>
                        <p className="step-hint">Write in present tense as if it already happened. Specificity creates energy.</p>
                    </div>

                    <LearnMore>
                        Dreams create energy. Your brain doesn't differentiate between what's in your head and reality. Mental contrasting increases goal achievement by 40% vs. positive thinking alone (Oettingen, 2014).
                    </LearnMore>

                    <div className="questions-grid">
                        <div className="question-box full-width">
                            <label className="field-label">
                                What have you achieved? What's the concrete outcome?
                                <HelpAccordion id="outcome" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                    <strong>Why:</strong> Specificity creates energy. Vague goals = vague results.<br/>
                                    <strong>Good:</strong> Concrete numbers, timeline ("90 days from now"), observable results.
                                </HelpAccordion>
                            </label>
                            <textarea className="field-textarea" value={data.outcome} onChange={e => updateData('outcome', e.target.value)} placeholder={p.outcome} maxLength={300} />
                            <p className="field-help">{data.outcome.length}/300 (min 20)</p>
                        </div>

                        <div className="question-box">
                            <label className="field-label">
                                How has the world changed?
                                <HelpAccordion id="worldChange" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                    <strong>Why:</strong> Impact on others creates "approach motivation" — your brain works harder for goals that matter beyond yourself.<br/>
                                    <strong>Think:</strong> How others behave differently, what systems improved, what's now possible.
                                </HelpAccordion>
                            </label>
                            <textarea className="field-textarea" style={{ minHeight: 80 }} value={data.worldChange} onChange={e => updateData('worldChange', e.target.value)} placeholder={p.worldChange} maxLength={200} />
                            <p className="field-help">{data.worldChange.length}/200 (min 10)</p>
                        </div>

                        <div className="question-box">
                            <label className="field-label">
                                How do you feel about it?
                                <HelpAccordion id="feeling" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                    <strong>Why:</strong> Emotion is the fuel. Without feeling, goals are just words.<br/>
                                    <strong>Good:</strong> One powerful word or short phrase that makes you sit up straighter.
                                </HelpAccordion>
                            </label>
                            <input type="text" className="field-input" value={data.feeling} onChange={e => updateData('feeling', e.target.value)} placeholder={p.feeling} />
                        </div>
                    </div>

                    {canProceed && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">{closing.title}</p>
                            <p>{closing.text}</p>
                        </div>
                    )}
                </div>
            );
        }

        // --- Step 2: Outcome ---
        function Step2Content({ data, updateStep, updateData, questionHelp, setQuestionHelp, closing, canProceed }) {
            const ph = data.scopeType === 'program' ? [
                "Align team on core values and 3 critical moves",
                "Implement ABC delegation system and run first session",
                "Launch weekly metrics dashboard and complete 4 review cycles"
            ] : [
                "Hire A-player VP of Sales and close first 3 major deals",
                "Launch in 2 new markets with validated product-market fit",
                "Build 5-person leadership team with clear OKRs"
            ];

            return (
                <div className="step-content animate-in">
                    <p className="step-indicator">STEP 2 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Map the Outcome</h1>
                        <p className="step-hint">What are the 3 key milestones to reach your end game? Strategy is sacrifice — only 3.</p>
                    </div>

                    <LearnMore>
                        Mental rehearsal works. Lewis Hamilton mentally drives each lap before stepping in the car. Research shows mental practice activates the same brain regions as physical practice.
                    </LearnMore>

                    <div className="questions-grid single-col">
                        {data.steps.map((stepVal, index) => (
                            <div key={index} className="question-box" style={{ marginBottom: 24 }}>
                                <label className="field-label">
                                    Step {index + 1}
                                    <HelpAccordion id={`step${index}`} activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                        <strong>Good milestone:</strong> Specific, measurable, builds toward your end game, you can visualize completing it.
                                    </HelpAccordion>
                                </label>
                                <input type="text" className="field-input" value={stepVal} onChange={e => updateStep(index, e.target.value)} placeholder={ph[index]} />
                            </div>
                        ))}

                        <div className="question-box" style={{ marginTop: 32 }}>
                            <p style={{ fontWeight: 600, fontSize: 16, marginBottom: 8 }}>Mental Rehearsal</p>
                            <p style={{ fontSize: 14, color: '#666', marginBottom: 14 }}>Close your eyes. Picture yourself completing each step. See the details. Feel the momentum.</p>
                            <label style={{ display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer' }}>
                                <input type="checkbox" checked={data.mentallyRehearsed} onChange={e => updateData('mentallyRehearsed', e.target.checked)} style={{ width: 18, height: 18 }} />
                                <span style={{ fontSize: 14 }}>I've mentally rehearsed each step.</span>
                            </label>
                        </div>
                    </div>

                    {canProceed && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">{closing.title}</p>
                            <p>{closing.text}</p>
                        </div>
                    )}
                </div>
            );
        }

        // --- Step 3: Obstacles ---
        function Step3Content({ data, updateObstacle, addObstacle, removeObstacle, questionHelp, setQuestionHelp, closing, canProceed }) {
            return (
                <div className="step-content animate-in">
                    <p className="step-indicator">STEP 3 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Anticipate Obstacles</h1>
                        <p className="step-hint">Identify what will try to stop you. Create specific IF-THEN plans. Max 3 obstacles.</p>
                    </div>

                    <LearnMore>
                        IF-THEN plans increase follow-through by up to 300%. Your brain automatically links trigger to action — no willpower required (Gollwitzer, 1999).
                    </LearnMore>

                    <div className="questions-grid single-col">
                        {data.obstacles && data.obstacles.map((obstacle, index) => (
                            <div key={index} className="question-box">
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 14 }}>
                                    <span className="monument" style={{ fontSize: 11, textTransform: 'uppercase', color: '#666' }}>OBSTACLE {index + 1}</span>
                                    {data.obstacles.length > 1 && (
                                        <button onClick={() => removeObstacle(index)} style={{ background: 'none', border: 'none', fontSize: 18, cursor: 'pointer', color: '#999' }}>&times;</button>
                                    )}
                                </div>

                                <div className="field-group">
                                    <label className="field-label">
                                        What's the problem?
                                        <HelpAccordion id={`obstacle${index}`} activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                            <strong>Good obstacle:</strong> Specific, realistic, actually likely to happen, could genuinely derail progress.
                                        </HelpAccordion>
                                    </label>
                                    <textarea className="field-textarea" style={{ minHeight: 70 }} value={obstacle.problem} onChange={e => updateObstacle(index, 'problem', e.target.value)} placeholder="e.g. Team pushes back on new accountability system" />
                                </div>

                                <div style={{ borderLeft: '3px solid #FFF469', paddingLeft: 16, marginTop: 8 }}>
                                    <p className="monument" style={{ fontSize: 10, textTransform: 'uppercase', color: '#666', marginBottom: 10 }}>IF-THEN PLAN</p>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 }}>
                                        <div className="field-group">
                                            <label className="field-label">IF (trigger)</label>
                                            <input type="text" className="field-input" value={obstacle.ifTrigger} onChange={e => updateObstacle(index, 'ifTrigger', e.target.value)} placeholder="A team member complains..." />
                                        </div>
                                        <div className="field-group">
                                            <label className="field-label">THEN (who?)</label>
                                            <input type="text" className="field-input" value={obstacle.thenPerson} onChange={e => updateObstacle(index, 'thenPerson', e.target.value)} placeholder="I (CEO)" />
                                        </div>
                                        <div className="field-group">
                                            <label className="field-label">WILL (action)</label>
                                            <input type="text" className="field-input" value={obstacle.thenAction} onChange={e => updateObstacle(index, 'thenAction', e.target.value)} placeholder="Schedule 30-min 1-on-1" />
                                        </div>
                                        <div className="field-group">
                                            <label className="field-label">BY WHEN</label>
                                            <input type="text" className="field-input" value={obstacle.byWhen} onChange={e => updateObstacle(index, 'byWhen', e.target.value)} placeholder="Within 24 hours" />
                                        </div>
                                    </div>

                                    {(obstacle.ifTrigger || obstacle.thenAction) && (
                                        <div style={{ background: '#F5F5F5', padding: 10, marginTop: 8, fontSize: 13, color: '#333' }}>
                                            <strong>IF</strong> {obstacle.ifTrigger || '___'}, <strong>THEN</strong> {obstacle.thenPerson || '___'} will <strong>{obstacle.thenAction || '___'}</strong> <strong>BY</strong> {obstacle.byWhen || '___'}
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {data.obstacles.length < 3 && (
                        <button onClick={addObstacle} style={{ width: '100%', padding: '12px 0', border: '2px dashed #E0E0E0', background: 'none', fontSize: 14, cursor: 'pointer', color: '#666', marginBottom: 24 }}>
                            + Add Another Obstacle (Max 3)
                        </button>
                    )}

                    {canProceed && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">{closing.title}</p>
                            <p>{closing.text}</p>
                        </div>
                    )}
                </div>
            );
        }

        // --- Step 4: Plan ---
        function Step4Content({ data, updateData, questionHelp, setQuestionHelp, closing, canProceed }) {
            return (
                <div className="step-content animate-in">
                    <p className="step-indicator">STEP 4 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Create Your Plan</h1>
                        <p className="step-hint">Break down your journey. Choose the smallest, easiest first action. Date = Reality.</p>
                    </div>

                    <LearnMore>
                        The Zeigarnik Effect: once you start a task, your brain becomes obsessed with completing it. A specific deadline activates time-based implementation intentions.
                    </LearnMore>

                    <div className="questions-grid single-col">
                        <div className="question-box">
                            <label className="field-label">
                                What are the big chunks of work?
                                <HelpAccordion id="bigChunks" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                    See the full picture before picking your first bite. List major phases or work streams.
                                </HelpAccordion>
                            </label>
                            <textarea className="field-textarea" style={{ minHeight: 90 }} value={data.bigChunks} onChange={e => updateData('bigChunks', e.target.value)} placeholder={"Define and document company values\nBuild ABC delegation framework\nSet up weekly metrics dashboard"} />
                        </div>

                        <div className="question-box">
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                <div className="field-group">
                                    <label className="field-label">
                                        Smallest first action?
                                        <HelpAccordion id="firstAction" activeHelp={questionHelp} setActiveHelp={setQuestionHelp}>
                                            So small it feels silly. Under 30 min. Impossible to fail at. Creates momentum.
                                        </HelpAccordion>
                                    </label>
                                    <textarea className="field-textarea" style={{ minHeight: 80 }} value={data.firstAction} onChange={e => updateData('firstAction', e.target.value)} placeholder="Book the room. Send the invite. That's it." />
                                </div>
                                <div className="field-group">
                                    <label className="field-label">By when?</label>
                                    <input type="date" className="field-input" value={data.deadline} onChange={e => updateData('deadline', e.target.value)} min={new Date().toISOString().split('T')[0]} />
                                    <p className="field-help">Date = Reality.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {canProceed && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">{closing.title}</p>
                            <p>{closing.text}</p>
                        </div>
                    )}
                </div>
            );
        }

        // --- Canvas View ---
        function CanvasView({ data, onBack }) {
            const handleShare = () => alert('WOOP plan shared with your team. Accountability activated.');

            const [submitStatus, setSubmitStatus] = useState(null); // 'saving' | 'success' | 'error'
            const [submitMessage, setSubmitMessage] = useState('');

            const handleSubmit = async () => {
                try {
                    setSubmitStatus('saving');
                    setSubmitMessage('Reviewing your answers...');
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) { setSubmitStatus('error'); setSubmitMessage('User not authenticated. No user ID found.'); return; }
                    console.log('[WOOP Submit] userId:', userId);
                    const questionMappings = {
                        wish: { outcome: data.outcome, worldChange: data.worldChange, feeling: data.feeling },
                        outcome: { steps: data.steps.filter(s => s.trim()), mentallyRehearsed: data.mentallyRehearsed },
                        obstacle_internal: data.obstacles.filter(o => o.problem),
                        plan_if_then: data.bigChunks,
                        first_action: data.firstAction,
                        commitment_level: data.scopeType
                    };
                    console.log('[WOOP Submit] Submitting with AI challenge:', questionMappings);
                    await AIChallenge.submitWithChallenge(userId, 'woop', questionMappings, {
                        onReviewStart: () => { setSubmitMessage('AI coach is reviewing...'); },
                        onRevise: () => { setSubmitStatus(null); setSubmitMessage(''); onBack(); },
                        onSubmitAnyway: () => { setSubmitStatus('success'); setSubmitMessage('Submission saved successfully!'); },
                        onError: (err) => { setSubmitStatus('error'); setSubmitMessage('Failed to save: ' + err.message); }
                    });
                } catch (error) {
                    console.error('[WOOP Submit] Error:', error);
                    setSubmitStatus('error');
                    setSubmitMessage('Failed to save: ' + error.message);
                }
            };

            const imageToDataURL = (img) => new Promise((resolve, reject) => {
                const c = document.createElement('canvas'); c.width = img.width; c.height = img.height;
                c.getContext('2d').drawImage(img, 0, 0);
                try { resolve(c.toDataURL('image/png')); } catch (e) { reject(e); }
            });

            const handleExport = async (e) => {
                try {
                    const btn = e.target; btn.disabled = true; btn.textContent = 'Generating...';
                    if (!window.jspdf || !window.html2canvas) { alert('PDF libraries loading...'); btn.disabled = false; btn.textContent = 'Export PDF'; return; }
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                    const el = document.getElementById('woop-canvas-content');
                    if (!el) throw new Error('Canvas not found.');
                    const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#fff', useCORS: false, logging: false, width: el.scrollWidth, height: el.scrollHeight });
                    const imgData = canvas.toDataURL('image/png');
                    const pw = 210, ph = 297, m = 10, mw = pw - m * 2, mh = ph - m * 2 - 20;
                    const ar = canvas.width / canvas.height; let iw = mw, ih = iw / ar;
                    if (ih > mh) { ih = mh; iw = ih * ar; }
                    pdf.addImage(imgData, 'PNG', (pw - iw) / 2, m, iw, ih);
                    const logo = new Image(); logo.crossOrigin = 'anonymous'; logo.src = 'FastTrack_F_black (1).png';
                    logo.onload = async () => { try { pdf.addImage(await imageToDataURL(logo), 'PNG', pw - 50, 10, 40, 15); } catch(e){} pdf.save(`WOOP-Canvas-${new Date().toISOString().split('T')[0]}.pdf`); btn.disabled = false; btn.textContent = 'Export PDF'; };
                    logo.onerror = () => { pdf.save(`WOOP-Canvas-${new Date().toISOString().split('T')[0]}.pdf`); btn.disabled = false; btn.textContent = 'Export PDF'; };
                } catch (error) { alert('PDF failed: ' + error.message); if (e?.target) { e.target.disabled = false; e.target.textContent = 'Export PDF'; } }
            };

            return (
                <div style={{ minHeight: '100vh', background: '#fff' }}>
                    <header className="no-print" style={{ borderBottom: '2px solid #000', padding: '16px 24px' }}>
                        <div style={{ maxWidth: 960, margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <div>
                                <h1 className="plaak" style={{ fontSize: 28, marginBottom: 4 }}>YOUR WOOP CANVAS</h1>
                                <p style={{ fontSize: 14, color: '#666' }}>Clarity + Energy = Action</p>
                            </div>
                            <button onClick={onBack} className="btn-back">&larr; Edit</button>
                        </div>
                    </header>
                    <div style={{ maxWidth: 960, margin: '0 auto', padding: '32px 24px' }}>
                        <div id="woop-canvas-content" style={{ border: '2px solid #000', padding: 32, marginBottom: 24 }}>
                            <div style={{ marginBottom: 32 }}>
                                <div className="numbered-section" style={{ marginBottom: 12 }}>[W] YOUR WISH</div>
                                <div className="canvas-wish-box">
                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>ACHIEVED</p>
                                    <p style={{ marginBottom: 16 }}>{data.outcome}</p>
                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>WORLD CHANGED</p>
                                    <p style={{ marginBottom: 16 }}>{data.worldChange}</p>
                                    <p style={{ fontWeight: 600, fontSize: 13, marginBottom: 4, color: '#666' }}>FEELING</p>
                                    <p style={{ fontWeight: 600, fontSize: 18 }}>{data.feeling}</p>
                                </div>
                            </div>
                            <div style={{ marginBottom: 32 }}>
                                <div className="numbered-section" style={{ marginBottom: 12 }}>[O] THE OUTCOME</div>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 12 }}>
                                    {data.steps && data.steps.filter(s => s.trim()).map((s, i) => (
                                        <div key={i} className="canvas-step-box">
                                            <div className="monument" style={{ fontSize: 10, marginBottom: 6, color: '#666' }}>STEP {i + 1}</div>
                                            <p style={{ fontSize: 14 }}>{s}</p>
                                        </div>
                                    ))}
                                </div>
                                {data.mentallyRehearsed && <div style={{ background: '#000', color: '#fff', padding: '6px 12px', marginTop: 8, textAlign: 'center' }}><span className="monument" style={{ fontSize: 10 }}>MENTALLY REHEARSED</span></div>}
                            </div>
                            <div style={{ marginBottom: 32 }}>
                                <div className="numbered-section" style={{ marginBottom: 12 }}>[O] OBSTACLES & IF-THEN PLANS</div>
                                {data.obstacles && data.obstacles.map((o, i) => (
                                    <div key={i} className="canvas-obstacle-box">
                                        <p style={{ fontWeight: 600, marginBottom: 8 }}>Problem {i + 1}: {o.problem}</p>
                                        <div style={{ background: '#fff', padding: 12, border: '1px solid #E0E0E0', fontSize: 14 }}>
                                            <strong>IF</strong> {o.ifTrigger || '—'}, <strong>THEN</strong> {o.thenPerson || '—'} will <strong>{o.thenAction || '—'}</strong> <strong>BY</strong> {o.byWhen || '—'}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div>
                                <div className="numbered-section" style={{ marginBottom: 12 }}>[P] THE PLAN</div>
                                <div className="canvas-plan-box">
                                    <div className="monument" style={{ fontSize: 10, marginBottom: 8, color: '#666' }}>FIRST ACTION</div>
                                    <p style={{ fontSize: 16, marginBottom: 16 }}>{data.firstAction}</p>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#666' }}>DEADLINE:</span>
                                        <span style={{ fontSize: 18, fontWeight: 600 }}>{data.deadline ? new Date(data.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not set'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="no-print" style={{ display: 'flex', gap: 12 }}>
                            <button onClick={handleShare} className="btn-next" style={{ flex: 1 }}>Share With Team</button>
                            <button onClick={handleExport} className="btn-back" style={{ flex: 1 }}>Export PDF</button>
                            <button id="submit-button" data-testid="submit-button" onClick={handleSubmit} className="btn-next" style={{ flex: 1 }} disabled={submitStatus === 'saving'}>
                                {submitStatus === 'saving' ? 'Saving...' : 'Final Submit'}
                            </button>
                        </div>
                        {submitStatus && (
                            <div style={{ marginTop: 16, padding: '12px 16px', textAlign: 'center', background: submitStatus === 'success' ? '#f0fdf4' : submitStatus === 'error' ? '#fef2f2' : '#f5f5f5', border: `1px solid ${submitStatus === 'success' ? '#bbf7d0' : submitStatus === 'error' ? '#fecaca' : '#e0e0e0'}`, fontSize: 14 }}>
                                <span style={{ color: submitStatus === 'success' ? '#166534' : submitStatus === 'error' ? '#991b1b' : '#333' }}>{submitMessage}</span>
                            </div>
                        )}
                        <div style={{ marginTop: 24, textAlign: 'center' }}><p className="monument" style={{ fontSize: 11, color: '#999' }}>CLARITY AND ENERGY LOCKED IN</p></div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<WOOPTool />, document.getElementById('root'));
    </script>
</body>
</html>
