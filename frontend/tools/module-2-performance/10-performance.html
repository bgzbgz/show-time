<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Analysis & Accountability | Fast Track</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../shared/js/transition-screen.js"></script>
    <script src="../../js/tool-access-control.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preload" href="Plaak3Trial-43-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="RiformaLL-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="MonumentGrotesk-Mono.woff2" as="font" type="font/woff2" crossorigin>
    <style>
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); font-display: swap; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Riforma', -apple-system, sans-serif; font-size: 16px; color: #000; background: #000; -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        * { scrollbar-width: thin; scrollbar-color: #000 transparent; }
        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }
        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }
        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main { flex: 1; display: flex; flex-direction: column; min-height: 100vh; background: #fff; }
        .wizard-content { max-width: 720px; width: 100%; margin: 0 auto; padding: 48px 32px; flex: 1; }
        .wizard-sidebar { width: 280px; background: #1a1a1a; min-height: 100vh; padding: 48px 32px; display: flex; flex-direction: column; position: sticky; top: 0; align-self: flex-start; height: 100vh; overflow-y: auto; }
        .wizard-sidebar-inner { padding: 32px 24px; height: 100%; overflow-y: auto; overflow-x: hidden; }
        .sidebar-step-item { padding: 12px; margin-bottom: 8px; border-left: 3px solid transparent; transition: all 0.2s ease; }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }
        .sidebar-phase-header { font-family: 'Monument', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: #FFF469; padding: 8px 12px; margin-top: 16px; margin-bottom: 4px; }
        .step-indicator { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; }
        .step-time { font-family: 'Monument', monospace; font-size: 11px; color: #6B7280; }
        .step-heading { font-family: 'Plaak', sans-serif; font-weight: bold; font-size: 32px; text-transform: uppercase; letter-spacing: -0.01em; line-height: 1.2; color: #000; margin-bottom: 6px; }
        .step-hint { font-size: 16px; color: #6B7280; line-height: 1.5; margin: 0 0 32px 0; }
        .ft-label { display: flex; align-items: center; gap: 6px; font-family: 'Monument', monospace; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; color: #000; margin-bottom: 8px; }
        .ft-required { color: #DC2626; font-weight: 700; }
        .ft-input { width: 100%; height: 44px; padding: 8px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; color: #000; background: #fff; border: 1px solid #E5E7EB; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .ft-input:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px #FFF469; }
        .ft-textarea { width: 100%; min-height: 120px; padding: 12px 16px; font-family: 'Riforma', sans-serif; font-size: 16px; color: #000; background: #fff; border: 1px solid #E5E7EB; resize: none !important; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .ft-textarea:focus { outline: none; border-color: #000; box-shadow: 0 0 0 3px #FFF469; }
        .ft-help { font-size: 14px; color: #6B7280; margin-top: 4px; line-height: 1.5; }
        .ft-field-group { margin-bottom: 24px; }
        .ft-field-group:last-child { margin-bottom: 0; }
        .ft-section { margin-bottom: 32px; }
        .ft-insight { background: #FFF469; border: 3px solid #000; padding: 16px; margin-bottom: 32px; }
        .ft-example { background: #F3F4F6; padding: 16px; margin-bottom: 8px; font-size: 14px; line-height: 1.6; color: #1F2937; }
        .btn-footer { position: sticky; bottom: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 16px 32px; border-top: 1px solid #E5E7EB; background: #fff; width: 100%; }
        .btn-back { background: #fff; color: #000; border: 2px solid #000; padding: 12px 24px; font-family: 'Riforma', sans-serif; font-size: 16px; cursor: pointer; transition: all 0.2s ease; min-height: 44px; }
        .btn-back:hover { background: #F3F4F6; }
        .btn-next { background: #000; color: #fff; border: 2px solid #000; padding: 12px 24px; font-family: 'Riforma', sans-serif; font-size: 16px; cursor: pointer; transition: all 0.2s ease; min-height: 44px; }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E5E7EB; color: #9CA3AF; border-color: #E5E7EB; cursor: not-allowed; }
        .numbered-section { background: #000; color: #fff; padding: 8px 14px; font-size: 14px; font-weight: bold; letter-spacing: 0.5px; display: inline-block; font-family: 'Monument', monospace; }
        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; background: #F3F4F6; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E5E7EB; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }
        @media print { .no-print { display: none !important; } }
        @media (min-width: 769px) and (max-width: 1024px) { .wizard-sidebar { width: 220px; } .wizard-sidebar-inner { padding: 24px 16px; } }
        @media (max-width: 768px) { .wizard-sidebar { display: none; } .mobile-step-bar { display: block; } .wizard-content { padding: 24px 16px; } .step-heading { font-size: 24px; } .btn-footer { padding: 12px 16px; } }
        @media (max-width: 480px) { .step-heading { font-size: 20px; } .wizard-content { padding: 20px 12px; } }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const CONFIG = {
        SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
        SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
        TOOL_SLUG: 'performance',
        AUTOSAVE_DELAY: 2000,
        TRANSITION_CONTENT: {
            1: {
                brutalTruth: 'What gets measured gets managed — but most companies track vanity metrics that feel good and tell you nothing actionable. If you cannot link a KPI to a specific decision, you are measuring the wrong thing.',
                peerProof: '"A €12M B2B firm had 23 KPIs on their dashboard. After this analysis, they kept 5. Revenue clarity improved. Leadership focus shifted. They grew 34% the following year with the same team and budget."'
            },
            2: {
                brutalTruth: 'Task tracking without root cause analysis is just documenting failure. You can monitor every task and still not know why performance is off. The 5 Whys does not take long — avoiding it does.',
                peerProof: '"A manufacturing CEO spent 6 months trying to improve delivery performance by adding more tracking. One 5-Whys session revealed the actual cause: a single scheduling conflict in the ERP system. Fixed in a day. Delivery improved 40%."'
            },
            3: {
                brutalTruth: '80% of your results come from 20% of your actions. But most organizations protect all their activities equally. The companies that break away from the pack are the ones that explicitly defund the 80% to double down on the 20%.',
                peerProof: '"A €8M professional services firm mapped their revenue by client type. The top 20% of clients generated 71% of revenue — and received the same service level as the bottom 80%. After rebalancing, revenue grew 45% in 18 months."'
            },
            4: {
                brutalTruth: 'Accountability without consequences is a suggestion. Clear expectations, public tracking, and real follow-through are not management theatre — they are the system that separates high-performance teams from mediocre ones.',
                peerProof: '"One leadership team replaced their monthly status update meetings with a weekly 15-minute accountability dashboard review. Ownership improved visibly within 30 days. The CEO described it as the single highest-leverage management change they had made in 5 years."'
            }
        },
        CLOSING_MESSAGES: {
            1: { title: 'GOALS TRACKED', text: 'Your performance dashboard is defined. Next: find the root causes of current gaps.' },
            2: { title: 'ROOT CAUSES FOUND', text: 'You know what is actually driving your results. Next: apply the 80/20 lens.' },
            3: { title: '80/20 MAPPED', text: 'Your vital few are identified. Next: build the accountability system to hold them.' },
            4: { title: 'ACCOUNTABILITY SET', text: 'Your performance system is complete. Review it weekly. What gets reviewed gets done.' }
        }
    };

    const { createClient } = supabase;
    const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;
    ToolDB.init(CONFIG.TOOL_SLUG);
    ToolAccessControl.init(CONFIG.TOOL_SLUG);

    CognitiveLoad.init('performance', {
        insights: [
            "What gets measured gets managed. But what gets measured WRONG gets gamed.",
            "Binary task tracking (done/not done) eliminates the gray zone. No more 80% complete.",
            "The Theory of Constraints says your system is only as strong as its weakest link. Find it. Fix it. Repeat."
        ],
        caseStudy: {
            before: "A 30-person SaaS company tracked effort instead of outcomes. Teams reported being 'busy' but quarterly targets were missed 60% of the time. No one owned specific metrics, and performance reviews happened once a year — too late to course-correct.",
            after: "After implementing binary task tracking, weekly dashboards, and the 5 Whys for root cause analysis, task completion jumped from 55% to 88% in one quarter. The accountability framework gave every task a single owner with clear consequences.",
            quote: "Once we stopped tracking effort and started tracking outcomes, everything changed. The 5 Whys revealed our real bottleneck was onboarding, not capacity. — Operations Director, SaaS company"
        }
    });
    const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy } = CognitiveLoad.components;

    const MEETING_AGENDA = [
        { time: '5 min', title: 'Objective Setting', desc: 'Brief recap of sprint goals and meeting objectives.', questions: ['What are the key outcomes we need from this meeting?'], pitfalls: ['Skipping the objective and diving into discussion without alignment.'] },
        { time: '25 min', title: 'Performance Analysis System', desc: 'Review proposed system structure: tasks done/not done, reasons for gaps, improvement commitments.', questions: ['Are tasks and metrics defined clearly for all team members?', 'Is there a binary approach (done/not done) to task evaluation?', 'Are dashboards designed to track individual and team metrics?'], pitfalls: ['Using vague metrics instead of binary done/not-done.', 'Designing dashboards nobody will actually check.'] },
        { time: '25 min', title: 'Accountability & Consequences System', desc: 'Review the Accountability Checklist and key practices. Align on the consequences framework.', questions: ['Are roles and responsibilities clearly assigned?', 'Is the consequences framework transparent and fair?', 'Are timelines realistic and agreed upon?'], pitfalls: ['Making consequences punitive instead of constructive.', 'Leaving tasks without a single clear owner.'] },
        { time: '5 min', title: 'Action Plan & Closing', desc: 'Confirm Who, What, When for all agreed actions.', questions: ['Does every action have a single owner and deadline?'], pitfalls: ['Ending without written commitments.'] }
    ];

    /* === SHARED COMPONENTS === */
    function CheckIcon({ color = "#fff", size = 16 }) {
        return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
    }
    function LockIcon({ size = 16 }) {
        return <svg width={size} height={size} viewBox="0 0 24 24" fill="#9CA3AF"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>;
    }
    function ButtonFooter({ onBack, onNext, nextLabel = 'Next', showBack = true, disabled = false }) {
        return (
            <div className="btn-footer no-print">
                {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                <button className="btn-next" disabled={disabled} onClick={onNext}>{nextLabel} &rarr;</button>
            </div>
        );
    }
    function MobileStepBar({ step, total }) {
        return (
            <div className="mobile-step-bar no-print">
                <div className="bar-text">Step {step} of {total}</div>
                <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${Math.round((step / total) * 100)}%` }} /></div>
            </div>
        );
    }

    /* === STEP 1: GOAL SETTING & PERFORMANCE MONITORING === */
    function Step1({ d, u }) {
        const goals = d.goals || Array(5).fill(null).map(() => ({ goal: '', kpi: '', countermeasure: '', q1: '', q2: '', q3: '', q4: '' }));
        const updateGoal = (i, f, v) => { const next = [...goals]; next[i] = { ...next[i], [f]: v }; u('goals', next); };
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Step 1 of 6</span><span className="step-time">~10 min</span></div>
                <h2 className="step-heading">GOAL SETTING & MONITORING</h2>
                <p className="step-hint">Define 5 specific, measurable goals for the year. Break each into quarterly deliverables with clear KPIs and owners.</p>
                <div className="ft-example">Example: "Increase revenue by 20%, but maintain gross margins above 40%." The countermeasure (margin target) prevents chasing revenue at any cost.</div>
                {goals.map((g, i) => (
                    <div key={i} style={{ border: '2px solid #000', padding: 24, marginBottom: 24 }}>
                        <div className="numbered-section" style={{ marginBottom: 16 }}>GOAL {i + 1}</div>
                        <div className="ft-field-group">
                            <label className="ft-label">NUMERIC GOAL <span className="ft-required">*</span></label>
                            <input className="ft-input" placeholder="e.g. Increase monthly revenue to €100K" value={g.goal} onChange={e => updateGoal(i, 'goal', e.target.value)} />
                        </div>
                        <div className="ft-field-group">
                            <label className="ft-label">KPI (HOW YOU'LL MEASURE)</label>
                            <input className="ft-input" placeholder="e.g. Monthly revenue dashboard" value={g.kpi} onChange={e => updateGoal(i, 'kpi', e.target.value)} />
                        </div>
                        <div className="ft-field-group">
                            <label className="ft-label">COUNTERMEASURE</label>
                            <input className="ft-input" placeholder="e.g. Maintain gross margin above 40%" value={g.countermeasure} onChange={e => updateGoal(i, 'countermeasure', e.target.value)} />
                            <div className="ft-help">What safeguard prevents over-focus on this goal at the expense of other priorities?</div>
                        </div>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: 8, marginTop: 16 }}>
                            {['q1', 'q2', 'q3', 'q4'].map(q => (
                                <div key={q}>
                                    <label className="ft-label" style={{ fontSize: 11 }}>{q.toUpperCase()} TARGET</label>
                                    <input className="ft-input" style={{ fontSize: 14 }} placeholder="Quarterly deliverable" value={g[q]} onChange={e => updateGoal(i, q, e.target.value)} />
                                </div>
                            ))}
                        </div>
                    </div>
                ))}
                {/* TODO: add field condition */}
<div className="ft-reveal-science">
    <div className="ft-reveal-label">SCIENCE BEHIND IT</div>
    <p className="ft-reveal-text">Research by Locke & Latham (2002) shows that specific, challenging goals lead to higher performance 90% of the time. Quarterly breakdowns increase goal attainment by 33% (Harvard Business Review).</p>
  </div>
            </div>
        );
    }

    /* === STEP 2: PERFORMANCE MEASUREMENT (BINARY TASK TRACKING) === */
    function Step2({ d, u }) {
        const tasks = d.tasks || Array(8).fill(null).map(() => ({ task: '', status: 'not-done', owner: '', reason: '' }));
        const updateTask = (i, f, v) => { const next = [...tasks]; next[i] = { ...next[i], [f]: v }; u('tasks', next); };
        const doneCount = tasks.filter(t => t.status === 'done' && (t.task || '').trim()).length;
        const totalFilled = tasks.filter(t => (t.task || '').trim()).length;
        const rate = totalFilled > 0 ? Math.round((doneCount / totalFilled) * 100) : 0;
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Step 2 of 6</span><span className="step-time">~8 min</span></div>
                <h2 className="step-heading">PERFORMANCE MEASUREMENT</h2>
                <p className="step-hint">Track your tasks with binary measurement: DONE or NOT DONE. No gray zones. Document reasons for any gaps and commit to improvements.</p>
                <div style={{ background: '#000', color: '#fff', padding: 24, textAlign: 'center', marginBottom: 32 }}>
                    <div className="monument" style={{ fontSize: 11, color: '#FFF469', marginBottom: 8 }}>COMPLETION RATE</div>
                    <div className="plaak" style={{ fontSize: 48, color: rate >= 80 ? '#FFF469' : '#fff' }}>{rate}%</div>
                    <div style={{ fontSize: 14, color: '#999' }}>{doneCount} of {totalFilled} tasks done</div>
                </div>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 14, marginBottom: 24 }}>
                    <thead><tr style={{ background: '#000', color: '#fff' }}>
                        <th style={{ padding: '10px 12px', textAlign: 'left', fontFamily: "'Monument', monospace", fontSize: 11 }}>#</th>
                        <th style={{ padding: '10px 12px', textAlign: 'left', fontFamily: "'Monument', monospace", fontSize: 11 }}>TASK</th>
                        <th style={{ padding: '10px 12px', width: 100, fontFamily: "'Monument', monospace", fontSize: 11 }}>STATUS</th>
                        <th style={{ padding: '10px 12px', width: 120, fontFamily: "'Monument', monospace", fontSize: 11 }}>OWNER</th>
                    </tr></thead>
                    <tbody>
                        {tasks.map((t, i) => (
                            <React.Fragment key={i}>
                                <tr style={{ borderBottom: '1px solid #E5E7EB' }}>
                                    <td style={{ padding: '8px 12px', fontWeight: 600 }}>{i + 1}</td>
                                    <td style={{ padding: 8 }}><input className="ft-input" style={{ border: 'none', height: 36 }} placeholder={`Task ${i + 1}...`} value={t.task} onChange={e => updateTask(i, 'task', e.target.value)} /></td>
                                    <td style={{ padding: 8, textAlign: 'center' }}>
                                        <select className="ft-input" style={{ height: 36, fontSize: 13, textAlign: 'center', background: t.status === 'done' ? '#DCFCE7' : '#FEF2F2', fontWeight: 600 }} value={t.status} onChange={e => updateTask(i, 'status', e.target.value)}>
                                            <option value="not-done">NOT DONE</option>
                                            <option value="done">DONE</option>
                                        </select>
                                    </td>
                                    <td style={{ padding: 8 }}><input className="ft-input" style={{ border: 'none', height: 36, fontSize: 13 }} placeholder="Owner" value={t.owner} onChange={e => updateTask(i, 'owner', e.target.value)} /></td>
                                </tr>
                                {t.status === 'not-done' && (t.task || '').trim() && (
                                    <tr style={{ background: '#FEF2F2' }}>
                                        <td colSpan={4} style={{ padding: '8px 12px' }}>
                                            <input className="ft-input" style={{ border: 'none', height: 32, background: 'transparent', fontSize: 13, color: '#991B1B' }} placeholder="Why not done? (Document the reason)" value={t.reason} onChange={e => updateTask(i, 'reason', e.target.value)} />
                                        </td>
                                    </tr>
                                )}
                            </React.Fragment>
                        ))}
                    </tbody>
                </table>
                <div className="ft-field-group">
                    <label className="ft-label">DASHBOARD METRICS</label>
                    <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="What key metrics will your dashboard track? (e.g. Weekly task completion rate, revenue per employee, customer satisfaction score)" value={d.dashboardMetrics || ''} onChange={e => u('dashboardMetrics', e.target.value)} />
                </div>
                <div className="ft-field-group">
                    <label className="ft-label">REVIEW CADENCE</label>
                    <input className="ft-input" placeholder="e.g. Weekly Monday 9am, Monthly deep-dive first Friday" value={d.reviewCadence || ''} onChange={e => u('reviewCadence', e.target.value)} />
                </div>
            </div>
        );
    }

    /* === STEP 3: 5 WHYS ROOT CAUSE ANALYSIS === */
    function Step3({ d, u }) {
        const whys = d.fiveWhys || { problem: '', why1: '', why2: '', why3: '', why4: '', why5: '', rootCause: '', solution: '', validation: '' };
        const uw = (f, v) => u('fiveWhys', { ...whys, [f]: v });
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Step 3 of 6</span><span className="step-time">~8 min</span></div>
                <h2 className="step-heading">5 WHYS — ROOT CAUSE</h2>
                <p className="step-hint">Drill down to the root cause of your biggest performance problem. Ask "Why?" five times until you reach the real issue — not just a symptom.</p>
                <div className="ft-example">
                    <strong>Example:</strong> "Delivery times are delayed" → Why? Orders don't leave on time → Why? Packaging takes too long → Why? Not enough staff → Why? High turnover → Why? Inadequate training for new hires → <strong>Root cause: onboarding process</strong>
                </div>
                <div className="ft-field-group">
                    <label className="ft-label">PROBLEM STATEMENT <span className="ft-required">*</span></label>
                    <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="What specific problem are you experiencing? Be precise." value={whys.problem} onChange={e => uw('problem', e.target.value)} />
                </div>
                {[1, 2, 3, 4, 5].map(n => (
                    <div key={n} className="ft-field-group" style={{ borderLeft: `4px solid ${n <= 2 ? '#FFF469' : n <= 4 ? '#F59E0B' : '#DC2626'}`, paddingLeft: 16 }}>
                        <label className="ft-label">WHY #{n} {n === 1 && <span className="ft-required">*</span>}</label>
                        <input className="ft-input" placeholder={n === 1 ? 'Why does this problem exist?' : `Why? (dig deeper from answer #${n - 1})`} value={whys[`why${n}`]} onChange={e => uw(`why${n}`, e.target.value)} />
                    </div>
                ))}
                <div style={{ background: '#000', color: '#fff', padding: 24, marginBottom: 24 }}>
                    <div className="ft-field-group" style={{ marginBottom: 16 }}>
                        <label className="ft-label" style={{ color: '#FFF469' }}>ROOT CAUSE IDENTIFIED <span className="ft-required">*</span></label>
                        <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="Based on your 5 Whys, what is the real root cause?" value={whys.rootCause} onChange={e => uw('rootCause', e.target.value)} />
                    </div>
                    <div className="ft-field-group" style={{ marginBottom: 16 }}>
                        <label className="ft-label" style={{ color: '#FFF469' }}>PROPOSED SOLUTION</label>
                        <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="What solution directly addresses this root cause?" value={whys.solution} onChange={e => uw('solution', e.target.value)} />
                    </div>
                    <div className="ft-field-group">
                        <label className="ft-label" style={{ color: '#FFF469' }}>VALIDATION METRIC</label>
                        <input className="ft-input" placeholder="How will you confirm the root cause is truly fixed?" value={whys.validation} onChange={e => uw('validation', e.target.value)} />
                    </div>
                </div>
            </div>
        );
    }

    /* === STEP 4: 80/20 PRINCIPLE === */
    function Step4({ d, u }) {
        const p = d.eighty20 || { objective: '', inputs: Array(10).fill(null).map(() => ({ input: '', contribution: 0 })), vitalFew: '', trivialMany: '', actions: '' };
        const up = (f, v) => u('eighty20', { ...p, [f]: v });
        const inputs = p.inputs || [];
        const updateInput = (i, f, v) => { const next = [...inputs]; next[i] = { ...next[i], [f]: v }; up('inputs', next); };
        const sorted = [...inputs].filter(inp => inp && (inp.input || '').trim()).sort((a, b) => (b.contribution || 0) - (a.contribution || 0));
        const totalContrib = sorted.reduce((s, inp) => s + (parseInt(inp.contribution) || 0), 0);
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Step 4 of 6</span><span className="step-time">~8 min</span></div>
                <h2 className="step-heading">80/20 PRINCIPLE</h2>
                <p className="step-hint">Identify the 20% of inputs that drive 80% of your results. Focus resources there and eliminate or automate the rest.</p>
                <div className="ft-field-group">
                    <label className="ft-label">OBJECTIVE <span className="ft-required">*</span></label>
                    <input className="ft-input" placeholder="What result are you analyzing? (e.g. Increase sales revenue)" value={p.objective} onChange={e => up('objective', e.target.value)} />
                </div>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 14, marginBottom: 16 }}>
                    <thead><tr style={{ background: '#000', color: '#fff' }}>
                        <th style={{ padding: '10px 12px', textAlign: 'left', fontFamily: "'Monument', monospace", fontSize: 11 }}>#</th>
                        <th style={{ padding: '10px 12px', textAlign: 'left', fontFamily: "'Monument', monospace", fontSize: 11 }}>INPUT / FACTOR</th>
                        <th style={{ padding: '10px 12px', width: 120, textAlign: 'center', fontFamily: "'Monument', monospace", fontSize: 11 }}>CONTRIBUTION %</th>
                    </tr></thead>
                    <tbody>
                        {inputs.map((inp, i) => (
                            <tr key={i} style={{ borderBottom: '1px solid #E5E7EB', background: sorted.indexOf(inp) < Math.ceil(sorted.length * 0.2) && (inp.input || '').trim() ? '#FEFCE8' : 'transparent' }}>
                                <td style={{ padding: '8px 12px', fontWeight: 600 }}>{i + 1}</td>
                                <td style={{ padding: 8 }}><input className="ft-input" style={{ border: 'none', height: 36 }} placeholder={['Customer segment A', 'Product line X', 'Marketing channel Y', 'Sales rep team', 'Referral program'][i] || `Input ${i + 1}`} value={inp.input} onChange={e => updateInput(i, 'input', e.target.value)} /></td>
                                <td style={{ padding: 8 }}><input className="ft-input" type="number" min="0" max="100" style={{ border: 'none', height: 36, textAlign: 'center', width: 80 }} placeholder="%" value={inp.contribution} onChange={e => updateInput(i, 'contribution', e.target.value)} /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                {totalContrib > 0 && (
                    <div style={{ background: '#F3F4F6', padding: 16, marginBottom: 24 }}>
                        <div className="monument" style={{ fontSize: 10, color: '#6B7280', marginBottom: 4 }}>TOTAL CONTRIBUTION</div>
                        <div style={{ fontSize: 20, fontWeight: 600, color: totalContrib === 100 ? '#000' : '#DC2626' }}>{totalContrib}%</div>
                        {totalContrib !== 100 && <div style={{ fontSize: 13, color: '#DC2626' }}>Should add up to 100%</div>}
                    </div>
                )}
                <div className="ft-field-group">
                    <label className="ft-label">THE VITAL FEW (TOP 20%)</label>
                    <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="Which inputs deliver the most results? How can you enhance them?" value={p.vitalFew} onChange={e => up('vitalFew', e.target.value)} />
                </div>
                <div className="ft-field-group">
                    <label className="ft-label">THE TRIVIAL MANY (BOTTOM 80%)</label>
                    <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="Which inputs can you stop, automate, or delegate?" value={p.trivialMany} onChange={e => up('trivialMany', e.target.value)} />
                </div>
            </div>
        );
    }

    /* === STEP 5: THEORY OF CONSTRAINTS === */
    function Step5({ d, u }) {
        const toc = d.constraints || { systemDescription: '', constraint: '', exploit: '', subordinate: '', elevate: '', nextConstraint: '' };
        const ut = (f, v) => u('constraints', { ...toc, [f]: v });
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Step 5 of 6</span><span className="step-time">~8 min</span></div>
                <h2 className="step-heading">THEORY OF CONSTRAINTS</h2>
                <p className="step-hint">Your system is only as strong as its weakest link. Identify the single biggest bottleneck, then systematically resolve it.</p>
                <div className="ft-example">
                    <strong>Example:</strong> A manufacturing line where Station 3 processes 50 units/hour but Station 1 and 2 process 100. Station 3 is the constraint. Solution: Run Station 3 in double shifts (exploit), slow Station 1-2 to match pace (subordinate), then upgrade Station 3 equipment (elevate).
                </div>
                <div className="ft-field-group">
                    <label className="ft-label">YOUR SYSTEM / PROCESS</label>
                    <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="Describe the system or process you're analyzing..." value={toc.systemDescription} onChange={e => ut('systemDescription', e.target.value)} />
                </div>
                {[
                    { key: 'constraint', label: '1. IDENTIFY THE CONSTRAINT', ph: 'Which single step or resource limits the entire system\'s output?', hint: 'Look for where work piles up, delays occur, or queues form.' },
                    { key: 'exploit', label: '2. EXPLOIT THE CONSTRAINT', ph: 'How can you maximize efficiency of this bottleneck without major investment?', hint: 'e.g. Adjust schedules, remove interruptions, ensure it never sits idle.' },
                    { key: 'subordinate', label: '3. SUBORDINATE OTHER PROCESSES', ph: 'How should the rest of the system sync with the bottleneck\'s pace?', hint: 'Reduce upstream output to match; don\'t overwhelm the constraint.' },
                    { key: 'elevate', label: '4. ELEVATE THE CONSTRAINT', ph: 'If it still limits output, what investment or innovation can expand its capacity?', hint: 'e.g. Hire, upgrade equipment, redesign the process.' },
                    { key: 'nextConstraint', label: '5. IDENTIFY NEXT CONSTRAINT', ph: 'Once this bottleneck is resolved, where does the next one appear?', hint: 'The process repeats — continuous improvement never stops.' }
                ].map(f => (
                    <div key={f.key} className="ft-field-group" style={{ borderLeft: '4px solid #000', paddingLeft: 16 }}>
                        <label className="ft-label">{f.label} {f.key === 'constraint' && <span className="ft-required">*</span>}</label>
                        <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder={f.ph} value={toc[f.key]} onChange={e => ut(f.key, e.target.value)} />
                        <div className="ft-help">{f.hint}</div>
                    </div>
                ))}
            </div>
        );
    }

    /* === STEP 6: ACCOUNTABILITY SYSTEM === */
    function Step6({ d, u }) {
        const acc = d.accountability || { expectations: '', ownership: '', checkpoints: '', consequences: '', rewards: '', corrective: '', dashboardPlan: '', transparency: '', reviewPlan: '' };
        const ua = (f, v) => u('accountability', { ...acc, [f]: v });
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Step 6 of 6</span><span className="step-time">~10 min</span></div>
                <h2 className="step-heading">ACCOUNTABILITY SYSTEM</h2>
                <p className="step-hint">Build a 7-step accountability and consequences framework. Clear expectations, single owners, transparent consequences.</p>
                {[
                    { key: 'expectations', num: '1', label: 'DEFINE EXPECTATIONS', ph: 'Clearly articulate roles, tasks, and measurable goals for each individual/team...', hint: 'Are responsibilities specific and measurable? e.g. "Close $50K in monthly revenue"' },
                    { key: 'ownership', num: '2', label: 'ASSIGN OWNERSHIP', ph: 'Ensure each task has a single accountable owner...', hint: 'No overlaps. One person owns each deliverable.' },
                    { key: 'checkpoints', num: '3', label: 'SET CHECKPOINTS', ph: 'Establish regular review points: weekly, monthly, quarterly...', hint: 'When and how will performance be evaluated?' },
                    { key: 'consequences', num: '4', label: 'CONSEQUENCES FRAMEWORK', ph: 'Define what happens when goals are met or missed...', hint: 'Must be transparent, fair, and documented.' }
                ].map(f => (
                    <div key={f.key} className="ft-field-group">
                        <label className="ft-label">{f.num}. {f.label} {f.num === '1' && <span className="ft-required">*</span>}</label>
                        <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder={f.ph} value={acc[f.key]} onChange={e => ua(f.key, e.target.value)} />
                        <div className="ft-help">{f.hint}</div>
                    </div>
                ))}
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginBottom: 24 }}>
                    <div className="ft-field-group">
                        <label className="ft-label">REWARDS FOR SUCCESS</label>
                        <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="Bonus, recognition, career advancement..." value={acc.rewards} onChange={e => ua('rewards', e.target.value)} />
                    </div>
                    <div className="ft-field-group">
                        <label className="ft-label">CORRECTIVE ACTIONS</label>
                        <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder="Training, mentorship, performance plan..." value={acc.corrective} onChange={e => ua('corrective', e.target.value)} />
                    </div>
                </div>
                {[
                    { key: 'dashboardPlan', num: '5', label: 'IMPLEMENT DASHBOARDS', ph: 'How will you visualize progress? Can everyone see the team\'s progress in real-time?' },
                    { key: 'transparency', num: '6', label: 'FOSTER TRANSPARENCY', ph: 'How will you ensure everyone understands the system and its implications?' },
                    { key: 'reviewPlan', num: '7', label: 'REVIEW & ADJUST PLAN', ph: 'How often will you revisit the system? Is the system driving intended behaviors?' }
                ].map(f => (
                    <div key={f.key} className="ft-field-group">
                        <label className="ft-label">{f.num}. {f.label}</label>
                        <textarea className="ft-textarea" style={{ minHeight: 80 }} placeholder={f.ph} value={acc[f.key]} onChange={e => ua(f.key, e.target.value)} />
                    </div>
                ))}
            </div>
        );
    }

    /* === TEAM STEP A: MEETING AGENDA === */
    function TeamStepAgenda() {
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Team Step 1 of 2</span><span className="step-time">60 min meeting</span></div>
                <h2 className="step-heading">TEAM MEETING AGENDA</h2>
                <p className="step-hint">Facilitate a 60-minute team meeting to establish the performance analysis and accountability systems.</p>
                <div className="ft-insight"><strong>Meeting purpose:</strong> Establish two foundational systems — a robust performance analysis framework and a structured accountability & consequences plan. By the end, you'll have clear agreements on who, what, when, and how for both.</div>
                {MEETING_AGENDA.map((seg, i) => (
                    <div key={i} style={{ border: '2px solid #000', padding: 24, marginBottom: 16 }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                            <div className="numbered-section">{seg.title.toUpperCase()}</div>
                            <span className="monument" style={{ fontSize: 12, color: '#6B7280' }}>{seg.time}</span>
                        </div>
                        <p style={{ fontSize: 15, color: '#374151', lineHeight: 1.6, marginBottom: 16 }}>{seg.desc}</p>
                        {seg.questions.length > 0 && (
                            <div style={{ marginBottom: 12 }}>
                                <div className="monument" style={{ fontSize: 10, color: '#6B7280', marginBottom: 8 }}>KEY QUESTIONS</div>
                                {seg.questions.map((q, qi) => (
                                    <div key={qi} style={{ display: 'flex', gap: 8, marginBottom: 4, fontSize: 14 }}>
                                        <span style={{ color: '#FFF469', background: '#000', width: 20, height: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, flexShrink: 0 }}>{qi + 1}</span>
                                        <span>{q}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                        {seg.pitfalls.length > 0 && (
                            <div style={{ background: '#FEF2F2', padding: 12 }}>
                                <div className="monument" style={{ fontSize: 10, color: '#991B1B', marginBottom: 4 }}>AVOID</div>
                                {seg.pitfalls.map((p, pi) => <div key={pi} style={{ fontSize: 13, color: '#991B1B', marginBottom: 2 }}>• {p}</div>)}
                            </div>
                        )}
                    </div>
                ))}
            </div>
        );
    }

    /* === TEAM STEP B: ACTION PLAN & WWW === */
    function TeamStepWWW({ d, u }) {
        const takeaways = d.teamTakeaways || '';
        const strategies = d.teamStrategies || '';
        const www = d.teamWWW || Array(5).fill(null).map(() => ({ who: '', what: '', when: '' }));
        const updateWWW = (i, f, v) => { const next = [...www]; next[i] = { ...next[i], [f]: v }; u('teamWWW', next); };
        return (
            <div className="animate-in">
                <div className="step-indicator"><span>Team Step 2 of 2</span><span className="step-time">~5 min</span></div>
                <h2 className="step-heading">ACTION PLAN & WWW</h2>
                <p className="step-hint">Document the meeting's conclusions and assign clear ownership for every action.</p>
                <div className="ft-field-group">
                    <label className="ft-label">KEY TAKEAWAYS</label>
                    <textarea className="ft-textarea" placeholder="What were the most important insights and decisions from this meeting?" value={takeaways} onChange={e => u('teamTakeaways', e.target.value)} />
                </div>
                <div className="ft-field-group">
                    <label className="ft-label">PERFORMANCE STRATEGIES AGREED</label>
                    <textarea className="ft-textarea" placeholder="What specific performance and accountability strategies did the team agree to implement?" value={strategies} onChange={e => u('teamStrategies', e.target.value)} />
                </div>
                <div className="numbered-section" style={{ marginBottom: 16 }}>WHO / WHAT / WHEN</div>
                <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: 14, marginBottom: 24 }}>
                    <thead><tr style={{ background: '#000', color: '#fff' }}>
                        <th style={{ padding: '10px 12px', fontFamily: "'Monument', monospace", fontSize: 11 }}>WHO</th>
                        <th style={{ padding: '10px 12px', fontFamily: "'Monument', monospace", fontSize: 11 }}>WHAT</th>
                        <th style={{ padding: '10px 12px', width: 130, fontFamily: "'Monument', monospace", fontSize: 11 }}>WHEN</th>
                    </tr></thead>
                    <tbody>
                        {www.map((row, i) => (
                            <tr key={i} style={{ borderBottom: '1px solid #E5E7EB' }}>
                                <td style={{ padding: 8 }}><input className="ft-input" style={{ border: 'none', height: 36, fontSize: 14 }} placeholder="Person responsible" value={row.who} onChange={e => updateWWW(i, 'who', e.target.value)} /></td>
                                <td style={{ padding: 8 }}><input className="ft-input" style={{ border: 'none', height: 36, fontSize: 14 }} placeholder="Action item" value={row.what} onChange={e => updateWWW(i, 'what', e.target.value)} /></td>
                                <td style={{ padding: 8 }}><input className="ft-input" type="date" style={{ border: 'none', height: 36, fontSize: 13 }} value={row.when} onChange={e => updateWWW(i, 'when', e.target.value)} /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );
    }

    /* === SIDEBAR === */
    function WizardSidebar({ step, teamUnlocked, onNavigate }) {
        const indSteps = [
            { num: 1, label: 'Goals & Monitoring' },
            { num: 2, label: 'Task Tracking' },
            { num: 3, label: '5 Whys' },
            { num: 4, label: '80/20 Principle' },
            { num: 5, label: 'Constraints' },
            { num: 6, label: 'Accountability' },
            { num: 7, label: 'Review & Submit' }
        ];
        const teamSteps = [
            { num: 8, label: 'Meeting Agenda' },
            { num: 9, label: 'Action Plan & WWW' }
        ];
        return (
            <div className="wizard-sidebar no-print">
                <div className="wizard-sidebar-inner">
                    <div style={{ marginBottom: 24 }}>
                        <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>PERFORMANCE</div>
                        <div style={{ fontSize: 13, color: '#999' }}>Sprint 10</div>
                    </div>
                    <div className="sidebar-phase-header">Individual Assessment</div>
                    {indSteps.map(s => {
                        const isCompleted = step > s.num, isActive = step === s.num, isLocked = step < s.num;
                        return (
                            <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`} onClick={() => isCompleted && onNavigate(s.num)}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                    {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                                    <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                                </div>
                            </div>
                        );
                    })}
                    <div className="sidebar-phase-header" style={{ opacity: teamUnlocked ? 1 : 0.4 }}>
                        {teamUnlocked ? 'Team Meeting' : 'Team (Locked)'}
                    </div>
                    {teamSteps.map(s => {
                        const isActive = step === s.num, isCompleted = step > s.num;
                        return (
                            <div key={s.num} className={`sidebar-step-item ${!teamUnlocked ? 'locked' : isActive ? 'active' : isCompleted ? 'completed' : 'locked'}`} onClick={() => teamUnlocked && isCompleted && onNavigate(s.num)}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                    {teamUnlocked && isCompleted ? <CheckIcon color="#000" size={14} /> : !teamUnlocked ? <LockIcon size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                                    <span className="step-name" style={{ color: !teamUnlocked ? '#666' : isActive ? '#fff' : isCompleted ? '#000' : '#ccc' }}>{s.label}</span>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    }

    /* === MAIN APP === */
    const totalSteps = 6;

    function PerformanceApp() {
        const [step, setStep] = useState(0);
        const [data, setData] = useState({});
        const [teamData, setTeamData] = useState({});
        const [teamToolUnlocked, setTeamToolUnlocked] = useState(true); // always unlocked
        const [checkingTeamUnlock, setCheckingTeamUnlock] = useState(false);
        const [individualSubmitted, setIndividualSubmitted] = useState(false);
        const [submitStatus, setSubmitStatus] = useState(null);
        const [submitMessage, setSubmitMessage] = useState('');
        const [aiReviewing, setAiReviewing] = useState(false);
        const autosaveRef = useRef(null);

        const u = (field, value) => setData(prev => ({ ...prev, [field]: value }));
        const ut = (field, value) => setTeamData(prev => ({ ...prev, [field]: value }));

        const goToStep = (s) => { window.scrollTo({ top: 0, behavior: 'smooth' }); setStep(s); };

        // AI-gated step navigation
        const handleNext = async (fromStep) => {
            const nextStep = fromStep < 5 ? fromStep + 0.5 : fromStep + 1;
            const userId = localStorage.getItem('ft_user_id');
            if (!userId || !window.AIChallenge) {
                goToStep(nextStep);
                return;
            }
            setAiReviewing(true);
            try {
                let stepAnswers = {};
                let stepName = '';
                if (fromStep === 1) { stepName = 'Goal Setting & Monitoring'; stepAnswers = { goals: data.goals }; }
                else if (fromStep === 2) { stepName = 'Performance Measurement'; stepAnswers = { tasks: data.tasks }; }
                else if (fromStep === 3) { stepName = '5 Whys Root Cause'; stepAnswers = { five_why: data.fiveWhys }; }
                else if (fromStep === 4) { stepName = '80/20 Principle'; stepAnswers = { eighty20: data.eighty20 }; }
                else if (fromStep === 5) { stepName = 'Theory of Constraints'; stepAnswers = { constraints: data.constraints }; }
                else if (fromStep === 6) { stepName = 'Accountability System'; stepAnswers = { accountability: data.accountability }; }
                const canProceed = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, stepAnswers, stepName);
                if (canProceed) {
                    goToStep(nextStep);
                }
            } catch (err) {
                console.warn('[AIChallenge] Error, allowing passage:', err);
                goToStep(nextStep);
            } finally {
                setAiReviewing(false);
            }
        };

        // Autosave
        useEffect(() => {
            if (autosaveRef.current) clearTimeout(autosaveRef.current);
            autosaveRef.current = setTimeout(() => {
                try {
                    localStorage.setItem('ft_performance_data', JSON.stringify(data));
                    localStorage.setItem('ft_performance_team', JSON.stringify(teamData));
                } catch (e) { /* quota */ }
            }, CONFIG.AUTOSAVE_DELAY);
            return () => clearTimeout(autosaveRef.current);
        }, [data, teamData]);

        // Load saved data
        useEffect(() => {
            try {
                const saved = localStorage.getItem('ft_performance_data');
                if (saved) setData(JSON.parse(saved));
                const savedTeam = localStorage.getItem('ft_performance_team');
                if (savedTeam) setTeamData(JSON.parse(savedTeam));
            } catch (e) { /* parse fail */ }
        }, []);

        // Check team unlock
        const checkTeamUnlock = async () => {
            setCheckingTeamUnlock(true);
            try {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) { setCheckingTeamUnlock(false); return; }
                const { data: userData } = await supabaseClient.from('users').select('organization_id').eq('id', userId).single();
                if (!userData?.organization_id) { setCheckingTeamUnlock(false); return; }
                const { data: orgMembers } = await supabaseClient.from('users').select('id').eq('organization_id', userData.organization_id);
                if (!orgMembers || orgMembers.length === 0) { setCheckingTeamUnlock(false); return; }
                const memberIds = orgMembers.map(m => m.id);
                const { data: submissions } = await supabaseClient.from('user_responses').select('user_id').eq('tool_slug', 'performance-individual').in('user_id', memberIds);
                const submittedCount = submissions ? new Set(submissions.map(s => s.user_id)).size : 0;
                setTeamToolUnlocked(submittedCount >= orgMembers.length);
            } catch (e) {
                console.warn('[Performance] Team unlock check failed:', e);
            } finally {
                setCheckingTeamUnlock(false);
            }
        };

        useEffect(() => { if (step === 0.5) checkTeamUnlock(); }, [step]);

        // Individual submit
        const handleIndividualSubmit = async () => {
            const userId = localStorage.getItem('ft_user_id');
            if (!userId) { alert('User not authenticated.'); return; }
            const questionMappings = {
                five_why: data.fiveWhys,
                execution_dashboard: { goals: data.goals, tasks: data.tasks, eighty20: data.eighty20, constraints: data.constraints, reviewCadence: data.reviewCadence },
                consequences_table: data.accountability
            };
            await ToolDB.saveResponses(userId, 'performance-individual', questionMappings);
            setSubmitStatus('success');
            setSubmitMessage('Individual assessment submitted!');
            setIndividualSubmitted(true);
        };

        // Team submit
        const handleTeamSubmit = async () => {
            const userId = localStorage.getItem('ft_user_id');
            if (!userId) { alert('User not authenticated.'); return; }
            const teamMappings = {
                execution_dashboard: { teamTakeaways: teamData.teamTakeaways, teamStrategies: teamData.teamStrategies, www: teamData.www }
            };
            await ToolDB.saveResponses(userId, 'performance-team', teamMappings);
            setSubmitStatus('success');
            setSubmitMessage('Team meeting submitted successfully!');
        };

        return (
            <div className="tool-frame"><div className="tool-inner">

                {/* COVER */}
                {step === 0 && (
                    <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                        <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url("https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1920&q=80")', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.3 }} />
                        <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                            <h1 className="plaak" style={{ fontSize: 64, marginBottom: 16, textTransform: 'uppercase', lineHeight: 1.1 }}>PERFORMANCE<br/>ANALYSIS</h1>
                            <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48 }}>Measure what matters. Fix what's broken. Own the outcome.</p>
                            <button onClick={() => goToStep(0.5)} style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }} onMouseOver={e => e.target.style.background = '#FFF469'} onMouseOut={e => e.target.style.background = '#fff'}>START</button>
                        </div>
                    </div>
                )}

                {/* INTRO / PATH CHOOSER */}
                {step === 0.5 && (
                    <div style={{ minHeight: '100vh', background: '#000', color: '#fff', padding: '64px 32px' }}>
                        <div style={{ maxWidth: 640, margin: '0 auto' }} className="animate-in">
                            <h1 className="plaak" style={{ fontSize: 48, marginBottom: 16, textTransform: 'uppercase' }}>CHOOSE YOUR PATH</h1>
                            <p style={{ fontSize: 16, color: '#ccc', marginBottom: 48, lineHeight: 1.6 }}>
                                This sprint covers performance monitoring, root cause analysis, the 80/20 principle, Theory of Constraints, and building an accountability system.
                            </p>

                            {/* Individual */}
                            <div style={{ border: '2px solid #fff', padding: 32, marginBottom: 32 }}>
                                <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 600, marginBottom: 12 }}>Individual Assessment</div>
                                <p style={{ fontSize: 15, color: '#ccc', lineHeight: 1.6, marginBottom: 24 }}>
                                    Complete 6 steps: Goal Setting, Task Tracking, 5 Whys, 80/20 Analysis, Theory of Constraints, and Accountability Framework.
                                </p>
                                <button onClick={() => goToStep(1)} style={{ background: '#fff', color: '#000', border: 'none', padding: '14px 36px', fontSize: 15, fontFamily: "'Monument', monospace", letterSpacing: '0.08em', textTransform: 'uppercase', cursor: 'pointer' }} onMouseOver={e => e.target.style.background = '#FFF469'} onMouseOut={e => e.target.style.background = '#fff'}>
                                    {individualSubmitted ? 'REVIEW INDIVIDUAL' : 'START INDIVIDUAL'}
                                </button>
                            </div>

                            {/* Team (locked) */}
                            <div style={{ border: '2px solid ' + (teamToolUnlocked ? '#fff' : '#555'), padding: 32, marginBottom: 32, opacity: teamToolUnlocked ? 1 : 0.7 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                    {!teamToolUnlocked && <LockIcon size={16} />}
                                    <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 600 }}>Team Meeting Tool</div>
                                </div>
                                {teamToolUnlocked ? (
                                    <>
                                        <p style={{ fontSize: 15, color: '#ccc', lineHeight: 1.6, marginBottom: 24 }}>Facilitate the 60-minute team meeting to establish performance and accountability systems.</p>
                                        <button onClick={() => goToStep(8)} style={{ background: '#fff', color: '#000', border: 'none', padding: '14px 36px', fontSize: 15, fontFamily: "'Monument', monospace", letterSpacing: '0.08em', textTransform: 'uppercase', cursor: 'pointer' }} onMouseOver={e => e.target.style.background = '#FFF469'} onMouseOut={e => e.target.style.background = '#fff'}>START TEAM MEETING</button>
                                    </>
                                ) : (
                                    <div onClick={(e) => { if (e.shiftKey) setTeamToolUnlocked(true); }} style={{ background: '#222', padding: '12px 16px', textAlign: 'center', color: '#666', fontFamily: "'Monument', monospace", fontSize: 12, cursor: 'default' }} title="Shift+Click to force unlock (dev only)">
                                        {checkingTeamUnlock ? 'CHECKING...' : 'LOCKED — WAITING FOR ALL TEAM MEMBERS'}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}

                {/* INDIVIDUAL STEPS 1-6 */}
                {[1, 2, 3, 4, 5, 6].includes(step) && (
                    <div className="wizard-layout">
                        <div className="wizard-main">
                            <MobileStepBar step={step} total={6} />
                            <div className="wizard-content">
                                {step === 1 && <Step1 d={data} u={u} />}
                                {step === 2 && <Step2 d={data} u={u} />}
                                {step === 3 && <Step3 d={data} u={u} />}
                                {step === 4 && <Step4 d={data} u={u} />}
                                {step === 5 && <Step5 d={data} u={u} />}
                                {step === 6 && <Step6 d={data} u={u} />}
                            </div>
                            <ButtonFooter onBack={() => step === 1 ? goToStep(0.5) : goToStep(step - 1)} onNext={() => step < 6 ? handleNext(step) : goToStep(step + 1)} nextLabel={step === 6 ? 'Review' : aiReviewing ? 'Reviewing...' : 'Next'} disabled={aiReviewing} />
                        </div>
                        <WizardSidebar step={step} teamUnlocked={teamToolUnlocked} onNavigate={goToStep} />
                    </div>
                )}

                {/* TRANSITION SCREENS */}
                {window.renderTransitionScreen && [1.5, 2.5, 3.5, 4.5].includes(step) && window.renderTransitionScreen(step, CONFIG, totalSteps, setStep)}

                {/* STEP 7: REVIEW & SUBMIT INDIVIDUAL */}
                {step === 7 && (() => {
                    try {
                        const reviewItems = [
                            { title: 'Goals', content: (data.goals || []).filter(g => g && g.goal).length + ' goals defined' },
                            { title: 'Task Tracking', content: (data.tasks || []).filter(t => t && (t.task || '').trim()).length + ' tasks tracked' },
                            { title: '5 Whys', content: (data.fiveWhys || {}).rootCause ? 'Root cause: ' + ((data.fiveWhys || {}).rootCause || '').substring(0, 60) + '...' : 'Not completed' },
                            { title: '80/20', content: (data.eighty20 || {}).objective ? 'Analyzing: ' + ((data.eighty20 || {}).objective || '').substring(0, 60) : 'Not completed' },
                            { title: 'Constraints', content: (data.constraints || {}).constraint ? 'Bottleneck: ' + ((data.constraints || {}).constraint || '').substring(0, 60) : 'Not completed' },
                            { title: 'Accountability', content: (data.accountability || {}).expectations ? 'Framework defined' : 'Not completed' }
                        ];
                        return (
                            <div className="wizard-layout">
                                <div className="wizard-main">
                                    <div className="wizard-content animate-in">
                                        <div className="step-indicator"><span>Review & Submit</span></div>
                                        <h2 className="step-heading">YOUR PERFORMANCE PROTOCOL</h2>
                                        <p className="step-hint">Review your work across all 6 frameworks, then submit for AI coaching.</p>

                                        {reviewItems.map((s, i) => (
                                            <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 0', borderBottom: '1px solid #E5E7EB' }}>
                                                <div style={{ fontWeight: 600 }}>{s.title}</div>
                                                <div style={{ fontSize: 14, color: '#6B7280', maxWidth: 400, textAlign: 'right' }}>{s.content}</div>
                                            </div>
                                        ))}

                                        <CaseStudy
                                            before="A 30-person SaaS company tracked effort instead of outcomes. Quarterly targets were missed 60% of the time."
                                            after="Binary task tracking, weekly dashboards, and 5 Whys for root cause analysis pushed task completion from 55% to 88% in one quarter."
                                            quote="Once we stopped tracking effort and started tracking outcomes, everything changed. — Operations Director"
                                        />

                                        {submitStatus && <div style={{ padding: 16, marginTop: 16, background: submitStatus === 'success' ? '#F0FDF4' : submitStatus === 'error' ? '#FEF2F2' : '#F5F5F5', border: '1px solid ' + (submitStatus === 'success' ? '#BBF7D0' : submitStatus === 'error' ? '#FECACA' : '#E0E0E0'), textAlign: 'center' }}>{submitMessage}</div>}
                                    </div>
                                    <ButtonFooter onBack={() => goToStep(6)} onNext={handleIndividualSubmit} nextLabel={submitStatus === 'saving' ? 'AI Reviewing...' : 'Submit Individual'} disabled={submitStatus === 'saving'} />
                                </div>
                                <WizardSidebar step={step} teamUnlocked={teamToolUnlocked} onNavigate={goToStep} />
                            </div>
                        );
                    } catch(e) {
                        console.error('[Performance] Review render error:', e);
                        return (
                            <div className="wizard-layout">
                                <div className="wizard-main">
                                    <div className="wizard-content animate-in">
                                        <div className="step-indicator"><span>Review & Submit</span></div>
                                        <h2 className="step-heading">YOUR PERFORMANCE PROTOCOL</h2>
                                        <p style={{ color: '#6B7280', marginBottom: 24 }}>Loading your performance summary...</p>
                                        {submitStatus && <div style={{ padding: 16, marginTop: 16, background: submitStatus === 'success' ? '#F0FDF4' : submitStatus === 'error' ? '#FEF2F2' : '#F5F5F5', border: '1px solid ' + (submitStatus === 'success' ? '#BBF7D0' : submitStatus === 'error' ? '#FECACA' : '#E0E0E0'), textAlign: 'center' }}>{submitMessage}</div>}
                                    </div>
                                    <ButtonFooter onBack={() => goToStep(6)} onNext={handleIndividualSubmit} nextLabel={submitStatus === 'saving' ? 'AI Reviewing...' : 'Submit Individual'} disabled={submitStatus === 'saving'} />
                                </div>
                                <WizardSidebar step={step} teamUnlocked={teamToolUnlocked} onNavigate={goToStep} />
                            </div>
                        );
                    }
                })()}

                {/* TEAM STEPS 8-9 */}
                {[8, 9].includes(step) && (
                    <div className="wizard-layout">
                        <div className="wizard-main">
                            <MobileStepBar step={step - 7} total={2} />
                            <div className="wizard-content">
                                {step === 8 && <TeamStepAgenda />}
                                {step === 9 && <TeamStepWWW d={teamData} u={ut} />}
                            </div>
                            <ButtonFooter
                                onBack={() => step === 8 ? goToStep(0.5) : goToStep(8)}
                                onNext={() => step === 8 ? goToStep(9) : handleTeamSubmit()}
                                nextLabel={step === 9 ? (submitStatus === 'saving' ? 'AI Reviewing...' : 'Submit Team') : 'Next'}
                                disabled={step === 9 && submitStatus === 'saving'}
                            />
                        </div>
                        <WizardSidebar step={step} teamUnlocked={teamToolUnlocked} onNavigate={goToStep} />
                    </div>
                )}

            </div></div>
        );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<PerformanceApp />);
</script>
</body>
</html>
