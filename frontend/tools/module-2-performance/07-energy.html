<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creating Energy in Body and Mind - Fast Track</title>
    <link rel="icon" type="image/png" href="favicon/favicon-16x16.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Font preloading to prevent FOUT -->
    <link rel="preload" href="Plaak3Trial-43-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="RiformaLL-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="MonumentGrotesk-Mono.woff2" as="font" type="font/woff2" crossorigin>

    <style>
        /* === FONT FACES === */
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; font-display: swap; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; font-display: swap; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); font-display: swap; }

        /* === BASE RESET === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Riforma', -apple-system, sans-serif;
            font-size: 16px;
            color: #000;
            background: #000;
            -webkit-font-smoothing: antialiased;
        }

        /* === CUSTOM SCROLLBAR === */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        * { scrollbar-width: thin; scrollbar-color: #000 transparent; }

        /* === TYPOGRAPHY HELPERS === */
        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        /* === LAYOUT FRAME === */
        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        /* === WIZARD LAYOUT === */
        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fff;
        }
        .wizard-content {
            max-width: 720px;
            width: 100%;
            margin: 0 auto;
            padding: 48px 32px;
            flex: 1;
        }

        /* === SIDEBAR === */
        .wizard-sidebar {
            width: 280px;
            background: #000;
            border-left: 1px solid #000;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: hidden;
        }
        .wizard-sidebar-inner {
            padding: 32px 24px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .sidebar-step-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }

        /* === Phase header in sidebar === */
        .sidebar-phase-header {
            font-family: 'Monument', monospace;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #FFF469;
            padding: 8px 12px;
            margin-top: 16px;
            margin-bottom: 4px;
        }

        /* === STEP HEADER === */
        .step-indicator {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-time {
            font-family: 'Monument', monospace;
            font-size: 11px;
            color: #6B7280;
        }
        .step-heading {
            font-family: 'Plaak', sans-serif;
            font-weight: bold;
            font-size: 32px;
            text-transform: uppercase;
            letter-spacing: -0.01em;
            line-height: 1.2;
            color: #000;
            margin-bottom: 6px;
        }
        .step-hint {
            font-size: 16px;
            color: #6B7280;
            line-height: 1.5;
            margin: 0 0 32px 0;
        }

        /* === FORM ELEMENTS === */
        .ft-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Monument', monospace;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 8px;
        }
        .ft-required { color: #DC2626; font-weight: 700; }

        .ft-input {
            width: 100%;
            height: 44px;
            padding: 8px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }
        .ft-input.has-error {
            border: 2px solid #DC2626;
            padding-right: 40px;
        }
        .ft-input.has-error:focus {
            border-color: #DC2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }

        .ft-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            resize: vertical;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .ft-textarea:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }
        .ft-textarea.has-error {
            border: 2px solid #DC2626;
        }
        .ft-textarea.has-error:focus {
            border-color: #DC2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }

        .ft-help {
            font-size: 14px;
            color: #6B7280;
            margin-top: 4px;
            line-height: 1.5;
        }
        .ft-error-msg {
            font-size: 14px;
            font-weight: 600;
            color: #DC2626;
            margin-top: 4px;
            line-height: 1.4;
        }
        .ft-field-group {
            margin-bottom: 24px;
        }
        .ft-field-group:last-child { margin-bottom: 0; }
        .ft-section { margin-bottom: 32px; }

        /* === YELLOW INSIGHT BOX === */
        .ft-insight {
            background: #FFF469;
            border: 3px solid #000;
            padding: 16px;
            margin-bottom: 32px;
        }

        /* === EXAMPLE BOX === */
        .ft-example {
            background: #F3F4F6;
            padding: 16px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #1F2937;
        }

        /* === ERROR SUMMARY === */
        .ft-error-summary {
            border: 2px solid #DC2626;
            background: #fff;
            padding: 16px;
            margin-bottom: 24px;
        }
        .ft-error-summary a {
            color: #DC2626;
            text-decoration: underline;
            cursor: pointer;
        }
        .ft-error-summary a:hover { text-decoration: none; }

        /* === BUTTON FOOTER === */
        .btn-footer {
            position: sticky;
            bottom: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-top: 1px solid #E5E7EB;
            background: #fff;
            width: 100%;
        }
        .btn-back {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-back:hover { background: #F3F4F6; }
        .btn-next {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E5E7EB; color: #9CA3AF; border-color: #E5E7EB; cursor: not-allowed; }

        /* === TOOL-SPECIFIC: Buttons === */
        .btn-primary {
            background: #000;
            color: #fff;
            padding: 16px 32px;
            border: 2px solid #000;
            font-family: 'Riforma', sans-serif;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-primary:disabled { background: #E0E0E0; color: #9CA3AF; cursor: not-allowed; opacity: 0.5; }
        .btn-secondary {
            background: #fff;
            color: #000;
            padding: 12px 24px;
            border: 2px solid #000;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-secondary:hover { background: #F8F8F8; }

        /* === CLOSING MESSAGE === */
        .closing-box {
            border-top: 1px solid #E5E7EB;
            padding: 20px 0 0 0;
            margin-top: 8px;
            text-align: center;
        }
        .closing-box p { font-size: 14px; color: #6B7280; }
        .closing-box .closing-title {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 6px;
        }

        /* === MOBILE STEP BAR === */
        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; background: #F3F4F6; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E5E7EB; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }

        /* === CANVAS STYLES === */
        .numbered-section { background: #000; color: #fff; padding: 8px 14px; font-size: 14px; font-weight: bold; letter-spacing: 0.5px; display: inline-block; font-family: 'Monument', monospace; }

        /* === Spinner === */
        .spinner {
            border: 4px solid #E0E0E0;
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* === Badge Styles === */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }
        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-yellow { background: #FFF469; color: #000; }
        .badge-red { background: #FEE2E2; color: #991B1B; }

        /* === ANIMATIONS === */
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }

        /* === PRINT === */
        @media print { .no-print { display: none !important; } }

        /* === RESPONSIVE === */
        @media (min-width: 769px) and (max-width: 1024px) {
            .wizard-sidebar { width: 220px; }
            .wizard-sidebar-inner { padding: 24px 16px; }
        }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .mobile-step-bar { display: block; }
            .wizard-content { padding: 24px 16px; }
            .step-heading { font-size: 24px; }
            .btn-footer { padding: 12px 16px; }
        }
        @media (max-width: 480px) {
            .step-heading { font-size: 20px; }
            .wizard-content { padding: 20px 12px; }
        }

        /* === TOOL-SPECIFIC: Slider/Rating CSS === */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #E5E7EB;
            outline: none;
            border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #000;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #000;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const CONFIG = {
            SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
            TOOL_SLUG: 'energy',
            STORAGE_KEY: 'ft_energy_autosave',
            AUTOSAVE_DELAY: 2000
        };

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        // Make Supabase client globally available for dependency injection
        window.supabaseClient = supabaseClient;

        // Initialize ToolDB and dependency injection
        ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);

        // Initialize cognitive load components
        CognitiveLoad.init('energy', {"insights":["Energy management beats time management. A focused hour beats a distracted day.","CEO energy is contagious. If you are depleted, your organization feels it."],"caseStudy":{"before":"A CEO running a 200-person company was working 70-hour weeks, skipping meals, sleeping 5 hours a night, and hadn't exercised in months. Decision quality was declining, the team sensed constant tension, and two senior leaders had resigned citing burnout culture.","after":"After implementing the Fast Track Energy Protocol \u2014 consistent 7-hour sleep, structured nutrition, daily 30-minute movement, and weekly mental resets \u2014 the CEO cut to 50-hour weeks while doubling strategic output. Team engagement scores rose 34% within one quarter.","quote":"I thought working more hours meant more results. The truth is I was the bottleneck because I was exhausted. Once I fixed my energy, everything in the company started moving faster."}});
        const { FastTrackInsight, ScienceBox, WarningBox, CaseStudy, ScienceBookmarkIcon, ToolGuideDrawer } = CognitiveLoad.components;

        /* ============================================================
           PILLAR CONFIG
           ============================================================ */

        const PILLAR_BY_STEP = { 1: 'sleep', 2: 'nutrition', 3: 'movement' };
        const PILLAR_TITLE = { 1: 'Sleep', 2: 'Nutrition', 3: 'Movement' };

        const PILLAR_PLACEHOLDERS = {
            sleep: {
                doWell: 'e.g., I consistently get 7+ hours of sleep on weekdays',
                notDoWell: 'e.g., I look at my phone right before bed, disrupting sleep quality',
                goals: 'e.g., Stop consuming caffeine after 2 PM and set a phone alarm at 10 PM to begin my wind-down routine',
                keyHabit: 'e.g., Put phone in living room 1 hour before bed',
                trigger: 'e.g., Phone alarm at 10pm',
                routine: 'e.g., 1. Alarm goes off, 2. Put phone on charger in living room, 3. Read book for 15 min',
                reward: 'e.g., Wake up energized and focused',
                accountabilityPartner: 'Who will check in with you? (Name + how often)'
            },
            nutrition: {
                doWell: 'e.g., I eat balanced meals with vegetables at least twice a day',
                notDoWell: 'e.g., I snack on sugary foods when stressed and skip breakfast regularly',
                goals: 'e.g., Plan meals weekly and replace afternoon sugar with protein-rich snacks',
                keyHabit: 'e.g., Prepare a healthy lunch the night before',
                trigger: 'e.g., After dinner dishes are done, prep next-day lunch',
                routine: 'e.g., 1. Check meal plan, 2. Prepare protein + vegetables, 3. Pack in container',
                reward: 'e.g., Feel alert and focused through the afternoon without energy crashes',
                accountabilityPartner: 'Who will check in with you? (Name + how often)'
            },
            movement: {
                doWell: 'e.g., I walk for 20 minutes during lunch breaks three times a week',
                notDoWell: 'e.g., I sit for 8+ hours straight and skip exercise when busy',
                goals: 'e.g., Move for 30 minutes every day before 9 AM, alternating walks and strength',
                keyHabit: 'e.g., 30-minute morning walk before checking email',
                trigger: 'e.g., Running shoes placed next to bed the night before',
                routine: 'e.g., 1. Wake up, 2. Put on shoes, 3. Walk 15 min out + 15 min back',
                reward: 'e.g., Arrive at desk feeling sharp, calm, and energized',
                accountabilityPartner: 'Who will check in with you? (Name + how often)'
            }
        };

        const PILLAR_INSIGHTS = {
            1: "Sleep is the foundation of every other energy pillar. Matthew Walker's research at UC Berkeley proves that sleep deprivation reduces cognitive performance by up to 40%. You can not out-work a sleep deficit.",
            2: "Nutrition directly fuels your brain. Diets high in omega-3 fatty acids improve cognitive efficiency by 20% (Perlmutter, 2015). What you eat determines how you think, decide, and lead.",
            3: "A Stanford study found that walking boosts creative output by 60%. Movement is not a luxury for leaders -- it is a competitive advantage. Lack of physical activity reduces new brain cell generation by 50%."
        };

        /* ============================================================
           TRANSITION CONTENT
           ============================================================ */

        const TRANSITION_CONTENT = {
            1: {
                title: 'SLEEP LOCKED.',
                text: "Your sleep protocol is defined. Now let's fuel the machine with the right nutrition.",
                brutalTruth: "Matthew Walker's research at UC Berkeley proves that sleep deprivation reduces cognitive performance by up to 40%. You can't out-work a sleep deficit -- every hour of lost sleep costs you two hours of productivity the next day.",
                peerProof: "CEOs who implemented a strict 7-hour sleep minimum reported 28% better decision quality within 30 days (Fast Track cohort data, 2024)."
            },
            2: {
                title: 'NUTRITION SET.',
                text: "Your food protocol is in place. Now let's build the movement engine that powers peak performance.",
                brutalTruth: "Diets high in omega-3 fatty acids improve cognitive efficiency by 20% (Perlmutter, 2015). What you eat directly impacts how you think. Skip meals and your brain runs on fumes.",
                peerProof: "Leaders who implemented structured meal timing reported 35% fewer afternoon energy crashes and 22% improvement in sustained focus (Huberman Lab aggregate data)."
            },
            3: {
                title: 'MOVEMENT ACTIVATED.',
                text: "Your body is in motion. Now let's optimize the mental game -- what you control, what you release, and how you respond.",
                brutalTruth: "A Stanford study found that walking boosts creative output by 60%. Exercise isn't a luxury for leaders -- it's a competitive advantage. Lack of physical activity reduces new brain cell generation by 50%.",
                peerProof: "Executives who committed to 30 minutes of daily movement saw a 34% increase in strategic thinking quality within one quarter (Fast Track program data)."
            },
            4: {
                title: 'MENTAL FOCUS MAPPED.',
                text: "Your control analysis and strategic decisions are set. Now master your response patterns with the event-gap analysis.",
                brutalTruth: "Your brain consumes 20% of your body's energy while being only 2% of its mass. Optimizing how you use mental energy isn't optional -- it's the highest-leverage activity for any leader.",
                peerProof: "Research shows that mindfulness and focused breathing reduce stress levels by 30-35% and cut nighttime awakenings by 30% (Huberman Lab). Leaders who master the mental energy pillar report the most dramatic performance improvements."
            },
            5: {
                title: 'PROTOCOL COMPLETE.',
                text: "You've built your complete energy system. Review everything before submitting.",
                brutalTruth: "Written commitments create psychological accountability that increases follow-through by 65%. This protocol isn't a document -- it's a contract with yourself.",
                peerProof: "Fast Track participants who completed all pillars and reviewed their protocol before submitting showed 3x higher habit adoption rates at the 90-day follow-up."
            },
            7: {
                title: 'MEETING COMPLETE.',
                text: "The team energy meeting is done. Now finalize PDPs and company commitments.",
                brutalTruth: "Meetings without documented decisions decay within 48 hours. The PDPs you create now are the difference between a productive session and a forgotten conversation.",
                peerProof: "Teams that documented personal development plans and company commitments immediately after the energy meeting showed 78% higher implementation rates compared to those that postponed (Fast Track 2024 cohort data)."
            }
        };

        /* ============================================================
           MEETING AGENDA
           ============================================================ */

        const MEETING_AGENDA = [
            {
                num: 1,
                title: 'Review of Individual Insights',
                duration: '10 min',
                description: 'Reflect on individual energy habits. What works? What does not? Where did the team collectively fail to optimize energy?',
                keyQuestion: 'What patterns do you see across the team\'s energy challenges?',
                pitfall: 'Surface-level reflections lead to surface-level results.'
            },
            {
                num: 2,
                title: 'Guru Presentation',
                duration: '15 min',
                description: 'Present the key energy-boosting tools for this sprint, focusing on sleep, nutrition, movement, and stress management.',
                keyQuestion: 'Which research-backed strategy will have the biggest impact on our team?',
                pitfall: 'Presenting without connecting to team-specific challenges.'
            },
            {
                num: 3,
                title: 'Group Discussion',
                duration: '30 min',
                description: 'Each team member shares their top insights. Identify common energy challenges and propose collective solutions. How can we create team-wide rituals to maintain high energy (walking meetings, sleep hygiene initiatives)? Which energy-boosting habits will drive the highest productivity?',
                keyQuestion: 'How can we create team-wide rituals to maintain high energy?',
                pitfall: 'Focusing only on individual challenges, neglecting broader team context.'
            },
            {
                num: 4,
                title: 'Decision and Action Points',
                duration: '20 min',
                description: 'Finalize 2-3 specific, actionable team strategies to optimize energy.',
                keyQuestion: 'What specific changes could lead to immediate improvements?',
                pitfall: 'Decisions without clear accountability, leading to inaction.'
            },
            {
                num: 5,
                title: 'Reflection and Accountability',
                duration: '15 min',
                description: 'Align on next steps. Ensure every team member knows what to track and how to report on progress.',
                keyQuestion: 'What is the one takeaway that will have the most significant impact?',
                pitfall: 'Reflection lacking depth, leaving unresolved issues.'
            }
        ];

        /* ============================================================
           SHARED COMPONENTS
           ============================================================ */

        function CheckIcon({ color = "#fff", size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
        }

        function LockIcon({ size = 20, color = "#9CA3AF" }) {
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0110 0v4" />
                </svg>
            );
        }

        function ButtonFooter({ onBack, onNext, nextLabel = 'Next', showBack = true, disabled = false }) {
            return (
                <div className="btn-footer no-print">
                    {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                    <button className="btn-next" disabled={disabled} onClick={onNext}>{nextLabel} &rarr;</button>
                </div>
            );
        }

        function MobileStepBar({ currentStep, totalSteps }) {
            const total = totalSteps || 6;
            const progress = Math.round((Math.min(currentStep, total) / total) * 100);
            return (
                <div className="mobile-step-bar no-print">
                    <div className="bar-text">Step {Math.min(currentStep, total)} of {total}</div>
                    <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${progress}%` }} /></div>
                </div>
            );
        }

        function CoachFeedbackPanel() {
            const [expanded, setExpanded] = useState(false);
            const [feedback, setFeedback] = useState(null);

            useEffect(() => {
                const check = () => {
                    if (window.AIChallenge && window.AIChallenge.getLastFeedback) {
                        setFeedback(window.AIChallenge.getLastFeedback());
                    }
                };
                check();
                const interval = setInterval(check, 2000);
                return () => clearInterval(interval);
            }, []);

            if (!feedback) return null;

            return (
                <div style={{ marginTop: 24, borderTop: '1px solid #333', paddingTop: 16 }}>
                    <button
                        onClick={() => setExpanded(!expanded)}
                        style={{ background: 'none', border: 'none', color: '#FFF469', cursor: 'pointer', fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', display: 'flex', alignItems: 'center', gap: 6, padding: 0, width: '100%' }}
                    >
                        <span style={{ transform: expanded ? 'rotate(90deg)' : 'rotate(0deg)', transition: 'transform 0.2s', display: 'inline-block' }}>&#9654;</span>
                        COACH FEEDBACK
                    </button>
                    {expanded && (
                        <div style={{ marginTop: 10, fontSize: 12, color: '#ccc', lineHeight: 1.5 }}>
                            {feedback.type === 'approved' && <p style={{ color: '#FFF469' }}>{feedback.message}</p>}
                            {feedback.type === 'challenges' && (
                                <>
                                    {feedback.encouragement && <p style={{ color: '#FFF469', marginBottom: 8 }}>{feedback.encouragement}</p>}
                                    {feedback.challenges && feedback.challenges.map((ch, i) => (
                                        <div key={i} style={{ marginBottom: 8, paddingLeft: 8, borderLeft: '2px solid #555' }}>
                                            <div style={{ fontSize: 10, color: '#999', marginBottom: 2 }}>{ch.question_text || ch.question_key}</div>
                                            <div>{ch.feedback}</div>
                                        </div>
                                    ))}
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function DependencyContext({ deps }) {
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '24px' }}>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: '11px', textTransform: 'uppercase', letterSpacing: '0.05em', color: '#666', marginBottom: '8px' }}>
                        CONTEXT FROM PREVIOUS TOOLS
                    </div>
                    {deps.map((dep, i) => (
                        <div key={i} style={{ background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '12px 16px', marginBottom: '8px', fontSize: '14px' }}>
                            <div style={{ fontWeight: 600, marginBottom: '4px', color: '#333' }}>{dep.label}</div>
                            <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                        </div>
                    ))}
                </div>
            );
        }

        /* ============================================================
           SIDEBAR
           ============================================================ */

        function WizardSidebar({ currentStep, mode, formData, teamData, onNavigate }) {
            const individualSteps = [
                { num: 1, label: 'Sleep Protocol' },
                { num: 2, label: 'Nutrition Protocol' },
                { num: 3, label: 'Movement Protocol' },
                { num: 4, label: 'Mental Focus' },
                { num: 5, label: 'Event-Gap Analysis' },
                { num: 6, label: 'Review & Submit' }
            ];
            const teamSteps = [
                { num: 7, label: 'Meeting Agenda' },
                { num: 8, label: 'PDPs & Commitments' }
            ];

            const effectiveStep = Math.ceil(currentStep);

            const getSnippet = (n) => {
                if (mode === 'individual') {
                    const pillar = PILLAR_BY_STEP[n];
                    if (pillar && formData[pillar + 'KeyHabit']) {
                        const habit = formData[pillar + 'KeyHabit'];
                        return 'Habit: ' + habit.substring(0, 40) + (habit.length > 40 ? '...' : '');
                    }
                    if (n === 4 && formData.mentalCanControl) return 'Control analysis complete';
                    if (n === 5 && formData.eventDescription) return 'Event analysis complete';
                    if (n === 6) return 'Ready to submit';
                } else if (mode === 'team') {
                    if (n === 7 && teamData.meetingNotes) return 'Notes captured';
                    if (n === 8 && teamData.pdpMembers && teamData.pdpMembers.length > 0) {
                        return teamData.pdpMembers.length + ' PDP' + (teamData.pdpMembers.length !== 1 ? 's' : '');
                    }
                }
                return null;
            };

            const renderStepItem = (s) => {
                const isCompleted = effectiveStep > s.num;
                const isActive = effectiveStep === s.num;
                const isLocked = effectiveStep < s.num;
                const snippet = isCompleted ? getSnippet(s.num) : null;

                return (
                    <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                        onClick={() => isCompleted && onNavigate && onNavigate(s.num)}
                        title={isCompleted ? 'Click to review this step' : ''}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                            {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                            <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                        </div>
                        {snippet && <div className="sidebar-snippet">{snippet}</div>}
                    </div>
                );
            };

            const timeLabel = mode === 'individual' ? '~40 min' : '~60 min';

            return (
                <div className="wizard-sidebar no-print">
                    <div className="wizard-sidebar-inner">
                        <div style={{ marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>ENERGY PROTOCOL</div>
                            <div style={{ fontSize: 13, color: '#999' }}>{timeLabel}</div>
                        </div>

                        {mode === 'individual' && (
                            <>
                                <div className="sidebar-phase-header">Individual Phase</div>
                                {individualSteps.map(renderStepItem)}
                            </>
                        )}

                        {mode === 'team' && (
                            <>
                                <div className="sidebar-phase-header">Team Meeting</div>
                                {teamSteps.map(renderStepItem)}
                            </>
                        )}

                        <CoachFeedbackPanel />
                    </div>
                </div>
            );
        }

        /* ============================================================
           PILLAR SECTION COMPONENT (steps 1-3)
           ============================================================ */

        const PillarSection = ({ pillar, title, stepNum, formData, updateField }) => {
            const [openSection, setOpenSection] = useState('assessment');
            const ph = PILLAR_PLACEHOLDERS[pillar];

            const AccordionButton = ({ sectionId, label }) => (
                <button
                    onClick={() => setOpenSection(openSection === sectionId ? null : sectionId)}
                    style={{
                        width: '100%', display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        background: openSection === sectionId ? '#000' : '#f5f5f5',
                        color: openSection === sectionId ? '#fff' : '#000',
                        border: '2px solid #000', padding: '12px 16px', cursor: 'pointer', marginBottom: 16,
                        fontFamily: "'Monument', monospace", fontSize: 11,
                        textTransform: 'uppercase', letterSpacing: '0.06em'
                    }}
                >
                    <span>{label}</span>
                    <span style={{ fontSize: 18 }}>{openSection === sectionId ? '−' : '+'}</span>
                </button>
            );

            return (
                <div>
                    <div className="step-indicator">
                        <span>Section A: Physical Energy -- Step {stepNum} of 3</span>
                        <span className="step-time">~10 min</span>
                    </div>
                    <h2 className="step-heading">{title} Protocol</h2>
                    <p className="step-hint">Assess your current state, set goals, and define one key habit using the Trigger-Routine-Reward framework.</p>

                    <FastTrackInsight>
                        {PILLAR_INSIGHTS[stepNum]}
                    </FastTrackInsight>

                    <WarningBox>
                        Don't confuse busyness with productivity. <strong>Bad:</strong> "I want to {title.toLowerCase()} better." <strong>Good:</strong> Be specific about what, when, and how.
                    </WarningBox>

                    {/* Current State Assessment */}
                    <AccordionButton sectionId="assessment" label="Current State Assessment" />
                    {openSection === 'assessment' && (
                        <div className="ft-section" style={{ border: '2px solid #000', borderTop: 'none', padding: 24, marginBottom: 16 }}>
                            <div className="ft-field-group">
                                <label className="ft-label">Rate your current {title} (1-10):</label>
                                <ScienceBookmarkIcon>
                                    Self-assessment accuracy improves by 27% when you rate specific habits rather than general feelings.
                                </ScienceBookmarkIcon>
                                <div className="flex items-center gap-4">
                                    <input
                                        type="range"
                                        min="1"
                                        max="10"
                                        className="flex-1"
                                        value={formData[pillar + 'Rating']}
                                        onChange={(e) => updateField(pillar + 'Rating', e.target.value)}
                                    />
                                    <span className="plaak text-4xl w-12">{formData[pillar + 'Rating']}</span>
                                </div>
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">What I do WELL:</label>
                                <textarea
                                    className="ft-textarea"
                                    value={formData[pillar + 'DoWell']}
                                    onChange={(e) => updateField(pillar + 'DoWell', e.target.value)}
                                    placeholder={ph.doWell}
                                />
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">What I do NOT do well:</label>
                                <textarea
                                    className="ft-textarea"
                                    value={formData[pillar + 'NotDoWell']}
                                    onChange={(e) => updateField(pillar + 'NotDoWell', e.target.value)}
                                    placeholder={ph.notDoWell}
                                />
                                <p className="ft-help">Identify triggers that lead to negative behaviors.</p>
                            </div>
                        </div>
                    )}

                    {/* Goals */}
                    <AccordionButton sectionId="goals" label="My Goals" />
                    {openSection === 'goals' && (
                        <div className="ft-section" style={{ border: '2px solid #000', borderTop: 'none', padding: 24, marginBottom: 16 }}>
                            <textarea
                                className="ft-textarea"
                                value={formData[pillar + 'Goals']}
                                onChange={(e) => updateField(pillar + 'Goals', e.target.value)}
                                placeholder={ph.goals}
                            />
                            <p className="ft-help">Be specific, not vague. Avoid "I want to be healthier" -- say exactly what you will do.</p>
                        </div>
                    )}

                    {/* ONE KEY HABIT */}
                    <AccordionButton sectionId="habit" label="One Key Habit To Develop" />
                    {openSection === 'habit' && (
                        <div style={{ border: '2px solid #000', borderTop: 'none', padding: 24, background: '#FFFBEB', marginBottom: 16 }}>
                            <p style={{ color: '#6B7280', marginBottom: 16 }}>Using the Atomic Habits framework</p>

                            <div className="ft-field-group">
                                <label className="ft-label">My Key Habit: <span className="ft-required">*</span></label>
                                <input
                                    className="ft-input"
                                    value={formData[pillar + 'KeyHabit']}
                                    onChange={(e) => updateField(pillar + 'KeyHabit', e.target.value)}
                                    placeholder={ph.keyHabit}
                                />
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">Trigger/Reminder: <span className="ft-required">*</span></label>
                                <input
                                    className="ft-input"
                                    value={formData[pillar + 'Trigger']}
                                    onChange={(e) => updateField(pillar + 'Trigger', e.target.value)}
                                    placeholder={ph.trigger}
                                />
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">Routine (Specific actions):</label>
                                <textarea
                                    className="ft-textarea"
                                    value={formData[pillar + 'Routine']}
                                    onChange={(e) => updateField(pillar + 'Routine', e.target.value)}
                                    placeholder={ph.routine}
                                />
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">Reward (What you get):</label>
                                <input
                                    className="ft-input"
                                    value={formData[pillar + 'Reward']}
                                    onChange={(e) => updateField(pillar + 'Reward', e.target.value)}
                                    placeholder={ph.reward}
                                />
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">Accountability Partner:</label>
                                <input
                                    className="ft-input"
                                    value={formData[pillar + 'AccountabilityPartner']}
                                    onChange={(e) => updateField(pillar + 'AccountabilityPartner', e.target.value)}
                                    placeholder={ph.accountabilityPartner}
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        /* ============================================================
           MENTAL FOCUS STEP (step 4)
           ============================================================ */

        function MentalFocusStep({ formData, updateField }) {
            const [openPart, setOpenPart] = useState('define');

            const AccordionButton = ({ partId, label }) => (
                <button
                    onClick={() => setOpenPart(openPart === partId ? null : partId)}
                    style={{
                        width: '100%', display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                        background: openPart === partId ? '#000' : '#f5f5f5',
                        color: openPart === partId ? '#fff' : '#000',
                        border: '2px solid #000', padding: '12px 16px', cursor: 'pointer', marginBottom: 16,
                        fontFamily: "'Monument', monospace", fontSize: 11,
                        textTransform: 'uppercase', letterSpacing: '0.06em'
                    }}
                >
                    <span>{label}</span>
                    <span style={{ fontSize: 18 }}>{openPart === partId ? '−' : '+'}</span>
                </button>
            );

            return (
                <div>
                    <div className="step-indicator">
                        <span>Section B: Mental Energy -- Part 1 of 2</span>
                        <span className="step-time">~10 min</span>
                    </div>
                    <h2 className="step-heading">Mental Focus & Control</h2>
                    <p className="step-hint">Control what you can, release what you cannot, and make strategic decisions about your energy allocation.</p>

                    <FastTrackInsight>
                        Mastering mental energy is about controlling what you can and releasing what you cannot. Focus your energy on what moves the needle. Your brain consumes 20% of your body's energy -- deploy it wisely.
                    </FastTrackInsight>

                    <ScienceBox collapsible={true}>
                        Research shows that mindfulness and focused breathing reduce stress levels by 30-35% and cut nighttime awakenings by 30% (Huberman Lab). Strategic energy allocation improves decision quality by 25% over 8 weeks.
                    </ScienceBox>

                    {/* Part 1: Control */}
                    <AccordionButton partId="define" label="Part 1: Define What Matters" />
                    {openPart === 'define' && (
                        <div className="ft-section" style={{ border: '2px solid #000', borderTop: 'none', padding: 24, marginBottom: 16 }}>
                            <div className="ft-field-group">
                                <label className="ft-label">Things that matter to me that I CAN control: <span className="ft-required">*</span></label>
                                <textarea
                                    className="ft-textarea"
                                    value={formData.mentalCanControl}
                                    onChange={(e) => updateField('mentalCanControl', e.target.value)}
                                    placeholder="List things within your control (e.g., my daily routine, my reactions, my habits, how I prepare for meetings)"
                                />
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">Things that matter to me that I CANNOT control:</label>
                                <textarea
                                    className="ft-textarea"
                                    value={formData.mentalCannotControl}
                                    onChange={(e) => updateField('mentalCannotControl', e.target.value)}
                                    placeholder="List things outside your control (e.g., other people's opinions, market conditions, competitor actions)"
                                />
                            </div>
                        </div>
                    )}

                    {/* Part 2: Stop/Do Less/Do More */}
                    <AccordionButton partId="decisions" label="Part 2: Strategic Decisions" />
                    {openPart === 'decisions' && (
                        <div className="ft-section" style={{ border: '2px solid #000', borderTop: 'none', padding: 24, marginBottom: 16 }}>
                            <div className="ft-field-group">
                                <label className="ft-label">STOP doing completely (3 things):</label>
                                {[1,2,3].map(i => (
                                    <input
                                        key={i}
                                        className="ft-input"
                                        style={{ marginBottom: 8 }}
                                        value={formData['stopDoing' + i]}
                                        onChange={(e) => updateField('stopDoing' + i, e.target.value)}
                                        placeholder={i + '. e.g., Checking email before 9am'}
                                    />
                                ))}
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">DO LESS of starting today (3 things):</label>
                                {[1,2,3].map(i => (
                                    <input
                                        key={i}
                                        className="ft-input"
                                        style={{ marginBottom: 8 }}
                                        value={formData['doLess' + i]}
                                        onChange={(e) => updateField('doLess' + i, e.target.value)}
                                        placeholder={i + '. e.g., Attending non-essential meetings'}
                                    />
                                ))}
                            </div>
                            <div className="ft-field-group">
                                <label className="ft-label">DO MORE of starting today (3 things):</label>
                                {[1,2,3].map(i => (
                                    <input
                                        key={i}
                                        className="ft-input"
                                        style={{ marginBottom: 8 }}
                                        value={formData['doMore' + i]}
                                        onChange={(e) => updateField('doMore' + i, e.target.value)}
                                        placeholder={i + '. e.g., Deep work sessions, walking meetings'}
                                    />
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        /* ============================================================
           EVENT-GAP STEP (step 5)
           ============================================================ */

        function EventGapStep({ formData, updateField }) {
            return (
                <div>
                    <div className="step-indicator">
                        <span>Section B: Mental Energy -- Part 2 of 2</span>
                        <span className="step-time">~10 min</span>
                    </div>
                    <h2 className="step-heading">Event-Gap-Response Analysis</h2>
                    <p className="step-hint">Reflect on a recent event where your reaction was not ideal, and design a better response pattern.</p>

                    <FastTrackInsight>
                        The gap between an event and your response is where leadership lives. The event-gap-response framework improves emotional intelligence by 25% over 8 weeks. Master this gap, and you master yourself.
                    </FastTrackInsight>

                    <div style={{ border: '2px solid #000', padding: 24, background: '#FFFBEB' }}>
                        <div className="ft-field-group">
                            <label className="ft-label">Describe a recent event where your reaction was not ideal: <span className="ft-required">*</span></label>
                            <textarea
                                className="ft-textarea"
                                value={formData.eventDescription}
                                onChange={(e) => updateField('eventDescription', e.target.value)}
                                placeholder="e.g., I reacted angrily to feedback during a meeting."
                            />
                        </div>
                        <div className="ft-field-group">
                            <label className="ft-label">The GAP -- Difference between reaction and ideal response:</label>
                            <textarea
                                className="ft-textarea"
                                value={formData.gapAnalysis}
                                onChange={(e) => updateField('gapAnalysis', e.target.value)}
                                placeholder="e.g., I wish I had stayed calm and asked for clarification instead."
                            />
                        </div>
                        <div className="ft-field-group">
                            <label className="ft-label">Your ideal response:</label>
                            <textarea
                                className="ft-textarea"
                                value={formData.idealResponse}
                                onChange={(e) => updateField('idealResponse', e.target.value)}
                                placeholder="e.g., Take a breath, acknowledge the feedback, ask a clarifying question."
                            />
                        </div>
                        <div className="ft-field-group">
                            <label className="ft-label">Plan for future similar situations:</label>
                            <textarea
                                className="ft-textarea"
                                value={formData.futurePlan}
                                onChange={(e) => updateField('futurePlan', e.target.value)}
                                placeholder="e.g., Next time, I'll pause before responding and ask more questions."
                            />
                        </div>
                    </div>
                </div>
            );
        }

        /* ============================================================
           REVIEW STEP (step 6)
           ============================================================ */

        function ReviewStep({ formData, onSubmit, submitStatus, submitMessage }) {
            return (
                <div id="canvas-content">
                    <div className="step-indicator">
                        <span>Step 6 of 6</span>
                        <span className="step-time">~5 min</span>
                    </div>
                    <h2 className="step-heading">Your Complete Energy Protocol</h2>
                    <p className="step-hint">Review everything before submitting.</p>

                    <FastTrackInsight>
                        Leadership starts with energy. Review your protocol across all pillars and look for patterns. Where are you strongest? Where is the biggest gap?
                    </FastTrackInsight>

                    {/* 3 Pillars Summary */}
                    {['sleep', 'nutrition', 'movement'].map((pillar) => (
                        <div key={pillar} className="ft-section" style={{ border: '2px solid #000', padding: 24 }}>
                            <h3 className="plaak" style={{ fontSize: 24, marginBottom: 16 }}>{pillar.charAt(0).toUpperCase() + pillar.slice(1)}</h3>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <span className="monument" style={{ fontSize: 10 }}>RATING:</span>
                                    <p className="plaak" style={{ fontSize: 24 }}>{formData[pillar + 'Rating']}/10</p>
                                </div>
                                <div>
                                    <span className="monument" style={{ fontSize: 10 }}>KEY HABIT:</span>
                                    <p style={{ fontSize: 14 }}>{formData[pillar + 'KeyHabit'] || '--'}</p>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span className="monument" style={{ fontSize: 10 }}>TRIGGER:</span>
                                    <p>{formData[pillar + 'Trigger'] || '--'}</p>
                                </div>
                                <div>
                                    <span className="monument" style={{ fontSize: 10 }}>REWARD:</span>
                                    <p>{formData[pillar + 'Reward'] || '--'}</p>
                                </div>
                            </div>
                        </div>
                    ))}

                    {/* Mental Energy Summary */}
                    <div className="ft-section" style={{ border: '2px solid #000', padding: 24, background: '#F9FAFB' }}>
                        <h3 className="plaak" style={{ fontSize: 24, marginBottom: 16 }}>Mental Energy</h3>
                        <div className="space-y-3 text-sm">
                            <div style={{ marginBottom: 12 }}>
                                <span className="monument" style={{ fontSize: 10 }}>STOP DOING:</span>
                                <p>{[formData.stopDoing1, formData.stopDoing2, formData.stopDoing3].filter(Boolean).join(', ') || '--'}</p>
                            </div>
                            <div style={{ marginBottom: 12 }}>
                                <span className="monument" style={{ fontSize: 10 }}>DO LESS:</span>
                                <p>{[formData.doLess1, formData.doLess2, formData.doLess3].filter(Boolean).join(', ') || '--'}</p>
                            </div>
                            <div style={{ marginBottom: 12 }}>
                                <span className="monument" style={{ fontSize: 10 }}>DO MORE:</span>
                                <p>{[formData.doMore1, formData.doMore2, formData.doMore3].filter(Boolean).join(', ') || '--'}</p>
                            </div>
                            <div>
                                <span className="monument" style={{ fontSize: 10 }}>EVENT-GAP ANALYSIS:</span>
                                <p>{formData.eventDescription || '--'}</p>
                            </div>
                        </div>
                    </div>

                    {/* Submit */}
                    <div style={{ textAlign: 'center', marginTop: 32 }}>
                        <button onClick={onSubmit} className="btn-next" style={{ padding: '16px 48px', fontSize: 18 }} disabled={submitStatus === 'saving'}>
                            {submitStatus === 'saving' ? 'AI Coach Reviewing...' : 'Submit My Energy Protocol'}
                        </button>
                        {submitStatus && submitMessage && (
                            <div style={{ marginTop: 16, padding: '12px 16px', textAlign: 'center', background: submitStatus === 'success' ? '#f0fdf4' : submitStatus === 'error' ? '#fef2f2' : '#f5f5f5', border: '1px solid ' + (submitStatus === 'success' ? '#bbf7d0' : submitStatus === 'error' ? '#fecaca' : '#e0e0e0'), fontSize: 14 }}>
                                <span style={{ color: submitStatus === 'success' ? '#166534' : submitStatus === 'error' ? '#991b1b' : '#333' }}>{submitMessage}</span>
                            </div>
                        )}
                    </div>

                    <CaseStudy
                        title="From Burnout to Breakthrough"
                        before="A CEO running a 200-person company was working 70-hour weeks, skipping meals, sleeping 5 hours a night, and hadn't exercised in months. Decision quality was declining, the team sensed constant tension, and two senior leaders had resigned citing 'burnout culture.' Obesity had reduced his cognitive sharpness — brain tissue loss of up to 8% was accelerating decline."
                        after="After implementing the Fast Track Energy Protocol — consistent 7-hour sleep, structured nutrition with omega-3-rich meals, daily 30-minute movement, and weekly mental resets — he cut to 50-hour weeks while doubling strategic output. Team engagement scores rose 34% within one quarter. Two new senior hires cited the company's 'energy-first culture' as the reason they joined."
                        quote="I thought working more hours meant more results. The truth is I was the bottleneck because I was exhausted. Once I fixed my energy, everything in the company started moving faster."
                        attribution="— CEO, 200-person services company, Fast Track cohort 2024"
                    />
                </div>
            );
        }

        /* ============================================================
           TEAM STEP 7: Meeting Agenda
           ============================================================ */

        function TeamMeetingStep({ teamData, setTeamData }) {
            return (
                <div className="animate-in">
                    <div className="step-indicator">
                        <span>Team Meeting -- Step 1 of 2</span>
                        <span className="step-time">~45 min</span>
                    </div>
                    <h2 className="step-heading">Team Energy Meeting</h2>
                    <p className="step-hint">Follow the structured agenda below. Capture key notes and decisions as you go.</p>

                    <FastTrackInsight>
                        The team meeting is where individual insights become collective strategy. A structured 60-minute conversation about energy produces more lasting change than months of individual effort. Energy is contagious -- both good and bad.
                    </FastTrackInsight>

                    {/* Meeting Agenda */}
                    <div className="ft-section">
                        <div className="ft-label" style={{ marginBottom: 16 }}>Meeting Agenda -- 90 Minutes</div>
                        {MEETING_AGENDA.map(segment => (
                            <div key={segment.num} style={{ border: '1px solid #E5E7EB', padding: 20, marginBottom: 12 }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                        <span style={{ background: '#000', color: '#fff', width: 28, height: 28, borderRadius: '50%', display: 'inline-flex', alignItems: 'center', justifyContent: 'center', fontSize: 13, fontWeight: 600 }}>
                                            {segment.num}
                                        </span>
                                        <span style={{ fontWeight: 600, fontSize: 15 }}>{segment.title}</span>
                                    </div>
                                    <span className="badge badge-yellow" style={{ fontFamily: "'Monument', monospace", fontSize: 11 }}>{segment.duration}</span>
                                </div>
                                <p style={{ fontSize: 14, color: '#374151', lineHeight: 1.6, marginBottom: 8 }}>{segment.description}</p>
                                {segment.keyQuestion && (
                                    <div style={{ background: '#FFFBEB', border: '1px solid #FDE68A', padding: '8px 12px', marginBottom: 8, fontSize: 13 }}>
                                        <strong style={{ color: '#92400E' }}>Key Q:</strong> <span style={{ color: '#374151' }}>{segment.keyQuestion}</span>
                                    </div>
                                )}
                                <div style={{ background: '#F3F4F6', border: '1px solid #E5E7EB', padding: '8px 12px', fontSize: 13 }}>
                                    <strong style={{ color: '#6B7280' }}>Pitfall to avoid:</strong> <span style={{ color: '#6B7280' }}>{segment.pitfall}</span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Meeting Notes */}
                    <div className="ft-section">
                        <div className="ft-field-group">
                            <label className="ft-label">Meeting Notes & Key Decisions</label>
                            <p className="ft-help" style={{ marginBottom: 8, marginTop: 0 }}>Capture key decisions, insights, and action items from the meeting.</p>
                            <textarea
                                className="ft-textarea"
                                value={teamData.meetingNotes}
                                onChange={(e) => setTeamData(prev => ({ ...prev, meetingNotes: e.target.value }))}
                                placeholder="Write your meeting notes, key decisions, and insights here..."
                                style={{ minHeight: 180 }}
                            />
                        </div>
                    </div>
                </div>
            );
        }

        /* ============================================================
           TEAM STEP 8: PDPs & Company Commitments
           ============================================================ */

        function PDPStep({ teamData, setTeamData, onSubmit, submitStatus, submitMessage }) {
            const [newMemberName, setNewMemberName] = useState('');

            const addPDPMember = () => {
                const name = newMemberName.trim();
                if (!name) return;
                const newMember = {
                    id: Date.now().toString(),
                    name: name,
                    commitment: '',
                    measurable: '',
                    timeline: ''
                };
                setTeamData(prev => ({
                    ...prev,
                    pdpMembers: [...(prev.pdpMembers || []), newMember]
                }));
                setNewMemberName('');
            };

            const removePDPMember = (id) => {
                setTeamData(prev => ({
                    ...prev,
                    pdpMembers: (prev.pdpMembers || []).filter(m => m.id !== id)
                }));
            };

            const updatePDPMember = (id, field, value) => {
                setTeamData(prev => ({
                    ...prev,
                    pdpMembers: (prev.pdpMembers || []).map(m =>
                        m.id === id ? { ...m, [field]: value } : m
                    )
                }));
            };

            const updateStrategy = (index, field, value) => {
                setTeamData(prev => {
                    const strategies = [...prev.teamStrategies];
                    strategies[index] = { ...strategies[index], [field]: value };
                    return { ...prev, teamStrategies: strategies };
                });
            };

            const members = teamData.pdpMembers || [];

            return (
                <div className="animate-in" id="canvas-content">
                    <div className="step-indicator">
                        <span>Team Meeting -- Step 2 of 2</span>
                        <span className="step-time">~15 min</span>
                    </div>
                    <h2 className="step-heading">PDPs & Company Commitments</h2>
                    <p className="step-hint">Finalize personal development plans, company-level commitments, and team energy strategies.</p>

                    <FastTrackInsight>
                        Personal Development Plans turn meeting conversations into trackable commitments. Every team member leaves with a specific, measurable energy goal. Company commitments create the environment where individual change becomes sustainable.
                    </FastTrackInsight>

                    {/* Section 1: Personal Development Plans */}
                    <div className="ft-section" style={{ border: '2px solid #000', padding: 24 }}>
                        <h3 className="plaak" style={{ fontSize: 24, marginBottom: 16 }}>Personal Development Plans (PDPs)</h3>

                        <div className="ft-field-group">
                            <label className="ft-label">Add Team Member</label>
                            <div style={{ display: 'flex', gap: 8 }}>
                                <input
                                    type="text"
                                    value={newMemberName}
                                    onChange={(e) => setNewMemberName(e.target.value)}
                                    onKeyDown={(e) => e.key === 'Enter' && addPDPMember()}
                                    placeholder="Member name"
                                    className="ft-input"
                                />
                                <button onClick={addPDPMember} className="btn-next" style={{ whiteSpace: 'nowrap', minWidth: 100 }}>
                                    Add
                                </button>
                            </div>
                        </div>

                        {members.length > 0 && members.map(member => (
                            <div key={member.id} style={{ border: '1px solid #E5E7EB', padding: 16, marginBottom: 12 }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                                    <span style={{ fontWeight: 600, fontSize: 15 }}>{member.name}</span>
                                    <button onClick={() => removePDPMember(member.id)} style={{ background: 'none', border: 'none', color: '#DC2626', cursor: 'pointer', fontSize: 13 }}>Remove</button>
                                </div>
                                <div className="ft-field-group">
                                    <label className="ft-label" style={{ fontSize: 12 }}>Personal energy commitment</label>
                                    <textarea
                                        className="ft-textarea"
                                        style={{ minHeight: 80 }}
                                        value={member.commitment}
                                        onChange={(e) => updatePDPMember(member.id, 'commitment', e.target.value)}
                                        placeholder="What they'll do individually to improve energy"
                                    />
                                </div>
                                <div className="ft-field-group">
                                    <label className="ft-label" style={{ fontSize: 12 }}>Measurable outcome</label>
                                    <input
                                        className="ft-input"
                                        value={member.measurable}
                                        onChange={(e) => updatePDPMember(member.id, 'measurable', e.target.value)}
                                        placeholder="How they'll track it -- must be specific, not vague"
                                    />
                                </div>
                                <div className="ft-field-group">
                                    <label className="ft-label" style={{ fontSize: 12 }}>Timeline</label>
                                    <input
                                        className="ft-input"
                                        value={member.timeline}
                                        onChange={(e) => updatePDPMember(member.id, 'timeline', e.target.value)}
                                        placeholder="By when? (e.g., End of Q2, 30 days from now)"
                                    />
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Section 2: Company Commitments */}
                    <div className="ft-section" style={{ border: '2px solid #000', padding: 24 }}>
                        <h3 className="plaak" style={{ fontSize: 24, marginBottom: 16 }}>Company Commitments That Support Physical Energy</h3>

                        <div className="ft-field-group">
                            <label className="ft-label">What company-level changes will support team energy?</label>
                            <textarea
                                className="ft-textarea"
                                value={teamData.companyCommitments}
                                onChange={(e) => setTeamData(prev => ({ ...prev, companyCommitments: e.target.value }))}
                                placeholder="e.g., Walking meetings policy, healthy snack budget, flexible morning schedules"
                            />
                        </div>
                        <div className="ft-field-group">
                            <label className="ft-label">How does physical energy affect day-to-day business operations?</label>
                            <textarea
                                className="ft-textarea"
                                value={teamData.energyBusinessImpact}
                                onChange={(e) => setTeamData(prev => ({ ...prev, energyBusinessImpact: e.target.value }))}
                                placeholder="Be specific with real measurement outcomes. e.g., 'Better sleep leads to 20% fewer errors in Q3 reporting'"
                            />
                        </div>
                        <div className="ft-field-group">
                            <label className="ft-label">How will we move from business-level to personal-level trust?</label>
                            <textarea
                                className="ft-textarea"
                                value={teamData.trustStrategy}
                                onChange={(e) => setTeamData(prev => ({ ...prev, trustStrategy: e.target.value }))}
                                placeholder="e.g., Monthly check-ins on energy habits, vulnerability-based trust exercises"
                            />
                        </div>
                    </div>

                    {/* Section 3: Team Energy Strategies */}
                    <div className="ft-section" style={{ border: '2px solid #000', padding: 24 }}>
                        <h3 className="plaak" style={{ fontSize: 24, marginBottom: 16 }}>Team Energy Strategies (2-3 Actionable)</h3>

                        {teamData.teamStrategies.map((strategy, index) => (
                            <div key={index} style={{ border: '1px solid #E5E7EB', padding: 16, marginBottom: 12 }}>
                                <div className="ft-label" style={{ fontSize: 12, marginBottom: 8 }}>Strategy {index + 1}</div>
                                <div className="ft-field-group">
                                    <input
                                        className="ft-input"
                                        value={strategy.title}
                                        onChange={(e) => updateStrategy(index, 'title', e.target.value)}
                                        placeholder={'Strategy ' + (index + 1) + ' title (What?)'}
                                    />
                                </div>
                                <div className="ft-field-group">
                                    <textarea
                                        className="ft-textarea"
                                        style={{ minHeight: 80 }}
                                        value={strategy.description}
                                        onChange={(e) => updateStrategy(index, 'description', e.target.value)}
                                        placeholder="How will this strategy be implemented? Who is responsible?"
                                    />
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Submit */}
                    <div style={{ textAlign: 'center', marginTop: 32 }}>
                        <button onClick={onSubmit} className="btn-primary" disabled={submitStatus === 'saving' || submitStatus === 'success'}>
                            {submitStatus === 'saving' ? 'AI Coach Reviewing...' : submitStatus === 'success' ? 'Submitted' : 'Submit Team Energy Plan'}
                        </button>
                        {submitStatus && submitMessage && (
                            <div style={{ marginTop: 16, padding: '12px 16px', textAlign: 'center', background: submitStatus === 'success' ? '#f0fdf4' : submitStatus === 'error' ? '#fef2f2' : '#f5f5f5', border: '1px solid ' + (submitStatus === 'success' ? '#bbf7d0' : submitStatus === 'error' ? '#fecaca' : '#e0e0e0'), fontSize: 14 }}>
                                <span style={{ color: submitStatus === 'success' ? '#166534' : submitStatus === 'error' ? '#991b1b' : '#333' }}>{submitMessage}</span>
                            </div>
                        )}
                    </div>

                    <CaseStudy
                        title="Team Energy Transformation"
                        before="A 15-person leadership team was running on fumes. Average sleep was under 6 hours, lunch was skipped or eaten at desks, and 'busy' was worn as a badge of honor. Three team members were on stress leave in 12 months. Meeting quality was poor — people were physically present but mentally checked out. The CEO admitted: 'We talk about high performance but we're barely surviving.'"
                        after="After the Energy Sprint, the team implemented three company-wide commitments: no meetings before 9am (protecting sleep), walking meetings twice per week, and a shared meal prep challenge. Within 90 days, sick days dropped 40%, meeting effectiveness scores doubled, and the team reported feeling 'genuinely connected for the first time.' Two team members who had been considering leaving chose to stay."
                        quote="We went from talking about business metrics to actually caring about each other as people. The energy work broke down walls that years of team-building events never touched. When you share something personal like your sleep struggles, trust follows naturally."
                        attribution="— Guru, 15-person leadership team, Fast Track cohort 2024"
                    />
                </div>
            );
        }

        /* ============================================================
           MAIN APP
           ============================================================ */

        function App() {
            const [step, setStep] = useState(0);
            const [mode, setMode] = useState(null); // 'individual' | 'team'
            const [deps, setDeps] = useState([]);
            const [aiReviewing, setAiReviewing] = useState(false);
            const [submitStatus, setSubmitStatus] = useState(null);
            const [submitMessage, setSubmitMessage] = useState('');
            const [individualSubmitted, setIndividualSubmitted] = useState(false);
            const [teamToolUnlocked, setTeamToolUnlocked] = useState(false);
            const [checkingTeamUnlock, setCheckingTeamUnlock] = useState(false);

            // Individual data
            const [formData, setFormData] = useState({
                sleepRating: 5, sleepDoWell: '', sleepNotDoWell: '', sleepGoals: '', sleepKeyHabit: '', sleepTrigger: '', sleepRoutine: '', sleepReward: '', sleepAccountabilityPartner: '',
                nutritionRating: 5, nutritionDoWell: '', nutritionNotDoWell: '', nutritionGoals: '', nutritionKeyHabit: '', nutritionTrigger: '', nutritionRoutine: '', nutritionReward: '', nutritionAccountabilityPartner: '',
                movementRating: 5, movementDoWell: '', movementNotDoWell: '', movementGoals: '', movementKeyHabit: '', movementTrigger: '', movementRoutine: '', movementReward: '', movementAccountabilityPartner: '',
                mentalCanControl: '', mentalCannotControl: '',
                stopDoing1: '', stopDoing2: '', stopDoing3: '',
                doLess1: '', doLess2: '', doLess3: '',
                doMore1: '', doMore2: '', doMore3: '',
                eventDescription: '', gapAnalysis: '', idealResponse: '', futurePlan: ''
            });

            // Team data
            const [teamData, setTeamData] = useState({
                meetingNotes: '',
                pdpMembers: [],
                companyCommitments: '',
                energyBusinessImpact: '',
                trustStrategy: '',
                teamStrategies: [
                    { title: '', description: '' },
                    { title: '', description: '' },
                    { title: '', description: '' }
                ]
            });

            const STORAGE_KEY = CONFIG.STORAGE_KEY;

            // Load saved data from localStorage
            useEffect(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const data = JSON.parse(saved);

                        // Migration: clear old format data
                        if (data.formData && !data.mode && data.step !== undefined && typeof data.step === 'number' && data.step > 0 && !data.teamData) {
                            // Old single-phase format -- migrate formData
                            if (data.formData) setFormData(prev => ({ ...prev, ...data.formData }));
                            setStep(0);
                            return;
                        }

                        if (data.formData) setFormData(prev => ({ ...prev, ...data.formData }));
                        if (data.teamData) setTeamData(prev => ({ ...prev, ...data.teamData }));
                        if (data.step !== undefined) setStep(data.step);
                        if (data.mode) setMode(data.mode);
                    }
                } catch (e) {
                    console.warn('[Energy] Failed to load saved data:', e);
                }
            }, []);

            // Autosave to localStorage
            useEffect(() => {
                const timer = setTimeout(() => {
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify({
                            formData,
                            teamData,
                            step,
                            mode,
                            lastSaved: new Date().toISOString()
                        }));
                    } catch (e) {
                        console.warn('[Energy] Failed to save:', e);
                    }
                }, CONFIG.AUTOSAVE_DELAY);
                return () => clearTimeout(timer);
            }, [formData, teamData, step, mode]);

            // Load dependencies
            useEffect(() => {
                const loadDeps = async () => {
                    try {
                        const userId = localStorage.getItem('ft_user_id');
                        if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[Energy] Failed to load dependencies:', err);
                    }
                };
                loadDeps();
            }, []);

            // Check if team tool should be unlocked
            const checkTeamUnlock = async () => {
                setCheckingTeamUnlock(true);
                try {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) { setCheckingTeamUnlock(false); return; }

                    const { data: userData } = await supabaseClient
                        .from('users')
                        .select('organization_id')
                        .eq('id', userId)
                        .single();

                    if (!userData?.organization_id) {
                        console.warn('[Energy] No organization found -- team tool stays locked');
                        setCheckingTeamUnlock(false);
                        return;
                    }

                    // Count org members
                    const { data: orgMembers } = await supabaseClient
                        .from('users')
                        .select('id')
                        .eq('organization_id', userData.organization_id);

                    if (!orgMembers || orgMembers.length === 0) {
                        setCheckingTeamUnlock(false);
                        return;
                    }

                    // Count who submitted energy-individual
                    const memberIds = orgMembers.map(m => m.id);
                    const { data: submissions } = await supabaseClient
                        .from('user_responses')
                        .select('user_id')
                        .eq('tool_slug', 'energy-individual')
                        .in('user_id', memberIds);

                    const submittedCount = submissions ? new Set(submissions.map(s => s.user_id)).size : 0;
                    const allSubmitted = submittedCount >= orgMembers.length;

                    setTeamToolUnlocked(allSubmitted);
                } catch (e) {
                    console.warn('[Energy] Team unlock check failed:', e);
                } finally {
                    setCheckingTeamUnlock(false);
                }
            };

            // Check team unlock on intro page
            useEffect(() => {
                if (step === 0.5) {
                    checkTeamUnlock();
                }
            }, [step]);

            // Navigation helpers
            const goToStep = (newStep) => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setStep(newStep);
            };

            const updateField = (field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            };

            // AI-gated step navigation
            const handleStepNext = async (nextStepValue, stepAnswers, stepName) => {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) {
                    goToStep(nextStepValue);
                    return;
                }
                setAiReviewing(true);
                try {
                    const canGo = await window.AIChallenge.reviewStep(userId, 'energy', stepAnswers, stepName);
                    if (canGo) {
                        goToStep(nextStepValue);
                    }
                } catch (err) {
                    console.warn('AI review error, allowing passage:', err);
                    goToStep(nextStepValue);
                } finally {
                    setAiReviewing(false);
                }
            };

            // Submit individual phase
            const handleIndividualSubmit = async () => {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) {
                    alert('User not authenticated. Please return to the dashboard.');
                    return;
                }

                const questionMappings = {
                    energy_audit: {
                        sleep: { rating: formData.sleepRating, doWell: formData.sleepDoWell, notDoWell: formData.sleepNotDoWell, goals: formData.sleepGoals },
                        nutrition: { rating: formData.nutritionRating, doWell: formData.nutritionDoWell, notDoWell: formData.nutritionNotDoWell, goals: formData.nutritionGoals },
                        movement: { rating: formData.movementRating, doWell: formData.movementDoWell, notDoWell: formData.movementNotDoWell, goals: formData.movementGoals }
                    },
                    habit_commitments: {
                        sleep: { keyHabit: formData.sleepKeyHabit, trigger: formData.sleepTrigger, routine: formData.sleepRoutine, reward: formData.sleepReward, accountabilityPartner: formData.sleepAccountabilityPartner },
                        nutrition: { keyHabit: formData.nutritionKeyHabit, trigger: formData.nutritionTrigger, routine: formData.nutritionRoutine, reward: formData.nutritionReward, accountabilityPartner: formData.nutritionAccountabilityPartner },
                        movement: { keyHabit: formData.movementKeyHabit, trigger: formData.movementTrigger, routine: formData.movementRoutine, reward: formData.movementReward, accountabilityPartner: formData.movementAccountabilityPartner }
                    },
                    mental_energy: {
                        mentalCanControl: formData.mentalCanControl,
                        mentalCannotControl: formData.mentalCannotControl,
                        stopDoing: [formData.stopDoing1, formData.stopDoing2, formData.stopDoing3],
                        doLess: [formData.doLess1, formData.doLess2, formData.doLess3],
                        doMore: [formData.doMore1, formData.doMore2, formData.doMore3]
                    },
                    event_gap_response: {
                        eventDescription: formData.eventDescription,
                        gapAnalysis: formData.gapAnalysis,
                        idealResponse: formData.idealResponse,
                        futurePlan: formData.futurePlan
                    }
                };

                await window.AIChallenge.submitWithChallenge(userId, 'energy-individual', questionMappings, {
                    onReviewStart: () => { setSubmitStatus('saving'); setSubmitMessage('AI coach is reviewing...'); },
                    onRevise: () => { setSubmitStatus(null); setSubmitMessage(''); goToStep(5); },
                    onSubmitAnyway: () => { setSubmitStatus('success'); setSubmitMessage('Your energy protocol has been submitted.'); setIndividualSubmitted(true); },
                    onError: (err) => { setSubmitStatus('error'); setSubmitMessage('Failed to save: ' + err.message); }
                });
            };

            // Submit team phase
            const handleTeamSubmit = async () => {
                try {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId) {
                        alert('User not authenticated.');
                        return;
                    }
                    const questionMappings = {
                        meeting_notes: teamData.meetingNotes,
                        personal_development_plans: (teamData.pdpMembers || []).map(m => ({
                            name: m.name,
                            commitment: m.commitment,
                            measurable: m.measurable,
                            timeline: m.timeline
                        })),
                        company_commitments: teamData.companyCommitments,
                        energy_business_impact: teamData.energyBusinessImpact,
                        trust_strategy: teamData.trustStrategy,
                        team_strategies: teamData.teamStrategies
                    };

                    await window.AIChallenge.submitWithChallenge(userId, 'energy-team', questionMappings, {
                        onReviewStart: () => { setSubmitStatus('saving'); setSubmitMessage('AI coach is reviewing...'); },
                        onRevise: () => { setSubmitStatus(null); setSubmitMessage(''); },
                        onSubmitAnyway: () => { setSubmitStatus('success'); setSubmitMessage('Team energy plan submitted successfully!'); },
                        onError: (err) => { setSubmitStatus('error'); setSubmitMessage('Failed to save: ' + err.message); }
                    });
                } catch (error) {
                    console.error('[Energy] Team submit error:', error);
                    setSubmitStatus('error');
                    setSubmitMessage('Failed to submit: ' + error.message);
                }
            };

            // PDF export
            const exportPDF = async () => {
                try {
                    const element = document.getElementById('canvas-content');
                    if (!element) return;
                    const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    pdf.addImage(imgData, 'PNG', imgX, 10, imgWidth * ratio, imgHeight * ratio);
                    pdf.save('energy-protocol.pdf');
                } catch (error) {
                    console.error('PDF export error:', error);
                    alert('Failed to export PDF');
                }
            };

            // Validation
            const canProceedIndividual = (stepNum) => {
                const pillar = PILLAR_BY_STEP[stepNum];
                if (pillar) {
                    return formData[pillar + 'KeyHabit'] && formData[pillar + 'Trigger'];
                }
                if (stepNum === 4) return formData.mentalCanControl && formData.mentalCanControl.trim().length > 0;
                if (stepNum === 5) return formData.eventDescription && formData.eventDescription.trim().length > 0;
                return true;
            };

            const canProceedTeam = (stepNum) => {
                if (stepNum === 7) return true; // meeting facilitation
                if (stepNum === 8) {
                    const hasPDP = (teamData.pdpMembers || []).length >= 1;
                    const hasStrategy = teamData.teamStrategies.some(s => s.title && s.title.trim().length > 0);
                    return hasPDP && hasStrategy;
                }
                return true;
            };

            // Clear saved data
            const clearCache = () => {
                localStorage.removeItem(STORAGE_KEY);
                setFormData({
                    sleepRating: 5, sleepDoWell: '', sleepNotDoWell: '', sleepGoals: '', sleepKeyHabit: '', sleepTrigger: '', sleepRoutine: '', sleepReward: '', sleepAccountabilityPartner: '',
                    nutritionRating: 5, nutritionDoWell: '', nutritionNotDoWell: '', nutritionGoals: '', nutritionKeyHabit: '', nutritionTrigger: '', nutritionRoutine: '', nutritionReward: '', nutritionAccountabilityPartner: '',
                    movementRating: 5, movementDoWell: '', movementNotDoWell: '', movementGoals: '', movementKeyHabit: '', movementTrigger: '', movementRoutine: '', movementReward: '', movementAccountabilityPartner: '',
                    mentalCanControl: '', mentalCannotControl: '',
                    stopDoing1: '', stopDoing2: '', stopDoing3: '',
                    doLess1: '', doLess2: '', doLess3: '',
                    doMore1: '', doMore2: '', doMore3: '',
                    eventDescription: '', gapAnalysis: '', idealResponse: '', futurePlan: ''
                });
                setTeamData({
                    meetingNotes: '',
                    pdpMembers: [],
                    companyCommitments: '',
                    energyBusinessImpact: '',
                    trustStrategy: '',
                    teamStrategies: [
                        { title: '', description: '' },
                        { title: '', description: '' },
                        { title: '', description: '' }
                    ]
                });
                setMode(null);
                setStep(0);
                setSubmitStatus(null);
                setSubmitMessage('');
                setIndividualSubmitted(false);
            };

            // Get next step label
            const getIndividualNextLabel = (s) => {
                if (s === 1) return 'Nutrition';
                if (s === 2) return 'Movement';
                if (s === 3) return 'Mental Focus';
                if (s === 4) return 'Event-Gap';
                if (s === 5) return 'Review Protocol';
                return 'Next';
            };

            /* ============================================================
               RENDER
               ============================================================ */

            return (
                <>
                    {/* ===== STEP 0: COVER SCREEN ===== */}
                    {step === 0 && (
                        <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                            <div style={{ position: 'absolute', inset: 0, backgroundImage: 'url("https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?w=1920&q=80")', backgroundSize: 'cover', backgroundPosition: 'center', opacity: 0.4 }} />
                            <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                                <div className="monument" style={{ fontSize: 14, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>TOOL 07</div>
                                <div style={{ display: 'inline-block', border: '2px solid #DAA520', padding: '6px 16px', marginBottom: 24 }}>
                                    <span className="monument" style={{ fontSize: 11, color: '#DAA520', letterSpacing: '0.08em' }}>INDIVIDUAL + TEAM TOOL</span>
                                </div>
                                <h1 className="plaak" style={{ fontSize: 64, marginBottom: 16, textTransform: 'uppercase' }}>CREATING ENERGY IN<br/>BODY AND MIND</h1>
                                <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48 }}>Design your complete energy protocol across physical and mental performance</p>
                                <button
                                    onClick={() => goToStep(0.5)}
                                    style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease', minHeight: 44 }}
                                    onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                    onMouseOut={e => { e.target.style.background = '#fff'; }}
                                >START</button>
                                <div style={{ marginTop: 24 }}>
                                    <button onClick={clearCache} style={{ background: 'none', border: 'none', color: '#555', fontSize: 12, cursor: 'pointer', fontFamily: "'Monument', monospace" }}>
                                        CLEAR SAVED DATA
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== STEP 0.5: PHASE SELECT ===== */}
                    {step === 0.5 && (
                        <div style={{ minHeight: '100vh', background: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ maxWidth: 720, width: '100%', padding: '48px 32px' }} className="animate-in">
                                <div style={{ textAlign: 'center', marginBottom: 48 }}>
                                    <div className="monument" style={{ fontSize: 12, color: '#6B7280', letterSpacing: '0.1em', marginBottom: 8 }}>TOOL 07</div>
                                    <h1 className="plaak" style={{ fontSize: 42, color: '#000', marginBottom: 8 }}>CREATING ENERGY IN BODY AND MIND</h1>
                                    <p style={{ fontSize: 16, color: '#6B7280' }}>Choose your path below</p>
                                </div>

                                {/* Box 1: Individual Assessment (always available) */}
                                <div style={{ border: '2px solid #000', padding: 32, marginBottom: 24 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                        <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 600 }}>Individual Assessment</div>
                                        <span className="monument" style={{ fontSize: 11, color: '#6B7280' }}>~40 MIN</span>
                                    </div>
                                    <p style={{ fontSize: 15, color: '#374151', lineHeight: 1.6, marginBottom: 24 }}>
                                        Analyze your physical and mental energy across sleep, nutrition, movement, and mindset. Build one key habit for each physical pillar, then master your mental energy through control analysis and event-gap-response.
                                    </p>
                                    <button
                                        onClick={() => { setMode('individual'); goToStep(1); }}
                                        className="btn-primary"
                                        style={{ width: '100%' }}
                                    >
                                        START INDIVIDUAL ASSESSMENT
                                    </button>
                                </div>

                                {/* Box 2: Team Meeting Tool (LOCKED until all individuals submit) */}
                                <div style={{ border: '2px solid ' + (teamToolUnlocked ? '#000' : '#E5E7EB'), padding: 32, marginBottom: 32, opacity: teamToolUnlocked ? 1 : 0.7 }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                            {!teamToolUnlocked && <LockIcon size={16} />}
                                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.08em', fontWeight: 600 }}>
                                                Team Meeting Tool
                                            </div>
                                        </div>
                                        <span className="monument" style={{ fontSize: 11, color: '#6B7280' }}>~60 MIN</span>
                                    </div>
                                    {teamToolUnlocked ? (
                                        <>
                                            <p style={{ fontSize: 15, color: '#374151', lineHeight: 1.6, marginBottom: 24 }}>
                                                Facilitate the 60-minute team energy meeting. Review insights, discuss dynamics, and set team energy strategies.
                                            </p>
                                            <button
                                                onClick={() => { setMode('team'); goToStep(7); }}
                                                className="btn-primary"
                                                style={{ width: '100%' }}
                                            >
                                                START TEAM MEETING
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            <p style={{ fontSize: 15, color: '#6B7280', lineHeight: 1.6, marginBottom: 24 }}>
                                                Locked until all team members complete their individual energy assessment. The CEO facilitates the 60-minute team meeting to set collective energy strategies.
                                            </p>
                                            <div
                                                onClick={(e) => {
                                                    if (e.shiftKey) {
                                                        console.log('[DEV] Force-unlocking team tool');
                                                        setTeamToolUnlocked(true);
                                                    }
                                                }}
                                                style={{ background: '#F3F4F6', padding: '12px 16px', textAlign: 'center', color: '#9CA3AF', fontFamily: "'Monument', monospace", fontSize: 12, cursor: 'default' }}
                                                title="Shift+Click to force unlock (dev only)"
                                            >
                                                {checkingTeamUnlock ? 'CHECKING...' : 'LOCKED -- WAITING FOR TEAM'}
                                            </div>
                                        </>
                                    )}
                                </div>

                                {/* Journey Overview */}
                                <div style={{ marginBottom: 32 }}>
                                    <div className="monument" style={{ fontSize: 11, color: '#6B7280', letterSpacing: '0.05em', marginBottom: 12, textTransform: 'uppercase' }}>Journey Overview</div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 }}>
                                        <div>
                                            <div className="monument" style={{ fontSize: 10, color: '#000', marginBottom: 8, fontWeight: 600 }}>Phase 1: Individual</div>
                                            <div style={{ fontSize: 13, color: '#374151', lineHeight: 2 }}>
                                                01 Sleep<br/>02 Nutrition<br/>03 Movement<br/>04 Mental Focus<br/>05 Event-Gap Analysis<br/>06 Review
                                            </div>
                                        </div>
                                        <div style={{ opacity: teamToolUnlocked ? 1 : 0.4 }}>
                                            <div className="monument" style={{ fontSize: 10, color: '#6B7280', marginBottom: 8, fontWeight: 600 }}>Phase 2: Team Meeting</div>
                                            <div style={{ fontSize: 13, color: '#6B7280', lineHeight: 2 }}>
                                                07 Meeting Agenda<br/>08 PDPs & Commitments
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style={{ textAlign: 'center' }}>
                                    <button onClick={() => goToStep(0)} style={{ background: 'none', border: '2px solid #E5E7EB', color: '#6B7280', padding: '10px 24px', fontSize: 14, cursor: 'pointer', fontFamily: "'Riforma', sans-serif" }}>
                                        &larr; Back to Cover
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== TRANSITION SCREENS (individual phase) ===== */}
                    {[1.5, 2.5, 3.5, 4.5, 5.5].includes(step) && (() => {
                        const completedStep = Math.floor(step);
                        const nextStep = completedStep + 1;
                        const t = TRANSITION_CONTENT[completedStep];
                        if (!t) { goToStep(nextStep); return null; }
                        const totalSteps = mode === 'individual' ? 6 : 2;
                        return (
                            <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                    <div className="monument" style={{ fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>
                                        STEP {completedStep} OF {totalSteps} COMPLETE
                                    </div>
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 12 }}>{t.title}</h1>
                                    <p style={{ fontSize: 16, color: '#ccc', marginBottom: 48 }}>{t.text}</p>

                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>{t.brutalTruth}</p>
                                    </div>

                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                                    </div>

                                    <button
                                        onClick={() => goToStep(nextStep)}
                                        style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }}
                                        onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                        onMouseOut={e => { e.target.style.background = '#fff'; }}
                                    >CONTINUE</button>
                                </div>
                            </div>
                        );
                    })()}

                    {/* ===== TRANSITION: Team meeting -> PDPs (step 7.5) ===== */}
                    {step === 7.5 && (() => {
                        const t = TRANSITION_CONTENT[7];
                        return (
                            <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                <div style={{ maxWidth: 640, padding: '0 32px', textAlign: 'center', color: '#fff' }} className="animate-in">
                                    <div className="monument" style={{ fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 16 }}>
                                        STEP 1 OF 2 COMPLETE
                                    </div>
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 12 }}>{t.title}</h1>
                                    <p style={{ fontSize: 16, color: '#ccc', marginBottom: 48 }}>{t.text}</p>

                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #FFF469', padding: '20px 24px', marginBottom: 24, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#FFF469', display: 'block', marginBottom: 8 }}>BRUTAL TRUTH</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7 }}>{t.brutalTruth}</p>
                                    </div>
                                    <div style={{ background: '#111', border: '1px solid #333', borderLeft: '4px solid #666', padding: '20px 24px', marginBottom: 48, textAlign: 'left' }}>
                                        <span className="monument" style={{ fontSize: 10, color: '#999', display: 'block', marginBottom: 8 }}>PEER PROOF</span>
                                        <p style={{ fontSize: 14, color: '#ccc', lineHeight: 1.7, fontStyle: 'italic' }}>{t.peerProof}</p>
                                    </div>

                                    <button
                                        onClick={() => goToStep(8)}
                                        style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }}
                                        onMouseOver={e => { e.target.style.background = '#FFF469'; }}
                                        onMouseOut={e => { e.target.style.background = '#fff'; }}
                                    >FINALIZE PDPs</button>
                                </div>
                            </div>
                        );
                    })()}

                    {/* ===== INDIVIDUAL PHASE GATE (step 6.5) -- after review submit ===== */}
                    {step === 6.5 && (
                        <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                                <div style={{ width: 64, height: 64, borderRadius: '50%', background: '#FFF469', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 24px' }}>
                                    <CheckIcon color="#000" size={32} />
                                </div>
                                <h1 className="plaak" style={{ fontSize: 48, color: '#FFF469', marginBottom: 16 }}>PROTOCOL SUBMITTED</h1>
                                <p style={{ fontSize: 18, color: '#ccc', maxWidth: 500, margin: '0 auto 32px' }}>
                                    Your complete energy protocol has been saved. Share it with your Guru before the team meeting.
                                </p>
                                <p style={{ fontSize: 14, color: '#999', marginBottom: 32 }}>You can close this page or return to the overview.</p>
                                <div style={{ display: 'flex', gap: 16, justifyContent: 'center', flexWrap: 'wrap' }}>
                                    <button
                                        onClick={() => { setMode('individual'); goToStep(1); }}
                                        style={{ background: 'none', border: '2px solid #555', color: '#999', padding: '12px 24px', fontSize: 14, cursor: 'pointer', fontFamily: "'Riforma', sans-serif" }}
                                    >
                                        Review My Protocol
                                    </button>
                                    <button
                                        onClick={() => goToStep(0.5)}
                                        style={{ background: 'none', border: '2px solid #555', color: '#999', padding: '12px 24px', fontSize: 14, cursor: 'pointer', fontFamily: "'Riforma', sans-serif" }}
                                    >
                                        Back to Overview
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ===== TEAM SUCCESS (step 999) ===== */}
                    {step === 999 && (
                        <div style={{ minHeight: '100vh', background: '#000', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ textAlign: 'center', color: '#fff' }} className="animate-in">
                                <div style={{ fontSize: 64, marginBottom: 32 }}><CheckIcon color="#FFF469" size={64} /></div>
                                <h1 className="plaak" style={{ fontSize: 48, marginBottom: 16 }}>TEAM ENERGY PLAN SUBMITTED</h1>
                                <p style={{ fontSize: 18, color: '#ccc', maxWidth: 500, margin: '0 auto' }}>Your team energy strategies, PDPs, and company commitments have been saved. Every team member now has a clear energy roadmap.</p>
                            </div>
                        </div>
                    )}

                    {/* ===== WIZARD LAYOUT: INDIVIDUAL STEPS 1-6 ===== */}
                    {mode === 'individual' && Number.isInteger(step) && step >= 1 && step <= 6 && (
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={step} totalSteps={6} />
                                <div className="wizard-content animate-in">
                                    {step === 1 && <><DependencyContext deps={deps} /><PillarSection pillar="sleep" title="Sleep" stepNum={1} formData={formData} updateField={updateField} /></>}
                                    {step === 2 && <PillarSection pillar="nutrition" title="Nutrition" stepNum={2} formData={formData} updateField={updateField} />}
                                    {step === 3 && <PillarSection pillar="movement" title="Movement" stepNum={3} formData={formData} updateField={updateField} />}
                                    {step === 4 && <MentalFocusStep formData={formData} updateField={updateField} />}
                                    {step === 5 && <EventGapStep formData={formData} updateField={updateField} />}
                                    {step === 6 && <ReviewStep formData={formData} onSubmit={handleIndividualSubmit} submitStatus={submitStatus} submitMessage={submitMessage} />}
                                </div>
                                {step <= 5 && (
                                    <ButtonFooter
                                        onBack={() => {
                                            if (step === 1) goToStep(0.5);
                                            else goToStep(step - 1);
                                        }}
                                        onNext={() => {
                                            const pillar = PILLAR_BY_STEP[step];
                                            let answers = {};
                                            if (pillar) {
                                                answers[pillar + '_protocol'] = {
                                                    rating: formData[pillar + 'Rating'],
                                                    keyHabit: formData[pillar + 'KeyHabit'],
                                                    trigger: formData[pillar + 'Trigger']
                                                };
                                                handleStepNext(step + 0.5, answers, PILLAR_TITLE[step] + ' Protocol');
                                            } else if (step === 4) {
                                                answers.mental_focus = {
                                                    canControl: formData.mentalCanControl,
                                                    stopDoing: [formData.stopDoing1, formData.stopDoing2, formData.stopDoing3]
                                                };
                                                handleStepNext(4.5, answers, 'Mental Focus');
                                            } else if (step === 5) {
                                                answers.event_gap = {
                                                    event: formData.eventDescription,
                                                    gap: formData.gapAnalysis,
                                                    ideal: formData.idealResponse
                                                };
                                                handleStepNext(5.5, answers, 'Event-Gap Analysis');
                                            }
                                        }}
                                        nextLabel={getIndividualNextLabel(step)}
                                        showBack={true}
                                        disabled={!canProceedIndividual(step) || aiReviewing}
                                    />
                                )}
                                {step === 6 && (
                                    <ButtonFooter
                                        onBack={() => goToStep(5)}
                                        onNext={handleIndividualSubmit}
                                        nextLabel="Submit Protocol"
                                        showBack={true}
                                        disabled={submitStatus === 'saving'}
                                    />
                                )}
                            </div>
                            <WizardSidebar
                                currentStep={step}
                                mode="individual"
                                formData={formData}
                                teamData={teamData}
                                onNavigate={(s) => goToStep(s)}
                            />
                        </div>
                    )}

                    {/* ===== WIZARD LAYOUT: TEAM STEPS 7-8 ===== */}
                    {mode === 'team' && Number.isInteger(step) && step >= 7 && step <= 8 && (
                        <div className="wizard-layout">
                            <div className="wizard-main">
                                <MobileStepBar currentStep={step - 6} totalSteps={2} />
                                <div className="wizard-content animate-in">
                                    {step === 7 && <TeamMeetingStep teamData={teamData} setTeamData={setTeamData} />}
                                    {step === 8 && <PDPStep teamData={teamData} setTeamData={setTeamData} onSubmit={handleTeamSubmit} submitStatus={submitStatus} submitMessage={submitMessage} />}
                                </div>
                                <ButtonFooter
                                    onBack={() => {
                                        if (step === 7) goToStep(0.5);
                                        else goToStep(7);
                                    }}
                                    onNext={() => {
                                        if (step === 7) {
                                            goToStep(7.5);
                                        } else if (step === 8) {
                                            handleTeamSubmit();
                                        }
                                    }}
                                    nextLabel={step === 7 ? 'PDPs & Commitments' : 'Submit Team Plan'}
                                    showBack={true}
                                    disabled={
                                        (step === 8 && !canProceedTeam(8)) ||
                                        submitStatus === 'saving'
                                    }
                                />
                            </div>
                            <WizardSidebar
                                currentStep={step}
                                mode="team"
                                formData={formData}
                                teamData={teamData}
                                onNavigate={(s) => goToStep(s)}
                            />
                        </div>
                    )}
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
