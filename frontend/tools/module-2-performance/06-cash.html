<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Flow Analysis | Fast Track Program</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../shared/js/tool-db.js"></script>
    <script src="../../shared/js/ai-challenge.js"></script>
    <script src="../../shared/js/dependency-injection.js"></script>
    <link rel="stylesheet" href="../../shared/css/cognitive-load.css">
    <script src="../../shared/js/cognitive-load.js"></script>
    <script src="../../js/tool-access-control.js"></script>
    <script src="../../shared/js/transition-screen.js"></script>

    <style>
        /* === FONT FACES === */
        @font-face { font-family: 'Plaak'; src: url('Plaak3Trial-43-Bold.woff2') format('woff2'); font-weight: bold; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: normal; }
        @font-face { font-family: 'Riforma'; src: url('RiformaLL-Regular.woff2') format('woff2'); font-weight: 600; }
        @font-face { font-family: 'Monument'; src: url('MonumentGrotesk-Mono.woff2') format('woff2'); }

        /* === BASE RESET === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Riforma', -apple-system, sans-serif;
            font-size: 16px;
            color: #000;
            background: #000;
            -webkit-font-smoothing: antialiased;
        }

        /* === CUSTOM SCROLLBAR === */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #333; }
        * { scrollbar-width: thin; scrollbar-color: #000 transparent; }

        /* === TYPOGRAPHY HELPERS === */
        .plaak { font-family: 'Plaak', sans-serif; font-weight: bold; letter-spacing: -0.01em; line-height: 1.2; }
        .monument { font-family: 'Monument', monospace; letter-spacing: 0.05em; }

        /* === LAYOUT FRAME === */
        .tool-frame { background: #fff; min-height: 100vh; }
        .tool-inner { background: #fff; min-height: 100vh; }

        /* === WIZARD LAYOUT === */
        .wizard-layout { display: flex; min-height: 100vh; }
        .wizard-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #fff;
        }
        .wizard-content {
            max-width: 640px;
            width: 100%;
            margin: 0 auto;
            padding: 48px 32px;
            flex: 1;
        }

        /* === SIDEBAR === */
        .wizard-sidebar {
            width: 280px;
            background: #000;
            border-left: 1px solid #000;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow: hidden;
        }
        .wizard-sidebar-inner {
            padding: 32px 24px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .sidebar-step-item {
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .sidebar-step-item.active { border-left-color: #FFF469; background: #222; }
        .sidebar-step-item.completed { background: #fff; color: #000; border-left-color: #fff; cursor: pointer; }
        .sidebar-step-item.completed:hover { background: #E0E0E0; }
        .sidebar-step-item.locked { opacity: 0.5; }
        .sidebar-step-item .step-num { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-step-item .step-name { font-family: 'Riforma', sans-serif; font-size: 14px; }
        .sidebar-snippet { font-size: 12px; margin-top: 4px; opacity: 0.7; line-height: 1.3; }

        /* === STEP HEADER === */
        .step-indicator {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6B7280;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-heading {
            font-family: 'Plaak', sans-serif;
            font-weight: bold;
            font-size: 32px;
            text-transform: uppercase;
            letter-spacing: -0.01em;
            line-height: 1.2;
            color: #000;
            margin-bottom: 6px;
        }
        .step-hint {
            font-size: 16px;
            color: #6B7280;
            line-height: 1.5;
            margin: 0 0 32px 0;
        }
        .opening-box { margin-bottom: 32px; }

        /* === FORM ELEMENTS === */
        .field-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: 'Monument', monospace;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 8px;
        }
        .field-input {
            width: 100%;
            height: 44px;
            padding: 8px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .field-input:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }
        .field-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px 16px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            color: #000;
            background: #fff;
            border: 1px solid #E5E7EB;
            resize: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .field-textarea:focus {
            outline: none;
            border-color: #000;
            box-shadow: 0 0 0 3px #FFF469;
        }
        .field-help {
            font-size: 14px;
            color: #6B7280;
            margin-top: 4px;
            line-height: 1.5;
        }
        .field-group { margin-bottom: 24px; }
        .field-group:last-child { margin-bottom: 0; }

        /* === LEARN MORE === */
        .learn-more-toggle {
            font-family: 'Monument', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            background: #F3F4F6;
            border: 1px solid #E5E7EB;
            cursor: pointer;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 32px;
            transition: background 0.15s ease;
        }
        .learn-more-toggle:hover { background: #E5E7EB; }
        .learn-more-content {
            border-left: 3px solid #000;
            background: #F3F4F6;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #374151;
            line-height: 1.7;
        }

        /* === YELLOW INSIGHT BOX (matches WOOP) === */
        .ft-insight {
            background: #FFF469;
            border: 3px solid #000;
            padding: 16px;
            margin-bottom: 32px;
        }

        /* === CLOSING MESSAGE === */
        .closing-box {
            border-top: 1px solid #E5E7EB;
            padding: 20px 0 0 0;
            margin-top: 8px;
            text-align: center;
        }
        .closing-box p { font-size: 14px; color: #6B7280; }
        .closing-box .closing-title {
            font-family: 'Monument', monospace;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #000;
            margin-bottom: 6px;
        }

        /* === BUTTON FOOTER (sticky like WOOP) === */
        .btn-footer {
            position: sticky;
            bottom: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            border-top: 1px solid #E5E7EB;
            background: #fff;
            width: 100%;
        }
        .btn-back {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-back:hover { background: #F3F4F6; }
        .btn-next {
            background: #000;
            color: #fff;
            border: 2px solid #000;
            padding: 12px 24px;
            font-family: 'Riforma', sans-serif;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
        }
        .btn-next:hover:not(:disabled) { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-next:disabled { background: #E5E7EB; color: #9CA3AF; border-color: #E5E7EB; cursor: not-allowed; }

        /* === MOBILE === */
        .mobile-step-bar { display: none; padding: 12px 16px; border-bottom: 1px solid #E5E7EB; background: #F3F4F6; }
        .mobile-step-bar .bar-text { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 6px; }
        .mobile-progress { height: 3px; background: #E5E7EB; width: 100%; }
        .mobile-progress-fill { height: 100%; background: #000; transition: width 0.3s ease; }

        /* === CASH-SPECIFIC === */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .section-divider { border-top: 1px solid #E5E7EB; padding-top: 24px; margin-top: 24px; }
        .section-label { font-family: 'Monument', monospace; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #6B7280; margin-bottom: 16px; }

        .metrics-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; padding: 16px; background: #F3F4F6; border-left: 3px solid #000; margin: 16px 0; }
        .metric-item .metric-label { font-size: 11px; color: #6B7280; font-family: 'Monument', monospace; text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 2px; }
        .metric-item .metric-value { font-weight: 600; font-size: 15px; }
        .metric-badge { display: inline-block; font-size: 10px; padding: 2px 6px; font-family: 'Monument', monospace; text-transform: uppercase; letter-spacing: 0.03em; margin-left: 4px; }
        .badge-good { background: #d1fae5; color: #065f46; }
        .badge-avg { background: #fef3c7; color: #92400e; }
        .badge-weak { background: #fee2e2; color: #991b1b; }

        .balance-ok { background: #f0fdf4; border-left: 3px solid #059669; padding: 10px 14px; margin-top: 12px; font-size: 13px; color: #166534; }
        .balance-err { background: #fef2f2; border-left: 3px solid #DC2626; padding: 10px 14px; margin-top: 12px; font-size: 13px; color: #991b1b; }

        /* Sliders */
        .lever-slider-row { padding: 16px 0; border-bottom: 1px solid #f0f0f0; }
        .lever-slider-row:last-child { border-bottom: none; }
        .lever-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .lever-name { font-weight: 600; font-size: 14px; }
        .lever-impacts { display: flex; gap: 16px; font-size: 13px; }
        .lever-cash { color: #059669; font-weight: 600; }
        .lever-ebit { color: #2563eb; font-weight: 600; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: #E5E7EB; outline: none; border-radius: 2px; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #000; cursor: pointer; border-radius: 50%; border: 2px solid #000; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #000; cursor: pointer; border-radius: 50%; border: 2px solid #000; }
        .slider-value { font-family: 'Monument', monospace; font-size: 13px; min-width: 60px; text-align: right; }

        .impact-total-bar { background: #000; color: #fff; padding: 20px 24px; margin-bottom: 24px; display: flex; justify-content: space-around; text-align: center; }
        .impact-total-item .impact-label { font-family: 'Monument', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #999; margin-bottom: 4px; }
        .impact-total-item .impact-number { font-family: 'Plaak', sans-serif; font-size: 28px; }

        /* Action plan */
        .idea-row { display: flex; gap: 12px; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .idea-row:last-child { border-bottom: none; }
        .score-badge { font-family: 'Monument', monospace; font-size: 12px; background: #F3F4F6; padding: 4px 8px; min-width: 32px; text-align: center; }

        /* === ANIMATIONS === */
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-in { animation: fadeSlideIn 0.3s ease-out; }

        /* === PRINT === */
        @media print { .no-print { display: none !important; } }

        /* === RESPONSIVE === */
        @media (min-width: 769px) and (max-width: 1024px) {
            .wizard-sidebar { width: 220px; }
            .wizard-sidebar-inner { padding: 24px 16px; }
        }
        @media (max-width: 768px) {
            .wizard-sidebar { display: none; }
            .mobile-step-bar { display: block; }
            .wizard-content { padding: 24px 16px; }
            .step-heading { font-size: 24px; }
            .btn-footer { padding: 12px 16px; }
            .two-col { grid-template-columns: 1fr !important; }
        }
        @media (max-width: 480px) {
            .step-heading { font-size: 20px; }
            .wizard-content { padding: 20px 12px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CONFIG = {
            SUPABASE_URL: 'https://lutzzfaedkbsmbobmrzx.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U',
            TOOL_SLUG: 'cash',
            AUTOSAVE_DELAY: 2000,
            TRANSITION_CONTENT: {
                1: {
                    brutalTruth: '70% of businesses that fail do so while profitable on paper. Cash timing kills — receivables due in 60 days and payables due in 30 is a death sentence regardless of your margins. Profit is opinion. Cash is fact.',
                    peerProof: '"A €3M construction firm discovered a €180k cash gap six weeks out. They renegotiated three supplier payment terms and secured a €100k credit line — without it, they would have missed payroll. The forecast saved the company."'
                },
                2: {
                    brutalTruth: 'Most founders treat cash forecasting as a formality. Real forecasting means stress-testing: What if your biggest customer pays 45 days late? What if your biggest order gets cancelled? The business that survives is the one that ran that scenario before it happened.',
                    peerProof: '"A fast-growing SaaS company ran a downside scenario before their Series A. They found a 3-month cash gap at 50% of projected growth and pre-emptively cut €60k in costs. No crisis. Just preparation — and investors noticed."'
                }
            },
            CLOSING_MESSAGES: {
                1: { title: 'CASH PICTURE CLEAR', text: 'Your current cash reality is mapped. Next: build the forecast and stress-test the gaps.' },
                2: { title: 'FORECAST BUILT', text: 'Your cash model is complete. Review it monthly. Cash surprises are only surprises once.' }
            }
        };

        const totalSteps = 2;

        const { createClient } = supabase;
        const supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        window.supabaseClient = supabaseClient;
        ToolDB.init(CONFIG.TOOL_SLUG);
        ToolAccessControl.init(CONFIG.TOOL_SLUG);
        CognitiveLoad.init('cash');

        const LOGO_WHITE = '../../../Designs/02. logos/FastTrack_F_White.png';

        // =========================================================================
        // INDUSTRY TRANSLATOR — dynamic field labels per business model
        // =========================================================================
        const LABELS = {
            manufacturing: { cogs: 'Cost of Goods Sold (COGS)', directLabor: 'Direct Labor', inventory: 'Inventory', daysInv: 'Days of Inventory', stockLever: 'Reduce Stock Days' },
            service:       { cogs: 'Cost of Delivery', directLabor: 'Billable Staff Costs', inventory: 'Work in Progress (Unbilled)', daysInv: 'Days of WIP', stockLever: 'Reduce WIP Days' },
            retail:        { cogs: 'Cost of Goods Sold (COGS)', directLabor: 'Store Staff Costs', inventory: 'Stock', daysInv: 'Days of Stock', stockLever: 'Reduce Stock Days' }
        };

        // =========================================================================
        // FINANCIAL CALCULATIONS
        // =========================================================================
        const calculatePL = (pl) => {
            const revenue = parseFloat(pl.revenue) || 0;
            const cogs = parseFloat(pl.cogs) || 0;
            const directLabor = parseFloat(pl.directLabor) || 0;
            const managementLabor = parseFloat(pl.managementLabor) || 0;
            const overheads = parseFloat(pl.overheads) || 0;
            const interest = parseFloat(pl.interest) || 0;
            const tax = parseFloat(pl.tax) || 0;
            const grossMargin = revenue - cogs;
            const grossMarginPct = revenue > 0 ? (grossMargin / revenue) * 100 : 0;
            const contributionMargin = grossMargin - directLabor;
            const contributionMarginPct = revenue > 0 ? (contributionMargin / revenue) * 100 : 0;
            const ebit = contributionMargin - managementLabor - overheads;
            const ebitPct = revenue > 0 ? (ebit / revenue) * 100 : 0;
            const netProfit = ebit - interest - tax;
            const directLER = directLabor > 0 ? grossMargin / directLabor : 0;
            const managementLER = managementLabor > 0 ? contributionMargin / managementLabor : 0;
            return { revenue, cogs, directLabor, managementLabor, overheads, interest, tax, grossMargin, grossMarginPct, contributionMargin, contributionMarginPct, ebit, ebitPct, netProfit, directLER, managementLER };
        };

        const calculateBS = (bs) => {
            const cash = parseFloat(bs.cash) || 0, ar = parseFloat(bs.ar) || 0, inventory = parseFloat(bs.inventory) || 0, otherCA = parseFloat(bs.otherCA) || 0, fixedAssets = parseFloat(bs.fixedAssets) || 0, otherAssets = parseFloat(bs.otherAssets) || 0;
            const ap = parseFloat(bs.ap) || 0, stDebt = parseFloat(bs.stDebt) || 0, otherCL = parseFloat(bs.otherCL) || 0, ltDebt = parseFloat(bs.ltDebt) || 0, otherLTL = parseFloat(bs.otherLTL) || 0, capital = parseFloat(bs.capital) || 0, retained = parseFloat(bs.retained) || 0;
            const totalCA = cash + ar + inventory + otherCA;
            const totalAssets = totalCA + fixedAssets + otherAssets;
            const totalCL = ap + stDebt + otherCL;
            const totalLiabilities = totalCL + ltDebt + otherLTL;
            const totalEquity = capital + retained;
            const totalLE = totalLiabilities + totalEquity;
            const balanceCheck = totalAssets - totalLE;
            return { cash, ar, inventory, otherCA, fixedAssets, otherAssets, ap, stDebt, otherCL, ltDebt, otherLTL, capital, retained, totalCA, totalAssets, totalCL, totalLiabilities, totalEquity, totalLE, balanceCheck };
        };

        const calculateWC = (wc) => {
            const daysAR = parseFloat(wc.daysAR) || 0, daysAP = parseFloat(wc.daysAP) || 0, daysInv = parseFloat(wc.daysInv) || 0;
            return { daysAR, daysAP, daysInv, ccc: daysAR + daysInv - daysAP };
        };

        const calculatePowerOfOne = (pl, wc, imp) => {
            if (pl.revenue <= 0) return [];
            const r = pl.revenue, cogs = pl.cogs, cm = pl.contributionMargin;
            return [
                { lever: 'Price Increase', val: imp.price, unit: '%', cash: r * (imp.price/100) * (365 - wc.daysAR) / 365, ebit: r * (imp.price/100) },
                { lever: 'Volume Increase', val: imp.volume, unit: '%', cash: cm * (imp.volume/100) - (r * (imp.volume/100) * wc.daysAR/365) - (cogs * (imp.volume/100) * wc.daysInv/365) + (cogs * (imp.volume/100) * wc.daysAP/365), ebit: cm * (imp.volume/100) },
                { lever: 'COGS Reduction', val: imp.cogs, unit: '%', cash: cogs * (imp.cogs/100) * (1 + (wc.daysInv - wc.daysAP)/365), ebit: cogs * (imp.cogs/100) },
                { lever: 'Direct Labor Efficiency', val: imp.directLabor, unit: '%', cash: pl.directLabor * (imp.directLabor/100), ebit: pl.directLabor * (imp.directLabor/100) },
                { lever: 'Management Labor Efficiency', val: imp.mgmtLabor, unit: '%', cash: pl.managementLabor * (imp.mgmtLabor/100), ebit: pl.managementLabor * (imp.mgmtLabor/100) },
                { lever: 'Overhead Reduction', val: imp.overheads, unit: '%', cash: pl.overheads * (imp.overheads/100), ebit: pl.overheads * (imp.overheads/100) },
                { lever: 'Reduce Debtor Days', val: imp.debtorDays, unit: 'd', cash: (r / 365) * imp.debtorDays, ebit: 0 },
                { lever: 'Reduce Stock Days', val: imp.stockDays, unit: 'd', cash: (cogs / 365) * imp.stockDays, ebit: 0 },
                { lever: 'Increase Creditor Days', val: imp.creditorDays, unit: 'd', cash: (cogs / 365) * imp.creditorDays, ebit: 0 }
            ];
        };

        const fmt = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'EUR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v || 0);
        const fmtPct = (v) => `${(v || 0).toFixed(1)}%`;

        // =========================================================================
        // SMALL COMPONENTS
        // =========================================================================
        function CheckIcon({ color = "#fff", size = 16 }) {
            return <svg width={size} height={size} viewBox="0 0 24 24" fill={color}><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>;
        }

        function LearnMore({ children }) {
            const [open, setOpen] = useState(false);
            return (
                <div style={{ marginBottom: open ? 0 : 12 }}>
                    <button className="learn-more-toggle" onClick={() => setOpen(!open)}>WHY THIS MATTERS {open ? '\u2212' : '+'}</button>
                    {open && <div className="learn-more-content">{children}</div>}
                </div>
            );
        }

        function ButtonFooter({ onBack, onNext, nextLabel = 'Next', canProceed, showBack = true }) {
            return (
                <div className="btn-footer no-print">
                    {showBack ? <button className="btn-back" onClick={onBack}>&larr; Back</button> : <div />}
                    <button className="btn-next" disabled={!canProceed} onClick={onNext}>{nextLabel} &rarr;</button>
                </div>
            );
        }

        function MobileStepBar({ currentStep }) {
            const progress = currentStep >= 999 ? 100 : Math.round((currentStep / 4) * 100);
            return (
                <div className="mobile-step-bar no-print">
                    <div className="bar-text">Step {Math.min(currentStep, 4)} of 4</div>
                    <div className="mobile-progress"><div className="mobile-progress-fill" style={{ width: `${progress}%` }} /></div>
                </div>
            );
        }

        function WizardSidebar({ currentStep, year1PL, year2PL, year2WC, powerOfOne, actionsCount, onNavigate }) {
            const steps = [
                { num: 1, label: 'Year 1 Data' },
                { num: 2, label: 'Year 2 Data' },
                { num: 3, label: 'Power of One' },
                { num: 4, label: 'Action Plan' }
            ];
            const y1 = calculatePL(year1PL);
            const y2 = calculatePL(year2PL);
            const wc2 = calculateWC(year2WC);
            const totalCash = powerOfOne.reduce((s, l) => s + l.cash, 0);
            const getSnippet = (n) => {
                if (n === 1 && y1.revenue > 0) return `Rev: ${fmt(y1.revenue)}, EBIT: ${fmtPct(y1.ebitPct)}`;
                if (n === 2 && y2.revenue > 0) return `Rev: ${fmt(y2.revenue)}, CCC: ${wc2.ccc.toFixed(0)}d`;
                if (n === 3 && totalCash > 0) return `Impact: ${fmt(totalCash)}`;
                if (n === 4 && actionsCount > 0) return `${actionsCount} action${actionsCount !== 1 ? 's' : ''} planned`;
                return null;
            };
            return (
                <div className="wizard-sidebar no-print">
                    <div className="wizard-sidebar-inner">
                        <div style={{ marginBottom: 24 }}>
                            <div className="monument" style={{ fontSize: 12, textTransform: 'uppercase', color: '#fff', marginBottom: 4 }}>CASH FLOW</div>
                            <div style={{ fontSize: 13, color: '#999' }}>~60 min</div>
                        </div>
                        <div style={{ marginBottom: 16, fontFamily: "'Monument', monospace", fontSize: 10, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#999' }}>Your analysis</div>
                        {steps.map(s => {
                            const isCompleted = currentStep > s.num, isActive = currentStep === s.num, isLocked = currentStep < s.num;
                            const snippet = isCompleted ? getSnippet(s.num) : null;
                            return (
                                <div key={s.num} className={`sidebar-step-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}`}
                                    onClick={() => isCompleted && onNavigate(s.num)} title={isCompleted ? 'Click to review' : ''}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                        {isCompleted ? <CheckIcon color="#000" size={14} /> : <span className="step-num" style={{ color: isActive ? '#fff' : '#ccc' }}>{String(s.num).padStart(2, '0')}</span>}
                                        <span className="step-name" style={{ color: isLocked ? '#666' : isCompleted ? '#000' : '#fff' }}>{s.label}</span>
                                    </div>
                                    {snippet && <div className="sidebar-snippet">{snippet}</div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        function NumField({ label, value, onChange, placeholder, help, required }) {
            return (
                <div className="field-group">
                    <label className="field-label">{label}{required && <span style={{ color: '#DC2626', fontWeight: 700 }}> *</span>}</label>
                    <input type="number" className="field-input" value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} />
                    {help && <p className="field-help">{help}</p>}
                </div>
            );
        }

        function MetricBadge({ value, good, avg }) {
            if (value >= good) return <span className="metric-badge badge-good">Healthy</span>;
            if (value >= avg) return <span className="metric-badge badge-avg">Average</span>;
            return <span className="metric-badge badge-weak">Needs focus</span>;
        }

        function PLMetrics({ calc }) {
            if (calc.revenue <= 0) return null;
            return (
                <div className="metrics-bar">
                    <div className="metric-item"><div className="metric-label">Gross Margin</div><div className="metric-value">{fmtPct(calc.grossMarginPct)} <MetricBadge value={calc.grossMarginPct} good={40} avg={20} /></div></div>
                    <div className="metric-item"><div className="metric-label">Contribution</div><div className="metric-value">{fmtPct(calc.contributionMarginPct)}</div></div>
                    <div className="metric-item"><div className="metric-label">EBIT</div><div className="metric-value">{fmtPct(calc.ebitPct)} <MetricBadge value={calc.ebitPct} good={15} avg={5} /></div></div>
                    <div className="metric-item"><div className="metric-label">Net Profit</div><div className="metric-value">{fmt(calc.netProfit)}</div></div>
                    {calc.directLER > 0 && <div className="metric-item"><div className="metric-label">Direct LER</div><div className="metric-value">{calc.directLER.toFixed(2)} <MetricBadge value={calc.directLER} good={3} avg={2} /></div></div>}
                    {calc.managementLER > 0 && <div className="metric-item"><div className="metric-label">Mgmt LER</div><div className="metric-value">{calc.managementLER.toFixed(2)}</div></div>}
                </div>
            );
        }

        function DependencyContext({ deps }) {
            if (!deps || deps.length === 0) return null;
            return (
                <div style={{ marginBottom: '24px' }}>
                    <div style={{ fontFamily: "'Monument', monospace", fontSize: '11px', textTransform: 'uppercase', letterSpacing: '0.05em', color: '#6B7280', marginBottom: '8px' }}>
                        CONTEXT FROM PREVIOUS TOOLS
                    </div>
                    {deps.map((dep, i) => (
                        <div key={i} style={{ background: '#FFF9E0', border: '1px solid #F0E68C', borderLeft: '3px solid #DAA520', padding: '12px 16px', marginBottom: '8px', fontSize: '14px' }}>
                            <div style={{ fontWeight: 600, marginBottom: '4px', color: '#333' }}>{dep.label}</div>
                            <div style={{ color: '#555', whiteSpace: 'pre-wrap' }}>{dep.value}</div>
                        </div>
                    ))}
                </div>
            );
        }

        // =========================================================================
        // MAIN COMPONENT
        // =========================================================================
        function CashFlowTool() {
            const [deps, setDeps] = useState([]);
            const [step, setStep] = useState(0);
            const [questionHelp, setQuestionHelp] = useState(null);
            const [authState, setAuthState] = useState({ loading: true, authenticated: false, user: null, progress: null, error: null });
            const [businessModel, setBusinessModel] = useState('');

            const emptyPL = { revenue: '', cogs: '', directLabor: '', managementLabor: '', overheads: '', interest: '', tax: '' };
            const emptyBS = { cash: '', ar: '', inventory: '', otherCA: '', fixedAssets: '', otherAssets: '', ap: '', stDebt: '', otherCL: '', ltDebt: '', otherLTL: '', capital: '', retained: '' };
            const emptyWC = { daysAR: '', daysAP: '', daysInv: '' };

            const [year1PL, setYear1PL] = useState({...emptyPL});
            const [year1BS, setYear1BS] = useState({...emptyBS});
            const [year1WC, setYear1WC] = useState({...emptyWC});
            const [year2PL, setYear2PL] = useState({...emptyPL});
            const [year2BS, setYear2BS] = useState({...emptyBS});
            const [year2WC, setYear2WC] = useState({...emptyWC});

            const [improvements, setImprovements] = useState({ price: 1, volume: 1, cogs: 1, directLabor: 1, mgmtLabor: 1, overheads: 1, debtorDays: 1, stockDays: 1, creditorDays: 1 });
            const [ideas, setIdeas] = useState([]);
            const [actions, setActions] = useState([{ what: '', who: '', when: '' }, { what: '', who: '', when: '' }, { what: '', who: '', when: '' }]);

            const [aiReviewing, setAiReviewing] = useState(false);
            const autosaveTimer = useRef(null);

            // Calculated values
            const y1PL = calculatePL(year1PL), y1BS = calculateBS(year1BS), y1WC = calculateWC(year1WC);
            const y2PL = calculatePL(year2PL), y2BS = calculateBS(year2BS), y2WC = calculateWC(year2WC);
            const powerOfOne = calculatePowerOfOne(y2PL, y2WC, improvements);
            const totalCash = powerOfOne.reduce((s, l) => s + l.cash, 0);
            const totalEbit = powerOfOne.reduce((s, l) => s + l.ebit, 0);
            const labels = LABELS[businessModel] || LABELS.manufacturing;

            useEffect(() => {
                async function loadDeps() {
                    const userId = localStorage.getItem('ft_user_id');
                    if (!userId || !window.ToolDB || !window.DependencyInjection) return;
                    try {
                        await ToolDB.whenReady();
                        const config = DependencyInjection.getDependenciesConfig();
                        const toolConfig = config[CONFIG.TOOL_SLUG];
                        if (!toolConfig || !toolConfig.fields) return;
                        const loaded = [];
                        for (const field of toolConfig.fields) {
                            const val = await ToolDB.getDependency(userId, field.source_field);
                            if (val) {
                                loaded.push({ label: field.display_label || field.source_field, value: window.DependencyInjection ? DependencyInjection.formatValue(val) : (typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val)) });
                            }
                        }
                        setDeps(loaded);
                    } catch (err) {
                        console.warn('[' + CONFIG.TOOL_SLUG + '] Failed to load dependencies:', err);
                    }
                }
                loadDeps();
            }, []);

            // Auth (handled by ToolDB.init -> identifyUser)
            useEffect(() => {
                setAuthState({ loading: false, authenticated: true, user: null, progress: { completed_tools: [], unlocked_tools: ['cash'] }, isUnlocked: true, isCompleted: false, error: null });
            }, []);

            // Autosave
            useEffect(() => {
                if (autosaveTimer.current) clearTimeout(autosaveTimer.current);
                autosaveTimer.current = setTimeout(() => {
                    localStorage.setItem('cashFlowData', JSON.stringify({ step, businessModel, year1PL, year1BS, year1WC, year2PL, year2BS, year2WC, improvements, ideas, actions, ts: new Date().toISOString() }));
                }, CONFIG.AUTOSAVE_DELAY);
                return () => { if (autosaveTimer.current) clearTimeout(autosaveTimer.current); };
            }, [step, businessModel, year1PL, year1BS, year1WC, year2PL, year2BS, year2WC, improvements, ideas, actions]);

            // Load saved
            useEffect(() => {
                const saved = localStorage.getItem('cashFlowData');
                if (saved) {
                    try {
                        const d = JSON.parse(saved);
                        if (d.year1PL) { setYear1PL(d.year1PL); setYear1BS(d.year1BS); setYear1WC(d.year1WC); setYear2PL(d.year2PL); setYear2BS(d.year2BS); setYear2WC(d.year2WC); }
                        if (d.businessModel) setBusinessModel(d.businessModel);
                        if (d.improvements) setImprovements(d.improvements);
                        if (d.ideas) setIdeas(d.ideas);
                        if (d.actions) setActions(d.actions);
                        if (d.step) setStep(d.step);
                    } catch (e) { localStorage.removeItem('cashFlowData'); }
                }
            }, []);

            const canStep1 = y1PL.revenue > 0 && y1PL.cogs > 0;
            const canStep2 = y2PL.revenue > 0 && y2PL.cogs > 0;
            const canStep3 = true;
            const topIdeas = [...ideas].sort((a, b) => ((b.impact * 2) + b.ease) - ((a.impact * 2) + a.ease));
            const canStep4 = actions.filter(a => a.what.trim() && a.who.trim() && a.when).length >= 1;

            const handleNext = async (fromStep) => {
                const userId = localStorage.getItem('ft_user_id');
                const nextStepNum = fromStep === 2 ? fromStep + 0.5 : (fromStep === 4 ? 999 : fromStep + 1);
                if (!userId) { setStep(nextStepNum); return; }
                setAiReviewing(true);
                try {
                    let stepAnswers = {};
                    let stepName = '';
                    if (fromStep === 1) {
                        stepName = 'Year 1 Data';
                        stepAnswers = {
                            story_report_y1: { revenue: year1PL.revenue, cogs: year1PL.cogs, directLabor: year1PL.directLabor, managementLabor: year1PL.managementLabor, overheads: year1PL.overheads, interest: year1PL.interest, tax: year1PL.tax },
                            year1_bs: year1BS,
                            year1_wc: year1WC
                        };
                    } else if (fromStep === 2) {
                        stepName = 'Year 2 Data';
                        stepAnswers = {
                            story_report_y2: { revenue: year2PL.revenue, cogs: year2PL.cogs, directLabor: year2PL.directLabor, managementLabor: year2PL.managementLabor, overheads: year2PL.overheads, interest: year2PL.interest, tax: year2PL.tax },
                            year2_bs: year2BS,
                            year2_wc: year2WC
                        };
                    } else if (fromStep === 3) {
                        stepName = 'Power of One';
                        stepAnswers = {
                            power_of_one: powerOfOne.map(l => ({ lever: l.lever, cashImpact: l.cash, ebitImpact: l.ebit }))
                        };
                    } else if (fromStep === 4) {
                        stepName = 'Action Plan';
                        stepAnswers = {
                            action_sheets: actions.filter(a => a.what.trim())
                        };
                    }
                    const canProceed = await window.AIChallenge.reviewStep(userId, CONFIG.TOOL_SLUG, stepAnswers, stepName);
                    if (canProceed) {
                        setStep(nextStepNum);
                    }
                } catch (err) {
                    console.warn('[AIChallenge] Error, allowing passage:', err);
                    setStep(nextStepNum);
                } finally {
                    setAiReviewing(false);
                }
            };

            return (
                <div className="tool-frame">
                    <div className="tool-inner">
                        {authState.loading && (
                            <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50 }}>
                                <div style={{ textAlign: 'center' }}><h1 className="plaak" style={{ fontSize: 48, marginBottom: 16 }}>AUTHENTICATING</h1><p style={{ fontSize: 18 }}>Please wait...</p></div>
                            </div>
                        )}

                        {!authState.loading && !authState.authenticated && (
                            <div style={{ position: 'fixed', inset: 0, background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 40 }}>
                                <div style={{ textAlign: 'center', padding: '0 32px', maxWidth: 640 }}>
                                    <h1 className="plaak" style={{ fontSize: 48, marginBottom: 24 }}>AUTHENTICATION REQUIRED</h1>
                                    <p style={{ fontSize: 20, marginBottom: 32 }}>Please access this tool from your LearnWorlds course.</p>
                                    <p style={{ fontSize: 16, color: '#999' }}>{authState.error || 'No active session found'}</p>
                                </div>
                            </div>
                        )}

                        {/* Cover */}
                        {step === 0 && authState.authenticated && (
                            <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)', display: 'flex', alignItems: 'center', justifyContent: 'center', position: 'relative', overflow: 'hidden' }}>
                                <div style={{ position: 'relative', textAlign: 'center', color: '#fff', padding: '0 32px' }} className="animate-in">
                                    <p className="monument" style={{ fontSize: 13, color: '#999', marginBottom: 16 }}>MODULE 2 — PERFORMANCE</p>
                                    <h1 className="plaak" style={{ fontSize: 72, marginBottom: 16 }}>CASH FLOW<br/>ANALYSIS</h1>
                                    <p style={{ fontSize: 18, color: '#ccc', marginBottom: 48, maxWidth: 500, margin: '0 auto 48px' }}>Master the 7 levers that create dramatic cash flow improvements using the Power of One</p>
                                    <button onClick={() => setStep(0.5)} style={{ background: '#fff', color: '#000', border: 'none', padding: '16px 48px', fontSize: 16, fontFamily: "'Monument', monospace", letterSpacing: '0.1em', textTransform: 'uppercase', cursor: 'pointer', transition: 'all 0.2s ease' }}
                                        onMouseOver={e => e.target.style.background = '#FFF469'}
                                        onMouseOut={e => e.target.style.background = '#fff'}>START</button>
                                </div>
                            </div>
                        )}

                        {/* Setup */}
                        {step === 0.5 && (
                            <div style={{ minHeight: '100vh', background: '#fff', display: 'flex', flexDirection: 'column' }}>
                                <div className="wizard-content animate-in">
                                    <p className="step-indicator">SETUP</p>
                                    <div className="opening-box">
                                        <h1 className="step-heading">Before We Start</h1>
                                        <p className="step-hint">Cash flow is the oxygen of your company. This tool shows how small 1% improvements across 7 levers create dramatic cash flow results.</p>
                                    </div>

                                    <div className="ft-insight">
                                        <div style={{ display: 'flex', gap: 12, alignItems: 'flex-start' }}>
                                            <div style={{ fontSize: 16, color: '#000', lineHeight: 1.5, fontWeight: 500 }}>
                                                <strong>You will need:</strong>
                                                <ul style={{ marginTop: 8, paddingLeft: 20 }}>
                                                    <li>Profit & Loss statement for the last 2 years</li>
                                                    <li>Balance Sheet for the last 2 years</li>
                                                    <li>Days in A/R, A/P, and Inventory metrics</li>
                                                </ul>
                                                <p style={{ marginTop: 8, color: '#333' }}>Your finance team can help gather this data. Strategic insights matter more than decimal precision.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="field-group">
                                        <label className="field-label" style={{ marginBottom: 12 }}>What is your business model?</label>
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: 10 }}>
                                            {[
                                                { val: 'manufacturing', title: 'Manufacturing / Production', desc: 'You make physical products (inventory, COGS, direct labor)' },
                                                { val: 'service', title: 'Service / Professional', desc: 'You sell expertise (WIP, cost of delivery, billable staff)' },
                                                { val: 'retail', title: 'Retail / Distribution', desc: 'You buy and resell products (stock, COGS, store staff)' }
                                            ].map(opt => (
                                                <label key={opt.val} style={{ display: 'block', padding: '14px 16px', border: businessModel === opt.val ? '2px solid #000' : '1px solid #E5E7EB', cursor: 'pointer', transition: 'all 0.15s ease', background: businessModel === opt.val ? '#FFF469' : '#fff' }}>
                                                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: 12 }}>
                                                        <input type="radio" name="bm" value={opt.val} checked={businessModel === opt.val} onChange={() => setBusinessModel(opt.val)} style={{ marginTop: 3, accentColor: '#000' }} />
                                                        <div><div style={{ fontWeight: 600, marginBottom: 2 }}>{opt.title}</div><div style={{ fontSize: 13, color: businessModel === opt.val ? '#333' : '#6B7280' }}>{opt.desc}</div></div>
                                                    </div>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="btn-footer no-print">
                                    <button className="btn-back" onClick={() => setStep(0)}>&larr; Back</button>
                                    <button className="btn-next" disabled={!businessModel} onClick={() => setStep(1)}>Let's Start &rarr;</button>
                                </div>
                            </div>
                        )}

                        {/* Steps 1-4 */}
                        {step >= 1 && step <= 4 && (
                            <div className="wizard-layout">
                                <div className="wizard-main">
                                    <MobileStepBar currentStep={step} />
                                    <div className="wizard-content animate-in">
                                        {step === 1 && <><DependencyContext deps={deps} /><Step1Content pl={year1PL} setPL={setYear1PL} bs={year1BS} setBS={setYear1BS} wc={year1WC} setWC={setYear1WC} calc={y1PL} bsCalc={y1BS} wcCalc={y1WC} labels={labels} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} canProceed={canStep1} /></>}
                                        {step === 2 && <Step2Content pl={year2PL} setPL={setYear2PL} bs={year2BS} setBS={setYear2BS} wc={year2WC} setWC={setYear2WC} calc={y2PL} bsCalc={y2BS} wcCalc={y2WC} y1WC={y1WC} labels={labels} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} canProceed={canStep2} />}
                                        {step === 3 && <Step3Content powerOfOne={powerOfOne} improvements={improvements} setImprovements={setImprovements} totalCash={totalCash} totalEbit={totalEbit} y2PL={y2PL} labels={labels} />}
                                        {step === 4 && <Step4Content ideas={ideas} setIdeas={setIdeas} actions={actions} setActions={setActions} powerOfOne={powerOfOne} />}
                                        {window.renderTransitionScreen && renderTransitionScreen(step, CONFIG, totalSteps, setStep)}
                                    </div>
                                    <ButtonFooter
                                        onBack={() => setStep(step === 1 ? 0.5 : step - 1)}
                                        onNext={() => handleNext(step)}
                                        canProceed={!aiReviewing && (step === 1 ? canStep1 : step === 2 ? canStep2 : step === 3 ? canStep3 : canStep4)}
                                        nextLabel={aiReviewing ? 'AI Coach Reviewing...' : step === 4 ? 'View Your Canvas' : 'Next'}
                                    />
                                </div>
                                <WizardSidebar currentStep={step} year1PL={year1PL} year2PL={year2PL} year2WC={year2WC} powerOfOne={powerOfOne} actionsCount={actions.filter(a => a.what.trim()).length} onNavigate={setStep} />
                            </div>
                        )}

                        {/* Canvas */}
                        {step === 999 && <CanvasView y1PL={y1PL} y2PL={y2PL} y1WC={y1WC} y2WC={y2WC} powerOfOne={powerOfOne} totalCash={totalCash} totalEbit={totalEbit} actions={actions} onBack={() => setStep(4)} />}
                    </div>
                </div>
            );
        }

        // =========================================================================
        // STEP 1: YEAR 1 DATA
        // =========================================================================
        function FinancialDataStep({ yearLabel, pl, setPL, bs, setBS, wc, setWC, calc, bsCalc, wcCalc, labels, questionHelp, setQuestionHelp, prevWC }) {
            const [openSection, setOpenSection] = useState('pl');
            const upPL = (k, v) => setPL(prev => ({ ...prev, [k]: v }));
            const upBS = (k, v) => setBS(prev => ({ ...prev, [k]: v }));
            const upWC = (k, v) => setWC(prev => ({ ...prev, [k]: v }));

            const toggleSection = (section) => {
                setOpenSection(openSection === section ? null : section);
            };

            const accordionHeaderStyle = {
                width: '100%',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                background: '#f9f9f9',
                border: '1px solid #e0e0e0',
                borderLeft: '3px solid #000',
                padding: '12px 16px',
                cursor: 'pointer',
                fontFamily: "'Monument', monospace",
                fontSize: 11,
                textTransform: 'uppercase',
                letterSpacing: '0.06em',
                marginBottom: 0,
                marginTop: 16
            };

            const accordionBodyStyle = {
                border: '1px solid #e0e0e0',
                borderTop: 'none',
                padding: '16px',
                marginBottom: 16
            };

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 0, marginBottom: 32 }}>
                    {/* P&L Accordion */}
                    <button
                        onClick={() => toggleSection('pl')}
                        style={{
                            ...accordionHeaderStyle,
                            marginTop: 0
                        }}
                    >
                        <span>PROFIT & LOSS — {yearLabel}</span>
                        <span style={{ fontSize: 16 }}>{openSection === 'pl' ? '−' : '+'}</span>
                    </button>
                    {openSection === 'pl' && (
                        <div style={accordionBodyStyle}>
                            <div className="two-col">
                                <NumField label="Revenue" value={pl.revenue} onChange={v => upPL('revenue', v)} placeholder="35000000" required />
                                <NumField label={labels.cogs} value={pl.cogs} onChange={v => upPL('cogs', v)} placeholder="24500000" required />
                                <NumField label={labels.directLabor} value={pl.directLabor} onChange={v => upPL('directLabor', v)} placeholder="3000000" />
                                <NumField label="Management Labor" value={pl.managementLabor} onChange={v => upPL('managementLabor', v)} placeholder="2000000" />
                                <NumField label="Overheads" value={pl.overheads} onChange={v => upPL('overheads', v)} placeholder="1750000" />
                                <NumField label="Interest Expense" value={pl.interest} onChange={v => upPL('interest', v)} placeholder="1165000" />
                                <NumField label="Tax Expense" value={pl.tax} onChange={v => upPL('tax', v)} placeholder="930000" />
                            </div>
                            <PLMetrics calc={calc} />
                        </div>
                    )}

                    {/* Balance Sheet Accordion */}
                    <button
                        onClick={() => toggleSection('bs')}
                        style={accordionHeaderStyle}
                    >
                        <span>BALANCE SHEET — {yearLabel}</span>
                        <span style={{ fontSize: 16 }}>{openSection === 'bs' ? '−' : '+'}</span>
                    </button>
                    {openSection === 'bs' && (
                        <div style={accordionBodyStyle}>
                            <div className="two-col">
                                <div>
                                    <p className="monument" style={{ fontSize: 10, color: '#999', marginBottom: 12 }}>ASSETS</p>
                                    <NumField label="Cash" value={bs.cash} onChange={v => upBS('cash', v)} placeholder="0" />
                                    <NumField label="Accounts Receivable" value={bs.ar} onChange={v => upBS('ar', v)} placeholder="6712000" required />
                                    <NumField label={labels.inventory} value={bs.inventory} onChange={v => upBS('inventory', v)} placeholder="10337000" />
                                    <NumField label="Other Current Assets" value={bs.otherCA} onChange={v => upBS('otherCA', v)} placeholder="0" />
                                    <NumField label="Fixed Assets (Net)" value={bs.fixedAssets} onChange={v => upBS('fixedAssets', v)} placeholder="8500000" />
                                    <NumField label="Other Assets" value={bs.otherAssets} onChange={v => upBS('otherAssets', v)} placeholder="0" />
                                </div>
                                <div>
                                    <p className="monument" style={{ fontSize: 10, color: '#999', marginBottom: 12 }}>LIABILITIES & EQUITY</p>
                                    <NumField label="Accounts Payable" value={bs.ap} onChange={v => upBS('ap', v)} placeholder="4029000" required />
                                    <NumField label="Short-term Debt" value={bs.stDebt} onChange={v => upBS('stDebt', v)} placeholder="5020000" />
                                    <NumField label="Other Current Liabilities" value={bs.otherCL} onChange={v => upBS('otherCL', v)} placeholder="0" />
                                    <NumField label="Long-term Debt" value={bs.ltDebt} onChange={v => upBS('ltDebt', v)} placeholder="9000000" />
                                    <NumField label="Other LT Liabilities" value={bs.otherLTL} onChange={v => upBS('otherLTL', v)} placeholder="0" />
                                    <NumField label="Capital" value={bs.capital} onChange={v => upBS('capital', v)} placeholder="2001000" />
                                    <NumField label="Retained Earnings" value={bs.retained} onChange={v => upBS('retained', v)} placeholder="5500000" />
                                </div>
                            </div>
                            {bsCalc.totalAssets > 0 && (
                                Math.abs(bsCalc.balanceCheck) < 1 ?
                                    <div className="balance-ok">Balance sheet balances. Assets: {fmt(bsCalc.totalAssets)} = Liabilities + Equity: {fmt(bsCalc.totalLE)}</div> :
                                    <div className="balance-err">Does not balance. Difference: {fmt(bsCalc.balanceCheck)} — Assets ({fmt(bsCalc.totalAssets)}) must equal L+E ({fmt(bsCalc.totalLE)})</div>
                            )}
                        </div>
                    )}

                    {/* Working Capital Accordion */}
                    <button
                        onClick={() => toggleSection('wc')}
                        style={accordionHeaderStyle}
                    >
                        <span>WORKING CAPITAL — {yearLabel}</span>
                        <span style={{ fontSize: 16 }}>{openSection === 'wc' ? '−' : '+'}</span>
                    </button>
                    {openSection === 'wc' && (
                        <div style={accordionBodyStyle}>
                            <div className="two-col" style={{ gridTemplateColumns: '1fr 1fr 1fr' }}>
                                <NumField label="Days in A/R" value={wc.daysAR} onChange={v => upWC('daysAR', v)} placeholder="70" help="Days to collect from customers" />
                                <NumField label="Days in A/P" value={wc.daysAP} onChange={v => upWC('daysAP', v)} placeholder="60" help="Days to pay suppliers" />
                                <NumField label={labels.daysInv} value={wc.daysInv} onChange={v => upWC('daysInv', v)} placeholder="154" help="Days of stock on hand" />
                            </div>
                            {wcCalc.daysAR > 0 && (
                                <div className="metrics-bar" style={{ gridTemplateColumns: '1fr' }}>
                                    <div className="metric-item">
                                        <div className="metric-label">Cash Conversion Cycle</div>
                                        <div className="metric-value" style={{ fontSize: 22 }}>{wcCalc.ccc.toFixed(0)} days <MetricBadge value={-wcCalc.ccc} good={-30} avg={-60} /></div>
                                        {prevWC && calculateWC(prevWC).daysAR > 0 && (
                                            <div style={{ fontSize: 12, color: '#6B7280', marginTop: 4 }}>
                                                Change from Year 1: {(wcCalc.ccc - calculateWC(prevWC).ccc > 0 ? '+' : '')}{(wcCalc.ccc - calculateWC(prevWC).ccc).toFixed(0)} days
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function Step1Content({ pl, setPL, bs, setBS, wc, setWC, calc, bsCalc, wcCalc, labels, questionHelp, setQuestionHelp, canProceed }) {
            return (
                <>
                    <p className="step-indicator">STEP 1 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Year 1 Financial Data</h1>
                        <p className="step-hint">Enter your baseline financial data from your previous fiscal year. This is the foundation for your analysis.</p>
                    </div>
                    <LearnMore>
                        Revenue is vanity, profit is sanity, but <strong>cash is king</strong>. Understanding your financial position across all three statements — P&L, Balance Sheet, and Working Capital — gives you the complete picture of your company's health. As Alan Miltz says: "Cash flow is the oxygen of a company."
                    </LearnMore>
                    <FinancialDataStep yearLabel="YEAR 1" pl={pl} setPL={setPL} bs={bs} setBS={setBS} wc={wc} setWC={setWC} calc={calc} bsCalc={bsCalc} wcCalc={wcCalc} labels={labels} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} />
                    {canProceed && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">YEAR 1 CAPTURED</p>
                            <p>Baseline established. Next: enter your most recent year for comparison.</p>
                        </div>
                    )}
                </>
            );
        }

        function Step2Content({ pl, setPL, bs, setBS, wc, setWC, calc, bsCalc, wcCalc, y1WC, labels, questionHelp, setQuestionHelp, canProceed }) {
            return (
                <>
                    <p className="step-indicator">STEP 2 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Year 2 Financial Data</h1>
                        <p className="step-hint">Enter your most recent fiscal year data. The year-over-year comparison reveals your trajectory.</p>
                    </div>
                    <LearnMore>
                        Comparing two data points creates a narrative. Are costs growing faster than revenue? Is working capital improving or deteriorating? The trend tells you where to focus your Power of One improvements.
                    </LearnMore>
                    <FinancialDataStep yearLabel="YEAR 2" pl={pl} setPL={setPL} bs={bs} setBS={setBS} wc={wc} setWC={setWC} calc={calc} bsCalc={bsCalc} wcCalc={wcCalc} labels={labels} questionHelp={questionHelp} setQuestionHelp={setQuestionHelp} prevWC={y1WC} />
                    {canProceed && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">COMPARISON READY</p>
                            <p>Both years captured. Next: discover the power of small improvements.</p>
                        </div>
                    )}
                </>
            );
        }

        // =========================================================================
        // STEP 3: POWER OF ONE SIMULATOR
        // =========================================================================
        function Step3Content({ powerOfOne, improvements, setImprovements, totalCash, totalEbit, y2PL, labels }) {
            const updateImp = (key, val) => setImprovements(prev => ({ ...prev, [key]: parseFloat(val) || 0 }));
            const leverKeys = ['price', 'volume', 'cogs', 'directLabor', 'mgmtLabor', 'overheads', 'debtorDays', 'stockDays', 'creditorDays'];
            const leverNames = ['Price Increase', 'Volume Increase', `${labels.cogs} Reduction`, `${labels.directLabor} Efficiency`, 'Management Labor Efficiency', 'Overhead Reduction', 'Reduce Debtor Days', labels.stockLever, 'Increase Creditor Days'];
            const isPercent = [true, true, true, true, true, true, false, false, false];
            const maxVals = [10, 10, 10, 10, 10, 10, 30, 30, 30];

            return (
                <>
                    <p className="step-indicator">STEP 3 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Power of One Simulator</h1>
                        <p className="step-hint">Drag the sliders to see how small improvements across 7 levers transform your cash flow. Start with 1% — that's the Power of One.</p>
                    </div>
                    <LearnMore>
                        The Power of One framework (Alan Miltz, "Scaling Up") breaks complex cash improvement into 7 manageable levers. Companies that systematically address these levers improve cash conversion cycles by 30-50% within 12-18 months. You don't need massive changes — small 1% improvements compound into dramatic results.
                    </LearnMore>

                    {y2PL.revenue > 0 && (
                        <div className="impact-total-bar">
                            <div className="impact-total-item">
                                <div className="impact-label">Cash Flow Impact</div>
                                <div className="impact-number" style={{ color: '#4ade80' }}>{fmt(totalCash)}</div>
                            </div>
                            <div className="impact-total-item">
                                <div className="impact-label">EBIT Impact</div>
                                <div className="impact-number" style={{ color: '#60a5fa' }}>{fmt(totalEbit)}</div>
                            </div>
                            <div className="impact-total-item">
                                <div className="impact-label">New EBIT</div>
                                <div className="impact-number">{fmt(y2PL.ebit + totalEbit)}</div>
                            </div>
                        </div>
                    )}

                    {y2PL.revenue <= 0 && (
                        <div className="ft-insight">
                            <div style={{ fontSize: 16, color: '#000', lineHeight: 1.5, fontWeight: 500 }}>
                                Complete Year 2 data first to use the simulator. Go back to Step 2.
                            </div>
                        </div>
                    )}

                    {/* Profitability Levers */}
                    <p className="section-label" style={{ marginTop: 8 }}>PROFITABILITY LEVERS (1-6)</p>
                    {leverKeys.slice(0, 6).map((key, i) => (
                        <div key={key} className="lever-slider-row">
                            <div className="lever-header">
                                <span className="lever-name">{leverNames[i]}</span>
                                <div className="lever-impacts">
                                    <span className="lever-cash">Cash: {fmt(powerOfOne[i]?.cash || 0)}</span>
                                    <span className="lever-ebit">EBIT: {fmt(powerOfOne[i]?.ebit || 0)}</span>
                                </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                <input type="range" min="0" max={maxVals[i]} step="0.5" value={improvements[key]} onChange={e => updateImp(key, e.target.value)} />
                                <span className="slider-value">{improvements[key]}%</span>
                            </div>
                        </div>
                    ))}

                    {/* Working Capital Levers */}
                    <div className="section-divider">
                        <p className="section-label">WORKING CAPITAL LEVERS (7A-7C)</p>
                    </div>
                    {leverKeys.slice(6).map((key, i) => {
                        const idx = i + 6;
                        return (
                            <div key={key} className="lever-slider-row">
                                <div className="lever-header">
                                    <span className="lever-name">{leverNames[idx]}</span>
                                    <div className="lever-impacts">
                                        <span className="lever-cash">Cash: {fmt(powerOfOne[idx]?.cash || 0)}</span>
                                    </div>
                                </div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                                    <input type="range" min="0" max={maxVals[idx]} step="1" value={improvements[key]} onChange={e => updateImp(key, e.target.value)} />
                                    <span className="slider-value">{improvements[key]} days</span>
                                </div>
                            </div>
                        );
                    })}

                    {totalCash > 0 && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">IMPACT MODELED</p>
                            <p>You've identified {fmt(totalCash)} in potential cash flow improvement. Next: turn this into action.</p>
                        </div>
                    )}
                </>
            );
        }

        // =========================================================================
        // STEP 4: ACTION PLAN
        // =========================================================================
        function Step4Content({ ideas, setIdeas, actions, setActions, powerOfOne }) {
            const idCounter = useRef(Date.now());
            const addIdea = () => { idCounter.current++; setIdeas(prev => [...prev, { id: idCounter.current, text: '', impact: 2, ease: 2 }]); };
            const updateIdea = (id, field, val) => setIdeas(prev => prev.map(idea => idea.id === id ? { ...idea, [field]: val } : idea));
            const removeIdea = (id) => setIdeas(prev => prev.filter(idea => idea.id !== id));
            const updateAction = (i, field, val) => setActions(prev => prev.map((a, idx) => idx === i ? { ...a, [field]: val } : a));

            // Compute rank for each idea (1 = best) without reordering the list
            const scores = ideas.map(idea => ({ id: idea.id, score: (idea.impact * 2) + idea.ease }));
            const ranked = [...scores].sort((a, b) => b.score - a.score);
            const rankMap = {};
            ranked.forEach((item, i) => { rankMap[item.id] = i + 1; });

            return (
                <>
                    <p className="step-indicator">STEP 4 OF 4</p>
                    <div className="opening-box">
                        <h1 className="step-heading">Action Plan</h1>
                        <p className="step-hint">Brainstorm improvement ideas, score them, then commit to your Top 3 with clear Who, What, When. Strategy is sacrifice — pick 3 or do nothing.</p>
                    </div>
                    <LearnMore>
                        The Impact/Ease matrix comes from Lean Six Sigma. Score each idea on Impact (1-3) and Ease (1-3). Score = (Impact x 2) + Ease. This surfaces quick wins — high-impact, easy-to-execute actions. Focus on 2-3 levers maximum per quarter to avoid diluting effort.
                    </LearnMore>

                    {/* Idea Brainstorm */}
                    <p className="section-label">BRAINSTORM IDEAS</p>
                    <div style={{ background: '#F3F4F6', padding: 16, marginBottom: 16, fontSize: 13, color: '#374151' }}>
                        <strong>Scoring:</strong> Impact (1=Small, 2=Medium, 3=Large) x 2 + Ease (1=Hard, 2=Medium, 3=Easy). Range: 3-9. Higher = better priority.
                    </div>

                    {ideas.map((idea) => {
                        const score = (idea.impact * 2) + idea.ease;
                        const rank = rankMap[idea.id] || '-';
                        return (
                            <div key={idea.id} className="idea-row">
                                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', minWidth: 40 }}>
                                    <span className="score-badge" style={{ fontSize: 14, fontWeight: 700 }}>{score}</span>
                                    <span style={{ fontSize: 10, color: '#999', fontFamily: "'Monument', monospace" }}>#{rank}</span>
                                </div>
                                <input type="text" className="field-input" style={{ flex: 1 }} value={idea.text} onChange={e => updateIdea(idea.id, 'text', e.target.value)} placeholder="e.g. Reduce A/R days by invoicing within 24 hours" />
                                <select className="field-input" style={{ width: 100 }} value={idea.impact} onChange={e => updateIdea(idea.id, 'impact', parseInt(e.target.value))}>
                                    <option value={3}>Impact: 3</option><option value={2}>Impact: 2</option><option value={1}>Impact: 1</option>
                                </select>
                                <select className="field-input" style={{ width: 90 }} value={idea.ease} onChange={e => updateIdea(idea.id, 'ease', parseInt(e.target.value))}>
                                    <option value={3}>Ease: 3</option><option value={2}>Ease: 2</option><option value={1}>Ease: 1</option>
                                </select>
                                <button onClick={() => removeIdea(idea.id)} style={{ background: 'none', border: 'none', fontSize: 18, cursor: 'pointer', color: '#999' }}>&times;</button>
                            </div>
                        );
                    })}

                    <button onClick={addIdea} style={{ width: '100%', padding: '12px 0', border: '2px dashed #E5E7EB', background: 'none', fontSize: 14, cursor: 'pointer', color: '#6B7280', margin: '16px 0 32px' }}>
                        + Add Idea
                    </button>

                    {/* Top 3 WWW */}
                    <div className="section-divider">
                        <p className="section-label">YOUR TOP 3 COMMITMENTS (WHO, WHAT, WHEN)</p>
                    </div>
                    <p style={{ fontSize: 14, color: '#6B7280', marginBottom: 20 }}>Based on your scoring above, commit to exactly 3 actions with clear ownership and deadlines.</p>

                    {actions.map((action, i) => (
                        <div key={i} style={{ borderLeft: '3px solid #000', paddingLeft: 16, marginBottom: 24 }}>
                            <p className="monument" style={{ fontSize: 10, textTransform: 'uppercase', color: '#6B7280', marginBottom: 10 }}>ACTION {i + 1}</p>
                            <div className="field-group">
                                <label className="field-label">What (specific action)</label>
                                <textarea className="field-textarea" style={{ minHeight: 60 }} value={action.what} onChange={e => updateAction(i, 'what', e.target.value)} placeholder={i === 0 ? "e.g. Reduce debtor days from 70 to 55 by implementing 24hr invoicing" : i === 1 ? "e.g. Negotiate 5% COGS reduction with top 3 suppliers" : "e.g. Increase prices by 2% on premium product lines"} />
                            </div>
                            <div className="two-col">
                                <div className="field-group">
                                    <label className="field-label">Who (owner)</label>
                                    <input type="text" className="field-input" value={action.who} onChange={e => updateAction(i, 'who', e.target.value)} placeholder="Sarah Johnson (CFO)" />
                                </div>
                                <div className="field-group">
                                    <label className="field-label">When (deadline)</label>
                                    <input type="date" className="field-input" value={action.when} onChange={e => updateAction(i, 'when', e.target.value)} />
                                </div>
                            </div>
                        </div>
                    ))}

                    {actions.filter(a => a.what.trim() && a.who.trim() && a.when).length >= 1 && (
                        <div className="closing-box animate-in">
                            <p className="closing-title">PLAN LOCKED</p>
                            <p>Accountability is set. Review your canvas and submit.</p>
                        </div>
                    )}
                </>
            );
        }

        // =========================================================================
        // CANVAS VIEW (WOOP-style grid layout)
        // =========================================================================
        function CanvasView({ y1PL, y2PL, y1WC, y2WC, powerOfOne, totalCash, totalEbit, actions, onBack }) {
            const [submitStatus, setSubmitStatus] = useState(null);
            const [submitMessage, setSubmitMessage] = useState('');

            const handleSubmit = async () => {
                const userId = localStorage.getItem('ft_user_id');
                if (!userId) { setSubmitStatus('error'); setSubmitMessage('User not authenticated.'); return; }
                const questionMappings = {
                    story_report: { year1PL: { revenue: y1PL.revenue, cogs: y1PL.cogs, grossMargin: y1PL.grossMargin, ebit: y1PL.ebit, ebitPct: y1PL.ebitPct, netProfit: y1PL.netProfit, directLER: y1PL.directLER, managementLER: y1PL.managementLER }, year2PL: { revenue: y2PL.revenue, cogs: y2PL.cogs, grossMargin: y2PL.grossMargin, ebit: y2PL.ebit, ebitPct: y2PL.ebitPct, netProfit: y2PL.netProfit, directLER: y2PL.directLER, managementLER: y2PL.managementLER } },
                    power_of_one: powerOfOne.map(l => ({ lever: l.lever, cashImpact: l.cash, ebitImpact: l.ebit })),
                    action_sheets: actions.filter(a => a.what.trim()),
                    top_priority: 'Cash impact: ' + totalCash + ', EBIT impact: ' + totalEbit,
                    ler_ratio: { year1WC: y1WC, year2WC: y2WC }
                };
                await window.AIChallenge.submitWithChallenge(userId, CONFIG.TOOL_SLUG, questionMappings, {
                    onReviewStart: () => { setSubmitStatus('saving'); setSubmitMessage('AI coach is reviewing...'); },
                    onRevise: () => { setSubmitStatus(null); setSubmitMessage(''); onBack(); },
                    onSubmitAnyway: () => { setSubmitStatus('success'); setSubmitMessage('Saved successfully!'); },
                    onError: (err) => { setSubmitStatus('error'); setSubmitMessage('Failed: ' + err.message); }
                });
            };

            const handleExport = async (e) => {
                try {
                    const btn = e.target; btn.disabled = true; btn.textContent = 'Generating...';
                    if (!window.jspdf || !window.html2canvas) { alert('PDF libraries loading...'); btn.disabled = false; btn.textContent = 'Export PDF'; return; }
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                    const el = document.getElementById('cash-canvas');
                    const canvas = await html2canvas(el, { scale: 2, backgroundColor: '#fff', useCORS: false, logging: false });
                    const imgData = canvas.toDataURL('image/png');
                    const pw = 210, m = 10, mw = pw - m * 2;
                    const ar = canvas.width / canvas.height;
                    let iw = mw, ih = iw / ar;
                    if (ih > 277) { ih = 277; iw = ih * ar; }
                    pdf.addImage(imgData, 'PNG', (pw - iw) / 2, m, iw, ih);
                    pdf.save(`Cash-Flow-Analysis-${new Date().toISOString().split('T')[0]}.pdf`);
                    btn.disabled = false; btn.textContent = 'Export PDF';
                } catch (error) { alert('PDF failed: ' + error.message); if (e?.target) { e.target.disabled = false; e.target.textContent = 'Export PDF'; } }
            };

            const sorted = [...powerOfOne].sort((a, b) => b.cash - a.cash);

            /* Shared cell style helpers (matching WOOP) */
            const tag = (color = '#000') => ({ fontFamily: "'Monument', monospace", fontSize: 9, textTransform: 'uppercase', letterSpacing: '0.08em', color, marginBottom: 4 });

            return (
                <div style={{ minHeight: '100vh', background: '#F3F4F6' }}>
                    {/* Black hero header (WOOP-style) */}
                    <div className="no-print" style={{ background: '#000', padding: '32px 24px 24px' }}>
                        <div style={{ maxWidth: 960, margin: '0 auto', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-end' }}>
                            <div>
                                <p style={{ ...tag('#666'), marginBottom: 8 }}>YOUR CASH FLOW CANVAS</p>
                                <h1 className="plaak" style={{ fontSize: 36, color: '#fff', textTransform: 'uppercase', lineHeight: 1 }}>POWER OF ONE</h1>
                                <p style={{ fontSize: 13, color: '#FFF469', marginTop: 8, fontFamily: "'Monument', monospace", letterSpacing: '0.05em' }}>Cash Impact: {fmt(totalCash)} | EBIT Impact: {fmt(totalEbit)}</p>
                            </div>
                            <button onClick={onBack} style={{ background: 'transparent', border: '1px solid #666', color: '#fff', padding: '8px 16px', cursor: 'pointer', fontFamily: "'Monument', monospace", fontSize: 11, textTransform: 'uppercase', letterSpacing: '0.05em', flexShrink: 0 }}>&larr; Edit</button>
                        </div>
                    </div>

                    <div style={{ maxWidth: 960, margin: '0 auto', padding: '24px 24px 40px' }}>
                        <div id="cash-canvas" style={{ background: '#fff', border: '2px solid #000' }}>

                            {/* === ROW 1: Executive Summary (yellow hero) === */}
                            <div style={{ background: '#FFF469', padding: 20, borderBottom: '2px solid #000' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                    <span style={{ background: '#000', color: '#FFF469', padding: '3px 8px', fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.08em' }}>CF</span>
                                    <span style={{ ...tag(), marginBottom: 0 }}>EXECUTIVE SUMMARY</span>
                                </div>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 16 }}>
                                    <div>
                                        <p style={{ ...tag('#666') }}>CASH FLOW IMPACT</p>
                                        <p style={{ fontSize: 24, fontWeight: 700, fontFamily: "'Plaak', sans-serif" }}>{fmt(totalCash)}</p>
                                    </div>
                                    <div>
                                        <p style={{ ...tag('#666') }}>EBIT IMPACT</p>
                                        <p style={{ fontSize: 24, fontWeight: 700, fontFamily: "'Plaak', sans-serif" }}>{fmt(totalEbit)}</p>
                                    </div>
                                    <div>
                                        <p style={{ ...tag('#666') }}>CASH CONVERSION CYCLE</p>
                                        <p style={{ fontSize: 24, fontWeight: 700, fontFamily: "'Plaak', sans-serif" }}>{y2WC.ccc.toFixed(0)} days</p>
                                    </div>
                                </div>
                            </div>

                            {/* === ROW 2: Year-over-Year + Working Capital side by side === */}
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', borderBottom: '2px solid #000' }}>
                                {/* Year-over-Year */}
                                <div style={{ padding: 20, borderRight: '2px solid #000' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                        <span style={{ background: '#000', color: '#fff', padding: '3px 8px', fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.08em' }}>01</span>
                                        <span style={{ ...tag(), marginBottom: 0 }}>YEAR-OVER-YEAR</span>
                                    </div>
                                    {[
                                        ['Revenue', fmt(y1PL.revenue), fmt(y2PL.revenue), y2PL.revenue - y1PL.revenue],
                                        ['Gross Margin', fmtPct(y1PL.grossMarginPct), fmtPct(y2PL.grossMarginPct), y2PL.grossMarginPct - y1PL.grossMarginPct],
                                        ['EBIT', fmtPct(y1PL.ebitPct), fmtPct(y2PL.ebitPct), y2PL.ebitPct - y1PL.ebitPct],
                                        ['Net Profit', fmt(y1PL.netProfit), fmt(y2PL.netProfit), y2PL.netProfit - y1PL.netProfit]
                                    ].map(([label, v1, v2, d]) => (
                                        <div key={label} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 0', borderBottom: '1px solid #F3F4F6', fontSize: 13 }}>
                                            <span style={{ fontWeight: 600, flex: 1 }}>{label}</span>
                                            <span style={{ color: '#6B7280', width: 80, textAlign: 'right' }}>{v1}</span>
                                            <span style={{ width: 80, textAlign: 'right' }}>{v2}</span>
                                            <span style={{ width: 70, textAlign: 'right', color: d >= 0 ? '#059669' : '#DC2626', fontWeight: 600 }}>{d >= 0 ? '+' : ''}{typeof d === 'number' ? (label.includes('Revenue') || label.includes('Profit') ? fmt(d) : fmtPct(d)) : d}</span>
                                        </div>
                                    ))}
                                </div>

                                {/* Working Capital */}
                                <div style={{ padding: 20 }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                        <span style={{ background: '#000', color: '#fff', padding: '3px 8px', fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.08em' }}>02</span>
                                        <span style={{ ...tag(), marginBottom: 0 }}>WORKING CAPITAL</span>
                                    </div>
                                    {[
                                        ['Days A/R', y1WC.daysAR.toFixed(0), y2WC.daysAR.toFixed(0), y2WC.daysAR - y1WC.daysAR],
                                        ['Days A/P', y1WC.daysAP.toFixed(0), y2WC.daysAP.toFixed(0), y2WC.daysAP - y1WC.daysAP],
                                        ['Days Inventory', y1WC.daysInv.toFixed(0), y2WC.daysInv.toFixed(0), y2WC.daysInv - y1WC.daysInv],
                                        ['CCC', y1WC.ccc.toFixed(0), y2WC.ccc.toFixed(0), y2WC.ccc - y1WC.ccc]
                                    ].map(([label, v1, v2, d]) => (
                                        <div key={label} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 0', borderBottom: '1px solid #F3F4F6', fontSize: 13 }}>
                                            <span style={{ fontWeight: 600, flex: 1 }}>{label}</span>
                                            <span style={{ color: '#6B7280', width: 60, textAlign: 'right' }}>{v1}d</span>
                                            <span style={{ width: 60, textAlign: 'right' }}>{v2}d</span>
                                            <span style={{ width: 60, textAlign: 'right', color: (label === 'Days A/P' ? (d >= 0 ? '#059669' : '#DC2626') : (d <= 0 ? '#059669' : '#DC2626')), fontWeight: 600 }}>{d >= 0 ? '+' : ''}{d.toFixed(0)}d</span>
                                        </div>
                                    ))}
                                    {/* LER badges */}
                                    <div style={{ display: 'flex', gap: 12, marginTop: 12 }}>
                                        {y2PL.directLER > 0 && (
                                            <div style={{ background: '#F3F4F6', padding: '8px 12px', flex: 1 }}>
                                                <p style={{ ...tag('#6B7280') }}>DIRECT LER</p>
                                                <p style={{ fontSize: 15, fontWeight: 700 }}>{y2PL.directLER.toFixed(2)}</p>
                                            </div>
                                        )}
                                        {y2PL.managementLER > 0 && (
                                            <div style={{ background: '#F3F4F6', padding: '8px 12px', flex: 1 }}>
                                                <p style={{ ...tag('#6B7280') }}>MGMT LER</p>
                                                <p style={{ fontSize: 15, fontWeight: 700 }}>{y2PL.managementLER.toFixed(2)}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* === ROW 3: Power of One Ranked === */}
                            <div style={{ padding: 20, borderBottom: '2px solid #000' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                    <span style={{ background: '#000', color: '#fff', padding: '3px 8px', fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.08em' }}>03</span>
                                    <span style={{ ...tag(), marginBottom: 0 }}>POWER OF ONE — RANKED BY CASH IMPACT</span>
                                </div>
                                {sorted.filter(l => l.cash > 0).map((lever, i) => (
                                    <div key={i} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: i < sorted.filter(l => l.cash > 0).length - 1 ? '1px solid #F3F4F6' : 'none' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                            <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, color: '#6B7280', minWidth: 20 }}>#{i + 1}</span>
                                            <span style={{ fontWeight: 600, fontSize: 13 }}>{lever.lever}</span>
                                            <span style={{ background: '#F3F4F6', padding: '2px 6px', fontFamily: "'Monument', monospace", fontSize: 10, color: '#6B7280' }}>{lever.val}{lever.unit === '%' ? '%' : 'd'}</span>
                                        </div>
                                        <div style={{ display: 'flex', gap: 16 }}>
                                            <span style={{ background: '#d1fae5', color: '#065f46', padding: '2px 8px', fontWeight: 600, fontSize: 13 }}>{fmt(lever.cash)}</span>
                                            {lever.ebit > 0 && <span style={{ color: '#2563eb', fontSize: 12 }}>EBIT: {fmt(lever.ebit)}</span>}
                                        </div>
                                    </div>
                                ))}
                                {/* Total bar */}
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: 12, padding: '10px 14px', background: '#000', color: '#fff' }}>
                                    <span style={{ fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.05em' }}>TOTAL IMPACT</span>
                                    <div style={{ display: 'flex', gap: 16 }}>
                                        <span style={{ color: '#4ade80', fontWeight: 700, fontSize: 15 }}>{fmt(totalCash)}</span>
                                        <span style={{ color: '#60a5fa', fontWeight: 700, fontSize: 15 }}>EBIT: {fmt(totalEbit)}</span>
                                    </div>
                                </div>
                            </div>

                            {/* === ROW 4: Action Plan === */}
                            <div style={{ padding: 20 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 }}>
                                    <span style={{ background: '#000', color: '#FFF469', padding: '3px 8px', fontFamily: "'Monument', monospace", fontSize: 10, letterSpacing: '0.08em' }}>GO</span>
                                    <span style={{ ...tag(), marginBottom: 0 }}>ACTION PLAN (WHO, WHAT, WHEN)</span>
                                </div>
                                {actions.filter(a => a.what.trim()).map((action, i) => (
                                    <div key={i} style={{ borderLeft: '3px solid #000', paddingLeft: 16, marginBottom: 16 }}>
                                        <p style={{ ...tag('#6B7280') }}>ACTION {i + 1}</p>
                                        <p style={{ fontSize: 14, fontWeight: 600, marginBottom: 4, lineHeight: 1.4 }}>{action.what}</p>
                                        <div style={{ display: 'flex', gap: 20, fontSize: 12, color: '#6B7280' }}>
                                            <span>Owner: <strong style={{ color: '#000' }}>{action.who || '\u2014'}</strong></span>
                                            <span>Deadline: <strong style={{ color: '#000' }}>{action.when ? new Date(action.when).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '\u2014'}</strong></span>
                                        </div>
                                    </div>
                                ))}
                                {actions.filter(a => a.what.trim()).length === 0 && <p style={{ fontSize: 14, color: '#999' }}>No actions defined.</p>}
                            </div>

                            {/* Quote footer */}
                            <div style={{ borderTop: '2px solid #000', padding: '16px 20px', textAlign: 'center', background: '#FAFAFA' }}>
                                <p style={{ fontSize: 13, fontStyle: 'italic', color: '#6B7280' }}>"Mind the gap between profit and cash flow; it's where the real financial health of your business lies."</p>
                                <p style={{ ...tag('#999'), marginTop: 4, marginBottom: 0 }}>ALAN MILTZ</p>
                            </div>
                        </div>

                        {/* Action buttons (WOOP-style Monument font) */}
                        <div className="no-print" style={{ display: 'flex', gap: 12, marginTop: 20 }}>
                            <button onClick={handleExport} style={{ flex: 1, minHeight: 48, background: '#fff', border: '2px solid #000', cursor: 'pointer', fontFamily: "'Monument', monospace", fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.05em' }}>Export PDF</button>
                            <button onClick={handleSubmit} disabled={submitStatus === 'saving'} style={{ flex: 1, minHeight: 48, background: '#000', color: '#fff', border: '2px solid #000', cursor: 'pointer', fontFamily: "'Monument', monospace", fontSize: 12, textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                                {submitStatus === 'saving' ? 'Saving...' : 'Final Submit'}
                            </button>
                        </div>

                        {submitStatus && (
                            <div style={{ marginTop: 12, padding: '10px 16px', textAlign: 'center', background: submitStatus === 'success' ? '#F0FDF4' : submitStatus === 'error' ? '#FEF2F2' : '#F3F4F6', border: `1px solid ${submitStatus === 'success' ? '#BBF7D0' : submitStatus === 'error' ? '#FECACA' : '#E5E7EB'}`, fontSize: 13 }}>
                                <span style={{ color: submitStatus === 'success' ? '#166534' : submitStatus === 'error' ? '#991B1B' : '#1F2937' }}>{submitMessage}</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<CashFlowTool />, document.getElementById('root'));
    </script>
</body>
</html>
