<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast Track Tools Dashboard</title>
  <link rel="icon" type="image/png" href="shared/images/favicon-16x16.png">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Fast Track Brand Fonts */
    @font-face {
      font-family: 'Plaak';
      src: url('shared/fonts/Plaak3Trial-43-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Riforma';
      src: url('shared/fonts/RiformaLL-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Monument Grotesk';
      src: url('shared/fonts/MonumentGrotesk-Mono.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    /* CSS Custom Properties */
    :root {
      --color-black: #000000;
      --color-white: #FFFFFF;
      --color-grey: #B2B2B2;
      --color-yellow: #FFF469;
      --font-plaak: 'Plaak', Arial, sans-serif;
      --font-riforma: 'Riforma', Arial, sans-serif;
      --font-monument: 'Monument Grotesk', 'Courier New', monospace;
    }

    /* CSS Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Base Styles */
    html, body {
      height: 100%;
      background-color: var(--color-black);
      color: var(--color-white);
      font-family: var(--font-riforma);
      line-height: 1.5;
    }

    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Typography */
    h1, h2, h3 {
      font-family: var(--font-plaak);
      text-transform: uppercase;
      font-weight: bold;
      line-height: 1.2;
    }

    h1 { font-size: 3rem; }
    h2 { font-size: 2rem; }
    h3 { font-size: 1.5rem; }

    p {
      font-family: var(--font-riforma);
      text-transform: none;
    }

    label, .label {
      font-family: var(--font-monument);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 10px; background-color: var(--color-black); }
    ::-webkit-scrollbar-track { background: var(--color-black); }
    ::-webkit-scrollbar-thumb { background: var(--color-grey); border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--color-yellow); }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 244, 105, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(255, 244, 105, 0); }
    }

    .unlock-animation {
      animation: fadeIn 0.5s ease-out, pulse 1s ease-out 0.5s;
    }

    /* Fast Track Brand Color Classes */
    .bg-ft-yellow { background-color: #FFF469 !important; }
    .text-ft-yellow { color: #FFF469 !important; }
    .border-ft-yellow { border-color: #FFF469 !important; }
    .bg-ft-grey { background-color: #B2B2B2 !important; }
    .text-ft-grey { color: #B2B2B2 !important; }
    .bg-ft-dark { background-color: #1F1F1F !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, memo, useCallback } = React;

    // ── Supabase Client ──
    const SUPABASE_URL = 'https://lutzzfaedkbsmbobmrzx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1dHp6ZmFlZGtic21ib2Jtcnp4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MDA0MDQsImV4cCI6MjA4NjM3NjQwNH0.o2gJba85vDl4NLS-C8Mq3OudWKxet-b0IqO9kazqb8U';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ── LearnWorlds Config ──
    const LEARNWORLDS_URL = 'https://fasttrack.learnworlds.com';

    // ── Tool Registry (30 tools) ──
    const TOOLS = [
      { sprint: 0,  slug: 'woop',                       name: 'WOOP',                        file: 'module-0-intro-sprint/00-woop.html' },
      { sprint: 1,  slug: 'know-thyself',                name: 'Know Thyself',                 file: 'module-1-identity/01-know-thyself.html' },
      { sprint: 2,  slug: 'dream',                       name: 'Dream',                        file: 'module-1-identity/02-dream.html' },
      { sprint: 3,  slug: 'values',                      name: 'Values',                       file: 'module-1-identity/03-values.html' },
      { sprint: 4,  slug: 'team',                        name: 'Team',                         file: 'module-1-identity/04-team.html' },
      { sprint: 5,  slug: 'fit',                         name: 'Fit',                          file: 'module-1-identity/05-fit.html' },
      { sprint: 6,  slug: 'cash',                        name: 'Cash',                         file: 'module-2-performance/06-cash.html' },
      { sprint: 7,  slug: 'energy',                      name: 'Energy',                       file: 'module-2-performance/07-energy.html' },
      { sprint: 8,  slug: 'goals',                       name: 'Goals',                        file: 'module-2-performance/08-goals.html' },
      { sprint: 9,  slug: 'focus',                       name: 'Focus',                        file: 'module-2-performance/09-focus.html' },
      { sprint: 10, slug: 'performance',                 name: 'Performance Analysis',          file: 'module-2-performance/10-performance.html' },
      { sprint: 11, slug: 'meeting-rhythm',              name: 'Meeting Rhythm',                file: 'module-2-performance/11-meeting-rhythm.html' },
      { sprint: 12, slug: 'market-size',                 name: 'Market Size',                   file: 'module-3-market/12-market-size.html' },
      { sprint: 13, slug: 'segmentation-target-market',  name: 'Segmentation & Target Market',  file: 'module-3-market/13-segmentation-target-market.html' },
      { sprint: 14, slug: 'target-segment-deep-dive',    name: 'Target Segment Deep Dive',      file: 'module-4-strategy-development/14-target-segment-deep-dive.html' },
      { sprint: 15, slug: 'value-proposition',           name: 'Value Proposition',             file: 'module-4-strategy-development/15-value-proposition.html' },
      { sprint: 16, slug: 'value-proposition-testing',   name: 'Value Proposition Testing',     file: 'module-4-strategy-development/16-value-proposition-testing.html' },
      { sprint: 17, slug: 'product-development',         name: 'Product Development',           file: 'module-5-strategy-execution/17-product-development.html' },
      { sprint: 18, slug: 'pricing',                     name: 'Pricing',                       file: 'module-5-strategy-execution/18-pricing.html' },
      { sprint: 19, slug: 'brand-marketing',             name: 'Brand & Marketing',             file: 'module-5-strategy-execution/19-brand-marketing.html' },
      { sprint: 20, slug: 'customer-service',            name: 'Customer Service',              file: 'module-5-strategy-execution/20-customer-service.html' },
      { sprint: 21, slug: 'route-to-market',             name: 'Route to Market',               file: 'module-5-strategy-execution/21-route-to-market.html' },
      { sprint: 22, slug: 'core-activities',             name: 'Core Activities',               file: 'module-6-org-structure/22-core-activities.html' },
      { sprint: 23, slug: 'processes-decisions',         name: 'Processes & Decisions',         file: 'module-6-org-structure/23-processes-decisions.html' },
      { sprint: 24, slug: 'fit-abc-analysis',            name: 'Fit ABC Analysis',              file: 'module-6-org-structure/24-fit-abc-analysis.html' },
      { sprint: 25, slug: 'org-redesign',                name: 'Organizational Redesign',       file: 'module-6-org-structure/25-org-redesign.html' },
      { sprint: 26, slug: 'employer-branding',           name: 'Employer Branding',             file: 'module-7-people-leadership/26-employer-branding.html' },
      { sprint: 27, slug: 'agile-teams',                 name: 'Agile Teams',                   file: 'module-7-people-leadership/27-agile-teams.html' },
      { sprint: 28, slug: 'digitalization',              name: 'Digitalization',                file: 'module-8-tech-ai/28-digitalization.html' },
      { sprint: 29, slug: 'digital-heart',               name: 'Digital Heart',                 file: 'module-8-tech-ai/29-digital-heart.html' },
    ];

    const MODULES = [
      { id: 0, name: 'Intro Sprint',                    sprints: [0] },
      { id: 1, name: 'Individual & Company Identity',   sprints: [1,2,3,4,5] },
      { id: 2, name: 'Core Elements of Performance',    sprints: [6,7,8,9,10,11] },
      { id: 3, name: 'Understanding the Market',        sprints: [12,13] },
      { id: 4, name: 'Strategy Development',            sprints: [14,15,16] },
      { id: 5, name: 'Strategy Execution',              sprints: [17,18,19,20,21] },
      { id: 6, name: 'Organizational Structure',        sprints: [22,23,24,25] },
      { id: 7, name: 'People & Leadership',             sprints: [26,27] },
      { id: 8, name: 'Tech & AI',                       sprints: [28,29] },
    ];

    // ── Auth: LearnWorlds URL params ──
    // LearnWorlds external link variables:
    //   {{USER_ID}}, {{USER_NAME}}, {{USER_EMAIL}}, {{USER_TAGS}}, {{COURSE_ID}}, {{UNIT_ID}}
    // Dashboard URL in LearnWorlds:
    //   https://fasttracktools.up.railway.app/dashboard.html?lw_user_id={{USER_ID}}&lw_email={{USER_EMAIL}}&lw_name={{USER_NAME}}&lw_tags={{USER_TAGS}}
    // Tag guru users in LearnWorlds with the tag "guru" — they will see the GURU VIEW button.
    async function identifyUser() {
      const params = new URLSearchParams(window.location.search);
      const lwUserId = params.get('lw_user_id');
      const lwEmail = params.get('lw_email');
      const lwName = params.get('lw_name');
      const lwTags = params.get('lw_tags') || '';

      // Determine guru status — only trust it when coming directly from LearnWorlds URL
      let isGuru = false;
      if (lwUserId || lwEmail) {
        isGuru = lwTags.toLowerCase().split(',').map(t => t.trim()).includes('guru');
        // Persist for this browser session (same tab refreshes still work)
        if (isGuru) sessionStorage.setItem('ft_is_guru', '1');
        else sessionStorage.removeItem('ft_is_guru');
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        // No LW params — honour guru flag set earlier in this session
        isGuru = sessionStorage.getItem('ft_is_guru') === '1';
      }

      // 1. Try LearnWorlds params from URL (auto-identify, no login needed)
      if (lwUserId || lwEmail) {
        // Try by LearnWorlds user ID first
        if (lwUserId) {
          const { data: existing } = await sb
            .from('users')
            .select('id, full_name, email, learnworlds_user_id, organization_id, organization_name')
            .eq('learnworlds_user_id', lwUserId)
            .single();

          if (existing) {
            const updates = { last_login: new Date().toISOString() };
            if (lwName && (!existing.full_name || existing.full_name === existing.email.split('@')[0])) {
              updates.full_name = lwName;
            }
            await sb.from('users').update(updates).eq('id', existing.id);
            if (updates.full_name) existing.full_name = updates.full_name;
            storeSession(existing);
            return { user: existing, isGuru };
          }
        }

        // Try by email
        if (lwEmail) {
          const { data: byEmail } = await sb
            .from('users')
            .select('id, full_name, email, learnworlds_user_id, organization_id, organization_name')
            .eq('email', lwEmail.toLowerCase())
            .single();

          if (byEmail) {
            const updates = { last_login: new Date().toISOString() };
            if (lwUserId && !byEmail.learnworlds_user_id) updates.learnworlds_user_id = lwUserId;
            if (lwName && (!byEmail.full_name || byEmail.full_name === byEmail.email.split('@')[0])) updates.full_name = lwName;
            await sb.from('users').update(updates).eq('id', byEmail.id);
            if (updates.learnworlds_user_id) byEmail.learnworlds_user_id = lwUserId;
            if (updates.full_name) byEmail.full_name = updates.full_name;
            storeSession(byEmail);
            return { user: byEmail, isGuru };
          }
        }

        // Create new user from LearnWorlds data
        const email = lwEmail ? lwEmail.toLowerCase() : `${lwUserId}@learnworlds.user`;
        const { data: newUser } = await sb
          .from('users')
          .insert({
            email,
            learnworlds_user_id: lwUserId || null,
            full_name: lwName || (lwEmail ? lwEmail.split('@')[0] : 'Fast Track User'),
            role: 'participant',
            last_login: new Date().toISOString()
          })
          .select('id, full_name, email, learnworlds_user_id, organization_id, organization_name')
          .single();

        if (newUser) {
          storeSession(newUser);
          return { user: newUser, isGuru };
        }
      }

      // 2. Try stored session (same browser tab)
      const stored = getStoredSession();
      if (stored) return { user: stored, isGuru };

      // 3. Try ft_user_id from localStorage (persists across tabs/sessions)
      const storedUserId = localStorage.getItem('ft_user_id');
      if (storedUserId) {
        const { data: storedUser } = await sb
          .from('users')
          .select('id, full_name, email, learnworlds_user_id, organization_id, organization_name')
          .eq('id', storedUserId)
          .single();
        if (storedUser) {
          storeSession(storedUser);
          return { user: storedUser, isGuru };
        }
      }

      return { user: null, isGuru: false };
    }

    function storeSession(user) {
      sessionStorage.setItem('ft_dashboard_user', JSON.stringify(user));
      // Also set ft_user_id so tools can pick it up
      localStorage.setItem('ft_user_id', user.id);
    }

    function getStoredSession() {
      try {
        const stored = sessionStorage.getItem('ft_dashboard_user');
        return stored ? JSON.parse(stored) : null;
      } catch { return null; }
    }

    // ── Data Fetching ──
    async function fetchToolProgress(userId) {
      // 1. Get completions
      const { data: completions } = await sb
        .from('tool_completions')
        .select('tool_slug, completed_at')
        .eq('user_id', userId);

      const completedSlugs = new Set((completions || []).map(c => c.tool_slug));
      const completionMap = {};
      (completions || []).forEach(c => { completionMap[c.tool_slug] = c.completed_at; });

      // 2. Get all question IDs grouped by tool_slug
      const { data: questions } = await sb
        .from('tool_questions')
        .select('id, tool_slug')
        .in('tool_slug', TOOLS.map(t => t.slug));

      const questionsByTool = {};
      (questions || []).forEach(q => {
        if (!questionsByTool[q.tool_slug]) questionsByTool[q.tool_slug] = [];
        questionsByTool[q.tool_slug].push(q.id);
      });

      // 3. Get user's responses
      const allQuestionIds = (questions || []).map(q => q.id);
      const { data: responses } = await sb
        .from('user_responses')
        .select('question_id')
        .eq('user_id', userId)
        .in('question_id', allQuestionIds);

      const answeredIds = new Set((responses || []).map(r => r.question_id));

      // 4. Build tool list with status
      return TOOLS.map((tool, index) => {
        const totalQ = (questionsByTool[tool.slug] || []).length;
        const answeredQ = (questionsByTool[tool.slug] || []).filter(qid => answeredIds.has(qid)).length;

        let status;
        let progress = 0;

        if (completedSlugs.has(tool.slug)) {
          status = 'completed';
          progress = 100;
        } else if (answeredQ > 0) {
          status = 'in_progress';
          progress = totalQ > 0 ? Math.round((answeredQ / totalQ) * 100) : 0;
        } else if (index === 0) {
          // First tool always unlocked
          status = 'unlocked';
        } else {
          // Unlocked if previous tool is completed
          const prevSlug = TOOLS[index - 1].slug;
          status = completedSlugs.has(prevSlug) ? 'unlocked' : 'locked';
        }

        return {
          ...tool,
          id: tool.slug,
          status,
          progress,
          completedAt: completionMap[tool.slug] || null,
        };
      });
    }

    // ── Guru: fetch all org members with progress summary ──
    async function fetchOrgMembers(orgId) {
      if (!orgId) return [];

      const { data: memberList } = await sb
        .from('users')
        .select('id, full_name, email, last_login')
        .eq('organization_id', orgId);

      if (!memberList?.length) return [];
      const memberIds = memberList.map(m => m.id);

      const [{ data: completions }, { data: latestResponses }, { data: questions }] = await Promise.all([
        sb.from('tool_completions').select('user_id, tool_slug, completed_at').in('user_id', memberIds),
        sb.from('user_responses').select('user_id, question_id, updated_at').in('user_id', memberIds),
        sb.from('tool_questions').select('id, tool_slug'),
      ]);

      const qSlugMap = {};
      (questions || []).forEach(q => { qSlugMap[q.id] = q.tool_slug; });

      const completionsByUser = {};
      (completions || []).forEach(c => {
        if (!completionsByUser[c.user_id]) completionsByUser[c.user_id] = [];
        completionsByUser[c.user_id].push(c);
      });

      const latestByUser = {};
      (latestResponses || []).forEach(r => {
        const ex = latestByUser[r.user_id];
        if (!ex || r.updated_at > ex.updatedAt) {
          latestByUser[r.user_id] = { questionId: r.question_id, updatedAt: r.updated_at };
        }
      });

      return memberList.map(m => {
        const completedTools = (completionsByUser[m.id] || [])
          .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
        const latest = latestByUser[m.id];
        const currentSlug = latest ? qSlugMap[latest.questionId] : null;
        const currentTool = currentSlug ? TOOLS.find(t => t.slug === currentSlug) : null;
        return {
          ...m,
          completedCount: completedTools.length,
          completedTools,
          currentTool,
          lastActive: latest?.updatedAt || m.last_login,
        };
      }).sort((a, b) => (b.lastActive || '').localeCompare(a.lastActive || ''));
    }

    async function fetchToolSubmission(userId, toolSlug) {
      // Get questions for this tool
      const { data: questions } = await sb
        .from('tool_questions')
        .select('id, question_key, question_text, section_name, question_type')
        .eq('tool_slug', toolSlug)
        .order('step_number', { ascending: true })
        .order('display_order', { ascending: true });

      if (!questions || questions.length === 0) return [];

      // Get user's responses
      const questionIds = questions.map(q => q.id);
      const { data: responses } = await sb
        .from('user_responses')
        .select('question_id, response_value, response_data')
        .eq('user_id', userId)
        .in('question_id', questionIds);

      const responseMap = {};
      (responses || []).forEach(r => { responseMap[r.question_id] = r; });

      // Merge
      return questions.map(q => ({
        question: q.question_text || q.question_key,
        section: q.section_name,
        type: q.question_type,
        answer: responseMap[q.id]?.response_value || '',
        data: responseMap[q.id]?.response_data || null,
      }));
    }

    // ── Launch Tool ──
    function launchTool(tool) {
      window.location.href = `tools/${tool.file}`;
    }

    // ── Components ──
    const ProgressBar = memo(({ progress = 0, className = '' }) => (
      <div className={`w-full bg-ft-dark h-2 rounded-full overflow-hidden ${className}`}>
        <div className="h-full bg-ft-yellow transition-all duration-300" style={{ width: `${Math.max(0, Math.min(100, progress))}%` }}></div>
      </div>
    ));

    const StatusBadge = memo(({ status }) => {
      const styles = {
        locked:      'text-ft-grey text-xs uppercase',
        unlocked:    'text-white text-xs uppercase',
        in_progress: 'text-ft-yellow text-xs uppercase font-bold',
        completed:   'text-white text-xs uppercase font-bold'
      };
      const labels = {
        locked:      'LOCKED',
        unlocked:    'UNLOCKED',
        in_progress: 'IN PROGRESS',
        completed:   'DONE'
      };
      return <span className={styles[status] || styles.locked} style={{fontFamily: 'var(--font-monument)'}}>{labels[status] || 'LOCKED'}</span>;
    });

    const ToolCard = memo(({ tool, onViewSummary }) => {
      const isLocked = tool.status === 'locked';
      const showProgress = tool.status === 'in_progress' && tool.progress != null;
      const isCompleted = tool.status === 'completed';
      const borderClass = tool.status === 'in_progress' ? 'border-2 border-ft-yellow' : '';

      return (
        <div className={`bg-white text-black p-6 rounded-lg shadow-lg ${borderClass} ${isLocked ? 'opacity-60' : ''}`}>
          <div className="mb-2">
            <span className="text-xs uppercase text-gray-500" style={{fontFamily: 'var(--font-monument)'}}>Sprint {String(tool.sprint).padStart(2, '0')}</span>
          </div>
          <h3 className="text-xl mb-3" style={{fontFamily: 'var(--font-plaak)'}}>{tool.name}</h3>
          <div className="mb-3">
            <StatusBadge status={tool.status} />
          </div>
          {showProgress && (
            <div className="mb-4">
              <ProgressBar progress={tool.progress} />
              <span className="text-xs text-gray-600 mt-1 block">{tool.progress}%</span>
            </div>
          )}
          <div className="flex gap-2">
            {isCompleted ? (
              <button onClick={() => onViewSummary(tool)} className="px-6 py-2 rounded bg-ft-yellow text-black font-bold uppercase transition" style={{fontFamily: 'var(--font-monument)', fontSize: '0.75rem'}} onMouseEnter={(e) => e.target.style.backgroundColor = '#FFED7A'} onMouseLeave={(e) => e.target.style.backgroundColor = '#FFF469'}>
                VIEW SUMMARY
              </button>
            ) : (
              <button
                onClick={() => !isLocked && launchTool(tool)}
                disabled={isLocked}
                className={`px-6 py-2 rounded font-bold uppercase transition ${isLocked ? 'bg-gray-600 text-gray-400 cursor-not-allowed' : 'bg-black text-white hover:bg-gray-800 cursor-pointer'}`}
                style={{fontFamily: 'var(--font-monument)', fontSize: '0.75rem'}}
              >
                {tool.status === 'in_progress' ? 'CONTINUE' : 'LAUNCH'}
              </button>
            )}
            {isCompleted && (
              <button
                onClick={() => launchTool(tool)}
                className="px-6 py-2 rounded bg-gray-200 text-black font-bold uppercase transition hover:bg-gray-300"
                style={{fontFamily: 'var(--font-monument)', fontSize: '0.75rem'}}
              >
                REDO
              </button>
            )}
          </div>
        </div>
      );
    });

    const ModuleSection = memo(({ module, tools, collapsed, onToggle, onViewSummary }) => {
      const moduleTools = tools.filter(t => module.sprints.includes(t.sprint));
      const completed = moduleTools.filter(t => t.status === 'completed').length;
      const total = moduleTools.length;

      return (
        <div className="mb-8">
          <div onClick={onToggle} className="flex items-center justify-between cursor-pointer bg-gray-900 p-4 rounded-lg hover:bg-gray-800 transition">
            <div>
              <h2 className="text-2xl text-white mb-1" style={{fontFamily: 'var(--font-plaak)'}}>Module {module.id}: {module.name}</h2>
              <span className="text-sm text-gray-400" style={{fontFamily: 'var(--font-monument)'}}>
                {total === 1 ? `SPRINT ${module.sprints[0]}` : `SPRINTS ${module.sprints[0]}-${module.sprints[module.sprints.length-1]}`} &bull; {completed}/{total} COMPLETE
              </span>
            </div>
            <span className="text-ft-yellow text-2xl select-none">{collapsed ? '+' : '\u2212'}</span>
          </div>
          {!collapsed && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
              {moduleTools.map(tool => <ToolCard key={tool.id} tool={tool} onViewSummary={onViewSummary} />)}
            </div>
          )}
        </div>
      );
    });

    // Converts camelCase keys to readable labels
    function formatKey(key) {
      return key
        .replace(/([A-Z])/g, ' $1')
        .replace(/[_-]/g, ' ')
        .replace(/^\w/, c => c.toUpperCase())
        .trim();
    }

    // Renders any value (string, array, object) in a human-readable way
    const ResponseValue = memo(({ value }) => {
      if (value === null || value === undefined || value === '') {
        return <p className="text-gray-400 italic">No response</p>;
      }
      // Primitive string/number
      if (typeof value === 'string' || typeof value === 'number') {
        return <p className="text-base">{String(value)}</p>;
      }
      // Boolean
      if (typeof value === 'boolean') {
        return <p className="text-base">{value ? 'Yes' : 'No'}</p>;
      }
      // Array of strings
      if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'string') {
        return (
          <ul className="list-disc list-inside space-y-1">
            {value.map((item, i) => <li key={i} className="text-base">{item}</li>)}
          </ul>
        );
      }
      // Array of objects
      if (Array.isArray(value)) {
        return (
          <div className="space-y-3">
            {value.map((item, i) => (
              <div key={i} className="bg-gray-50 p-3 rounded border border-gray-100">
                {typeof item === 'object' && item !== null ? (
                  Object.entries(item).filter(([,v]) => v !== '' && v !== null).map(([k, v]) => (
                    <div key={k} className="mb-1 last:mb-0">
                      <span className="text-xs text-gray-500 uppercase" style={{fontFamily: 'var(--font-monument)'}}>{formatKey(k)}: </span>
                      <span className="text-sm">{typeof v === 'boolean' ? (v ? 'Yes' : 'No') : String(v)}</span>
                    </div>
                  ))
                ) : (
                  <p className="text-sm">{String(item)}</p>
                )}
              </div>
            ))}
          </div>
        );
      }
      // Plain object
      if (typeof value === 'object') {
        return (
          <div className="bg-gray-50 p-3 rounded border border-gray-100">
            {Object.entries(value).filter(([,v]) => v !== '' && v !== null).map(([k, v]) => (
              <div key={k} className="mb-2 last:mb-0">
                <span className="text-xs text-gray-500 uppercase block" style={{fontFamily: 'var(--font-monument)'}}>{formatKey(k)}</span>
                {typeof v === 'boolean' ? (
                  <span className="text-base">{v ? 'Yes' : 'No'}</span>
                ) : Array.isArray(v) ? (
                  <ul className="list-disc list-inside">
                    {v.map((item, i) => <li key={i} className="text-sm">{String(item)}</li>)}
                  </ul>
                ) : (
                  <span className="text-base">{String(v)}</span>
                )}
              </div>
            ))}
          </div>
        );
      }
      return <p className="text-base">{String(value)}</p>;
    });

    const SummaryModal = memo(({ tool, userId, onClose }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        if (tool && userId) {
          setLoading(true);
          fetchToolSubmission(userId, tool.slug)
            .then(setData)
            .finally(() => setLoading(false));
        }
      }, [tool, userId]);

      useEffect(() => {
        const handleEscape = (e) => e.key === 'Escape' && onClose();
        document.addEventListener('keydown', handleEscape);
        return () => document.removeEventListener('keydown', handleEscape);
      }, [onClose]);

      if (!tool) return null;

      // Group answers by section
      const sections = {};
      (data || []).forEach(item => {
        const sec = item.section || 'Responses';
        if (!sections[sec]) sections[sec] = [];
        sections[sec].push(item);
      });

      return (
        <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose} role="dialog" aria-modal="true">
          <div className="bg-white text-black rounded-lg max-w-4xl w-full max-h-[80vh] overflow-auto" onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center p-6 border-b">
              <div>
                <h2 className="text-3xl" style={{fontFamily: 'var(--font-plaak)'}}>{tool.name}</h2>
                <span className="text-sm text-gray-500" style={{fontFamily: 'var(--font-monument)'}}>SPRINT {String(tool.sprint).padStart(2, '0')}</span>
                {tool.completedAt && (
                  <span className="text-sm text-green-600 ml-4">Completed {new Date(tool.completedAt).toLocaleDateString()}</span>
                )}
              </div>
              <button onClick={onClose} className="text-3xl hover:text-gray-600">&times;</button>
            </div>
            <div className="p-6">
              {loading && <p className="text-gray-500">Loading submission...</p>}
              {!loading && (!data || data.length === 0) && <p className="text-gray-500">No submission data found.</p>}
              {!loading && data && data.length > 0 && (
                <div className="space-y-6">
                  {Object.entries(sections).map(([sectionName, items]) => (
                    <div key={sectionName}>
                      <h3 className="text-lg font-bold mb-3 pb-2 border-b border-gray-200" style={{fontFamily: 'var(--font-plaak)'}}>{sectionName}</h3>
                      <div className="space-y-3">
                        {items.map((item, i) => (
                          <div key={i}>
                            <p className="text-sm text-gray-500 mb-1">{item.question}</p>
                            <ResponseValue value={item.data || item.answer} />
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
            <div className="p-6 border-t flex justify-end gap-3">
              <button onClick={() => launchTool(tool)} className="px-6 py-2 bg-black text-white rounded hover:bg-gray-800 uppercase text-sm font-bold" style={{fontFamily: 'var(--font-monument)'}}>Relaunch Tool</button>
              <button onClick={onClose} className="px-6 py-2 bg-gray-200 rounded hover:bg-gray-300 uppercase text-sm font-bold" style={{fontFamily: 'var(--font-monument)'}}>Close</button>
            </div>
          </div>
        </div>
      );
    });

    // ── Guru Panel Components ──
    function timeAgo(dateStr) {
      if (!dateStr) return 'Never';
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return `${mins}m ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      return `${Math.floor(hours / 24)}d ago`;
    }

    const GuruResponseValue = memo(({ value }) => {
      const base = { fontFamily: 'var(--font-riforma)', fontSize: 14, lineHeight: '1.6', color: '#ccc' };
      if (value === null || value === undefined || value === '') {
        return <p style={{ ...base, color: '#444', fontStyle: 'italic' }}>No response</p>;
      }
      if (typeof value === 'string' || typeof value === 'number') {
        return <p style={base}>{String(value)}</p>;
      }
      if (typeof value === 'boolean') {
        return <p style={base}>{value ? 'Yes' : 'No'}</p>;
      }
      if (Array.isArray(value) && typeof value[0] === 'string') {
        return <ul style={{ ...base, paddingLeft: 16 }}>{value.map((v, i) => <li key={i}>{v}</li>)}</ul>;
      }
      if (Array.isArray(value)) {
        return (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
            {value.map((item, i) => (
              <div key={i} style={{ background: '#141414', padding: '10px 14px', border: '1px solid #1e1e1e' }}>
                {typeof item === 'object' && item !== null
                  ? Object.entries(item).filter(([,v]) => v !== '' && v !== null).map(([k, v]) => (
                      <div key={k} style={{ marginBottom: 3 }}>
                        <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#555', textTransform: 'uppercase' }}>{formatKey(k)}: </span>
                        <span style={{ ...base, fontSize: 13 }}>{String(v)}</span>
                      </div>
                    ))
                  : <span style={base}>{String(item)}</span>
                }
              </div>
            ))}
          </div>
        );
      }
      if (typeof value === 'object') {
        return (
          <div style={{ background: '#141414', padding: '12px 16px', border: '1px solid #1e1e1e' }}>
            {Object.entries(value).filter(([,v]) => v !== '' && v !== null).map(([k, v]) => (
              <div key={k} style={{ marginBottom: 8 }}>
                <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#555', textTransform: 'uppercase', marginBottom: 2 }}>{formatKey(k)}</div>
                <div style={base}>{String(v)}</div>
              </div>
            ))}
          </div>
        );
      }
      return <p style={base}>{String(value)}</p>;
    });

    const AnswerList = memo(({ answers }) => {
      const sections = {};
      (answers || []).forEach(item => {
        const sec = item.section || 'Responses';
        if (!sections[sec]) sections[sec] = [];
        sections[sec].push(item);
      });
      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: 24 }}>
          {Object.entries(sections).map(([sectionName, items]) => (
            <div key={sectionName}>
              <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#FFF469', letterSpacing: '0.08em', marginBottom: 10, textTransform: 'uppercase' }}>
                {sectionName}
              </div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                {items.map((item, i) => (
                  <div key={i}>
                    <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#555', marginBottom: 4 }}>{item.question}</div>
                    <GuruResponseValue value={item.data || item.answer} />
                  </div>
                ))}
              </div>
            </div>
          ))}
        </div>
      );
    });

    const GuruPanel = memo(({ user, onClose }) => {
      const [members, setMembers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedMember, setSelectedMember] = useState(null);
      const [selectedTool, setSelectedTool] = useState(null);
      const [answers, setAnswers] = useState(null);
      const [answersLoading, setAnswersLoading] = useState(false);

      useEffect(() => {
        const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
        document.addEventListener('keydown', handleEsc);
        return () => document.removeEventListener('keydown', handleEsc);
      }, [onClose]);

      useEffect(() => {
        fetchOrgMembers(user.organization_id)
          .then(setMembers)
          .finally(() => setLoading(false));
      }, []);

      const viewAnswers = useCallback(async (memberId, toolSlug) => {
        if (selectedTool === toolSlug) { setSelectedTool(null); setAnswers(null); return; }
        setSelectedTool(toolSlug);
        setAnswers(null);
        setAnswersLoading(true);
        try {
          const data = await fetchToolSubmission(memberId, toolSlug);
          setAnswers(data);
        } finally {
          setAnswersLoading(false);
        }
      }, [selectedTool]);

      const selectMember = useCallback((member) => {
        setSelectedMember(member);
        setSelectedTool(null);
        setAnswers(null);
      }, []);

      const totalCompleted = members.reduce((sum, m) => sum + m.completedCount, 0);
      const orgName = user.organization_name || 'Your Organisation';

      return (
        <div style={{ position: 'fixed', inset: 0, background: '#000', zIndex: 100, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
          {/* Header */}
          <div style={{ borderBottom: '1px solid #1a1a1a', padding: '18px 32px', display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexShrink: 0 }}>
            <div>
              <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#FFF469', letterSpacing: '0.12em', marginBottom: 4 }}>GURU VIEW</div>
              <div style={{ fontFamily: 'var(--font-plaak)', fontSize: 26, color: '#fff', textTransform: 'uppercase' }}>{orgName}</div>
              <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#444', marginTop: 4, letterSpacing: '0.06em' }}>
                {members.length} MEMBERS &bull; {totalCompleted} TOOLS COMPLETED
              </div>
            </div>
            <button
              onClick={onClose}
              style={{ background: 'none', border: '1px solid #333', color: '#fff', padding: '8px 20px', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.08em', cursor: 'pointer' }}
              onMouseEnter={e => e.currentTarget.style.borderColor = '#FFF469'}
              onMouseLeave={e => e.currentTarget.style.borderColor = '#333'}
            >
              CLOSE ✕
            </button>
          </div>

          {/* Body */}
          <div style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>
            {/* Member list */}
            <div style={{ width: 280, borderRight: '1px solid #1a1a1a', overflowY: 'auto', flexShrink: 0 }}>
              {loading && <div style={{ padding: 32, color: '#444', fontFamily: 'var(--font-riforma)', fontSize: 14 }}>Loading members...</div>}
              {!loading && members.length === 0 && (
                <div style={{ padding: 32, color: '#444', fontFamily: 'var(--font-riforma)', fontSize: 14 }}>
                  No team members found in this organisation.
                </div>
              )}
              {members.map(member => {
                const isSelected = selectedMember?.id === member.id;
                return (
                  <div
                    key={member.id}
                    onClick={() => selectMember(member)}
                    style={{
                      padding: '16px 20px',
                      borderBottom: '1px solid #111',
                      cursor: 'pointer',
                      background: isSelected ? '#0e0e0e' : 'transparent',
                      borderLeft: isSelected ? '3px solid #FFF469' : '3px solid transparent',
                      transition: 'background 0.15s',
                    }}
                  >
                    <div style={{ fontFamily: 'var(--font-riforma)', fontSize: 15, color: '#fff', marginBottom: 3 }}>
                      {member.full_name || member.email}
                    </div>
                    <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#FFF469', letterSpacing: '0.06em', marginBottom: 2 }}>
                      {member.completedCount} TOOLS DONE
                    </div>
                    {member.currentTool && (
                      <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#666', marginBottom: 2 }}>
                        → {member.currentTool.name.toUpperCase()}
                      </div>
                    )}
                    <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#333' }}>
                      {timeAgo(member.lastActive)}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Member detail */}
            <div style={{ flex: 1, overflowY: 'auto', padding: '36px 48px' }}>
              {!selectedMember ? (
                <div style={{ color: '#2a2a2a', fontFamily: 'var(--font-monument)', fontSize: 12, marginTop: 100, textAlign: 'center', letterSpacing: '0.08em' }}>
                  SELECT A TEAM MEMBER TO VIEW THEIR PROGRESS
                </div>
              ) : (
                <div>
                  {/* Member name + meta */}
                  <div style={{ marginBottom: 32, paddingBottom: 24, borderBottom: '1px solid #111' }}>
                    <div style={{ fontFamily: 'var(--font-plaak)', fontSize: 30, color: '#fff', textTransform: 'uppercase', marginBottom: 6 }}>
                      {selectedMember.full_name || selectedMember.email}
                    </div>
                    <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#444', letterSpacing: '0.06em' }}>
                      {selectedMember.email} &bull; LAST ACTIVE {timeAgo(selectedMember.lastActive)}
                    </div>
                  </div>

                  {/* Current tool badge */}
                  {selectedMember.currentTool && (
                    <div style={{ background: '#0e0e0e', border: '1px solid #FFF469', padding: '14px 20px', marginBottom: 32, display: 'inline-block' }}>
                      <div style={{ fontFamily: 'var(--font-monument)', fontSize: 9, color: '#FFF469', letterSpacing: '0.1em', marginBottom: 4 }}>CURRENTLY IN</div>
                      <div style={{ fontFamily: 'var(--font-plaak)', fontSize: 18, color: '#fff', textTransform: 'uppercase' }}>
                        {selectedMember.currentTool.name}
                      </div>
                    </div>
                  )}

                  {/* Completed tools */}
                  <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#444', letterSpacing: '0.08em', marginBottom: 16 }}>
                    COMPLETED TOOLS ({selectedMember.completedCount})
                  </div>

                  {selectedMember.completedTools.length === 0 && (
                    <div style={{ color: '#333', fontFamily: 'var(--font-riforma)', fontSize: 14 }}>No tools completed yet.</div>
                  )}

                  <div style={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
                    {selectedMember.completedTools.map(ct => {
                      const tool = TOOLS.find(t => t.slug === ct.tool_slug);
                      if (!tool) return null;
                      const isActive = selectedTool === ct.tool_slug;
                      return (
                        <div key={ct.tool_slug}>
                          <div
                            onClick={() => viewAnswers(selectedMember.id, ct.tool_slug)}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              padding: '14px 18px',
                              background: isActive ? '#0e0e0e' : '#080808',
                              border: isActive ? '1px solid #FFF469' : '1px solid #111',
                              cursor: 'pointer',
                              transition: 'border-color 0.15s',
                            }}
                            onMouseEnter={e => { if (!isActive) e.currentTarget.style.borderColor = '#333'; }}
                            onMouseLeave={e => { if (!isActive) e.currentTarget.style.borderColor = '#111'; }}
                          >
                            <div>
                              <span style={{ fontFamily: 'var(--font-plaak)', fontSize: 15, color: '#fff', textTransform: 'uppercase' }}>
                                {tool.name}
                              </span>
                              <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#444', marginLeft: 14 }}>
                                {new Date(ct.completed_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}
                              </span>
                            </div>
                            <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: isActive ? '#FFF469' : '#444', letterSpacing: '0.06em' }}>
                              {isActive ? 'HIDE ▲' : 'ANSWERS ▼'}
                            </span>
                          </div>

                          {isActive && (
                            <div style={{ background: '#060606', border: '1px solid #111', borderTop: 'none', padding: '20px 24px' }}>
                              {answersLoading && <p style={{ color: '#444', fontFamily: 'var(--font-riforma)', fontSize: 14 }}>Loading answers...</p>}
                              {!answersLoading && (!answers || answers.length === 0) && (
                                <p style={{ color: '#333', fontFamily: 'var(--font-riforma)', fontSize: 14 }}>No saved answers for this tool.</p>
                              )}
                              {!answersLoading && answers && answers.length > 0 && <AnswerList answers={answers} />}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    });

    const Header = memo(({ user, overallProgress, isGuru, onGuruClick }) => (
      <header className="bg-black text-white p-6 border-b border-gray-800">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-4">
            <img src="shared/images/FastTrack_F_White.png" alt="Fast Track" className="h-12" />
          </div>
          <div className="flex items-center gap-6">
            {isGuru && (
              <button
                onClick={onGuruClick}
                style={{
                  background: '#FFF469', color: '#000', border: 'none',
                  padding: '10px 24px', fontFamily: 'var(--font-monument)',
                  fontSize: 11, letterSpacing: '0.12em', textTransform: 'uppercase',
                  cursor: 'pointer', fontWeight: 'bold', transition: 'background 0.15s',
                }}
                onMouseEnter={e => e.currentTarget.style.background = '#e8dd5c'}
                onMouseLeave={e => e.currentTarget.style.background = '#FFF469'}
              >
                GURU VIEW
              </button>
            )}
            <div className="text-right">
              <p className="text-sm" style={{fontFamily: 'var(--font-riforma)'}}>{user?.full_name || user?.email || 'User'}</p>
              <div className="w-40">
                <ProgressBar progress={overallProgress} className="mt-1" />
              </div>
            </div>
          </div>
        </div>
      </header>
    ));

    const Hero = memo(({ completed, total, currentTool }) => (
      <section className="bg-black text-white py-16 px-6">
        <div className="max-w-7xl mx-auto">
          <h1 className="text-5xl md:text-6xl mb-4" style={{fontFamily: 'var(--font-plaak)'}}>YOUR TRANSFORMATION JOURNEY</h1>
          <p className="text-2xl text-gray-300 mb-2" style={{fontFamily: 'var(--font-riforma)'}}>{completed} of {total} tools complete</p>
          {currentTool && <p className="text-lg text-ft-yellow" style={{fontFamily: 'var(--font-monument)'}}>CURRENT: SPRINT {String(currentTool.sprint).padStart(2, '0')} &mdash; {currentTool.name}</p>}
        </div>
      </section>
    ));

    const EmailLogin = memo(({ onLogin }) => {
      const [email, setEmail] = useState('');
      const [name, setName] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!email.trim()) return;
        setLoading(true);
        setError('');

        try {
          // Look up by email
          const { data: existing } = await sb
            .from('users')
            .select('id, full_name, email, learnworlds_user_id')
            .eq('email', email.trim().toLowerCase())
            .single();

          if (existing) {
            await sb.from('users').update({ last_login: new Date().toISOString() }).eq('id', existing.id);
            storeSession(existing);
            onLogin(existing);
            return;
          }

          // Create new user
          const { data: newUser, error: insertErr } = await sb
            .from('users')
            .insert({
              email: email.trim().toLowerCase(),
              full_name: name.trim() || email.split('@')[0],
              role: 'participant',
              last_login: new Date().toISOString()
            })
            .select('id, full_name, email, learnworlds_user_id')
            .single();

          if (insertErr) throw insertErr;
          storeSession(newUser);
          onLogin(newUser);
        } catch (err) {
          console.error('Login error:', err);
          setError('Something went wrong. Try again.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-black text-white flex items-center justify-center">
          <div className="text-center max-w-md px-6 w-full">
            <img src="shared/images/FastTrack_F_White.png" alt="Fast Track" className="h-16 mx-auto mb-8" />
            <h1 className="text-4xl mb-4" style={{fontFamily: 'var(--font-plaak)'}}>YOUR JOURNEY STARTS HERE</h1>
            <p className="text-lg text-gray-300 mb-8" style={{fontFamily: 'var(--font-riforma)'}}>
              Enter your email to access your tools dashboard.
            </p>
            <form onSubmit={handleSubmit} className="space-y-4">
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Your name"
                className="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded text-white text-lg focus:border-yellow-300 focus:outline-none"
                style={{fontFamily: 'var(--font-riforma)'}}
              />
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Your email"
                required
                className="w-full px-4 py-3 bg-gray-900 border border-gray-700 rounded text-white text-lg focus:border-yellow-300 focus:outline-none"
                style={{fontFamily: 'var(--font-riforma)'}}
              />
              {error && <p className="text-red-400 text-sm">{error}</p>}
              <button
                type="submit"
                disabled={loading || !email.trim()}
                className="w-full bg-ft-yellow text-black px-8 py-3 rounded font-bold uppercase hover:opacity-90 transition disabled:opacity-50"
                style={{fontFamily: 'var(--font-monument)'}}
              >
                {loading ? 'Loading...' : 'Enter Dashboard'}
              </button>
            </form>
          </div>
        </div>
      );
    });

    const Footer = memo(() => (
      <footer className="bg-black text-white py-8 px-6 border-t border-gray-800">
        <div className="max-w-7xl mx-auto text-center">
          <p className="text-3xl mb-2" style={{fontFamily: 'var(--font-plaak)'}}>NO GRIT. NO GROWTH.</p>
          <p className="text-sm text-gray-400" style={{fontFamily: 'var(--font-riforma)'}}>&copy; {new Date().getFullYear()} Fast Track Ltd. All rights reserved.</p>
        </div>
      </footer>
    ));

    // ── Main Dashboard ──
    function Dashboard() {
      const [user, setUser] = useState(null);
      const [isGuru, setIsGuru] = useState(false);
      const [showGuruPanel, setShowGuruPanel] = useState(false);
      const [tools, setTools] = useState([]);
      const [loading, setLoading] = useState(true);
      const [noAccess, setNoAccess] = useState(false);
      const [collapsedModules, setCollapsedModules] = useState(() => {
        try {
          const saved = localStorage.getItem('ft_collapsed_modules');
          return saved ? JSON.parse(saved) : [];
        } catch { return []; }
      });
      const [modalTool, setModalTool] = useState(null);

      const overallProgress = useMemo(() => {
        const completed = tools.filter(t => t.status === 'completed').length;
        return tools.length > 0 ? Math.round((completed / tools.length) * 100) : 0;
      }, [tools]);

      const completedCount = useMemo(() => tools.filter(t => t.status === 'completed').length, [tools]);

      const currentTool = useMemo(() => {
        const inProgress = tools.find(t => t.status === 'in_progress');
        if (inProgress) return inProgress;
        return tools.find(t => t.status === 'unlocked') || null;
      }, [tools]);

      const loadData = useCallback(async (userId) => {
        const toolData = await fetchToolProgress(userId);
        setTools(toolData);
      }, []);

      useEffect(() => {
        (async () => {
          try {
            const { user: identified, isGuru: guruFlag } = await identifyUser();
            if (!identified) {
              setNoAccess(true);
              setLoading(false);
              return;
            }
            setUser(identified);
            setIsGuru(guruFlag);
            await loadData(identified.id);
          } catch (err) {
            console.error('Dashboard init error:', err);
          } finally {
            setLoading(false);
          }
        })();
      }, [loadData]);

      const toggleModule = useCallback((moduleId) => {
        setCollapsedModules(prev => {
          const next = prev.includes(moduleId) ? prev.filter(id => id !== moduleId) : [...prev, moduleId];
          localStorage.setItem('ft_collapsed_modules', JSON.stringify(next));
          return next;
        });
      }, []);

      if (loading) {
        return (
          <div className="min-h-screen bg-black text-white flex items-center justify-center">
            <div className="text-center">
              <div className="w-10 h-10 border-3 border-gray-700 border-t-yellow-300 rounded-full animate-spin mx-auto mb-4" style={{borderTopColor: '#FFF469'}}></div>
              <p className="text-xl" style={{fontFamily: 'var(--font-riforma)'}}>Loading your journey...</p>
            </div>
          </div>
        );
      }

      if (noAccess) return <EmailLogin onLogin={async (u) => { setUser(u); await loadData(u.id); setNoAccess(false); }} />;

      return (
        <div className="min-h-screen bg-black">
          <Header user={user} overallProgress={overallProgress} isGuru={isGuru} onGuruClick={() => setShowGuruPanel(true)} />
          <Hero completed={completedCount} total={TOOLS.length} currentTool={currentTool} />
          <main className="max-w-7xl mx-auto px-6 py-12">
            {MODULES.map(module => (
              <ModuleSection
                key={module.id}
                module={module}
                tools={tools}
                collapsed={collapsedModules.includes(module.id)}
                onToggle={() => toggleModule(module.id)}
                onViewSummary={setModalTool}
              />
            ))}
          </main>
          <Footer />
          {modalTool && <SummaryModal tool={modalTool} userId={user.id} onClose={() => setModalTool(null)} />}
          {showGuruPanel && <GuruPanel user={user} onClose={() => setShowGuruPanel(false)} />}
        </div>
      );
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Dashboard />);
  </script>
</body>
</html>
