<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fast Track Tools Dashboard</title>
  <link rel="icon" type="image/png" href="shared/images/favicon-16x16.png">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase CDN removed — all data flows through backend API -->

  <style>
    /* Fast Track Brand Fonts */
    @font-face {
      font-family: 'Plaak';
      src: url('shared/fonts/Plaak3Trial-43-Bold.woff2') format('woff2');
      font-weight: bold;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Riforma';
      src: url('shared/fonts/RiformaLL-Regular.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: 'Monument Grotesk';
      src: url('shared/fonts/MonumentGrotesk-Mono.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    /* CSS Custom Properties */
    :root {
      --color-black: #000000;
      --color-white: #FFFFFF;
      --color-grey: #B2B2B2;
      --color-yellow: #FFF469;
      --font-plaak: 'Plaak', Arial, sans-serif;
      --font-riforma: 'Riforma', Arial, sans-serif;
      --font-monument: 'Monument Grotesk', 'Courier New', monospace;
    }

    /* CSS Reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* Base Styles */
    html, body {
      height: 100%;
      background-color: var(--color-black);
      color: var(--color-white);
      font-family: var(--font-riforma);
      line-height: 1.5;
    }

    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Typography */
    h1, h2, h3 {
      font-family: var(--font-plaak);
      text-transform: uppercase;
      font-weight: bold;
      line-height: 1.2;
    }

    h1 { font-size: 3rem; }
    h2 { font-size: 2rem; }
    h3 { font-size: 1.5rem; }

    p {
      font-family: var(--font-riforma);
      text-transform: none;
    }

    label, .label {
      font-family: var(--font-monument);
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; background-color: var(--color-black); }
    ::-webkit-scrollbar-track { background: var(--color-black); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 0; }
    ::-webkit-scrollbar-thumb:hover { background: var(--color-yellow); }

    /* Animations */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 244, 105, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(255, 244, 105, 0); }
    }

    .unlock-animation {
      animation: fadeIn 0.5s ease-out, pulse 1s ease-out 0.5s;
    }

    /* Fast Track Brand Color Classes */
    .bg-ft-yellow { background-color: #FFF469 !important; }
    .text-ft-yellow { color: #FFF469 !important; }
    .border-ft-yellow { border-color: #FFF469 !important; }
    .bg-ft-grey { background-color: #B2B2B2 !important; }
    .text-ft-grey { color: #B2B2B2 !important; }
    .bg-ft-dark { background-color: #1F1F1F !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, memo, useCallback } = React;

    // ── Backend API ──
    const API_BASE = 'https://backend-production-639c.up.railway.app';

    function _authHeaders() {
      const token = localStorage.getItem('ft_access_token');
      return token ? { 'Authorization': 'Bearer ' + token } : {};
    }

    async function _fetchWithAuth(url, opts = {}) {
      opts.headers = Object.assign({}, opts.headers || {}, _authHeaders());
      const res = await fetch(url, opts);
      if (res.status === 401) {
        // Token expired — clear and force re-identify
        localStorage.removeItem('ft_access_token');
        return res;
      }
      return res;
    }

    // ── LearnWorlds Config ──
    const LEARNWORLDS_URL = 'https://fasttrack.learnworlds.com';

    // ── Preview Mode ──
    // Activated by ?preview in URL. Persists for the full browser session.
    // Share link: https://fasttracktools.up.railway.app/dashboard.html?preview
    const PREVIEW_MODE = (() => {
      if (new URLSearchParams(window.location.search).has('preview')) {
        sessionStorage.setItem('ft_preview_mode', '1');
        // Generate a stable anon ID for this browser (persists across page loads)
        if (!localStorage.getItem('ft_user_id')) {
          localStorage.setItem('ft_user_id', 'preview-' + Math.random().toString(36).slice(2, 10));
        }
        return true;
      }
      return sessionStorage.getItem('ft_preview_mode') === '1';
    })();

    // ── Tool Registry (30 tools) ──
    const TOOLS = [
      { sprint: 0,  slug: 'woop',                       name: 'WOOP',                        file: 'module-0-intro-sprint/00-woop.html' },
      { sprint: 1,  slug: 'know-thyself',                name: 'Know Thyself',                 file: 'module-1-identity/01-know-thyself.html' },
      { sprint: 2,  slug: 'dream',                       name: 'Dream',                        file: 'module-1-identity/02-dream.html' },
      { sprint: 3,  slug: 'values',                      name: 'Values',                       file: 'module-1-identity/03-values.html' },
      { sprint: 4,  slug: 'team',                        name: 'Team',                         file: 'module-1-identity/04-team.html' },
      { sprint: 5,  slug: 'fit',                         name: 'Fit',                          file: 'module-1-identity/05-fit.html' },
      { sprint: 6,  slug: 'cash',                        name: 'Cash',                         file: 'module-2-performance/06-cash.html' },
      { sprint: 7,  slug: 'energy',                      name: 'Energy',                       file: 'module-2-performance/07-energy.html' },
      { sprint: 8,  slug: 'goals',                       name: 'Goals',                        file: 'module-2-performance/08-goals.html' },
      { sprint: 9,  slug: 'focus',                       name: 'Focus',                        file: 'module-2-performance/09-focus.html' },
      { sprint: 10, slug: 'performance',                 name: 'Performance Analysis',          file: 'module-2-performance/10-performance.html' },
      { sprint: 11, slug: 'meeting-rhythm',              name: 'Meeting Rhythm',                file: 'module-2-performance/11-meeting-rhythm.html' },
      { sprint: 12, slug: 'market-size',                 name: 'Market Size',                   file: 'module-3-market/12-market-size.html' },
      { sprint: 13, slug: 'segmentation-target-market',  name: 'Segmentation & Target Market',  file: 'module-3-market/13-segmentation-target-market.html' },
      { sprint: 14, slug: 'target-segment-deep-dive',    name: 'Target Segment Deep Dive',      file: 'module-4-strategy-development/14-target-segment-deep-dive.html' },
      { sprint: 15, slug: 'value-proposition',           name: 'Value Proposition',             file: 'module-4-strategy-development/15-value-proposition.html' },
      { sprint: 16, slug: 'value-proposition-testing',   name: 'Value Proposition Testing',     file: 'module-4-strategy-development/16-value-proposition-testing.html' },
      { sprint: 17, slug: 'product-development',         name: 'Product Development',           file: 'module-5-strategy-execution/17-product-development.html' },
      { sprint: 18, slug: 'pricing',                     name: 'Pricing',                       file: 'module-5-strategy-execution/18-pricing.html' },
      { sprint: 19, slug: 'brand-marketing',             name: 'Brand & Marketing',             file: 'module-5-strategy-execution/19-brand-marketing.html' },
      { sprint: 20, slug: 'customer-service',            name: 'Customer Service',              file: 'module-5-strategy-execution/20-customer-service.html' },
      { sprint: 21, slug: 'route-to-market',             name: 'Route to Market',               file: 'module-5-strategy-execution/21-route-to-market.html' },
      { sprint: 22, slug: 'core-activities',             name: 'Core Activities',               file: 'module-6-org-structure/22-core-activities.html' },
      { sprint: 23, slug: 'processes-decisions',         name: 'Processes & Decisions',         file: 'module-6-org-structure/23-processes-decisions.html' },
      { sprint: 24, slug: 'fit-abc-analysis',            name: 'Fit ABC Analysis',              file: 'module-6-org-structure/24-fit-abc-analysis.html' },
      { sprint: 25, slug: 'org-redesign',                name: 'Organizational Redesign',       file: 'module-6-org-structure/25-org-redesign.html' },
      { sprint: 26, slug: 'employer-branding',           name: 'Employer Branding',             file: 'module-7-people-leadership/26-employer-branding.html' },
      { sprint: 27, slug: 'agile-teams',                 name: 'Agile Teams',                   file: 'module-7-people-leadership/27-agile-teams.html' },
      { sprint: 28, slug: 'digitalization',              name: 'Digitalization',                file: 'module-8-tech-ai/28-digitalization.html' },
      { sprint: 29, slug: 'digital-heart',               name: 'Digital Heart',                 file: 'module-8-tech-ai/29-digital-heart.html' },
    ];

    const MODULES = [
      { id: 0, name: 'Intro Sprint',                    sprints: [0] },
      { id: 1, name: 'Individual & Company Identity',   sprints: [1,2,3,4,5] },
      { id: 2, name: 'Core Elements of Performance',    sprints: [6,7,8,9,10,11] },
      { id: 3, name: 'Understanding the Market',        sprints: [12,13] },
      { id: 4, name: 'Strategy Development',            sprints: [14,15,16] },
      { id: 5, name: 'Strategy Execution',              sprints: [17,18,19,20,21] },
      { id: 6, name: 'Organizational Structure',        sprints: [22,23,24,25] },
      { id: 7, name: 'People & Leadership',             sprints: [26,27] },
      { id: 8, name: 'Tech & AI',                       sprints: [28,29] },
    ];

    // ── Auth: LearnWorlds URL params ──
    // LearnWorlds external link variables:
    //   {{USER_ID}}, {{USER_NAME}}, {{USER_EMAIL}}, {{COURSE_ID}}, {{UNIT_ID}}
    // Dashboard URL in LearnWorlds (use exactly this format):
    //   https://fasttracktools.up.railway.app/dashboard.html?user_id={{USER_ID}}&user_email={{USER_EMAIL}}&user_name={{USER_NAME}}
    //
    // Guru access: set role = 'guru' in the users table in Supabase.
    // The GURU VIEW button appears automatically for any user with that role.
    async function identifyUser() {
      // Preview mode: skip all auth, return a guest user instantly
      if (PREVIEW_MODE) {
        const anonId = localStorage.getItem('ft_user_id') || ('preview-' + Math.random().toString(36).slice(2, 10));
        localStorage.setItem('ft_user_id', anonId);
        return { user: { id: anonId, full_name: 'Preview User', email: '', role: 'participant' }, isGuru: false };
      }

      const params = new URLSearchParams(window.location.search);

      // Save raw params for debug display before URL is cleaned
      if (window.location.search) {
        sessionStorage.setItem('ft_debug_params', window.location.search);
      }

      // Support both LearnWorlds native param names and legacy lw_ prefixed names
      const lwUserId = params.get('user_id') || params.get('lw_user_id');
      const lwEmail  = params.get('user_email') || params.get('lw_email');
      const lwName   = params.get('user_name') || params.get('lw_name');

      if (lwUserId || lwEmail) {
        window.history.replaceState({}, document.title, window.location.pathname);
      }

      // 1. Try LearnWorlds params from URL — resolve via backend /identify
      if (lwUserId || lwEmail) {
        try {
          const res = await fetch(`${API_BASE}/api/toolsave/identify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lw_user_id: lwUserId, lw_email: lwEmail, lw_name: lwName })
          });
          if (res.ok) {
            const { data } = await res.json();
            if (data?.user_id) {
              localStorage.setItem('ft_user_id', data.user_id);
              if (data.access_token) localStorage.setItem('ft_access_token', data.access_token);
              // Fetch full user profile for display
              const user = await fetchUserProfile(data.user_id);
              if (user) {
                storeSession(user);
                return { user, isGuru: user.role === 'guru' };
              }
            }
          }
        } catch (err) {
          console.error('Dashboard identify error:', err);
        }
      }

      // 2. Try stored session (same browser tab)
      const stored = getStoredSession();
      if (stored && localStorage.getItem('ft_access_token')) {
        return { user: stored, isGuru: stored.role === 'guru' };
      }

      // 3. Try ft_user_id from localStorage — re-identify to get a fresh token
      const storedUserId = localStorage.getItem('ft_user_id');
      if (storedUserId) {
        // Try stored session if we have a token
        if (stored) return { user: stored, isGuru: stored.role === 'guru' };
        // Otherwise try to re-identify using stored email
        const storedSession = getStoredSession();
        if (storedSession?.email) {
          try {
            const res = await fetch(`${API_BASE}/api/toolsave/identify`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ lw_email: storedSession.email })
            });
            if (res.ok) {
              const { data } = await res.json();
              if (data?.access_token) localStorage.setItem('ft_access_token', data.access_token);
              return { user: storedSession, isGuru: storedSession.role === 'guru' };
            }
          } catch (err) {
            console.error('Dashboard re-identify error:', err);
          }
        }
      }

      return { user: null, isGuru: false };
    }

    // Fetch user profile from a lightweight backend endpoint
    async function fetchUserProfile(userId) {
      // We already have the user_id — use the stored session data or build minimal profile
      // The /identify endpoint returns user_id + token. For display, we use stored session or fallback.
      const stored = getStoredSession();
      if (stored && stored.id === userId) return stored;
      // Minimal fallback — will be populated on next identify
      return { id: userId, full_name: 'Fast Track User', email: '', role: 'participant' };
    }

    function storeSession(user) {
      sessionStorage.setItem('ft_dashboard_user', JSON.stringify(user));
      // Also set ft_user_id so tools can pick it up
      localStorage.setItem('ft_user_id', user.id);
    }

    function getStoredSession() {
      try {
        const stored = sessionStorage.getItem('ft_dashboard_user');
        return stored ? JSON.parse(stored) : null;
      } catch { return null; }
    }

    // ── Data Fetching ──
    async function fetchToolProgress(userId) {
      // Preview mode: all tools unlocked, no backend queries needed
      if (PREVIEW_MODE) {
        return TOOLS.map((tool) => ({
          ...tool,
          id: tool.slug,
          status: 'unlocked',
          progress: 0,
          completedAt: null,
        }));
      }

      try {
        const res = await _fetchWithAuth(`${API_BASE}/api/dashboard/progress`);
        if (!res.ok) {
          console.error('[Dashboard] fetchToolProgress error:', res.status);
          return TOOLS.map(t => ({ ...t, id: t.slug, status: 'unlocked', progress: 0, completedAt: null }));
        }
        const { data } = await res.json();

        // Merge backend progress into TOOLS array
        const progressMap = {};
        (data || []).forEach(p => { progressMap[p.slug] = p; });

        return TOOLS.map(tool => {
          const p = progressMap[tool.slug] || {};
          return {
            ...tool,
            id: tool.slug,
            status: p.status || 'unlocked',
            progress: p.progress || 0,
            completedAt: p.completedAt || null,
          };
        });
      } catch (err) {
        console.error('[Dashboard] fetchToolProgress error:', err);
        return TOOLS.map(t => ({ ...t, id: t.slug, status: 'unlocked', progress: 0, completedAt: null }));
      }
    }

    async function fetchToolSubmission(userId, toolSlug) {
      try {
        const res = await _fetchWithAuth(`${API_BASE}/api/dashboard/submission?tool_slug=${encodeURIComponent(toolSlug)}`);
        if (!res.ok) return [];
        const { data } = await res.json();
        return data || [];
      } catch (err) {
        console.error('[Dashboard] fetchToolSubmission error:', err);
        return [];
      }
    }

    // ── Launch Tool ──
    function launchTool(tool) {
      const url = PREVIEW_MODE ? `tools/${tool.file}?preview` : `tools/${tool.file}`;
      window.location.href = url;
    }

    // ── Components ──
    const ProgressBar = memo(({ progress = 0, className = '' }) => (
      <div className={`w-full bg-ft-dark h-1 overflow-hidden ${className}`} style={{ background: '#1a1a1a' }}>
        <div className="h-full bg-ft-yellow transition-all duration-300" style={{ width: `${Math.max(0, Math.min(100, progress))}%` }}></div>
      </div>
    ));

    const StatusBadge = memo(({ status }) => {
      const styles = {
        locked:      'text-ft-grey text-xs uppercase',
        unlocked:    'text-white text-xs uppercase',
        in_progress: 'text-ft-yellow text-xs uppercase font-bold',
        completed:   'text-white text-xs uppercase font-bold'
      };
      const labels = {
        locked:      'LOCKED',
        unlocked:    'UNLOCKED',
        in_progress: 'IN PROGRESS',
        completed:   'DONE'
      };
      return <span className={styles[status] || styles.locked} style={{fontFamily: 'var(--font-monument)'}}>{labels[status] || 'LOCKED'}</span>;
    });

    const ToolCard = memo(({ tool, onViewSummary }) => {
      const isLocked = tool.status === 'locked';
      const showProgress = tool.status === 'in_progress' && tool.progress != null;
      const isCompleted = tool.status === 'completed';
      const borderStyle = tool.status === 'in_progress'
        ? { border: '2px solid #FFF469' }
        : { border: '1px solid #1a1a1a' };

      return (
        <div style={{
          background: '#0a0a0a',
          color: '#fff',
          padding: '24px',
          opacity: isLocked ? 0.5 : 1,
          display: 'flex',
          flexDirection: 'column',
          gap: 0,
          ...borderStyle
        }}>
          <div style={{ marginBottom: 6 }}>
            <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', letterSpacing: '0.08em', textTransform: 'uppercase' }}>
              Sprint {String(tool.sprint).padStart(2, '0')}
            </span>
          </div>
          <h3 style={{ fontFamily: 'var(--font-plaak)', fontSize: 20, textTransform: 'uppercase', marginBottom: 10, lineHeight: 1.2 }}>{tool.name}</h3>
          <div style={{ marginBottom: 14 }}>
            <StatusBadge status={tool.status} />
          </div>
          {showProgress && (
            <div style={{ marginBottom: 14 }}>
              <ProgressBar progress={tool.progress} />
              <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', marginTop: 4, display: 'block' }}>{tool.progress}%</span>
            </div>
          )}
          <div style={{ display: 'flex', gap: 8, marginTop: 'auto' }}>
            {isCompleted ? (
              <button
                onClick={() => onViewSummary(tool)}
                style={{ padding: '9px 20px', background: '#FFF469', color: '#000', border: 'none', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.1em', textTransform: 'uppercase', fontWeight: 'bold', cursor: 'pointer' }}
                onMouseEnter={e => e.currentTarget.style.background = '#e8dd5c'}
                onMouseLeave={e => e.currentTarget.style.background = '#FFF469'}
              >
                VIEW SUMMARY
              </button>
            ) : (
              <button
                onClick={() => !isLocked && launchTool(tool)}
                disabled={isLocked}
                style={{
                  padding: '9px 20px',
                  background: isLocked ? '#111' : '#fff',
                  color: isLocked ? '#444' : '#000',
                  border: isLocked ? '1px solid #222' : '1px solid #fff',
                  fontFamily: 'var(--font-monument)',
                  fontSize: 11,
                  letterSpacing: '0.1em',
                  textTransform: 'uppercase',
                  fontWeight: 'bold',
                  cursor: isLocked ? 'not-allowed' : 'pointer',
                }}
                onMouseEnter={e => { if (!isLocked) { e.currentTarget.style.background = '#FFF469'; e.currentTarget.style.borderColor = '#FFF469'; }}}
                onMouseLeave={e => { if (!isLocked) { e.currentTarget.style.background = '#fff'; e.currentTarget.style.borderColor = '#fff'; }}}
              >
                {tool.status === 'in_progress' ? 'CONTINUE' : 'LAUNCH'}
              </button>
            )}
            {isCompleted && (
              <button
                onClick={() => launchTool(tool)}
                style={{ padding: '9px 20px', background: 'transparent', color: '#fff', border: '1px solid #222', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.1em', textTransform: 'uppercase', fontWeight: 'bold', cursor: 'pointer' }}
                onMouseEnter={e => { e.currentTarget.style.borderColor = '#555'; e.currentTarget.style.color = '#888'; }}
                onMouseLeave={e => { e.currentTarget.style.borderColor = '#222'; e.currentTarget.style.color = '#555'; }}
              >
                REDO
              </button>
            )}
          </div>
        </div>
      );
    });

    const ModuleSection = memo(({ module, tools, collapsed, onToggle, onViewSummary }) => {
      const moduleTools = tools.filter(t => module.sprints.includes(t.sprint));
      const completed = moduleTools.filter(t => t.status === 'completed').length;
      const total = moduleTools.length;

      return (
        <div style={{ marginBottom: 32 }}>
          <div
            onClick={onToggle}
            style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer', background: '#0a0a0a', padding: '18px 24px', border: '1px solid #1a1a1a', transition: 'border-color 0.15s' }}
            onMouseEnter={e => e.currentTarget.style.borderColor = '#333'}
            onMouseLeave={e => e.currentTarget.style.borderColor = '#1a1a1a'}
          >
            <div>
              <h2 style={{ fontFamily: 'var(--font-plaak)', fontSize: 22, color: '#fff', textTransform: 'uppercase', marginBottom: 4 }}>
                Module {module.id}: {module.name}
              </h2>
              <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', letterSpacing: '0.08em' }}>
                {total === 1 ? `SPRINT ${module.sprints[0]}` : `SPRINTS ${module.sprints[0]}–${module.sprints[module.sprints.length-1]}`} &bull; {completed}/{total} COMPLETE
              </span>
            </div>
            <span style={{ fontFamily: 'var(--font-monument)', color: '#FFF469', fontSize: 22, userSelect: 'none', lineHeight: 1 }}>{collapsed ? '+' : '−'}</span>
          </div>
          {!collapsed && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3" style={{ gap: 1, marginTop: 1, background: '#1a1a1a' }}>
              {moduleTools.map(tool => <ToolCard key={tool.id} tool={tool} onViewSummary={onViewSummary} />)}
            </div>
          )}
        </div>
      );
    });

    // Converts camelCase keys to readable labels
    function formatKey(key) {
      return key
        .replace(/([A-Z])/g, ' $1')
        .replace(/[_-]/g, ' ')
        .replace(/^\w/, c => c.toUpperCase())
        .trim();
    }

    // Renders any value (string, array, object) in a human-readable way
    const ResponseValue = memo(({ value }) => {
      const base = { fontFamily: 'var(--font-riforma)', fontSize: 14, lineHeight: '1.6', color: '#ccc' };
      if (value === null || value === undefined || value === '') {
        return <p style={{ ...base, color: '#333', fontStyle: 'italic' }}>No response</p>;
      }
      if (typeof value === 'string' || typeof value === 'number') {
        return <p style={base}>{String(value)}</p>;
      }
      if (typeof value === 'boolean') {
        return <p style={base}>{value ? 'Yes' : 'No'}</p>;
      }
      if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'string') {
        return (
          <ul style={{ ...base, paddingLeft: 18, display: 'flex', flexDirection: 'column', gap: 4 }}>
            {value.map((item, i) => <li key={i}>{item}</li>)}
          </ul>
        );
      }
      if (Array.isArray(value)) {
        return (
          <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
            {value.map((item, i) => (
              <div key={i} style={{ background: '#0a0a0a', padding: '10px 14px', border: '1px solid #1a1a1a' }}>
                {typeof item === 'object' && item !== null ? (
                  Object.entries(item).filter(([,v]) => v !== '' && v !== null).map(([k, v]) => (
                    <div key={k} style={{ marginBottom: 3 }}>
                      <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', textTransform: 'uppercase' }}>{formatKey(k)}: </span>
                      <span style={{ ...base, fontSize: 13 }}>{typeof v === 'boolean' ? (v ? 'Yes' : 'No') : String(v)}</span>
                    </div>
                  ))
                ) : (
                  <span style={base}>{String(item)}</span>
                )}
              </div>
            ))}
          </div>
        );
      }
      if (typeof value === 'object') {
        return (
          <div style={{ background: '#0a0a0a', padding: '12px 16px', border: '1px solid #1a1a1a' }}>
            {Object.entries(value).filter(([,v]) => v !== '' && v !== null).map(([k, v]) => (
              <div key={k} style={{ marginBottom: 8 }}>
                <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', textTransform: 'uppercase', marginBottom: 2 }}>{formatKey(k)}</div>
                {typeof v === 'boolean' ? (
                  <span style={base}>{v ? 'Yes' : 'No'}</span>
                ) : Array.isArray(v) ? (
                  <ul style={{ ...base, paddingLeft: 16 }}>{v.map((item, i) => <li key={i}>{String(item)}</li>)}</ul>
                ) : (
                  <span style={base}>{String(v)}</span>
                )}
              </div>
            ))}
          </div>
        );
      }
      return <p style={base}>{String(value)}</p>;
    });

    const SummaryModal = memo(({ tool, userId, onClose }) => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        if (tool && userId) {
          setLoading(true);
          fetchToolSubmission(userId, tool.slug)
            .then(setData)
            .finally(() => setLoading(false));
        }
      }, [tool, userId]);

      useEffect(() => {
        const handleEscape = (e) => e.key === 'Escape' && onClose();
        document.addEventListener('keydown', handleEscape);
        return () => document.removeEventListener('keydown', handleEscape);
      }, [onClose]);

      if (!tool) return null;

      // Group answers by section
      const sections = {};
      (data || []).forEach(item => {
        const sec = item.section || 'Responses';
        if (!sections[sec]) sections[sec] = [];
        sections[sec].push(item);
      });

      return (
        <div
          style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50, padding: 24 }}
          onClick={onClose}
          role="dialog"
          aria-modal="true"
        >
          <div
            style={{ background: '#000', border: '1px solid #222', color: '#fff', maxWidth: 800, width: '100%', maxHeight: '85vh', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', padding: '24px 28px', borderBottom: '1px solid #1a1a1a', flexShrink: 0 }}>
              <div>
                <h2 style={{ fontFamily: 'var(--font-plaak)', fontSize: 28, textTransform: 'uppercase', marginBottom: 6 }}>{tool.name}</h2>
                <div style={{ display: 'flex', gap: 16, alignItems: 'center' }}>
                  <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', letterSpacing: '0.08em' }}>SPRINT {String(tool.sprint).padStart(2, '0')}</span>
                  {tool.completedAt && (
                    <span style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#FFF469', letterSpacing: '0.06em' }}>
                      COMPLETED {new Date(tool.completedAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).toUpperCase()}
                    </span>
                  )}
                </div>
              </div>
              <button
                onClick={onClose}
                style={{ background: 'none', border: '1px solid #222', color: '#fff', padding: '6px 14px', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.08em', cursor: 'pointer', flexShrink: 0 }}
                onMouseEnter={e => e.currentTarget.style.borderColor = '#FFF469'}
                onMouseLeave={e => e.currentTarget.style.borderColor = '#222'}
              >✕</button>
            </div>
            {/* Body */}
            <div style={{ padding: '24px 28px', overflowY: 'auto', flex: 1 }}>
              {loading && <p style={{ fontFamily: 'var(--font-riforma)', color: '#555', fontSize: 14 }}>Loading submission...</p>}
              {!loading && (!data || data.length === 0) && <p style={{ fontFamily: 'var(--font-riforma)', color: '#555', fontSize: 14 }}>No submission data found.</p>}
              {!loading && data && data.length > 0 && (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 32 }}>
                  {Object.entries(sections).map(([sectionName, items]) => (
                    <div key={sectionName}>
                      <div style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#FFF469', letterSpacing: '0.08em', textTransform: 'uppercase', marginBottom: 16, paddingBottom: 10, borderBottom: '1px solid #1a1a1a' }}>{sectionName}</div>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
                        {items.map((item, i) => (
                          <div key={i}>
                            <p style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', marginBottom: 6, letterSpacing: '0.06em', textTransform: 'uppercase' }}>{item.question}</p>
                            <ResponseValue value={item.data || item.answer} />
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
            {/* Footer */}
            <div style={{ padding: '18px 28px', borderTop: '1px solid #1a1a1a', display: 'flex', justifyContent: 'flex-end', gap: 10, flexShrink: 0 }}>
              <button
                onClick={() => launchTool(tool)}
                style={{ padding: '10px 24px', background: '#fff', color: '#000', border: 'none', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.1em', textTransform: 'uppercase', fontWeight: 'bold', cursor: 'pointer' }}
                onMouseEnter={e => { e.currentTarget.style.background = '#FFF469'; }}
                onMouseLeave={e => { e.currentTarget.style.background = '#fff'; }}
              >Relaunch Tool</button>
              <button
                onClick={onClose}
                style={{ padding: '10px 24px', background: 'transparent', color: '#fff', border: '1px solid #222', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.1em', textTransform: 'uppercase', fontWeight: 'bold', cursor: 'pointer' }}
                onMouseEnter={e => { e.currentTarget.style.borderColor = '#555'; e.currentTarget.style.color = '#888'; }}
                onMouseLeave={e => { e.currentTarget.style.borderColor = '#222'; e.currentTarget.style.color = '#555'; }}
              >Close</button>
            </div>
          </div>
        </div>
      );
    });

    // ── Guru Panel Components ──
    function timeAgo(dateStr) {
      if (!dateStr) return 'Never';
      const diff = Date.now() - new Date(dateStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return `${mins}m ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      return `${Math.floor(hours / 24)}d ago`;
    }

    const Header = memo(({ user, overallProgress, isGuru, onGuruClick }) => (
      <header style={{ background: '#000', color: '#fff', padding: '20px 24px', borderBottom: '1px solid #1a1a1a' }}>
        <div className="max-w-7xl mx-auto" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
          <img src="shared/images/FastTrack_F_White.png" alt="Fast Track" style={{ height: 44 }} />
          <div style={{ display: 'flex', alignItems: 'center', gap: 24 }}>
            {isGuru && (
              <button
                onClick={onGuruClick}
                style={{ background: '#FFF469', color: '#000', border: 'none', padding: '10px 24px', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.12em', textTransform: 'uppercase', cursor: 'pointer', fontWeight: 'bold' }}
                onMouseEnter={e => e.currentTarget.style.background = '#e8dd5c'}
                onMouseLeave={e => e.currentTarget.style.background = '#FFF469'}
              >
                GURU VIEW
              </button>
            )}
            <div style={{ textAlign: 'right' }}>
              <p style={{ fontFamily: 'var(--font-riforma)', fontSize: 14, color: '#fff', marginBottom: 6 }}>{user?.full_name || user?.email || 'User'}</p>
              <div style={{ width: 140 }}>
                <ProgressBar progress={overallProgress} />
              </div>
            </div>
          </div>
        </div>
      </header>
    ));

    const Hero = memo(({ completed, total, currentTool }) => (
      <section style={{ background: '#000', color: '#fff', padding: '64px 24px', borderBottom: '1px solid #1a1a1a' }}>
        <div className="max-w-7xl mx-auto">
          <h1 style={{ fontFamily: 'var(--font-plaak)', fontSize: 'clamp(2.5rem, 6vw, 4.5rem)', textTransform: 'uppercase', marginBottom: 16, lineHeight: 1.1 }}>YOUR TRANSFORMATION JOURNEY</h1>
          <p style={{ fontFamily: 'var(--font-riforma)', fontSize: 20, color: '#fff', marginBottom: 10 }}>{completed} of {total} tools complete</p>
          {currentTool && <p style={{ fontFamily: 'var(--font-monument)', fontSize: 12, color: '#FFF469', letterSpacing: '0.1em', textTransform: 'uppercase' }}>CURRENT: SPRINT {String(currentTool.sprint).padStart(2, '0')} — {currentTool.name}</p>}
        </div>
      </section>
    ));

    const EmailLogin = memo(({ onLogin }) => {
      const [email, setEmail] = useState('');
      const [name, setName] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!email.trim()) return;
        setLoading(true);
        setError('');

        try {
          // Identify via backend — creates user if not found
          const res = await fetch(`${API_BASE}/api/toolsave/identify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lw_email: email.trim(), lw_name: name.trim() || undefined })
          });

          if (!res.ok) throw new Error('Identify failed');
          const { data } = await res.json();

          if (data?.user_id) {
            localStorage.setItem('ft_user_id', data.user_id);
            if (data.access_token) localStorage.setItem('ft_access_token', data.access_token);
            const user = {
              id: data.user_id,
              full_name: name.trim() || email.split('@')[0],
              email: email.trim().toLowerCase(),
              role: 'participant',
            };
            storeSession(user);
            onLogin(user);
          } else {
            throw new Error('No user_id returned');
          }
        } catch (err) {
          console.error('Login error:', err);
          setError('Something went wrong. Try again.');
        } finally {
          setLoading(false);
        }
      };

      const inputStyle = {
        width: '100%', padding: '14px 16px', background: '#0a0a0a', border: '1px solid #222',
        color: '#fff', fontSize: 16, fontFamily: 'var(--font-riforma)', outline: 'none', display: 'block',
        boxSizing: 'border-box',
      };

      return (
        <div style={{ minHeight: '100vh', background: '#000', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center', padding: '0 24px' }}>
          <div style={{ textAlign: 'center', maxWidth: 420, width: '100%' }}>
            <img src="shared/images/FastTrack_F_White.png" alt="Fast Track" style={{ height: 56, margin: '0 auto 40px' }} />
            <h1 style={{ fontFamily: 'var(--font-plaak)', fontSize: 40, textTransform: 'uppercase', marginBottom: 16 }}>YOUR JOURNEY STARTS HERE</h1>
            <p style={{ fontFamily: 'var(--font-riforma)', fontSize: 16, color: '#fff', marginBottom: 40, lineHeight: 1.6 }}>
              Enter your email to access your tools dashboard.
            </p>
            <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                placeholder="Your name"
                style={inputStyle}
                onFocus={e => e.currentTarget.style.borderColor = '#FFF469'}
                onBlur={e => e.currentTarget.style.borderColor = '#222'}
              />
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Your email"
                required
                style={inputStyle}
                onFocus={e => e.currentTarget.style.borderColor = '#FFF469'}
                onBlur={e => e.currentTarget.style.borderColor = '#222'}
              />
              {error && <p style={{ fontFamily: 'var(--font-monument)', fontSize: 11, color: '#ff5555', letterSpacing: '0.06em' }}>{error}</p>}
              <button
                type="submit"
                disabled={loading || !email.trim()}
                style={{
                  width: '100%', padding: '14px', background: loading || !email.trim() ? '#333' : '#FFF469',
                  color: '#000', border: 'none', fontFamily: 'var(--font-monument)', fontSize: 13,
                  letterSpacing: '0.12em', textTransform: 'uppercase', fontWeight: 'bold',
                  cursor: loading || !email.trim() ? 'not-allowed' : 'pointer', marginTop: 8,
                }}
                onMouseEnter={e => { if (!loading && email.trim()) e.currentTarget.style.background = '#e8dd5c'; }}
                onMouseLeave={e => { if (!loading && email.trim()) e.currentTarget.style.background = '#FFF469'; }}
              >
                {loading ? 'Loading...' : 'Enter Dashboard'}
              </button>
            </form>
          </div>
        </div>
      );
    });

    const Footer = memo(() => (
      <footer style={{ background: '#000', color: '#fff', padding: '48px 24px', borderTop: '1px solid #1a1a1a' }}>
        <div className="max-w-7xl mx-auto" style={{ textAlign: 'center' }}>
          <p style={{ fontFamily: 'var(--font-plaak)', fontSize: 32, textTransform: 'uppercase', marginBottom: 12 }}>NO GRIT. NO GROWTH.</p>
          <p style={{ fontFamily: 'var(--font-monument)', fontSize: 10, color: '#fff', letterSpacing: '0.08em' }}>&copy; {new Date().getFullYear()} FAST TRACK LTD. ALL RIGHTS RESERVED.</p>
        </div>
      </footer>
    ));

    // ── Main Dashboard ──
    function Dashboard() {
      const [user, setUser] = useState(null);
      const [isGuru, setIsGuru] = useState(false);
      const [tools, setTools] = useState([]);
      const [loading, setLoading] = useState(true);
      const [noAccess, setNoAccess] = useState(false);
      const [collapsedModules, setCollapsedModules] = useState(() => {
        try {
          const saved = localStorage.getItem('ft_collapsed_modules');
          return saved ? JSON.parse(saved) : [];
        } catch { return []; }
      });
      const [modalTool, setModalTool] = useState(null);

      const overallProgress = useMemo(() => {
        const completed = tools.filter(t => t.status === 'completed').length;
        return tools.length > 0 ? Math.round((completed / tools.length) * 100) : 0;
      }, [tools]);

      const completedCount = useMemo(() => tools.filter(t => t.status === 'completed').length, [tools]);

      const currentTool = useMemo(() => {
        const inProgress = tools.find(t => t.status === 'in_progress');
        if (inProgress) return inProgress;
        return tools.find(t => t.status === 'unlocked') || null;
      }, [tools]);

      const loadData = useCallback(async (userId) => {
        const toolData = await fetchToolProgress(userId);
        setTools(toolData);
      }, []);

      useEffect(() => {
        (async () => {
          try {
            const { user: identified, isGuru: guruFlag } = await identifyUser();
            if (!identified) {
              setNoAccess(true);
              setLoading(false);
              return;
            }
            setUser(identified);
            setIsGuru(guruFlag);
            await loadData(identified.id);
          } catch (err) {
            console.error('Dashboard init error:', err);
          } finally {
            setLoading(false);
          }
        })();
      }, [loadData]);

      const toggleModule = useCallback((moduleId) => {
        setCollapsedModules(prev => {
          const next = prev.includes(moduleId) ? prev.filter(id => id !== moduleId) : [...prev, moduleId];
          localStorage.setItem('ft_collapsed_modules', JSON.stringify(next));
          return next;
        });
      }, []);

      if (loading) {
        return (
          <div className="min-h-screen bg-black text-white flex items-center justify-center">
            <div className="text-center">
              <div style={{ width: 32, height: 32, border: '2px solid #1a1a1a', borderTopColor: '#FFF469', animation: 'spin 0.8s linear infinite', margin: '0 auto 16px' }}></div>
              <p className="text-xl" style={{fontFamily: 'var(--font-riforma)'}}>Loading your journey...</p>
            </div>
          </div>
        );
      }

      if (noAccess) return <EmailLogin onLogin={async (u) => { setUser(u); await loadData(u.id); setNoAccess(false); }} />;

      return (
        <div className="min-h-screen bg-black">
          {PREVIEW_MODE && (
            <div style={{ background: '#FFF469', color: '#000', textAlign: 'center', padding: '8px 24px', fontFamily: 'var(--font-monument)', fontSize: 11, letterSpacing: '0.1em', textTransform: 'uppercase' }}>
              PREVIEW MODE — Internal Testing Only. All tools unlocked.
            </div>
          )}
          <Header user={user} overallProgress={overallProgress} isGuru={isGuru} onGuruClick={() => {
            const params = new URLSearchParams({ ft_user_id: user.id, ft_name: user.full_name || '', ft_email: user.email || '' });
            window.location.href = '/guru-suite/?' + params.toString();
          }} />
          <Hero completed={completedCount} total={TOOLS.length} currentTool={currentTool} />
          <main className="max-w-7xl mx-auto" style={{ padding: '48px 24px' }}>
            {MODULES.map(module => (
              <ModuleSection
                key={module.id}
                module={module}
                tools={tools}
                collapsed={collapsedModules.includes(module.id)}
                onToggle={() => toggleModule(module.id)}
                onViewSummary={setModalTool}
              />
            ))}
          </main>
          <Footer />
          {modalTool && <SummaryModal tool={modalTool} userId={user.id} onClose={() => setModalTool(null)} />}
        </div>
      );
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Dashboard />);
  </script>
</body>
</html>
